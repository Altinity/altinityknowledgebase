<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="http://localhost:1313/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/">
<meta name="robots" content="noindex, nofollow">
<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="icon" href="/favicons/favicon.ico" >
<title>Data Migration | Altinity Knowledge Base for ClickHouse®</title>
<meta name="description" content="Data Migration
">
<meta property="og:title" content="Data Migration" />
<meta property="og:description" content="Data Migration
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://localhost:1313/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/" />

<meta itemprop="name" content="Data Migration">
<meta itemprop="description" content="Data Migration
"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Data Migration"/>
<meta name="twitter:description" content="Data Migration
"/>





<link href="/scss/main.css" rel="stylesheet">

<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>
<meta name="keywords" content="">

<script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/4536206.js"></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
  <a class="navbar-brand" href="/">
    <span class="navbar-logo"><svg id="a" viewBox="0 0 91.660006 105.99" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs1"><style id="style1">.b{fill:#fff}.c{fill:#199dcf}</style></defs><g id="g7"><polygon class="c" points="45.88,0 45.88,0.04 22.94,13.3 22.93,13.3 22.93,13.3 0.09,26.49 0.09,26.49 0.09,26.49 0,26.54 0.09,26.59 0.09,50.96 66.86,12.12" id="polygon1"/><polygon class="c" points="22.94,42.29 4.21,53.19 22.94,64.08" id="polygon2"/><polygon class="c" points="0.09,55.59 0.09,79.43 0,79.48 0.09,79.54 0.09,105.99 22.8,92.88 22.8,92.88 43.75,80.79 0.23,55.51" id="polygon3"/><polygon class="c" points="89.61,25.17 70.92,14.38 48.03,27.7 64.18,37.02 64.22,36.96 66.79,38.45" id="polygon4"/><g id="g6"><polygon class="c" points="91.66,52.82 91.63,52.83 76.33,44 91.66,52.92" id="polygon5"/><polygon class="c" points="91.66,105.76 91.66,57.55 68.71,44.2 68.71,92.51" id="polygon6"/></g><polygon class="c" points="91.66,52.85 91.66,28.61 70.77,40.76 76.28,43.97" id="polygon7"/></g></svg></span><span class="font-weight-bold">Altinity Knowledge Base for ClickHouse<sup>®</sup></span>
  </a>
  <div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
    <ul class="navbar-nav mt-2 mt-lg-0">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="productsDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Products</a>
        <div class="dropdown-menu" aria-labelledby="productsDropdown">
          <a class="dropdown-item" href="https://altinity.com/managed-clickhouse/" target="_blank"><span style="font-size: large;">Altinity.Cloud</span><br/><span style="font-size:small;">Managed service for ClickHouse in any AWS, GCP, or Azure region or your own VPC</span></a>
          <a class="dropdown-item" href="https://altinity.com/clickhouse-support/" target="_blank"><span style="font-size: large;">Support for ClickHouse</span><br/><span style="font-size: small;">Get 24/7 Support or POC and evaluative support</span></a>
          <a class="dropdown-item" href="https://altinity.com/clickhouse-training/" target="_blank"><span style="font-size: large;">Training for ClickHouse</span><br/><span style="font-size: small;">Altinity Administrator training for ClickHouse</span></a>
          <a class="dropdown-item" href="https://altinity.com/customer-stories/" target="_blank"><span style="font-size: large;">Customer Stories</span><br/><span style="font-size: small;">See why our customers love us</span></a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="resourceDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Resources</a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
          <a class="dropdown-item" href="https://docs.altinity.com/" target="_blank"><span style="font-size: large;">Documentation</span><br/><span style="font-size: small;">Product guides and tutorials</span></a>
          <a class="dropdown-item" href="https://hubs.la/Q02pLTV20" target="_blank"><span style="font-size: large;">Guides and eBooks</span><br/><span style="font-size: small;">Technical content for developers</span></a>
          <a class="dropdown-item" href="https://altinity.com/clickhouse-database/" target="_blank"><span style="font-size: large;">What is ClickHouse?</span><br/><span style="font-size: small;">Learn why ClickHouse is the fastest database in the world</span></a>
          <a class="dropdown-item" href="https://altinity.com/what-is-kubernetes/" target="_blank"><span style="font-size: large;">What is Kubernetes?</span><br/><span style="font-size: small;">Learn why Kubernetes is the platform of choice for analytic databases</span></a>
        </div>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://altinity.com/blog" target="_blank">Blog <span class="navbar-logo"><svg width="25.897644" height="31.648945" viewBox="0 0 25.897644 31.648945" version="1.1" id="svg1" xmlns="http://www.w3.org/2000/svg"><path d="m 18,14.5 v 6 H 6 v -12 h 6 m 3,-3 h 6 v 6 m 0,-6 -9,9" class="icon_svg-stroke" stroke="#ffffff" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round" id="path1" style="stroke:#ffffff;stroke-opacity:1"/></svg></span></a>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="companyDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Company</a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
          <a class="dropdown-item" href="https://altinity.com/about-us/" target="_blank"><span style="font-size: large;">About the Company</span><br/><span style="font-size: small;">Who we are and what we do</span></a>
          <a class="dropdown-item" href="https://altinity.com/careers/" target="_blank"><span style="font-size: large;">Careers</span><br/><span style="font-size: small;">Join our team!</span></a>
          <a class="dropdown-item" href="https://altinity.com/contact" target="_blank"><span style="font-size: large;">Contact</span><br/><span style="font-size: small;">Have questions? We've got answers.</span></a>
        </div>
      </li>
      <li class="header-social-wrap ml-md-auto">
        <div style="padding-right: 20px;" class="header-social-inner-wrap element-social-inner-wrap social-show-label-false social-style-filled">
          <a class="mega-menu-link" href="https://altinity.com/slack">
            <span style="border-radius: 24px; padding-top: .3em; padding-bottom: .3em; padding-left: 1em; padding-right: 1em; background-color: #1e9dcf; color: white; font-style: normal; font-size: 13px; line-height: 17px; font-weight: 700;">Join our community</span>
          </a>
          &nbsp;
          
          <a href="https://altinity.com/slack" aria-label="Slack" target="_blank" rel="noopener noreferrer" class="social-button header-social-item social-link-custom1" data-positional-element-id="75">
						<span class="social-icon-custom-svg" style="max-width:34px">
							<svg viewBox="0 0 36 36" height="24" width="24" xmlns="http://www.w3.org/2000/svg">
								<path fill="#fff" d="M7.563,22.747a3.782,3.782,0,1,1-3.78-3.78h3.78v3.78Zm1.906,0a3.782,3.782,0,0,1,7.563,0v9.469a3.782,3.782,0,1,1-7.563,0V22.747ZM13.251,7.563a3.782,3.782,0,1,1,3.782-3.78v3.78H13.251Zm0,1.906a3.781,3.781,0,1,1,0,7.563H3.783a3.782,3.782,0,1,1,0-7.563h9.468Zm15.183,3.782a3.783,3.783,0,1,1,3.783,3.782H28.434V13.251Zm-1.9,0a3.782,3.782,0,0,1-7.565,0V3.783a3.782,3.782,0,1,1,7.564,0ZM22.747,28.434a3.783,3.783,0,1,1-3.78,3.783V28.434h3.78Zm0-1.9a3.782,3.782,0,0,1,0-7.565h9.469a3.782,3.782,0,1,1,0,7.564Z" data-name="Icon simple-slack" id="Icon_simple-slack"></path>
							</svg>
						</span>
          </a>
          &nbsp;&nbsp;&nbsp;
          <a href="https://github.com/Altinity/" aria-label="GitHub" target="_blank" rel="noopener noreferrer" class="social-button header-social-item social-link-github has-custom-image" data-positional-element-id="76">
            <img width="500" height="245" src="https://altinity.com/wp-content/uploads/2023/11/github-mark-white.png" class="social-icon-image lazyloaded" alt="" decoding="async" loading="lazy" style="max-width:24px" data-ll-status="loaded">
            <noscript>
              <img width="250" height="245" src="https://altinity.com/wp-content/uploads/2023/11/github-mark-white.png" class="social-icon-image" alt="" decoding="async" loading="lazy" style="max-width:24px" />
            </noscript>
          </a>
        </div>
      </li>
      
      
      
      
      
      
      
      
      
      
    </ul>
  </div>
  <div class="navbar-nav d-none d-lg-block"></div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Data Migration</h1>
<div class="lead">Data Migration</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-995190106d7ed9690cfa9cfd364aec72">MSSQL bcp pipe to clickhouse-client</a></li>


    
  
    
    
	
<li>2: <a href="#pg-11fb2857cf3b2c7a29cb57f3cb63eba6">Add/Remove a new replica to a ClickHouse cluster</a></li>


    
  
    
    
	
<li>3: <a href="#pg-49f38a883c7ec4fc908726a6854c7bbe">clickhouse-copier</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-e1f1d825521583c133a8d3bf2a72f6e7">clickhouse-copier 20.3 and earlier</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-4907e613a878d5b7819f49cc367b9f3f">clickhouse-copier 20.4 - 21.6</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-092d5c190f9504b9126ab5f7779a2089">Kubernetes job for clickhouse-copier</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-775c97dd3622aad5380ef8cd9f7472ad">Distributed table to Cluster</a></li>


    
  
    
    
	
<li>5: <a href="#pg-6b8cf3862e661a5ba53de12323896812">Fetch Alter Table</a></li>


    
  
    
    
	
<li>6: <a href="#pg-384352a945ec192141ea6fb13e0f518f">Remote table function</a></li>


    
  
    
    
	
<li>7: <a href="#pg-69e50f36eba192534d9f891226a8196a">rsync</a></li>


    
  

    </ul>


<div class="content">
      <h2 id="export--import-into-common-data-formats">Export &amp; Import into common data formats</h2>
<p>Pros:</p>
<ul>
<li>Data can be inserted into any DBMS.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Decoding &amp; encoding of common data formats may be slower / require more CPU</li>
<li>The data size is usually bigger than ClickHouse formats.</li>
<li>Some of the common data formats have limitations.</li>
</ul>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    <p>The best approach to do that is using clickhouse-client, in that case, encoding/decoding of format happens client-side, while client and server speak clickhouse Native format (columnar &amp; compressed).</p>
<p>In contrast: when you use HTTP protocol, the server do encoding/decoding and more data is passed between client and server.</p>


</div>

<h2 id="remoteremotesecure-or-clusterdistributed-table">remote/remoteSecure or cluster/Distributed table</h2>
<p>Pros:</p>
<ul>
<li>Simple to run.</li>
<li>It’s possible to change the schema and distribution of data between shards.</li>
<li>It’s possible to copy only some subset of data.</li>
<li>Needs only access to ClickHouse TCP port.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Uses CPU / RAM (mostly on the receiver side)</li>
</ul>
<p>See details of both approaches in:</p>
<p><a href="http://localhost:1313/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/remote-table-function/">remote-table-function.md</a></p>
<p><a href="http://localhost:1313/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/distributed-table-cluster/">distributed-table-cluster.md</a></p>
<h2 id="clickhouse-copier">clickhouse-copier</h2>
<p>Pros:</p>
<ul>
<li>Possible to do <strong>some</strong> changes in schema.</li>
<li>Needs only access to ClickHouse TCP port.</li>
<li>It’s possible to change the distribution of data between shards.</li>
<li>Suitable for large clusters: many clickhouse-copier can execute the same task together.</li>
</ul>
<p>Cons:</p>
<ul>
<li>May create an inconsistent result if source cluster data is changing during the process.</li>
<li>Hard to setup.</li>
<li>Requires zookeeper.</li>
<li>Uses CPU / RAM (mostly on the clickhouse-copier and receiver side)</li>
</ul>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    Internally it works like smart <code>INSERT INTO cluster(…) SELECT * FROM ...</code> with some consistency checks.

</div>



<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    Run clickhouse copier on the same nodes as receiver clickhouse, to avoid doubling the network load.

</div>

<p>See details in:</p>
<p><a href="http://localhost:1313/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/altinity-kb-clickhouse-copier/">altinity-kb-clickhouse-copier</a></p>
<h2 id="manual-parts-moving-freeze--rsync--attach">Manual parts moving: freeze / rsync / attach</h2>
<p>Pros:</p>
<ul>
<li>Low CPU / RAM usage.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Table schema should be the same.</li>
<li>A lot of manual operations/scripting.</li>
</ul>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    With some additional care and scripting, it’s possible to do cheap re-sharding on parts level.

</div>

<p>See details in:</p>
<p><a href="http://localhost:1313/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/rsync/">rsync.md</a></p>
<h2 id="clickhouse-backup">clickhouse-backup</h2>
<p>Pros:</p>
<ul>
<li>Low CPU / RAM usage.</li>
<li>Suitable to recover both schema &amp; data for all tables at once.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Table schema should be the same.</li>
</ul>
<p>Just create the backup on server 1, upload it to server 2, and restore the backup.</p>
<p>See <a href="https://github.com/Altinity/clickhouse-backup" target="_blank">https://github.com/Altinity/clickhouse-backup</a></p>
<p><a href="https://altinity.com/blog/introduction-to-clickhouse-backups-and-clickhouse-backup" target="_blank">https://altinity.com/blog/introduction-to-clickhouse-backups-and-clickhouse-backup</a></p>
<h2 id="fetch-from-zookeeper-path">Fetch from zookeeper path</h2>
<p>Pros:</p>
<ul>
<li>Low CPU / RAM usage.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Table schema should be the same.</li>
<li>Works only when the source and the destination clickhouse servers share the same zookeeper (without chroot)</li>
<li>Needs to access zookeeper and ClickHouse replication ports: (<code>interserver_http_port</code> or <code>interserver_https_port</code>)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FETCH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">partition_expr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;path-in-zookeeper&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><a href="http://localhost:1313/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/fetch_alter_table/">alter table fetch detail</a></p>
<h2 id="using-the-replication-protocol-by-adding-a-new-replica">Using the replication protocol by adding a new replica</h2>
<p>Just make one more replica in another place.</p>
<p>Pros:</p>
<ul>
<li>Simple to setup</li>
<li>Data is consistent all the time automatically.</li>
<li>Low CPU and network usage should be tuned.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Needs to reach both zookeeper client (2181) and ClickHouse replication ports: (<code>interserver_http_port</code> or <code>interserver_https_port</code>)</li>
<li>In case of cluster migration, zookeeper need’s to be migrated too.</li>
<li>Replication works both ways so new replica should be outside the main cluster.</li>
</ul>
<p>Check the details in:</p>
<p><a href="http://localhost:1313/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/add_remove_replica/">Add a replica to a Cluster</a></p>
<h2 id="see-also">See also</h2>
<h3 id="github-issues">Github issues</h3>
<p><a href="https://github.com/ClickHouse/ClickHouse/issues/10943" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/10943</a>
<a href="https://github.com/ClickHouse/ClickHouse/issues/20219" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/20219</a>
<a href="https://github.com/ClickHouse/ClickHouse/pull/17871" target="_blank">https://github.com/ClickHouse/ClickHouse/pull/17871</a></p>
<h3 id="other-links">Other links</h3>
<p><a href="https://habr.com/ru/company/avito/blog/500678/" target="_blank">https://habr.com/ru/company/avito/blog/500678/</a></p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-995190106d7ed9690cfa9cfd364aec72">1 - MSSQL bcp pipe to clickhouse-client</h1>
    <div class="lead">Export from MSSQL to ClickHouse</div>
	<h2 id="how-to-pipe-data-from-bcp-export-tool-for-mssql-database">How to pipe data from bcp export tool for MSSQL database</h2>
<h3 id="prepare-tables">Prepare tables</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>LAPTOP.localdomain :<span style="color:#ce5c00;font-weight:bold">)</span> CREATE TABLE tbl<span style="color:#ce5c00;font-weight:bold">(</span>key UInt32<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">ENGINE</span><span style="color:#ce5c00;font-weight:bold">=</span>MergeTree ORDER BY key<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@LAPTOP:/home/user# sqlcmd -U sa -P Password78
</span></span><span style="display:flex;"><span>1&gt; WITH t0<span style="color:#ce5c00;font-weight:bold">(</span>i<span style="color:#ce5c00;font-weight:bold">)</span> AS <span style="color:#ce5c00;font-weight:bold">(</span>SELECT <span style="color:#0000cf;font-weight:bold">0</span> UNION ALL SELECT 0<span style="color:#ce5c00;font-weight:bold">)</span>, t1<span style="color:#ce5c00;font-weight:bold">(</span>i<span style="color:#ce5c00;font-weight:bold">)</span> AS <span style="color:#ce5c00;font-weight:bold">(</span>SELECT <span style="color:#0000cf;font-weight:bold">0</span> FROM t0 a, t0 b<span style="color:#ce5c00;font-weight:bold">)</span>, t2<span style="color:#ce5c00;font-weight:bold">(</span>i<span style="color:#ce5c00;font-weight:bold">)</span> AS <span style="color:#ce5c00;font-weight:bold">(</span>SELECT <span style="color:#0000cf;font-weight:bold">0</span> FROM t1 a, t1 b<span style="color:#ce5c00;font-weight:bold">)</span>, t3<span style="color:#ce5c00;font-weight:bold">(</span>i<span style="color:#ce5c00;font-weight:bold">)</span> AS <span style="color:#ce5c00;font-weight:bold">(</span>SELECT <span style="color:#0000cf;font-weight:bold">0</span> FROM t2 a, t2 b<span style="color:#ce5c00;font-weight:bold">)</span>, t4<span style="color:#ce5c00;font-weight:bold">(</span>i<span style="color:#ce5c00;font-weight:bold">)</span> AS <span style="color:#ce5c00;font-weight:bold">(</span>SELECT <span style="color:#0000cf;font-weight:bold">0</span> FROM t3 a, t3 b<span style="color:#ce5c00;font-weight:bold">)</span>, t5<span style="color:#ce5c00;font-weight:bold">(</span>i<span style="color:#ce5c00;font-weight:bold">)</span> AS <span style="color:#ce5c00;font-weight:bold">(</span>SELECT <span style="color:#0000cf;font-weight:bold">0</span> FROM t4 a, t3 b<span style="color:#ce5c00;font-weight:bold">)</span>,n<span style="color:#ce5c00;font-weight:bold">(</span>i<span style="color:#ce5c00;font-weight:bold">)</span> AS <span style="color:#ce5c00;font-weight:bold">(</span>SELECT ROW_NUMBER<span style="color:#ce5c00;font-weight:bold">()</span> OVER<span style="color:#ce5c00;font-weight:bold">(</span>ORDER BY <span style="color:#ce5c00;font-weight:bold">(</span>SELECT 0<span style="color:#ce5c00;font-weight:bold">))</span> FROM t5<span style="color:#ce5c00;font-weight:bold">)</span> SELECT i INTO tbl FROM n WHERE i BETWEEN <span style="color:#0000cf;font-weight:bold">1</span> AND <span style="color:#0000cf;font-weight:bold">16777216</span>
</span></span><span style="display:flex;"><span>2&gt; GO
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16777216</span> rows affected<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@LAPTOP:/home/user# sqlcmd -U sa -P Password78 -Q <span style="color:#4e9a06">&#34;SELECT count(*) FROM tbl&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-----------
</span></span><span style="display:flex;"><span>   <span style="color:#0000cf;font-weight:bold">16777216</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> rows affected<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="piping">Piping</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@LAPTOP:/home/user# mkfifo import_pipe
</span></span><span style="display:flex;"><span>root@LAPTOP:/home/user# bcp <span style="color:#4e9a06">&#34;SELECT * FROM tbl&#34;</span> queryout import_pipe -t, -c -b <span style="color:#0000cf;font-weight:bold">200000</span> -U sa -P Password78 -S localhost <span style="color:#000;font-weight:bold">&amp;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#0000cf;font-weight:bold">6038</span>
</span></span><span style="display:flex;"><span>root@LAPTOP:/home/user#
</span></span><span style="display:flex;"><span>Starting copy...
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">2000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">4000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">5000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">6000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">7000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">8000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">9000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">11000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">12000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">13000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">14000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">15000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">16000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">17000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">18000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">19000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">20000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">21000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">22000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">23000</span>
</span></span><span style="display:flex;"><span>-- Enter
</span></span><span style="display:flex;"><span>root@LAPTOP:/home/user# cat import_pipe <span style="color:#000;font-weight:bold">|</span> clickhouse-client --query <span style="color:#4e9a06">&#34;INSERT INTO tbl FORMAT CSV&#34;</span> <span style="color:#000;font-weight:bold">&amp;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">16769000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">16770000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">16771000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">16772000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">16773000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">16774000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">16775000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">16776000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1000</span> rows successfully bulk-copied to host-file. Total received: <span style="color:#0000cf;font-weight:bold">16777000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">16777216</span> rows copied.
</span></span><span style="display:flex;"><span>Network packet size <span style="color:#ce5c00;font-weight:bold">(</span>bytes<span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#0000cf;font-weight:bold">4096</span>
</span></span><span style="display:flex;"><span>Clock Time <span style="color:#ce5c00;font-weight:bold">(</span>ms.<span style="color:#ce5c00;font-weight:bold">)</span> Total     : <span style="color:#0000cf;font-weight:bold">11540</span>  Average : <span style="color:#ce5c00;font-weight:bold">(</span>1453831.5 rows per sec.<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>1<span style="color:#ce5c00;font-weight:bold">]</span>-  Done                    bcp <span style="color:#4e9a06">&#34;SELECT * FROM tbl&#34;</span> queryout import_pipe -t, -c -b <span style="color:#0000cf;font-weight:bold">200000</span> -U sa -P Password78 -S localhost
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>2<span style="color:#ce5c00;font-weight:bold">]</span>+  Done                    cat import_pipe <span style="color:#000;font-weight:bold">|</span> clickhouse-client --query <span style="color:#4e9a06">&#34;INSERT INTO tbl FORMAT CSV&#34;</span>
</span></span></code></pre></div><h3 id="another-shell">Another shell</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@LAPTOP:/home/user# <span style="color:#204a87;font-weight:bold">for</span> i in <span style="color:#4e9a06">`</span>seq <span style="color:#0000cf;font-weight:bold">1</span> 600<span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span> clickhouse-client -q <span style="color:#4e9a06">&#34;select count() from tbl&#34;</span><span style="color:#000;font-weight:bold">;</span>sleep 1<span style="color:#000;font-weight:bold">;</span>  <span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1048545</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4194180</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6291270</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">9436905</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">11533995</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">13631085</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">16777216</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">16777216</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">16777216</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">16777216</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-11fb2857cf3b2c7a29cb57f3cb63eba6">2 - Add/Remove a new replica to a ClickHouse cluster</h1>
    <div class="lead">How to add/remove a new replica manually and using clickhouse-backup</div>
	<h2 id="add-nodesreplicas-to-a-cluster">ADD nodes/Replicas to a Cluster</h2>
<p>To add some replicas to an existing cluster if -30TB then better to use replication:</p>
<ul>
<li>don’t add the <code>remote_servers.xml</code> until replication is done.</li>
<li>Add these files and restart to limit bandwidth and avoid saturation (70% total bandwidth):</li>
</ul>
<p><a href="https://clickhouse.com/docs/en/operations/settings/settings/#max_replicated_fetches_network_bandwidth_for_server" target="_blank">Core Settings | ClickHouse Docs</a></p>
<p>💡 Do the <strong>Gbps to Bps</strong> math correctly. For 10G —&gt; 1250MB/s —&gt; 1250000000 B/s and change <code>max_replicated_*</code> settings accordingly:</p>
<ul>
<li>Nodes replicating from:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;clickhouse&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&lt;profiles&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">&lt;default&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">&lt;max_replicated_sends_network_bandwidth_for_server&gt;</span>50000<span style="color:#204a87;font-weight:bold">&lt;/max_replicated_sends_network_bandwidth_for_server&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">&lt;/default&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&lt;/profiles&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><ul>
<li>Nodes replicating to:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;clickhouse&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&lt;profiles&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">&lt;default&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">&lt;max_replicated_fetches_network_bandwidth_for_server&gt;</span>50000<span style="color:#204a87;font-weight:bold">&lt;/max_replicated_fetches_network_bandwidth_for_server&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">&lt;/default&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&lt;/profiles&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><h3 id="manual-method-ddl">Manual method (DDL)</h3>
<ul>
<li>Create tables <code>manually</code> and be sure macros in all replicas are aligned with the ZK path. If zk path uses <code>{cluster}</code> then this method won’t work. ZK path should use <code>{shard}</code> and <code>{replica}</code> or <code>{uuid}</code> (if databases are Atomic) only.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- DDL for Databases
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">concat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CREATE DATABASE &#34;&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#34; ENGINE = &#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">engine_full</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;;&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">databases</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OUTFILE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;databases.sql&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">FORMAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TSVRaw</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- DDL for tables and views
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">replaceRegexpOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">replaceOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">concat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">create_table_query</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;;&#39;</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;(&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;ON CLUSTER \&#39;</span><span style="color:#a40000">{</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#a40000">}\</span><span style="color:#4e9a06">&#39; (&#39;</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;CREATE (TABLE|DICTIONARY|VIEW|LIVE VIEW|WINDOW VIEW)&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;CREATE \\1 IF NOT EXISTS&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;system&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;INFORMATION_SCHEMA&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">create_table_query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.inner.%%&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.inner_id.%%&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OUTFILE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/tmp/schema.sql&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">STDOUT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">FORMAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TSVRaw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">show_table_uuid_in_table_create_query_if_not_nil</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--- DDL only for materialized views
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">replaceRegexpOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">replaceOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">concat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">create_table_query</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;;&#39;</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;TO&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;ON CLUSTER \&#39;</span><span style="color:#a40000">{</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#a40000">}\</span><span style="color:#4e9a06">&#39; TO&#39;</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;(CREATE MATERIALIZED VIEW)&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;\\1 IF NOT EXISTS&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;system&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;INFORMATION_SCHEMA&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">create_table_query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.inner.%%&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.inner_id.%%&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">as_select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OUTFILE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/tmp/schema.sql&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">APPEND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">STDOUT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">FORMAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TSVRaw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">show_table_uuid_in_table_create_query_if_not_nil</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This will generate the UUIDs in the CREATE TABLE definition, something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">insert_test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UUID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;51b41170-5192-4947-b13b-d4094c511f06&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id_order</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id_plat</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id_warehouse</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id_product</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">order_type</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">order_status</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">datetime_order</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DateTime</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">units</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Int16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">total</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Float32</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/tables/{uuid}/{shard}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuple</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id_order</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id_plat</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id_warehouse</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_granularity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>Copy both SQL to destination replica and execute</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">clickhouse</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">client</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">--host localhost --port 9000 -mn &lt; databases.sql
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">clickhouse</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">client</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">--host localhost --port 9000 -mn &lt; schema.sql
</span></span></span></code></pre></div><h3 id="using-clickhouse-backup">Using clickhouse-backup</h3>
<ul>
<li>Using clickhouse-backup to copy the schema of a replica to another is also convenient and moreover if using Atomic database with <code>{uuid}</code> macros in ReplicatedMergeTree engines:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo -u clickhouse clickhouse-backup --schema --rbac create_remote full-replica
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># From the destination replica</span>
</span></span><span style="display:flex;"><span>sudo -u clickhouse clickhouse-backup --schema --rbac restore_remote full-replica
</span></span></code></pre></div><h3 id="check-that-schema-migration-was-successful-and-node-is-replicating">Check that schema migration was successful and node is replicating</h3>
<ul>
<li>To check that the schema migration has been <strong>successful</strong> query system.replicas:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">replica_is_active</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replicas</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FORMAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Vertical</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>
<p>Check how the replication process is performing using <a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-replication-queue/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-replication-queue/</a></p>
<ul>
<li>If there are many postponed tasks with message:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">Not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">executing</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">fetch</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">part</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000">_22719661_22719661_0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">because</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fetches</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">already</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">executing</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">                                                                                                      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2023</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">06</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>then it is ok, the maximum replication slots are being used. Exceptions are not OK and should be investigated</p>
</li>
<li>
<p>If migration was sucessful and replication is working then wait until the replication is finished. It may take some days depending on how much data is being replicated. After this edit the cluster configuration xml file for all replicas (<code>remote_servers.xml</code>) and add the new replica to the cluster.</p>
</li>
</ul>
<h3 id="possible-problems">Possible problems</h3>
<h4 id="exception-replica_already_exists"><strong>Exception</strong> <code>REPLICA_ALREADY_EXISTS</code></h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">253</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Received</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">There</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">was</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">an</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">error</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dl</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ny2</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">internal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">253</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Replica</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">clickhouse</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">tables</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000">c3503c3</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ed3c</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">443</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000">cb3</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ef41b3aed0a8</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">replicas</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">dl</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ny2</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">internal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">already</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">REPLICA_ALREADY_EXISTS</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">official</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">REPLICA_ALREADY_EXISTS</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">xxxx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">yyyy</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UUID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;3c3503c3-ed3c-443b-9cb3-ef41b3aed0a8&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The DDLs have been executed and some tables have been created and after that dropped but some left overs are left in ZK:</p>
<ul>
<li>If databases can be dropped then use <code>DROP DATABASE xxxxx SYNC</code></li>
<li>If databases cannot be dropped use <code>SYSTEM DROP REPLICA ‘replica_name’ FROM db.table</code></li>
</ul>
<h4 id="exception-table_already_exists"><strong>Exception</strong> <code>TABLE_ALREADY_EXISTS</code></h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">57</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Received</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">There</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">was</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">an</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">error</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dl</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ny2</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">internal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">57</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Directory</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000">c3</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000">c3503c3</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ed3c</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">443</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000">cb3</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ef41b3aed0a8</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">already</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TABLE_ALREADY_EXISTS</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">official</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TABLE_ALREADY_EXISTS</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">xxxx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">yyyy</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UUID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;3c3503c3-ed3c-443b-9cb3-ef41b3aed0a8&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Tables have not been dropped correctly:</p>
<ul>
<li>If databases can be dropped then use <code>DROP DATABASE xxxxx SYNC</code></li>
<li>If databases cannot be dropped use:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">concat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;DROP TABLE &#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39; SYNC;&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tables</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;system&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;INFORMATION_SCHEMA&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OUTFILE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/tmp/drop_tables.sql&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">FORMAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TSVRaw</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="tuning">Tuning</h3>
<ul>
<li>Sometimes replication goes very fast and if you have a tiered storage hot/cold you could run out of space, so for that it is interesting to:
<ul>
<li>reduce fetches from 8 to 4</li>
<li>increase moves from 8 to 16</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;profiles&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;default&gt;</span>        
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;max_replicated_fetches_network_bandwidth_for_server&gt;</span>625000000<span style="color:#204a87;font-weight:bold">&lt;/max_replicated_fetches_network_bandwidth_for_server&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;background_fetches_pool_size&gt;</span>4<span style="color:#204a87;font-weight:bold">&lt;/background_fetches_pool_size&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;background_move_pool_size&gt;</span>16<span style="color:#204a87;font-weight:bold">&lt;/background_move_pool_size&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/default&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/profiles&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><ul>
<li>Also to monitor this with:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%Move%&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5050155</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">af4a</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">474</span><span style="color:#000">f</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">a07a</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">f2f7e95fb395</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">metric</span><span style="color:#a40000">─────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┬─</span><span style="color:#000">description</span><span style="color:#a40000">──────────────────────────────────────────────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BackgroundMovePoolTask</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tasks</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BackgroundProcessingPool</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">moves</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└────────────────────────┴───────┴──────────────────────────────────────────────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">164</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">dnieto</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%Fetch%&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%Fetch%&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">992</span><span style="color:#000">cae2a</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">fb58</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4150</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">a088</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">83273805</span><span style="color:#000">d0c4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">metric</span><span style="color:#a40000">────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┬─</span><span style="color:#000">description</span><span style="color:#a40000">───────────────────────────────────────────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedFetch</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">being</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fetched</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BackgroundFetchesPoolTask</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fetches</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">an</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">associated</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">background</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pool</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└───────────────────────────┴───────┴───────────────────────────────────────────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">163</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>There are new tables in v23 <code>system.replicated_fetches</code> and <code>system.moves</code> check it out for more info.</li>
<li>if needed just stop replication using <code>SYSTEM STOP FETCHES</code> from the replicating nodes</li>
</ul>
<h2 id="remove-nodesreplicas-from-a-cluster">REMOVE nodes/Replicas from a Cluster</h2>
<ul>
<li>It is important to know which replica/node you want to remove to avoid problems. To check it you need to connect to the replica/node you want to remove and:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica_name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replicas</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">replica_name</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arg_t01</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arg_t02</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arg_t03</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arg_t04</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>After that we need connect to a replica different from the one that we want to remove (arg_tg01) and execute:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;arg_t01&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>This cannot be executed on the replica we want to remove (drop local replica), please use <strong><code>DROP TABLE/DATABASE</code></strong> for that. <strong><code>DROP REPLICA</code></strong> does not drop any tables and does not remove any data or metadata from disk:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- What happens if executing system drop replica in the local replica to remove.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;arg_t01&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">017</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Received</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exception</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">server</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">):</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">305</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Received</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dnieto</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">zenbook</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lan</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">We</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">can</span><span style="color:#4e9a06">&#39;t drop local replica, please use `DROP TABLE` if you want to clean the data and drop this replica. (TABLE_WAS_NOT_DROPPED)
</span></span></span></code></pre></div><ul>
<li>After DROP REPLCA, we need to check that the replica is gone from the list or replicas. Connect to a node and execute:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica_name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replicas</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">replica_name</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arg_t02</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arg_t03</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arg_t04</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- We should see there is no replica arg_t01
</span></span></span></code></pre></div><ul>
<li>Delete the replica in the cluster configuration: <code>remote_servers.xml</code> and shutdown the node/replica removed.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-49f38a883c7ec4fc908726a6854c7bbe">3 - clickhouse-copier</h1>
    <div class="lead">clickhouse-copier</div>
	<p>The description of the utility and its parameters, as well as examples of the config files that you need to create for the copier are in the official doc <a href="https://clickhouse.com/docs/en/operations/utilities/clickhouse-copier/" target="_blank">ClickHouse copier utility</a></p>
<p>The steps to run a task:</p>
<ol>
<li>
<p>Create a config file for clickhouse-copier (zookeeper.xml)</p>
<p><a href="https://clickhouse.com/docs/en/operations/utilities/clickhouse-copier/#format-of-zookeeper-xml" target="_blank">ZooKeeper config format</a></p>
</li>
<li>
<p>Create a config file for the task (task1.xml)</p>
<p><a href="https://clickhouse.com/docs/en/operations/utilities/clickhouse-copier/#configuration-of-copying-tasks" target="_blank">Copy task configuration</a></p>
</li>
<li>
<p>Create the task in ZooKeeper and start an instance of clickhouse-copier</p>
<p><code>clickhouse-copier --daemon --base-dir=/opt/clickhouse-copier --config=/opt/clickhouse-copier/zookeeper.xml --task-path=/clickhouse/copier/task1 --task-file=/opt/clickhouse-copier/task1.xml</code></p>
<p>If the node in ZooKeeper already exists and you want to change it, you need to add the <code>task-upload-force</code> parameter:</p>
<p><code>clickhouse-copier --daemon --base-dir=/opt/clickhouse-copier --config=/opt/clickhouse-copier/zookeeper.xml --task-path=/clickhouse/copier/task1 --task-file=/opt/clickhouse-copier/task1.xml --task-upload-force=1</code></p>
<p>If you want to run another instance of clickhouse-copier for the same task, you need to copy the config file (zookeeper.xml) to another server, and run this command:</p>
<p><code>clickhouse-copier --daemon --base-dir=/opt/clickhouse-copier --config=/opt/clickhouse-copier/zookeeper.xml --task-path=/clickhouse/copier/task1</code></p>
</li>
</ol>
<p>The number of simultaneously running instances is controlled be the <code>max_workers</code> parameter in your task configuration file. If you run more workers superfluous workers will sleep and log messages like this:</p>
<p><code>&lt;Debug&gt; ClusterCopier: Too many workers (1, maximum 1). Postpone processing</code></p>
<h3 id="see-also">See also</h3>
<ul>
<li><a href="https://clickhouse.com/docs/en/operations/utilities/clickhouse-copier/" target="_blank">https://clickhouse.com/docs/en/operations/utilities/clickhouse-copier/</a></li>
<li>Никита Михайлов. Кластер ClickHouse ctrl-с ctrl-v. HighLoad++ Весна 2021 <a href="https://raw.githubusercontent.com/ClickHouse/clickhouse-presentations/master/highload2021/copier.pdf" target="_blank">slides</a></li>
<li>21.7 have a huge bulk of fixes / improvements. <a href="https://github.com/ClickHouse/ClickHouse/pull/23518" target="_blank">https://github.com/ClickHouse/ClickHouse/pull/23518</a></li>
<li><a href="https://altinity.com/blog/2018/8/22/clickhouse-copier-in-practice" target="_blank">https://altinity.com/blog/2018/8/22/clickhouse-copier-in-practice</a></li>
<li><a href="https://github.com/getsentry/snuba/blob/master/docs/clickhouse-copier.md" target="_blank">https://github.com/getsentry/snuba/blob/master/docs/clickhouse-copier.md</a></li>
<li><a href="https://hughsite.com/post/clickhouse-copier-usage.html" target="_blank">https://hughsite.com/post/clickhouse-copier-usage.html</a></li>
<li><a href="https://www.jianshu.com/p/c058edd664a6" target="_blank">https://www.jianshu.com/p/c058edd664a6</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e1f1d825521583c133a8d3bf2a72f6e7">3.1 - clickhouse-copier 20.3 and earlier</h1>
    <div class="lead">clickhouse-copier 20.3 and earlier</div>
	<p>Clickhouse-copier was created to move data between clusters.
It runs simple INSERT…SELECT queries and can copy data between tables with different engine parameters and between clusters with different number of shards.
In the task configuration file you need to describe the layout of the source and the target cluster, and list the tables that you need to copy. You can copy whole tables or specific partitions.
Clickhouse-copier uses temporary distributed tables to select from the source cluster and insert into the target cluster.</p>
<h2 id="the-process-is-as-follows">The process is as follows</h2>
<ol>
<li>Process the configuration files.</li>
<li>Discover the list of partitions if not provided in the config.</li>
<li>Copy partitions one by one.
<ol>
<li>Drop the partition from the target table if it’s not empty</li>
<li>Copy data from source shards one by one.
<ol>
<li>Check if there is data for the partition on a source shard.</li>
<li>Check the status of the task in ZooKeeper.</li>
<li>Create target tables on all shards of the target cluster.</li>
<li>Insert the partition of data into the target table.</li>
</ol>
</li>
<li>Mark the partition as completed in ZooKeeper.</li>
</ol>
</li>
</ol>
<p>If there are several workers running simultaneously, they will assign themselves to different source shards.
If a worker was interrupted, another worker can be started to continue the task. The next worker will drop incomplete partitions and resume the copying.</p>
<h2 id="configuring-the-engine-of-the-target-table">Configuring the engine of the target table</h2>
<p>Clickhouse-copier uses the engine from the task configuration file for these purposes:</p>
<ul>
<li>to create target tables if they don’t exist.</li>
<li>PARTITION BY: to SELECT a partition of data from the source table, to DROP existing partitions from target tables.</li>
</ul>
<p>Clickhouse-copier does not support the old MergeTree format.
However, you can create the target tables manually and specify the engine in the task configuration file in the new format so that clickhouse-copier can parse it for its SELECT queries.</p>
<h2 id="how-to-monitor-the-status-of-running-tasks">How to monitor the status of running tasks</h2>
<p>Clickhouse-copier uses ZooKeeper to keep track of the progress and to communicate between workers.
Here is a list of queries that you can use to see what’s happening.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">--task-path /clickhouse/copier/task1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The task config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------+---------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">description</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2020</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">task_active_workers_version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2020</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">07</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">08</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">tables</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">task_active_workers</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Running workers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/task_active_workers&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The list of processed tables
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The list of processed partitions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">201909</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The status of a partition
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">shards</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">partition_active_workers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The status of source shards
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/shards&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----+---------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">37</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">49</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4907e613a878d5b7819f49cc367b9f3f">3.2 - clickhouse-copier 20.4 - 21.6</h1>
    <div class="lead">clickhouse-copier 20.4 - 21.6</div>
	<p>Clickhouse-copier was created to move data between clusters.
It runs simple <code>INSERT…SELECT</code> queries and can copy data between tables with different engine parameters and between clusters with different number of shards.
In the task configuration file you need to describe the layout of the source and the target cluster, and list the tables that you need to copy. You can copy whole tables or specific partitions.
Clickhouse-copier uses temporary distributed tables to select from the source cluster and insert into the target cluster.</p>
<p>The behavior of clickhouse-copier was changed in 20.4:</p>
<ul>
<li>Now clickhouse-copier inserts data into intermediate tables, and after the insert finishes successfully clickhouse-copier attaches the completed partition into the target table. This allows for incremental data copying, because the data in the target table is intact during the process. <strong>Important note:</strong> ATTACH PARTITION respects the <code>max_partition_size_to_drop</code> limit. Make sure the <code>max_partition_size_to_drop</code> limit is big enough (or set to zero) in the destination cluster. If clickhouse-copier is unable to attach a partition because of the limit, it will proceed to the next partition, and it will drop the intermediate table when the task is finished (if the intermediate table is less than the <code>max_table_size_to_drop</code> limit). <strong>Another important note:</strong> ATTACH PARTITION is replicated. The attached partition will need to be downloaded by the other replicas. This can create significant network traffic between ClickHouse nodes. If an attach takes a long time, clickhouse-copier will log a timeout and will proceed to the next step.</li>
<li>Now clickhouse-copier splits the source data into chunks and copies them one by one. This is useful for big source tables, when inserting one partition of data can take hours. If there is an error during the insert clickhouse-copier has to drop the whole partition and start again. The <code>number_of_splits</code> parameter lets you split your data into chunks so that in case of an exception clickhouse-copier has to re-insert only one chunk of the data.</li>
<li>Now clickhouse-copier runs <code>OPTIMIZE target_table PARTITION ... DEDUPLICATE</code> for non-Replicated MergeTree tables. <strong>Important note:</strong> This is a very strange feature that can do more harm than good. We recommend to disable it by configuring the engine of the target table as Replicated in the task configuration file, and create the target tables manually if they are not supposed to be replicated. Intermediate tables are always created as plain MergeTree.</li>
</ul>
<h2 id="the-process-is-as-follows">The process is as follows</h2>
<ol>
<li>Process the configuration files.</li>
<li>Discover the list of partitions if not provided in the config.</li>
<li>Copy partitions one by one  ** The metadata in ZooKeeper suggests the order described here.**
<ol>
<li>Copy chunks of data one by one.
<ol>
<li>Copy data from source shards one by one.
<ol>
<li>Create intermediate tables on all shards of the target cluster.</li>
<li>Check the status of the chunk in ZooKeeper.</li>
<li>Drop the partition from the intermediate table if the previous attempt was interrupted.</li>
<li>Insert the chunk of data into the intermediate tables.</li>
<li>Mark the shard as completed in ZooKeeper</li>
</ol>
</li>
</ol>
</li>
<li>Attach the chunks of the completed partition into the target table one by one
<ol>
<li>Attach a chunk into the target table.</li>
<li><strong>non-Replicated:</strong> Run OPTIMIZE target_table DEDUPLICATE for the partition on the target table.</li>
</ol>
</li>
</ol>
</li>
<li>Drop intermediate tables (may not succeed if the tables are bigger than <code>max_table_size_to_drop</code>).</li>
</ol>
<p>If there are several workers running simultaneously, they will assign themselves to different source shards.
If a worker was interrupted, another worker can be started to continue the task. The next worker will drop incomplete partitions and resume the copying.</p>
<h2 id="configuring-the-engine-of-the-target-table">Configuring the engine of the target table</h2>
<p>Clickhouse-copier uses the engine from the task configuration file for these purposes:</p>
<ul>
<li>to create target and intermediate tables if they don’t exist.</li>
<li>PARTITION BY: to SELECT a partition of data from the source table, to ATTACH partitions into target tables, to DROP incomplete partitions from intermediate tables, to OPTIMIZE partitions after they are attached to the target.</li>
<li>ORDER BY: to SELECT a chunk of data from the source table.</li>
</ul>
<p>Here is an example of SELECT that clickhouse-copier runs to get the sixth of ten chunks of data:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">the</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clause</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">the</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">expression</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">partition_key</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cityHash64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">the</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clause</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Clickhouse-copier does not support the old MergeTree format.
However, you can create the intermediate tables manually with the same engine as the target tables (otherwise ATTACH will not work), and specify the engine in the task configuration file in the new format so that clickhouse-copier can parse it for SELECT, ATTACH PARTITION and DROP PARTITION queries.</p>
<p><strong>Important note</strong>: always configure engine as Replicated to disable OPTIMIZE … DEDUPLICATE (unless you know why you need clickhouse-copier to run OPTIMIZE … DEDUPLICATE).</p>
<h2 id="how-to-configure-the-number-of-chunks">How to configure the number of chunks</h2>
<p>The default value for <code>number_of_splits</code> is 10.
You can change this parameter in the <code>table</code> section of the task configuration file. We recommend setting it to 1 for smaller tables.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;cluster_push&gt;</span>target_cluster<span style="color:#204a87;font-weight:bold">&lt;/cluster_push&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;database_push&gt;</span>target_database<span style="color:#204a87;font-weight:bold">&lt;/database_push&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;table_push&gt;</span>target_table<span style="color:#204a87;font-weight:bold">&lt;/table_push&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;number_of_splits&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/number_of_splits&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;engine&gt;</span>Engine=Replicated...<span style="color:#204a87;font-weight:bold">&lt;engine&gt;</span>
</span></span></code></pre></div><h2 id="how-to-monitor-the-status-of-running-tasks">How to monitor the status of running tasks</h2>
<p>Clickhouse-copier uses ZooKeeper to keep track of the progress and to communicate between workers.
Here is a list of queries that you can use to see what’s happening.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">--task-path=/clickhouse/copier/task1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The task config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------+---------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">description</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">status</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">task_active_workers_version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">tables</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">47</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">47</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">task_active_workers</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Status
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/status&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Running workers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/task_active_workers&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The list of processed tables
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The list of processed partitions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">202103</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">47</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">202102</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">202101</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">27</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">36</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">202012</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">08</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The status of a partition
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">piece_0</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">attach_is_done</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The status of a piece
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/piece_N&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------------------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">shards</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">is_dirty</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">51</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">partition_piece_active_workers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">54</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">clean_start</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">54</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The status of source shards
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/piece_N/shards&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----+---------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">54</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-092d5c190f9504b9126ab5f7779a2089">3.3 - Kubernetes job for clickhouse-copier</h1>
    <div class="lead">Kubernetes job for clickhouse-copier</div>
	<h1 id="clickhouse-copier-deployment-in-kubernetes">ClickHouse-copier deployment in kubernetes</h1>
<p>Clickhouse-copier can be deployed in a kubernetes environment to automate some simple backups or copy fresh data between clusters.</p>
<p>Some documentation to read:</p>
<ul>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/altinity-kb-clickhouse-copier/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/altinity-kb-clickhouse-copier/</a></li>
<li><a href="https://clickhouse.com/docs/en/operations/utilities/clickhouse-copier/" target="_blank">https://clickhouse.com/docs/en/operations/utilities/clickhouse-copier/</a></li>
</ul>
<h2 id="deployment">Deployment</h2>
<p>Use a kubernetes job is recommended but a simple pod can be used if you only want to execute the copy one time.</p>
<p>Just edit/change all the <code>yaml</code> files to your needs.</p>
<h3 id="1-create-the-pvc">1) Create the PVC:</h3>
<p>First create a namespace in which all the pods and resources are going to be deployed</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create namespace clickhouse-copier
</span></span></code></pre></div><p>Then create the PVC using a <code>storageClass</code> gp2-encrypted class or use any other storageClass from other providers:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">copier-logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clickhouse-copier</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">storageClassName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gp2-encrypted</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">accessModes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">ReadWriteOnce</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">storage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>and deploy:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n clickhouse-copier create -f ./kubernetes/copier-pvc.yaml
</span></span></code></pre></div><h3 id="2-create-the-configmap">2) Create the configmap:</h3>
<p>The configmap has both files <code>zookeeper.xml</code> and <code>task01.xml</code> with the zookeeper node listing and the parameters for the task respectively.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">copier-config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clickhouse-copier</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">task01.xml</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        &lt;clickhouse&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;logger&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;console&gt;true&lt;/console&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;log remove=&#34;remove&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;errorlog remove=&#34;remove&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;level&gt;trace&lt;/level&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;/logger&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;remote_servers&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;all-replicated&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;shard&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        &lt;replica&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;host&gt;clickhouse01.svc.cluster.local&lt;/host&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;port&gt;9000&lt;/port&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;user&gt;chcopier&lt;/user&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;password&gt;pass&lt;/password&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        &lt;/replica&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        &lt;replica&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;host&gt;clickhouse02.svc.cluster.local&lt;/host&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;port&gt;9000&lt;/port&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;user&gt;chcopier&lt;/user&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;password&gt;pass&lt;/password&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        &lt;/replica&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;/shard&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;/all-replicated&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;all-sharded&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;!-- &lt;secret&gt;&lt;/secret&gt; --&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;shard&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        &lt;replica&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;host&gt;clickhouse03.svc.cluster.local&lt;/host&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;port&gt;9000&lt;/port&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;user&gt;chcopier&lt;/user&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;password&gt;pass&lt;/password&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        &lt;/replica&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;/shard&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;shard&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        &lt;replica&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;host&gt;clickhouse03.svc.cluster.local&lt;/host&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;port&gt;9000&lt;/port&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;user&gt;chcopier&lt;/user&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                            &lt;password&gt;pass&lt;/password&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        &lt;/replica&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;/shard&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;/all-sharded&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;/remote_servers&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;max_workers&gt;1&lt;/max_workers&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;settings_pull&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;readonly&gt;1&lt;/readonly&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;/settings_pull&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;settings_push&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;readonly&gt;0&lt;/readonly&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;/settings_push&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;settings&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;connect_timeout&gt;3&lt;/connect_timeout&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;insert_distributed_sync&gt;1&lt;/insert_distributed_sync&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;/settings&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;tables&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;table_sales&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;cluster_pull&gt;all-replicated&lt;/cluster_pull&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;database_pull&gt;default&lt;/database_pull&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;table_pull&gt;fact_sales_event&lt;/table_pull&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;cluster_push&gt;all-sharded&lt;/cluster_push&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;database_push&gt;default&lt;/database_push&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;table_push&gt;fact_sales_event&lt;/table_push&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;engine&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        Engine=ReplicatedMergeTree(&#39;/clickhouse/{cluster}/tables/{shard}/fact_sales_event&#39;, &#39;{replica}&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        PARTITION BY toYYYYMM(timestamp)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        ORDER BY (channel_id, product_id)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                        SETTINGS index_granularity = 8192
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;/engine&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;sharding_key&gt;rand()&lt;/sharding_key&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;/table_ventas&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;/tables&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        &lt;/clickhouse&gt;</span><span style="color:#f8f8f8;text-decoration:underline">        
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">zookeeper.xml</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        &lt;clickhouse&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;logger&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;level&gt;trace&lt;/level&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;size&gt;100M&lt;/size&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;count&gt;3&lt;/count&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;/logger&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;zookeeper&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;node&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;host&gt;zookeeper1.svc.cluster.local&lt;/host&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;port&gt;2181&lt;/port&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;/node&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;node&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;host&gt;zookeeper2.svc.cluster.local&lt;/host&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;port&gt;2181&lt;/port&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;/node&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;node&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;host&gt;zookeeper3.svc.cluster.local&lt;/host&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                    &lt;port&gt;2181&lt;/port&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                &lt;/node&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &lt;/zookeeper&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        &lt;/clickhouse&gt;</span><span style="color:#f8f8f8;text-decoration:underline">        
</span></span></span></code></pre></div><p>and deploy:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n clickhouse-copier create -f ./kubernetes/copier-configmap.yaml
</span></span></code></pre></div><p>The <code>task01.xml</code> file has many parameters to take into account explained in the <a href="https://clickhouse.com/docs/en/operations/utilities/clickhouse-copier/" target="_blank">clickhouse-copier documentation</a>. Important to note that it is needed a FQDN for the zookeeper nodes and clickhouse server that are valid for the cluster. As the deployment creates a new namespace, it is recommended to use a FQDN linked to a service. For example <code>zookeeper01.svc.cluster.local</code>. This file should be adapted to both clusters topologies and to the needs of the user.</p>
<p>The <code>zookeeper.xml</code> file is pretty straightforward with a simple 3 node ensemble configuration.</p>
<h3 id="3-create-the-job">3) Create the job:</h3>
<p>Basically the job will download the official clickhouse image and will create a pod with 2 containers:</p>
<ul>
<li>
<p>clickhouse-copier: This container will run the clickhouse-copier utility.</p>
</li>
<li>
<p>sidecar-logging: This container will be used to read the logs of the clickhouse-copier container for different runs (this part can be improved):</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">batch/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Job</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clickhouse-copier-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clickhouse-copier</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># only for kubernetes 1.23</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># ttlSecondsAfterFinished: 86400</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clickhouse-copier</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clickhouse/clickhouse-server:21.8</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">clickhouse-copier</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- --<span style="color:#000">task-upload-force=1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- --<span style="color:#000">config-file=$(CH_COPIER_CONFIG)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- --<span style="color:#000">task-path=$(CH_COPIER_TASKPATH)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- --<span style="color:#000">task-file=$(CH_COPIER_TASKFILE)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- --<span style="color:#000">base-dir=$(CH_COPIER_BASEDIR)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CH_COPIER_CONFIG</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/var/lib/clickhouse/tmp/zookeeper.xml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CH_COPIER_TASKPATH</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/clickhouse/copier/tasks/task01&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CH_COPIER_TASKFILE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/var/lib/clickhouse/tmp/task01.xml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CH_COPIER_BASEDIR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/var/lib/clickhouse/tmp&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">2048Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">copier-config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/clickhouse/tmp/zookeeper.xml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">subPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">zookeeper.xml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">copier-config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/clickhouse/tmp/task01.xml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">subPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">task01.xml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">copier-logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/clickhouse/tmp</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sidecar-logger</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">busybox:1.35</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;/bin/sh&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;-c&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;tail&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;-n&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;1000&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;-f&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/tmp/copier-logs/clickhouse-copier*/*.log&#39;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">512Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">copier-logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/tmp/copier-logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">copier-config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">configMap</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">copier-config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">items</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">zookeeper.xml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">zookeeper.xml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">task01.xml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">task01.xml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">copier-logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">persistentVolumeClaim</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">claimName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">copier-logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">restartPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Never</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">backoffLimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Deploy and watch progress checking the logs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n clickhouse-copier logs &lt;podname&gt; sidecar-logging
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-775c97dd3622aad5380ef8cd9f7472ad">4 - Distributed table to Cluster</h1>
    <div class="lead">Distributed table to cluster</div>
	<p>In order to shift INSERTS to a standby cluster (for example increase zone availability or disaster recovery) some ClickHouse features can be used.</p>
<p>Basically we need to create a distributed table, a MV, rewrite the <code>remote_servers.xml</code> config file and tune some parameters.</p>
<p>Distributed engine information and parameters:
<a href="https://clickhouse.com/docs/en/engines/table-engines/special/distributed/" target="_blank">https://clickhouse.com/docs/en/engines/table-engines/special/distributed/</a></p>
<h2 id="steps">Steps</h2>
<h3 id="create-a-distributed-table-in-the-source-cluster">Create a Distributed table in the source cluster</h3>
<p>For example, we should have a <code>ReplicatedMergeTree</code> table in which all inserts are falling. This table is the first step in our pipeline:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">inserts_source</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;source&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">column1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">column2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DateTime</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">.....</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/tables/{shard}/inserts_source&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toYYYYMM</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">column2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">column1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">column2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This table lives in the source cluster and all INSERTS go there. In order to shift all INSERTS in the source cluster to destination cluster we can create a <code>Distributed</code> table that points to another <code>ReplicatedMergeTree</code> in the destination cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">inserts_source_dist</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;source&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">column1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">column2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DateTime</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">.....</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Distributed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;destination&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inserts_destination</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="create-a-materialized-view-to-shift-inserts-to-destination-cluster">Create a Materialized View to shift INSERTS to destination cluster:</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MATERIALIZED</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">shift_inserts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;source&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">inserts_source_dist</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">inserts_source</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="create-a-replicatedmergetree-table-in-the-destination-cluster">Create a ReplicatedMergeTree table in the destination cluster:</h3>
<p>This is the table in the destination cluster that is pointed by the distributed table in the source cluster</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">inserts_destination</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;destination&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">column1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">column2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DateTime</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">.....</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/tables/{shard}/inserts_destination&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toYYYYMM</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">column2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">column1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">column2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="rewrite-remote_serversxml">Rewrite remote_servers.xml:</h3>
<p>All the hostnames/FQDN from each replica/node must be accessible from both clusters. Also the remote_servers.xml from the source cluster should read like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;clickhouse&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;remote_servers&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;source&gt;</span>   
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;shard&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>host03<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9000<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>host04<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9000<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;/shard&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/source&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;destination&gt;</span>   
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;shard&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>host01<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9000<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>host02<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9000<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;/shard&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/destination&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">&lt;!-- If using a LB to shift inserts you need to use user and password and create MT destination table in an all-replicated cluster config --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;destination_with_lb&gt;</span>   
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;shard&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>load_balancer.xxxx.com<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9440<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;secure&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/secure&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;username&gt;</span>user<span style="color:#204a87;font-weight:bold">&lt;/username&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;password&gt;</span>pass<span style="color:#204a87;font-weight:bold">&lt;/password&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;/shard&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/destination_with_lb&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">&lt;/remote_servers&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><h3 id="configuration-settings">Configuration settings</h3>
<p>Depending on your use case you can set the the distributed INSERTs to sync or async mode. This example is for async mode:
Put this config settings on the default profile. Check for more info about the possible modes:</p>
<p><a href="https://clickhouse.com/docs/en/operations/settings/settings#insert_distributed_sync" target="_blank">https://clickhouse.com/docs/en/operations/settings/settings#insert_distributed_sync</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;clickhouse&gt;</span>
</span></span><span style="display:flex;"><span>    ....
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;profiles&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;default&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">&lt;!-- StorageDistributed DirectoryMonitors try to batch individual inserts into bigger ones to increase performance --&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;distributed_directory_monitor_batch_inserts&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/distributed_directory_monitor_batch_inserts&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">&lt;!-- StorageDistributed DirectoryMonitors try to split batch into smaller in case of failures --&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;distributed_directory_monitor_split_batch_on_failure&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/distributed_directory_monitor_split_batch_on_failure&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/default&gt;</span>
</span></span><span style="display:flex;"><span>    .....
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/profiles&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/clickhouse&gt;</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6b8cf3862e661a5ba53de12323896812">5 - Fetch Alter Table</h1>
    <div class="lead">Fetch Alter Table</div>
	<h1 id="fetch-parts-from-zookeeper">FETCH Parts from Zookeeper</h1>
<p>This is a detailed explanation on how to move data by fetching partitions or parts between replicas</p>
<h3 id="get-partitions-by-database-and-table">Get partitions by database and table:</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">hostName</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">partition_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">part_id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parts</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;db1&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;db2&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbn&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This query will return all the partitions and parts stored in this node for the databases and their tables.</p>
<h3 id="fetch-the-partitions">Fetch the partitions:</h3>
<p>Prior starting with the fetching process it is recommended to check the <code>system.detached_parts</code> table of the destination node. There is a chance that detached folders already contain some old parts, and you will have to remove them all before starting moving data. Otherwise you will attach those old parts together with the fetched parts. Also you could run into issues if there are detached folders with the same names as the ones you are fetching (not very probable, put possible). Simply delete the detached parts and continue with the process.</p>
<p>To fetch a partition:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">tablename</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FETCH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">partition_id</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{shard}/{table}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The <code>FROM</code> path is from the zookeeper node and you have to specify the shard from you&rsquo;re <a href="https://clickhouse.com/docs/en/sql-reference/statements/alter/partition#alter_fetch-partition" target="_blank">fetching the partition</a>. Next executing the DDL query:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">tablename</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">partition_id</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>will attach the partitions to a table. Again and because the process is manual, it is recommended to check that the fetched partitions are attached correctly and that there are no detached parts left. Check both <code>system.parts</code> and <code>system.detached_parts</code> tables.</p>
<h3 id="detach-tables-and-delete-replicas">Detach tables and delete replicas:</h3>
<p>If needed, after moving the data and checking that everything is sound, you can detach the tables and delete the replicas.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Required for DROP REPLICA
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">DETACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- This will remove everything from /table_path_in_z/replicas/replica_name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- but not the data. You could reattach the table again and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- restore the replica if needed. Get the zookeeper_path and replica_name from system.replicas
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replica_name&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ZKPATH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/table_path_in_zk/&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="query-to-generate-all-the-ddl">Query to generate all the DDL:</h3>
<p>With this query you can generate the DDL script that will do the fetch and attach operations for each table and partition.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#39;alter table &#39;</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#4e9a06">&#39; FETCH PARTITION &#39;&#39;&#39;</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#000">partition_id</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#4e9a06">&#39;&#39;&#39; FROM &#39;&#39;&#39;</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#000">zookeeper_path</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#4e9a06">&#39;&#39;&#39;; &#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#4e9a06">&#39;alter table &#39;</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#4e9a06">&#39; ATTACH PARTITION &#39;&#39;&#39;</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#000">partition_id</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#4e9a06">&#39;&#39;&#39;;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replicas</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;db1&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;db2&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbn&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You could add an ORDER BY to manually make the list in the order you need, or use ORDER BY rand() to randomize it. You will then need to split the commands between the shards.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-384352a945ec192141ea6fb13e0f518f">6 - Remote table function</h1>
    <div class="lead">Remote table function</div>
	<h2 id="remote-table-function">remote(&hellip;) table function</h2>
<p>Suitable for moving up to hundreds of gigabytes of data.</p>
<p>With bigger tables recommended approach is to slice the original data by some <code>WHERE</code> condition, ideally - apply the condition on partitioning key, to avoid writing data to many partitions at once.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">(...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">date</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2021-04-13&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">(...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">date</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2021-04-12&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">(...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">date</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2021-04-11&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">....</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">(...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">date</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2021-04-11&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">....</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="q-can-it-create-a-bigger-load-on-the-source-system">Q. Can it create a bigger load on the source system?</h3>
<p>Yes, it may use disk read &amp; network write bandwidth. But typically write speed is worse than the read speed, so most probably the receiver side will be a bottleneck, and the sender side will not be overloaded.</p>
<p>While of course it should be checked, every case is different.</p>
<h3 id="q-can-i-tune-insert-speed-to-make-it-faster">Q. Can I tune INSERT speed to make it faster?</h3>
<p>Yes, by the cost of extra memory usage (on the receiver side).</p>
<p>Clickhouse tries to form blocks of data in memory and while one of limit: <code>min_insert_block_size_rows</code> or <code>min_insert_block_size_bytes</code> being hit, clickhouse dump this block on disk. If clickhouse tries to execute insert in parallel (<code>max_insert_threads &gt; 1</code>), it would form multiple blocks at one time.<br>
So maximum memory usage can be calculated like this: <code>max_insert_threads * first(min_insert_block_size_rows OR min_insert_block_size_bytes)</code></p>
<p>Default values:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">────────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">min_insert_block_size_rows</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1048545</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">min_insert_block_size_bytes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">268427520</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_insert_threads</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Values</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">means</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">that</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">is</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">run</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">parallel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────────────────┴───────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Tune those settings depending on your table average row size and amount of memory which are safe to occupy by <code>INSERT SELECT</code> query.</p>
<h3 id="q-ive-got-the-error-all-connection-tries-failed">Q. I&rsquo;ve got the error &ldquo;All connection tries failed&rdquo;</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;server.from.remote.dc:9440&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;default.table&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;password&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Received</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exception</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">server</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">):</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">519</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Received</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">All</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attempts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">structure</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">failed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">279</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">displayText</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">NetException</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">All</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">connection</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tries</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">failed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">209</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">displayText</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">NetException</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">connect</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">out</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">192</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">official</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">209</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">displayText</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">NetException</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">connect</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">out</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">192</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">official</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">209</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">displayText</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">NetException</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">connect</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">out</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">192</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">official</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ol>
<li>Using remote(&hellip;) table function with secure TCP port (default values is 9440). There is remoteSecure() function for that.</li>
<li>High (&gt;50ms) ping between servers, values for <code>connect_timeout_with_failover_ms,</code>  <code>connect_timeout_with_failover_secure_ms</code> need&rsquo;s to be adjusted accordingly.</li>
</ol>
<p>Default values:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">────────────────────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">connect_timeout_with_failover_ms</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">connect_timeout_with_failover_secure_ms</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────────────────────────────┴───────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="example">Example</h3>
<pre tabindex="0"><code>#!/bin/bash

table=&#39;...&#39;
database=&#39;bvt&#39;
local=&#39;...&#39;
remote=&#39;...&#39;
CH=&#34;clickhouse-client&#34;   # you may add auth here 
settings=&#34;  max_insert_threads=20, 
            max_threads=20, 
            min_insert_block_size_bytes = 536870912, 
            min_insert_block_size_rows = 16777216, 
            max_insert_block_size = 16777216,
            optimize_on_insert=0&#34;;

# need it to create temp table with same structure (suitable for attach)
params=$($CH -h $remote -q &#34;select partition_key,sorting_key,primary_key from system.tables where table=&#39;$table&#39; and database = &#39;$database&#39; &#34; -f TSV)
IFS=$&#39;\t&#39; read -r partition_key sorting_key primary_key &lt;&lt;&lt; $params

$CH -h $local \  # get list of source partitions
-q &#34;select distinct partition from system.parts where table=&#39;$table&#39; and database = &#39;$database&#39; &#34;

while read -r partition; do
# check that the partition is already copied
  if [ `$CH -h $remote -q &#34; select count() from system.parts table=&#39;$table&#39; and database = &#39;$database&#39; and partition=&#39;$partition&#39;&#34;` -eq 0 ] ; then
      $CH -n -h $remote -q &#34;
        create temporary table temp as $database.$table engine=MergeTree -- 23.3 required for temporary table
           partition by ($partition_key) primary key ($primary_key)  order by ($sorting_key);
        -- SYSTEM STOP MERGES temp; -- maybe....
        set $settings;
        insert into temp select * from remote($local,$database.$table) where _partition=&#39;$partition&#39;
        -- order by ($sorting_key) -- maybe....
        ;
        alter table $database.$table attach partition $partition from temp
  &#34;
  fi
done
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-69e50f36eba192534d9f891226a8196a">7 - rsync</h1>
    <div class="lead">rsync</div>
	<h3 id="short-instructions">Short Instructions</h3>
<p>These instructions apply to ClickHouse using default locations for storage.</p>
<ol>
<li>
<p>Do <a href="https://clickhouse.tech/docs/en/sql-reference/statements/alter/partition/#alter_freeze-partition" target="_blank">FREEZE TABLE</a> on needed table, partition. It produces a consistent snapshot of table data.</p>
</li>
<li>
<p>Run rsync command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rsync -ravlW --bwlimit<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100000</span> /var/lib/clickhouse/data/shadow/N/database/table
</span></span><span style="display:flex;"><span>    root@remote_host:/var/lib/clickhouse/data/database/table/detached
</span></span></code></pre></div><p><code>--bwlimit</code> is transfer limit in KBytes per second.</p>
</li>
<li>
<p>Run <a href="https://clickhouse.tech/docs/en/sql-reference/statements/alter/partition/#alter_attach-partition" target="_blank">ATTACH PARTITION</a> for each partition from <code>./detached</code> directory.</p>
</li>
</ol>
<p>IMPORTANT NOTE: If you are using a mount point different from /var/lib/clickhouse/data, adjust the rsync command accordingly to point the correct location. For example, suppose you reconfigure the storage path as follows in /etc/clickhouse-server/config.d/config.xml.</p>
<pre tabindex="0"><code>&lt;clickhouse&gt;
    &lt;!-- Path to data directory, with trailing slash. --&gt;
    &lt;path&gt;/data1/clickhouse/&lt;/path&gt;
    ...
&lt;/clickhouse&gt;
</code></pre><p>You&rsquo;ll need to use <code>/data1/clickhouse</code> instead of <code>/var/lib/clickhouse</code> in the rsync paths.</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row footer-inner pb-3">
      <div class="col-12">
        <a href="https://altinity.com" target="_blank"><img src="/images/general/altinity-logo_horizontal_blue_white.svg" width="154" alt="Altinity.com"></a>
      </div>
    </div>
    <div class="row footer-inner py-3">
      <div class="col-12 col-sm-6 col-md-3">
        <ul class="nav flex-column mb-3">
          <li class="nav-item"><b>PRODUCT</b></li>
          <li class="nav-item"><a href="https://altinity.com/managed-clickhouse/" target="_blank">Altinity.Cloud</a></li>
          <li class="nav-item"><a href="https://altinity.com/clickhouse-support/" target="_blank">Support for ClickHouse</a></li>
          <li class="nav-item"><a href="https://altinity.com/clickhouse-training" target="_blank">Training for ClickHouse</a></li>
          <li class="nav-item"><a href="https://altinity.com/clickhouse-pricing/" target="_blank">Altinity.Cloud Pricing</a></li>
          <li class="nav-item"><a href="https://altinity.com/plans-and-features-clickhouse/" target="_blank">Altinity Plans and Features</a></li>
        </ul>
        <div class="d-none d-md-block mb-3"><img decoding="async" style="width: 60px;display:inline-block;margin: 0 10px 0 0;" src="/images/general/soc.webp" alt="SOC Certified" /><img decoding="async" style="width: 60px;display:inline-block;margin: 0;" src="/images/general/soc2.webp" alt="SOC2 TYPE II Certified"/></div>
      </div>
      <div class="col-12 col-sm-6 col-md-3">
        <ul class="nav flex-column mb-3">
          <li class="nav-item"><b>RESOURCES</b></li>
          <li class="nav-item"><a href="https://altinity.com/blog" target="_blank" >Blog</a></li>
          <li class="nav-item"><a href="https://docs.altinity.com/" target="_blank" >Documentation</a></li>
          <li class="nav-item"><a href="https://kb.altinity.com/" target="_blank" >Knowledge Base</a></li>
          <li class="nav-item"><a href="https://altinity.com/releases" target="_blank" >Altinity Stable Builds</a></li>
          <li class="nav-item"><a href="https://hubs.la/Q02pLTV20" target="_blank" >Kubernetes Operator</a></li>
          <li class="nav-item"><a href="https://altinity.com/ecosystem/" target="_blank" >Altinity Open Source Projects</a></li>
          <li class="nav-item"><a href="https://altinity.com/events/" target="_blank" >Events</a></li>
        </ul>
      </div>      <div class="col-12 col-sm-6 col-md-3">
      <ul class="nav flex-column mb-3">
        <li class="nav-item"><b>COMPANY</b></li>
        <li class="nav-item"><a href="https://altinity.com/about-us/" target="_blank">About Altinity</a></li>
        <li class="nav-item"><a href="https://altinity.com/about-us/press-releases" target="_blank">Press Releases</a></li>
        <li class="nav-item"><a href="https://altinity.com/partners/" target="_blank">Partners</a></li>
        <li class="nav-item"><a href="https://altinity.com/customer-stories/" target="_blank">Customer Stories</a></li>
        <li class="nav-item"><a href="https://altinity.com/careers/" target="_blank">Careers</a></li>
        <li class="nav-item"><a href="https://altinity.com/contact/" target="_blank">Contact Us</a></li>
      </ul>
    </div>
      <div class="col-12 col-sm-6 col-md-3">
        Get the latest ClickHouse news straight to your inbox every month.<br />
        <a href="https://altinity.com/newsletter/" target="_blank" class="btn btn-primary my-3" style="border-radius: 1.5rem;">Sign Up</a>
      </div>

    </div>
    </div>
    <div class="row footer-inner pb-3">
      <div class="col-12 col-sm-6 text-left text-xs-center py-2">
        <small class="text-white">&copy; 2024  Altinity Inc. Altinity®, Altinity.Cloud®, and Altinity Stable® are registered trademarks of Altinity, Inc. ClickHouse® is a registered trademark of ClickHouse, Inc.; Altinity is not affiliated with or associated with ClickHouse, Inc. All Rights Reserved</small>
        <small class="ml-1"><a href="https://altinity.com/privacy-policy/" target="_blank">Privacy Policy</a></small>
  
    
  
      </div>
      <div class="col-12 col-sm-6 text-right text-xs-center">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://altinity.com/slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="X" aria-label="X">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://twitter.com/AltinityDB">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="LinkedIn" aria-label="LinkedIn">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/company/altinity/">
      <i class="fab fa-linkedin"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Youtube" aria-label="Youtube">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/channel/UCE3Y2lDKl_ZfjaCrh62onYA">
      <i class="fab fa-youtube"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/orgs/Altinity/">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Reddit" aria-label="Reddit">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.reddit.com/r/Clickhouse/">
      <i class="fab fa-reddit"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>

    </div>
  </div>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-101676615-2"></script>
  
  <script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/4536206.js"></script>
  
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-101676615-2');
  </script>
</footer>


    </div>
    <script src="/js/main.js"></script>
<script src='/js/prism.js'></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
