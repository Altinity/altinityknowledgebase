<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-ddlworker/><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=icon href=/favicons/favicon.ico><title>DDLWorker and DDL queue problems | Altinity® Knowledge Base for ClickHouse®</title>
<meta name=description content="Finding and troubleshooting problems in the `distributed_ddl_queue`
"><meta property="og:url" content="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-ddlworker/"><meta property="og:site_name" content="Altinity® Knowledge Base for ClickHouse®"><meta property="og:title" content="DDLWorker and DDL queue problems"><meta property="og:description" content="Finding and troubleshooting problems in the `distributed_ddl_queue`"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="DDLWorker and DDL queue problems"><meta itemprop=description content="Finding and troubleshooting problems in the `distributed_ddl_queue`"><meta itemprop=dateModified content="2025-10-01T15:09:05+02:00"><meta itemprop=wordCount content="574"><meta itemprop=keywords content="clickhouse ddl,clickhouse replication queue"><meta name=twitter:card content="summary"><meta name=twitter:title content="DDLWorker and DDL queue problems"><meta name=twitter:description content="Finding and troubleshooting problems in the `distributed_ddl_queue`"><link rel=preload href=/scss/main.min.10f29ebcf80a650ac763f904f53e25ddad49c874d72279a3e2123ef3e2c93426.css as=style><link href=/scss/main.min.10f29ebcf80a650ac763f904f53e25ddad49c874d72279a3e2123ef3e2c93426.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><link rel=stylesheet href=/css/prism.css><meta name=keywords content="clickhouse ddl,clickhouse replication queue"><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/4536206.js></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","v7y63vmran")</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand-xl navbar-dark"><a class=navbar-brand href=https://altinity.com target=_blank><span class=navbar-logo><img src=/images/general/altinity-logo_horizontal_blue_white.svg width=154 alt=Altinity.com></span>
</a><button class="navbar-toggler ml-auto" type=button data-bs-toggle=collapse data-bs-target=#mobile_navbar aria-controls=mobile_navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="td-navbar-nav-scroll w-100 d-none d-xl-block" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item dropdown position-static"><a class="nav-link dropdown-toggle" href=# id=productsDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Products</a><ul class="dropdown-menu list-unstyled w-100 mega-menu" aria-labelledby=navbarDropdown><li><div class=grid-row style="grid-template-columns:35% 35% 30%"><div><h5 style=margin-bottom:15px>PRODUCTS</h5><div><div class=sub-section-header>Altinity.Cloud</div><div class=sub_links style="display:grid;grid-template-columns:50% 50%;margin-bottom:15px"><div><a href=https://altinity.com/managed-clickhouse/ id=nav_products_cloud class=med-link>Managed cloud</a><div class=desc>Deploy on Altinity’s cloud</div></div><div><a href=https://altinity.com/managed-clickhouse/bring-your-own-cloud/ id=nav_products_byoc class=med-link>Bring your own cloud</a><div class=desc>Any region, any environment</div></div></div><div class=sub_links style="display:grid;grid-template-columns:50% 50%;margin-bottom:20px"><div><a href=https://altinity.com/altinity-cloud-vs-clickhouse-cloud-faq id=nav_products_comparison><i class="fas fa-table text-primary"></i> Vendor comparison </a></div><div><a href=https://altinity.com/clickhouse-pricing/ id=nav_products_pricing><i class="fas fa-dollar-sign text-primary"></i> Pricing </a></div></div></div><div><div class=sub-section-header>Support for ClickHouse<sup>®</sup></div><a href=https://altinity.com/clickhouse-support/ id=nav_products_support class=med-link style=margin-bottom:10px>24/7 Support</a><br><a href=https://altinity.com/poc-evaluation-support/ id=nav_products_poc_evaluative_support class=med-link style=margin-bottom:10px>POC and Evaluative Support</a><br><a href=https://altinity.com/clickhouse-training/ id=nav_products_training class=med-link style=margin-bottom:10px>Training for ClickHouse<sup>®</sup></a><br></div></div><div style="border-left:1px solid rgba(255,255,255,.3);padding-left:30px"><h5 style=margin-bottom:15px>OPEN SOURCE SOFTWARE</h5><div style="margin-left:-10px;padding:5px 5px 5px 10px;margin-bottom:5px;background:rgba(24,157,208,.5);border-radius:8px"><a href=https://altinity.com/project-antalya-real-time-data-lakes/ id=nav_products_antalya_builds>NEW Project Antalya Builds </a><br><div class=desc style=margin-bottom:0>Scale ClickHouse queries infinitely with 10X cheaper data lakes</div></div><a href=https://altinity.com/altinity-stable/ id=nav_products_stable_builds>Altinity Stable Builds for ClickHouse<sup>®</sup> </a><br><div class=desc style=margin-bottom:15px>LTS-certified binaries with 3 years’ support</div><a href=https://altinity.com/kubernetes-operator/ id=nav_products_kubernetes>Altinity Kubernetes Operator for ClickHouse<sup>®</sup> </a><br><div class=desc style=margin-bottom:15px>Manage ClickHouse clusters on Kubernetes effortlessly</div><a href=https://altinity.com/altinity-backup-for-clickhouse/ id=nav_products_backup>Altinity Backup for ClickHouse<sup>®</sup> </a><br><div class=desc style=margin-bottom:15px>Simple backup and restore tool for ClickHouse</div><a href=https://altinity.com/ecosystem/>See more > </a></div><div style="border-left:1px solid rgba(255,255,255,.3);padding-left:30px"><h5 style=margin-bottom:15px>CLICKHOUSE<sup>®</sup> SOLUTIONS</h5><a href=https://altinity.com/observability-and-logging/ id=nav_observability>Observability & Logging </a><br><div class=desc style=margin-bottom:15px>Manage high-volume observability data efficiently</div><a href=https://altinity.com/security-information-and-event-management/ id=nav_siem>Security Information and Event Management (SIEM) </a><br><div class=desc style=margin-bottom:15px>Efficiently process and analyze high-volume security events</div><a href=https://altinity.com/trading-systems/ id=nav_trading_systems>Trading Analytics </a><br><div class=desc style=margin-bottom:15px>Make faster market decisions</div></div></div><div class=grid-row style="grid-template-columns:33% 60%;border-top:1px solid rgba(255,255,255,.3)"><div><a href=https://altinity.com/customer-stories/ id=nav_products_customer_stories>Customer stories </a><br><div class=desc>See why our customers love us</div></div><div><a href=https://altinity.com/plans-and-features-clickhouse/ id=nav_products_plans_features>Altinity Plans and Features </a><br><div class=desc>Managed service or support? Compare plans and features</div></div></div></li></ul></li><li class="nav-item dropdown position-static"><a class="nav-link dropdown-toggle" href=# id=resourceDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Resources</a><ul class="dropdown-menu list-unstyled w-100 mega-menu" aria-labelledby=navbarDropdown><li><div class=grid-row><div><p class=col-header>Developer Center</p><div><a href=https://docs.altinity.com/ target=_blank id=nav_resources_docs>Documentation </a><div class=desc>Product guides and tutorials</div><br></div><div><a href=https://kb.altinity.com/ target=_blank id=nav_resources_knowledgebase>Knowledge Base </a><div class=desc>Answers to common questions and issues</div><br></div><div><a href="https://altinity.com/blog/?cat=webinarspage" target=_blank id=nav_resources_webinars>Past Webinars </a><div class=desc>Watch anytime, on demand.</div><br></div><div><a href=https://altinity.com/developer-resources/ id=nav_resources_dev_resources>More Technical Content </a><div class=desc>How-to guides and videos</div><br></div></div><div><p class=col-header>Learning</p><div><a href=https://altinity.com/clickhouse-database/ id=nav_resources_what_is_ch>What is ClickHouse? </a><div class=desc>New to ClickHouse? Start here</div><br></div><div><a href=https://altinity.com/kubernetes-operator/ id=nav_resources_k8s_operator>Kubernetes Operator </a><div class=desc>Learn how it works and who uses it</div><br></div><div><a href=https://altinity.com/unevenly-distributed/ id=nav_unevenlydistributed>Unevenly Distributed </a><div class=desc>A Thought Leadership Series on Real-Time Data Lakes</div><br></div><div><a href=https://altinity.com/altinity-stable/ id=nav_resources_stable>Altinity Stable Builds </a><div class=desc>Learn why you should be using them in your prod environments</div><br></div></div><div><p class=col-header>Community</p><div><a href=https://altinity.com/ecosystem/ id=nav_resources_open_source>Open Source at Altinity </a><div class=desc>Explore our open source projects and contributions</div><br></div><div><a href=https://altinity.com/events/ id=nav_resources_events>Events </a><div class=desc>Upcoming conferences, events, and webinars</div><br></div><div><a href=https://altinity.com/slack/ target=_blank id=nav_resources_slack>Slack Community </a><div class=desc>Get help for any ClickHouse issue from experts</div><br></div><div><a href=https://altinity.com/office-hours-for-clickhouse/ id=nav_resources_office_hours>Monthly Office Hours </a><div class=desc>Meet our engineers live and ask your questions</div><br></div></div></div></li></ul></li><li class=nav-item><a class=nav-link href=https://altinity.com/blog target=_blank>Blog</a></li><li class="nav-item dropdown position-static"><a class="nav-link dropdown-toggle" href=# id=companyDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Company</a><ul class="dropdown-menu list-unstyled w-100 mega-menu" aria-labelledby=navbarDropdown><li><div class=grid-row><div><div><a href=https://altinity.com/about-us/ id=nav_company_about>About the company  </a></div><div><a href=https://altinity.com/about-us/#leadership id=nav_company_leadership>Leadership </a></div></div><div><div><a href=https://altinity.com/about-us/press-releases/ id=nav_company_press>Press Releases </a></div><div><a href=https://altinity.com/partners/ id=nav_company_partners>Partners </a></div></div><div><div><a href=https://altinity.com/customer-stories/ id=nav_company_customer_stories>Customer Stories </a></div><div><a href=https://altinity.com/careers/ id=nav_company_careers>Careers </a></div></div><div class=mega-bg-blue><div><h5>Get in touch with ClickHouse experts.</h5><a href=https://altinity.com/contact class="btn btn-primary button">Contact Us </a></div></div></div></li></ul></li><li class=nav-item><a class=nav-link href=https://altinity.com/contact target=_blank>Contact</a></li><li class="header-social-wrap ml-md-auto"><a class=navbar-button href=https://altinity.com/free-clickhouse-consultation/ target=_blank>Tech Support</a>
<a class=navbar-button href=https://acm.altinity.cloud/signup target=_blank style=margin-right:15px>ClickHouse® in Cloud</a>
<a href=https://www.youtube.com/@Altinity aria-label=Slack target=_blank rel="noopener noreferrer" class="social-button header-social-item"><span class=social-icon-custom-svg style=max-width:34px><svg fill="currentcolor" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28"><title>YouTube</title><path d="M11.109 17.625l7.562-3.906-7.562-3.953v7.859zM14 4.156c5.891.0 9.797.281 9.797.281.547.063 1.75.063 2.812 1.188.0.0.859.844 1.109 2.781.297 2.266.281 4.531.281 4.531v2.125s.016 2.266-.281 4.531c-.25 1.922-1.109 2.781-1.109 2.781-1.062 1.109-2.266 1.109-2.812 1.172.0.0-3.906.297-9.797.297v0c-7.281-.063-9.516-.281-9.516-.281-.625-.109-2.031-.078-3.094-1.188.0.0-.859-.859-1.109-2.781-.297-2.266-.281-4.531-.281-4.531v-2.125s-.016-2.266.281-4.531C.531 6.469 1.39 5.625 1.39 5.625 2.452 4.5 3.656 4.5 4.202 4.437c0 0 3.906-.281 9.797-.281v0z"/></svg>
</span></a><a href=https://altinity.com/slack/ aria-label=Slack target=_blank rel="noopener noreferrer" class="social-button header-social-item"><span class=social-icon-custom-svg style=max-width:34px><svg viewBox="0 0 36 36" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path fill="currentcolor" d="M7.563 22.747a3.782 3.782.0 11-3.78-3.78h3.78v3.78zm1.906.0a3.782 3.782.0 017.563.0v9.469a3.782 3.782.0 11-7.563.0V22.747zM13.251 7.563a3.782 3.782.0 113.782-3.78v3.78H13.251zm0 1.906a3.781 3.781.0 110 7.563H3.783a3.782 3.782.0 110-7.563h9.468zm15.183 3.782a3.783 3.783.0 113.783 3.782H28.434V13.251zm-1.9.0a3.782 3.782.0 01-7.565.0V3.783a3.782 3.782.0 117.564.0zM22.747 28.434a3.783 3.783.0 11-3.78 3.783V28.434h3.78zm0-1.9a3.782 3.782.0 010-7.565h9.469a3.782 3.782.0 110 7.564z" data-name="Icon simple-slack" id="Icon_simple-slack"/></svg>
</span></a><a href=https://github.com/altinity/ aria-label=GitHub target=_blank rel="noopener noreferrer" class="social-button header-social-item"><svg fill="currentcolor" xmlns="http://www.w3.org/2000/svg" width="24" height="28" viewBox="0 0 24 28"><title>Github</title><path d="M12 2c6.625.0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-.609.109-.828-.266-.828-.578.0-.391.016-1.687.016-3.297.0-1.125-.375-1.844-.812-2.219 2.672-.297 5.484-1.313 5.484-5.922.0-1.313-.469-2.375-1.234-3.219.125-.313.531-1.531-.125-3.187-1-.313-3.297 1.234-3.297 1.234-.953-.266-1.984-.406-3-.406s-2.047.141-3 .406c0 0-2.297-1.547-3.297-1.234-.656 1.656-.25 2.875-.125 3.187-.766.844-1.234 1.906-1.234 3.219.0 4.594 2.797 5.625 5.469 5.922-.344.313-.656.844-.766 1.609-.688.313-2.438.844-3.484-1-.656-1.141-1.844-1.234-1.844-1.234-1.172-.016-.078.734-.078.734.781.359 1.328 1.75 1.328 1.75.703 2.141 4.047 1.422 4.047 1.422.0 1 .016 1.937.016 2.234.0.313-.219.688-.828.578-4.766-1.594-8.203-6.094-8.203-11.391.0-6.625 5.375-12 12-12zM4.547 19.234c.031-.063-.016-.141-.109-.187-.094-.031-.172-.016-.203.031-.031.063.016.141.109.187.078.047.172.031.203-.031zM5.031 19.766c.063-.047.047-.156-.031-.25-.078-.078-.187-.109-.25-.047-.063.047-.047.156.031.25.078.078.187.109.25.047zM5.5 20.469c.078-.063.078-.187.0-.297-.063-.109-.187-.156-.266-.094-.078.047-.078.172.0.281s.203.156.266.109zM6.156 21.125c.063-.063.031-.203-.063-.297-.109-.109-.25-.125-.313-.047-.078.063-.047.203.063.297.109.109.25.125.313.047zM7.047 21.516c.031-.094-.063-.203-.203-.25-.125-.031-.266.016-.297.109s.063.203.203.234c.125.047.266.0.297-.094zM8.031 21.594c0-.109-.125-.187-.266-.172-.141.0-.25.078-.25.172.0.109.109.187.266.172.141.0.25-.078.25-.172zM8.937 21.438c-.016-.094-.141-.156-.281-.141-.141.031-.234.125-.219.234.016.094.141.156.281.125s.234-.125.219-.219z"/></svg></a></li></ul></div></nav><div id=mobile_navbar class="collapse js-navbar-scroll navbar-collapse d-xl-none"><ul class="menu has-collapse-sub-nav"><li class="nav-item nav-item-has-children active"><div class=drawer-nav-drop-wrap><a>Products</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a href=https://altinity.com/managed-clickhouse/>Altinity.Cloud</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/clickhouse-pricing/>Pricing for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/altinity-cloud-vs-clickhouse-cloud-faq/>Altinity.Cloud vs ClickHouse Cloud FAQ</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-support/>Support for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-training/>Training for ClickHouse</a></li></ul></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a href=https://altinity.com/ecosystem/>Open Source Software</a></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/project-antalya-real-time-data-lakes/>Project Antalya</a></li><li class=nav-item><a href=https://altinity.com/altinity-stable/>Altinity Stable Builds</a></li><li class=nav-item><a href=https://altinity.com/kubernetes-operator/>Kubernetes Operator</a></li><li class=nav-item><a href=https://altinity.com/altinity-backup-for-clickhouse/>Altinity Backup for ClickHouse</a></li></ul></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a>ClickHouse™ Solutions</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/observability-and-logging/>Observability & Logging with ClickHouse®</a></li><li class=nav-item><a href=https://altinity.com/security-information-and-event-management/>Security Information and Event Management (SIEM) with ClickHouse®</a></li><li class=nav-item><a href=https://altinity.com/trading-systems/>Trading analytics with ClickHouse®</a></li></ul></li></ul></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a>Resources</a></div><ul class=sub-menu><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a href=#>Developer Center</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a target=_blank href=https://docs.altinity.com/>Documentation</a></li><li class=nav-item><a target=_blank href=https://kb.altinity.com/>Knowledge Base</a></li><li class=nav-item><a href="https://altinity.com/blog/?cat=webinarspage">Past Webinars</a></li><li class=nav-item><a href=https://altinity.com/developer-resources/>Guides and eBooks</a></li></ul></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a href=#>Learning</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/clickhouse-database/>What is ClickHouse?</a></li><li class=nav-item><a href=https://altinity.com/what-is-kubernetes/>What is Kubernetes?</a></li><li class=nav-item><a href=https://altinity.com/unevenly-distributed/>Unevenly Distributed</a></li><li class=nav-item><a href=https://altinity.com/altinity-stable/>Altinity Stable Builds</a></li></ul></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a href=#>Community</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/events>Events</a></li><li class="nav-slack nav-item"><a target=_blank href=http://www.localhost:10008/slack>Slack Community</a></li><li class=nav-item><a href=https://altinity.com/office-hours-for-clickhouse/>Office Hours for ClickHouse®</a></li></ul></li></ul></li><li class=nav-item><a href=https://altinity.com/blog>Blog</a></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a>Company</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/about-us/>About Altinity</a></li><li class=nav-item><a href=https://altinity.com/about-us/#leadership>Leadership</a></li><li class=nav-item><a href=https://altinity.com/about-us/press-releases/>Press Releases</a></li><li class=nav-item><a href=https://altinity.com/partners/>Partners</a></li><li class=nav-item><a href=https://altinity.com/customer-stories/>Customer Stories</a></li><li class=nav-item><a href=https://altinity.com/careers/>Careers</a></li></ul></li><li class=nav-item><a href=https://altinity.com/contact>Contact</a></li><li class="header-nav-button nav-item"><a href=https://altinity.com/free-clickhouse-consultation>Tech Support</a></li><li class="header-nav-button nav-item"><a href="https://acm.altinity.cloud/signup?__hstc=173202428.421802398cbec3b5d6457748d00d825f.1702395478849.1769622795179.1769630357065.395&__hssc=173202428.9.1769630357065&__hsfp=e5063c5ad56e06035f046e27f2ea897a">ClickHouse® in Cloud</a></li></ul></div></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/altinity-kb-setup-and-maintenance/altinity-kb-ddlworker/>Return to the regular view of this page</a>.</p></div><h1 class=title>DDLWorker and DDL queue problems</h1><div class=lead>Finding and troubleshooting problems in the <code>distributed_ddl_queue</code></div><ul><li>1: <a href=#pg-7f5f8971a74cdc0af853041c9dd18c8f>There are N unfinished hosts (0 of them are currently active).</a></li></ul><div class=content><p>DDLWorker is a subprocess (thread) of <code>clickhouse-server</code> that executes <code>ON CLUSTER</code> tasks at the node.</p><p>When you execute a DDL query with <code>ON CLUSTER mycluster</code> section, the query executor at the current node reads the cluster <code>mycluster</code> definition (remote_servers / system.clusters) and places tasks into Zookeeper znode <code>task_queue/ddl/...</code> for members of the cluster <code>mycluster</code>.</p><p>DDLWorker at all ClickHouse® nodes constantly check this <code>task_queue</code> for their tasks, executes them locally, and reports about the results back into <code>task_queue</code>.</p><p>The common issue is the different hostnames/IPAddresses in the cluster definition and locally.</p><p>So if the initiator node puts tasks for a host named Host1. But the Host1 thinks about own name as localhost or <strong>xdgt634678d</strong> (internal docker hostname) and never sees tasks for the Host1 because is looking tasks for <strong>xdgt634678d.</strong> The same with internal VS external IP addresses.</p><h2 id=ddlworker-thread-crashed>DDLWorker thread crashed</h2><p>That causes ClickHouse to stop executing <code>ON CLUSTER</code> tasks.</p><p>Check that DDLWorker is alive:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ps -eL<span style=color:#000;font-weight:700>|</span>grep DDL
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>18829</span> <span style=color:#0000cf;font-weight:700>18876</span> ?        00:00:00 DDLWorkerClnr
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>18829</span> <span style=color:#0000cf;font-weight:700>18879</span> ?        00:00:00 DDLWorker
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ps -ef<span style=color:#000;font-weight:700>|</span>grep 18829<span style=color:#000;font-weight:700>|</span>grep -v grep
</span></span><span style=display:flex><span>clickho+ <span style=color:#0000cf;font-weight:700>18829</span> <span style=color:#0000cf;font-weight:700>18828</span>  <span style=color:#0000cf;font-weight:700>1</span> Feb09 ?        00:55:00 /usr/bin/clickhouse-server --con...
</span></span></code></pre></div><p>As you can see there are two threads: <code>DDLWorker</code> and <code>DDLWorkerClnr</code>.</p><p>The second thread – <code>DDLWorkerCleaner</code> cleans old tasks from <code>task_queue</code>. You can configure how many recent tasks to store:</p><pre tabindex=0><code class=language-markup data-lang=markup>config.xml
&lt;yandex&gt;
    &lt;distributed_ddl&gt;
        &lt;path&gt;/clickhouse/task_queue/ddl&lt;/path&gt;
        &lt;pool_size&gt;1&lt;/pool_size&gt;
        &lt;max_tasks_in_queue&gt;1000&lt;/max_tasks_in_queue&gt;
        &lt;task_max_lifetime&gt;604800&lt;/task_max_lifetime&gt;
        &lt;cleanup_delay_period&gt;60&lt;/cleanup_delay_period&gt;
    &lt;/distributed_ddl&gt;
&lt;/yandex&gt;
</code></pre><p>Default values:</p><p><strong>cleanup_delay_period</strong> = 60 seconds – Sets how often to start cleanup to remove outdated data.</p><p><strong>task_max_lifetime</strong> = 7 * 24 * 60 * 60 (in seconds = week) – Delete task if its age is greater than that.</p><p><strong>max_tasks_in_queue</strong> = 1000 – How many tasks could be in the queue.</p><p><strong>pool_size</strong> = 1 - How many ON CLUSTER queries can be run simultaneously.</p><h2 id=too-intensive-stream-of-on-cluster-command>Too intensive stream of ON CLUSTER command</h2><p>Generally, it&rsquo;s a bad design, but you can increase pool_size setting</p><h2 id=stuck-ddl-tasks-in-the-distributed_ddl_queue>Stuck DDL tasks in the distributed_ddl_queue</h2><p>Sometimes <a href=/altinity-kb-setup-and-maintenance/altinity-kb-ddlworker/>DDL tasks</a>
(the ones that use ON CLUSTER) can get stuck in the <code>distributed_ddl_queue</code> because the replicas can overload if multiple DDLs (thousands of CREATE/DROP/ALTER) are executed at the same time. This is very normal in heavy ETL jobs.This can be detected by checking the <code>distributed_ddl_queue</code> table and see if there are tasks that are not moving or are stuck for a long time.</p><p>If these DDLs are completed in some replicas but failed in others, the simplest way to solve this is to execute the failed command in the missed replicas without ON CLUSTER. If most of the DDLs failed, then check the number of unfinished records in <code>distributed_ddl_queue</code> on the other nodes, because most probably it will be as high as thousands.</p><p>First, backup the <code>distributed_ddl_queue</code> into a table so you will have a snapshot of the table with the states of the tasks. You can do this with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>system_distributed_ddl_queue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>distributed_ddl_queue</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>After this, we need to check from the backup table which tasks are not finished and execute them manually in the missed replicas, and review the pipeline which do <code>ON CLUSTER</code> command and does not abuse them. There is a new <code>CREATE TEMPORARY TABLE</code> command that can be used to avoid the <code>ON CLUSTER</code> command in some cases, where you need an intermediate table to do some operations and after that you can <code>INSERT INTO</code> the final table or do <code>ALTER TABLE final ATTACH PARTITION FROM TABLE temp</code> and this temp table will be dropped automatically after the session is closed.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7f5f8971a74cdc0af853041c9dd18c8f>1 - There are N unfinished hosts (0 of them are currently active).</h1><div class=lead>There are N unfinished hosts (0 of them are currently active).</div><p>Sometimes your Distributed DDL queries are being stuck, and not executing on all or subset of nodes, there are a lot of possible reasons for that kind of behavior, so it would take some time and effort to investigate.</p><h2 id=possible-reasons>Possible reasons</h2><h3 id=clickhouse-node-cant-recognize-itself>ClickHouse® node can&rsquo;t recognize itself</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clusters</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- check is_local column, it should have 1 for itself
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>getent hosts clickhouse.local.net <span style=color:#8f5902;font-style:italic># or other name which should be local</span>
</span></span><span style=display:flex><span>hostname --fqdn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat /etc/hosts
</span></span><span style=display:flex><span>cat /etc/hostname
</span></span></code></pre></div><h3 id=debian--ubuntu>Debian / Ubuntu</h3><p>There is an issue in Debian based images, when hostname being mapped to 127.0.1.1 address which doesn&rsquo;t literally match network interface and ClickHouse fails to detect this address as local.</p><p><a href=https://github.com/ClickHouse/ClickHouse/issues/23504 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/23504</a></p><h4 id=previous-task-is-being-executed-and-taking-some-time>Previous task is being executed and taking some time</h4><p>It&rsquo;s usually some heavy operations like merges, mutations, alter columns, so it make sense to check those tables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PROCESSLIST</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>merges</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutations</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>In that case, you can just wait completion of previous task.</p><h3 id=previous-task-is-stuck-because-of-some-error>Previous task is stuck because of some error</h3><p>In that case, the first step is to understand which exact task is stuck and why. There are some queries which can help with that.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- list of all distributed ddl queries, path can be different in your installation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- information about specific task.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;query-0000001000&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- 22.3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow_unrestricted_reads_from_keeper</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;true&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- 22.6
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow_unrestricted_reads_from_keeper</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;true&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- How many nodes executed this task
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numChildren</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>finished_nodes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;finished&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>─────┬─</span><span style=color:#000>finished_nodes</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>finished</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────┴────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The nodes that are running the task
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/active/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- What was the result for the finished nodes 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/finished/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Latest successfull executed tasks from query_log.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_log</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%ddl_entry%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;cluster&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%MaxDDLEntryID%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>───────────────────┬─</span><span style=color:#000>metric</span><span style=color:#a40000>────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>───────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chi</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ab</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>svc</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MaxDDLEntryID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>1468</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Max</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>entry</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDLWorker</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>───────────────────┬─</span><span style=color:#000>metric</span><span style=color:#a40000>────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>───────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chi</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ab</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>svc</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MaxDDLEntryID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>1468</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Max</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>entry</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDLWorker</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>───────────────────┬─</span><span style=color:#000>metric</span><span style=color:#a40000>────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>───────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chi</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ab</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>svc</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MaxDDLEntryID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>1468</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Max</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>entry</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDLWorker</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Information about task execution from logs.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>grep</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87;font-weight:700>C</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;ddl_entry&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=issues-that-can-prevent-task-execution>Issues that can prevent task execution</h3><h4 id=obsolete-replicas>Obsolete Replicas</h4><p>Obsolete replicas left in zookeeper.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>zookeeper_path</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica_path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicas</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>total_replicas</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active_replicas</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/cluster/tables/01/database/table/replicas&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;replica_name&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STOP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICATION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>QUEUES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>START</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICATION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>QUEUES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><a href=https://clickhouse.tech/docs/en/sql-reference/statements/system/%5c#query_language-system-drop-replica target=_blank rel=nofollow>https://clickhouse.tech/docs/en/sql-reference/statements/system/#query_language-system-drop-replica</a></p><h4 id=tasks-manually-removed-from-ddl-queue>Tasks manually removed from DDL queue</h4><p>Task were removed from DDL queue, but left in Replicated*MergeTree table queue.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grep -C <span style=color:#0000cf;font-weight:700>40</span> <span style=color:#4e9a06>&#34;ddl_entry&#34;</span> /var/log/clickhouse-server/clickhouse-server*.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:28.956888 <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#0000cf;font-weight:700>599</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{}</span> &lt;Debug&gt; DDLWorker: Processing task query-0000211211 <span style=color:#ce5c00;font-weight:700>(</span>ALTER TABLE db.table_local ON CLUSTER <span style=color:#4e9a06>`</span>all-replicated<span style=color:#4e9a06>`</span> DELETE WHERE <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> 1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:29.053555 <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#0000cf;font-weight:700>599</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{}</span> &lt;Error&gt; DDLWorker: ZooKeeper error: Code: 999, e.displayText<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>=</span> Coordination::Exception: No node, Stack trace <span style=color:#ce5c00;font-weight:700>(</span>when copying this message, always include the lines below<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-0. Coordination::Exception::Exception<span style=color:#ce5c00;font-weight:700>(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const<span style=color:#000;font-weight:700>&amp;</span>, Coordination::Error, int<span style=color:#ce5c00;font-weight:700>)</span> @ 0xfb2f6b3 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-1. Coordination::Exception::Exception<span style=color:#ce5c00;font-weight:700>(</span>Coordination::Error<span style=color:#ce5c00;font-weight:700>)</span> @ 0xfb2fb56 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:2. DB::DDLWorker::createStatusDirs<span style=color:#ce5c00;font-weight:700>(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const<span style=color:#000;font-weight:700>&amp;</span>, std::__1::shared_ptr&lt;zkutil::ZooKeeper&gt; const<span style=color:#000;font-weight:700>&amp;</span><span style=color:#ce5c00;font-weight:700>)</span> @ 0xeb3127a in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:3. DB::DDLWorker::processTask<span style=color:#ce5c00;font-weight:700>(</span>DB::DDLTask<span style=color:#000;font-weight:700>&amp;</span><span style=color:#ce5c00;font-weight:700>)</span> @ 0xeb36c96 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:4. DB::DDLWorker::enqueueTask<span style=color:#ce5c00;font-weight:700>(</span>std::__1::unique_ptr&lt;DB::DDLTask, std::__1::default_delete&lt;DB::DDLTask&gt; &gt;<span style=color:#ce5c00;font-weight:700>)</span> @ 0xeb35f22 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-5. ? @ 0xeb47aed in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-6. ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::worker<span style=color:#ce5c00;font-weight:700>(</span>std::__1::__list_iterator&lt;ThreadFromGlobalPool, void*&gt;<span style=color:#ce5c00;font-weight:700>)</span> @ 0x8633bcd in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-7. ThreadFromGlobalPool::ThreadFromGlobalPool&lt;void ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::scheduleImpl&lt;void&gt;<span style=color:#ce5c00;font-weight:700>(</span>std::__1::function&lt;void <span style=color:#ce5c00;font-weight:700>()</span>&gt;, int, std::__1::optional&lt;unsigned long&gt;<span style=color:#ce5c00;font-weight:700>)</span>::<span style=color:#4e9a06>&#39;lambda1&#39;</span><span style=color:#ce5c00;font-weight:700>()</span>&gt;<span style=color:#ce5c00;font-weight:700>(</span>void<span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>, void ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::scheduleImpl&lt;void&gt;<span style=color:#ce5c00;font-weight:700>(</span>std::__1::function&lt;void <span style=color:#ce5c00;font-weight:700>()</span>&gt;, int, std::__1::optional&lt;unsigned long&gt;<span style=color:#ce5c00;font-weight:700>)</span>::<span style=color:#4e9a06>&#39;lambda1&#39;</span><span style=color:#ce5c00;font-weight:700>()&amp;&amp;</span>...<span style=color:#ce5c00;font-weight:700>)</span>::<span style=color:#4e9a06>&#39;lambda&#39;</span><span style=color:#ce5c00;font-weight:700>()</span>::operator<span style=color:#ce5c00;font-weight:700>()()</span> @ 0x863612f in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-8. ThreadPoolImpl&lt;std::__1::thread&gt;::worker<span style=color:#ce5c00;font-weight:700>(</span>std::__1::__list_iterator&lt;std::__1::thread, void*&gt;<span style=color:#ce5c00;font-weight:700>)</span> @ 0x8630ffd in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-9. ? @ 0x8634bb3 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-10. start_thread @ 0x9609 in /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-11. __clone @ 0x122293 in /usr/lib/x86_64-linux-gnu/libc-2.31.so
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log- <span style=color:#ce5c00;font-weight:700>(</span>version 21.1.8.30 <span style=color:#ce5c00;font-weight:700>(</span>official build<span style=color:#ce5c00;font-weight:700>))</span>
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:29.053951 <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#0000cf;font-weight:700>599</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{}</span> &lt;Debug&gt; DDLWorker: Processing task query-0000211211 <span style=color:#ce5c00;font-weight:700>(</span>ALTER TABLE db.table_local ON CLUSTER <span style=color:#4e9a06>`</span>all-replicated<span style=color:#4e9a06>`</span> DELETE WHERE <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> 1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>Context of this problem is:</p><ul><li>Constant pressure of cheap ON CLUSTER DELETE queries.</li><li>One replica was down for a long amount of time (multiple days).</li><li>Because of pressure on the DDL queue, it purged old records due to the <code>task_max_lifetime</code> setting.</li><li>When a lagging replica comes up, it&rsquo;s fail&rsquo;s execute old queries from DDL queue, because at this point they were purged from it.</li></ul><p>Solution:</p><ul><li>Reload/Restore this replica from scratch.</li></ul><h4 id=ddl-path-was-changed-in-zookeeper-without-restarting-clickhouse>DDL path was changed in Zookeeper without restarting ClickHouse</h4><p>Changing the DDL queue path in Zookeeper without restarting ClickHouse will make ClickHouse confused. If you need to do this ensure that you restart ClickHouse before submitting additional distributed DDL commands. Here&rsquo;s an example.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Path before change:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/clickhouse101/task_queue&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>path</span><span style=color:#a40000>─────────────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse101</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>task_queue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────┴───────┴──────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Path after change
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/clickhouse101/task_queue&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>path</span><span style=color:#a40000>─────────────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ddl2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse101</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>task_queue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────┴───────┴──────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The reason is that ClickHouse will not &ldquo;see&rdquo; this change and will continue to look for tasks in the old path. Altering paths in Zookeeper should be avoided if at all possible. If necessary it must be done <em>very carefully</em>.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class="row footer-inner pb-3"><div class=col-12><a href=https://altinity.com target=_blank><img src=/images/general/altinity-logo_horizontal_blue_white.svg width=154 alt=Altinity.com></a></div></div><div class="row footer-inner py-3"><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>PRODUCT</b></li><li class=nav-item><a href=https://altinity.com/managed-clickhouse/ target=_blank>Altinity.Cloud</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-support/ target=_blank>Support for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-training target=_blank>Training for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-pricing/ target=_blank>Altinity.Cloud Pricing</a></li><li class=nav-item><a href=https://altinity.com/plans-and-features-clickhouse/ target=_blank>Altinity Plans and Features</a></li></ul><div class="d-none d-md-block mb-3"><img decoding=async style="width:60px;display:inline-block;margin:0 10px 0 0" src=/images/general/soc.webp alt="SOC Certified"><img decoding=async style=width:60px;display:inline-block;margin:0 src=/images/general/soc2.webp alt="SOC2 TYPE II Certified"></div></div><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>RESOURCES</b></li><li class=nav-item><a href=https://altinity.com/blog target=_blank>Blog</a></li><li class=nav-item><a href=https://docs.altinity.com/ target=_blank>Documentation</a></li><li class=nav-item><a href=https://kb.altinity.com/ target=_blank>Knowledge Base</a></li><li class=nav-item><a href=https://altinity.com/releases target=_blank>Altinity Stable Builds</a></li><li class=nav-item><a href=https://hubs.la/Q02pLTV20 target=_blank>Kubernetes Operator</a></li><li class=nav-item><a href=https://altinity.com/ecosystem/ target=_blank>Altinity Open Source Projects</a></li><li class=nav-item><a href=https://altinity.com/events/ target=_blank>Events</a></li></ul></div><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>COMPANY</b></li><li class=nav-item><a href=https://altinity.com/about-us/ target=_blank>About Altinity</a></li><li class=nav-item><a href=https://altinity.com/about-us/press-releases target=_blank>Press Releases</a></li><li class=nav-item><a href=https://altinity.com/partners/ target=_blank>Partners</a></li><li class=nav-item><a href=https://altinity.com/customer-stories/ target=_blank>Customer Stories</a></li><li class=nav-item><a href=https://altinity.com/careers/ target=_blank>Careers</a></li><li class=nav-item><a href=https://altinity.com/contact/ target=_blank>Contact Us</a></li></ul></div><div class="col-12 col-sm-6 col-md-3">Get the latest ClickHouse news straight to your inbox every month.<br><a href=https://altinity.com/newsletter/ target=_blank class="btn btn-primary my-3" style=border-radius:1.5rem>Sign Up</a></div></div></div><div class="row footer-inner pb-3"><div class="col-12 col-sm-6 text-left text-xs-center py-2"><small class=text-white>&copy; 2026 Altinity Inc. Altinity®, Altinity.Cloud®, and Altinity Stable® are registered trademarks of Altinity, Inc. ClickHouse® is a registered trademark of ClickHouse, Inc.; Altinity is not affiliated with or associated with ClickHouse, Inc. Kafka, Kubernetes, MySQL, and PostgreSQL are trademarks and property of their respective owners. All Rights Reserved</small>
<small class=ml-1><a href=https://altinity.com/privacy-policy/ target=_blank>Privacy Policy</a></small></div><div class="col-12 col-sm-6 text-end text-xs-center"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://altinity.com/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=X aria-label=X><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/AltinityDB><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/company/altinity/><i class="fab fa-linkedin"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.youtube.com/channel/UCE3Y2lDKl_ZfjaCrh62onYA><i class="fab fa-youtube"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/Altinity/altinityknowledgebase><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Reddit aria-label=Reddit><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.reddit.com/r/Clickhouse/><i class="fab fa-reddit"></i></a></li></ul></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-101676615-2"></script><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/4536206.js></script><script type=text/javascript>!function(){var e,t="06536e793668baa",n=function(){Reo.init({clientID:"06536e793668baa"})};(e=document.createElement("script")).src="https://static.reo.dev/"+t+"/reo.js",e.defer=!0,e.onload=n,document.head.appendChild(e)}()</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-101676615-2")</script><script>$(document).ready(function(){$(".mobile-drop-toggle").on("click",function(){$(this).parent().parent().toggleClass("active")})})</script></footer><script type=text/javascript>_linkedin_partner_id="1601132",window._linkedin_data_partner_ids=window._linkedin_data_partner_ids||[],window._linkedin_data_partner_ids.push(_linkedin_partner_id)</script><script type=text/javascript>(function(e){e||(window.lintrk=function(e,t){window.lintrk.q.push([e,t])},window.lintrk.q=[]);var n=document.getElementsByTagName("script")[0],t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://snap.licdn.com/li.lms-analytics/insight.min.js",n.parentNode.insertBefore(t,n)})(window.lintrk)</script><noscript><img height=1 width=1 style=display:none alt src="https://px.ads.linkedin.com/collect/?pid=1601132&fmt=gif"></noscript></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/tabpane-persist.js></script></body></html>