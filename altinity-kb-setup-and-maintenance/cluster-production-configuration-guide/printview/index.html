<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.96.0" /><link rel="canonical" type="text/html" href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="icon" href="/favicons/favicon.ico" >
<title>Production Cluster Configuration Guide | Altinity Knowledge Base</title>
<meta name="description" content="Altinity Knowledge Base"><meta property="og:title" content="Production Cluster Configuration Guide" />
<meta property="og:description" content="Production Cluster Configuration Guide
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/" /><meta property="og:site_name" content="Altinity Knowledge Base" />

<meta itemprop="name" content="Production Cluster Configuration Guide">
<meta itemprop="description" content="Production Cluster Configuration Guide
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Production Cluster Configuration Guide"/>
<meta name="twitter:description" content="Production Cluster Configuration Guide
"/>




<link rel="preload" href="/scss/main.min.ec0d259783afc2c6841272db4924ae5f6ab47953b32356793cb392fb1f3c3e5d.css" as="style">
<link href="/scss/main.min.ec0d259783afc2c6841272db4924ae5f6ab47953b32356793cb392fb1f3c3e5d.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css"/>

<meta name="keywords" content="">




  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 97.68 112.95"><defs><linearGradient id="linear-gradient" x1="49.43" y1="564.05" x2="21.19" y2="486.25" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#009cd0"/><stop offset=".16" stop-color="#02a0d4"/><stop offset=".33" stop-color="#08acdf"/><stop offset=".49" stop-color="#12c0f1"/><stop offset=".66" stop-color="#10bced"/><stop offset=".83" stop-color="#0ab0e2"/><stop offset="1" stop-color="#009cd0"/></linearGradient><linearGradient id="linear-gradient-2" x1="0" y1="472.36" x2="48.75" y2="472.36" xlink:href="#linear-gradient"/><linearGradient id="linear-gradient-3" x1=".05" y1="493.62" x2="24.5" y2="493.62" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#fff"/><stop offset=".03" stop-color="#f2f7fb"/><stop offset=".19" stop-color="#b3d2e7"/><stop offset=".34" stop-color="#7cb2d5"/><stop offset=".5" stop-color="#5097c7"/><stop offset=".64" stop-color="#2d83bc"/><stop offset=".78" stop-color="#1474b4"/><stop offset=".9" stop-color="#056bb0"/><stop offset="1" stop-color="#0068ae"/></linearGradient><linearGradient id="linear-gradient-4" x1="73.23" y1="507.9" x2="97.68" y2="507.9" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0068ae"/><stop offset=".12" stop-color="#046aaf"/><stop offset=".25" stop-color="#1072b3"/><stop offset=".38" stop-color="#257eba"/><stop offset=".5" stop-color="#418fc3"/><stop offset=".63" stop-color="#66a4ce"/><stop offset=".76" stop-color="#93bfdd"/><stop offset=".88" stop-color="#c7deed"/><stop offset="1" stop-color="#fff"/></linearGradient><linearGradient id="linear-gradient-5" x1="50.7" y1="522" x2="74.92" y2="522" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0068ae"/><stop offset=".09" stop-color="#096eb1"/><stop offset=".23" stop-color="#237db9"/><stop offset=".41" stop-color="#4d95c6"/><stop offset=".62" stop-color="#86b8d9"/><stop offset=".86" stop-color="#cfe3f0"/><stop offset="1" stop-color="#fff"/></linearGradient></defs><title>logo_1</title><g style="isolation:isolate"><g id="Layer_2" data-name="Layer 2"><g id="Layer_1-2" data-name="Layer 1"><path d="M97.68 56.29h0L73.23 42.21V98.58L97.68 112.7V56.29z" style="fill:#009cd0"/><path d="M73.23 42.21 97.68 56.32V28.09z" style="fill:#009cd0"/><path d="M73.25 42.2 97.68 28.09 73.25 14h0L48.79 28.08 73.23 42.19v0h0z" style="fill:#009cd0"/><path d="M73.34 14.12 48.89.0V0L24.45 14.18h0L.1 28.23h0L0 28.29l.09.05V56.46L24.45 42.4h0 .1.0L49.4 27.94 73.34 14.12z" style="fill:url(#linear-gradient)"/><path d="M48.75 84.87 24.45 70.52v-28L.21 56.53l-.12-.07v.14L0 56.66l.09.05V84.65L0 84.7l.09.06V113L24.3 99v0L48.75 84.87z" style="fill:url(#linear-gradient-2)"/><path d="M.05 56.44 24.5 70.55V42.32z" style="fill:#009cd0"/><path d="M.05 56.49 24.5 70.6V42.37z" style="mix-blend-mode:multiply;fill:url(#linear-gradient-3)"/><path d="M73.23 42.21 97.68 56.32V28.09z" style="mix-blend-mode:multiply;fill:url(#linear-gradient-4)"/><path d="M97.68 28.09 73.23 14v0L48.79 28.13 73.25 42.25v0z" style="mix-blend-mode:multiply;fill:url(#linear-gradient-5)"/></g></g></g></svg></span><span class="text-uppercase font-weight-bold">Altinity Knowledge Base</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.9f88c2900b11dcd5146da70a8cc84431.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Production Cluster Configuration Guide</h1>
<div class="lead">Production Cluster Configuration Guide</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-202b7e3651622a4779b38f52cef739a7">Backups</a></li>


    
  
    
    
	
<li>2: <a href="#pg-8064c7d414e643fb87b3e0939260d98f">Cluster Configuration FAQ</a></li>


    
  
    
    
	
<li>3: <a href="#pg-839cbf636b5f8a35c6823f41977447f7">Cluster Configuration Process</a></li>


    
  
    
    
	
<li>4: <a href="#pg-3754a72a1a168184ed696d361b761145">Hardware Requirements</a></li>


    
  
    
    
	
<li>5: <a href="#pg-4accea5680fbc04bc964ceaa6a6f4898">Monitoring Considerations</a></li>


    
  
    
    
	
<li>6: <a href="#pg-414e2937f5573cccbd17d35a64e42c62">Network Configuration</a></li>


    
  
    
    
	
<li>7: <a href="#pg-79036a2f9b1596d53a92b5746e36394e">Version Upgrades</a></li>


    
  

    </ul>


<div class="content">
      <p>Moving from a single ClickHouse server to a clustered format provides several benefits:</p>
<ul>
<li>Replication guarantees data integrity.</li>
<li>Provides redundancy.</li>
<li>Failover by being able to restart half of the nodes without encountering downtime.</li>
</ul>
<p>Moving from an unsharded ClickHouse environment to a sharded cluster requires redesign of schema and queries. Starting with a sharded cluster from the beginning makes it easier in the future to scale the cluster up.</p>
<p>Setting up a ClickHouse cluster for a production environment requires the following stages:</p>
<ul>
<li>Hardware Requirements</li>
<li>Network Configuration</li>
<li>Create Host Names</li>
<li>Monitoring Considerations</li>
<li>Configuration Steps</li>
<li>Setting Up Backups</li>
<li>Staging Plans</li>
<li>Upgrading The Cluster</li>
</ul>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-202b7e3651622a4779b38f52cef739a7">1 - Backups</h1>
    <div class="lead">Backups</div>
	<p>ClickHouse is currently at the design stage of creating some universal backup solution. Some custom backup strategies are:</p>
<ol>
<li>Each shard is backed up separately.</li>
<li>FREEZE the table/partition. For more information, see <a href="https://clickhouse.tech/docs/en/sql-reference/statements/alter/partition/#alter_freeze-partition" target="_blank">Alter Freeze Partition</a>.
<ol>
<li>This creates hard links in shadow subdirectory.</li>
</ol>
</li>
<li>rsync that directory to a backup location, then remove that subfolder from shadow.
<ol>
<li>Cloud users are recommended to use <a href="https://rclone.org/" target="_blank">Rclone</a>.</li>
</ol>
</li>
<li>Always add the full contents of the metadata subfolder that contains the current DB schema and clickhouse configs to your backup.</li>
<li>For a second replica, it’s enough to copy metadata and configuration.</li>
<li>Data in clickhouse is already compressed with lz4, backup can be compressed bit better, but avoid using cpu-heavy compression algorythms like gzip, use something like zstd instead.</li>
</ol>
<p>The tool automating that process  <a href="https://github.com/AlexAkulov/clickhouse-backup" target="_blank">clickhouse-backup</a>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8064c7d414e643fb87b3e0939260d98f">2 - Cluster Configuration FAQ</h1>
    <div class="lead">Cluster Configuration FAQ</div>
	<h2 id="clickhouse-does-not-start-some-other-unexpected-behavior-happening">ClickHouse does not start, some other unexpected behavior happening</h2>
<p>Check clickhouse logs, they are your friends:</p>
<p>tail -n 1000 /var/log/clickhouse-server/clickhouse-server.err.log | less
tail -n 10000 /var/log/clickhouse-server/clickhouse-server.log | less</p>
<h2 id="how-do-i-restrict-memory-usage">How Do I Restrict Memory Usage?</h2>
<p>See <a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-memory-configuration-settings/">our knowledge base article</a>  and <a href="https://clickhouse.tech/docs/en/operations/settings/query-complexity/#settings_max_memory_usage" target="_blank">official documentation</a> for more information.</p>
<h2 id="clickhouse-died-during-big-query-execution">ClickHouse died during big query execution</h2>
<p>Misconfigured clickhouse can try to allocate more RAM than is available on the system.</p>
<p>In that case an OS component called oomkiller can kill the clickhouse process.</p>
<p>That event leaves traces inside system logs (can be checked by running dmesg command).</p>
<h2 id="how-do-i-make-huge-group-by-queries-use-less-ram">How Do I make huge ‘Group By’ queries use less RAM?</h2>
<p>Enable on disk GROUP BY (it is slower, so is disabled by default)</p>
<p>Set <a href="https://clickhouse.tech/docs/en/operations/settings/query-complexity/#settings-max_bytes_before_external_group_by" target="_blank">max_bytes_before_external_group_by</a> to a value about 70-80% of your max_memory_usage value.</p>
<h2 id="data-returned-in-chunks-by-clickhouse-client">Data returned in chunks by clickhouse-client</h2>
<p>See <a href="http://kb.altinity.com/altinity-kb-interfaces/altinity-kb-clickhouse-client/">altinity-kb-clickhouse-client</a></p>
<h2 id="i-cant-connect-from-other-hosts--what-do-i-do">I Can’t Connect From Other Hosts.  What do I do?</h2>
<p>Check the <listen> settings in config.xml. Verify that the connection can connect on both IPV4 and IPV6.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-839cbf636b5f8a35c6823f41977447f7">3 - Cluster Configuration Process</h1>
    <div class="lead">Cluster Configuration Process</div>
	<p>So you set up 3 nodes with zookeeper (zookeeper1, zookeeper2, zookeeper3 - <a href="https://docs.altinity.com/operationsguide/clickhouse-zookeeper/" target="_blank">How to install zookeer?</a>),  and  and 4 nodes with ClickHouse (clickhouse-sh1r1,clickhouse-sh1r2,clickhouse-sh2r1,clickhouse-sh2r2 - <a href="https://docs.altinity.com/altinitystablerelease/stablequickstartguide/" target="_blank">how to install ClickHouse?</a>). Now we need to make them work together.</p>
<p>Use ansible/puppet/salt or other systems to control the servers’ configurations.</p>
<ol>
<li>Configure ClickHouse access to Zookeeper by adding the file zookeeper.xml in /etc/clickhouse-server/config.d/ folder. This file must be placed on all ClickHouse servers.</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;yandex&gt;
    &lt;zookeeper&gt;
        &lt;node&gt;
            &lt;host&gt;zookeeper1&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
        &lt;node&gt;
            &lt;host&gt;zookeeper2&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
        &lt;node&gt;
            &lt;host&gt;zookeeper3&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
    &lt;/zookeeper&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>On each server put the file macros.xml in <code>/etc/clickhouse-server/config.d/</code> folder.</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;yandex&gt;
    &lt;!--
        That macros are defined per server,
        and they can be used in DDL, to make the DB schema cluster/server neutral
    --&gt;
    &lt;macros&gt;
        &lt;cluster&gt;prod_cluster&lt;/cluster&gt;
        &lt;shard&gt;01&lt;/shard&gt;
        &lt;replica&gt;clickhouse-sh1r1&lt;/replica&gt; &lt;!-- better - use the same as hostname  --&gt;
    &lt;/macros&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>On each server place the file cluster.xml in /etc/clickhouse-server/config.d/ folder. Before 20.10  ClickHouse will use default user to connect to other nodes (configurable, other users can be used), since 20.10 we recommend to use passwordless intercluster authentication based on common secret (HMAC auth)</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;yandex&gt;
    &lt;remote_servers&gt;
        &lt;prod_cluster&gt; &lt;!-- you need to give a some name for a cluster --&gt;

            &lt;!--
                &lt;secret&gt;some_random_string, same on all cluster nodes, keep it safe&lt;/secret&gt;
            --&gt;
            &lt;shard&gt;
                &lt;internal_replication&gt;true&lt;/internal_replication&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh1r1&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh1r2&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
            &lt;/shard&gt;
            &lt;shard&gt;
                &lt;internal_replication&gt;true&lt;/internal_replication&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh2r1&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh2r2&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
            &lt;/shard&gt;
        &lt;/prod_cluster&gt;
    &lt;/remote_servers&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>A good practice is to create 2 additional cluster configurations similar to prod_cluster above with the following distinction: but listing all nodes of single shard (all are replicas) and as nodes of 6 different shards (no replicas)
<ol>
<li>all-replicated: All nodes are listed as replicas in a single shard.</li>
<li>all-sharded: All nodes are listed as separate shards with no replicas.</li>
</ol>
</li>
</ol>
<p>Once this is complete, other queries that span nodes can be performed. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_table_local</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt8</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/tables/{database}/{table}/{shard}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>That will create a table on all servers in the cluster. You can insert data into this table and it will be replicated automatically to the other shards.To store the data or read the data from all shards at the same time, create a Distributed table that links to the replicatedMergeTree table.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">Distributed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;default&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;
</span></span></span></code></pre></div><h4 id="hardening-clickhouse-security"><strong>Hardening ClickHouse Security</strong></h4>
<p><strong>See</strong> <a href="https://docs.altinity.com/operationsguide/security/clickhouse-hardening-guide/" target="_blank">https://docs.altinity.com/operationsguide/security/clickhouse-hardening-guide/</a></p>
<h3 id="additional-settings">Additional Settings</h3>
<p>See <a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-settings-to-adjust/">altinity-kb-settings-to-adjust</a></p>
<h4 id="users">Users</h4>
<p>Disable or add password for the default users default and readonly if your server is accessible from non-trusted networks.</p>
<p>If you add password to the default user, you will need to adjust cluster configuration, since the other servers need to know the default user’s should know the default user’s to connect to each other.</p>
<p>If you’re inside a trusted network, you can leave default user set to nothing to allow the ClickHouse nodes to communicate with each other.</p>
<h4 id="engines--clickhouse-building-blocks">Engines &amp; ClickHouse building blocks</h4>
<p>For general explanations of roles of different engines - check the post <a href="https://github.com/yandex/ClickHouse/issues/2161" target="_blank">Distributed vs Shard vs Replicated ahhh, help me!!!</a>.</p>
<h4 id="zookeeper-paths">Zookeeper Paths</h4>
<p>Use conventions  for zookeeper paths.  For example, use:</p>
<p>ReplicatedMergeTree(&rsquo;/clickhouse/{cluster}/tables/{shard}/table_name&rsquo;, &lsquo;{replica}&rsquo;)</p>
<p>for:</p>
<p>SELECT * FROM system.zookeeper WHERE path=&rsquo;/ &hellip;';</p>
<h4 id="configuration-best-practices">Configuration Best Practices</h4>
<table>
  <thead>
    <tr>
      <th style="text-align:left">
        <p>Attribution</p>
        <p>Modified by a post [on GitHub by Mikhail Filimonov](https://github.com/ClickHouse/ClickHouse/issues/3607#issuecomment-440235298).</p>
      </th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<p>The following are recommended Best Practices when it comes to setting up a ClickHouse Cluster with Zookeeper:</p>
<ol>
<li>Don’t edit/overwrite default configuration files. Sometimes a newer version of ClickHouse introduces some new settings or changes the defaults in config.xml and users.xml.
<ol>
<li>Set configurations via the extra files in conf.d directory. For example, to overwrite the interface save the file config.d/listen.xml, with the following:</li>
</ol>
</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;listen_host replace=&#34;replace&#34;&gt;::&lt;/listen_host&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>The same is true for users. For example, change the default profile by putting the file in users.d/profile_default.xml:</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;profiles&gt;
        &lt;default replace=&#34;replace&#34;&gt;
            &lt;max_memory_usage&gt;15000000000&lt;/max_memory_usage&gt;
            &lt;max_bytes_before_external_group_by&gt;12000000000&lt;/max_bytes_before_external_group_by&gt;
            &lt;max_bytes_before_external_sort&gt;12000000000&lt;/max_bytes_before_external_sort&gt;
            &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt;
            &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt;
            &lt;load_balancing&gt;random&lt;/load_balancing&gt;
            &lt;log_queries&gt;1&lt;/log_queries&gt;
            &lt;max_execution_time&gt;600&lt;/max_execution_time&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>Or you can create a user by putting a file users.d/user_xxx.xml (since 20.5 you can also use CREATE USER)</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;users&gt;
        &lt;xxx&gt;
            &lt;!-- PASSWORD=$(base64 &lt; /dev/urandom | head -c8); echo &#34;$PASSWORD&#34;; echo -n &#34;$PASSWORD&#34; | sha256sum | tr -d &#39;-&#39; --&gt;
            &lt;password_sha256_hex&gt;...&lt;/password_sha256_hex&gt;
            &lt;networks incl=&#34;networks&#34; /&gt;
            &lt;profile&gt;readonly&lt;/profile&gt;
            &lt;quota&gt;default&lt;/quota&gt;
            &lt;allow_databases incl=&#34;allowed_databases&#34; /&gt;
        &lt;/xxx&gt;
    &lt;/users&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>Some parts of configuration will contain repeated elements (like allowed ips for all the users). To avoid repeating that - use substitutions file. By default its /etc/metrika.xml, but you can change it for example to /etc/clickhouse-server/substitutions.xml with the &lt;include_from&gt; section of the main config. Put the repeated parts into substitutions file, like this:</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;networks&gt;
        &lt;ip&gt;::1&lt;/ip&gt;
        &lt;ip&gt;127.0.0.1&lt;/ip&gt;
        &lt;ip&gt;10.42.0.0/16&lt;/ip&gt;
        &lt;ip&gt;192.168.0.0/24&lt;/ip&gt;
    &lt;/networks&gt;
&lt;/yandex&gt;
</code></pre><p>These files can be common for all the servers inside the cluster or can be individualized per server. If you choose to use one substitutions file per cluster, not per node, you will also need to generate the file with macros, if macros are used.</p>
<p>This way you have full flexibility; you’re not limited to the settings described in the template. You can change any settings per server or data center just by assigning files with some settings to that server or server group. It becomes easy to navigate, edit, and assign files.</p>
<h3 id="other-configuration-recommendations">Other Configuration Recommendations</h3>
<p>Other configurations that should be evaluated:</p>
<ul>
<li><listen> in config.xml: Determines which IP addresses and ports the ClickHouse servers listen for incoming communications.</li>
<li>&lt;max_memory_..&gt; and &lt;max_bytes_before_external_&hellip;&gt; in users.xml. These are part of the profile <default>.</li>
<li>&lt;max_execution_time&gt;</li>
<li>&lt;log_queries&gt;</li>
</ul>
<p>The following extra debug logs should be considered:</p>
<ul>
<li>part_log</li>
<li>text_log</li>
</ul>
<h3 id="understanding-the-configuration">Understanding The Configuration</h3>
<p>ClickHouse configuration stores most of its information in two files:</p>
<ul>
<li>config.xml: Stores <a href="https://clickhouse.yandex/docs/en/operations/server_settings/" target="_blank">Server configuration parameters</a>. They are server wide, some are hierarchical , and most of them can’t be changed in runtime. The list of settings to apply without a restart changes from version to version. Some settings can be verified using system tables, for example:
<ul>
<li>macros (system.macros)</li>
<li>remote_servers (system.clusters)</li>
</ul>
</li>
<li>users.xml: Configure users, and user level / session level <a href="https://clickhouse.yandex/docs/en/operations/settings/settings/" target="_blank">settings</a>.
<ul>
<li>Each user can change these during their session by:
<ul>
<li>Using parameter in http query</li>
<li>By using parameter for clickhouse-client</li>
<li>Sending query like set allow_experimental_data_skipping_indices=1.</li>
</ul>
</li>
<li>Those settings and their current values are visible in system.settings. You can make some settings global by editing default profile in users.xml, which does not need restart.</li>
<li>You can forbid users to change their settings by using readonly=2 for that user, or using <a href="https://clickhouse.yandex/docs/en/operations/settings/constraints_on_settings/" target="_blank">setting constraints</a>.</li>
<li>Changes in users.xml are applied w/o restart.</li>
</ul>
</li>
</ul>
<p>For both config.xml and users.xml, it’s preferable to put adjustments in the config.d and users.d subfolders instead of editing config.xml and users.xml directly.</p>
<p>You can check if the config file was reread by checking /var/lib/clickhouse/preprocessed_configs/ folder.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3754a72a1a168184ed696d361b761145">4 - Hardware Requirements</h1>
    <div class="lead">Hardware Requirements</div>
	<h3 id="clickhouse"><strong>ClickHouse</strong></h3>
<p>ClickHouse will use all available hardware to maximize performance. So the more hardware - the better. As of this publication, the hardware requirements are:</p>
<ul>
<li>Minimum Hardware: 4-core CPU with support of SSE4.2, 16 Gb RAM, 1Tb HDD.
<ul>
<li>Recommended for development and staging environments.</li>
<li>SSE4.2 is required, and going below 4 Gb of RAM is not recommended.</li>
</ul>
</li>
<li>Recommended Hardware: &gt;=16-cores, &gt;=64Gb RAM, HDD-raid or SSD.
<ul>
<li>For processing up to hundreds of millions / billions of rows.</li>
</ul>
</li>
</ul>
<p>For clouds: disk throughput is the more important factor compared to IOPS. Be aware of burst / baseline disk speed difference.</p>
<p>See also: <a href="https://clickhouse.tech/benchmark/hardware/" target="_blank">https://clickhouse.tech/benchmark/hardware/</a></p>
<h3 id="zookeeper"><strong>Zookeeper</strong></h3>
<p>Zookeeper requires separate servers from those used for ClickHouse. Zookeeper has poor performance when installed on the same node as ClickHouse.</p>
<p>Hardware Requirements for Zookeeper:</p>
<ul>
<li>Fast disk speed (ideally NVMe, 128Gb should be enough).</li>
<li>Any modern CPU (one core, better 2)</li>
<li>4Gb of RAM</li>
</ul>
<p>For clouds - be careful with burstable network disks (like gp2 on aws): you may need up to 1000 IOPs on the disk for on a long run, so gp3 with 3000 IOPs baseline is a better choice.</p>
<p>The number of Zookeeper instances depends on the environment:</p>
<ul>
<li>Production: 3 is an optimal number of zookeeper instances.</li>
<li>Development and Staging: 1 zookeeper instance is sufficient.</li>
</ul>
<p>See also:</p>
<ul>
<li><a href="https://docs.altinity.com/operationsguide/clickhouse-zookeeper/" target="_blank">https://docs.altinity.com/operationsguide/clickhouse-zookeeper/</a></li>
<li><a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/altinity-kb-proper-setup/">altinity-kb-proper-setup</a></li>
<li><a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/zookeeper-monitoring/">zookeeper-monitoring</a></li>
</ul>
<h4 id="clickhouse-hardware-configuration">ClickHouse Hardware Configuration</h4>
<p>Configure the servers according to those recommendations the <a href="https://clickhouse.yandex/docs/en/operations/tips/" target="_blank">ClickHouse Usage Recommendations</a>.</p>
<h4 id="test-your-hardware"><strong>Test Your Hardware</strong></h4>
<p>Be sure to test the following:</p>
<ul>
<li>RAM speed.</li>
<li>Network speed.</li>
<li>Storage speed.</li>
</ul>
<p>It’s better to find any performance issues before installing ClickHouse.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4accea5680fbc04bc964ceaa6a6f4898">5 - Monitoring Considerations</h1>
    <div class="lead">Monitoring Considerations</div>
	<p><a href="../altinity-kb-monitoring">Moved</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-414e2937f5573cccbd17d35a64e42c62">6 - Network Configuration</h1>
    <div class="lead">Network Configuration</div>
	<h3 id="networking-and-server-room-planning"><strong>Networking And Server Room Planning</strong></h3>
<p>The network used for your ClickHouse cluster should be a fast network, ideally 10 Gbit or more.
ClickHouse nodes generate a lot of traffic to exchange the data between nodes (port 9009 for replication, and 9000 for distributed queries).
Zookeeper traffic in normal circumstanses is moderate, but in some special cases can also be very significant.</p>
<p>For the zookeeper low latency is more important than bandwidth.</p>
<p>Keep the replicas isolated on the hardware level. This allows for cluster failover from possible outages.</p>
<ul>
<li>For Physical Environments: Avoid placing 2 ClickHouse replicas on the same server rack. Ideally, they should be on isolated network switches and an isolated power supply.</li>
<li>For Clouds Environments: Use different availability zones between the ClickHouse replicas when possible (but be aware of the interzone traffic costs)</li>
</ul>
<p>These considerations are the same as the Zookeeper nodes.</p>
<p>For example:</p>
<table>
<thead>
<tr>
<th style="text-align:left"><strong>Rack</strong></th>
<th style="text-align:left"><strong>Server</strong></th>
<th style="text-align:left"><strong>Server</strong></th>
<th style="text-align:left"><strong>Server</strong></th>
<th style="text-align:left"><strong>Server</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>Rack 1</strong></td>
<td style="text-align:left"><strong>CH_SHARD1_R1</strong></td>
<td style="text-align:left"><strong>CH_SHARD2_R1</strong></td>
<td style="text-align:left"><strong>CH_SHARD3_R1</strong></td>
<td style="text-align:left"><strong>ZOO_1</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>Rack 2</strong></td>
<td style="text-align:left"><strong>CH_SHARD1_R2</strong></td>
<td style="text-align:left"><strong>CH_SHARD2_R2</strong></td>
<td style="text-align:left"><strong>CH_SHARD3_R2</strong></td>
<td style="text-align:left"><strong>ZOO_2</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>Rack 3</strong></td>
<td style="text-align:left"><strong>ZOO3</strong></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h4 id="network-ports-and-firewall"><strong>Network Ports And Firewall</strong></h4>
<p>ClickHouse listens the following ports:</p>
<ul>
<li>9000: clickhouse-client, native clients, other clickhouse-servers connect to here.</li>
<li>8123: HTTP clients</li>
<li>9009: Other replicas will connect here to download data.</li>
</ul>
<p>For more information, see <a href="https://www.altinity.com/blog/2019/3/15/clickhouse-networking-part-1" target="_blank">CLICKHOUSE NETWORKING, PART 1</a>.</p>
<p>Zookeeper listens the following ports:</p>
<ul>
<li>2181: Client connections.</li>
<li>2888: Inter-ensemble connections.</li>
<li>3888: Leader election.</li>
</ul>
<p>Outbound traffic from ClickHouse connects to the following ports:</p>
<ul>
<li>ZooKeeper: On port 2181.</li>
<li>Other CH nodes in the cluster: On port 9000 and 9009.</li>
<li>Dictionary sources: Depending on what was configured such as HTTP, MySQL, Mongo, etc.</li>
<li>Kafka or Hadoop: If those integrations were enabled.</li>
</ul>
<h3 id="ssl"><strong>SSL</strong></h3>
<p>For non-trusted networks enable SSL/HTTPS. If acceptable, it is better to keep interserver communications unencrypted for performance reasons.</p>
<h3 id="naming-schema"><strong>Naming Schema</strong></h3>
<p>The best time to start creating a naming schema for the servers is before they’re created and configured.</p>
<p>There are a few features based on good server naming in ClickHouse:</p>
<ul>
<li>clickhouse-client prompts: Allows a different prompt for clickhouse-client per server hostname.</li>
<li>Nearest hostname load balancing: For more information, see <a href="https://clickhouse.yandex/docs/en/operations/settings/settings/#load_balancing-nearest_hostname" target="_blank">Nearest Hostname</a>.</li>
</ul>
<p>A good option is to use the following:</p>
<p>{datacenter}-{serverroom}-{rack identifier}-{clickhouse cluster identifier}-{shard number or server number}.</p>
<p>Other examples:</p>
<ul>
<li>rxv-olap-ch-master-sh01-r01:
<ul>
<li>rxv - location (rack#15)</li>
<li>olap - product name</li>
<li>ch = clickhouse</li>
<li>master = stage</li>
<li>sh01 = shard 1</li>
<li>r01 = replica 1</li>
</ul>
</li>
<li>hetnzerde1-ch-prod-01.local:
<ul>
<li>hetnzerde1 - location (also replica id)</li>
<li>ch = clickhouse</li>
<li>prod = stage</li>
<li>01 - server number / shard number in that DC</li>
</ul>
</li>
<li>sh01.ch-front.dev.aws-east1a.example.com:
<ul>
<li>sh01 - shard 01</li>
<li>ch-front - cluster name</li>
<li>dev = stage</li>
<li>aws = cloud provider</li>
<li>east1a = region and availability zone</li>
</ul>
</li>
</ul>
<h4 id="host-name-references"><strong>Host Name References</strong></h4>
<ul>
<li><a href="https://stackoverflow.com/a/39336460/1555175" target="_blank">What are the best practices for domain names (dev, staging, production)?</a></li>
<li><a href="https://www.replex.io/blog/9-best-practices-and-examples-for-working-with-kubernetes-labels" target="_blank">9 Best Practices and Examples for Working with Kubernetes Labels</a></li>
<li><a href="https://devcentral.f5.com/s/articles/thoughts-on-hostname-nomenclature" target="_blank">Thoughts On Hostname Nomenclature</a></li>
</ul>
<h3 id="additional-hostname-tips"><strong>Additional Hostname Tips</strong></h3>
<ul>
<li>Hostnames configured on the server should not change. If you do need to change the host name, one reference to use is <a href="https://linuxize.com/post/how-to-change-hostname-on-ubuntu-18-04/" target="_blank">How to Change Hostname on Ubuntu 18.04</a>.</li>
<li>The server should be accessible to other servers in the cluster via it’s hostname. Otherwise you will need to configure interserver_hostname in your config.</li>
<li>Ensure that <code>hostname --fqdn</code> and <code>getent hosts $(hostname --fqdn)</code> return the correct name and ip.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-79036a2f9b1596d53a92b5746e36394e">7 - Version Upgrades</h1>
    <div class="lead">Version Upgrades</div>
	<p>Update itself is simple: update packages, restart clickhouse-server service afterwards.</p>
<ol>
<li>Check if the version you want to upgrade to is stable. We highly recommend the Altinity ClickHouse Stable Releases.
<ol>
<li>Review the changelog to ensure that no configuration changes are needed.</li>
</ol>
</li>
<li>Update staging and test to verify all systems are working.</li>
<li>Prepare and test downgrade procedures so the server can be returned to the previous version if necessary.</li>
<li>Start with a “canary” update. This is one replica with one shard that is upgraded to make sure that the procedure works.</li>
<li>Test and verify that everything works properly. Check for any errors in the log files.</li>
<li>If everything is working well, update the rest of the cluster.</li>
</ol>
<p>For small clusters, the <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html" target="_blank">BlueGreenDeployment technique</a> is also a good option.</p>
<hr>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://twitter.com/AltinityDB">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Youtube" aria-label="Youtube">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/channel/UCE3Y2lDKl_ZfjaCrh62onYA">
      <i class="fab fa-youtube"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="LinkedIn" aria-label="LinkedIn">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/company/altinity/">
      <i class="fab fa-linkedin"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/orgs/Altinity/">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022  Altinity Inc. All Rights Reserved</small>
        <small class="ml-1"><a href="https://altinity.com/privacy-policy/" target="_blank">Privacy Policy</a></small>
	
		
	
      </div>
    </div>
  </div>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-101676615-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-101676615-2');
</script>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>






 













<script src="/js/main.min.7fa9e3e39f56ebd66798993ef3c080218d9696c971a28ef8872d750b7416a435.js" integrity="sha256-f6nj459W69ZnmJk&#43;88CAIY2Wlslxoo74hy11C3QWpDU=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
