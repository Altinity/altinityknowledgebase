<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.96.0" /><link rel="canonical" type="text/html" href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="icon" href="/favicons/favicon.ico" >
<title>Setup &amp; maintenance | Altinity Knowledge Base</title>
<meta name="description" content="Altinity Knowledge Base"><meta property="og:title" content="Setup &amp; maintenance" />
<meta property="og:description" content="Learn how to set up, deploy, monitor, and backup ClickHouse with step-by-step guides.
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://kb.altinity.com/altinity-kb-setup-and-maintenance/" /><meta property="og:site_name" content="Altinity Knowledge Base" />

<meta itemprop="name" content="Setup &amp; maintenance">
<meta itemprop="description" content="Learn how to set up, deploy, monitor, and backup ClickHouse with step-by-step guides.
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Setup &amp; maintenance"/>
<meta name="twitter:description" content="Learn how to set up, deploy, monitor, and backup ClickHouse with step-by-step guides.
"/>




<link rel="preload" href="/scss/main.min.ec0d259783afc2c6841272db4924ae5f6ab47953b32356793cb392fb1f3c3e5d.css" as="style">
<link href="/scss/main.min.ec0d259783afc2c6841272db4924ae5f6ab47953b32356793cb392fb1f3c3e5d.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css"/>

<meta name="keywords" content="clickhouse setup, clickhouse maintenance, monitor clickhouse, data migration">




  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 97.68 112.95"><defs><linearGradient id="linear-gradient" x1="49.43" y1="564.05" x2="21.19" y2="486.25" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#009cd0"/><stop offset=".16" stop-color="#02a0d4"/><stop offset=".33" stop-color="#08acdf"/><stop offset=".49" stop-color="#12c0f1"/><stop offset=".66" stop-color="#10bced"/><stop offset=".83" stop-color="#0ab0e2"/><stop offset="1" stop-color="#009cd0"/></linearGradient><linearGradient id="linear-gradient-2" x1="0" y1="472.36" x2="48.75" y2="472.36" xlink:href="#linear-gradient"/><linearGradient id="linear-gradient-3" x1=".05" y1="493.62" x2="24.5" y2="493.62" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#fff"/><stop offset=".03" stop-color="#f2f7fb"/><stop offset=".19" stop-color="#b3d2e7"/><stop offset=".34" stop-color="#7cb2d5"/><stop offset=".5" stop-color="#5097c7"/><stop offset=".64" stop-color="#2d83bc"/><stop offset=".78" stop-color="#1474b4"/><stop offset=".9" stop-color="#056bb0"/><stop offset="1" stop-color="#0068ae"/></linearGradient><linearGradient id="linear-gradient-4" x1="73.23" y1="507.9" x2="97.68" y2="507.9" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0068ae"/><stop offset=".12" stop-color="#046aaf"/><stop offset=".25" stop-color="#1072b3"/><stop offset=".38" stop-color="#257eba"/><stop offset=".5" stop-color="#418fc3"/><stop offset=".63" stop-color="#66a4ce"/><stop offset=".76" stop-color="#93bfdd"/><stop offset=".88" stop-color="#c7deed"/><stop offset="1" stop-color="#fff"/></linearGradient><linearGradient id="linear-gradient-5" x1="50.7" y1="522" x2="74.92" y2="522" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0068ae"/><stop offset=".09" stop-color="#096eb1"/><stop offset=".23" stop-color="#237db9"/><stop offset=".41" stop-color="#4d95c6"/><stop offset=".62" stop-color="#86b8d9"/><stop offset=".86" stop-color="#cfe3f0"/><stop offset="1" stop-color="#fff"/></linearGradient></defs><title>logo_1</title><g style="isolation:isolate"><g id="Layer_2" data-name="Layer 2"><g id="Layer_1-2" data-name="Layer 1"><path d="M97.68 56.29h0L73.23 42.21V98.58L97.68 112.7V56.29z" style="fill:#009cd0"/><path d="M73.23 42.21 97.68 56.32V28.09z" style="fill:#009cd0"/><path d="M73.25 42.2 97.68 28.09 73.25 14h0L48.79 28.08 73.23 42.19v0h0z" style="fill:#009cd0"/><path d="M73.34 14.12 48.89.0V0L24.45 14.18h0L.1 28.23h0L0 28.29l.09.05V56.46L24.45 42.4h0 .1.0L49.4 27.94 73.34 14.12z" style="fill:url(#linear-gradient)"/><path d="M48.75 84.87 24.45 70.52v-28L.21 56.53l-.12-.07v.14L0 56.66l.09.05V84.65L0 84.7l.09.06V113L24.3 99v0L48.75 84.87z" style="fill:url(#linear-gradient-2)"/><path d="M.05 56.44 24.5 70.55V42.32z" style="fill:#009cd0"/><path d="M.05 56.49 24.5 70.6V42.37z" style="mix-blend-mode:multiply;fill:url(#linear-gradient-3)"/><path d="M73.23 42.21 97.68 56.32V28.09z" style="mix-blend-mode:multiply;fill:url(#linear-gradient-4)"/><path d="M97.68 28.09 73.23 14v0L48.79 28.13 73.25 42.25v0z" style="mix-blend-mode:multiply;fill:url(#linear-gradient-5)"/></g></g></g></svg></span><span class="text-uppercase font-weight-bold">Altinity Knowledge Base</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.9f88c2900b11dcd5146da70a8cc84431.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/altinity-kb-setup-and-maintenance/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Setup &amp; maintenance</h1>
<div class="lead">Learn how to set up, deploy, monitor, and backup ClickHouse with step-by-step guides.</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-17895b08eba3969685dec534c8c71f9f">S3 &amp; object storage</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-828bae3b9b7642a9616204fb40e1e9ed">AWS S3 Recipes</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-56d30b1c77fb6e372359df908c32cf1a">S3Disk</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-3fadca3aea85e2e4d4fe0090f2c8c658">AggregateFunction(uniq, UUID) doubled after ClickHouse upgrade</a></li>


    
  
    
    
	
<li>3: <a href="#pg-842ce56e1a0b0d67156403a261b18400">Can not connect to my ClickHouse server</a></li>


    
  
    
    
	
<li>4: <a href="#pg-5c047eed8f820765587e3275057bd864">cgroups and kubernetes cloud providers</a></li>


    
  
    
    
	
<li>5: <a href="#pg-65c6ddd3186c33d4134ea5a9bd44bff4">ClickHouse operator</a></li>


    
  
    
    
	
<li>6: <a href="#pg-2bf046fe139243d74994289f2cb4e13e">Custom Settings</a></li>


    
  
    
    
	
<li>7: <a href="#pg-bbd4c8156a39e2b06aedbc53ab2fcc76">Description of asynchronous_metrics</a></li>


    
  
    
    
	
<li>8: <a href="#pg-7e8b8793d3f75d7f6e63b71cccb3389e">http handler example</a></li>


    
  
    
    
	
<li>9: <a href="#pg-7c6fe7411111212f4a99eb416db8e345">Logging</a></li>


    
  
    
    
	
<li>10: <a href="#pg-d380f73c2612b91e3bc35f59f39febe2">Precreate parts using clickhouse-local</a></li>


    
  
    
    
	
<li>11: <a href="#pg-ba31da9c4b193969853f742350ad98c9">Access Control and Account Management example (RBAC)</a></li>


    
  
    
    
	
<li>12: <a href="#pg-178be1fa49d7fab0cb9c1deba7df54ca">recovery-after-complete-data-loss</a></li>


    
  
    
    
	
<li>13: <a href="#pg-a621d627feb47445d97f056ab85fb1c0">source parts size is greater than the current maximum</a></li>


    
  
    
    
	
<li>14: <a href="#pg-598152e68b617d22b315a15725d3db6c">Successful ClickHouse deployment plan</a></li>


    
  
    
    
	
<li>15: <a href="#pg-36bd996bf58568ac32e55cbc1970dce1">Timeouts during OPTIMIZE FINAL</a></li>


    
  
    
    
	
<li>16: <a href="#pg-bdd41222cb6666cd88673471ac35bde8">Useful settings to turn on/Defaults that should be reconsidered</a></li>


    
  
    
    
	
<li>17: <a href="#pg-3c882b894707a1546ab5cd4e5a238a68">ZooKeeper session has expired</a></li>


    
  
    
    
	
<li>18: <a href="#pg-c5646e9a69c9b22cfb88e043089f04f0">Altinity packaging compatibility &gt;21.x and earlier</a></li>


    
  
    
    
	
<li>19: <a href="#pg-51d2a664b930ed17f6ade89e393219cc">AWS EBS</a></li>


    
  
    
    
	
<li>20: <a href="#pg-4789c5a0fbc6e298289a42e92e966f51">ClickHouse in Docker</a></li>


    
  
    
    
	
<li>21: <a href="#pg-e2ee81b31da5dc08de7cc4b0235f75fd">ClickHouse Monitoring</a></li>


    
  
    
    
	
<li>22: <a href="#pg-199cb1e25e9c6fa0e0312726a5acd246">ClickHouse versions</a></li>


    
  
    
    
	
<li>23: <a href="#pg-482a9e1e23251a246ec9901728b5dda1">clickhouse-backup</a></li>


    
  
    
    
	
<li>24: <a href="#pg-0bbf5bd9eca8f96d4529ea56056d69c4">Converting MergeTree to Replicated</a></li>


    
  
    
    
	
<li>25: <a href="#pg-156c434f74af4cc1f5844eb80c8a1d57">Data Migration</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>25.1: <a href="#pg-49f38a883c7ec4fc908726a6854c7bbe">clickhouse-copier</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>25.1.1: <a href="#pg-e1f1d825521583c133a8d3bf2a72f6e7">clickhouse-copier 20.3 and earlier</a></li>


    
  
    
    
	
<li>25.1.2: <a href="#pg-7cba4646c1996d768d76c912356b9762">clickhouse-copier 20.4 - 21.6</a></li>


    
  

    </ul>
    
  
    
    
	
<li>25.2: <a href="#pg-384352a945ec192141ea6fb13e0f518f">Remote table function</a></li>


    
  
    
    
	
<li>25.3: <a href="#pg-69e50f36eba192534d9f891226a8196a">rsync</a></li>


    
  

    </ul>
    
  
    
    
	
<li>26: <a href="#pg-ac091a7a3a7a23bf1a7c0acd539339ce">DDLWorker</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>26.1: <a href="#pg-7f5f8971a74cdc0af853041c9dd18c8f">There are N unfinished hosts (0 of them are currently active).</a></li>


    
  

    </ul>
    
  
    
    
	
<li>27: <a href="#pg-d3de9fe2d4264f8c0b10d27225d8c18c">differential backups using clickhouse-backup</a></li>


    
  
    
    
	
<li>28: <a href="#pg-492a58dfa6abf818e811a55026049ff2">High CPU usage</a></li>


    
  
    
    
	
<li>29: <a href="#pg-55be77301bcff9aa2583091b11b429d0">Load balancers</a></li>


    
  
    
    
	
<li>30: <a href="#pg-a5bef820919d4f1ad9265cdefeca05f5">memory configuration settings</a></li>


    
  
    
    
	
<li>31: <a href="#pg-605ad2e3cca983282a1dbf9607bb550c">Moving table to another device.</a></li>


    
  
    
    
	
<li>32: <a href="#pg-60329cb30d1cf552b84e2cee02de47b7">Object consistency in a cluster</a></li>


    
  
    
    
	
<li>33: <a href="#pg-b4d9520dcb2feeb131e8e5640308a411">Production Cluster Configuration Guide</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>33.1: <a href="#pg-202b7e3651622a4779b38f52cef739a7">Backups</a></li>


    
  
    
    
	
<li>33.2: <a href="#pg-8064c7d414e643fb87b3e0939260d98f">Cluster Configuration FAQ</a></li>


    
  
    
    
	
<li>33.3: <a href="#pg-839cbf636b5f8a35c6823f41977447f7">Cluster Configuration Process</a></li>


    
  
    
    
	
<li>33.4: <a href="#pg-3754a72a1a168184ed696d361b761145">Hardware Requirements</a></li>


    
  
    
    
	
<li>33.5: <a href="#pg-4accea5680fbc04bc964ceaa6a6f4898">Monitoring Considerations</a></li>


    
  
    
    
	
<li>33.6: <a href="#pg-414e2937f5573cccbd17d35a64e42c62">Network Configuration</a></li>


    
  
    
    
	
<li>33.7: <a href="#pg-79036a2f9b1596d53a92b5746e36394e">Version Upgrades</a></li>


    
  

    </ul>
    
  
    
    
	
<li>34: <a href="#pg-13df9db0c6033eb5e2bfdfb7089294a2">Replication queue</a></li>


    
  
    
    
	
<li>35: <a href="#pg-b49d062b4f5879d725ccb9b4aedf0f07">Schema migration tools for ClickHouse</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>35.1: <a href="#pg-f4359fae9928fc2ceb30bfc0e2c0b8d2">golang-migrate</a></li>


    
  

    </ul>
    
  
    
    
	
<li>36: <a href="#pg-ef428242bace20ed80fc2a5a94cbc2e1">Server config files</a></li>


    
  
    
    
	
<li>37: <a href="#pg-3ea70b58bc10fe6596f9888998227ac9">Settings to adjust</a></li>


    
  
    
    
	
<li>38: <a href="#pg-f46a585ead49a5db2d19ee263d652ffa">Shutting down a node</a></li>


    
  
    
    
	
<li>39: <a href="#pg-ea9b4077205d7c579bd465b784e33e77">SSL connection unexpectedly closed</a></li>


    
  
    
    
	
<li>40: <a href="#pg-ec43a5205301eb00c48712282b7243ed">Suspiciously many broken parts</a></li>


    
  
    
    
	
<li>41: <a href="#pg-e64ef5a4f506fd394e7168728f58b04b">System tables eat my disk</a></li>


    
  
    
    
	
<li>42: <a href="#pg-14dc574ea90d3f73fbe3876ff659dd99">Threads</a></li>


    
  
    
    
	
<li>43: <a href="#pg-403fab8125b657a5a3d0f82db33c7544">Who ate my memory</a></li>


    
  
    
    
	
<li>44: <a href="#pg-001c962263e4fe6ade35b2640d581f26">X rows of Y total rows in filesystem are suspicious</a></li>


    
  
    
    
	
<li>45: <a href="#pg-475baf90f39df7559ac79d0838516eba">ZooKeeper</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>45.1: <a href="#pg-05425e768ddcc5be5d1203f59044e6d5">Install standalone Zookeeper for ClickHouse on Ubuntu / Debian</a></li>


    
  
    
    
	
<li>45.2: <a href="#pg-4c33701373e85b893c3b3464fa4f6683">clickhouse-keeper</a></li>


    
  
    
    
	
<li>45.3: <a href="#pg-564a3bbd39f9550e577334d912a883dc">How to check the list of watches</a></li>


    
  
    
    
	
<li>45.4: <a href="#pg-722cb96284be123698aa3e56ea92ecaf">JVM sizes and garbage collector settings</a></li>


    
  
    
    
	
<li>45.5: <a href="#pg-1ef2081889fb4a086febf3b281e44778">Proper setup</a></li>


    
  
    
    
	
<li>45.6: <a href="#pg-66b660806f12af38114754857823e52a">Recovering from complete metadata loss in ZooKeeper</a></li>


    
  
    
    
	
<li>45.7: <a href="#pg-8892167f56e913cb6f2d429fc16315c8">ZooKeeper backup</a></li>


    
  
    
    
	
<li>45.8: <a href="#pg-f9f14245cdbc89d13e77a5b1b24de46e">ZooKeeper cluster migration</a></li>


    
  
    
    
	
<li>45.9: <a href="#pg-4b2037cae63d87dd18115b5fa7174451">ZooKeeper Monitoring</a></li>


    
  
    
    
	
<li>45.10: <a href="#pg-caaac474228860d2cc9228c7ba1fb3f9">ZooKeeper schema</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-17895b08eba3969685dec534c8c71f9f">1 - S3 &amp; object storage</h1>
    <div class="lead">S3 &amp; object storage</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-828bae3b9b7642a9616204fb40e1e9ed">1.1 - AWS S3 Recipes</h1>
    <div class="lead">AWS S3 Recipes</div>
	<h2 id="using-aws-iam--identity-and-access-management-roles">Using AWS IAM — Identity and Access Management roles</h2>
<p>For EC2 instance, there is an option to configure an IAM role:</p>
<p><img src="/assets/select-ec2-iam-role.png" alt=""></p>
<p>Role shall contain a policy with permissions like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;Version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2012-10-17&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;Statement&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;Sid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;allow-put-and-get&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;Effect&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Allow&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;Action&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#4e9a06">&#34;s3:PutObject&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#4e9a06">&#34;s3:GetObject&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;Resource&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;arn:aws:s3:::BUCKET_NAME/test_s3_disk/*&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Corresponding configuration of ClickHouse:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;clickhouse&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;storage_configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;disks&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;disk_s3&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;type&gt;</span>s3<span style="color:#204a87;font-weight:bold">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;endpoint&gt;</span>http://s3.us-east-1.amazonaws.com/BUCKET_NAME/test_s3_disk/<span style="color:#204a87;font-weight:bold">&lt;/endpoint&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;use_environment_credentials&gt;</span>true<span style="color:#204a87;font-weight:bold">&lt;/use_environment_credentials&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;/disk_s3&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/disks&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;policies&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;policy_s3_only&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;volumes&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;volume_s3&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&lt;disk&gt;</span>disk_s3<span style="color:#204a87;font-weight:bold">&lt;/disk&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;/volume_s3&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;/volumes&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;/policy_s3_only&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/policies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/storage_configuration&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><p>Small check:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_s3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Int64</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENGINE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">MergeTree</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuple</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuple</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">storage_policy</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;policy_s3_only&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_s3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">numbers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100000000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_s3</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_s3</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-56d30b1c77fb6e372359df908c32cf1a">1.2 - S3Disk</h1>
    
	<h2 id="settings">Settings</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;clickhouse&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;storage_configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;disks&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;s3&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;type&gt;</span>s3<span style="color:#204a87;font-weight:bold">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;endpoint&gt;</span>http://s3.us-east-1.amazonaws.com/BUCKET_NAME/test_s3_disk/<span style="color:#204a87;font-weight:bold">&lt;/endpoint&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;access_key_id&gt;</span>ACCESS_KEY_ID<span style="color:#204a87;font-weight:bold">&lt;/access_key_id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;secret_access_key&gt;</span>SECRET_ACCESS_KEY<span style="color:#204a87;font-weight:bold">&lt;/secret_access_key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;skip_access_check&gt;</span>true<span style="color:#204a87;font-weight:bold">&lt;/skip_access_check&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;send_metadata&gt;</span>true<span style="color:#204a87;font-weight:bold">&lt;/send_metadata&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;/s3&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><ul>
<li>
<p>skip_access_check — if true, it&rsquo;s possible to use read only credentials with regular MergeTree table. But you would need to disable merges (<code>prefer_not_to_merge</code> setting) on s3 volume as well.</p>
</li>
<li>
<p>send_metadata — if true, ClickHouse will populate s3 object with initial part &amp; file path, which allow you to recover metadata from s3 and make debug easier.</p>
</li>
</ul>
<h2 id="restore-metadata-from-s3">Restore metadata from S3</h2>
<h3 id="default">Default</h3>
<p>Limitations:</p>
<ol>
<li>ClickHouse need RW access to this bucket</li>
</ol>
<p>In order to restore metadata, you would need to create restore file in <code>metadata_path/_s3_disk_name_</code> directory:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>touch /var/lib/clickhouse/disks/_s3_disk_name_/restore
</span></span></code></pre></div><p>In that case ClickHouse would restore to the same bucket and path and update only metadata files in s3 bucket.</p>
<h3 id="custom">Custom</h3>
<p>Limitations:</p>
<ol>
<li>ClickHouse needs RO access to the old bucket and RW to the new.</li>
<li>ClickHouse will copy objects in case of restoring to a different bucket or path.</li>
</ol>
<p>If you would like to change bucket or path, you need to populate restore file with settings in key=value format:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /var/lib/clickhouse/disks/_s3_disk_name_/restore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">source_bucket</span><span style="color:#ce5c00;font-weight:bold">=</span>s3disk
</span></span><span style="display:flex;"><span><span style="color:#000">source_path</span><span style="color:#ce5c00;font-weight:bold">=</span>vol1/
</span></span></code></pre></div><h2 id="links">Links</h2>
<p><a href="https://altinity.com/blog/integrating-clickhouse-with-minio" target="_blank">https://altinity.com/blog/integrating-clickhouse-with-minio</a>
<a href="https://altinity.com/blog/clickhouse-object-storage-performance-minio-vs-aws-s3" target="_blank">https://altinity.com/blog/clickhouse-object-storage-performance-minio-vs-aws-s3</a>
<a href="https://altinity.com/blog/tips-for-high-performance-clickhouse-clusters-with-s3-object-storage" target="_blank">https://altinity.com/blog/tips-for-high-performance-clickhouse-clusters-with-s3-object-storage</a></p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3fadca3aea85e2e4d4fe0090f2c8c658">2 - AggregateFunction(uniq, UUID) doubled after ClickHouse upgrade</h1>
    <div class="lead">Page description for heading and indexes.</div>
	<h2 id="what-happened">What happened</h2>
<p>After ClickHouse upgrade from version pre 21.6 to version after 21.6, count of unique UUID in AggregatingMergeTree tables nearly doubled in case of merging of data which was generated in different ClickHouse versions.</p>
<h2 id="why-happened">Why happened</h2>
<p>In <a href="https://github.com/ClickHouse/ClickHouse/pull/23631" target="_blank">pull request</a> which changed the internal representation of big integers data types (and UUID).
SipHash64 hash-function used for uniq aggregation function for UUID data type was replaced with intHash64, which leads to different result for the same UUID value across different ClickHouse versions.
Therefore, it results in doubling of counts, when uniqState created by different ClickHouse versions being merged together.</p>
<p>Related <a href="https://github.com/ClickHouse/ClickHouse/issues/33607" target="_blank">issue</a>.</p>
<h2 id="solution">Solution</h2>
<p>You need to replace any occurrence of <code>uniqState(uuid)</code> in MATERIALIZED VIEWs with <code>uniqState(sipHash64(uuid))</code> and change data type for already saved data from <code>AggregateFunction(uniq, UUID)</code> to <code>AggregateFunction(uniq, UInt64)</code>, because result data type of sipHash64 is UInt64.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- On ClickHouse version 21.3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AggregateFunction</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uniq</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UUID</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MergeTree</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reinterpretAsUUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Ok</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">404</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">million</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">38</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">59</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">million</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">74</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">modulo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┬─</span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────┴──────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- After upgrade of ClickHouse to 21.8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">modulo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┬─</span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────┴──────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">41</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">72</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">86</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MergeTree</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Ok</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">78</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reinterpretAsUUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Ok</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">266</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">million</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">38</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">93</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">million</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">modulo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┬─</span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">99834</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Count</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">unique</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nearly</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">doubled</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100219</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100128</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100457</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100272</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100279</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">99372</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">99450</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">99974</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">99632</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">99562</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100660</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100439</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100252</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100650</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">99320</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100095</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">99632</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">99540</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">100098</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────┴──────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">356</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">33</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">56</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">54</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MergeTree</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">126</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">79</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">33</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Option 1, create separate column
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">value_2</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AggregateFunction</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uniq</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt64</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">unhex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value_2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value_2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mutations</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">is_done</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Ok</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">008</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value_2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sipHash64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reinterpretAsUUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Ok</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">337</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">million</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">38</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">million</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">89</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value_2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">modulo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┬─</span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┬─</span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value_2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────┴──────────────────┴────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">768</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">58</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">96</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Option 2, modify column in-place with String as intermediate data type. 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">MODIFY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Ok</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">280</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">MODIFY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AggregateFunction</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uniq</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt64</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Ok</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">254</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sipHash64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reinterpretAsUUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Ok</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">554</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">million</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">38</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">89</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">million</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value_2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">modulo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┬─</span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┬─</span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value_2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────┴──────────────────┴────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">589</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">87</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">93</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">66</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SHOW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_3</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">uniq_state_3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AggregateFunction</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uniq</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt64</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">value_2</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AggregateFunction</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uniq</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt64</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">unhex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MergeTree</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_granularity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Option 3, CAST uniqState(UInt64) to String.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MergeTree</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Ok</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">146</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">68</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">98</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">CAST</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uniqState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sipHash64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reinterpretAsUUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">))),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;String&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Ok</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">476</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">million</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">38</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">million</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">63</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">modulo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┬─</span><span style="color:#000">uniqMerge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">49999</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────┴──────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Elapsed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">281</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">33</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">71</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thousand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">27</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SHOW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq_state_4</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">uniq_state_4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AggregateFunction</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uniq</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UUID</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MergeTree</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_granularity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-842ce56e1a0b0d67156403a261b18400">3 - Can not connect to my ClickHouse server</h1>
    <div class="lead">Can not connect to my ClickHouse server.</div>
	<h2 id="can-not-connect-to-my-clickhouse-server">Can not connect to my ClickHouse server</h2>
<p>Errors like
&ldquo;Connection reset by peer, while reading from socket&rdquo;</p>
<ol>
<li>
<p>Ensure that the clickhouse-server is running</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>systemctl status clickhouse-server
</span></span></code></pre></div><p>If server was restarted recently and don&rsquo;t accept the connections after the restart - most probably it still just starting.
During the startup sequence it need to iterate over all data folders in /var/lib/clickhouse-server
In case if you have a very high number of folders there (usually caused by a wrong partitioning, or a very high number of tables / databases)
that startup time can take a lot of time (same can happen if disk is very slow, for example NFS).</p>
<p>You can check that by looking for &lsquo;Ready for connections&rsquo; line in <code>/var/log/clickhouse-server/clickhouse-server.log</code> (<code>Information</code> log level neede)</p>
</li>
<li>
<p>Ensure you use the proper port ip / interface?</p>
<p>Ensure you&rsquo;re not trying to connect to secure port without tls / https or vice versa.</p>
<p>For clickhouse-client - pay attention on host / port / secure flags.</p>
<p>Ensure the interface you&rsquo;re connecting to is the one which clickhouse listens (by default clickhouse listens only localhost).</p>
<p>Note: If you uncomment line <code>&lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt;</code> only - clickhouse will listen only ipv4 interfaces,
while the localhost (used by clickhouse-client) may be resolved to ipv6 address. And clickhouse-client may be failing to connect.</p>
<p>How to check which interfaces / ports do clickhouse listen?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo lsof -i -P -n <span style="color:#000;font-weight:bold">|</span> grep LISTEN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> listen_host
</span></span><span style="display:flex;"><span>sudo clickhouse-extract-from-config --config<span style="color:#ce5c00;font-weight:bold">=</span>/etc/clickhouse-server/config.xml --key<span style="color:#ce5c00;font-weight:bold">=</span>listen_host
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> tcp_port
</span></span><span style="display:flex;"><span>sudo clickhouse-extract-from-config --config<span style="color:#ce5c00;font-weight:bold">=</span>/etc/clickhouse-server/config.xml --key<span style="color:#ce5c00;font-weight:bold">=</span>tcp_port
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> tcp_port_secure
</span></span><span style="display:flex;"><span>sudo clickhouse-extract-from-config --config<span style="color:#ce5c00;font-weight:bold">=</span>/etc/clickhouse-server/config.xml --key<span style="color:#ce5c00;font-weight:bold">=</span>tcp_port_secure
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> http_port
</span></span><span style="display:flex;"><span>sudo clickhouse-extract-from-config --config<span style="color:#ce5c00;font-weight:bold">=</span>/etc/clickhouse-server/config.xml --key<span style="color:#ce5c00;font-weight:bold">=</span>http_port
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> https_port
</span></span><span style="display:flex;"><span>sudo clickhouse-extract-from-config --config<span style="color:#ce5c00;font-weight:bold">=</span>/etc/clickhouse-server/config.xml --key<span style="color:#ce5c00;font-weight:bold">=</span>https_port
</span></span></code></pre></div></li>
<li>
<p>For secure connection:</p>
<ul>
<li>ensure that server uses some certificate which can be validated by the client</li>
<li>OR disable certificate checks on the client (UNSECURE)</li>
</ul>
</li>
<li>
<p>Check for errors in /var/log/clickhouse-server/clickhouse-server.err.log ?</p>
</li>
<li>
<p>Is clickhouse able to serve some trivial tcp / http requests from localhost?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl 127.0.0.1:9200
</span></span><span style="display:flex;"><span>curl 127.0.0.1:8123
</span></span></code></pre></div></li>
<li>
<p>Check number of sockets opened by clickhouse</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo lsof -i -a -p <span style="color:#204a87;font-weight:bold">$(</span>pidof clickhouse-server<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or (adjust 9000 / 8123 ports if needed)</span>
</span></span><span style="display:flex;"><span>netstat -tn 2&gt;/dev/null <span style="color:#000;font-weight:bold">|</span> tail -n +3 <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{ printf(&#34;%s\t%s\t%s\t%s\t%s\t%s\n&#34;, $1, $2, $3, $4, $5, $6) }&#39;</span> <span style="color:#000;font-weight:bold">|</span> clickhouse-local -S <span style="color:#4e9a06">&#34;Proto String, RecvQ Int64, SendQ Int64, LocalAddress String, ForeignAddress String, State LowCardinality(String)&#34;</span> --query<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;SELECT * FROM table WHERE LocalAddress like &#39;%:9000&#39; FORMAT PrettyCompact&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>netstat -tn 2&gt;/dev/null <span style="color:#000;font-weight:bold">|</span> tail -n +3 <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{ printf(&#34;%s\t%s\t%s\t%s\t%s\t%s\n&#34;, $1, $2, $3, $4, $5, $6) }&#39;</span> <span style="color:#000;font-weight:bold">|</span> clickhouse-local -S <span style="color:#4e9a06">&#34;Proto String, RecvQ Int64, SendQ Int64, LocalAddress String, ForeignAddress String, State LowCardinality(String)&#34;</span> --query<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;SELECT * FROM table WHERE LocalAddress like &#39;%:8123&#39; FORMAT PrettyCompact&#34;</span>
</span></span></code></pre></div><p>ClickHouse has a limit of number of open connections (4000 by default).</p>
</li>
<li>
<p>Check also:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># system overall support limited number of connections it can handle</span>
</span></span><span style="display:flex;"><span>netstat
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># you can also be reaching of of the process ulimits (Max open files)</span>
</span></span><span style="display:flex;"><span>cat /proc/<span style="color:#204a87;font-weight:bold">$(</span>pidof -s clickhouse-server<span style="color:#204a87;font-weight:bold">)</span>/limits
</span></span></code></pre></div></li>
<li>
<p>Check firewall / selinux rules (if used)</p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5c047eed8f820765587e3275057bd864">4 - cgroups and kubernetes cloud providers</h1>
    <div class="lead">cgroups and kubernetes cloud providers.</div>
	<h2 id="cgroups-and-kubernetes-cloud-providers">cgroups and kubernetes cloud providers</h2>
<p>Why my ClickHouse is slow after upgrade to version 22.2 and higher?</p>
<p>The probable reason is that ClickHouse 22.2 started to respect cgroups (Respect cgroups limits in max_threads autodetection. <a href="https://github.com/ClickHouse/ClickHouse/pull/33342" target="_blank">#33342</a> (<a href="https://github.com/JaySon-Huang" target="_blank">JaySon</a>).</p>
<p>You can observe that <code>max_threads = 1</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">settings</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;max_threads&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_threads</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;auto(1)&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────┴───────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This makes ClickHouse to execute all queries with a single thread (normal behavior is half of available CPU cores, cores = 64, then &lsquo;auto(32)&rsquo;).</p>
<p>We observe this cgroups behavior with AWS EKS (Kubernetes) environment and <a href="https://github.com/Altinity/clickhouse-operator" target="_blank">Altinity
ClickHouse Operator</a> in case if requests.cpu and limits.cpu are not set for a resource.</p>
<h2 id="workaround">Workaround</h2>
<p>We suggest to set requests.cpu = <code>half of available CPU cores</code>, and limits.cpu = <code>CPU cores</code>.</p>
<p>For example in case of 16 CPU cores:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>          resources:
</span></span><span style="display:flex;"><span>            requests:
</span></span><span style="display:flex;"><span>              memory: ...
</span></span><span style="display:flex;"><span>              cpu: 8
</span></span><span style="display:flex;"><span>            limits:
</span></span><span style="display:flex;"><span>              memory: ....
</span></span><span style="display:flex;"><span>              cpu: 16
</span></span></code></pre></div><p>Then you should get a new result:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">settings</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;max_threads&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_threads</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;auto(8)&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────┴───────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="in-depth">in depth</h2>
<p>For some reason AWS EKS sets cgroup kernel parameters in case of empty requests.cpu &amp; limits.cpu into these:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us</span>
</span></span><span style="display:flex;"><span>-1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat /sys/fs/cgroup/cpu/cpu.cfs_period_us</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">100000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat /sys/fs/cgroup/cpu/cpu.shares</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span></code></pre></div><p>This makes ClickHouse to set <code>max_threads = 1</code> because of</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>cgroup_share = /sys/fs/cgroup/cpu/cpu.shares (2)
</span></span><span style="display:flex;"><span>PER_CPU_SHARES = 1024
</span></span><span style="display:flex;"><span>share_count = ceil( cgroup_share / PER_CPU_SHARES ) ---&gt; ceil(2 / 1024) ---&gt; 1
</span></span></code></pre></div><h2 id="fix">Fix</h2>
<p>Incorrect calculation was fixed in <a href="https://github.com/ClickHouse/ClickHouse/pull/35815" target="_blank">https://github.com/ClickHouse/ClickHouse/pull/35815</a> and will work correctly on newer releases.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-65c6ddd3186c33d4134ea5a9bd44bff4">5 - ClickHouse operator</h1>
    <div class="lead">ClickHouse operator</div>
	<h2 id="clickhouse-operator">ClickHouse operator</h2>
<p><a href="https://github.com/Altinity/clickhouse-operator/blob/master/docs/README.md" target="_blank">https://github.com/Altinity/clickhouse-operator/blob/master/docs/README.md</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2bf046fe139243d74994289f2cb4e13e">6 - Custom Settings</h1>
    <div class="lead">Using custom settings</div>
	<h2 id="using-custom-settings-in-config">Using custom settings in config</h2>
<p>You can not use the cutsom settings in config file &lsquo;as is&rsquo;, because clickhouse don&rsquo;t know which datatype should be used to parse it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>cat /etc/clickhouse-server/users.d/default_profile.xml 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;profiles&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;default&gt;</span>
</span></span><span style="display:flex;"><span>     	     <span style="color:#204a87;font-weight:bold">&lt;custom_data_version&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/custom_data_version&gt;</span> <span style="color:#8f5902;font-style:italic">&lt;!-- will not work! see below --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/default&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/profiles&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><p>That will end up with the following error:</p>
<pre tabindex="0"><code>2021.09.24 12:50:37.369259 [ 264905 ] {} &lt;Error&gt; ConfigReloader: Error updating configuration from &#39;/etc/clickhouse-server/users.xml&#39; config.: Code: 536. DB::Exception: Couldn&#39;t restore Field from dump: 1: while parsing value &#39;1&#39; for setting &#39;custom_data_version&#39;. (CANNOT_RESTORE_FROM_FIELD_DUMP), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, int, bool) @ 0x9440eba in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
1. DB::Field::restoreFromDump(std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt; const&amp;)::$_4::operator()() const @ 0x10449da0 in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
2. DB::Field::restoreFromDump(std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt; const&amp;) @ 0x10449bf1 in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
3. DB::BaseSettings&lt;DB::SettingsTraits&gt;::stringToValueUtil(std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;) @ 0x1042e2bf in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
4. DB::UsersConfigAccessStorage::parseFromConfig(Poco::Util::AbstractConfiguration const&amp;) @ 0x1041a097 in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
5. void std::__1::__function::__policy_invoker&lt;void (Poco::AutoPtr&lt;Poco::Util::AbstractConfiguration&gt;, bool)&gt;::__call_impl&lt;std::__1::__function::__default_alloc_func&lt;DB::UsersConfigAccessStorage::load(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::function&lt;std::__1::shared_ptr&lt;zkutil::ZooKeeper&gt; ()&gt; const&amp;)::$_0, void (Poco::AutoPtr&lt;Poco::Util::AbstractConfiguration&gt;, bool)&gt; &gt;(std::__1::__function::__policy_storage const*, Poco::AutoPtr&lt;Poco::Util::AbstractConfiguration&gt;&amp;&amp;, bool) @ 0x1042e7ff in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
6. DB::ConfigReloader::reloadIfNewer(bool, bool, bool, bool) @ 0x11caf54e in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
7. DB::ConfigReloader::run() @ 0x11cb0f8f in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
8. ThreadFromGlobalPool::ThreadFromGlobalPool&lt;void (DB::ConfigReloader::*)(), DB::ConfigReloader*&gt;(void (DB::ConfigReloader::*&amp;&amp;)(), DB::ConfigReloader*&amp;&amp;)::&#39;lambda&#39;()::operator()() @ 0x11cb19f1 in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
9. ThreadPoolImpl&lt;std::__1::thread&gt;::worker(std::__1::__list_iterator&lt;std::__1::thread, void*&gt;) @ 0x9481f5f in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
10. void* std::__1::__thread_proxy&lt;std::__1::tuple&lt;std::__1::unique_ptr&lt;std::__1::__thread_struct, std::__1::default_delete&lt;std::__1::__thread_struct&gt; &gt;, void ThreadPoolImpl&lt;std::__1::thread&gt;::scheduleImpl&lt;void&gt;(std::__1::function&lt;void ()&gt;, int, std::__1::optional&lt;unsigned long&gt;)::&#39;lambda0&#39;()&gt; &gt;(void*) @ 0x9485843 in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
11. start_thread @ 0x9609 in /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
12. __clone @ 0x122293 in /usr/lib/x86_64-linux-gnu/libc-2.31.so
 (version 21.10.1.8002 (official build))


2021.09.29 11:36:07.722213 [ 2090 ] {} &lt;Error&gt; Application: DB::Exception: Couldn&#39;t restore Field from dump: 1: while parsing value &#39;1&#39; for setting &#39;custom_data_version&#39;
</code></pre><p>To make it work you need to change it an the following way:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>cat /etc/clickhouse-server/users.d/default_profile.xml 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;profiles&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;default&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;custom_data_version&gt;</span>UInt64_1<span style="color:#204a87;font-weight:bold">&lt;/custom_data_version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/default&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/profiles&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>cat /etc/clickhouse-server/users.d/default_profile.xml 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;profiles&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;default&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;custom_data_version&gt;</span>&#39;1&#39;<span style="color:#204a87;font-weight:bold">&lt;/custom_data_version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/default&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/profiles&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><p>The list of recognized prefixes is in the sources: <a href="https://github.com/ClickHouse/ClickHouse/blob/ea13a8b562edbc422c07b5b4ecce353f79b6cb63/src/Core/Field.cpp#L253-L270" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/ea13a8b562edbc422c07b5b4ecce353f79b6cb63/src/Core/Field.cpp#L253-L270</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bbd4c8156a39e2b06aedbc53ab2fcc76">7 - Description of asynchronous_metrics</h1>
    <div class="lead">Description of asynchronous_metrics</div>
	<pre tabindex="0"><code>CompiledExpressionCacheCount    -- number or compiled cached expression (if CompiledExpressionCache is enabled)

jemalloc -- parameters of jemalloc allocator, they are not very useful, and not interesting

MarkCacheBytes / MarkCacheFiles  -- there are cache for .mrk files (default size is 5GB), you can see is it use all 5GB or not

MemoryCode  -- how much memory allocated for ClickHouse executable 

MemoryDataAndStack -- virtual memory allocated for data and stack

MemoryResident  -- real memory used by ClickHouse ( the same as top RES/RSS)

MemoryShared   -- shared memory used by ClickHouse

MemoryVirtual  -- virtual memory used by ClickHouse ( the same as top VIRT)

NumberOfDatabases

NumberOfTables

ReplicasMaxAbsoluteDelay -- important parameter - replica max absolute delay in seconds

ReplicasMaxRelativeDelay -- replica max relative delay (from other replicas) in seconds

ReplicasMaxInsertsInQueue  -- max number of parts to fetch for a single Replicated table

ReplicasSumInsertsInQueue  -- sum of parts to fetch for all Replicated tables

ReplicasMaxMergesInQueue  -- max number of merges in queue for a single Replicated table

ReplicasSumMergesInQueue  -- total number of merges in queue for all Replicated tables

ReplicasMaxQueueSize -- max number of tasks  for a single Replicated table 

ReplicasSumQueueSize -- total number of tasks in replication queue

UncompressedCacheBytes/UncompressedCacheCells  -- allocated memory for uncompressed cache (disabled by default)

Uptime     -- uptime seconds
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7e8b8793d3f75d7f6e63b71cccb3389e">8 - http handler example</h1>
    <div class="lead">http handler example</div>
	<h2 id="http-handler-example-how-to-disable-play">http handler example (how to disable /play)</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span># cat /etc/clickhouse-server/config.d/play_disable.xml
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">&lt;http_handlers&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;rule&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;url&gt;</span>/play<span style="color:#204a87;font-weight:bold">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;methods&gt;</span>GET<span style="color:#204a87;font-weight:bold">&lt;/methods&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;handler&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;type&gt;</span>static<span style="color:#204a87;font-weight:bold">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;status&gt;</span>403<span style="color:#204a87;font-weight:bold">&lt;/status&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;content_type&gt;</span>text/plain; charset=UTF-8<span style="color:#204a87;font-weight:bold">&lt;/content_type&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;response_content&gt;&lt;/response_content&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;/handler&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/rule&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;defaults/&gt;</span>         <span style="color:#8f5902;font-style:italic">&lt;!-- handler to save default handlers ?query / ping --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/http_handlers&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7c6fe7411111212f4a99eb416db8e345">9 - Logging</h1>
    <div class="lead">Logging configuration and issues</div>
	<p>Q. I get errors:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>File not found: /var/log/clickhouse-server/clickhouse-server.log.0.
</span></span><span style="display:flex;"><span>File not found: /var/log/clickhouse-server/clickhouse-server.log.8.gz.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> File not found: /var/log/clickhouse-server/clickhouse-server.err.log.0, Stack trace <span style="color:#ce5c00;font-weight:bold">(</span>when copying this message, always include the lines below<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>0. Poco::FileImpl::handleLastErrorImpl<span style="color:#ce5c00;font-weight:bold">(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">)</span> @ 0x11c2b345 in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>1. Poco::PurgeOneFileStrategy::purge<span style="color:#ce5c00;font-weight:bold">(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">)</span> @ 0x11c84618 in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>2. Poco::FileChannel::log<span style="color:#ce5c00;font-weight:bold">(</span>Poco::Message const<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">)</span> @ 0x11c314cc in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>3. DB::OwnFormattingChannel::logExtended<span style="color:#ce5c00;font-weight:bold">(</span>DB::ExtendedLogMessage const<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">)</span> @ 0x8681402 in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>4. DB::OwnSplitChannel::logSplit<span style="color:#ce5c00;font-weight:bold">(</span>Poco::Message const<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">)</span> @ 0x8682fa8 in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>5. DB::OwnSplitChannel::log<span style="color:#ce5c00;font-weight:bold">(</span>Poco::Message const<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">)</span> @ 0x8682e41 in /usr/bin/clickhouse
</span></span></code></pre></div><p>A. Check if you have proper permission to a log files folder, and enough disk space (&amp; inode numbers) on the block device used for logging.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -la /var/log/clickhouse-server/
</span></span><span style="display:flex;"><span>df -Th
</span></span><span style="display:flex;"><span>df -Thi
</span></span></code></pre></div><p>Q. How to configure logging in clickhouse?</p>
<p>A. See <a href="https://github.com/ClickHouse/ClickHouse/blob/ceaf6d57b7f00e1925b85754298cf958a278289a/programs/server/config.xml#L9-L62" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/ceaf6d57b7f00e1925b85754298cf958a278289a/programs/server/config.xml#L9-L62</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d380f73c2612b91e3bc35f59f39febe2">10 - Precreate parts using clickhouse-local</h1>
    <div class="lead">Precreate parts using clickhouse-local.</div>
	<h2 id="precreate-parts-using-clickhouse-local">Precreate parts using clickhouse-local</h2>
<pre tabindex="0"><code>rm -rf /tmp/precreate_parts


mkdir -p /tmp/precreate_parts/metadata/local/

cd /tmp/precreate_parts

## 1. Imagine we want to process this file:

cat &lt;&lt;EOF &gt; /tmp/data.csv
1,2020-01-01,&#34;String&#34;
2,2020-02-02,&#34;Another string&#34;
3,2020-03-03,&#34;One more string&#34;
4,2020-01-02,&#34;String for first partition&#34;
EOF

## 2. that is the metadata for the table we want to fill
## schema should match the schema of the table from server
## (the easiest way is just to copy it from the server)

## I&#39;ve added sleepEachRow(0.5) here just to mimic slow insert

cat &lt;&lt;EOF &gt; metadata/local/test.sql
ATTACH TABLE local.test (id UInt64, d Date, s String, x MATERIALIZED sleepEachRow(0.5)) Engine=MergeTree ORDER BY id PARTITION BY toYYYYMM(d);
EOF

## 3a. that is the metadata for the input file we want to read
## it should match the structure of source file

## use stdin to read from pipe 

cat &lt;&lt;EOF &gt; metadata/local/stdin.sql 
ATTACH TABLE local.stdin (id UInt64, d Date, s String) Engine=File(CSV, stdin);
EOF

## 3b. Instead of stdin you can use file path 

cat &lt;&lt;EOF &gt; metadata/local/data_csv.sql 
ATTACH TABLE local.data_csv (id UInt64, d Date, s String) Engine=File(CSV, &#39;/tmp/data.csv&#39;);
EOF

## All preparations done,
## the rest is simple:

# option a (if 3a used) with pipe / reading stdin

cat /tmp/data.csv | clickhouse-local --query &#34;INSERT INTO local.test SELECT * FROM local.stdin&#34; -- --path=.

# option b (if 3b used) 0 with filepath 
cd /tmp/precreate_parts
clickhouse-local --query &#34;INSERT INTO local.test SELECT * FROM local.data_csv&#34; -- --path=.


# now you can check what was inserted (i did both options so i have doubled data)

clickhouse-local --query &#34;SELECT _part,* FROM local.test ORDER BY id&#34; -- --path=.
202001_4_4_0	1	2020-01-01	String
202001_1_1_0	1	2020-01-01	String
202002_5_5_0	2	2020-02-02	Another string
202002_2_2_0	2	2020-02-02	Another string
202003_6_6_0	3	2020-03-03	One more string
202003_3_3_0	3	2020-03-03	One more string
202001_4_4_0	4	2020-01-02	String for first partition
202001_1_1_0	4	2020-01-02	String for first partition

# But you can&#39;t do OPTIMIZE (local will die with coredump) :) That would be too good
# clickhouse-local --query &#34;OPTIMIZE TABLE local.test FINAL&#34; -- --path=.

## now you can upload those parts to a server (in detached subfolder) and attach them.

mfilimonov@laptop5591:/tmp/precreate_parts$ ls -la data/local/test/
total 40
drwxrwxr-x 9 mfilimonov mfilimonov 4096 paź 15 11:15 .
drwxrwxr-x 3 mfilimonov mfilimonov 4096 paź 15 11:15 ..
drwxrwxr-x 2 mfilimonov mfilimonov 4096 paź 15 11:15 202001_1_1_0
drwxrwxr-x 2 mfilimonov mfilimonov 4096 paź 15 11:15 202001_4_4_0
drwxrwxr-x 2 mfilimonov mfilimonov 4096 paź 15 11:15 202002_2_2_0
drwxrwxr-x 2 mfilimonov mfilimonov 4096 paź 15 11:15 202002_5_5_0
drwxrwxr-x 2 mfilimonov mfilimonov 4096 paź 15 11:15 202003_3_3_0
drwxrwxr-x 2 mfilimonov mfilimonov 4096 paź 15 11:15 202003_6_6_0
drwxrwxr-x 2 mfilimonov mfilimonov 4096 paź 15 11:15 detached
-rw-rw-r-- 1 mfilimonov mfilimonov    1 paź 15 11:15 format_version.txt


mfilimonov@laptop5591:/tmp/precreate_parts$ ls -la data/local/test/202001_1_1_0/
total 44
drwxrwxr-x 2 mfilimonov mfilimonov 4096 paź 15 11:15 .
drwxrwxr-x 9 mfilimonov mfilimonov 4096 paź 15 11:15 ..
-rw-rw-r-- 1 mfilimonov mfilimonov  250 paź 15 11:15 checksums.txt
-rw-rw-r-- 1 mfilimonov mfilimonov   79 paź 15 11:15 columns.txt
-rw-rw-r-- 1 mfilimonov mfilimonov    1 paź 15 11:15 count.txt
-rw-rw-r-- 1 mfilimonov mfilimonov  155 paź 15 11:15 data.bin
-rw-rw-r-- 1 mfilimonov mfilimonov  144 paź 15 11:15 data.mrk3
-rw-rw-r-- 1 mfilimonov mfilimonov   10 paź 15 11:15 default_compression_codec.txt
-rw-rw-r-- 1 mfilimonov mfilimonov    4 paź 15 11:15 minmax_d.idx
-rw-rw-r-- 1 mfilimonov mfilimonov    4 paź 15 11:15 partition.dat
-rw-rw-r-- 1 mfilimonov mfilimonov   16 paź 15 11:15 primary.idx
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ba31da9c4b193969853f742350ad98c9">11 - Access Control and Account Management example (RBAC)</h1>
    <div class="lead">Access Control and Account Management example (RBAC).</div>
	<p>Documentation <a href="https://clickhouse.com/docs/en/operations/access-rights/" target="_blank">https://clickhouse.com/docs/en/operations/access-rights/</a></p>
<h2 id="example-3-roles-dba-dashboard_ro-ingester_rw">Example: 3 roles (dba, dashboard_ro, ingester_rw)</h2>
<p>You need to create an .xml file at each node to allow user <code>default</code> to manage access using SQL.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>cat /etc/clickhouse-server/users.d/access_management.xml
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;users&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;default&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;access_management&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/access_management&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/default&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/users&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dba</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">grant</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dba</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">user1</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">identified</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pass1234&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">grant</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dba</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dashboard_ro</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">grant</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dashboard_ro</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">grant</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dictGet</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dashboard_ro</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">settings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">replace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile_dashboard_ro</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">settings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_concurrent_queries_for_user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_threads</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_memory_usage_for_user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;30G&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_memory_usage</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;30G&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_execution_time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">60</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_rows_to_read</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000000000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_bytes_to_read</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;5000G&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dashboard_ro</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">dash1</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">identified</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pass1234&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">grant</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dashboard_ro</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dash1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ingester_rw</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">grant</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ingester_rw</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">settings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">replace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile_ingester_rw</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">settings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_concurrent_queries_for_user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">-- user can run 40 queries (select, insert ...) simultaneously  
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_threads</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#8f5902;font-style:italic">-- each query can use up to 10 cpu (READONLY means user cannot override a value)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_memory_usage_for_user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;30G&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic">-- all queries of the user can use up to 30G RAM
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_memory_usage</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;25G&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic">-- each query can use up to 25G RAM
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_execution_time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic">-- each query can executes no longer 200 seconds
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_rows_to_read</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000000000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic">-- each query can read up to 1 billion rows
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">max_bytes_to_read</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;5000G&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">READONLY</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic">-- each query can read up to 5 TB from a MergeTree
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ingester_rw</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">ingester_app1</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">identified</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pass1234&#39;</span><span style="color:#f8f8f8;text-decoration:underline">　</span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">grant</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ingester_rw</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ingester_app1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="check">check</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ clickhouse-client -u dash1 --password pass1234
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>create table <span style="color:#204a87">test</span> <span style="color:#ce5c00;font-weight:bold">(</span> A Int64<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">Engine</span><span style="color:#ce5c00;font-weight:bold">=</span>Log<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   DB::Exception: dash1: Not enough privileges
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>$ clickhouse-client -u user1 --password pass1234
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>create table <span style="color:#204a87">test</span> <span style="color:#ce5c00;font-weight:bold">(</span> A Int64<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">Engine</span><span style="color:#ce5c00;font-weight:bold">=</span>Log<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>Ok.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>drop table test<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>Ok.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ clickhouse-client -u ingester_app1 --password pass1234
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span> count<span style="color:#ce5c00;font-weight:bold">()</span> from system.numbers limit 1000000000000<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   DB::Exception: Received from localhost:9000. DB::Exception: Limit <span style="color:#204a87;font-weight:bold">for</span> rows or bytes to <span style="color:#204a87">read</span> exceeded, max rows: 1.00 billion
</span></span></code></pre></div><h2 id="clean-up">clean up</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profiles</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">─────────────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile_dashboard_ro</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile_ingester_rw</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">readonly</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">readonly</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile_dashboard_ro</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">profile_ingester_rw</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">roles</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">─────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dashboard_ro</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dba</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ingester_rw</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dba</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dashboard_ro</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ingester_rw</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">──────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dash1</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ingester_app1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user1</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└───────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ingester_app1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dash1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-178be1fa49d7fab0cb9c1deba7df54ca">12 - recovery-after-complete-data-loss</h1>
    <div class="lead">Recovery after complete data loss</div>
	<h1 id="atomic--ordinary-databases">Atomic &amp; Ordinary databases.</h1>
<p>srv1 &ndash; good replica</p>
<p>srv2 &ndash; lost replica / we will restore it from srv1</p>
<h2 id="test-data-3-tables-atomic--ordinary-databases">test data (3 tables (atomic &amp; ordinary databases))</h2>
<p>srv1</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testatomic</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">engine</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">Atomic</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testatomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">A</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">D</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{database}/{table}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">partition</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toYYYYMM</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">D</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testatomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">today</span><span style="color:#000;font-weight:bold">(),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testordinary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">engine</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">Ordinary</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testordinary</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">A</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">D</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{database}/{table}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">partition</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toYYYYMM</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">D</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testordinary</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">today</span><span style="color:#000;font-weight:bold">(),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">A</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">D</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{database}/{table}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">partition</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toYYYYMM</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">D</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">today</span><span style="color:#000;font-weight:bold">(),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="destroy-srv2">destroy srv2</h2>
<p>srv2</p>
<pre tabindex="0"><code>/etc/init.d/clickhouse-server stop
rm -rf /var/lib/clickhouse/*
</code></pre><h2 id="generate-script-to-re-create-databases-create_databasesql">generate script to re-create databases (create_database.sql).</h2>
<p>srv1</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">home</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">ubuntu</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">generate_schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">sql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">concat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CREATE DATABASE &#34;&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#34; ENGINE = &#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">engine</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39; COMMENT \&#39;&#39;, comment, &#39;</span><span style="color:#a40000">\</span><span style="color:#4e9a06">&#39;;&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">databases</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;INFORMATION_SCHEMA&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;system&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;default&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">clickhouse</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">client</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">home</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">denis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zhuravlev</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">generate_schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">sql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">create_database</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">sql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>check the result</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat create_database.sql
</span></span><span style="display:flex;"><span>CREATE DATABASE <span style="color:#4e9a06">&#34;testatomic&#34;</span> <span style="color:#000">ENGINE</span> <span style="color:#ce5c00;font-weight:bold">=</span> Atomic COMMENT <span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>CREATE DATABASE <span style="color:#4e9a06">&#34;testordinary&#34;</span> <span style="color:#000">ENGINE</span> <span style="color:#ce5c00;font-weight:bold">=</span> Ordinary COMMENT <span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>transfer this create_database.sql to srv2 (scp / rsync)</p>
<h2 id="make-a-copy-of-schema-sql-files-metadata_schematar">make a copy of schema sql files (metadata_schema.tar)</h2>
<p>srv1</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> /var/lib/clickhouse/
</span></span><span style="display:flex;"><span>tar -cvhf /home/ubuntu/metadata_schema.tar metadata
</span></span></code></pre></div><p><code>-h</code> - is important! (-h, &ndash;dereference Follow symlinks; archive and dump the files they point to.)</p>
<p>transfer this metadata_schema.tar to srv2 (scp / rsync)</p>
<h2 id="create-databases-at-srv2">create databases at srv2</h2>
<p>srv2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/etc/init.d/clickhouse-server start
</span></span><span style="display:flex;"><span>clickhouse-client &lt; create_database.sql
</span></span><span style="display:flex;"><span>/etc/init.d/clickhouse-server stop
</span></span></code></pre></div><h2 id="create-tables-at-srv2">create tables at srv2</h2>
<p>srv2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> /var/lib/clickhouse/
</span></span><span style="display:flex;"><span>tar xkfv /home/ubuntu/metadata_schema.tar
</span></span><span style="display:flex;"><span>sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
</span></span><span style="display:flex;"><span>/etc/init.d/clickhouse-server start
</span></span></code></pre></div><p><code>tar xkfv</code> <code>-k</code> is important! To save folders/symlinks created with create database ( -k, &ndash;keep-old-files Don&rsquo;t replace existing files when extracting )</p>
<h2 id="check-a-recovery">check a recovery</h2>
<p>srv2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testatomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testordinary</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a621d627feb47445d97f056ab85fb1c0">13 - source parts size is greater than the current maximum</h1>
    <div class="lead">source parts size (&hellip;) is greater than the current maximum (&hellip;)</div>
	<h2 id="symthom">Symthom</h2>
<p>I see messages like: <code>source parts size (...) is greater than the current maximum (...)</code> in the logs and/or inside <code>system.replication_queue</code></p>
<h2 id="cause">Cause</h2>
<p>Usually that means that there are already few big merges running.
You can see the running merges using the query:</p>
<pre tabindex="0"><code>SELECT * FROM system.merges
</code></pre><p>That logic is needed to prevent picking a log of huge merges simultaneously
(otherwise they will take all available slots and clickhouse will not be
able to do smaller merges, which usally are important for keeping the
number of parts stable).</p>
<h2 id="action">Action</h2>
<p>It is normal to see those messages on some stale replicas. And it should be resolved
automatically after some time. So just wait &amp; monitor system.merges &amp;
system.replication_queue tables, it should be resolved by it&rsquo;s own.</p>
<p>If it happens often or don&rsquo;t resolves by it&rsquo;s own during some longer period of time,
it could be caused by:</p>
<ol>
<li>increased insert pressure</li>
<li>disk issues / high load (it works slow, not enought space etc.)</li>
<li>high CPU load (not enough CPU power to catch up with merges)</li>
<li>issue with table schemas leading to high merges pressure (high / increased number of tables / partitions / etc.)</li>
</ol>
<p>Start from checking dmesg / system journals / clickhouse monitoring to find the anomalies.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-598152e68b617d22b315a15725d3db6c">14 - Successful ClickHouse deployment plan</h1>
    <div class="lead">Successful ClickHouse deployment plan.</div>
	<h2 id="successful-clickhouse-deployment-plan">Successful ClickHouse deployment plan</h2>
<h3 id="stage-0-build-poc">Stage 0. Build POC</h3>
<ol>
<li>Install single node clickhouse
<ul>
<li><a href="https://clickhouse.com/docs/en/getting-started/tutorial/" target="_blank">https://clickhouse.com/docs/en/getting-started/tutorial/</a></li>
<li><a href="https://clickhouse.com/docs/en/getting-started/install/" target="_blank">https://clickhouse.com/docs/en/getting-started/install/</a></li>
<li><a href="https://docs.altinity.com/altinitystablebuilds/stablequickstartguide/" target="_blank">https://docs.altinity.com/altinitystablebuilds/stablequickstartguide/</a></li>
</ul>
</li>
<li>Start with creating a single table (the biggest one), use MergeTree engine. Create &lsquo;some&rsquo; schema (most probably it will be far from optimal). Prefer denormalized approach for all immutable dimensions, for mutable dimensions - consider dictionaries.</li>
<li>Load some amount of data (at least 5 Gb, and 10 mln rows) - preferable the real one, or as close to real as possible. Usully the simplest options are either through CSV / TSV files (or <code>insert into clickhouse_table select * FROM mysql(...) where ...</code>)</li>
<li>Create several representative queries.</li>
<li>Check the columns cardinality, and appropriate types, use minimal needed type</li>
<li>Review the partition by and order by. <a href="https://kb.altinity.com/engines/mergetree-table-engine-family/pick-keys/" target="_blank">https://kb.altinity.com/engines/mergetree-table-engine-family/pick-keys/</a></li>
<li>Create the schema(s) with better/promising order by / partitioning, load data in. Pick the best schema.</li>
<li>consider different improvements of particular columns (codecs / better data types etc.) <a href="https://kb.altinity.com/altinity-kb-schema-design/codecs/altinity-kb-how-to-test-different-compression-codecs/" target="_blank">https://kb.altinity.com/altinity-kb-schema-design/codecs/altinity-kb-how-to-test-different-compression-codecs/</a></li>
<li>If the performance of certain queries is not enough - consider using PREWHERE / skipping indexes</li>
<li>Repeat 2-9 for next big table(s). Avoid scenarios when you need to join big tables.</li>
<li>Pick the clients library for you programming language (the most mature are python / golang / java / c++), build some pipeline - for inserts (low QPS, lot of rows in singe insert, check acknowledgements &amp; retry the same block on failures), ETLs if needed, some reporting layer (<a href="https://kb.altinity.com/altinity-kb-integrations/bi-tools/" target="_blank">https://kb.altinity.com/altinity-kb-integrations/bi-tools/</a>) </li>
</ol>
<h3 id="stage-1-planning-the-production-setup">Stage 1. Planning the production setup</h3>
<ol>
<li>Collect more data / estimate insert speed, estimate the column sizes per day / month.</li>
<li>Measure the speed of queries</li>
<li>Consider improvement using materialized views / projections / dictionaries.</li>
<li>Collect requirements (ha / number of simultaneous queries / insert pressure / &rsquo;exactly once&rsquo; etc)</li>
<li>Do a cluster sizing estimation, plan the hardware 
<ul>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/hardware-requirements/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/hardware-requirements/</a></li>
<li><a href="https://blog.cloudflare.com/clickhouse-capacity-estimation-framework/" target="_blank">https://blog.cloudflare.com/clickhouse-capacity-estimation-framework/</a></li>
</ul>
</li>
<li>plan the network, if needed - consider using LoadBalancers etc.
<ul>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/network-configuration/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/network-configuration/</a></li>
</ul>
</li>
<li>If you need sharding - consider different sharding approaches.</li>
</ol>
<h3 id="stage-2-preprod-setup--developement">Stage 2. Preprod setup &amp; developement</h3>
<ol>
<li>Install clickhouse in cluster - several nodes / VMs + zookeeper
<ul>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/cluster-configuration-process/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/cluster-configuration-process/</a></li>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/altinity-kb-proper-setup/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/altinity-kb-proper-setup/</a></li>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/</a></li>
</ul>
</li>
<li>Create good config &amp; automate config / os / restarts (ansible / puppet etc)
<ul>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-settings-to-adjust/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-settings-to-adjust/</a></li>
<li>for docker: <a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-clickhouse-in-docker/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-clickhouse-in-docker/</a></li>
<li>for k8, use clickhouse-operator OR <a href="https://kb.altinity.com/altinity-kb-kubernetes/altinity-kb-possible-issues-with-running-clickhouse-in-k8s/" target="_blank">https://kb.altinity.com/altinity-kb-kubernetes/altinity-kb-possible-issues-with-running-clickhouse-in-k8s/</a></li>
</ul>
</li>
<li>Set up monitoring / log processing / alerts etc.
<ul>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-monitoring/#build-your-own-monitoring" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-monitoring/#build-your-own-monitoring</a></li>
</ul>
</li>
<li>Set up users.
<ul>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/rbac/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/rbac/</a></li>
</ul>
</li>
<li>Think of schema management. Deploy the schema.
<ul>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/schema-migration-tools/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/schema-migration-tools/</a></li>
</ul>
</li>
<li>Design backup / failover strategies:
<ul>
<li><a href="https://clickhouse.com/docs/en/operations/backup/" target="_blank">https://clickhouse.com/docs/en/operations/backup/</a></li>
<li><a href="https://github.com/AlexAkulov/clickhouse-backup" target="_blank">https://github.com/AlexAkulov/clickhouse-backup</a></li>
</ul>
</li>
<li>Develop pipelines / queries, create test suite, CI/CD</li>
<li>Do benchmark / stress tests</li>
<li>Test configuration changes / server restarts / failovers / version upgrades</li>
<li>Review the security topics (tls, limits / restrictions, network, passwords)</li>
<li>Document the solution for operations</li>
</ol>
<h3 id="stage-3-production-setup">Stage 3. Production setup</h3>
<ol>
<li>Deploy the production setup (consider also canary / blue-greed deployments etc)</li>
<li>Schedule ClickHouse upgrades every 6 to 12 months (if possible)</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-36bd996bf58568ac32e55cbc1970dce1">15 - Timeouts during OPTIMIZE FINAL</h1>
    <div class="lead"><code>Timeout exceeded ...</code> or <code>executing longer than distributed_ddl_task_timeout</code>  during <code>OPTIMIZE FINAL</code>.</div>
	<h2 id="timeout-exceeded--or-executing-longer-than-distributed_ddl_task_timeout--during-optimize-final"><code>Timeout exceeded ...</code> or <code>executing longer than distributed_ddl_task_timeout</code>  during <code>OPTIMIZE FINAL</code></h2>
<p>Timeout may occur</p>
<ol>
<li>
<p>due to the fact that the client reach timeout interval.</p>
<ul>
<li>in case of TCP / native clients - you can change send_timeout / recieve_timeout + tcp_keep_alive_timeout + driver timeout settings</li>
<li>in case of HTTP clients - you can change http_send_timeout / http_receive_timeout + tcp_keep_alive_timeout + driver timeout settings</li>
</ul>
</li>
<li>
<p>(in the case of ON CLUSTER queries) due to the fact that the timeout for query execution by shards ends</p>
<ul>
<li>see setting <code>distributed_ddl_task_timeout</code></li>
</ul>
</li>
</ol>
<p>In the first case you additionally may get the misleading messages: <code>Cancelling query. ... Query was cancelled.</code></p>
<p>In both cases, this does NOT stop the execution of the OPTIMIZE command. It continues to work even after
the client is disconnected. You can see the progress of that in <code>system.processes</code> / <code>show processlist</code> / <code>system.merges</code> / <code>system.query_log</code>.</p>
<p>The same applies to queries like:</p>
<ul>
<li><code>INSERT ... SELECT</code></li>
<li><code>CREATE TABLE ...  AS SELECT</code></li>
<li><code>CREATE MATERIALIZED VIEW ... POPULATE ...</code></li>
</ul>
<p>It is possible to run a query with some special <code>query_id</code> and then poll the status from the processlist (in the case of a cluster, it can be a bit more complicated).</p>
<p>See also</p>
<ul>
<li><a href="https://github.com/ClickHouse/ClickHouse/issues/6093" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/6093</a></li>
<li><a href="https://github.com/ClickHouse/ClickHouse/issues/7794" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/7794</a></li>
<li><a href="https://github.com/ClickHouse/ClickHouse/issues/28896" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/28896</a></li>
<li><a href="https://github.com/ClickHouse/ClickHouse/issues/19319" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/19319</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bdd41222cb6666cd88673471ac35bde8">16 - Useful settings to turn on/Defaults that should be reconsidered</h1>
    <div class="lead">Useful settings to turn on.</div>
	<h2 id="useful-settings-to-turn-ondefaults-that-should-be-reconsidered">Useful settings to turn on/Defaults that should be reconsidered</h2>
<p>Some setting that are not enabled by default.</p>
<ul>
<li><a href="https://clickhouse.com/docs/en/operations/settings/settings/#ttl_only_drop_parts" target="_blank">ttl_only_drop_parts</a></li>
</ul>
<p>Enables or disables complete dropping of data parts where all rows are expired in MergeTree tables.</p>
<p>When ttl_only_drop_parts is disabled (by default), the ClickHouse server only deletes expired rows according to their TTL.</p>
<p>When ttl_only_drop_parts is enabled, the ClickHouse server drops a whole part when all rows in it are expired.</p>
<p>Dropping whole parts instead of partial cleaning TTL-d rows allows having shorter merge_with_ttl_timeout times and lower impact on system performance.</p>
<ul>
<li><a href="https://clickhouse.com/docs/en/operations/settings/settings/#join_use_nulls" target="_blank">join_use_nulls</a></li>
</ul>
<p>Might be you not expect that join will be filled with default values for missing columns (instead of classic NULLs) during JOIN.</p>
<p>Sets the type of JOIN behaviour. When merging tables, empty cells may appear. ClickHouse fills them differently based on this setting.</p>
<p>Possible values:</p>
<p>0 — The empty cells are filled with the default value of the corresponding field type.
1 — JOIN behaves the same way as in standard SQL. The type of the corresponding field is converted to Nullable, and empty cells are filled with NULL.</p>
<ul>
<li><a href="https://clickhouse.com/docs/en/operations/settings/settings/#aggregate_functions_null_for_empty" target="_blank">aggregate_functions_null_for_empty</a></li>
</ul>
<p>Default behaviour is not compatible with ANSI SQL (ClickHouse avoids Nullable types by perfomance reasons)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">x</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┬─</span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">nan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└────────┴────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aggregate_functions_null_for_empty</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">x</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">sumOrNull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┬─</span><span style="color:#000">avgOrNull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#a40000">ᴺᵁᴸᴸ</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#a40000">ᴺᵁᴸᴸ</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────────┴──────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3c882b894707a1546ab5cd4e5a238a68">17 - ZooKeeper session has expired</h1>
    <div class="lead">ZooKeeper session has expired.</div>
	<blockquote>
<p><strong>Q. I get &ldquo;ZooKeeper session has expired&rdquo; once. What should i do? Should I worry?</strong></p>
</blockquote>
<p>Getting exceptions or lack of acknolegment in distributed system from time to time is a normal situation.
Your client should do the retry. If that happened once and your client do retries correctly - nothing to worry about.</p>
<p>It it happens often, or with every retry - it may be a sign of some misconfiguration / issue in cluster (see below).</p>
<blockquote>
<p><strong>Q. we see a lot of these: ZooKeeper session has expired. Switching to a new session</strong></p>
</blockquote>
<p>A. There is a single zookeeper session per server. But there are many threads that can use zookeeper simultaneously.
So the same event (we lose the single zookeeper session we had), will be reported by all the threads/queries which were using that zookeeper session.</p>
<p>Usually after loosing the zookeeper session that exception is printed by all the thread which watch zookeeper replication queues, and all the threads which had some in-flight zookeeper operations (for example inserts, <code>ON CLUSTER</code> commands etc).</p>
<p>If you see a lot of those simultaniously - that just means you have a lot of threads talking to zookeeper simultaniously (or may be you have many replicated tables?).</p>
<p>BTW: every Replicated table comes with its own cost, so you <a href="/altinity-kb-schema-design/how-much-is-too-much/#number-of-tables-system-wide-across-all-databases">can&amp;rsquo;t scale the number of replicated tables indefinitely</a>.</p>
<p>Typically after several hundreds (sometimes thousands) of replicated tables, the clickhouse server becomes unusable: it can&rsquo;t do any other work, but only keeping replication housekeeping tasks. &lsquo;ClickHouse-way&rsquo; is to have a few (maybe dozens) of very huge tables instead of having thousands of tiny tables. (Side note: the number of not-replicated tables can be scaled much better).</p>
<p>So again if during short period of time you see lot of those exceptions and that don&rsquo;t happen anymore for a while - nothing to worry about. Just ensure your client is doing retries properly.</p>
<blockquote>
<p><strong>Q. We are wondering what is causing that session to &ldquo;timeout&rdquo; as the default looks like 30 seconds, and there&rsquo;s certainly stuff happening much more frequently than every 30 seconds.</strong></p>
</blockquote>
<p>Typically that has nothing with an expiration/timeout - even if you do nothing there are heartbeat events in the zookeeper protocol.</p>
<p>So internally inside clickhouse:</p>
<ol>
<li>we have a &lsquo;zookeeper client&rsquo; which in practice is a single zookeeper connection (TCP socket), with 2 threads - one serving reads, the seconds serving writes, and some API around.</li>
<li>while everything is ok zookeeper client keeps a single logical &lsquo;zookeeper session&rsquo; (also by sending heartbeats etc).</li>
<li>we may have hundreds of &lsquo;users&rsquo; of that zookeeper client - those are threads that do some housekeeping, serve queries etc.</li>
<li>zookeeper client normally have dozen &lsquo;in-flight&rsquo; requests (asked by different threads). And if something bad happens with that
(disconnect, some issue with zookeeper server, some other failure), zookeeper client needs to re-establish the connection and switch to the new session
so all those &lsquo;in-flight&rsquo; requests will be terminated with a &lsquo;session expired&rsquo; exception.</li>
</ol>
<blockquote>
<p><strong>Q. That problem happens very often (all the time, every X minutes / hours / days).</strong></p>
</blockquote>
<p>Sometimes the real issue can be visible somewhere close to the first &lsquo;session expired&rsquo; exception in the log. (i.e. zookeeper client thread can
know &amp; print to logs the real reason, while all &lsquo;user&rsquo; threads just get &lsquo;session expired&rsquo;).</p>
<p>Also zookeeper logs may ofter have a clue to that was the real problem.</p>
<p>Known issues which can lead to session termination by zookeeper:</p>
<ol>
<li>connectivity / network issues.</li>
<li><code>jute.maxbuffer</code> overrun. If you need to pass too much data in a single zookeeper transaction. (often happens if you need to do ALTER table UPDATE or other mutation on the table with big number of parts). The fix is adjusting JVM setting: -Djute.maxbuffer=8388608. See <a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/jvm-sizes-and-garbage-collector-settings/" target="_blank">https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/jvm-sizes-and-garbage-collector-settings/</a></li>
<li>XID overflow. XID is a transaction counter in zookeeper, if you do too many transactions the counter reaches maxint32, and to restart the counter zookeeper closes all the connections. Usually, that happens rarely, and is not avoidable in zookeeper (well in clickhouse-keeper that problem solved). There are some corner cases / some schemas which may end up with that XID overflow happening quite often. (a worst case we saw was once per 3 weeks).</li>
</ol>
<blockquote>
<p><strong>Q. &ldquo;ZooKeeper session has expired&rdquo; happens every time I try to start the mutation / do other ALTER on Replicated table.</strong></p>
</blockquote>
<p>During ALTERing replicated table ClickHouse need to create a record in zookeeper listing all the parts which should be mutated (that usually means = list names of all parts of the table). If the size of list of parts exceeds maximum buffer size - zookeeper drops the connection.</p>
<p>Parts name length can be different for different tables. In average with default <code>jute.maxbuffer</code> (1Mb) mutations start to fail for tables which have more than 5000 parts.</p>
<p>Solutions:</p>
<ol>
<li>rethink partitioning, high number of parts in table is usually <a href="https://kb.altinity.com/altinity-kb-schema-design/how-much-is-too-much/#number-of-parts--partitions-system-wide-across-all-databases" target="_blank">not recommended</a></li>
<li>increase <code>jute.maxbuffer</code> on zookeeper side <a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/jvm-sizes-and-garbage-collector-settings/" target="_blank">to values about 8M</a></li>
<li>use IN PARITION clause for mutations (where applicable) - since <a href="https://github.com/ClickHouse/ClickHouse/pull/13403" target="_blank">20.12</a></li>
<li>switch to clickhouse-keeper</li>
</ol>
<p>Related issues:</p>
<ul>
<li><a href="https://github.com/ClickHouse/ClickHouse/issues/16307" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/16307</a></li>
<li><a href="https://github.com/ClickHouse/ClickHouse/issues/11933" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/11933</a></li>
<li><a href="https://github.com/ClickHouse/ClickHouse/issues/32646" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/32646</a></li>
<li><a href="https://github.com/ClickHouse/ClickHouse/issues/15882" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/15882</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c5646e9a69c9b22cfb88e043089f04f0">18 - Altinity packaging compatibility &gt;21.x and earlier</h1>
    <div class="lead">Altinity packaging compatibility &gt;21.x and earlier</div>
	<h2 id="working-with-altinity--yandex-packaging-together">Working with Altinity &amp; Yandex packaging together</h2>
<p>Since version 21.1 Altinity switches to the same packaging as used by Yandex. That is needed for syncing things and introduces several improvements (like adding systemd service file).</p>
<p>Unfortunately, that change leads to compatibility issues - automatic dependencies resolution gets confused by the conflicting package names: both when you update ClickHouse to the new version (the one which uses older packaging) and when you want to install older altinity packages (20.8 and older).</p>
<h3 id="installing-old-clickhouse-version-with-old-packaging-schema">Installing old clickhouse version (with old packaging schema)</h3>
<p>When you try to install versions 20.8 or older from Altinity repo -</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">version</span><span style="color:#ce5c00;font-weight:bold">=</span>20.8.12.2-1.el7
</span></span><span style="display:flex;"><span>yum install clickhouse-client-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span> clickhouse-server-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><p>yum outputs smth like</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install clickhouse-client-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span> clickhouse-server-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>Loaded plugins: fastestmirror, ovl
</span></span><span style="display:flex;"><span>Loading mirror speeds from cached hostfile
</span></span><span style="display:flex;"><span> * base: centos.hitme.net.pl
</span></span><span style="display:flex;"><span> * extras: centos1.hti.pl
</span></span><span style="display:flex;"><span> * updates: centos1.hti.pl
</span></span><span style="display:flex;"><span>Altinity_clickhouse-altinity-stable/x86_64/signature                                                                                                                                <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">833</span> B  00:00:00
</span></span><span style="display:flex;"><span>Altinity_clickhouse-altinity-stable/x86_64/signature                                                                                                                                <span style="color:#000;font-weight:bold">|</span> 1.0 kB  00:00:01 !!!
</span></span><span style="display:flex;"><span>Altinity_clickhouse-altinity-stable-source/signature                                                                                                                                <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">833</span> B  00:00:00
</span></span><span style="display:flex;"><span>Altinity_clickhouse-altinity-stable-source/signature                                                                                                                                <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">951</span> B  00:00:00 !!!
</span></span><span style="display:flex;"><span>Resolving Dependencies
</span></span><span style="display:flex;"><span>--&gt; Running transaction check
</span></span><span style="display:flex;"><span>---&gt; Package clickhouse-client.x86_64 0:20.8.12.2-1.el7 will be installed
</span></span><span style="display:flex;"><span>---&gt; Package clickhouse-server.x86_64 0:20.8.12.2-1.el7 will be installed
</span></span><span style="display:flex;"><span>--&gt; Processing Dependency: clickhouse-server-common <span style="color:#ce5c00;font-weight:bold">=</span> 20.8.12.2-1.el7 <span style="color:#204a87;font-weight:bold">for</span> package: clickhouse-server-20.8.12.2-1.el7.x86_64
</span></span><span style="display:flex;"><span>Package clickhouse-server-common is obsoleted by clickhouse-server, but obsoleting package does not provide <span style="color:#204a87;font-weight:bold">for</span> requirements
</span></span><span style="display:flex;"><span>--&gt; Processing Dependency: clickhouse-common-static <span style="color:#ce5c00;font-weight:bold">=</span> 20.8.12.2-1.el7 <span style="color:#204a87;font-weight:bold">for</span> package: clickhouse-server-20.8.12.2-1.el7.x86_64
</span></span><span style="display:flex;"><span>--&gt; Running transaction check
</span></span><span style="display:flex;"><span>---&gt; Package clickhouse-common-static.x86_64 0:20.8.12.2-1.el7 will be installed
</span></span><span style="display:flex;"><span>---&gt; Package clickhouse-server.x86_64 0:20.8.12.2-1.el7 will be installed
</span></span><span style="display:flex;"><span>--&gt; Processing Dependency: clickhouse-server-common <span style="color:#ce5c00;font-weight:bold">=</span> 20.8.12.2-1.el7 <span style="color:#204a87;font-weight:bold">for</span> package: clickhouse-server-20.8.12.2-1.el7.x86_64
</span></span><span style="display:flex;"><span>Package clickhouse-server-common is obsoleted by clickhouse-server, but obsoleting package does not provide <span style="color:#204a87;font-weight:bold">for</span> requirements
</span></span><span style="display:flex;"><span>--&gt; Finished Dependency Resolution
</span></span><span style="display:flex;"><span>Error: Package: clickhouse-server-20.8.12.2-1.el7.x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>Altinity_clickhouse-altinity-stable<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>           Requires: clickhouse-server-common <span style="color:#ce5c00;font-weight:bold">=</span> 20.8.12.2-1.el7
</span></span><span style="display:flex;"><span>           Available: clickhouse-server-common-1.1.54370-2.x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>clickhouse-stable<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>               clickhouse-server-common <span style="color:#ce5c00;font-weight:bold">=</span> 1.1.54370-2
</span></span><span style="display:flex;"><span>           Available: clickhouse-server-common-1.1.54378-2.x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>clickhouse-stable<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>               clickhouse-server-common <span style="color:#ce5c00;font-weight:bold">=</span> 1.1.54378-2
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>           Available: clickhouse-server-common-20.8.11.17-1.el7.x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>Altinity_clickhouse-altinity-stable<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>               clickhouse-server-common <span style="color:#ce5c00;font-weight:bold">=</span> 20.8.11.17-1.el7
</span></span><span style="display:flex;"><span>           Available: clickhouse-server-common-20.8.12.2-1.el7.x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>Altinity_clickhouse-altinity-stable<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>               clickhouse-server-common <span style="color:#ce5c00;font-weight:bold">=</span> 20.8.12.2-1.el7
</span></span><span style="display:flex;"><span> You could try using --skip-broken to work around the problem
</span></span><span style="display:flex;"><span> You could try running: rpm -Va --nofiles --nodigest
</span></span></code></pre></div><p>As you can see yum has an issue with resolving <code>clickhouse-server-common</code> dependency, which marked as obsoleted by newer packages.</p>
<h4 id="solution-with-old-packaging-scheme">Solution with Old Packaging Scheme</h4>
<p>add <code>--setopt=obsoletes=0</code> flag to the yum call.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">version</span><span style="color:#ce5c00;font-weight:bold">=</span>20.8.12.2-1.el7
</span></span><span style="display:flex;"><span>yum install --setopt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">obsoletes</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> clickhouse-client-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span> clickhouse-server-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>title: <span style="color:#4e9a06">&#34;installation succeeded&#34;</span>
</span></span><span style="display:flex;"><span>linkTitle: <span style="color:#4e9a06">&#34;installation succeeded&#34;</span>
</span></span><span style="display:flex;"><span>description: &gt;
</span></span><span style="display:flex;"><span>    installation succeeded
</span></span><span style="display:flex;"><span>---
</span></span></code></pre></div><p>Alternatively, you can add <code>obsoletes=0</code> into <code>/etc/yum.conf</code>.</p>
<h3 id="to-update-to-new-clickhouse-version-from-old-packaging-schema-to-new-packaging-schema">To update to new ClickHouse version (from old packaging schema to new packaging schema)</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">version</span><span style="color:#ce5c00;font-weight:bold">=</span>21.1.7.1-2
</span></span><span style="display:flex;"><span>yum install clickhouse-client-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span> clickhouse-server-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Loaded plugins: fastestmirror, ovl
</span></span><span style="display:flex;"><span>Loading mirror speeds from cached hostfile
</span></span><span style="display:flex;"><span> * base: centos.hitme.net.pl
</span></span><span style="display:flex;"><span> * extras: centos1.hti.pl
</span></span><span style="display:flex;"><span> * updates: centos1.hti.pl
</span></span><span style="display:flex;"><span>Altinity_clickhouse-altinity-stable/x86_64/signature                                                                                                                                <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">833</span> B  00:00:00
</span></span><span style="display:flex;"><span>Altinity_clickhouse-altinity-stable/x86_64/signature                                                                                                                                <span style="color:#000;font-weight:bold">|</span> 1.0 kB  00:00:01 !!!
</span></span><span style="display:flex;"><span>Altinity_clickhouse-altinity-stable-source/signature                                                                                                                                <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">833</span> B  00:00:00
</span></span><span style="display:flex;"><span>Altinity_clickhouse-altinity-stable-source/signature                                                                                                                                <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">951</span> B  00:00:00 !!!
</span></span><span style="display:flex;"><span>Nothing to <span style="color:#204a87;font-weight:bold">do</span>
</span></span></code></pre></div><p>It is caused by wrong dependencies resolution.</p>
<h4 id="solution-with-new-package-scheme">Solution with New Package Scheme</h4>
<p>To update to the latest available version - just add <code>clickhouse-server-common</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install clickhouse-client clickhouse-server clickhouse-server-common
</span></span></code></pre></div><p>This way the latest available version will be installed (even if you will request some other version explicitly).</p>
<p>To install some specific version remove old packages first, then install new ones.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum erase clickhouse-client clickhouse-server clickhouse-server-common clickhouse-common-static
</span></span><span style="display:flex;"><span><span style="color:#000">version</span><span style="color:#ce5c00;font-weight:bold">=</span>21.1.7.1
</span></span><span style="display:flex;"><span>yum install clickhouse-client-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span> clickhouse-server-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><h3 id="downgrade-from-new-version-to-old-one">Downgrade from new version to old one</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">version</span><span style="color:#ce5c00;font-weight:bold">=</span>20.8.12.2-1.el7
</span></span><span style="display:flex;"><span>yum downgrade  clickhouse-client-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span> clickhouse-server-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><p>will not work:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Loaded plugins: fastestmirror, ovl
</span></span><span style="display:flex;"><span>Loading mirror speeds from cached hostfile
</span></span><span style="display:flex;"><span> * base: ftp.agh.edu.pl
</span></span><span style="display:flex;"><span> * extras: ftp.agh.edu.pl
</span></span><span style="display:flex;"><span> * updates: centos.wielun.net
</span></span><span style="display:flex;"><span>Resolving Dependencies
</span></span><span style="display:flex;"><span>--&gt; Running transaction check
</span></span><span style="display:flex;"><span>---&gt; Package clickhouse-client.x86_64 0:20.8.12.2-1.el7 will be a downgrade
</span></span><span style="display:flex;"><span>---&gt; Package clickhouse-client.noarch 0:21.1.7.1-2 will be erased
</span></span><span style="display:flex;"><span>---&gt; Package clickhouse-server.x86_64 0:20.8.12.2-1.el7 will be a downgrade
</span></span><span style="display:flex;"><span>--&gt; Processing Dependency: clickhouse-server-common <span style="color:#ce5c00;font-weight:bold">=</span> 20.8.12.2-1.el7 <span style="color:#204a87;font-weight:bold">for</span> package: clickhouse-server-20.8.12.2-1.el7.x86_64
</span></span><span style="display:flex;"><span>Package clickhouse-server-common-20.8.12.2-1.el7.x86_64 is obsoleted by clickhouse-server-21.1.7.1-2.noarch which is already installed
</span></span><span style="display:flex;"><span>--&gt; Processing Dependency: clickhouse-common-static <span style="color:#ce5c00;font-weight:bold">=</span> 20.8.12.2-1.el7 <span style="color:#204a87;font-weight:bold">for</span> package: clickhouse-server-20.8.12.2-1.el7.x86_64
</span></span><span style="display:flex;"><span>---&gt; Package clickhouse-server.noarch 0:21.1.7.1-2 will be erased
</span></span><span style="display:flex;"><span>--&gt; Finished Dependency Resolution
</span></span><span style="display:flex;"><span>Error: Package: clickhouse-server-20.8.12.2-1.el7.x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>Altinity_clickhouse-altinity-stable<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>           Requires: clickhouse-common-static <span style="color:#ce5c00;font-weight:bold">=</span> 20.8.12.2-1.el7
</span></span><span style="display:flex;"><span>           Installed: clickhouse-common-static-21.1.7.1-2.x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>@clickhouse-stable<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>               clickhouse-common-static <span style="color:#ce5c00;font-weight:bold">=</span> 21.1.7.1-2
</span></span><span style="display:flex;"><span>           Available: clickhouse-common-static-1.1.54378-2.x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>clickhouse-stable<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>               clickhouse-common-static <span style="color:#ce5c00;font-weight:bold">=</span> 1.1.54378-2
</span></span><span style="display:flex;"><span>Error: Package: clickhouse-server-20.8.12.2-1.el7.x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>Altinity_clickhouse-altinity-stable<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>           Available: clickhouse-server-common-20.8.12.2-1.el7.x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>Altinity_clickhouse-altinity-stable<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>               clickhouse-server-common <span style="color:#ce5c00;font-weight:bold">=</span> 20.8.12.2-1.el7
</span></span><span style="display:flex;"><span> You could try using --skip-broken to work around the problem
</span></span><span style="display:flex;"><span> You could try running: rpm -Va --nofiles --nodigest
</span></span></code></pre></div><h4 id="solution-with-downgrading">Solution With Downgrading</h4>
<p>Remove packages first, then install older versions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum erase clickhouse-client clickhouse-server clickhouse-server-common clickhouse-common-static
</span></span><span style="display:flex;"><span><span style="color:#000">version</span><span style="color:#ce5c00;font-weight:bold">=</span>20.8.12.2-1.el7
</span></span><span style="display:flex;"><span>yum install --setopt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">obsoletes</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> clickhouse-client-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span> clickhouse-server-<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-51d2a664b930ed17f6ade89e393219cc">19 - AWS EBS</h1>
    <div class="lead">AWS EBS</div>
	<table>
  <thead>
    <tr>
      <th style="text-align:left"> <b>Volume type</b>
      </th>
      <th style="text-align:center">gp3</th>
      <th style="text-align:center">gp2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align:left"> <b>Max throughput per volume</b>
      </td>
      <td style="text-align:center">1000 MiB/s</td>
      <td style="text-align:center">250 MiB/s</td>
    </tr>
    <tr>
      <td style="text-align:left"><b>Price</b>
      </td>
      <td style="text-align:center">
        <p>$0.08/GB-month</p>
        <p>3,000 IOPS free and</p>
        <p>$0.005/provisioned IOPS-month over 3,000;</p>
        <p>125 MB/s free and</p>
        <p>$0.04/provisioned MB/s-month over 125</p>
      </td>
      <td style="text-align:center">$0.10/GB-month</td>
    </tr>
  </tbody>
</table>
<h3 id="gp2">GP2</h3>
<p>In usual conditions ClickHouse being limited by throughput of volumes and amount of provided IOPS doesn&rsquo;t make any big difference for performance starting from a certain number. So the most native choice for clickhouse is gp2 and gp3 volumes.</p>
<p>‌Because gp2 volumes have a hard limit of 250 MiB/s per volume (for volumes bigger than 334 GB), it usually makes sense to split one big volume in multiple smaller volumes larger than 334GB in order to have maximum possible throughput.</p>
<p>‌EC2 instances also have an EBS throughput limit, it depends on the size of the EC2 instance. That means if you would attach multiple volumes which would have high potential throughput, you would be limited by your EC2 instance, so usually there is no reason to have more than 4-5 volumes per node.</p>
<p>It&rsquo;s pretty straightforward to set up a ClickHouse for using multiple EBS volumes with storage_policies.</p>
<h3 id="gp3">GP3</h3>
<p>It&rsquo;s a new type of volume, which is 20% cheaper than gp2 per GB-month and has lower free throughput: only 125 MB/s vs 250 MB/s. But you can buy additional throughput for volume and gp3 pricing became comparable with multiple gp2 volumes starting from 1000-1500GB size. It also works better if most of your queries read only one or several parts, because in that case you are not being limited by performance of a single ebs disk, as parts can be located only on one disk at once.</p>
<p>For best performance, it&rsquo;s suggested to buy:</p>
<ul>
<li>7000 IOPS</li>
<li>Throughput up to the limit of your EC2 instance</li>
</ul>
<p><a href="https://altinity.com/blog/2019/11/27/amplifying-clickhouse-capacity-with-multi-volume-storage-part-1" target="_blank">https://altinity.com/blog/2019/11/27/amplifying-clickhouse-capacity-with-multi-volume-storage-part-1</a></p>
<p><a href="https://altinity.com/blog/2019/11/29/amplifying-clickhouse-capacity-with-multi-volume-storage-part-2" target="_blank">https://altinity.com/blog/2019/11/29/amplifying-clickhouse-capacity-with-multi-volume-storage-part-2</a></p>
<p><a href="https://calculator.aws/%5c#/createCalculator/EBS?nc2=h_ql_pr_calc" target="_blank">https://calculator.aws/#/createCalculator/EBS?nc2=h_ql_pr_calc</a></p>
<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-optimized.html" target="_blank">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-optimized.html</a></p>
<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-volume-types.html" target="_blank">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-volume-types.html</a></p>
<p><a href="https://aws.amazon.com/ebs/general-purpose/" target="_blank">https://aws.amazon.com/ebs/general-purpose/</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4789c5a0fbc6e298289a42e92e966f51">20 - ClickHouse in Docker</h1>
    <div class="lead">ClickHouse in Docker</div>
	<h2 id="do-you-have-documentation-on-docker-deployments">Do you have documentation on Docker deployments?</h2>
<p>Check</p>
<ul>
<li><a href="https://hub.docker.com/r/yandex/clickhouse-server/" target="_blank">https://hub.docker.com/r/yandex/clickhouse-server/</a></li>
<li><a href="https://docs.altinity.com/clickhouseonkubernetes/" target="_blank">https://docs.altinity.com/clickhouseonkubernetes/</a></li>
<li>sources of entry point - <a href="https://github.com/ClickHouse/ClickHouse/blob/master/docker/server/entrypoint.sh" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/master/docker/server/entrypoint.sh</a></li>
</ul>
<p>Important things:</p>
<ul>
<li>use concrete version tag (avoid using latest)</li>
<li>if possible use <code>--network=host</code> (due to performance reasons)</li>
<li>you need to mount the folder <code>/var/lib/clickhouse</code> to have persistency.</li>
<li>you MAY also mount the folder <code>/var/log/clickhouse-server</code> to have logs accessible outside of the container.</li>
<li>Also, you may mount in some files or folders in the configuration folder:
<ul>
<li><code>/etc/clickhouse-server/config.d/listen_ports.xml</code></li>
</ul>
</li>
<li><code>--ulimit nofile=262144:262144</code></li>
<li>You can also set on some linux capabilities to enable some of extra features of ClickHouse (not obligatory): <code>SYS_PTRACE NET_ADMIN IPC_LOCK SYS_NICE</code></li>
<li>you may also mount in the folder <code>/docker-entrypoint-initdb.d/</code> - all SQL or bash scripts there will be executed during container startup.</li>
<li>if you use cgroup limits - it may misbehave <a href="https://github.com/ClickHouse/ClickHouse/issues/2261" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/2261</a> (set up <code>&lt;max_server_memory_usage&gt;</code> manually)</li>
<li>there are several ENV switches, see: <a href="https://github.com/ClickHouse/ClickHouse/blob/master/docker/server/entrypoint.sh" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/master/docker/server/entrypoint.sh</a></li>
</ul>
<p>TLDR version: use it as a starting point:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --name some-clickhouse-server <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --ulimit <span style="color:#000">nofile</span><span style="color:#ce5c00;font-weight:bold">=</span>262144:262144 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --volume<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">pwd</span><span style="color:#204a87;font-weight:bold">)</span>/data:/var/lib/clickhouse <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --volume<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">pwd</span><span style="color:#204a87;font-weight:bold">)</span>/logs:/var/log/clickhouse-server <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --volume<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">pwd</span><span style="color:#204a87;font-weight:bold">)</span>/configs/memory_adjustment.xml:/etc/clickhouse-server/config.d/memory_adjustment.xml <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --cap-add<span style="color:#ce5c00;font-weight:bold">=</span>SYS_NICE <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --cap-add<span style="color:#ce5c00;font-weight:bold">=</span>NET_ADMIN <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --cap-add<span style="color:#ce5c00;font-weight:bold">=</span>IPC_LOCK <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --cap-add<span style="color:#ce5c00;font-weight:bold">=</span>SYS_PTRACE <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --network<span style="color:#ce5c00;font-weight:bold">=</span>host <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   yandex/clickhouse-server:21.1.7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker <span style="color:#204a87">exec</span> -it some-clickhouse-server clickhouse-client
</span></span><span style="display:flex;"><span>docker <span style="color:#204a87">exec</span> -it some-clickhouse-server bash
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e2ee81b31da5dc08de7cc4b0235f75fd">21 - ClickHouse Monitoring</h1>
    <div class="lead">ClickHouse Monitoring</div>
	<h2 id="clickhouse-monitoring">ClickHouse Monitoring</h2>
<p>Monitoring helps to track potential issues in your cluster before they cause a critical error.</p>
<p>What to read / watch on subject:</p>
<ul>
<li>Altinity webinar &ldquo;ClickHouse Monitoring 101: What to monitor and how&rdquo;. <a href="https://www.youtube.com/watch?v=W9KlehhgwLw" target="_blank">recording</a>, <a href="https://www.slideshare.net/Altinity/clickhouse-monitoring-101-what-to-monitor-and-how" target="_blank">slides</a></li>
<li>docs <a href="https://clickhouse.com/docs/en/operations/monitoring/" target="_blank">https://clickhouse.com/docs/en/operations/monitoring/</a></li>
</ul>
<h2 id="what-should-be-monitored">What should be monitored</h2>
<p>The following metrics should be collected / monitored</p>
<ul>
<li>
<p>For Host Machine:</p>
<ul>
<li>CPU</li>
<li>Memory</li>
<li>Network (bytes/packets)</li>
<li>Storage (iops)</li>
<li>Disk Space (free / used)</li>
</ul>
</li>
<li>
<p>For ClickHouse:</p>
<ul>
<li>Connections (count)</li>
<li>RWLocks</li>
<li>Read / Write / Return (bytes)</li>
<li>Read / Write / Return (rows)</li>
<li>Zookeeper operations (count)</li>
<li>Absolute delay</li>
<li>Query duration (optional)</li>
<li>Replication parts and queue (count)</li>
</ul>
</li>
<li>
<p>For Zookeeper:</p>
<ul>
<li><a href="../altinity-kb-zookeeper/zookeeper-monitoring/">See separate article</a></li>
</ul>
</li>
</ul>
<h2 id="monitoring-tools">Monitoring tools</h2>
<h3 id="prometheus-embedded-exporter--grafana">Prometheus (embedded exporter) + Grafana</h3>
<ul>
<li>Enable <a href="https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-prometheus" target="_blank">embedded exporter</a></li>
<li>Grafana dashboards <a href="https://grafana.com/grafana/dashboards/14192" target="_blank">https://grafana.com/grafana/dashboards/14192</a> or <a href="https://grafana.com/grafana/dashboards/13500" target="_blank">https://grafana.com/grafana/dashboards/13500</a></li>
</ul>
<h3 id="clickhouse-operator-embedded-exporter">clickhouse-operator embedded exporter</h3>
<ul>
<li>exporter is included in clickhouse-operator, and enabled automatically</li>
<li>see instructions of <a href="https://github.com/Altinity/clickhouse-operator/blob/eb3fc4e28514d0d6ea25a40698205b02949bcf9d/docs/prometheus_setup.md" target="_blank">Prometheus</a> and <a href="https://github.com/Altinity/clickhouse-operator/blob/eb3fc4e28514d0d6ea25a40698205b02949bcf9d/docs/grafana_setup.md" target="_blank">Grafana</a> installation (if you don&rsquo;t have one)</li>
<li>Grafana dashboard <a href="https://github.com/Altinity/clickhouse-operator/tree/master/grafana-dashboard" target="_blank">https://github.com/Altinity/clickhouse-operator/tree/master/grafana-dashboard</a></li>
<li>Prometheus alerts <a href="https://github.com/Altinity/clickhouse-operator/blob/master/deploy/prometheus/prometheus-alert-rules-clickhouse.yaml" target="_blank">https://github.com/Altinity/clickhouse-operator/blob/master/deploy/prometheus/prometheus-alert-rules-clickhouse.yaml</a></li>
</ul>
<h3 id="prometheus-exporter-external--grafana">Prometheus exporter (external) + Grafana</h3>
<ul>
<li><a href="https://github.com/ClickHouse/clickhouse_exporter" target="_blank">clickhouse-exporter</a></li>
<li>Dashboard: <a href="https://grafana.com/grafana/dashboards/882" target="_blank">https://grafana.com/grafana/dashboards/882</a></li>
</ul>
<p>(unmaintained)</p>
<h3 id="dashboards-quering-clickhouse-directly">Dashboards quering clickhouse directly</h3>
<ul>
<li>Overview: <a href="https://grafana.com/grafana/dashboards/13606" target="_blank">https://grafana.com/grafana/dashboards/13606</a></li>
<li>Queries dashboard (analyzing system.query_log) <a href="https://grafana.com/grafana/dashboards/2515" target="_blank">https://grafana.com/grafana/dashboards/2515</a></li>
</ul>
<h3 id="zabbix">Zabbix</h3>
<ul>
<li><a href="https://www.zabbix.com/integrations/clickhouse" target="_blank">https://www.zabbix.com/integrations/clickhouse</a></li>
<li><a href="https://github.com/Altinity/clickhouse-zabbix-template" target="_blank">https://github.com/Altinity/clickhouse-zabbix-template</a></li>
</ul>
<h3 id="graphite">Graphite</h3>
<ul>
<li>Use the embedded exporter. See <a href="https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-graphite" target="_blank">docs</a> and config.xml</li>
</ul>
<h3 id="influxdb">InfluxDB</h3>
<ul>
<li>You can use embedded exporter, plus Telegraf. For more information, see <a href="https://docs.influxdata.com/influxdb/v1.7/supported_protocols/graphite/" target="_blank">Graphite protocol support in InfluxDB</a>.</li>
</ul>
<h3 id="nagiosicinga">Nagios/Icinga</h3>
<ul>
<li><a href="https://github.com/exogroup/check_clickhouse/" target="_blank">https://github.com/exogroup/check_clickhouse/</a></li>
</ul>
<h3 id="commercial-solution">Commercial solution</h3>
<ul>
<li>Datadog <a href="https://docs.datadoghq.com/integrations/clickhouse/?tab=host" target="_blank">https://docs.datadoghq.com/integrations/clickhouse/?tab=host</a></li>
<li>Sematext <a href="https://sematext.com/docs/integration/clickhouse/" target="_blank">https://sematext.com/docs/integration/clickhouse/</a></li>
<li>Instana <a href="https://www.instana.com/supported-technologies/clickhouse-monitoring/" target="_blank">https://www.instana.com/supported-technologies/clickhouse-monitoring/</a></li>
<li>site24x7 <a href="https://www.site24x7.com/plugins/clickhouse-monitoring.html" target="_blank">https://www.site24x7.com/plugins/clickhouse-monitoring.html</a></li>
<li>Acceldata Pulse <a href="https://www.acceldata.io/blog/acceldata-pulse-for-clickhouse-monitoring" target="_blank">https://www.acceldata.io/blog/acceldata-pulse-for-clickhouse-monitoring</a></li>
</ul>
<h3 id="build-your-own-monitoring">&ldquo;Build your own&rdquo; monitoring</h3>
<p>ClickHouse allow to access lot of internals using system tables. The main tables to access monitoring data are:</p>
<ul>
<li>system.metrics</li>
<li>system.asynchronous_metrics</li>
<li>system.events</li>
</ul>
<p>Minimum neccessary set of checks</p>
<table>
  <tr>
   <td><strong>Check Name</strong>
   </td>
   <td><strong><code>Shell or SQL command</code></strong>
   </td>
   <td><strong><code>Severity</code></strong>
   </td>
  </tr>
  <tr>
   <td>ClickHouse status
   </td>
   <td><code>$ curl 'http://localhost:8123/'</code>
<p>
<code>Ok.</code>
   </td>
   <td><code>Critical</code>
   </td>
  </tr>
  <tr>
   <td>Too many simultaneous queries. Maximum: 100 (by default)
   </td>
   <td><code>select value from system.metrics </code>
<p>
<code>where metric='Query'</code>
   </td>
   <td><code>Critical</code>
   </td>
  </tr>
  <tr>
   <td>Replication status
   </td>
   <td><code>$ curl 'http://localhost:8123/replicas_status'</code>
<p>
<code>Ok.</code>
   </td>
   <td><code>High</code>
   </td>
  </tr>
  <tr>
   <td>Read only replicas (reflected by <code>replicas_status</code> as well)
   </td>
   <td><code>select value from system.metrics </code>
<p>
<code>where metric='ReadonlyReplica'</code>
   </td>
   <td><code>High</code>
   </td>
  </tr>
  <tr>
   <td>Some replication tasks are stuck
   </td>
   <td><code>select count()</code>
<p>
<code>from system.replication_queue</code>
<p>
<code>where num_tries > 100 or num_postponed > 1000</code>
   </td>
   <td><code>High</code>
   </td>
  </tr>
  <tr>
   <td>ZooKeeper is available
   </td>
   <td><code>select count() from system.zookeeper </code>
<p>
<code>where path='/'</code>
   </td>
   <td><code>Critical for writes</code>
   </td>
  </tr>
  <tr>
   <td>ZooKeeper exceptions
   </td>
   <td><code>select value from system.events </code>
<p>
<code>where event='ZooKeeperHardwareExceptions'</code>
   </td>
   <td><code>Medium</code>
   </td>
  </tr>
  <tr>
   <td>Other CH nodes are available
   </td>
   <td><code>$ for node in `echo "select distinct host_address from system.clusters where host_name !='localhost'" | curl 'http://localhost:8123/' --silent --data-binary @-`; do curl "http://$node:8123/" --silent ; done | sort -u</code>
<p>
<code>Ok.</code>
   </td>
   <td><code>High</code>
   </td>
  </tr>
  <tr>
   <td>All CH clusters are available (i.e. every configured cluster has enough replicas to serve queries)
   </td>
   <td><code>for cluster in `echo "select distinct cluster from system.clusters where host_name !='localhost'" | curl 'http://localhost:8123/' --silent --data-binary @-` ; do clickhouse-client --query="select '$cluster', 'OK' from cluster('$cluster', system, one)" ; done </code>
   </td>
   <td><code>Critical</code>
   </td>
  </tr>
  <tr>
   <td>There are files in 'detached' folders
   </td>
   <td><code>$ find /var/lib/clickhouse/data/*/*/detached/* -type d | wc -l; \
19.8+</code>
<p>
<code>select count() from system.detached_parts</code>
   </td>
   <td><code>Medium</code>
   </td>
  </tr>
  <tr>
   <td>Too many parts: \
Number of parts is growing; \
Inserts are being delayed; \
Inserts are being rejected
   </td>
   <td><code>select value from system.asynchronous_metrics </code>
<p>
<code>where metric='MaxPartCountForPartition';</code>
<p>
<code>select value from system.events/system.metrics </code>
<p>
<code>where event/metric='DelayedInserts'; \
select value from system.events </code>
<p>
<code>where event='RejectedInserts'</code>
   </td>
   <td><code>Critical</code>
   </td>
  </tr>
  <tr>
   <td>Dictionaries: exception
   </td>
   <td><code>select concat(name,': ',last_exception) </code>
<p>
<code>from system.dictionaries</code>
<p>
<code>where last_exception != ''</code>
   </td>
   <td><code>Medium</code>
   </td>
  </tr>
  <tr>
   <td>ClickHouse has been restarted
   </td>
   <td><code>select uptime();</code>
<p>
<code>select value from system.asynchronous_metrics </code>
<p>
<code>where metric='Uptime'</code>
   </td>
   <td>
   </td>
  </tr>
  <tr>
   <td>DistributedFilesToInsert should not be always increasing
   </td>
   <td><code>select value from system.metrics </code>
<p>
<code>where metric='DistributedFilesToInsert'</code>
   </td>
   <td><code>Medium</code>
   </td>
  </tr>
  <tr>
   <td>A data part was lost
   </td>
   <td><code>select value from system.events </code>
<p>
<code>where event='ReplicatedDataLoss'</code>
   </td>
   <td><code>High</code>
   </td>
  </tr>
  <tr>
   <td>Data parts are not the same on different replicas
   </td>
   <td><code>select value from system.events where event='DataAfterMergeDiffersFromReplica'; \
select value from system.events where event='DataAfterMutationDiffersFromReplica'</code>
   </td>
   <td><code>Medium</code>
   </td>
  </tr>
  <tr>
   <td>
   </td>
   <td>
   </td>
   <td>
   </td>
  </tr>
</table>
<p>The following queries are recommended to be included in monitoring:</p>
<ul>
<li><code>SELECT * FROM system.replicas</code>
<ul>
<li>For more information, see the ClickHouse guide on <a href="https://clickhouse.tech/docs/en/operations/system_tables/#system_tables-replicas" target="_blank">System Tables</a></li>
</ul>
</li>
<li><code>SELECT * FROM system.merges</code>
<ul>
<li>Checks on the speed and progress of currently executed merges.</li>
</ul>
</li>
<li><code>SELECT * FROM system.mutations</code>
<ul>
<li>This is the source of information on the speed and progress of currently executed merges.</li>
</ul>
</li>
</ul>
<h2 id="logs-monitoring">Logs monitoring</h2>
<p>ClickHouse logs can be another important source of information. There are 2 logs enabled by default</p>
<ul>
<li>/var/log/clickhouse-server/clickhouse-server.err.log (error &amp; warning, you may want to keep an eye on that or send it to some monitoring system)</li>
<li>/var/log/clickhouse-server/clickhouse-server.log (trace logs,  very detailed, useful for debugging, usually too verbose to monitor).</li>
</ul>
<p>You can additionally enable system.text_log table to have an access to the logs from clickhouse sql queries (ensure that you will not expose some information to the users which should not see it).</p>
<h2 id="opentelemetry-support">OpenTelemetry support</h2>
<p>See <a href="https://clickhouse.com/docs/en/operations/opentelemetry/" target="_blank">https://clickhouse.com/docs/en/operations/opentelemetry/</a></p>
<h2 id="other-sources">Other sources</h2>
<ul>
<li><a href="https://tech.marksblogg.com/clickhouse-prometheus-grafana.html" target="_blank">https://tech.marksblogg.com/clickhouse-prometheus-grafana.html</a></li>
<li><a href="https://sematext.com/blog/clickhouse-monitoring-key-metrics/" target="_blank">Key Metrics for Monitoring ClickHouse</a></li>
<li><a href="https://dzone.com/articles/clickhouse-monitoring-key-metrics-to-monitor-semat" target="_blank">ClickHouse Monitoring Key Metrics to Monitor</a></li>
<li><a href="https://dzone.com/articles/clickhouse-monitoring-tools-five-tools-to-consider" target="_blank">ClickHouse Monitoring Tools: Five Tools to Consider</a></li>
<li><a href="https://docs.instana.io/ecosystem/clickhouse/" target="_blank">Monitoring ClickHouse</a></li>
<li><a href="https://www.datadoghq.com/blog/monitor-clickhouse/" target="_blank">Monitor ClickHouse with Datadog</a></li>
<li><a href="https://docs.google.com/spreadsheets/d/1K92yZr5slVQEvDglfZ88k_7bfsAKqahY9RPp_2tSdVU/edit#gid=521173956" target="_blank">Unsorted notes on monitor and Alerts</a></li>
<li><a href="https://intl.cloud.tencent.com/document/product/1026/36887" target="_blank">https://intl.cloud.tencent.com/document/product/1026/36887</a></li>
<li><a href="https://chowdera.com/2021/03/20210301161806704Y.html" target="_blank">https://chowdera.com/2021/03/20210301161806704Y.html</a></li>
<li><a href="https://chowdera.com/2021/03/20210301160252465m.html#" target="_blank">https://chowdera.com/2021/03/20210301160252465m.html#</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-199cb1e25e9c6fa0e0312726a5acd246">22 - ClickHouse versions</h1>
    <div class="lead">ClickHouse versions</div>
	<h2 id="clickhouse-versioning-schema">ClickHouse versioning schema</h2>
<p><img src="/assets/illyustraciya_bez_nazvaniya.png" alt="ClickHouse Version Breakdown"></p>
<p>Example:</p>
<p>21.3.10.1-lts</p>
<ol>
<li>21 is the year of release.</li>
<li>3 indicates a Feature Release. This is an increment where features are delivered.</li>
<li>10 is the bugfix / maintenance version. When that version is incremented it means that some bugs was fixed comparing to 21.3.9.</li>
<li>1 - build number, means nothing for end users.</li>
<li>lts - type of release. (long time support).</li>
</ol>
<h3 id="what-is-altinity-stable-version">What is Altinity Stable version?</h3>
<p>It is one of general / public version of ClickHouse which has passed some extra testings, the upgrade path and changelog was analyzed, known issues are documented, and at least few big companies use it on production. All those things take some time, so usually that means that Altinity Stable is always a  &lsquo;behind&rsquo; the main releases.</p>
<p>Altinity version - is an option for conservative users, who prefer bit older but better known things.</p>
<p>Usually there is no reason to use version older than Altinity Stable. If you see that new Altinity Version arrived and you still use some older version - you should for sure consider an upgrade.</p>
<p>Additionally for Altinity client we provide extra support for those version for a longer time (and we also support newer versions).</p>
<h3 id="which-version-should-i-use">Which version should I use?</h3>
<p>We recommend the following approach:</p>
<ol>
<li>When you start using ClickHouse and before you go on production - pick the latest stable version.</li>
<li>If you already have ClickHouse running on production:
<ol>
<li>Check all the new queries / schemas on the staging first, especially if some new ClickHouse features are used.</li>
<li>Do minor (bugfix) upgrades regularly: monitor new maintenance releases of the feature release you use.</li>
<li>When considering upgrade - check <a href="https://docs.altinity.com/altinitystablerelease/" target="_blank">Altinity Stable release docs</a>, if you want to use newer release -  analyze changelog and known issues.</li>
<li>Check latest stable or test versions of ClickHouse on your staging environment regularly and pass the feedback to us or on the <a href="https://github.com/ClickHouse/ClickHouse" target="_blank">official ClickHouse github</a>.</li>
<li>Consider blue/green or canary upgrades.</li>
</ol>
</li>
</ol>
<p>See also: <a href="https://clickhouse.tech/docs/en/faq/operations/production/" target="_blank">https://clickhouse.tech/docs/en/faq/operations/production/</a></p>
<h2 id="how-do-i-upgrade">How do I upgrade?</h2>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    Check upgrade / downgrade scenario on staging first.

</div>

<ol>
<li>check if you need to adjust some settings / to opt-out some new features you don&rsquo;t need (maybe needed to to make the downgrade path possible, or to make it possible for 2 versions to work together).</li>
<li><a href="https://docs.altinity.com/altinitystablerelease/stablequickstartguide/" target="_blank">upgrade packages</a> on odd replicas</li>
<li>(if needed / depends on use case) stop ingestion into odd replicas / remove them for load-balancer etc.</li>
<li>restart clickhouse-server service on odd replicas.</li>
<li>once odd replicas will go back online - repeat the same procedure on the even replicas.</li>
</ol>
<p>In some upgrade scenarios (depending from which version to which you do upgrate) when differerent replicas use different clickhouse versions you may see following issues:</p>
<ol>
<li>the replication don&rsquo;t work at all and delays grow.</li>
<li>errors about &lsquo;checksum mismatch&rsquo;  and traffic between replicase increase (they need to resync merge results).</li>
</ol>
<p>Both problems will go away once all replicas will be upgraded.</p>
<h2 id="bugs">Bugs?</h2>
<p>ClickHouse development process goes in a very high pace and has already thousands of features. CI system doing tens of thousands of tests (including tests with different sanitizers) against every commit.</p>
<p>All core features are well-tested, and very stable, and code is high-quality. But as with any other software bad things may happen. Usually the most of bugs happens in the new, freshly added functionality, and in some complex combination of several features (of course all possible combinations of features just physically can’t be tested). Usually new features are adopted by the community and stabilize quickly.</p>
<h3 id="what-should-i-do-if-i-found-a-bug-in-clickhouse">What should I do if I found a bug in clickhouse?</h3>
<ol>
<li>First of all: try to upgrade to the latest bugfix release  Example: if you use v21.3.5.42-lts but you know that v21.3.10.1-lts already exists - start with upgrade to that. Upgrades to latest maintenance releases are smooth and safe.</li>
<li>Look for similar issues in github. Maybe the fix is on the way.</li>
<li>If you can reproduce the bug: try to isolate it - remove some pieces of query one-by-one / simplify the scenario until the issue still reproduces. This way you can figure out which part is responsible for that bug, and you can try to create <a href="https://stackoverflow.com/help/minimal-reproducible-example" target="_blank">minimal reproducible example</a></li>
<li>Once you have minimal reproducible example:
<ol>
<li>report it to github (or to Altinity Support)</li>
<li>check if it reproduces on newer clickhouse versions</li>
</ol>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-482a9e1e23251a246ec9901728b5dda1">23 - clickhouse-backup</h1>
    <div class="lead">clickhouse-backup + backblaze</div>
	<h3 id="installation-and-configuration">Installation and configuration</h3>
<p>Download the latest <code>clickhouse-backup.tar.gz</code> from assets from <a href="https://github.com/AlexAkulov/clickhouse-backup/releases" target="_blank">https://github.com/AlexAkulov/clickhouse-backup/releases</a></p>
<p>This tar.gz contains a single binary of <code>clickhouse-backup</code> and an example of config file.</p>
<p>Backblaze has s3 compatible API but requires empty acl parameter <code>acl: &quot;&quot;</code>.</p>
<p><a href="https://www.backblaze.com/" target="_blank">https://www.backblaze.com/</a> has 15 days and free 10Gb S3 trial.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">$ mkdir clickhouse-backup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">$ cd clickhouse-backup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">$ wget https://github.com/AlexAkulov/clickhouse-backup/releases/download/1.0.0-beta2/clickhouse-backup.tar.gz</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">$ tar zxf clickhouse-backup.tar.gz</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">$ rm clickhouse-backup.tar.gz</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">$ cat config.yml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">general</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">remote_storage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">max_file_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1099511627776</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disable_progress_bar</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">backups_to_keep_local</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">backups_to_keep_remote</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">log_level</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">info</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">allow_empty_backups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">clickhouse</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disk_mapping</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">skip_tables</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">system.*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">5m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">freeze_by_part</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">secure</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">skip_verify</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">sync_replicated_tables</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">log_sql_queries</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">s3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">access_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#8f5902;font-style:italic">****1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">secret_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">K****1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bucket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;mybucket&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3.us-west-000.backblazeb2.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-west-000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">acl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">force_path_style</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clickhouse-backup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disable_ssl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">part_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">536870912</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">compression_level</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">compression_format</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">sse</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disable_cert_verification</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">storage_class</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">STANDARD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>I have a database <code>test</code> with table <code>test</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">400000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>clickhouse-backup list should work without errors (it scans local and remote (s3) folders):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo ./clickhouse-backup list -c config.yml
</span></span><span style="display:flex;"><span>$
</span></span></code></pre></div><h3 id="backup">Backup</h3>
<ul>
<li>create a local backup of database test</li>
<li>upload this backup to remote</li>
<li>remove the local backup</li>
<li>drop the source database</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo ./clickhouse-backup create --tables<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;test.*&#39;</span> bkp01 -c config.yml
</span></span><span style="display:flex;"><span>2021/05/31 23:11:13  info <span style="color:#204a87;font-weight:bold">done</span>   <span style="color:#000">backup</span><span style="color:#ce5c00;font-weight:bold">=</span>bkp01 <span style="color:#000">operation</span><span style="color:#ce5c00;font-weight:bold">=</span>create <span style="color:#000">table</span><span style="color:#ce5c00;font-weight:bold">=</span>test.test
</span></span><span style="display:flex;"><span>2021/05/31 23:11:13  info <span style="color:#204a87;font-weight:bold">done</span>   <span style="color:#000">backup</span><span style="color:#ce5c00;font-weight:bold">=</span>bkp01 <span style="color:#000">operation</span><span style="color:#ce5c00;font-weight:bold">=</span>create
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo ./clickhouse-backup upload bkp01 -c config.yml
</span></span><span style="display:flex;"><span> 1.44 MiB / 1.44 MiB <span style="color:#ce5c00;font-weight:bold">[=====================]</span> 100.00% 2s
</span></span><span style="display:flex;"><span>2021/05/31 23:12:13  info <span style="color:#204a87;font-weight:bold">done</span>   <span style="color:#000">backup</span><span style="color:#ce5c00;font-weight:bold">=</span>bkp01 <span style="color:#000">operation</span><span style="color:#ce5c00;font-weight:bold">=</span>upload <span style="color:#000">table</span><span style="color:#ce5c00;font-weight:bold">=</span>test.test
</span></span><span style="display:flex;"><span>2021/05/31 23:12:17  info <span style="color:#204a87;font-weight:bold">done</span>   <span style="color:#000">backup</span><span style="color:#ce5c00;font-weight:bold">=</span>bkp01 <span style="color:#000">operation</span><span style="color:#ce5c00;font-weight:bold">=</span>upload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo ./clickhouse-backup list -c config.yml
</span></span><span style="display:flex;"><span>bkp01   1.44MiB   31/05/2021 23:11:13   <span style="color:#204a87">local</span>
</span></span><span style="display:flex;"><span>bkp01   1.44MiB   31/05/2021 23:11:13   remote      tar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo ./clickhouse-backup delete <span style="color:#204a87">local</span> bkp01 -c config.yml
</span></span><span style="display:flex;"><span>2021/05/31 23:13:29  info delete <span style="color:#4e9a06">&#39;bkp01&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DATABASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="restore">Restore</h3>
<ul>
<li>download the remote backup</li>
<li>restore database</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo ./clickhouse-backup list -c config.yml
</span></span><span style="display:flex;"><span>bkp01   1.44MiB   31/05/2021 23:11:13   remote      tar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo ./clickhouse-backup download bkp01 -c config.yml
</span></span><span style="display:flex;"><span>2021/05/31 23:14:41  info <span style="color:#204a87;font-weight:bold">done</span>    <span style="color:#000">backup</span><span style="color:#ce5c00;font-weight:bold">=</span>bkp01 <span style="color:#000">operation</span><span style="color:#ce5c00;font-weight:bold">=</span>download <span style="color:#000">table</span><span style="color:#ce5c00;font-weight:bold">=</span>test.test
</span></span><span style="display:flex;"><span> 1.47 MiB / 1.47 MiB <span style="color:#ce5c00;font-weight:bold">[=====================]</span> 100.00% 0s
</span></span><span style="display:flex;"><span>2021/05/31 23:14:43  info <span style="color:#204a87;font-weight:bold">done</span>    <span style="color:#000">backup</span><span style="color:#ce5c00;font-weight:bold">=</span>bkp01 <span style="color:#000">operation</span><span style="color:#ce5c00;font-weight:bold">=</span>download <span style="color:#000">table</span><span style="color:#ce5c00;font-weight:bold">=</span>test.test
</span></span><span style="display:flex;"><span>2021/05/31 23:14:43  info <span style="color:#204a87;font-weight:bold">done</span>    <span style="color:#000">backup</span><span style="color:#ce5c00;font-weight:bold">=</span>bkp01 <span style="color:#000">operation</span><span style="color:#ce5c00;font-weight:bold">=</span>download
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo ./clickhouse-backup restore bkp01 -c config.yml
</span></span><span style="display:flex;"><span>2021/05/31 23:16:04  info <span style="color:#204a87;font-weight:bold">done</span>    <span style="color:#000">backup</span><span style="color:#ce5c00;font-weight:bold">=</span>bkp01 <span style="color:#000">operation</span><span style="color:#ce5c00;font-weight:bold">=</span>restore <span style="color:#000">table</span><span style="color:#ce5c00;font-weight:bold">=</span>test.test
</span></span><span style="display:flex;"><span>2021/05/31 23:16:04  info <span style="color:#204a87;font-weight:bold">done</span>    <span style="color:#000">backup</span><span style="color:#ce5c00;font-weight:bold">=</span>bkp01 <span style="color:#000">operation</span><span style="color:#ce5c00;font-weight:bold">=</span>restore
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">400000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="delete-backups">Delete backups</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo ./clickhouse-backup delete <span style="color:#204a87">local</span> bkp01 -c config.yml
</span></span><span style="display:flex;"><span>2021/05/31 23:17:05  info delete <span style="color:#4e9a06">&#39;bkp01&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo ./clickhouse-backup delete remote bkp01 -c config.yml
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0bbf5bd9eca8f96d4529ea56056d69c4">24 - Converting MergeTree to Replicated</h1>
    <div class="lead">Converting MergeTree to Replicated</div>
	<p>Options here are:</p>
<ol>
<li>Use<code>INSERT INTO foo_replicated SELECT * FROM foo</code> .</li>
<li>Create table aside and attach all partition from the existing table then drop original table (uses hard links don&rsquo;t require extra disk space). <code>ALTER TABLE foo_replicated ATTACH PARTITION ID 'bar' FROM 'foo'</code> You can easily auto generate those commands using a query like: <code>SELECT DISTINCT 'ALTER TABLE foo_replicated ATTACH PARTITION ID \'' || partition_id || '\' FROM foo;' from system.parts WHERE table = 'foo';</code></li>
<li>Do it &lsquo;in place&rsquo; using some file manipulation. see the procedure described here: <a href="https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/replication/#converting-from-mergetree-to-replicatedmergetree" target="_blank">https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/replication/#converting-from-mergetree-to-replicatedmergetree</a></li>
<li>Do a backup of MergeTree and recover as ReplicatedMergeTree. <a href="https://github.com/AlexAkulov/clickhouse-backup/blob/master/Examples.md#how-to-convert-mergetree-to-replicatedmegretree" target="_blank">https://github.com/AlexAkulov/clickhouse-backup/blob/master/Examples.md#how-to-convert-mergetree-to-replicatedmegretree</a></li>
<li>Embedded command for that should be added in future.</li>
</ol>
<h2 id="example-for-option-2">example for option 2</h2>
<p>Note: ATTACH PARTITION ID &lsquo;bar&rsquo; FROM &lsquo;foo&rsquo;` is practically free from compute and disk space perpespective. This feature utilizes filesysem hard-links and the fact that files are immutable in Clickhouse ( it&rsquo;s the core of the Clickhouse design, filesysem hard-links and such file manipulations are widely used ).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">D</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">S</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MergeTree</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">partition</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toYYYYMM</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">D</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">today</span><span style="color:#000;font-weight:bold">(),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">e8</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">today</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">e8</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌───</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200000000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└───────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo_replicated</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{database}/{table}/{shard}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">partition</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toYYYYMM</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">D</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">STOP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MERGES</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;ALTER TABLE foo_replicated ATTACH PARTITION ID \&#39;&#39; || partition_id || &#39;</span><span style="color:#a40000">\</span><span style="color:#4e9a06">&#39; FROM foo;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;foo&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">concat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;ALTER TABLE foo_replicated ATTACH PARTITION ID \&#39;&#39;, partition_id, &#39;</span><span style="color:#a40000">\</span><span style="color:#4e9a06">&#39; FROM foo;&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo_replicated</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;202111&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo_replicated</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;202201&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└───────────────────────────────────────────────────────────────────────────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">clickhouse</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">client</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">q</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;SELECT DISTINCT &#39;ALTER TABLE foo_replicated ATTACH PARTITION ID \&#39;&#39; || partition_id || &#39;\&#39; FROM foo;&#39; from system.parts WHERE table = &#39;foo&#39; format TabSeparatedRaw&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">clickhouse</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">client</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mn</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">START</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MERGES</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo_replicated</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌───</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200000000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└───────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo_old</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo_replicated</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- you can drop foo_old any time later, it&#39;s kinda a cheap backup, 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- it cost nothing until you insert a lot of additional data into foo_replicated
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-156c434f74af4cc1f5844eb80c8a1d57">25 - Data Migration</h1>
    <div class="lead">Data Migration</div>
	<h2 id="export--import-into-common-data-formats">Export &amp; Import into common data formats</h2>
<p>Pros:</p>
<ul>
<li>Data can be inserted into any DBMS.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Decoding &amp; encoding of common data formats may be slower / require more CPU</li>
<li>The data size is usually bigger than ClickHouse formats.</li>
<li>Some of the common data formats have limitations.</li>
</ul>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    <p>The best approach to do that is using clickhouse-client, in that case, encoding/decoding of format happens client-side, while client and server speak clickhouse Native format (columnar &amp; compressed).</p>
<p>In contrast: when you use HTTP protocol, the server do encoding/decoding and more data is passed between client and server.</p>


</div>

<h2 id="remoteremotesecure-or-clusterdistributed-table">remote/remoteSecure or cluster/Distributed table</h2>
<p>Pros:</p>
<ul>
<li>Simple to run.</li>
<li>It’s possible to change the schema and distribution of data between shards.</li>
<li>It’s possible to copy only some subset of data.</li>
<li>Needs only access to ClickHouse TCP port.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Uses CPU / RAM (mostly on the receiver side)</li>
</ul>
<p>See details in:</p>
<p><a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/remote-table-function/">remote-table-function.md</a></p>
<h2 id="clickhouse-copier">clickhouse-copier</h2>
<p>Pros:</p>
<ul>
<li>Possible to do <strong>some</strong> changes in schema.</li>
<li>Needs only access to ClickHouse TCP port.</li>
<li>It’s possible to change the distribution of data between shards.</li>
<li>Suitable for large clusters: many clickhouse-copier can execute the same task together.</li>
</ul>
<p>Cons:</p>
<ul>
<li>May create an inconsistent result if source cluster data is changing during the process.</li>
<li>Hard to setup.</li>
<li>Requires zookeeper.</li>
<li>Uses CPU / RAM (mostly on the clickhouse-copier and receiver side)</li>
</ul>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    Internally it works like smart <code>INSERT INTO cluster(…) SELECT * FROM ...</code> with some consistency checks.

</div>



<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    Run clickhouse copier on the same nodes as receiver clickhouse, to avoid doubling the network load.

</div>

<p>See details in:</p>
<p><a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/altinity-kb-clickhouse-copier/">altinity-kb-clickhouse-copier</a></p>
<h2 id="manual-parts-moving-freeze--rsync--attach">Manual parts moving: freeze / rsync / attach</h2>
<p>Pros:</p>
<ul>
<li>Low CPU / RAM usage.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Table schema should be the same.</li>
<li>A lot of manual operations/scripting.</li>
</ul>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    With some additional care and scripting, it’s possible to do cheap re-sharding on parts level.

</div>

<p>See details in:</p>
<p><a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/rsync/">rsync.md</a></p>
<h2 id="clickhouse-backup">clickhouse-backup</h2>
<p>Pros:</p>
<ul>
<li>Low CPU / RAM usage.</li>
<li>Suitable to recover both schema &amp; data for all tables at once.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Table schema should be the same.</li>
</ul>
<p>Just create the backup on server 1, upload it to server 2, and restore the backup.</p>
<p>See <a href="https://github.com/AlexAkulov/clickhouse-backup" target="_blank">https://github.com/AlexAkulov/clickhouse-backup</a></p>
<p><a href="%22https://altinity.com/blog/introduction-to-clickhouse-backups-and-clickhouse-backup%22">https://altinity.com/blog/introduction-to-clickhouse-backups-and-clickhouse-backup</a></p>
<h2 id="fetch-from-zookeeper-path">Fetch from zookeeper path</h2>
<p>Pros:</p>
<ul>
<li>Low CPU / RAM usage.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Table schema should be the same.</li>
<li>Works only when the source and the destination clickhouse servers share the same zookeeper (without chroot)</li>
<li>Needs to access zookeeper and ClickHouse replication ports: (<code>interserver_http_port</code> or <code>interserver_https_port</code>)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FETCH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">partition_expr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;path-in-zookeeper&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="replication-protocol">Replication protocol</h2>
<p>Just make one more replica in another place.</p>
<p>Pros:</p>
<ul>
<li>Simple to setup</li>
<li>Data is consistent all the time automatically.</li>
<li>Low CPU and network usage.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Needs to reach both zookeeper client (2181) and ClickHouse replication ports: (<code>interserver_http_port</code> or <code>interserver_https_port</code>)</li>
<li>In case of cluster migration, zookeeper need’s to be migrated too.</li>
<li>Replication works both ways.</li>
</ul>
<p><a href="../altinity-kb-zookeeper/altinity-kb-zookeeper-cluster-migration.md">../altinity-kb-zookeeper/altinity-kb-zookeeper-cluster-migration.md</a></p>
<h2 id="see-also">See also</h2>
<h3 id="github-issues">Github issues</h3>
<p><a href="https://github.com/ClickHouse/ClickHouse/issues/10943" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/10943</a>
<a href="https://github.com/ClickHouse/ClickHouse/issues/20219" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/20219</a>
<a href="https://github.com/ClickHouse/ClickHouse/pull/17871" target="_blank">https://github.com/ClickHouse/ClickHouse/pull/17871</a></p>
<h3 id="other-links">Other links</h3>
<p><a href="https://habr.com/ru/company/avito/blog/500678/" target="_blank">https://habr.com/ru/company/avito/blog/500678/</a></p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-49f38a883c7ec4fc908726a6854c7bbe">25.1 - clickhouse-copier</h1>
    <div class="lead">clickhouse-copier</div>
	<p>The description of the utility and its parameters, as well as examples of the config files that you need to create for the copier are in the doc <a href="https://clickhouse.tech/docs/en/operations/utilities/clickhouse-copier/" target="_blank">https://clickhouse.tech/docs/en/operations/utilities/clickhouse-copier/</a></p>
<p>The steps to run a task:</p>
<ol>
<li>
<p>Create a config file for clickhouse-copier (zookeeper.xml)</p>
<p><a href="https://clickhouse.tech/docs/en/operations/utilities/clickhouse-copier/#format-of-zookeeper-xml" target="_blank">https://clickhouse.tech/docs/en/operations/utilities/clickhouse-copier/#format-of-zookeeper-xml</a></p>
</li>
<li>
<p>Create a config file for the task (task1.xml)</p>
<p><a href="https://clickhouse.tech/docs/en/operations/utilities/clickhouse-copier/#configuration-of-copying-tasks" target="_blank">https://clickhouse.tech/docs/en/operations/utilities/clickhouse-copier/#configuration-of-copying-tasks</a></p>
</li>
<li>
<p>Create the task in ZooKeeper and start an instance of clickhouse-copier<code>clickhouse-copier --daemon --base-dir=/opt/clickhouse-copier --config /opt/clickhouse-copier/zookeeper.xml --task-path /clickhouse/copier/task1 --task-file /opt/clickhouse-copier/task1.xml</code></p>
</li>
</ol>
<p>If the node in ZooKeeper already exists and you want to change it, you need to add the <code>task-upload-force</code> parameter:</p>
<p><code>clickhouse-copier --daemon --base-dir=/opt/clickhouse-copier --config /opt/clickhouse-copier/zookeeper.xml --task-path /clickhouse/copier/task1 --task-file /opt/clickhouse-copier/task1.xml --task-upload-force 1</code></p>
<p>If you want to run another instance of clickhouse-copier for the same task, you need to copy the config file (zookeeper.xml) to another server, and run this command:</p>
<p><code>clickhouse-copier --daemon --base-dir=/opt/clickhouse-copier --config /opt/clickhouse-copier/zookeeper.xml --task-path /clickhouse/copier/task1</code></p>
<p>The number of simultaneously running instances is controlled be the <code>max_workers</code> parameter in your task configuration file. If you run more workers superfluous workers will sleep and log messages like this:</p>
<p><code>&lt;Debug&gt; ClusterCopier: Too many workers (1, maximum 1). Postpone processing</code></p>
<h3 id="see-also">See also</h3>
<ul>
<li><a href="https://clickhouse.tech/docs/en/operations/utilities/clickhouse-copier/" target="_blank">https://clickhouse.tech/docs/en/operations/utilities/clickhouse-copier/</a></li>
<li>Никита Михайлов. Кластер ClickHouse ctrl-с ctrl-v. HighLoad++ Весна 2021 <a href="https://raw.githubusercontent.com/ClickHouse/clickhouse-presentations/master/highload2021/copier.pdf" target="_blank">slides</a></li>
<li>21.7 have a huge bulk of fixes / improvements. <a href="https://github.com/ClickHouse/ClickHouse/pull/23518" target="_blank">https://github.com/ClickHouse/ClickHouse/pull/23518</a></li>
<li><a href="https://altinity.com/blog/2018/8/22/clickhouse-copier-in-practice" target="_blank">https://altinity.com/blog/2018/8/22/clickhouse-copier-in-practice</a></li>
<li><a href="http://www.clickhouse.com.cn/topic/601fb322b06e5e0f21ba79e1" target="_blank">http://www.clickhouse.com.cn/topic/601fb322b06e5e0f21ba79e1</a></li>
<li><a href="https://github.com/getsentry/snuba/blob/master/docs/clickhouse-copier.md" target="_blank">https://github.com/getsentry/snuba/blob/master/docs/clickhouse-copier.md</a></li>
<li><a href="https://hughsite.com/post/clickhouse-copier-usage.html" target="_blank">https://hughsite.com/post/clickhouse-copier-usage.html</a></li>
<li><a href="https://www.jianshu.com/p/c058edd664a6" target="_blank">https://www.jianshu.com/p/c058edd664a6</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e1f1d825521583c133a8d3bf2a72f6e7">25.1.1 - clickhouse-copier 20.3 and earlier</h1>
    <div class="lead">clickhouse-copier 20.3 and earlier</div>
	<p>Clickhouse-copier was created to move data between clusters.
It runs simple INSERT…SELECT queries and can copy data between tables with different engine parameters and between clusters with different number of shards.
In the task configuration file you need to describe the layout of the source and the target cluster, and list the tables that you need to copy. You can copy whole tables or specific partitions.
Clickhouse-copier uses temporary distributed tables to select from the source cluster and insert into the target cluster.</p>
<h2 id="the-process-is-as-follows">The process is as follows</h2>
<ol>
<li>Process the configuration files.</li>
<li>Discover the list of partitions if not provided in the config.</li>
<li>Copy partitions one by one.
<ol>
<li>Drop the partition from the target table if it’s not empty</li>
<li>Copy data from source shards one by one.
<ol>
<li>Check if there is data for the partition on a source shard.</li>
<li>Check the status of the task in ZooKeeper.</li>
<li>Create target tables on all shards of the target cluster.</li>
<li>Insert the partition of data into the target table.</li>
</ol>
</li>
<li>Mark the partition as completed in ZooKeeper.</li>
</ol>
</li>
</ol>
<p>If there are several workers running simultaneously, they will assign themselves to different source shards.
If a worker was interrupted, another worker can be started to continue the task. The next worker will drop incomplete partitions and resume the copying.</p>
<h2 id="configuring-the-engine-of-the-target-table">Configuring the engine of the target table</h2>
<p>Clickhouse-copier uses the engine from the task configuration file for these purposes:</p>
<ul>
<li>to create target tables if they don’t exist.</li>
<li>PARTITION BY: to SELECT a partition of data from the source table, to DROP existing partitions from target tables.</li>
</ul>
<p>Clickhouse-copier does not support the old MergeTree format.
However, you can create the target tables manually and specify the engine in the task configuration file in the new format so that clickhouse-copier can parse it for its SELECT queries.</p>
<h2 id="how-to-monitor-the-status-of-running-tasks">How to monitor the status of running tasks</h2>
<p>Clickhouse-copier uses ZooKeeper to keep track of the progress and to communicate between workers.
Here is a list of queries that you can use to see what’s happening.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">--task-path /clickhouse/copier/task1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The task config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------+---------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">description</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2020</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">task_active_workers_version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2020</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">07</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">08</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">tables</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">task_active_workers</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Running workers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/task_active_workers&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The list of processed tables
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The list of processed partitions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">201909</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The status of a partition
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">shards</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">partition_active_workers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The status of source shards
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/shards&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----+---------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">37</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">49</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7cba4646c1996d768d76c912356b9762">25.1.2 - clickhouse-copier 20.4 - 21.6</h1>
    <div class="lead">clickhouse-copier 20.4 - 21.6</div>
	<p>Clickhouse-copier was created to move data between clusters.
It runs simple INSERT…SELECT queries and can copy data between tables with different engine parameters and between clusters with different number of shards.
In the task configuration file you need to describe the layout of the source and the target cluster, and list the tables that you need to copy. You can copy whole tables or specific partitions.
Clickhouse-copier uses temporary distributed tables to select from the source cluster and insert into the target cluster.</p>
<p>The behavior of clickhouse-copier was changed in 20.4:</p>
<ul>
<li>Now clickhouse-copier inserts data into intermediate tables, and after the insert finishes successfully clickhouse-copier attaches the completed partition into the target table. This allows for incremental data copying, because the data in the target table is intact during the process. <strong>Important note:</strong> ATTACH PARTITION respects the <code>max_partition_size_to_drop</code> limit. Make sure the <code>max_partition_size_to_drop</code> limit is big enough (or set to zero) in the destination cluster. If clickhouse-copier is unable to attach a partition because of the limit, it will proceed to the next partition, and it will drop the intermediate table when the task is finished (if the intermediate table is less than the <code>max_table_size_to_drop</code> limit). <strong>Another important note:</strong> ATTACH PARTITION is replicated. The attached partition will need to be downloaded by the other replicas. This can create significant network traffic between ClickHouse nodes. If an attach takes a long time, clickhouse-copier will log a timeout and will proceed to the next step.</li>
<li>Now clickhouse-copier splits the source data into chunks and copies them one by one. This is useful for big source tables, when inserting one partition of data can take hours. If there is an error during the insert clickhouse-copier has to drop the whole partition and start again. The <code>number_of_splits</code> parameter lets you split your data into chunks so that in case of an exception clickhouse-copier has to re-insert only one chunk of the data.</li>
<li>Now clickhouse-copier runs <code>OPTIMIZE target_table PARTITION ... DEDUPLICATE</code> for non-Replicated MergeTree tables. <strong>Important note:</strong> This is a very strange feature that can do more harm than good. We recommend to disable it by configuring the engine of the target table as Replicated in the task configuration file, and create the target tables manually if they are not supposed to be replicated. Intermediate tables are always created as plain MergeTree.</li>
</ul>
<h2 id="the-process-is-as-follows">The process is as follows</h2>
<ol>
<li>Process the configuration files.</li>
<li>Discover the list of partitions if not provided in the config.</li>
<li>Copy partitions one by one <em><strong>I’m not sure of the order since I was copying from 1 shard to 4 shards.</strong></em> <em><strong>The metadata in ZooKeeper suggests the order described here.</strong></em>
<ol>
<li>Copy chunks of data one by one.
<ol>
<li>Copy data from source shards one by one.
<ol>
<li>Create intermediate tables on all shards of the target cluster.</li>
<li>Check the status of the chunk in ZooKeeper.</li>
<li>Drop the partition from the intermediate table if the previous attempt was interrupted.</li>
<li>Insert the chunk of data into the intermediate tables.</li>
<li>Mark the shard as completed in ZooKeeper</li>
</ol>
</li>
</ol>
</li>
<li>Attach the chunks of the completed partition into the target table one by one
<ol>
<li>Attach a chunk into the target table.</li>
<li><strong>non-Replicated:</strong> Run OPTIMIZE target_table DEDUPLICATE for the partition on the target table.</li>
</ol>
</li>
</ol>
</li>
<li>Drop intermediate tables (may not succeed if the tables are bigger than <code>max_table_size_to_drop</code>).</li>
</ol>
<p>If there are several workers running simultaneously, they will assign themselves to different source shards.
If a worker was interrupted, another worker can be started to continue the task. The next worker will drop incomplete partitions and resume the copying.</p>
<h2 id="configuring-the-engine-of-the-target-table">Configuring the engine of the target table</h2>
<p>Clickhouse-copier uses the engine from the task configuration file for these purposes:</p>
<ul>
<li>to create target and intermediate tables if they don’t exist.</li>
<li>PARTITION BY: to SELECT a partition of data from the source table, to ATTACH partitions into target tables, to DROP incomplete partitions from intermediate tables, to OPTIMIZE partitions after they are attached to the target.</li>
<li>ORDER BY: to SELECT a chunk of data from the source table.</li>
</ul>
<p>Here is an example of SELECT that clickhouse-copier runs to get the sixth of ten chunks of data:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">the</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clause</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">the</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">expression</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">partition_key</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cityHash64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">the</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clause</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Clickhouse-copier does not support the old MergeTree format.
However, you can create the intermediate tables manually with the same engine as the target tables (otherwise ATTACH will not work), and specify the engine in the task configuration file in the new format so that clickhouse-copier can parse it for SELECT, ATTACH PARTITION and DROP PARTITION queries.</p>
<p><strong>Important note</strong>: always configure engine as Replicated to disable OPTIMIZE … DEDUPLICATE (unless you know why you need clickhouse-copier to run OPTIMIZE … DEDUPLICATE).</p>
<h2 id="how-to-configure-the-number-of-chunks">How to configure the number of chunks</h2>
<p>The default value for <code>number_of_splits</code> is 10.
You can change this parameter in the <code>table</code> section of the task configuration file. We recommend setting it to 1 for smaller tables.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;cluster_push&gt;</span>target_cluster<span style="color:#204a87;font-weight:bold">&lt;/cluster_push&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;database_push&gt;</span>target_database<span style="color:#204a87;font-weight:bold">&lt;/database_push&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;table_push&gt;</span>target_table<span style="color:#204a87;font-weight:bold">&lt;/table_push&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;number_of_splits&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/number_of_splits&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;engine&gt;</span>Engine=Replicated...<span style="color:#204a87;font-weight:bold">&lt;engine&gt;</span>
</span></span></code></pre></div><h2 id="how-to-monitor-the-status-of-running-tasks">How to monitor the status of running tasks</h2>
<p>Clickhouse-copier uses ZooKeeper to keep track of the progress and to communicate between workers.
Here is a list of queries that you can use to see what’s happening.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">--task-path /clickhouse/copier/task1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The task config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------+---------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">description</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">task_active_workers_version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">tables</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">47</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">47</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">task_active_workers</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Running workers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/task_active_workers&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The list of processed tables
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The list of processed partitions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">202103</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">47</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">202102</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">202101</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">27</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">36</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">202012</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">08</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The status of a partition
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">piece_0</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">attach_is_done</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The status of a piece
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/piece_N&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------------------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">shards</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">is_dirty</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">51</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">partition_piece_active_workers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">54</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">clean_start</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">54</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The status of source shards
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/piece_N/shards&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline">           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----+---------------------+--------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">54</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2021</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-384352a945ec192141ea6fb13e0f518f">25.2 - Remote table function</h1>
    <div class="lead">Remote table function</div>
	<h2 id="remote-table-function">remote(&hellip;) table function</h2>
<p>Suitable for moving up to hundreds of gigabytes of data.</p>
<p>With bigger tables recommended approach is to slice the original data by some <code>WHERE</code> condition, ideally - apply the condition on partitioning key, to avoid writing data to many partitions at once.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">(...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">date</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2021-04-13&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">(...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">date</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2021-04-12&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">(...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">date</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2021-04-11&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">....</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="q-can-it-create-a-bigger-load-on-the-source-system">Q. Can it create a bigger load on the source system?</h3>
<p>Yes, it may use disk read &amp; network write bandwidth. But typically write speed is worse than the read speed, so most probably the receiver side will be a bottleneck, and the sender side will not be overloaded.</p>
<p>While of course it should be checked, every case is different.</p>
<h3 id="q-can-i-tune-insert-speed-to-make-it-faster">Q. Can I tune INSERT speed to make it faster?</h3>
<p>Yes, by the cost of extra memory usage (on the receiver side).</p>
<p>Clickhouse tries to form blocks of data in memory and while one of limit: <code>min_insert_block_size_rows</code> or <code>min_insert_block_size_bytes</code> being hit, clickhouse dump this block on disk. If clickhouse tries to execute insert in parallel (<code>max_insert_threads &gt; 1</code>), it would form multiple blocks at one time.<br>
So maximum memory usage can be calculated like this: <code>max_insert_threads * first(min_insert_block_size_rows OR min_insert_block_size_bytes)</code></p>
<p>Default values:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">────────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">min_insert_block_size_rows</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1048545</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">min_insert_block_size_bytes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">268427520</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_insert_threads</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Values</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">means</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">that</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">is</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">run</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">parallel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────────────────┴───────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Tune those settings depending on your table average row size and amount of memory which are safe to occupy by <code>INSERT SELECT</code> query.</p>
<h3 id="q-ive-got-the-error-all-connection-tries-failed">Q. I&rsquo;ve got the error &ldquo;All connection tries failed&rdquo;</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;server.from.remote.dc:9440&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;default.table&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;password&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Received</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">exception</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">server</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">):</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">519</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Received</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">All</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attempts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">structure</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">failed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">279</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">displayText</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">NetException</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">All</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">connection</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tries</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">failed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">209</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">displayText</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">NetException</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">connect</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">out</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">192</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">official</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">209</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">displayText</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">NetException</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">connect</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">out</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">192</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">official</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">209</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">displayText</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DB</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">NetException</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">connect</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">out</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">192</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9440</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">official</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ol>
<li>Using remote(&hellip;) table function with secure TCP port (default values is 9440). There is remoteSecure() function for that.</li>
<li>High (&gt;50ms) ping between servers, values for <code>connect_timeout_with_failover_ms,</code>  <code>connect_timeout_with_failover_secure_ms</code> need&rsquo;s to be adjusted accordingly.</li>
</ol>
<p>Default values:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">────────────────────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">connect_timeout_with_failover_ms</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">connect_timeout_with_failover_secure_ms</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────────────────────────────┴───────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-69e50f36eba192534d9f891226a8196a">25.3 - rsync</h1>
    <div class="lead">rsync</div>
	<h3 id="short-instruction">Short Instruction</h3>
<ol>
<li>
<p>Do <a href="https://clickhouse.tech/docs/en/sql-reference/statements/alter/partition/#alter_freeze-partition" target="_blank">FREEZE TABLE</a> on needed table, partition. It would produce consistent snapshot of table data.</p>
</li>
<li>
<p>Run rsync command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rsync -ravlW --bwlimit<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100000</span> /var/lib/clickhouse/data/shadow/N/database/table
</span></span><span style="display:flex;"><span>    root@remote_host:/var/lib/clickhouse/data/database/table/detached
</span></span></code></pre></div><p><code>--bwlimit</code> is transfer limit in KBytes per second.</p>
</li>
<li>
<p>Run <a href="https://clickhouse.tech/docs/en/sql-reference/statements/alter/partition/#alter_attach-partition" target="_blank">ATTACH PARTITION</a> for each partition from <code>./detached</code> directory.</p>
</li>
</ol>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ac091a7a3a7a23bf1a7c0acd539339ce">26 - DDLWorker</h1>
    <div class="lead">DDLWorker</div>
	<p>DDLWorker is a subprocess (thread) of clickhouse-server that executes <code>ON CLUSTER</code> tasks at the node.</p>
<p>When you execute a DDL query with <code>ON CLUSTER mycluster</code> section the query executor at the current node reads the cluster <code>mycluster</code> definition (remote_servers / system.clusters) and places tasks into Zookeeper znode <code>task_queue/ddl/...</code> for members of the cluster <code>mycluster</code>.</p>
<p>DDLWorker at all ClickHouse nodes constantly check this <code>task_queue</code> for their tasks and executes them locally and reports about a result back into <code>task_queue</code>.</p>
<p>The common issue is the different hostnames/IPAddresses in the cluster definition and locally.</p>
<p>So a node initiator puts tasks for a host named Host1. But the Host1 thinks about own name as localhost or <strong>xdgt634678d</strong> (internal docker hostname) and never sees tasks for the Host1 because is looking tasks for <strong>xdgt634678d.</strong> The same with internal VS external IP addresses.</p>
<p>Another issue that sometimes DDLWorker thread can crash then ClickHouse node stops to execute <code>ON CLUSTER</code> tasks.</p>
<p>Check that DDLWorker is alive:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ps -eL<span style="color:#000;font-weight:bold">|</span>grep DDL
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">18829</span> <span style="color:#0000cf;font-weight:bold">18876</span> ?        00:00:00 DDLWorkerClnr
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">18829</span> <span style="color:#0000cf;font-weight:bold">18879</span> ?        00:00:00 DDLWorker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ps -ef<span style="color:#000;font-weight:bold">|</span>grep 18829<span style="color:#000;font-weight:bold">|</span>grep -v grep
</span></span><span style="display:flex;"><span>clickho+ <span style="color:#0000cf;font-weight:bold">18829</span> <span style="color:#0000cf;font-weight:bold">18828</span>  <span style="color:#0000cf;font-weight:bold">1</span> Feb09 ?        00:55:00 /usr/bin/clickhouse-server --con...
</span></span></code></pre></div><p>As you can see there are two threads: <code>DDLWorker</code> and <code>DDLWorkerClnr</code>.</p>
<p>The second thread – <code>DDLWorkerCleaner</code> cleans old tasks from <code>task_queue</code>. You can configure how many recent tasks to store:</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">config.xml
&lt;yandex&gt;
    &lt;distributed_ddl&gt;
        &lt;path&gt;/clickhouse/task_queue/ddl&lt;/path&gt;
        &lt;max_tasks_in_queue&gt;1000&lt;/max_tasks_in_queue&gt;
        &lt;task_max_lifetime&gt;604800&lt;/task_max_lifetime&gt;
        &lt;cleanup_delay_period&gt;60&lt;/cleanup_delay_period&gt;
    &lt;/distributed_ddl&gt;
&lt;/yandex&gt;
</code></pre><p>Default values:</p>
<p><strong>cleanup_delay_period</strong> = 60 seconds – Sets how often to start cleanup to remove outdated data.</p>
<p><strong>task_max_lifetime</strong> = 7 * 24 * 60 * 60 (in seconds = week) – Delete task if its age is greater than that.</p>
<p><strong>max_tasks_in_queue</strong> = 1000 – How many tasks could be in the queue.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7f5f8971a74cdc0af853041c9dd18c8f">26.1 - There are N unfinished hosts (0 of them are currently active).</h1>
    <div class="lead">&ldquo;There are N unfinished hosts (0 of them are currently active).&rdquo;</div>
	<p>Sometimes your Distributed DDL queries are being stuck, and not executing on all or subset of nodes, there are a lot of possible reasons for that kind of behavior, so it would take some time and effort to investigate.</p>
<h2 id="possible-reasons">Possible reasons</h2>
<h3 id="clickhouse-node-cant-recognize-itself">Clickhouse node can&rsquo;t recognize itself</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clusters</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- check is_local column, it should have 1 for itself
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>getent hosts clickhouse.local.net <span style="color:#8f5902;font-style:italic"># or other name which should be local</span>
</span></span><span style="display:flex;"><span>hostname --fqdn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat /etc/hosts
</span></span><span style="display:flex;"><span>cat /etc/hostname
</span></span></code></pre></div><h3 id="debian--ubuntu">Debian / Ubuntu</h3>
<p>There is an issue in Debian based images, when hostname being mapped to 127.0.1.1 address which doesn&rsquo;t literally match network interface and clickhouse fails to detect this address as local.</p>
<p><a href="https://github.com/ClickHouse/ClickHouse/issues/23504" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/23504</a></p>
<h4 id="previous-task-is-being-executed-and-taking-some-time">Previous task is being executed and taking some time</h4>
<p>It&rsquo;s usually some heavy operations like merges, mutations, alter columns, so it make sense to check those tables:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SHOW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PROCESSLIST</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">merges</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mutations</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>In that case, you can just wait completion of previous task.</p>
<h3 id="previous-task-is-stuck-because-of-some-error">Previous task is stuck because of some error</h3>
<p>In that case, the first step is to understand which exact task is stuck and why. There are some queries which can help with that.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- list of all distributed ddl queries, path can be different in your installation
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/clickhouse/task_queue/ddl/&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- information about specific task.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/clickhouse/task_queue/ddl/query-0000001000/&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/clickhouse/task_queue/ddl/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;query-0000001000&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- How many nodes executed this task
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numChildren</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">finished_nodes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/clickhouse/task_queue/ddl/query-0000001000/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;finished&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">─────┬─</span><span style="color:#000">finished_nodes</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">finished</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────┴────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- The nodes that are running the task
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/clickhouse/task_queue/ddl/query-0000001000/active/&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- What was the result for the finished nodes 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctime</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/clickhouse/task_queue/ddl/query-0000001000/finished/&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Latest successfull executed tasks from query_log.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">query_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%ddl_entry%&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">event_time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">FQDN</span><span style="color:#000;font-weight:bold">(),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterAllReplicas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cluster&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%MaxDDLEntryID%&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">FQDN</span><span style="color:#000;font-weight:bold">()</span><span style="color:#a40000">───────────────────┬─</span><span style="color:#000">metric</span><span style="color:#a40000">────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┬─</span><span style="color:#000">description</span><span style="color:#a40000">───────────────────────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">chi</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ab</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MaxDDLEntryID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">1468</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Max</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DDL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">entry</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DDLWorker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">FQDN</span><span style="color:#000;font-weight:bold">()</span><span style="color:#a40000">───────────────────┬─</span><span style="color:#000">metric</span><span style="color:#a40000">────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┬─</span><span style="color:#000">description</span><span style="color:#a40000">───────────────────────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">chi</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ab</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MaxDDLEntryID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">1468</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Max</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DDL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">entry</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DDLWorker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">FQDN</span><span style="color:#000;font-weight:bold">()</span><span style="color:#a40000">───────────────────┬─</span><span style="color:#000">metric</span><span style="color:#a40000">────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┬─</span><span style="color:#000">description</span><span style="color:#a40000">───────────────────────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">chi</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ab</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MaxDDLEntryID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">1468</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Max</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">processed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DDL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">entry</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DDLWorker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Information about task execution from logs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">grep</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87;font-weight:bold">C</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ddl_entry&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">log</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">clickhouse</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">server</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">clickhouse</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">server</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="issues-that-can-prevent-the-task-execution">Issues that can prevent the task execution</h4>
<p>Obsolete replicas left in zookeeper.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">zookeeper_path</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica_path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replicas</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">total_replicas</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active_replicas</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/clickhouse/cluster/tables/01/database/table/replicas&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replica_name&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">STOP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">QUEUES</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">START</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">QUEUES</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><a href="https://clickhouse.tech/docs/en/sql-reference/statements/system/%5c#query_language-system-drop-replica" target="_blank">https://clickhouse.tech/docs/en/sql-reference/statements/system/#query_language-system-drop-replica</a></p>
<p>Task were removed from DDL queue, but left in Replicated*MergeTree table queue.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep -C <span style="color:#0000cf;font-weight:bold">40</span> <span style="color:#4e9a06">&#34;ddl_entry&#34;</span> /var/log/clickhouse-server/clickhouse-server*.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:28.956888 <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#0000cf;font-weight:bold">599</span> <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">{}</span> &lt;Debug&gt; DDLWorker: Processing task query-0000211211 <span style="color:#ce5c00;font-weight:bold">(</span>ALTER TABLE db.table_local ON CLUSTER <span style="color:#4e9a06">`</span>all-replicated<span style="color:#4e9a06">`</span> DELETE WHERE <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> 1<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:29.053555 <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#0000cf;font-weight:bold">599</span> <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">{}</span> &lt;Error&gt; DDLWorker: ZooKeeper error: Code: 999, e.displayText<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=</span> Coordination::Exception: No node, Stack trace <span style="color:#ce5c00;font-weight:bold">(</span>when copying this message, always include the lines below<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log-
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log-0. Coordination::Exception::Exception<span style="color:#ce5c00;font-weight:bold">(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const<span style="color:#000;font-weight:bold">&amp;</span>, Coordination::Error, int<span style="color:#ce5c00;font-weight:bold">)</span> @ 0xfb2f6b3 in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log-1. Coordination::Exception::Exception<span style="color:#ce5c00;font-weight:bold">(</span>Coordination::Error<span style="color:#ce5c00;font-weight:bold">)</span> @ 0xfb2fb56 in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log:2. DB::DDLWorker::createStatusDirs<span style="color:#ce5c00;font-weight:bold">(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const<span style="color:#000;font-weight:bold">&amp;</span>, std::__1::shared_ptr&lt;zkutil::ZooKeeper&gt; const<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">)</span> @ 0xeb3127a in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log:3. DB::DDLWorker::processTask<span style="color:#ce5c00;font-weight:bold">(</span>DB::DDLTask<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">)</span> @ 0xeb36c96 in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log:4. DB::DDLWorker::enqueueTask<span style="color:#ce5c00;font-weight:bold">(</span>std::__1::unique_ptr&lt;DB::DDLTask, std::__1::default_delete&lt;DB::DDLTask&gt; &gt;<span style="color:#ce5c00;font-weight:bold">)</span> @ 0xeb35f22 in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log-5. ? @ 0xeb47aed in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log-6. ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::worker<span style="color:#ce5c00;font-weight:bold">(</span>std::__1::__list_iterator&lt;ThreadFromGlobalPool, void*&gt;<span style="color:#ce5c00;font-weight:bold">)</span> @ 0x8633bcd in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log-7. ThreadFromGlobalPool::ThreadFromGlobalPool&lt;void ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::scheduleImpl&lt;void&gt;<span style="color:#ce5c00;font-weight:bold">(</span>std::__1::function&lt;void <span style="color:#ce5c00;font-weight:bold">()</span>&gt;, int, std::__1::optional&lt;unsigned long&gt;<span style="color:#ce5c00;font-weight:bold">)</span>::<span style="color:#4e9a06">&#39;lambda1&#39;</span><span style="color:#ce5c00;font-weight:bold">()</span>&gt;<span style="color:#ce5c00;font-weight:bold">(</span>void<span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>, void ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::scheduleImpl&lt;void&gt;<span style="color:#ce5c00;font-weight:bold">(</span>std::__1::function&lt;void <span style="color:#ce5c00;font-weight:bold">()</span>&gt;, int, std::__1::optional&lt;unsigned long&gt;<span style="color:#ce5c00;font-weight:bold">)</span>::<span style="color:#4e9a06">&#39;lambda1&#39;</span><span style="color:#ce5c00;font-weight:bold">()&amp;&amp;</span>...<span style="color:#ce5c00;font-weight:bold">)</span>::<span style="color:#4e9a06">&#39;lambda&#39;</span><span style="color:#ce5c00;font-weight:bold">()</span>::operator<span style="color:#ce5c00;font-weight:bold">()()</span> @ 0x863612f in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log-8. ThreadPoolImpl&lt;std::__1::thread&gt;::worker<span style="color:#ce5c00;font-weight:bold">(</span>std::__1::__list_iterator&lt;std::__1::thread, void*&gt;<span style="color:#ce5c00;font-weight:bold">)</span> @ 0x8630ffd in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log-9. ? @ 0x8634bb3 in /usr/bin/clickhouse
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log-10. start_thread @ 0x9609 in /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log-11. __clone @ 0x122293 in /usr/lib/x86_64-linux-gnu/libc-2.31.so
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log- <span style="color:#ce5c00;font-weight:bold">(</span>version 21.1.8.30 <span style="color:#ce5c00;font-weight:bold">(</span>official build<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:29.053951 <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#0000cf;font-weight:bold">599</span> <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">{}</span> &lt;Debug&gt; DDLWorker: Processing task query-0000211211 <span style="color:#ce5c00;font-weight:bold">(</span>ALTER TABLE db.table_local ON CLUSTER <span style="color:#4e9a06">`</span>all-replicated<span style="color:#4e9a06">`</span> DELETE WHERE <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> 1<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>Context of this problem is:</p>
<ul>
<li>Constant pressure of cheap ON CLUSTER DELETE queries.</li>
<li>One replica was down for a long amount of time (multiple days).</li>
<li>Because of pressure on the DDL queue, it purged old records due to the <code>task_max_lifetime</code> setting.</li>
<li>When a lagging replica comes up, it&rsquo;s fail&rsquo;s execute old queries from DDL queue, because at this point they were purged from it.</li>
</ul>
<p>Solution:</p>
<ul>
<li>Reload/Restore this replica from scratch.</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d3de9fe2d4264f8c0b10d27225d8c18c">27 - differential backups using clickhouse-backup</h1>
    <div class="lead">differential backups using clickhouse-backup</div>
	<h3 id="differential-backups-using-clickhouse-backup">differential backups using clickhouse-backup</h3>
<ol>
<li>Download the latest clickhouse-backup for your platform <a href="https://github.com/AlexAkulov/clickhouse-backup/releases" target="_blank">https://github.com/AlexAkulov/clickhouse-backup/releases</a></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ubuntu / debian</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget https://github.com/AlexAkulov/clickhouse-backup/releases/download/v1.0.0/clickhouse-backup_1.0.0_amd64.deb 
</span></span><span style="display:flex;"><span>sudo dpkg -i clickhouse-backup_1.0.0_amd64.deb 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># centos / redhat / fedora </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo yum install https://github.com/AlexAkulov/clickhouse-backup/releases/download/v1.0.0/clickhouse-backup-1.0.0-1.x86_64.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># other platforms</span>
</span></span><span style="display:flex;"><span>wget https://github.com/AlexAkulov/clickhouse-backup/releases/download/v1.0.0/clickhouse-backup.tar.gz
</span></span><span style="display:flex;"><span>sudo mkdir /etc/clickhouse-backup/
</span></span><span style="display:flex;"><span>sudo mv clickhouse-backup/config.yml /etc/clickhouse-backup/config.yml.example
</span></span><span style="display:flex;"><span>sudo mv clickhouse-backup/clickhouse-backup /usr/bin/
</span></span><span style="display:flex;"><span>rm -rf clickhouse-backup clickhouse-backup.tar.gz
</span></span></code></pre></div><ol start="2">
<li>Create a runner script for the crontab</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /opt/clickhouse-backup-diff/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt; &#39;END&#39; &gt; /opt/clickhouse-backup-diff/clickhouse-backup-cron.sh
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set +x
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">command_line_argument=$1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">backup_name=$(date +%Y-%M-%d-%H-%M-%S)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">echo &#34;Creating local backup &#39;${backup_name}&#39; (full, using hardlinks)...&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">clickhouse-backup create &#34;${backup_name}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">if [[ &#34;run_diff&#34; == &#34;${command_line_argument}&#34; &amp;&amp; &#34;2&#34; -le &#34;$(clickhouse-backup list local | wc -l)&#34; ]]; then
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  prev_backup_name=&#34;$(clickhouse-backup list local | tail -n 2 | head -n 1 | cut -d &#34; &#34; -f 1)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  echo &#34;Uploading the backup &#39;${backup_name}&#39; as diff from the previous backup (&#39;${prev_backup_name}&#39;)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  clickhouse-backup upload --diff-from &#34;${prev_backup_name}&#34; &#34;${backup_name}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">elif [[ &#34;&#34; == &#34;${command_line_argument}&#34; ]]; then
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  echo &#34;Uploading the backup &#39;${backup_name}, and removing old unneeded backups&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  KEEP_BACKUPS_LOCAL=1 KEEP_BACKUPS_REMOTE=1 clickhouse-backup upload &#34;${backup_name}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">fi
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">END</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod +x /opt/clickhouse-backup-diff/clickhouse-backup-cron.sh
</span></span></code></pre></div><ol start="3">
<li>Create confuguration for clickhouse-backup</li>
</ol>
<pre tabindex="0"><code># Check the example: /etc/clickhouse-backup/config.yml.example 
vim /etc/clickhouse-backup/config.yml
</code></pre><ol start="4">
<li>Edit the crontab</li>
</ol>
<pre tabindex="0"><code>crontab -e

# full backup at 0:00 Monday
0 0 * * 1 clickhouse /opt/clickhouse-backup-diff/clickhouse-backup-cron.sh
# differential backup every hour (except of 00:00) Monday 
0 1-23 * * 1 clickhouse /opt/clickhouse-backup-diff/clickhouse-backup-cron.sh run_diff
# differential backup every hour Sunday, Tuesday-Saturday
0 */1 * * 0,2-6 clickhouse /opt/clickhouse-backup-diff/clickhouse-backup-cron.sh run_diff
</code></pre><ol start="5">
<li>Recover the last backup:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">last_remote_backup</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>clickhouse-backup list remote <span style="color:#000;font-weight:bold">|</span> tail -n <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span> cut -d <span style="color:#4e9a06">&#34; &#34;</span> -f 1<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>clickhouse-backup download <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">last_remote_backup</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>clickhouse-backup restore --rm <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">last_remote_backup</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-492a58dfa6abf818e811a55026049ff2">28 - High CPU usage</h1>
    <div class="lead">High CPU usage</div>
	<p>In general, it is a NORMAL situation for clickhouse that while processing a huge dataset it can use a lot of (or all of) the server resources. It is &lsquo;by design&rsquo; - just to make the answers faster.</p>
<p>The main directions to reduce the CPU usage <strong>is to review the schema / queries</strong> to limit the amount of the data which need to be processed, and to plan the resources in a way when single running query will not impact the others.</p>
<p>Any attempts to reduce the CPU usage will end up with slower queries!</p>
<h3 id="how-to-slow-down-queries-to-reduce-the-cpu-usage">How to slow down queries to reduce the CPU usage</h3>
<p>If it is acceptable for you - please check the following options for limiting the CPU usage:</p>
<ol>
<li>
<p>setting <code>max_threads</code>: reducing the number of threads that are allowed to use one request. Fewer threads = more free cores for other requests.  By default, it&rsquo;s allowed to take half of the available CPU cores, adjust only when needed. So if if you have 10 cores then <code>max_threads = 10</code> will work about twice faster than <code>max_threads=5</code>, but will take 100% or CPU. (max_threads=5 will use half of CPUs so 50%).</p>
</li>
<li>
<p>setting <code>os_thread_priority</code>: increasing niceness for selected requests. In this case, the operating system, when choosing which of the running processes to allocate processor time, will prefer processes with lower niceness. 0 is the default niceness. The higher the niceness, the lower the priority of the process. The maximum niceness value is 19.</p>
</li>
</ol>
<p>These are custom settings that can be tweaked in several ways:</p>
<ol>
<li>
<p>by specifying them when connecting a client, for example</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>clickhouse-client --os_thread_priority<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">19</span> -q <span style="color:#4e9a06">&#39;SELECT max (number) from numbers (100000000)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;SELECT max(number) from numbers(100000000)&#39;</span> <span style="color:#000;font-weight:bold">|</span> curl <span style="color:#4e9a06">&#39;http://localhost:8123/?os_thread_priority=19&#39;</span> --data-binary @-
</span></span></code></pre></div></li>
<li>
<p>via dedicated API / connection parameters in client libraries</p>
</li>
<li>
<p>using the SQL command SET (works only within the session)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">os_thread_priority</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100000000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>using different profiles of settings for different users. Something like</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;profiles&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;default&gt;</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/default&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;lowcpu&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;os_thread_priority&gt;</span>19<span style="color:#204a87;font-weight:bold">&lt;/os_thread_priority&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;max_threads&gt;</span>4<span style="color:#204a87;font-weight:bold">&lt;/max_threads&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/lowcpu&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/profiles&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">&lt;!-- Users and ACL. --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;users&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">&lt;!-- If user name was not specified, &#39;default&#39; user is used. --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;limited_user&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;password&gt;</span>123<span style="color:#204a87;font-weight:bold">&lt;/password&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;networks&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;ip&gt;</span>::/0<span style="color:#204a87;font-weight:bold">&lt;/ip&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;/networks&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;profile&gt;</span>lowcpu<span style="color:#204a87;font-weight:bold">&lt;/profile&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">&lt;!-- Quota for user. --&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;quota&gt;</span>default<span style="color:#204a87;font-weight:bold">&lt;/quota&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/limited_user&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/users&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div></li>
</ol>
<p>There are also plans to introduce a system of more flexible control over the assignment of resources to different requests.</p>
<p>Also, if these are manually created queries, then you can try to discipline users by adding quotas to them (they can be formulated as &ldquo;you can read no more than 100GB of data per hour&rdquo; or &ldquo;no more than 10 queries&rdquo;, etc.)</p>
<p>If these are automatically generated queries, it may make sense to check if there is no way to write them in a more efficient way.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-55be77301bcff9aa2583091b11b429d0">29 - Load balancers</h1>
    <div class="lead">Load balancers</div>
	<p>In general - one of the simplest option to do load balancing is to implement it on the client side.</p>
<p>I.e. list several endpoints for clickhouse connections and add some logic to pick one of the nodes.</p>
<p>Many client libraries support that.</p>
<h2 id="clickhouse-native-protocol-port-9000">ClickHouse native protocol (port 9000)</h2>
<p>Currently there are no protocol-aware proxies for clickhouse protocol, so the proxy / load balancer can work only on TCP level.</p>
<p>One of the best option for TCP load balancer is haproxy, also nginx can work in that mode.</p>
<p>Haproxy will pick one upstream when connection is established, and after that it will keep it connected to the same server until the client or server will disconnect (or some timeout will happen).</p>
<p>It can’t send different queries coming via a single connection to different servers, as he knows nothing about clickhouse protocol and doesn&rsquo;t know when one query ends and another start, it just sees the binary stream.</p>
<p>So for native protocol, there are only 3 possibilities:</p>
<ol>
<li>close connection after each query client-side</li>
<li>close connection after each query server-side (currently there is only one setting for that - idle_connection_timeout=0, which is not exact what you need, but similar).</li>
<li>use a clickhouse server with Distributed table as a proxy.</li>
</ol>
<h2 id="http-protocol-port-8123">HTTP protocol (port 8123)</h2>
<p>There are many more options and you can use haproxy / nginx / chproxy, etc.
chproxy give some extra clickhouse-specific features, you can find a list of them at <a href="https://github.com/Vertamedia/chproxy" target="_blank">https://github.com/Vertamedia/chproxy</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a5bef820919d4f1ad9265cdefeca05f5">30 - memory configuration settings</h1>
    <div class="lead">memory configuration settings</div>
	<h2 id="max_memory_usage-single-query-memory-usage">max_memory_usage. Single query memory usage</h2>
<p>max_memory_usage - the maximum amount of memory allowed for <strong>a single query</strong> to take. By default, it&rsquo;s 10Gb. The default value is good, don&rsquo;t adjust it in advance.</p>
<p>There are scenarios when you need to relax the limit for particular queries (if you hit &lsquo;Memory limit (for query) exceeded&rsquo;), or use a lower limit if you need to discipline the users or increase the number of simultaneous queries.</p>
<h2 id="server-memory-usage">Server memory usage</h2>
<p>Server memory usage = constant memory footprint (used by different caches, dictionaries, etc) + sum of memory temporary used by running queries (a theoretical limit is a number of simultaneous queries multiplied by max_memory_usage).</p>
<p>Since 20.4 you can set up a global limit using the <code>max_server_memory_usage</code> setting. If <strong>something</strong> will hit that limit you will see &lsquo;Memory limit (total) exceeded&rsquo; in <strong>random places</strong>.</p>
<p>By default it 90% of the physical RAM of the server.
<a href="https://clickhouse.tech/docs/en/operations/server-configuration-parameters/settings/#max_server_memory_usage" target="_blank">https://clickhouse.tech/docs/en/operations/server-configuration-parameters/settings/#max_server_memory_usage</a>
<a href="https://github.com/ClickHouse/ClickHouse/blob/e5b96bd93b53d2c1130a249769be1049141ef386/programs/server/config.xml#L239-L250" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/e5b96bd93b53d2c1130a249769be1049141ef386/programs/server/config.xml#L239-L250</a></p>
<p>You can decrease that in some scenarios (like you need to leave more free RAM for page cache or to some other software).</p>
<h3 id="how-to-check-what-is-using-my-ram">How to check what is using my RAM?</h3>
<p><a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-who-ate-my-memory/">altinity-kb-who-ate-my-memory.md&amp;quot; </a></p>
<h3 id="mark-cache">Mark cache</h3>
<p><a href="https://github.com/ClickHouse/clickhouse-presentations/blob/master/meetup39/mark-cache.pdf" target="_blank">https://github.com/ClickHouse/clickhouse-presentations/blob/master/meetup39/mark-cache.pdf</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-605ad2e3cca983282a1dbf9607bb550c">31 - Moving table to another device.</h1>
    <div class="lead">Moving table to another device.</div>
	<p>Suppose we mount a new device at path <code>/mnt/disk_1</code> and want to move <code>table_4</code> to it.</p>
<ol>
<li>Create directory on new device for ClickHouse data. /in shell <code>mkdir /mnt/disk_1/clickhouse</code></li>
<li>Change ownership of created directory to ClickHouse user. /in shell <code>chown -R clickhouse:clickhouse /mnt/disk_1/clickhouse</code></li>
<li>Create a special storage policy which should include both disks: old and new. /in shell</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">nano /etc/clickhouse-server/config.d/storage.xml
###################/etc/clickhouse-server/config.d/storage.xml###########################
&lt;yandex&gt;
  &lt;storage_configuration&gt;
    &lt;disks&gt;
      &lt;!--
          default disk is special, it always
          exists even if not explicitly
          configured here, but you can&#39;t change
          it&#39;s path here (you should use &lt;path&gt;
          on top level config instead)
      --&gt;
      &lt;default&gt;
         &lt;!--
             You can reserve some amount of free space
             on any disk (including default) by adding
             keep_free_space_bytes tag
         --&gt;
      &lt;/default&gt;
      &lt;disk_1&gt; &lt;!-- disk name --&gt;
          &lt;path&gt;/mnt/disk_1/clickhouse/&lt;/path&gt;
      &lt;/disk_1&gt;
    &lt;/disks&gt;
    &lt;policies&gt;
      &lt;move_from_default_to_disk_1&gt; &lt;!-- name for new storage policy --&gt;
        &lt;volumes&gt;
          &lt;default&gt;
            &lt;disk&gt;default&lt;/disk&gt;
            &lt;max_data_part_size_bytes&gt;10000000&lt;/max_data_part_size_bytes&gt;
          &lt;/default&gt;
          &lt;disk_1_vol&gt; &lt;!-- name of volume --&gt;
            &lt;!--
                we have only one disk in that volume
                and we reference here the name of disk
                as configured above in &lt;disks&gt; section
            --&gt;
            &lt;disk&gt;disk_1&lt;/disk&gt;
          &lt;/disk_1_vol&gt;
        &lt;/volumes&gt;
        &lt;move_factor&gt;0.99&lt;/move_factor&gt;
      &lt;/move_from_default_to_disk_1&gt;
    &lt;/policies&gt;
  &lt;/storage_configuration&gt;
&lt;/yandex&gt;
#########################################################################################
</code></pre><ol>
<li>Update storage_policy setting of tables to new policy.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">MODIFY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SETTING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">storage_policy</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;move_from_default_to_disk_1&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ol>
<li>Wait till all parts of tables change their disk_name to new disk.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">disk_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;table_4&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">disk_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes_on_disk</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">partition</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;table_4&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">disk_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">disk_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ol>
<li>Remove &lsquo;default&rsquo; disk from new storage policy.  In server shell:</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">nano /etc/clickhouse-server/config.d/storage.xml
###################/etc/clickhouse-server/config.d/storage.xml###########################
&lt;yandex&gt;
  &lt;storage_configuration&gt;
    &lt;disks&gt;
      &lt;!--
          default disk is special, it always
          exists even if not explicitly
          configured here, but you can&#39;t change
          it&#39;s path here (you should use &lt;path&gt;
          on top level config instead)
      --&gt;
      &lt;default&gt;
         &lt;!--
             You can reserve some amount of free space
             on any disk (including default) by adding
             keep_free_space_bytes tag
         --&gt;
      &lt;/default&gt;
      &lt;disk_1&gt; &lt;!-- disk name --&gt;
          &lt;path&gt;/mnt/disk_1/clickhouse/&lt;/path&gt;
      &lt;/disk_1&gt;
    &lt;/disks&gt;
    &lt;policies&gt;
      &lt;move_from_default_to_disk_1&gt; &lt;!-- name for new storage policy --&gt;
        &lt;volumes&gt;
          &lt;disk_1_vol&gt; &lt;!-- name of volume --&gt;
            &lt;!--
                we have only one disk in that volume
                and we reference here the name of disk
                as configured above in &lt;disks&gt; section
            --&gt;
            &lt;disk&gt;disk_1&lt;/disk&gt;
          &lt;/disk_1_vol&gt;
        &lt;/volumes&gt;
        &lt;move_factor&gt;0.99&lt;/move_factor&gt;
      &lt;/move_from_default_to_disk_1&gt;
    &lt;/policies&gt;
  &lt;/storage_configuration&gt;
&lt;/yandex&gt;
#########################################################################################
</code></pre><p>ClickHouse wouldn&rsquo;t auto reload config, because we removed some disks from storage policy, so we need to restart it by hand.</p>
<ol>
<li>Restart ClickHouse server.</li>
<li>Make sure that storage policy uses the right disks.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">storage_policies</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">policy_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;move_from_default_to_disk_1&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-60329cb30d1cf552b84e2cee02de47b7">32 - Object consistency in a cluster</h1>
    <div class="lead">Object consistency in a cluster</div>
	<p>List of missing tables</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">groupArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">FQDN</span><span style="color:#000;font-weight:bold">())</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterAllReplicas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">{</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">one</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hosts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">arrayFilter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">groupArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hosts</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">miss_table</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FQDN</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterAllReplicas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">{</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">tables</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">engine</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Log&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;Memory&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;TinyLog&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">HAVING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">miss_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">skip_unavailable_shards</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#a40000">─┬─</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#a40000">─┬─</span><span style="color:#000">miss_table</span><span style="color:#a40000">────────────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;host366.mynetwork.net&#39;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────┴───────┴───────────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>List of inconsistent tables</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">engine</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uniqExact</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">create_table_query</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ddl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterAllReplicas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">{</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tables</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">engine</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">HAVING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ddl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>List of inconsistent columns</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">groupArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">FQDN</span><span style="color:#000;font-weight:bold">())</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterAllReplicas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">{</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">one</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hosts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">arrayStringConcat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arrayMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#4e9a06">&#39;: &#39;</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                 </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">groupArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">g</span><span style="color:#000;font-weight:bold">)),</span><span style="color:#4e9a06">&#39;, &#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">diff</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FQDN</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterAllReplicas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">{</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">columns</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">HAVING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arrayDistinct</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hosts</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">skip_unavailable_shards</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#a40000">─┬─</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#a40000">───┬─</span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#a40000">────┬─</span><span style="color:#000">diff</span><span style="color:#a40000">────────────────────────────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">z</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ch</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">host22</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ch</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">host21</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────┴─────────┴───────────┴─────────────────────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>List of inconsistent dictionaries</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">groupArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">FQDN</span><span style="color:#000;font-weight:bold">())</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterAllReplicas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">{</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">one</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hosts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">dictionary</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">arrayFilter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">groupArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hosts</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">miss_dict</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">arrayReduce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;median&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">groupArray</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">element_count</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ec</span><span style="color:#000;font-weight:bold">).</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FQDN</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">dictionary</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">element_count</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterAllReplicas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">{</span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">dictionaries</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">dictionary</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">HAVING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">miss_dict</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">skip_unavailable_shards</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b4d9520dcb2feeb131e8e5640308a411">33 - Production Cluster Configuration Guide</h1>
    <div class="lead">Production Cluster Configuration Guide</div>
	<p>Moving from a single ClickHouse server to a clustered format provides several benefits:</p>
<ul>
<li>Replication guarantees data integrity.</li>
<li>Provides redundancy.</li>
<li>Failover by being able to restart half of the nodes without encountering downtime.</li>
</ul>
<p>Moving from an unsharded ClickHouse environment to a sharded cluster requires redesign of schema and queries. Starting with a sharded cluster from the beginning makes it easier in the future to scale the cluster up.</p>
<p>Setting up a ClickHouse cluster for a production environment requires the following stages:</p>
<ul>
<li>Hardware Requirements</li>
<li>Network Configuration</li>
<li>Create Host Names</li>
<li>Monitoring Considerations</li>
<li>Configuration Steps</li>
<li>Setting Up Backups</li>
<li>Staging Plans</li>
<li>Upgrading The Cluster</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-202b7e3651622a4779b38f52cef739a7">33.1 - Backups</h1>
    <div class="lead">Backups</div>
	<p>ClickHouse is currently at the design stage of creating some universal backup solution. Some custom backup strategies are:</p>
<ol>
<li>Each shard is backed up separately.</li>
<li>FREEZE the table/partition. For more information, see <a href="https://clickhouse.tech/docs/en/sql-reference/statements/alter/partition/#alter_freeze-partition" target="_blank">Alter Freeze Partition</a>.
<ol>
<li>This creates hard links in shadow subdirectory.</li>
</ol>
</li>
<li>rsync that directory to a backup location, then remove that subfolder from shadow.
<ol>
<li>Cloud users are recommended to use <a href="https://rclone.org/" target="_blank">Rclone</a>.</li>
</ol>
</li>
<li>Always add the full contents of the metadata subfolder that contains the current DB schema and clickhouse configs to your backup.</li>
<li>For a second replica, it’s enough to copy metadata and configuration.</li>
<li>Data in clickhouse is already compressed with lz4, backup can be compressed bit better, but avoid using cpu-heavy compression algorythms like gzip, use something like zstd instead.</li>
</ol>
<p>The tool automating that process  <a href="https://github.com/AlexAkulov/clickhouse-backup" target="_blank">clickhouse-backup</a>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8064c7d414e643fb87b3e0939260d98f">33.2 - Cluster Configuration FAQ</h1>
    <div class="lead">Cluster Configuration FAQ</div>
	<h2 id="clickhouse-does-not-start-some-other-unexpected-behavior-happening">ClickHouse does not start, some other unexpected behavior happening</h2>
<p>Check clickhouse logs, they are your friends:</p>
<p>tail -n 1000 /var/log/clickhouse-server/clickhouse-server.err.log | less
tail -n 10000 /var/log/clickhouse-server/clickhouse-server.log | less</p>
<h2 id="how-do-i-restrict-memory-usage">How Do I Restrict Memory Usage?</h2>
<p>See <a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-memory-configuration-settings/">our knowledge base article</a>  and <a href="https://clickhouse.tech/docs/en/operations/settings/query-complexity/#settings_max_memory_usage" target="_blank">official documentation</a> for more information.</p>
<h2 id="clickhouse-died-during-big-query-execution">ClickHouse died during big query execution</h2>
<p>Misconfigured clickhouse can try to allocate more RAM than is available on the system.</p>
<p>In that case an OS component called oomkiller can kill the clickhouse process.</p>
<p>That event leaves traces inside system logs (can be checked by running dmesg command).</p>
<h2 id="how-do-i-make-huge-group-by-queries-use-less-ram">How Do I make huge ‘Group By’ queries use less RAM?</h2>
<p>Enable on disk GROUP BY (it is slower, so is disabled by default)</p>
<p>Set <a href="https://clickhouse.tech/docs/en/operations/settings/query-complexity/#settings-max_bytes_before_external_group_by" target="_blank">max_bytes_before_external_group_by</a> to a value about 70-80% of your max_memory_usage value.</p>
<h2 id="data-returned-in-chunks-by-clickhouse-client">Data returned in chunks by clickhouse-client</h2>
<p>See <a href="http://kb.altinity.com/altinity-kb-interfaces/altinity-kb-clickhouse-client/">altinity-kb-clickhouse-client</a></p>
<h2 id="i-cant-connect-from-other-hosts--what-do-i-do">I Can’t Connect From Other Hosts.  What do I do?</h2>
<p>Check the <listen> settings in config.xml. Verify that the connection can connect on both IPV4 and IPV6.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-839cbf636b5f8a35c6823f41977447f7">33.3 - Cluster Configuration Process</h1>
    <div class="lead">Cluster Configuration Process</div>
	<p>So you set up 3 nodes with zookeeper (zookeeper1, zookeeper2, zookeeper3 - <a href="https://docs.altinity.com/operationsguide/clickhouse-zookeeper/" target="_blank">How to install zookeer?</a>),  and  and 4 nodes with ClickHouse (clickhouse-sh1r1,clickhouse-sh1r2,clickhouse-sh2r1,clickhouse-sh2r2 - <a href="https://docs.altinity.com/altinitystablerelease/stablequickstartguide/" target="_blank">how to install ClickHouse?</a>). Now we need to make them work together.</p>
<p>Use ansible/puppet/salt or other systems to control the servers’ configurations.</p>
<ol>
<li>Configure ClickHouse access to Zookeeper by adding the file zookeeper.xml in /etc/clickhouse-server/config.d/ folder. This file must be placed on all ClickHouse servers.</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;yandex&gt;
    &lt;zookeeper&gt;
        &lt;node&gt;
            &lt;host&gt;zookeeper1&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
        &lt;node&gt;
            &lt;host&gt;zookeeper2&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
        &lt;node&gt;
            &lt;host&gt;zookeeper3&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
    &lt;/zookeeper&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>On each server put the file macros.xml in <code>/etc/clickhouse-server/config.d/</code> folder.</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;yandex&gt;
    &lt;!--
        That macros are defined per server,
        and they can be used in DDL, to make the DB schema cluster/server neutral
    --&gt;
    &lt;macros&gt;
        &lt;cluster&gt;prod_cluster&lt;/cluster&gt;
        &lt;shard&gt;01&lt;/shard&gt;
        &lt;replica&gt;clickhouse-sh1r1&lt;/replica&gt; &lt;!-- better - use the same as hostname  --&gt;
    &lt;/macros&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>On each server place the file cluster.xml in /etc/clickhouse-server/config.d/ folder. Before 20.10  ClickHouse will use default user to connect to other nodes (configurable, other users can be used), since 20.10 we recommend to use passwordless intercluster authentication based on common secret (HMAC auth)</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;yandex&gt;
    &lt;remote_servers&gt;
        &lt;prod_cluster&gt; &lt;!-- you need to give a some name for a cluster --&gt;

            &lt;!--
                &lt;secret&gt;some_random_string, same on all cluster nodes, keep it safe&lt;/secret&gt;
            --&gt;
            &lt;shard&gt;
                &lt;internal_replication&gt;true&lt;/internal_replication&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh1r1&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh1r2&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
            &lt;/shard&gt;
            &lt;shard&gt;
                &lt;internal_replication&gt;true&lt;/internal_replication&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh2r1&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh2r2&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
            &lt;/shard&gt;
        &lt;/prod_cluster&gt;
    &lt;/remote_servers&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>A good practice is to create 2 additional cluster configurations similar to prod_cluster above with the following distinction: but listing all nodes of single shard (all are replicas) and as nodes of 6 different shards (no replicas)
<ol>
<li>all-replicated: All nodes are listed as replicas in a single shard.</li>
<li>all-sharded: All nodes are listed as separate shards with no replicas.</li>
</ol>
</li>
</ol>
<p>Once this is complete, other queries that span nodes can be performed. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_table_local</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt8</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/tables/{database}/{table}/{shard}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>That will create a table on all servers in the cluster. You can insert data into this table and it will be replicated automatically to the other shards.To store the data or read the data from all shards at the same time, create a Distributed table that links to the replicatedMergeTree table.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">Distributed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;default&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;
</span></span></span></code></pre></div><h4 id="hardening-clickhouse-security"><strong>Hardening ClickHouse Security</strong></h4>
<p><strong>See</strong> <a href="https://docs.altinity.com/operationsguide/security/clickhouse-hardening-guide/" target="_blank">https://docs.altinity.com/operationsguide/security/clickhouse-hardening-guide/</a></p>
<h3 id="additional-settings">Additional Settings</h3>
<p>See <a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-settings-to-adjust/">altinity-kb-settings-to-adjust</a></p>
<h4 id="users">Users</h4>
<p>Disable or add password for the default users default and readonly if your server is accessible from non-trusted networks.</p>
<p>If you add password to the default user, you will need to adjust cluster configuration, since the other servers need to know the default user’s should know the default user’s to connect to each other.</p>
<p>If you’re inside a trusted network, you can leave default user set to nothing to allow the ClickHouse nodes to communicate with each other.</p>
<h4 id="engines--clickhouse-building-blocks">Engines &amp; ClickHouse building blocks</h4>
<p>For general explanations of roles of different engines - check the post <a href="https://github.com/yandex/ClickHouse/issues/2161" target="_blank">Distributed vs Shard vs Replicated ahhh, help me!!!</a>.</p>
<h4 id="zookeeper-paths">Zookeeper Paths</h4>
<p>Use conventions  for zookeeper paths.  For example, use:</p>
<p>ReplicatedMergeTree(&rsquo;/clickhouse/{cluster}/tables/{shard}/table_name&rsquo;, &lsquo;{replica}&rsquo;)</p>
<p>for:</p>
<p>SELECT * FROM system.zookeeper WHERE path=&rsquo;/ &hellip;';</p>
<h4 id="configuration-best-practices">Configuration Best Practices</h4>
<table>
  <thead>
    <tr>
      <th style="text-align:left">
        <p>Attribution</p>
        <p>Modified by a post [on GitHub by Mikhail Filimonov](https://github.com/ClickHouse/ClickHouse/issues/3607#issuecomment-440235298).</p>
      </th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<p>The following are recommended Best Practices when it comes to setting up a ClickHouse Cluster with Zookeeper:</p>
<ol>
<li>Don’t edit/overwrite default configuration files. Sometimes a newer version of ClickHouse introduces some new settings or changes the defaults in config.xml and users.xml.
<ol>
<li>Set configurations via the extra files in conf.d directory. For example, to overwrite the interface save the file config.d/listen.xml, with the following:</li>
</ol>
</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;listen_host replace=&#34;replace&#34;&gt;::&lt;/listen_host&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>The same is true for users. For example, change the default profile by putting the file in users.d/profile_default.xml:</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;profiles&gt;
        &lt;default replace=&#34;replace&#34;&gt;
            &lt;max_memory_usage&gt;15000000000&lt;/max_memory_usage&gt;
            &lt;max_bytes_before_external_group_by&gt;12000000000&lt;/max_bytes_before_external_group_by&gt;
            &lt;max_bytes_before_external_sort&gt;12000000000&lt;/max_bytes_before_external_sort&gt;
            &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt;
            &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt;
            &lt;load_balancing&gt;random&lt;/load_balancing&gt;
            &lt;log_queries&gt;1&lt;/log_queries&gt;
            &lt;max_execution_time&gt;600&lt;/max_execution_time&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>Or you can create a user by putting a file users.d/user_xxx.xml (since 20.5 you can also use CREATE USER)</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;users&gt;
        &lt;xxx&gt;
            &lt;!-- PASSWORD=$(base64 &lt; /dev/urandom | head -c8); echo &#34;$PASSWORD&#34;; echo -n &#34;$PASSWORD&#34; | sha256sum | tr -d &#39;-&#39; --&gt;
            &lt;password_sha256_hex&gt;...&lt;/password_sha256_hex&gt;
            &lt;networks incl=&#34;networks&#34; /&gt;
            &lt;profile&gt;readonly&lt;/profile&gt;
            &lt;quota&gt;default&lt;/quota&gt;
            &lt;allow_databases incl=&#34;allowed_databases&#34; /&gt;
        &lt;/xxx&gt;
    &lt;/users&gt;
&lt;/yandex&gt;
</code></pre><ol>
<li>Some parts of configuration will contain repeated elements (like allowed ips for all the users). To avoid repeating that - use substitutions file. By default its /etc/metrika.xml, but you can change it for example to /etc/clickhouse-server/substitutions.xml with the &lt;include_from&gt; section of the main config. Put the repeated parts into substitutions file, like this:</li>
</ol>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;networks&gt;
        &lt;ip&gt;::1&lt;/ip&gt;
        &lt;ip&gt;127.0.0.1&lt;/ip&gt;
        &lt;ip&gt;10.42.0.0/16&lt;/ip&gt;
        &lt;ip&gt;192.168.0.0/24&lt;/ip&gt;
    &lt;/networks&gt;
&lt;/yandex&gt;
</code></pre><p>These files can be common for all the servers inside the cluster or can be individualized per server. If you choose to use one substitutions file per cluster, not per node, you will also need to generate the file with macros, if macros are used.</p>
<p>This way you have full flexibility; you’re not limited to the settings described in the template. You can change any settings per server or data center just by assigning files with some settings to that server or server group. It becomes easy to navigate, edit, and assign files.</p>
<h3 id="other-configuration-recommendations">Other Configuration Recommendations</h3>
<p>Other configurations that should be evaluated:</p>
<ul>
<li><listen> in config.xml: Determines which IP addresses and ports the ClickHouse servers listen for incoming communications.</li>
<li>&lt;max_memory_..&gt; and &lt;max_bytes_before_external_&hellip;&gt; in users.xml. These are part of the profile <default>.</li>
<li>&lt;max_execution_time&gt;</li>
<li>&lt;log_queries&gt;</li>
</ul>
<p>The following extra debug logs should be considered:</p>
<ul>
<li>part_log</li>
<li>text_log</li>
</ul>
<h3 id="understanding-the-configuration">Understanding The Configuration</h3>
<p>ClickHouse configuration stores most of its information in two files:</p>
<ul>
<li>config.xml: Stores <a href="https://clickhouse.yandex/docs/en/operations/server_settings/" target="_blank">Server configuration parameters</a>. They are server wide, some are hierarchical , and most of them can’t be changed in runtime. The list of settings to apply without a restart changes from version to version. Some settings can be verified using system tables, for example:
<ul>
<li>macros (system.macros)</li>
<li>remote_servers (system.clusters)</li>
</ul>
</li>
<li>users.xml: Configure users, and user level / session level <a href="https://clickhouse.yandex/docs/en/operations/settings/settings/" target="_blank">settings</a>.
<ul>
<li>Each user can change these during their session by:
<ul>
<li>Using parameter in http query</li>
<li>By using parameter for clickhouse-client</li>
<li>Sending query like set allow_experimental_data_skipping_indices=1.</li>
</ul>
</li>
<li>Those settings and their current values are visible in system.settings. You can make some settings global by editing default profile in users.xml, which does not need restart.</li>
<li>You can forbid users to change their settings by using readonly=2 for that user, or using <a href="https://clickhouse.yandex/docs/en/operations/settings/constraints_on_settings/" target="_blank">setting constraints</a>.</li>
<li>Changes in users.xml are applied w/o restart.</li>
</ul>
</li>
</ul>
<p>For both config.xml and users.xml, it’s preferable to put adjustments in the config.d and users.d subfolders instead of editing config.xml and users.xml directly.</p>
<p>You can check if the config file was reread by checking /var/lib/clickhouse/preprocessed_configs/ folder.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3754a72a1a168184ed696d361b761145">33.4 - Hardware Requirements</h1>
    <div class="lead">Hardware Requirements</div>
	<h3 id="clickhouse"><strong>ClickHouse</strong></h3>
<p>ClickHouse will use all available hardware to maximize performance. So the more hardware - the better. As of this publication, the hardware requirements are:</p>
<ul>
<li>Minimum Hardware: 4-core CPU with support of SSE4.2, 16 Gb RAM, 1Tb HDD.
<ul>
<li>Recommended for development and staging environments.</li>
<li>SSE4.2 is required, and going below 4 Gb of RAM is not recommended.</li>
</ul>
</li>
<li>Recommended Hardware: &gt;=16-cores, &gt;=64Gb RAM, HDD-raid or SSD.
<ul>
<li>For processing up to hundreds of millions / billions of rows.</li>
</ul>
</li>
</ul>
<p>For clouds: disk throughput is the more important factor compared to IOPS. Be aware of burst / baseline disk speed difference.</p>
<p>See also: <a href="https://clickhouse.tech/benchmark/hardware/" target="_blank">https://clickhouse.tech/benchmark/hardware/</a></p>
<h3 id="zookeeper"><strong>Zookeeper</strong></h3>
<p>Zookeeper requires separate servers from those used for ClickHouse. Zookeeper has poor performance when installed on the same node as ClickHouse.</p>
<p>Hardware Requirements for Zookeeper:</p>
<ul>
<li>Fast disk speed (ideally NVMe, 128Gb should be enough).</li>
<li>Any modern CPU (one core, better 2)</li>
<li>4Gb of RAM</li>
</ul>
<p>For clouds - be careful with burstable network disks (like gp2 on aws): you may need up to 1000 IOPs on the disk for on a long run, so gp3 with 3000 IOPs baseline is a better choice.</p>
<p>The number of Zookeeper instances depends on the environment:</p>
<ul>
<li>Production: 3 is an optimal number of zookeeper instances.</li>
<li>Development and Staging: 1 zookeeper instance is sufficient.</li>
</ul>
<p>See also:</p>
<ul>
<li><a href="https://docs.altinity.com/operationsguide/clickhouse-zookeeper/" target="_blank">https://docs.altinity.com/operationsguide/clickhouse-zookeeper/</a></li>
<li><a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/altinity-kb-proper-setup/">altinity-kb-proper-setup</a></li>
<li><a href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/zookeeper-monitoring/">zookeeper-monitoring</a></li>
</ul>
<h4 id="clickhouse-hardware-configuration">ClickHouse Hardware Configuration</h4>
<p>Configure the servers according to those recommendations the <a href="https://clickhouse.yandex/docs/en/operations/tips/" target="_blank">ClickHouse Usage Recommendations</a>.</p>
<h4 id="test-your-hardware"><strong>Test Your Hardware</strong></h4>
<p>Be sure to test the following:</p>
<ul>
<li>RAM speed.</li>
<li>Network speed.</li>
<li>Storage speed.</li>
</ul>
<p>It’s better to find any performance issues before installing ClickHouse.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4accea5680fbc04bc964ceaa6a6f4898">33.5 - Monitoring Considerations</h1>
    <div class="lead">Monitoring Considerations</div>
	<p><a href="../altinity-kb-monitoring">Moved</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-414e2937f5573cccbd17d35a64e42c62">33.6 - Network Configuration</h1>
    <div class="lead">Network Configuration</div>
	<h3 id="networking-and-server-room-planning"><strong>Networking And Server Room Planning</strong></h3>
<p>The network used for your ClickHouse cluster should be a fast network, ideally 10 Gbit or more.
ClickHouse nodes generate a lot of traffic to exchange the data between nodes (port 9009 for replication, and 9000 for distributed queries).
Zookeeper traffic in normal circumstanses is moderate, but in some special cases can also be very significant.</p>
<p>For the zookeeper low latency is more important than bandwidth.</p>
<p>Keep the replicas isolated on the hardware level. This allows for cluster failover from possible outages.</p>
<ul>
<li>For Physical Environments: Avoid placing 2 ClickHouse replicas on the same server rack. Ideally, they should be on isolated network switches and an isolated power supply.</li>
<li>For Clouds Environments: Use different availability zones between the ClickHouse replicas when possible (but be aware of the interzone traffic costs)</li>
</ul>
<p>These considerations are the same as the Zookeeper nodes.</p>
<p>For example:</p>
<table>
<thead>
<tr>
<th style="text-align:left"><strong>Rack</strong></th>
<th style="text-align:left"><strong>Server</strong></th>
<th style="text-align:left"><strong>Server</strong></th>
<th style="text-align:left"><strong>Server</strong></th>
<th style="text-align:left"><strong>Server</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>Rack 1</strong></td>
<td style="text-align:left"><strong>CH_SHARD1_R1</strong></td>
<td style="text-align:left"><strong>CH_SHARD2_R1</strong></td>
<td style="text-align:left"><strong>CH_SHARD3_R1</strong></td>
<td style="text-align:left"><strong>ZOO_1</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>Rack 2</strong></td>
<td style="text-align:left"><strong>CH_SHARD1_R2</strong></td>
<td style="text-align:left"><strong>CH_SHARD2_R2</strong></td>
<td style="text-align:left"><strong>CH_SHARD3_R2</strong></td>
<td style="text-align:left"><strong>ZOO_2</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>Rack 3</strong></td>
<td style="text-align:left"><strong>ZOO3</strong></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h4 id="network-ports-and-firewall"><strong>Network Ports And Firewall</strong></h4>
<p>ClickHouse listens the following ports:</p>
<ul>
<li>9000: clickhouse-client, native clients, other clickhouse-servers connect to here.</li>
<li>8123: HTTP clients</li>
<li>9009: Other replicas will connect here to download data.</li>
</ul>
<p>For more information, see <a href="https://www.altinity.com/blog/2019/3/15/clickhouse-networking-part-1" target="_blank">CLICKHOUSE NETWORKING, PART 1</a>.</p>
<p>Zookeeper listens the following ports:</p>
<ul>
<li>2181: Client connections.</li>
<li>2888: Inter-ensemble connections.</li>
<li>3888: Leader election.</li>
</ul>
<p>Outbound traffic from ClickHouse connects to the following ports:</p>
<ul>
<li>ZooKeeper: On port 2181.</li>
<li>Other CH nodes in the cluster: On port 9000 and 9009.</li>
<li>Dictionary sources: Depending on what was configured such as HTTP, MySQL, Mongo, etc.</li>
<li>Kafka or Hadoop: If those integrations were enabled.</li>
</ul>
<h3 id="ssl"><strong>SSL</strong></h3>
<p>For non-trusted networks enable SSL/HTTPS. If acceptable, it is better to keep interserver communications unencrypted for performance reasons.</p>
<h3 id="naming-schema"><strong>Naming Schema</strong></h3>
<p>The best time to start creating a naming schema for the servers is before they’re created and configured.</p>
<p>There are a few features based on good server naming in ClickHouse:</p>
<ul>
<li>clickhouse-client prompts: Allows a different prompt for clickhouse-client per server hostname.</li>
<li>Nearest hostname load balancing: For more information, see <a href="https://clickhouse.yandex/docs/en/operations/settings/settings/#load_balancing-nearest_hostname" target="_blank">Nearest Hostname</a>.</li>
</ul>
<p>A good option is to use the following:</p>
<p>{datacenter}-{serverroom}-{rack identifier}-{clickhouse cluster identifier}-{shard number or server number}.</p>
<p>Other examples:</p>
<ul>
<li>rxv-olap-ch-master-sh01-r01:
<ul>
<li>rxv - location (rack#15)</li>
<li>olap - product name</li>
<li>ch = clickhouse</li>
<li>master = stage</li>
<li>sh01 = shard 1</li>
<li>r01 = replica 1</li>
</ul>
</li>
<li>hetnzerde1-ch-prod-01.local:
<ul>
<li>hetnzerde1 - location (also replica id)</li>
<li>ch = clickhouse</li>
<li>prod = stage</li>
<li>01 - server number / shard number in that DC</li>
</ul>
</li>
<li>sh01.ch-front.dev.aws-east1a.example.com:
<ul>
<li>sh01 - shard 01</li>
<li>ch-front - cluster name</li>
<li>dev = stage</li>
<li>aws = cloud provider</li>
<li>east1a = region and availability zone</li>
</ul>
</li>
</ul>
<h4 id="host-name-references"><strong>Host Name References</strong></h4>
<ul>
<li><a href="https://stackoverflow.com/a/39336460/1555175" target="_blank">What are the best practices for domain names (dev, staging, production)?</a></li>
<li><a href="https://www.replex.io/blog/9-best-practices-and-examples-for-working-with-kubernetes-labels" target="_blank">9 Best Practices and Examples for Working with Kubernetes Labels</a></li>
<li><a href="https://devcentral.f5.com/s/articles/thoughts-on-hostname-nomenclature" target="_blank">Thoughts On Hostname Nomenclature</a></li>
</ul>
<h3 id="additional-hostname-tips"><strong>Additional Hostname Tips</strong></h3>
<ul>
<li>Hostnames configured on the server should not change. If you do need to change the host name, one reference to use is <a href="https://linuxize.com/post/how-to-change-hostname-on-ubuntu-18-04/" target="_blank">How to Change Hostname on Ubuntu 18.04</a>.</li>
<li>The server should be accessible to other servers in the cluster via it’s hostname. Otherwise you will need to configure interserver_hostname in your config.</li>
<li>Ensure that <code>hostname --fqdn</code> and <code>getent hosts $(hostname --fqdn)</code> return the correct name and ip.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-79036a2f9b1596d53a92b5746e36394e">33.7 - Version Upgrades</h1>
    <div class="lead">Version Upgrades</div>
	<p>Update itself is simple: update packages, restart clickhouse-server service afterwards.</p>
<ol>
<li>Check if the version you want to upgrade to is stable. We highly recommend the Altinity ClickHouse Stable Releases.
<ol>
<li>Review the changelog to ensure that no configuration changes are needed.</li>
</ol>
</li>
<li>Update staging and test to verify all systems are working.</li>
<li>Prepare and test downgrade procedures so the server can be returned to the previous version if necessary.</li>
<li>Start with a “canary” update. This is one replica with one shard that is upgraded to make sure that the procedure works.</li>
<li>Test and verify that everything works properly. Check for any errors in the log files.</li>
<li>If everything is working well, update the rest of the cluster.</li>
</ol>
<p>For small clusters, the <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html" target="_blank">BlueGreenDeployment technique</a> is also a good option.</p>
<hr>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-13df9db0c6033eb5e2bfdfb7089294a2">34 - Replication queue</h1>
    <div class="lead">Replication queue</div>
	<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">last_exception</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postpone_reason</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">create_time</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">last_attempt_time</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">last_postpone_time</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">num_postponed</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_postponed</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">num_tries</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_tries</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">num_tries</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">min_tries</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">countIf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">last_exception</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">count_err</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">countIf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">num_postponed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">count_postponed</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">countIf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is_currently_executing</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">count_executing</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">count_all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replication_queue</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">count_all</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b49d062b4f5879d725ccb9b4aedf0f07">35 - Schema migration tools for ClickHouse</h1>
    <div class="lead">Schema migration tools for ClickHouse</div>
	<ul>
<li>golang-migrate tool - see <a href="golang-migrate">golang-migrate</a></li>
<li>bytebase
<ul>
<li><a href="https://bytebase.com" target="_blank">https://bytebase.com</a></li>
</ul>
</li>
<li>Flyway - there are a lot of PRs introducing ClickHouse support, maintainer doesn&rsquo;t merge them (maybe he will change his mind soon), but&rsquo;s it&rsquo;s not hard to build flyway from one of those PRs (latest at the top)
<ul>
<li><a href="https://github.com/flyway/flyway/pull/3333" target="_blank">https://github.com/flyway/flyway/pull/3333</a> Сlickhouse support</li>
<li><a href="https://github.com/flyway/flyway/pull/3134" target="_blank">https://github.com/flyway/flyway/pull/3134</a> Сlickhouse support</li>
<li><a href="https://github.com/flyway/flyway/pull/3133" target="_blank">https://github.com/flyway/flyway/pull/3133</a> Add support clickhouse</li>
<li><a href="https://github.com/flyway/flyway/pull/2981" target="_blank">https://github.com/flyway/flyway/pull/2981</a> Clickhouse replicated</li>
<li><a href="https://github.com/flyway/flyway/pull/2640" target="_blank">https://github.com/flyway/flyway/pull/2640</a> Yet another ClickHouse support</li>
<li><a href="https://github.com/flyway/flyway/pull/2166" target="_blank">https://github.com/flyway/flyway/pull/2166</a> Clickhouse support (#1772)</li>
<li><a href="https://github.com/flyway/flyway/pull/1773" target="_blank">https://github.com/flyway/flyway/pull/1773</a> Fixed #1772: Add support for ClickHouse (<a href="https://clickhouse.yandex/" target="_blank">https://clickhouse.yandex/</a>)</li>
</ul>
</li>
<li>liquibase
<ul>
<li><a href="https://github.com/mediarithmics/liquibase-clickhouse" target="_blank">https://github.com/mediarithmics/liquibase-clickhouse</a></li>
<li><a href="https://johntipper.org/how-to-execute-liquibase-changesets-against-clickhouse/" target="_blank">https://johntipper.org/how-to-execute-liquibase-changesets-against-clickhouse/</a></li>
</ul>
</li>
<li>custom tool for ClickHouse
<ul>
<li><a href="https://github.com/delium/clickhouse-migrator" target="_blank">https://github.com/delium/clickhouse-migrator</a></li>
</ul>
</li>
<li>phpMigrations
<ul>
<li><a href="https://github.com/smi2/phpMigrationsClickhouse" target="_blank">https://github.com/smi2/phpMigrationsClickhouse</a></li>
<li><a href="https://habrahabr.ru/company/smi2/blog/317682/" target="_blank">https://habrahabr.ru/company/smi2/blog/317682/</a></li>
</ul>
</li>
<li>dbmate
<ul>
<li><a href="https://github.com/amacneil/dbmate#clickhouse" target="_blank">https://github.com/amacneil/dbmate#clickhouse</a></li>
</ul>
</li>
</ul>
<p>know more?</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f4359fae9928fc2ceb30bfc0e2c0b8d2">35.1 - golang-migrate</h1>
    <div class="lead">golang-migrate</div>
	<h3 id="migrate"><code>migrate</code></h3>
<p><code>migrate</code> is a simple schema migration tool written in golang. No external dependencies are required (like interpreter, jre), only one platform-specific executable. <a href="https://github.com/golang-migrate/migrate" target="_blank">golang-migrate/migrate</a></p>
<p><code>migrate</code> supports several databases, including ClickHouse (support was introduced by <a href="https://github.com/kshvakov" target="_blank">@kshvakov</a>).</p>
<p>To store information about migrations state <code>migrate</code> creates one additional table in target database, by default that table is called <code>schema_migrations</code>.</p>
<h4 id="install">Install</h4>
<p><a href="https://github.com/golang-migrate/migrate/releases" target="_blank">download</a> the <code>migrate</code> executable for your platform and put it to the folder listed in your %PATH.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#wget https://github.com/golang-migrate/migrate/releases/download/v3.2.0/migrate.linux-amd64.tar.gz</span>
</span></span><span style="display:flex;"><span>wget https://github.com/golang-migrate/migrate/releases/download/v4.14.1/migrate.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar -xzf migrate.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>mkdir -p ~/bin
</span></span><span style="display:flex;"><span>mv migrate.linux-amd64 ~/bin/migrate
</span></span><span style="display:flex;"><span>rm migrate.linux-amd64.tar.gz
</span></span></code></pre></div><h4 id="sample-usage">Sample usage</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir migrations
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;create table test(id UInt8) Engine = Memory;&#39;</span> &gt; migrations/000001_my_database_init.up.sql
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;DROP TABLE test;&#39;</span> &gt; migrations/000001_my_database_init.down.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># you can also auto-create file with new migrations with automatic numbering like that:</span>
</span></span><span style="display:flex;"><span>migrate create -dir migrations -seq -digits <span style="color:#0000cf;font-weight:bold">6</span> -ext sql my_database_init
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>edit migrations/000001_my_database_init.up.sql <span style="color:#000;font-weight:bold">&amp;</span> migrations/000001_my_database_init.down.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>migrate -database <span style="color:#4e9a06">&#39;clickhouse://localhost:9000&#39;</span> -path ./migrations up
</span></span><span style="display:flex;"><span>1/u my_database_init <span style="color:#ce5c00;font-weight:bold">(</span>6.502974ms<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>migrate -database <span style="color:#4e9a06">&#39;clickhouse://localhost:9000&#39;</span> -path ./migrations down
</span></span><span style="display:flex;"><span>1/d my_database_init <span style="color:#ce5c00;font-weight:bold">(</span>2.164394ms<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># clears the database (use carefully - will not ask any confirmations)</span>
</span></span><span style="display:flex;"><span>➜ migrate -database <span style="color:#4e9a06">&#39;clickhouse://localhost:9000&#39;</span> -path ./migrations drop
</span></span></code></pre></div><h4 id="connection-string-format">Connection string format</h4>
<p><code>clickhouse://host:port?username=user&amp;password=qwerty&amp;database=clicks</code></p>
<table>
<thead>
<tr>
<th style="text-align:left">URL Query</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>x-migrations-table</code></td>
<td style="text-align:left">Name of the migrations table</td>
</tr>
<tr>
<td style="text-align:left"><code>database</code></td>
<td style="text-align:left">The name of the database to connect to</td>
</tr>
<tr>
<td style="text-align:left"><code>username</code></td>
<td style="text-align:left">The user to sign in as</td>
</tr>
<tr>
<td style="text-align:left"><code>password</code></td>
<td style="text-align:left">The user&rsquo;s password</td>
</tr>
<tr>
<td style="text-align:left"><code>host</code></td>
<td style="text-align:left">The host to connect to.</td>
</tr>
<tr>
<td style="text-align:left"><code>port</code></td>
<td style="text-align:left">The port to bind to.</td>
</tr>
<tr>
<td style="text-align:left"><code>secure</code></td>
<td style="text-align:left">to use a secure connection (for self-signed also add <code>skip_verify=1</code>)</td>
</tr>
</tbody>
</table>
<h4 id="replicated--distributed--cluster-environments">Replicated / Distributed / Cluster environments</h4>
<p>By default <code>migrate</code> create table <code>schema_migrations</code> with the following structure</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">schema_migrations</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">dirty</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">sequence</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt64</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TinyLog</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>That allows storing version of schema locally.</p>
<p>If you need to use <code>migrate</code> in some multi server environment (replicated / cluster) you should create <code>schema_migrations</code> manually with the same structure and with the appropriate Engine (Replicated / Distributed), otherwise, other servers will not know the version of the DB schema. As an alternative you can force the current version number on another server manually, like that:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>migrate -database <span style="color:#4e9a06">&#39;clickhouse://localhost:9000&#39;</span> -path ./migrations force <span style="color:#0000cf;font-weight:bold">123456</span> <span style="color:#8f5902;font-style:italic"># force version 123456</span>
</span></span></code></pre></div><h4 id="known-issues">Known issues</h4>
<p><code>could not load time location: unknown time zone Europe/Moscow in line 0:</code></p>
<p>It&rsquo;s happens due of missing tzdata package in migrate/migrate docker image of golang-migrate.
There is 2 possible solutions:</p>
<ol>
<li>You can build your own golang-migrate image from official with tzdata package.</li>
<li>If you using it as part of your CI you can add installing tzdata package as one of step in CI before using golang-migrate.</li>
</ol>
<p>Related GitHub issues:
<a href="https://github.com/golang-migrate/migrate/issues/494" target="_blank">https://github.com/golang-migrate/migrate/issues/494</a>
<a href="https://github.com/golang-migrate/migrate/issues/201" target="_blank">https://github.com/golang-migrate/migrate/issues/201</a></p>
<p>Using database name in <code>x-migrations-table</code></p>
<ol>
<li>Creates table with <code>database.table</code></li>
<li>When running migrations migrate actually uses database from query settings and encapsulate <code>database.table</code> as table name: ``other_database.`database.table```</li>
</ol>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ef428242bace20ed80fc2a5a94cbc2e1">36 - Server config files</h1>
    <div class="lead">How to manage server config files in Clickhouse</div>
	<h2 id="сonfig-management-recommended-structure">Сonfig management (recommended structure)</h2>
<p>Clickhouse server config consists of two parts server settings (config.xml) and users settings (users.xml).</p>
<p>By default they are stored in the folder <strong>/etc/clickhouse-server/</strong> in two files config.xml &amp; users.xml.</p>
<p>We suggest never change vendor config files and place your changes into separate .xml files in sub-folders. This way is easier to maintain and ease Clickhouse upgrades.</p>
<p><strong>/etc/clickhouse-server/users.d</strong> – sub-folder for user settings.</p>
<p><strong>/etc/clickhouse-server/config.d</strong> – sub-folder for server settings.</p>
<p><strong>/etc/clickhouse-server/conf.d</strong> – sub-folder for any (both) settings.</p>
<p>File names of your xml files can be arbitrary but they are applied in alphabetical order.</p>
<p>Examples:</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/config.d/listen_host.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;yandex&gt;
  &lt;listen_host&gt;::&lt;/listen_host&gt;
&lt;/yandex&gt;


$ cat /etc/clickhouse-server/config.d/macros.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;yandex&gt;
  &lt;macros&gt;
    &lt;cluster&gt;test&lt;/cluster&gt;
    &lt;replica&gt;host22&lt;/replica&gt;
    &lt;shard&gt;0&lt;/shard&gt;
    &lt;server_id&gt;41295&lt;/server_id&gt;
    &lt;server_name&gt;host22.server.com&lt;/server_name&gt;
  &lt;/macros&gt;
&lt;/yandex&gt;

cat /etc/clickhouse-server/config.d/zoo.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;yandex&gt;
  &lt;zookeeper&gt;
    &lt;node&gt;
      &lt;host&gt;localhost&lt;/host&gt;
      &lt;port&gt;2181&lt;/port&gt;
    &lt;/node&gt;
  &lt;/zookeeper&gt;
  &lt;distributed_ddl&gt;
    &lt;path&gt;/clickhouse/test/task_queue/ddl&lt;/path&gt;
  &lt;/distributed_ddl&gt;
&lt;/yandex&gt;

cat /etc/clickhouse-server/users.d/enable_access_management_for_user_default.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;yandex&gt;
  &lt;users&gt;
    &lt;default&gt;
      &lt;access_management&gt;1&lt;/access_management&gt;
    &lt;/default&gt;
  &lt;/users&gt;
&lt;/yandex&gt;

cat /etc/clickhouse-server/users.d/memory_usage.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;yandex&gt;
    &lt;profiles&gt;
        &lt;default&gt;
            &lt;max_bytes_before_external_group_by&gt;25290221568&lt;/max_bytes_before_external_group_by&gt;
            &lt;max_memory_usage&gt;50580443136&lt;/max_memory_usage&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/yandex&gt;
</code></pre><p>BTW, you can define any macro in your configuration and use them in Zookeeper paths</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span> ReplicatedMergeTree(&#39;/clickhouse/{cluster}/tables/my_table&#39;,&#39;{replica}&#39;)
</span></span></code></pre></div><p>or in your code using function getMacro:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">srv_server_info</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">getMacro</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;shard&#39;</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">shard_num</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">getMacro</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;server_name&#39;</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">server_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">getMacro</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;server_id&#39;</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">server_key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Settings can be appended to an XML tree (default behaviour) or replaced or removed.</p>
<p>Example how to delete <strong>tcp_port</strong> &amp; <strong>http_port</strong> defined on higher level in the main config.xml (it disables open tcp &amp; http ports if you configured secure ssl):</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">cat /etc/clickhouse-server/config.d/disable_open_network.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
  &lt;http_port remove=&#34;1&#34;/&gt;
  &lt;tcp_port remove=&#34;1&#34;/&gt;
&lt;/yandex&gt;
</code></pre><p>Example how to replace <strong>remote_servers</strong> section defined on higher level in the main config.xml (it allows to remove default test clusters.</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;yandex&gt;
  &lt;remote_servers replace=&#34;1&#34;&gt;
    &lt;mycluster&gt;
      ....
    &lt;/mycluster&gt;
  &lt;/remote_servers&gt;
&lt;/yandex&gt;
</code></pre><h2 id="settings--restart">Settings &amp; restart</h2>
<p>General &lsquo;rule of thumb&rsquo;:</p>
<ul>
<li><strong>server</strong> settings (<code>config.xml</code> and <code>config.d</code>) changes <strong>require restart</strong>;</li>
<li><strong>user</strong> settings (<code>users.xml</code> and <code>users.d</code>) changes <strong>don&rsquo;t require restart</strong>.</li>
</ul>
<p>But there are <strong>exceptions</strong> from those rules (see below).</p>
<h3 id="server-config-configxml-sections-which-dont-require-restart">Server config (config.xml) sections which don&rsquo;t require restart</h3>
<ul>
<li><code>&lt;max_server_memory_usage&gt;</code></li>
<li><code>&lt;max_server_memory_usage_to_ram_ratio&gt;</code></li>
<li><code>&lt;max_table_size_to_drop&gt;</code></li>
<li><code>&lt;max_partition_size_to_drop&gt;</code></li>
<li><code>&lt;max_concurrent_queries&gt;</code></li>
<li><code>&lt;macros&gt;</code></li>
<li><code>&lt;remote_servers&gt;</code></li>
<li><code>&lt;dictionaries_config&gt;</code></li>
<li><code>&lt;user_defined_executable_functions_config&gt;</code></li>
<li><code>&lt;models_config&gt;</code></li>
<li><code>&lt;keeper_server&gt;</code></li>
<li><code>&lt;zookeeper&gt;</code> (but reconnect don&rsquo;t happen automatically)</li>
<li><code>&lt;storage_configuration&gt;</code></li>
<li><code>&lt;user_directories&gt;</code></li>
<li><code>&lt;access_control_path&gt;</code></li>
<li><code>&lt;encryption_codecs&gt;</code></li>
<li><code>&lt;logger&gt;</code> (since 21.11)</li>
</ul>
<p>Those sections (live in separate files):</p>
<ul>
<li><code>&lt;dictionaries&gt;</code></li>
<li><code>&lt;functions&gt;</code></li>
<li><code>&lt;models&gt;</code></li>
</ul>
<p>See also <a href="https://github.com/ClickHouse/ClickHouse/blob/445b0ba7cc6b82e69fef28296981fbddc64cd634/programs/server/Server.cpp#L809-L883" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/445b0ba7cc6b82e69fef28296981fbddc64cd634/programs/server/Server.cpp#L809-L883</a></p>
<h3 id="user-settings-which-require-restart">User settings which require restart.</h3>
<p>Most of user setting changes don&rsquo;t require restart, but they get applied at the connect time, so existing connection may still use old user-level settings.
That means that that new setting will be applied to new sessions / after reconnect.</p>
<p>The list of user setting which require server restart:</p>
<ul>
<li><code>&lt;background_buffer_flush_schedule_pool_size&gt;</code></li>
<li><code>&lt;background_pool_size&gt;</code></li>
<li><code>&lt;background_merges_mutations_concurrency_ratio&gt;</code></li>
<li><code>&lt;background_move_pool_size&gt;</code></li>
<li><code>&lt;background_fetches_pool_size&gt;</code></li>
<li><code>&lt;background_common_pool_size&gt;</code></li>
<li><code>&lt;background_schedule_pool_size&gt;</code></li>
<li><code>&lt;background_message_broker_schedule_pool_size&gt;</code></li>
<li><code>&lt;background_distributed_schedule_pool_size&gt;</code></li>
<li><code>&lt;max_replicated_fetches_network_bandwidth_for_server&gt;</code></li>
<li><code>&lt;max_replicated_sends_network_bandwidth_for_server&gt;</code></li>
</ul>
<p>See also <code>select * from system.settings where description ilike '%start%'</code></p>
<p>Also there are several &rsquo;long-running&rsquo; user sessions which are almost never restarted and can keep the setting from the server start (it&rsquo;s DDLWorker, Kafka, and some other service things).</p>
<h2 id="dictionaries">Dictionaries</h2>
<p>We suggest to store each dictionary description in a separate (own) file in a <strong>/etc/clickhouse-server/dict</strong> sub-folder.</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/dict/country.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;dictionaries&gt;
  &lt;dictionary&gt;
    &lt;name&gt;country&lt;/name&gt;
    &lt;source&gt;
      &lt;http&gt;
      ...
  &lt;/dictionary&gt;
&lt;/dictionaries&gt;
</code></pre><p>and add to the configuration</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/config.d/dictionaries.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
  &lt;dictionaries_config&gt;dict/*.xml&lt;/dictionaries_config&gt;
  &lt;dictionaries_lazy_load&gt;true&lt;/dictionaries_lazy_load&gt;
&lt;/yandex&gt;
</code></pre><p><strong>dict/*.xml</strong> – relative path, servers seeks files in the folder <strong>/etc/clickhouse-server/dict</strong>. More info in <a href="altinity-kb-server-config-files.md#Multiple-Clickhouse-instances">Multiple Clickhouse instances</a>.</p>
<h2 id="incl-attribute--metricaxml">incl attribute &amp; metrica.xml</h2>
<p><strong>incl</strong> attribute allows to include some XML section from a special <strong>include</strong> file multiple times.</p>
<p>By default <strong>include</strong> file is <strong>/etc/metrika.xml</strong>. You can use many include files for each XML section.</p>
<p>For example to avoid repetition of user/password for each dictionary you can create an XML file:</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/dict_sources.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
  &lt;mysql_config&gt;
      &lt;port&gt;3306&lt;/port&gt;
      &lt;user&gt;user&lt;/user&gt;
      &lt;password&gt;123&lt;/password&gt;
      &lt;replica&gt;
        &lt;host&gt;mysql_host&lt;/host&gt;
        &lt;priority&gt;1&lt;/priority&gt;
      &lt;/replica&gt;
      &lt;db&gt;my_database&lt;/db&gt;
  &lt;/mysql_config&gt;
&lt;/yandex&gt;
</code></pre><p>Include this file:</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/config.d/dictionaries.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
  ...
  &lt;include_from&gt;/etc/clickhouse-server/dict_sources.xml&lt;/include_from&gt;
&lt;/yandex&gt;
</code></pre><p>And use in dictionary descriptions (<strong>incl=&ldquo;mysql_config&rdquo;</strong>):</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/dict/country.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;dictionaries&gt;
  &lt;dictionary&gt;
    &lt;name&gt;country&lt;/name&gt;
    &lt;source&gt;
        &lt;mysql incl=&#34;mysql_config&#34;&gt;
            &lt;table&gt;my_table&lt;/table&gt;
            &lt;invalidate_query&gt;select max(id) from my_table&lt;/invalidate_query&gt;
        &lt;/mysql&gt;
    &lt;/source&gt;
      ...
  &lt;/dictionary&gt;
&lt;/dictionaries&gt;
</code></pre><h2 id="multiple-clickhouse-instances-at-one-host">Multiple Clickhouse instances at one host</h2>
<p>By default Clickhouse server configs are in <strong>/etc/clickhouse-server/</strong> because clickhouse-server runs with a parameter <strong>&ndash;config-file /etc/clickhouse-server/config.xml</strong></p>
<p><strong>config-file</strong> is defined in startup scripts:</p>
<ul>
<li><strong>/etc/init.d/clickhouse-server</strong> – init-V</li>
<li><strong>/etc/systemd/system/clickhouse-server.service</strong> – systemd</li>
</ul>
<p>Clickhouse uses the path from <strong>config-file</strong> parameter as base folder and seeks for other configs by relative path. All sub-folders <strong>users.d / config.d</strong> are relative.</p>
<p>You can start multiple <strong>clickhouse-server</strong> each with own <strong>&ndash;config-file.</strong></p>
<p>For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/bin/clickhouse-server --config-file /etc/clickhouse-server-node1/config.xml
</span></span><span style="display:flex;"><span>  /etc/clickhouse-server-node1/  config.xml ... users.xml
</span></span><span style="display:flex;"><span>  /etc/clickhouse-server-node1/config.d/disable_open_network.xml
</span></span><span style="display:flex;"><span>  /etc/clickhouse-server-node1/users.d/....
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/usr/bin/clickhouse-server --config-file /etc/clickhouse-server-node2/config.xml
</span></span><span style="display:flex;"><span>  /etc/clickhouse-server-node2/   config.xml ... users.xml
</span></span><span style="display:flex;"><span>  /etc/clickhouse-server-node2/config.d/disable_open_network.xml
</span></span><span style="display:flex;"><span>  /etc/clickhouse-server-node2/users.d/....
</span></span></code></pre></div><p>If you need to run multiple servers for CI purposes you can combine all settings in a single fat XML file and start ClickHouse without config folders/sub-folders.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/bin/clickhouse-server --config-file /tmp/ch1.xml
</span></span><span style="display:flex;"><span>/usr/bin/clickhouse-server --config-file /tmp/ch2.xml
</span></span><span style="display:flex;"><span>/usr/bin/clickhouse-server --config-file /tmp/ch3.xml
</span></span></code></pre></div><p>Each ClickHouse instance must work with own <strong>data-folder</strong> and <strong>tmp-folder</strong>.</p>
<p>By default ClickHouse uses <strong>/var/lib/clickhouse/</strong>. It can be overridden in path settings</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;path&gt;</span>/data/clickhouse-ch1/<span style="color:#204a87;font-weight:bold">&lt;/path&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;tmp_path&gt;</span>/data/clickhouse-ch1/tmp/<span style="color:#204a87;font-weight:bold">&lt;/tmp_path&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;user_files_path&gt;</span>/data/clickhouse-ch1/user_files/<span style="color:#204a87;font-weight:bold">&lt;/user_files_path&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;local_directory&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;path&gt;</span>/data/clickhouse-ch1/access/<span style="color:#204a87;font-weight:bold">&lt;/path&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;/local_directory&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;format_schema_path&gt;</span>/data/clickhouse-ch1/format_schemas/<span style="color:#204a87;font-weight:bold">&lt;/format_schema_path&gt;</span>
</span></span></code></pre></div><h2 id="preprocessed_configs">preprocessed_configs</h2>
<p>Clickhouse server watches config files and folders. When you change, add or remove XML files Clickhouse immediately assembles XML files into a combined file. These combined files are stored in <strong>/var/lib/clickhouse/preprocessed_configs/</strong> folders.</p>
<p>You can verify that your changes are valid by checking <strong>/var/lib/clickhouse/preprocessed_configs/config.xml</strong>, <strong>/var/lib/clickhouse/preprocessed_configs/users.xml</strong>.</p>
<p>If something wrong with with your settings e.g. unclosed XML element or typo you can see alerts about this mistakes in <strong>/var/log/clickhouse-server/clickhouse-server.log</strong></p>
<p>If you see your changes in <strong>preprocessed_configs</strong> it does not mean that changes are applied on running server, check <a href="altinity-kb-server-config-files.md#Settings-%26--restart">Settings &amp;amp; restart</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3ea70b58bc10fe6596f9888998227ac9">37 - Settings to adjust</h1>
    <div class="lead">Settings to adjust</div>
	<ol>
<li>
<p><code>query_log</code> and other <code>_log</code> tables - set up TTL, or some other cleanup procedures.</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">cat /etc/clickhouse-server/config.d/query_log.xml
&lt;yandex&gt;
    &lt;query_log replace=&#34;1&#34;&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;query_log&lt;/table&gt;
        &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;
        &lt;engine&gt;
ENGINE = MergeTree
PARTITION BY event_date
ORDER BY (event_time)
TTL event_date + interval 90 day
SETTINGS ttl_only_drop_parts=1
        &lt;/engine&gt;
    &lt;/query_log&gt;
&lt;/yandex&gt;
</code></pre></li>
<li>
<p><code>query_thread_log</code> - typically is not too useful for end users, you can disable it (or set up TTL).</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">cat /etc/clickhouse-server/config.d/disable_query_thread_log.xml
&lt;yandex&gt;
    &lt;query_thread_log remove=&#34;1&#34; /&gt;
&lt;/yandex&gt;
</code></pre></li>
<li>
<p>If you have a good monitoring outside ClickHouse you don&rsquo;t need to store the history of metrics in ClickHouse</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">cat /etc/clickhouse-server/config.d/disable_metric_logs.xml
&lt;yandex&gt;
    &lt;metric_log remove=&#34;1&#34; /&gt;
    &lt;asynchronous_metric_log remove=&#34;1&#34; /&gt;
&lt;/yandex&gt;
</code></pre></li>
<li>
<p><code>part_log</code> - may be nice, especially at the beginning / during system tuning/analyze.</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">cat /etc/clickhouse-server/config.d/part_log.xml
&lt;yandex&gt;
    &lt;part_log replace=&#34;1&#34;&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;part_log&lt;/table&gt;
        &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;
        &lt;engine&gt;
ENGINE = MergeTree
PARTITION BY toYYYYMM(event_date)
ORDER BY (event_time)
TTL toStartOfMonth(event_date) + INTERVAL 3 MONTH
SETTINGS ttl_only_drop_parts=1
        &lt;/engine&gt;
    &lt;/part_log&gt;
&lt;/yandex&gt;
</code></pre></li>
<li>
<p>on older versions <code>log_queries</code> is disabled by default, it&rsquo;s worth having it enabled always.</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/users.d/log_queries.xml
&lt;yandex&gt;
    &lt;profiles&gt;
        &lt;default&gt;
            &lt;log_queries&gt;1&lt;/log_queries&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/yandex&gt;
</code></pre></li>
<li>
<p>quite often you want to have on-disk group by / order by enabled (both disabled by default).</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">cat /etc/clickhouse-server/users.d/enable_on_disk_operations.xml
&lt;yandex&gt;
    &lt;profiles&gt;
        &lt;default&gt;
           &lt;max_bytes_before_external_group_by&gt;2000000000&lt;/max_bytes_before_external_group_by&gt;
           &lt;max_bytes_before_external_sort&gt;2000000000&lt;/max_bytes_before_external_sort&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/yandex&gt;
</code></pre></li>
<li>
<p>quite often you want to create more users with different limitations.
The most typical is <code>&lt;max_execution_time&gt;</code>
It&rsquo;s actually also not a way to plan/share existing resources better, but it at least disciplines users.</p>
<p>Also introducing some <a href="https://clickhouse.tech/docs/en/operations/settings/query-complexity/" target="_blank">restrictions on query complexity</a> can be a good option to discipline users.</p>
<p>You can find the preset example <a href="https://clickhouse.tech/docs/en/operations/settings/settings-profiles/" target="_blank">here</a>.
Also, force_index_by_date + force_primary_key can be a nice idea to avoid queries that &lsquo;accidentally&rsquo; do full scans, max_concurrent_queries_for_user</p>
</li>
<li>
<p>merge_tree settings: <code>max_bytes_to_merge_at_max_space_in_pool</code> (may be reduced in some scenarios), <code>fsync_*</code> , <code>inactive_parts_to_throw_insert</code> - can be enabled, <code>replicated_deduplication_window</code> - can be extended if single insert create lot of parts , <code>merge_with_ttl_timeout</code> - when you use ttl</p>
</li>
<li>
<p>settings <code>default_database_engine</code> / <code>insert_distributed_sync</code> / <code>fsync_metadata</code> / <code>do_not_merge_across_partitions_select_final</code> / fsync</p>
</li>
<li>
<p>memory usage per server / query / user: <a href="altinity-kb-memory-configuration-settings.md">memory configuration settings</a></p>
</li>
</ol>
<p>See also:</p>
<p><a href="https://docs.altinity.com/operationsguide/security/clickhouse-hardening-guide/" target="_blank">https://docs.altinity.com/operationsguide/security/clickhouse-hardening-guide/</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f46a585ead49a5db2d19ee263d652ffa">38 - Shutting down a node</h1>
    <div class="lead">Shutting down a node</div>
	<p>It’s possible to shutdown server on fly, but that would lead to failure of some queries.</p>
<p>More safer way:</p>
<ul>
<li>
<p>Remove server (which is going to be disabled) from remote_server section of config.xml on all servers.</p>
</li>
<li>
<p>Remove server from load balancer, so new queries wouldn’t hit it.</p>
</li>
<li>
<p>Detach Kafka / Rabbit / Buffer tables (if used), and Materialized* databases.</p>
</li>
<li>
<p>Wait until all already running queries would finish execution on it.
It’s possible to check it via query:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SHOW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PROCESSLIST</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Ensure there is no pending data in distributed tables</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">distribution_queue</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FLUSH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DISTRIBUTED</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Run sync replica query in related shard replicas (others than the one you remove) via query:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SYNC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Shutdown server.</p>
</li>
</ul>
<p><code>SYSTEM SHUTDOWN</code> query doesn’t wait until query completion and tries to kill all queries immediately after receiving signal, even if setting <code>shutdown_wait_unfinished</code> being used.</p>
<p><a href="https://github.com/ClickHouse/ClickHouse/blob/master/programs/server/Server.cpp#L1353" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/master/programs/server/Server.cpp#L1353</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ea9b4077205d7c579bd465b784e33e77">39 - SSL connection unexpectedly closed</h1>
    <div class="lead">SSL connection unexpectedly closed</div>
	<p>ClickHouse doesn&rsquo;t probe CA path which is default on CentOS and Amazon Linux.</p>
<h2 id="clickhouse-client">ClickHouse client</h2>
<pre tabindex="0"><code class="language-markup" data-lang="markup">cat /etc/clickhouse-client/conf.d/openssl-ca.xml
&lt;config&gt;
    &lt;openSSL&gt;
        &lt;client&gt; &lt;!-- Used for connection to server&#39;s secure tcp port --&gt;
            &lt;caConfig&gt;/etc/ssl/certs&lt;/caConfig&gt;
        &lt;/client&gt;
    &lt;/openSSL&gt;
&lt;/config&gt;
</code></pre><h2 id="clickhouse-server">ClickHouse server</h2>
<pre tabindex="0"><code class="language-markup" data-lang="markup">cat /etc/clickhouse-server/conf.d/openssl-ca.xml
&lt;config&gt;
    &lt;openSSL&gt;
        &lt;server&gt;  &lt;!-- Used for https server AND secure tcp port --&gt;
            &lt;caConfig&gt;/etc/ssl/certs&lt;/caConfig&gt;
        &lt;/server&gt;
        &lt;client&gt;  &lt;!-- Used for connecting to https dictionary source and secured Zookeeper communication --&gt;
            &lt;caConfig&gt;/etc/ssl/certs&lt;/caConfig&gt;
        &lt;/client&gt;
    &lt;/openSSL&gt;
&lt;/config&gt;
</code></pre><p><a href="https://github.com/ClickHouse/ClickHouse/issues/17803" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/17803</a></p>
<p><a href="https://github.com/ClickHouse/ClickHouse/issues/18869" target="_blank">https://github.com/ClickHouse/ClickHouse/issues/18869</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ec43a5205301eb00c48712282b7243ed">40 - Suspiciously many broken parts</h1>
    <div class="lead">Suspiciously many broken parts error during the server startup.</div>
	<h2 id="symptom">Symptom:</h2>
<p>clickhouse don&rsquo;t start with a message <code>DB::Exception: Suspiciously many broken parts to remove.</code></p>
<h2 id="cause">Cause:</h2>
<p>That exception is just a safeguard check/circuit breaker, triggered when clickhouse detects a lot of broken parts during server startup.</p>
<p>Parts are considered broken if they have bad checksums or some files are missing or malformed. Usually, that means the data was corrupted on the disk.</p>
<p>Why data could be corrupted?</p>
<ol>
<li>
<p>the most often reason is a hard restart of the system, leading to a loss of the data which was not fully flushed to disk from the system page cache. Please be aware that by default ClickHouse doesn&rsquo;t do fsync, so data is considered inserted after it was passed to the Linux page cache. See fsync-related settings in ClickHouse.</p>
</li>
<li>
<p>it can also be caused by disk failures, maybe there are bad blocks on hard disk, or logical problems, or some raid issue. Check system journals, use <code>fsck</code> / <code>mdadm</code> and other standard tools to diagnose the disk problem.</p>
</li>
<li>
<p>other reasons: manual intervention/bugs etc, for example, the data files or folders are removed by mistake or moved to another folder.</p>
</li>
</ol>
<h2 id="action">Action:</h2>
<ol>
<li>
<p>If you ok to accept the data loss: set up <code>force_restrore_data</code> flag and clickhouse will move the parts to detached.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
</span></span></code></pre></div><p>then restart clickhouse, the table will be attached, and the broken parts will be detached, which means the data from those parts will not be available for the selects. You can see the list of those parts in the <code>system.detached_parts</code> table and drop them if needed using <code>ALTER TABLE ...  DROP DETACHED PART ...</code> commands.</p>
<p>If you are ok to tolerate bigger losses automatically you can change that safeguard configuration to be less sensitive by increasing <code>max_suspicious_broken_parts</code> setting:</p>
<pre tabindex="0"><code>cat /etc/clickhouse-server/config.d/max_suspicious_broken_parts.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
     &lt;merge_tree&gt;
         &lt;max_suspicious_broken_parts&gt;50&lt;/max_suspicious_broken_parts&gt;
     &lt;/merge_tree&gt;
&lt;/yandex&gt;
</code></pre><p>this limit is set to 10 by default, we can set a bigger value (50 or 100 or more), but the data will lose because of the corruption.</p>
<p>Check also a similar setting <code>max_suspicious_broken_parts_bytes</code>.<br>
See <a href="https://clickhouse.com/docs/en/operations/settings/merge-tree-settings/" target="_blank">https://clickhouse.com/docs/en/operations/settings/merge-tree-settings/</a></p>
</li>
<li>
<p>If you can&rsquo;t accept the data loss - you should recover data from backups / re-insert it once again etc.</p>
<p>If you don&rsquo;t want to tolerate automatic detaching of broken parts, you can set <code>max_suspicious_broken_parts_bytes</code> and <code>max_suspicious_broken_parts</code> to 0.</p>
</li>
</ol>
<h2 id="scenario-illustrating--testing">Scenario illustrating / testing</h2>
<ol>
<li>Create table</li>
</ol>
<pre tabindex="0"><code>create table t111(A UInt32) Engine=MergeTree order by A settings max_suspicious_broken_parts=1;
insert into t111 select number from numbers(100000);
</code></pre><ol start="2">
<li>Detach the table and make Data corruption</li>
</ol>
<pre tabindex="0"><code>detach table t111;
</code></pre><p>cd /var/lib/clickhouse/data/default/t111/all_***
make data file corruption:</p>
<pre tabindex="0"><code>&gt; data.bin
</code></pre><p>repeat for 2 or more data files.</p>
<ol start="3">
<li>Attach the table:</li>
</ol>
<pre tabindex="0"><code>attach table t111;
 
Received exception from server (version 21.12.3):
Code: 231. DB::Exception: Received from localhost:9000. DB::Exception: Suspiciously many (2) broken parts to remove.. (TOO_MANY_UNEXPEC
</code></pre><ol start="4">
<li>setup force_restrore_data flag</li>
</ol>
<pre tabindex="0"><code>sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
sudo service clickhouse-server restart
</code></pre><p>then the table <code>t111</code> will be attached lost the corrupted data.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e64ef5a4f506fd394e7168728f58b04b">41 - System tables eat my disk</h1>
    <div class="lead">System tables eat my disk</div>
	<blockquote>
<p><strong>Note 1:</strong> System database stores virtual tables (<strong>parts</strong>, <strong>tables,</strong> <strong>columns, etc.</strong>) and *<strong>_log</strong> tables.</p>
<p>Virtual tables do not persist on disk. They reflect ClickHouse memory (c++ structures). They cannot be changed or removed.</p>
<p>Log tables are named with postfix *<strong>_log</strong> and have the MergeTree engine.</p>
<p>You can drop / rename / truncate *<strong>_log</strong> tables at any time. ClickHouse will recreate them in about 7 seconds (flush period).</p>
</blockquote>
<blockquote>
<p><strong>Note 2:</strong> Log tables with numeric postfixes (_1 / 2 / 3 &hellip;) <code>query_log_1 query_thread_log_3</code> are results of Clickhouse upgrades. When a new version of Clickhouse starts and discovers that a system log table&rsquo;s schema is incompatible with a new schema, then Clickhouse renames the old *_log table to the name with the prefix and creates a table with the new schema. You can drop such tables if you don&rsquo;t need such historic data.</p>
</blockquote>
<h2 id="you-can-disable-all--any-of-them">You can disable all / any of them</h2>
<p>Do not create log tables at all (a restart is needed for these changes to take effect).</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/config.d/z_log_disable.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;asynchronous_metric_log remove=&#34;1&#34;/&gt;
    &lt;metric_log remove=&#34;1&#34;/&gt;
    &lt;query_thread_log remove=&#34;1&#34; /&gt;  
    &lt;query_log remove=&#34;1&#34; /&gt;
    &lt;query_views_log remove=&#34;1&#34; /&gt;
    &lt;part_log remove=&#34;1&#34;/&gt;
    &lt;session_log remove=&#34;1&#34;/&gt;
    &lt;text_log remove=&#34;1&#34; /&gt;
    &lt;trace_log remove=&#34;1&#34;/&gt;
    &lt;crash_log remove=&#34;1&#34;/&gt;
    &lt;opentelemetry_span_log remove=&#34;1&#34;/&gt;
    &lt;zookeeper_log remove=&#34;1&#34;/&gt;
&lt;/yandex&gt;
</code></pre><p><strong>We do not recommend removing <code>query_log</code> and <code>query_thread_log</code> as queries&rsquo; (they have very useful information for debugging), and logging can be easily turned off without a restart through user profiles:</strong></p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/users.d/z_log_queries.xml
&lt;yandex&gt;
    &lt;profiles&gt;
        &lt;default&gt;
            &lt;log_queries&gt;0&lt;/log_queries&gt; &lt;!-- normally it&#39;s better to keep it turned on! --&gt;
            &lt;log_query_threads&gt;0&lt;/log_query_threads&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/yandex&gt;
</code></pre><p>Hint: <code>z_log_disable.xml</code> is named with <strong>z_</strong> in the beginning, it means this config will be applied the last and will override all other config files with these sections (config are applied in alphabetical order).</p>
<p>You can also configure these settings to reduce the amount of data in the <code>system.query_log</code> table:</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">name                              | value       | description                                                                                                                                                       
----------------------------------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------
log_queries_min_type              | QUERY_START | Minimal type in query_log to log, possible values (from low to high): QUERY_START, QUERY_FINISH, EXCEPTION_BEFORE_START, EXCEPTION_WHILE_PROCESSING.
log_queries_min_query_duration_ms | 0           | Minimal time for the query to run, to get to the query_log/query_thread_log.
log_queries_cut_to_length         | 100000      | If query length is greater than specified threshold (in bytes), then cut query when writing to query log. Also limit length of printed query in ordinary text log.
log_profile_events                | 1           | Log query performance statistics into the query_log and query_thread_log.
log_query_settings                | 1           | Log query settings into the query_log.
log_queries_probability           | 1           | Log queries with the specified probabality.
</code></pre><h2 id="you-can-configure-ttl">You can configure TTL</h2>
<p>Example for <code>query_log</code>. It drops partitions with data older than 14 days:</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/config.d/query_log_ttl.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;query_log&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;query_log&lt;/table&gt;
        &lt;engine&gt;ENGINE = MergeTree PARTITION BY (event_date)
                ORDER BY (event_time)
                TTL event_date + INTERVAL 14 DAY DELETE
                SETTINGS ttl_only_drop_parts=1
        &lt;/engine&gt;
        &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;
    &lt;/query_log&gt;
&lt;/yandex&gt;
</code></pre><p>After that you need to restart ClickHouse and drop or rename the existing system.query_log table, then CH creates a new table with these settings.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">query_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">query_log_1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Important part here is a daily partitioning <code>PARTITION BY (event_date)</code> and <code>ttl_only_drop_parts=1</code>. In this case ClickHouse drops whole partitions. Dropping of partitions is very easy operation for CPU / Disk I/O.</p>
<p>Usual TTL (without <code>ttl_only_drop_parts=1</code>) is heavy CPU / Disk I/O consuming operation which re-writes data parts without expired rows.</p>
<p>You can add TTL without ClickHouse restart (and table dropping or renaming):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">query_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">MODIFY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SETTING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ttl_only_drop_parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">query_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">MODIFY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TTL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">event_date</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTERVAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DAY</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>But in this case ClickHouse will drop only whole monthly partitions (will store data older than 14 days).</p>
<h2 id="one-more-way-to-configure-ttl-for-system-tables">One more way to configure TTL for system tables</h2>
<p>This way just adds TTL to a table and leaves monthly (default) partitioning (will store data older than 14 days).</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">$ cat /etc/clickhouse-server/config.d/query_log_ttl.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;query_log&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;query_log&lt;/table&gt;
        &lt;ttl&gt;event_date + INTERVAL 30 DAY DELETE&lt;/ttl&gt;
    &lt;/query_log&gt;
&lt;/yandex&gt;
</code></pre><p>After that you need to restart ClickHouse and drop or rename the existing system.query_log table, then CH creates a new table with this TTL setting.</p>
<h2 id="you-can-disable-logging-on-a-session-level-or-in-users-profile-for-all-or-specific-users">You can disable logging on a session level or in user’s profile (for all or specific users)</h2>
<p>But only for logs generated on session level (<code>query_log</code> / <code>query_thread_log</code>)</p>
<p>In this case a restart is not needed.</p>
<p>Let’s disable query logging for all users (profile = default, all other profiles inherit it).</p>
<pre tabindex="0"><code class="language-markup" data-lang="markup">cat /etc/clickhouse-server/users.d/log_queries.xml
&lt;yandex&gt;
    &lt;profiles&gt;
        &lt;default&gt;
            &lt;log_queries&gt;0&lt;/log_queries&gt;
            &lt;log_query_threads&gt;0&lt;/log_query_threads&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/yandex&gt;
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-14dc574ea90d3f73fbe3876ff659dd99">42 - Threads</h1>
    <div class="lead">Threads</div>
	<h3 id="count-threads-used-by-clickhouse-server">Count threads used by clickhouse-server</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /proc/<span style="color:#204a87;font-weight:bold">$(</span>pidof -s clickhouse-server<span style="color:#204a87;font-weight:bold">)</span>/status <span style="color:#000;font-weight:bold">|</span> grep Threads
</span></span><span style="display:flex;"><span>Threads: <span style="color:#0000cf;font-weight:bold">103</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ps hH <span style="color:#204a87;font-weight:bold">$(</span>pidof -s clickhouse-server<span style="color:#204a87;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">|</span> wc -l
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">103</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ps hH -AF <span style="color:#000;font-weight:bold">|</span> grep clickhouse <span style="color:#000;font-weight:bold">|</span> wc -l
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">116</span>
</span></span></code></pre></div><h3 id="thread-counts-by-type-using-ps--clickhouse-local">Thread counts by type (using ps &amp; clickhouse-local)</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ps H -o <span style="color:#4e9a06">&#39;tid comm&#39;</span> <span style="color:#204a87;font-weight:bold">$(</span>pidof -s clickhouse-server<span style="color:#204a87;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">|</span>  tail -n +2 <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{ printf(&#34;%s\t%s\n&#34;, $1, $2) }&#39;</span> <span style="color:#000;font-weight:bold">|</span> clickhouse-local -S <span style="color:#4e9a06">&#34;threadid UInt16, name String&#34;</span> -q <span style="color:#4e9a06">&#34;SELECT name, count() FROM table GROUP BY name WITH TOTALS ORDER BY count() DESC FORMAT PrettyCompact&#34;</span>
</span></span></code></pre></div><h3 id="threads-used-by-running-queries">Threads used by running queries:</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thread_ids</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">threads_count</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">threads_count</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="thread-pools-limits--usage">Thread pools limits &amp; usage</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">settings</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%pool%&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">─────────────────────────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">connection_pool_max_wait_ms</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">distributed_connections_pool_size</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">background_buffer_flush_schedule_pool_size</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">background_pool_size</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">background_move_pool_size</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">background_fetches_pool_size</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">background_schedule_pool_size</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">background_message_broker_schedule_pool_size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">background_distributed_schedule_pool_size</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgresql_connection_pool_size</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgresql_connection_pool_wait_timeout</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">odbc_bridge_connection_pool_size</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────────────────────────────────────────┴───────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">metric</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Background%&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">metric</span><span style="color:#a40000">──────────────────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BackgroundPoolTask</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BackgroundFetchesPoolTask</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BackgroundMovePoolTask</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BackgroundSchedulePoolTask</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BackgroundBufferFlushSchedulePoolTask</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BackgroundDistributedSchedulePoolTask</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BackgroundMessageBrokerSchedulePoolTask</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────────────────────────────┴───────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">asynchronous_metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">lower</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metric</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%thread%&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">metric</span><span style="color:#a40000">───────────────────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HTTPThreads</span><span style="color:#f8f8f8;text-decoration:underline">                              </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">InterserverThreads</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MySQLThreads</span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OSThreadsRunnable</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OSThreadsTotal</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">2910</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PostgreSQLThreads</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCPThreads</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jemalloc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">background_thread</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">num_runs</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jemalloc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">background_thread</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">num_threads</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jemalloc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">background_thread</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">run_intervals</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└──────────────────────────────────────────┴───────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">lower</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metric</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%thread%&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000">acbb596</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">e28f</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000">f89</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">94</span><span style="color:#000">b2</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">27</span><span style="color:#000">dccfe88ee9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">metric</span><span style="color:#a40000">─────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┬─</span><span style="color:#000">description</span><span style="color:#a40000">───────────────────────────────────────────────────────────────────────────────────────────────────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GlobalThread</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#0000cf;font-weight:bold">151</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">threads</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">global</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thread</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pool</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">                                                                          </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GlobalThreadActive</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#0000cf;font-weight:bold">144</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">threads</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">global</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thread</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pool</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">running</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">task</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">                                                           </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LocalThread</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">threads</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thread</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pools</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">The</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">threads</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thread</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pools</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">are</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">taken</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">the</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">global</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thread</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pool</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LocalThreadActive</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">threads</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thread</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pools</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">running</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">task</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">                                                           </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">QueryThread</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">processing</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">threads</span><span style="color:#f8f8f8;text-decoration:underline">                                                                                </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└────────────────────┴───────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="stack-traces-of-the-working-threads-from-the-pools">Stack traces of the working threads from the pools</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_introspection_functions</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arrayMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demangle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addressToSymbol</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">trace</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">thread_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">query_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">arrayStringConcat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;\n&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">res</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stack_trace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">res</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ILIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%Pool%&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">FORMAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Vertical</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-403fab8125b657a5a3d0f82db33c7544">43 - Who ate my memory</h1>
    <div class="lead">Who ate my memory</div>
	<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">asynchronous_metrics</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">like</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%Cach%&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">like</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%Mem%&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PrettyCompactMonoBlock</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">event_time</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">asynchronous_metric_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">event_time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">600</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">like</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%Cach%&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">like</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;%Mem%&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">event_time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PrettyCompactMonoBlock</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes_allocated</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dictionaries</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">total_bytes</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">engine</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Memory&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;Set&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;Join&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">memory_usage</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">merges</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">memory_usage</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processes</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">initial_query_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">elapsed</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">memory_usage</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">peak_memory_usage</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">peak_memory_usage</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">metric</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">asynchronous_metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;UncompressedCacheBytes&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;MarkCacheBytes&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">primary_key_bytes_in_memory</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary_key_bytes_in_memory</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">primary_key_bytes_in_memory_allocated</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary_key_bytes_in_memory_allocated</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">event_time</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">initial_query_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">formatReadableSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">memory_usage</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">query_log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event_date</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">today</span><span style="color:#000;font-weight:bold">())</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event_time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">7200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">memory_usage</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data_uncompressed_bytes</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">part_type</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;InMemory&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> i in <span style="color:#4e9a06">`</span>seq <span style="color:#0000cf;font-weight:bold">1</span> 600<span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span> clickhouse-client --empty_result_for_aggregation_by_empty_set<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> -q <span style="color:#4e9a06">&#34;select (select &#39;Merges: \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#39;||formatReadableSize(sum(memory_usage)) from system.merges), (select \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#39;Processes: &#39;||formatReadableSize(sum(memory_usage)) from system.processes)&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>sleep 3<span style="color:#000;font-weight:bold">;</span>  <span style="color:#204a87;font-weight:bold">done</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Merges: 96.57 MiB	Processes: 41.98 MiB
</span></span><span style="display:flex;"><span>Merges: 82.24 MiB	Processes: 41.91 MiB
</span></span><span style="display:flex;"><span>Merges: 66.33 MiB	Processes: 41.91 MiB
</span></span><span style="display:flex;"><span>Merges: 66.49 MiB	Processes: 37.13 MiB
</span></span><span style="display:flex;"><span>Merges: 67.78 MiB	Processes: 37.13 MiB
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;         Merges      Processes       PrimaryK       TempTabs          Dicts&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span><span style="color:#204a87;font-weight:bold">for</span> i in <span style="color:#4e9a06">`</span>seq <span style="color:#0000cf;font-weight:bold">1</span> 600<span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span> clickhouse-client --empty_result_for_aggregation_by_empty_set<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>  -q <span style="color:#4e9a06">&#34;select \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">(select leftPad(formatReadableSize(sum(memory_usage)),15, &#39; &#39;) from system.merges)||
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">(select leftPad(formatReadableSize(sum(memory_usage)),15, &#39; &#39;) from system.processes)||
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">(select leftPad(formatReadableSize(sum(primary_key_bytes_in_memory_allocated)),15, &#39; &#39;) from system.parts)|| \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">(select leftPad(formatReadableSize(sum(total_bytes)),15, &#39; &#39;) from system.tables \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"> WHERE engine IN (&#39;Memory&#39;,&#39;Set&#39;,&#39;Join&#39;))||
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">(select leftPad(formatReadableSize(sum(bytes_allocated)),15, &#39; &#39;) FROM system.dictionaries)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span> sleep 3<span style="color:#000;font-weight:bold">;</span>  <span style="color:#204a87;font-weight:bold">done</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         Merges      Processes       PrimaryK       TempTabs          Dicts
</span></span><span style="display:flex;"><span>         0.00 B         0.00 B      21.36 MiB       1.58 GiB     911.07 MiB
</span></span><span style="display:flex;"><span>         0.00 B         0.00 B      21.36 MiB       1.58 GiB     911.07 MiB
</span></span><span style="display:flex;"><span>         0.00 B         0.00 B      21.35 MiB       1.58 GiB     911.07 MiB
</span></span><span style="display:flex;"><span>         0.00 B         0.00 B      21.36 MiB       1.58 GiB     911.07 MiB
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-001c962263e4fe6ade35b2640d581f26">44 - X rows of Y total rows in filesystem are suspicious</h1>
    <div class="lead">X rows of Y total rows in filesystem are suspicious</div>
	

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    The local set of parts of table doesn&rsquo;t look like the set of parts in ZooKeeper. 100.00 rows of 150.00 total rows in filesystem are suspicious. There are 1 unexpected parts with 100 rows (1 of them is not just-written with 100 rows), 0 missing parts (with 0 blocks).: Cannot attach table.

</div>

<p>ClickHouse has a registry of parts in ZooKeeper.</p>
<p>And during the start ClickHouse compares that list of parts on a local disk is consistent with a list in ZooKeeper. If the lists are too different ClickHouse denies to start because it could be an issue with settings, wrong Shard or wrong Replica macros. But this safe-limiter throws an exception if the difference is more 50% (in rows).</p>
<p>In your case the table is very small and the difference &gt;50% ( 100.00 vs 150.00 ) is only a single part mismatch, which can be the result of hard restart.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">merge_tree_settings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicated_max_ratio_of_wrong_parts&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">────────────────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┬─</span><span style="color:#000">changed</span><span style="color:#a40000">─┬─</span><span style="color:#000">description</span><span style="color:#a40000">──────────────────────────────────────────────────────────────────────────┬─</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#a40000">──┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replicated_max_ratio_of_wrong_parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">If</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wrong</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">total</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">is</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">less</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">than</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">this</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">start</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Float</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└─────────────────────────────────────┴───────┴─────────┴──────────────────────────────────────────────────────────────────────────────────────┴───────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can set another value of <code>replicated_max_ratio_of_wrong_parts</code> for all MergeTree tables or per table.</p>
<p><a href="https://clickhouse.tech/docs/en/operations/settings/merge-tree-settings" target="_blank">https://clickhouse.tech/docs/en/operations/settings/merge-tree-settings</a></p>
<h2 id="after-manipulation-with-storage_policies-and-disks">After manipulation with storage_policies and disks</h2>
<p>When storage policy changes (one disk was removed from it), ClickHouse compared parts on disk and this replica state in ZooKeeper and found out that a lot of parts (from removed disk) disappeared. So ClickHouse removed them from the replica state in ZooKeeper and scheduled to fetch them from other replicas.</p>
<p>After we add the removed disk to storage_policy back, ClickHouse finds missing parts, but at this moment they are not registered for that replica.
ClickHouse produce error message like this:</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    <Error> Application: DB::Exception: The local set of parts of table default.tbl doesn&rsquo;t look like the set of parts in ZooKeeper: 14.96 billion rows of 16.24 billion total rows in filesystem are suspicious. There are 45 unexpected parts with 14960302620 rows (43 of them is not just-written with 14959824636 rows), 0 missing parts (with 0 blocks).: Cannot attach table <code>default</code>.<code>tbl</code> from metadata file /var/lib/clickhouse/metadata/default/tbl.sql from query ATTACH TABLE default.tbl &hellip; ENGINE=ReplicatedMergeTree(&rsquo;/clickhouse/tables/0/default/tbl&rsquo;, &lsquo;replica-0&rsquo;)&hellip; SETTINGS index_granularity = 1024, storage_policy = &rsquo;ebs_hot_and_cold&rsquo;: while loading database <code>default</code> from path /var/lib/clickhouse/metadata/data

</div>

<p>At this point, it&rsquo;s possible to either tune setting <code>replicated_max_ratio_of_wrong_parts</code> or do force restore, but it will end up downloading all &ldquo;missing&rdquo; parts from other replicas, which can take a lot of time for big tables.</p>
<h3 id="clickhouse-217">ClickHouse 21.7+</h3>
<ol>
<li>Rename table SQL attach script in order to prevent ClickHouse from attaching it at startup.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>mv /var/lib/clickhouse/metadata/default/tbl.sql /var/lib/clickhouse/metadata/default/tbl.sql.bak
</span></span></code></pre></div><ol start="2">
<li>
<p>Start ClickHouse server.</p>
</li>
<li>
<p>Remove metadata for this replica from ZooKeeper.</p>
</li>
</ol>
<pre tabindex="0"><code>SYSTEM DROP REPLICA &#39;replica-0&#39; FROM ZKPATH &#39;/clickhouse/tables/0/default/tbl&#39;;

SELECT * FROM system.zookeeper WHERE path = &#39;/clickhouse/tables/0/default/tbl/replicas&#39;;
</code></pre><ol start="4">
<li>Rename table SQL attach script back to normal name.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>mv /var/lib/clickhouse/metadata/default/tbl.sql.bak /var/lib/clickhouse/metadata/default/tbl.sql
</span></span></code></pre></div><ol start="5">
<li>Attach table to ClickHouse server, because there is no metadata in ZooKeeper, ClickHouse will attach it in read only state.</li>
</ol>
<pre tabindex="0"><code>ATTACH TABLE default.tbl;
</code></pre><ol start="6">
<li>Run <code>SYSTEM RESTORE REPLICA</code> in order to sync state on disk and in ZooKeeper.</li>
</ol>
<pre tabindex="0"><code>SYSTEM RESTORE REPLICA default.tbl;
</code></pre><ol start="7">
<li>Run <code>SYSTEM SYNC REPLICA</code> to download missing parts from other replicas.</li>
</ol>
<pre tabindex="0"><code>SYSTEM SYNC REPLICA default.tbl;
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-475baf90f39df7559ac79d0838516eba">45 - ZooKeeper</h1>
    <div class="lead">ZooKeeper</div>
	<h3 id="requirements">Requirements</h3>
<p>TLDR version:</p>
<ol>
<li>USE DEDICATED FAST DISKS for the transaction log! (crucial for performance due to write-ahead-log, NVMe is preferred for heavy load setup).</li>
<li>use 3 nodes (more nodes = slower quorum, less = no HA).</li>
<li>low network latency between zookeeper nodes is very important (latency, not bandwidth).</li>
<li>have at least 4Gb of RAM, disable swap, <a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/jvm-sizes-and-garbage-collector-settings/" target="_blank">tune JVM sizes, and garbage collector settings</a></li>
<li>ensure that zookeeper will not be CPU-starved by some other processes</li>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/zookeeper-monitoring/" target="_blank">monitor zookeeper</a>.</li>
</ol>
<p>Side note:
in many cases, the slowness of the zookeeper is actually a symptom of some issue with clickhouse schema/usage pattern (the most typical issues: an enormous number of partitions/tables/databases with real-time inserts, tiny &amp; frequent inserts).</p>
<h3 id="how-to-install">How to install</h3>
<ul>
<li><a href="https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/" target="_blank">https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/</a></li>
<li><a href="/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/">altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/</a></li>
</ul>
<h3 id="random-links-on-best-practices">Random links on best practices</h3>
<ul>
<li><a href="https://docs.confluent.io/platform/current/zookeeper/deployment.html" target="_blank">https://docs.confluent.io/platform/current/zookeeper/deployment.html</a></li>
<li><a href="https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems" target="_blank">https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems</a></li>
<li><a href="https://clickhouse.tech/docs/en/operations/tips/#zookeeper" target="_blank">https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a></li>
<li><a href="https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html" target="_blank">https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting" target="_blank">https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting</a></li>
</ul>
<p>Cite from <a href="https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems" target="_blank">https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems</a> :</p>
<blockquote>
<h2 id="things-to-avoid">Things to Avoid</h2>
<p>Here are some common problems you can avoid by configuring ZooKeeper correctly:</p>
<ul>
<li><em>inconsistent lists of servers</em> : The list of ZooKeeper servers used by the clients must match the list of ZooKeeper servers that each ZooKeeper server has. Things work okay if the client list is a subset of the real list, but things will really act strange if clients have a list of ZooKeeper servers that are in different ZooKeeper clusters. Also, the server lists in each Zookeeper server configuration file should be consistent with one another.</li>
<li><em>incorrect placement of transaction log</em> : The most performance critical part of ZooKeeper is the transaction log. ZooKeeper syncs transactions to media before it returns a response. A dedicated transaction log device is key to consistent good performance. Putting the log on a busy device will adversely affect performance. If you only have one storage device, increase the snapCount so that snapshot files are generated less often; it does not eliminate the problem, but it makes more resources available for the transaction log.</li>
<li><em>incorrect Java heap size</em> : You should take special care to set your Java max heap size correctly. In particular, you should not create a situation in which ZooKeeper swaps to disk. The disk is death to ZooKeeper. Everything is ordered, so if processing one request swaps the disk, all other queued requests will probably do the same. the disk. DON&rsquo;T SWAP. Be conservative in your estimates: if you have 4G of RAM, do not set the Java max heap size to 6G or even 4G. For example, it is more likely you would use a 3G heap for a 4G machine, as the operating system and the cache also need memory. The best and only recommend practice for estimating the heap size your system needs is to run load tests, and then make sure you are well below the usage limit that would cause the system to swap.</li>
<li><em>Publicly accessible deployment</em> : A ZooKeeper ensemble is expected to operate in a trusted computing environment. It is thus recommended to deploy ZooKeeper behind a firewall.</li>
</ul>
</blockquote>
<h3 id="how-to-check-number-of-followers">How to check number of followers:</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> mntr <span style="color:#000;font-weight:bold">|</span> nc zookeeper <span style="color:#0000cf;font-weight:bold">2187</span> <span style="color:#000;font-weight:bold">|</span> grep foll
</span></span><span style="display:flex;"><span>zk_synced_followers    <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>zk_synced_non_voting_followers    <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>zk_avg_follower_sync_time    0.0
</span></span><span style="display:flex;"><span>zk_min_follower_sync_time    <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>zk_max_follower_sync_time    <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>zk_cnt_follower_sync_time    <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>zk_sum_follower_sync_time    <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><h2 id="tools">Tools</h2>
<p><a href="https://github.com/apache/zookeeper/blob/master/zookeeper-docs/src/main/resources/markdown/zookeeperTools.md" target="_blank">https://github.com/apache/zookeeper/blob/master/zookeeper-docs/src/main/resources/markdown/zookeeperTools.md</a></p>
<h2 id="alternatives-for-zkcli">Alternatives for zkCli</h2>
<ul>
<li><a href="https://github.com/go-zkcli/zkcli" target="_blank">https://github.com/go-zkcli/zkcli</a></li>
<li><a href="https://github.com/outbrain/zookeepercli" target="_blank">https://github.com/outbrain/zookeepercli</a></li>
<li><a href="https://idata.co.il/2018/07/a-day-at-the-zoo-graphic-uis-for-apache-zookeeper/" target="_blank">https://idata.co.il/2018/07/a-day-at-the-zoo-graphic-uis-for-apache-zookeeper/</a></li>
</ul>
<h2 id="web-ui">Web UI</h2>
<ul>
<li><a href="https://github.com/elkozmon/zoonavigator-api" target="_blank">https://github.com/elkozmon/zoonavigator-api</a></li>
<li><a href="https://github.com/tobilg/docker-zookeeper-webui" target="_blank">https://github.com/tobilg/docker-zookeeper-webui</a></li>
<li><a href="https://github.com/vran-dev/PrettyZoo" target="_blank">https://github.com/vran-dev/PrettyZoo</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-05425e768ddcc5be5d1203f59044e6d5">45.1 - Install standalone Zookeeper for ClickHouse on Ubuntu / Debian</h1>
    <div class="lead">Install standalone Zookeeper for ClickHouse on Ubuntu / Debian.</div>
	<h2 id="reference-script-to-install-standalone-zookeeper-for-ubuntu--debian">Reference script to install standalone Zookeeper for Ubuntu / Debian</h2>
<p>Tested on Ubuntu 20.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install java runtime environment</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt install default-jre
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># prepare folders, logs folder should be on the low-latency disk.</span>
</span></span><span style="display:flex;"><span>sudo mkdir -p /var/lib/zookeeper/data /var/lib/zookeeper/logs /etc/zookeeper /var/log/zookeeper /opt 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># download and install files </span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span>3.6.3
</span></span><span style="display:flex;"><span>wget https://dlcdn.apache.org/zookeeper/zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin.tar.gz -O /tmp/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin.tar.gz
</span></span><span style="display:flex;"><span>sudo tar -xvf /tmp/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin.tar.gz -C /opt
</span></span><span style="display:flex;"><span>rm -rf /tmp/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># create the user </span>
</span></span><span style="display:flex;"><span>sudo groupadd -r zookeeper
</span></span><span style="display:flex;"><span>sudo useradd -r -g zookeeper --home-dir<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/zookeeper --shell<span style="color:#ce5c00;font-weight:bold">=</span>/bin/false zookeeper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># symlink pointing to the used version of zookeeper distibution</span>
</span></span><span style="display:flex;"><span>sudo ln -s /opt/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin /opt/zookeeper 
</span></span><span style="display:flex;"><span>sudo chown -R zookeeper:zookeeper /var/lib/zookeeper /var/log/zookeeper /etc/zookeeper /opt/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin
</span></span><span style="display:flex;"><span>sudo chown -h zookeeper:zookeeper /opt/zookeeper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># shortcuts in /usr/local/bin/</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkCli.sh &#34;$@&#34;&#39;</span>             <span style="color:#000;font-weight:bold">|</span> sudo tee /usr/local/bin/zkCli
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkServer.sh &#34;$@&#34;&#39;</span>          <span style="color:#000;font-weight:bold">|</span> sudo tee /usr/local/bin/zkServer
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkCleanup.sh &#34;$@&#34;&#39;</span>         <span style="color:#000;font-weight:bold">|</span> sudo tee /usr/local/bin/zkCleanup
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkSnapShotToolkit.sh &#34;$@&#34;&#39;</span> <span style="color:#000;font-weight:bold">|</span> sudo tee /usr/local/bin/zkSnapShotToolkit
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkTxnLogToolkit.sh &#34;$@&#34;&#39;</span>   <span style="color:#000;font-weight:bold">|</span> sudo tee /usr/local/bin/zkTxnLogToolkit
</span></span><span style="display:flex;"><span>sudo chmod +x /usr/local/bin/zkCli /usr/local/bin/zkServer /usr/local/bin/zkCleanup /usr/local/bin/zkSnapShotToolkit /usr/local/bin/zkTxnLogToolkit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># put in the config</span>
</span></span><span style="display:flex;"><span>sudo cp opt/zookeeper/conf/* /etc/zookeeper
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt;EOF | sudo tee /etc/zookeeper/zoo.cfg
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">initLimit=20
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">syncLimit=10
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">maxSessionTimeout=60000000
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">maxClientCnxns=2000
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">preAllocSize=131072
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">snapCount=3000000
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">dataDir=/var/lib/zookeeper/data
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">dataLogDir=/var/lib/zookeeper/logs # use low-latency disk!
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">clientPort=2181
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">#clientPortAddress=nthk-zoo1.localdomain
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">autopurge.snapRetainCount=10
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">autopurge.purgeInterval=1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">4lw.commands.whitelist=*
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>sudo chown -R zookeeper:zookeeper /etc/zookeeper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># create systemd service file</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt;EOF | sudo tee /etc/systemd/system/zookeeper.service
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Description=Zookeeper Daemon
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Documentation=http://zookeeper.apache.org
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Requires=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Type=forking
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">WorkingDirectory=/var/lib/zookeeper
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">User=zookeeper
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Group=zookeeper
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=ZK_SERVER_HEAP=1536 # in megabytes, adjust to ~ 80-90% of avaliable RAM (more than 8Gb is rather overkill)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=SERVER_JVMFLAGS=&#34;-Xms256m -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=ZOO_LOG_DIR=/var/log/zookeeper
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=/opt/zookeeper/bin/zkServer.sh start /etc/zookeeper/zoo.cfg
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStop=/opt/zookeeper/bin/zkServer.sh stop /etc/zookeeper/zoo.cfg
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecReload=/opt/zookeeper/bin/zkServer.sh restart /etc/zookeeper/zoo.cfg
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">TimeoutSec=30
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">WantedBy=default.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># start zookeeper</span>
</span></span><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl start zookeeper.service 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># check status etc.</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> stat <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">2181</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> ruok <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">2181</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> mntr <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">2181</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4c33701373e85b893c3b3464fa4f6683">45.2 - clickhouse-keeper</h1>
    <div class="lead">clickhouse-keeper</div>
	<p>In 21.3 there is already an option to run own clickhouse zookeeper implementation. It&rsquo;s still experimental, and still need to be started additionally on few nodes (similar to &rsquo;normal&rsquo; zookeeper) and speaks normal zookeeper protocol - needed to simplify A/B tests with real zookeeper.</p>
<p>No docs, for now, only PR with code &amp; tests. Of course, if you want to play with it - you can, and early feedback is very valuable. But be prepared for a lot of tiny issues here and there, so don&rsquo;t be disappointed if it will not satisfy your expectations for some reason. It&rsquo;s very-very fresh :slightly_smiling_face: It&rsquo;s ready for some trial runs, but not ready yet for production use cases.</p>
<p>To test that you need to run 3 instances of clickhouse-server (which will mimic zookeeper) with an extra config like that:</p>
<p><a href="https://github.com/ClickHouse/ClickHouse/blob/c8b1004ecb4bfc4aa581dbcbbbe3a4c72ce57123/tests/integration/test_keeper_multinode_simple/configs/enable_keeper1.xml" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/c8b1004ecb4bfc4aa581dbcbbbe3a4c72ce57123/tests/integration/test_keeper_multinode_simple/configs/enable_keeper1.xml</a></p>
<p><a href="https://github.com/ClickHouse/ClickHouse/blob/c8b1004ecb4bfc4aa581dbcbbbe3a4c72ce57123/tests/integration/test_keeper_snapshots/configs/enable_keeper.xml" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/c8b1004ecb4bfc4aa581dbcbbbe3a4c72ce57123/tests/integration/test_keeper_snapshots/configs/enable_keeper.xml</a></p>
<p>or event single instance with config like that: <a href="https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/keeper_port.xml" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/keeper_port.xml</a>
<a href="https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/zookeeper.xml" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/zookeeper.xml</a></p>
<p>And point all the clickhouses (zookeeper config secton) to those nodes / ports.</p>
<p>Latest testing version is recommended. We will be thankful for any feedback.</p>
<h2 id="example-of-a-simple-cluster-with-2-nodes-of-clickhouse-using-built-in-keeper">Example of a simple cluster with 2 nodes of Clickhouse using built-in keeper</h2>
<p>For example you can start two Clikhouse nodes (hostname1, hostname2)</p>
<h3 id="hostname1">hostname1</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>$ cat /etc/clickhouse-server/config.d/keeper.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;keeper_server&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;tcp_port&gt;</span>2181<span style="color:#204a87;font-weight:bold">&lt;/tcp_port&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;server_id&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/server_id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;log_storage_path&gt;</span>/var/lib/clickhouse/coordination/log<span style="color:#204a87;font-weight:bold">&lt;/log_storage_path&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;snapshot_storage_path&gt;</span>/var/lib/clickhouse/coordination/snapshots<span style="color:#204a87;font-weight:bold">&lt;/snapshot_storage_path&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;coordination_settings&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;operation_timeout_ms&gt;</span>10000<span style="color:#204a87;font-weight:bold">&lt;/operation_timeout_ms&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;session_timeout_ms&gt;</span>30000<span style="color:#204a87;font-weight:bold">&lt;/session_timeout_ms&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;raft_logs_level&gt;</span>trace<span style="color:#204a87;font-weight:bold">&lt;/raft_logs_level&gt;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&lt;rotate_log_storage_interval&gt;</span>10000<span style="color:#204a87;font-weight:bold">&lt;/rotate_log_storage_interval&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/coordination_settings&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;raft_configuration&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;server&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;id&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#204a87;font-weight:bold">&lt;hostname&gt;</span>hostname1<span style="color:#204a87;font-weight:bold">&lt;/hostname&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9444<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;/server&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;server&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;id&gt;</span>2<span style="color:#204a87;font-weight:bold">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#204a87;font-weight:bold">&lt;hostname&gt;</span>hostname2<span style="color:#204a87;font-weight:bold">&lt;/hostname&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9444<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;/server&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;/raft_configuration&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/keeper_server&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;zookeeper&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;node&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>localhost<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>2181<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/node&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/zookeeper&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;distributed_ddl&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;path&gt;</span>/clickhouse/testcluster/task_queue/ddl<span style="color:#204a87;font-weight:bold">&lt;/path&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/distributed_ddl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat /etc/clickhouse-server/config.d/macros.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;macros&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;cluster&gt;</span>testcluster<span style="color:#204a87;font-weight:bold">&lt;/cluster&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>replica1<span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;shard&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/shard&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/macros&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><h3 id="hostname2">hostname2</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>$ cat /etc/clickhouse-server/config.d/keeper.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;keeper_server&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;tcp_port&gt;</span>2181<span style="color:#204a87;font-weight:bold">&lt;/tcp_port&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;server_id&gt;</span>2<span style="color:#204a87;font-weight:bold">&lt;/server_id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;log_storage_path&gt;</span>/var/lib/clickhouse/coordination/log<span style="color:#204a87;font-weight:bold">&lt;/log_storage_path&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;snapshot_storage_path&gt;</span>/var/lib/clickhouse/coordination/snapshots<span style="color:#204a87;font-weight:bold">&lt;/snapshot_storage_path&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;coordination_settings&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;operation_timeout_ms&gt;</span>10000<span style="color:#204a87;font-weight:bold">&lt;/operation_timeout_ms&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;session_timeout_ms&gt;</span>30000<span style="color:#204a87;font-weight:bold">&lt;/session_timeout_ms&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;raft_logs_level&gt;</span>trace<span style="color:#204a87;font-weight:bold">&lt;/raft_logs_level&gt;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&lt;rotate_log_storage_interval&gt;</span>10000<span style="color:#204a87;font-weight:bold">&lt;/rotate_log_storage_interval&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/coordination_settings&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;raft_configuration&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;server&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;id&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#204a87;font-weight:bold">&lt;hostname&gt;</span>hostname1<span style="color:#204a87;font-weight:bold">&lt;/hostname&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9444<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;/server&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;server&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;id&gt;</span>2<span style="color:#204a87;font-weight:bold">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#204a87;font-weight:bold">&lt;hostname&gt;</span>hostname2<span style="color:#204a87;font-weight:bold">&lt;/hostname&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9444<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;/server&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;/raft_configuration&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/keeper_server&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;zookeeper&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;node&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>localhost<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>2181<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/node&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/zookeeper&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;distributed_ddl&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;path&gt;</span>/clickhouse/testcluster/task_queue/ddl<span style="color:#204a87;font-weight:bold">&lt;/path&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/distributed_ddl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat /etc/clickhouse-server/config.d/macros.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;macros&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;cluster&gt;</span>testcluster<span style="color:#204a87;font-weight:bold">&lt;/cluster&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>replica2<span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;shard&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/shard&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/macros&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><h3 id="on-both">on both</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>$ cat /etc/clickhouse-server/config.d/clusters.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;remote_servers&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;testcluster&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;shard&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>hostname1<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9000<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>hostname2<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9000<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;/shard&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/testcluster&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/remote_servers&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><p>Then create a table</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">S</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{database}/{table}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">Order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100000000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- on both nodes:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-564a3bbd39f9550e577334d912a883dc">45.3 - How to check the list of watches</h1>
    <div class="lead">How to check the list of watches</div>
	<p>Zookeeper use watches to notify a client on znode changes. This article explains how to check watches set by ZooKeeper servers and how it is used.</p>
<p><strong>Solution:</strong></p>
<p>Zookeeper uses the <code>'wchc'</code> command to list all watches set on the Zookeeper server.</p>
<p><code># echo wchc | nc zookeeper 2181</code></p>
<p>Reference</p>
<p><a href="https://zookeeper.apache.org/doc/r3.4.12/zookeeperAdmin.html" target="_blank">https://zookeeper.apache.org/doc/r3.4.12/zookeeperAdmin.html</a></p>
<p>The <code>wchp</code> and <code>wchc</code> commands are not enabled by default because of their known DOS vulnerability. For more information, see <a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2693" target="_blank">ZOOKEEPER-2693</a>and <a href="https://vulners.com/exploitdb/EDB-ID:41277" target="_blank">Zookeeper 3.5.2 - Denial of Service</a>.</p>
<p>By default those commands are disabled, they can be enabled via Java system property:</p>
<p><code>-Dzookeeper.4lw.commands.whitelist=*</code></p>
<p>on in zookeeper config: <code>4lw.commands.whitelist=*</code>\</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-722cb96284be123698aa3e56ea92ecaf">45.4 - JVM sizes and garbage collector settings</h1>
    <div class="lead">JVM sizes and garbage collector settings</div>
	<h2 id="tldr-version">TLDR version</h2>
<p>use fresh Java version (11 or newer), disable swap and set up (for 4 Gb node):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">JAVA_OPTS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-Xms512m -Xmx3G -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;</span>
</span></span></code></pre></div><p>If you have a node with more RAM - change it accordingly, for example for 8Gb node:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">JAVA_OPTS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-Xms512m -Xmx7G -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;</span>
</span></span></code></pre></div><h2 id="details">Details</h2>
<ol>
<li>
<p>ZooKeeper runs as in JVM. Depending on version different garbage collectors are available.</p>
</li>
<li>
<p>Recent JVM versions (starting from 10) use <code>G1</code> garbage collector by default (should work fine).
On JVM 13-14 using <code>ZGC</code> or <code>Shenandoah</code> garbage collector may reduce pauses.
On older JVM version (before 10) you may want to make some tuning to decrease pauses, ParNew + CMS garbage collectors (like in Yandex config) is one of the best options.</p>
</li>
<li>
<p>One of the most important setting for JVM application is heap size. A heap size of &gt;1 GB is recommended for most use cases and monitoring heap usage to ensure no delays are caused by garbage collection. We recommend to use at least 4Gb of RAM for zookeeper nodes (8Gb is better, that will make difference only when zookeeper is heavily loaded).</p>
</li>
</ol>
<p>Set the Java heap size smaller than available RAM size on the node. This is very important to avoid swapping, which will seriously degrade ZooKeeper performance. Be conservative - use a maximum heap size of 3GB for a 4GB machine.</p>
<ol>
<li>
<p>Add <code>XX:+AlwaysPreTouch</code> flag as well to load the memory pages into memory at the start of the zookeeper.</p>
</li>
<li>
<p>Set min (<code>Xms</code>) heap size to the values like 512Mb, or even to the same value as max (<code>Xmx</code>) to avoid resizing and returning the RAM to OS. Add <code>XX:+AlwaysPreTouch</code> flag as well to load the memory pages into memory at the start of the zookeeper.</p>
</li>
<li>
<p><code>MaxGCPauseMillis=50</code> (by default 200) - the &rsquo;target&rsquo; acceptable pause for garbage collection (milliseconds)</p>
</li>
<li>
<p><code>jute.maxbuffer</code> limits the maximum size of znode content. By default it&rsquo;s 1Mb. In some usecases (lot of partitions in table) ClickHouse may need to create bigger znodes.</p>
</li>
<li>
<p>(optional) enable GC logs: <code>-Xloggc:/path_to/gc.log</code></p>
</li>
</ol>
<h2 id="zookeeper-configurarion-used-by-yandex-metrika-from-2017">Zookeeper configurarion used by Yandex Metrika (from 2017)</h2>
<p>The configuration used by Yandex ( <a href="https://clickhouse.tech/docs/en/operations/tips/#zookeeper" target="_blank">https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a> ) - they use older JVM version (with <code>UseParNewGC</code> garbage collector), and tune GC logs heavily:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">JAVA_OPTS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-Xms{{ cluster.get(&#39;xms&#39;,&#39;128M&#39;) }} \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -Xmx{{ cluster.get(&#39;xmx&#39;,&#39;1G&#39;) }} \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -Xloggc:/var/log/</span><span style="color:#000">$NAME</span><span style="color:#4e9a06">/zookeeper-gc.log \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+UseGCLogFileRotation \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:NumberOfGCLogFiles=16 \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:GCLogFileSize=16M \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -verbose:gc \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintGCTimeStamps \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintGCDateStamps \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintGCDetails
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintTenuringDistribution \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintGCApplicationStoppedTime \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintGCApplicationConcurrentTime \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintSafepointStatistics \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+UseParNewGC \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+UseConcMarkSweepGC \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+CMSParallelRemarkEnabled&#34;</span>
</span></span></code></pre></div><h2 id="see-also">See also</h2>
<ul>
<li><a href="https://wikitech.wikimedia.org/wiki/JVM_Tuning#G1_for_full_gcs" target="_blank">https://wikitech.wikimedia.org/wiki/JVM_Tuning#G1_for_full_gcs</a></li>
<li><a href="https://sematext.com/blog/java-garbage-collection-tuning/" target="_blank">https://sematext.com/blog/java-garbage-collection-tuning/</a></li>
<li><a href="https://www.oracle.com/technical-resources/articles/java/g1gc.html" target="_blank">https://www.oracle.com/technical-resources/articles/java/g1gc.html</a></li>
<li><a href="https://docs.oracle.com/cd/E40972_01/doc.70/e40973/cnf_jvmgc.htm#autoId2" target="_blank">https://docs.oracle.com/cd/E40972_01/doc.70/e40973/cnf_jvmgc.htm#autoId2</a></li>
<li><a href="https://docs.cloudera.com/runtime/7.2.7/kafka-performance-tuning/topics/kafka-tune-broker-tuning-jvm.html" target="_blank">https://docs.cloudera.com/runtime/7.2.7/kafka-performance-tuning/topics/kafka-tune-broker-tuning-jvm.html</a></li>
<li><a href="https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cm-tune-g1gc.html" target="_blank">https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cm-tune-g1gc.html</a></li>
<li><a href="https://blog.sokolenko.me/2014/11/javavm-options-production.html" target="_blank">https://blog.sokolenko.me/2014/11/javavm-options-production.html</a></li>
<li><a href="https://www.maknesium.de/21-most-important-java-8-vm-options-for-servers" target="_blank">https://www.maknesium.de/21-most-important-java-8-vm-options-for-servers</a></li>
<li><a href="https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304" target="_blank">https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304</a></li>
<li><a href="https://github.com/chewiebug/GCViewer" target="_blank">https://github.com/chewiebug/GCViewer</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1ef2081889fb4a086febf3b281e44778">45.5 - Proper setup</h1>
    <div class="lead">Proper setup</div>
	<h3 id="main-docs-article">Main docs article</h3>
<p><a href="https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/" target="_blank">https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/</a></p>
<h3 id="hardware-requirements">Hardware requirements</h3>
<p>TLDR version:</p>
<ol>
<li>USE DEDICATED FAST DISKS for the transaction log! (crucial for performance due to write-ahead-log, NVMe is preferred for heavy load setup).</li>
<li>use 3 nodes (more nodes = slower quorum, less = no HA).</li>
<li>low network latency between zookeeper nodes is very important (latency, not bandwidth).</li>
<li>have at least 4Gb of RAM, disable swap, tune JVM sizes, and garbage collector settings.</li>
<li>ensure that zookeeper will not be CPU-starved by some other processes</li>
<li>monitor zookeeper.</li>
</ol>
<p>Side note:
in many cases, the slowness of the zookeeper is actually a symptom of some issue with clickhouse schema/usage pattern (the most typical issues: an enormous number of partitions/tables/databases with real-time inserts, tiny &amp; frequent inserts).</p>
<p>Some doc about that subject:</p>
<ul>
<li><a href="https://docs.confluent.io/platform/current/zookeeper/deployment.html" target="_blank">https://docs.confluent.io/platform/current/zookeeper/deployment.html</a></li>
<li><a href="https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems" target="_blank">https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems</a></li>
<li><a href="https://clickhouse.tech/docs/en/operations/tips/#zookeeper" target="_blank">https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a></li>
<li><a href="https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html" target="_blank">https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting" target="_blank">https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting</a></li>
</ul>
<p>Cite from <a href="https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems" target="_blank">https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems</a> :</p>
<blockquote>
<h2 id="things-to-avoid">Things to Avoid</h2>
<p>Here are some common problems you can avoid by configuring ZooKeeper correctly:</p>
<ul>
<li><em>inconsistent lists of servers</em> : The list of ZooKeeper servers used by the clients must match the list of ZooKeeper servers that each ZooKeeper server has. Things work okay if the client list is a subset of the real list, but things will really act strange if clients have a list of ZooKeeper servers that are in different ZooKeeper clusters. Also, the server lists in each Zookeeper server configuration file should be consistent with one another.</li>
<li><em>incorrect placement of transaction log</em> : The most performance critical part of ZooKeeper is the transaction log. ZooKeeper syncs transactions to media before it returns a response. A dedicated transaction log device is key to consistent good performance. Putting the log on a busy device will adversely affect performance. If you only have one storage device, increase the snapCount so that snapshot files are generated less often; it does not eliminate the problem, but it makes more resources available for the transaction log.</li>
<li><em>incorrect Java heap size</em> : You should take special care to set your Java max heap size correctly. In particular, you should not create a situation in which ZooKeeper swaps to disk. The disk is death to ZooKeeper. Everything is ordered, so if processing one request swaps the disk, all other queued requests will probably do the same. the disk. DON&rsquo;T SWAP. Be conservative in your estimates: if you have 4G of RAM, do not set the Java max heap size to 6G or even 4G. For example, it is more likely you would use a 3G heap for a 4G machine, as the operating system and the cache also need memory. The best and only recommend practice for estimating the heap size your system needs is to run load tests, and then make sure you are well below the usage limit that would cause the system to swap.</li>
<li><em>Publicly accessible deployment</em> : A ZooKeeper ensemble is expected to operate in a trusted computing environment. It is thus recommended to deploy ZooKeeper behind a firewall.</li>
</ul>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-66b660806f12af38114754857823e52a">45.6 - Recovering from complete metadata loss in ZooKeeper</h1>
    <div class="lead">Recovering from complete metadata loss in ZooKeeper</div>
	<h2 id="problem">Problem</h2>
<p>Every ClickHouse user experienced a loss of ZooKeeper one day. While the data is available and replicas respond to queries, inserts are no longer possible. ClickHouse uses ZooKeeper in order to store the reference version of the table structure and part of data, and when it is not available can not guarantee data consistency anymore. Replicated tables turn to the read-only mode. In this article we describe step-by-step instructions of how to restore ZooKeeper metadata and bring ClickHouse cluster back to normal operation.</p>
<p>In order to restore ZooKeeper we have to solve two tasks. First, we need to restore table metadata in ZooKeeper. Currently, the only way to do it is to recreate the table with the <code>CREATE TABLE DDL</code> statement.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENGINE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;zookeeper_path&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;replica_name&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The second and more difficult task is to populate zookeeper with information of clickhouse data parts. As mentioned above, ClickHouse stores the reference data about all parts of replicated tables in ZooKeeper, so we have to traverse all partitions and re-attach them to the recovered replicated table in order to fix that.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    Starting from ClickHouse version 21.7 there is SYSTEM RESTORE REPLICA command

</div>

<p><a href="https://altinity.com/blog/a-new-way-to-restore-clickhouse-after-zookeeper-metadata-is-lost" target="_blank">https://altinity.com/blog/a-new-way-to-restore-clickhouse-after-zookeeper-metadata-is-lost</a></p>
<h2 id="test-case">Test case</h2>
<p>Let&rsquo;s say we have replicated table <code>table_repl</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87">number</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intDiv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And populate it with some data</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;/clickhouse/cluster_1/tables/01/&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">partition</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;table_repl&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">partition</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Now let’s remove metadata in zookeeper using <code>ZkCli.sh</code> at ZooKeeper host:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>deleteall  /clickhouse/cluster_1/tables/01/table_repl
</span></span></code></pre></div><p>And try to resync clickhouse replica state with zookeeper:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RESTART</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>If we try to insert some data in the table, error happens:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And now we have an exception that we lost all metadata in zookeeper. It is time to recover!</p>
<h2 id="current-solution">Current Solution</h2>
<ol>
<li>
<p>Detach replicated table.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">DETACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Save the table’s attach script and change engine of replicated table to non-replicated *mergetree analogue. Table definition is located in the ‘metadata’ folder, ‘<code>/var/lib/clickhouse/metadata/default/table_repl.sql</code>’ in our example. Please make a backup copy and modify the file as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87">number</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intDiv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_granularity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Needs to be replaced with this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87">number</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MergeTree</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intDiv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_granularity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Attach non-replicated table.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Rename non-replicated table.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl_old</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Create a new replicated table. Take the saved attach script and replace ATTACH with CREATE, and run it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87">number</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intDiv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_granularity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Attach parts from old table to new.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl_old</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl_old</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ol>
<p>If the table has many partitions, it may require some shell script to make it easier.</p>
<h3 id="automated-approach">Automated approach</h3>
<p>For a large number of tables, you can use script  <a href="https://github.com/Altinity/clickhouse-zookeeper-recovery" target="_blank">https://github.com/Altinity/clickhouse-zookeeper-recovery</a> which partially automates the above approach.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8892167f56e913cb6f2d429fc16315c8">45.7 - ZooKeeper backup</h1>
    <div class="lead">ZooKeeper backup</div>
	<p>You may have a question: “Do I need to backup Zookeeper Database, because it’s pretty important for ClickHouse?”</p>
<p>Answer: <em>ZK is in memory database. All nodes of ZK has exactly the same data.</em></p>
<p><em>If you have 3 ZK servers, then you have 3 copies of (3 backups) already.</em></p>
<p><em>To backup ZK has no sense because you need to have a snapshot of ZK + last ZK logs to exactly the last ZK transaction.</em></p>
<p><em>You cannot use ZK database backed up 3 hours ago or 3 minutes ago.</em></p>
<p><em>ZK restored from the backup will be inconsistent with CH database.</em></p>
<p><em>Answer2: Usually, it doesn&rsquo;t have too much sense. It&rsquo;s very hard to take zookeeper snapshot at exactly the same state as clickhouse. (well maybe if you will turn of clickhouses, then you can take snapshots of clickhouse AND zookeepers). So for example on clouds if you can stop all nodes and take disk snapshots - it will just work.</em></p>
<p><em>But while clickhouse is working it&rsquo;s almost impossible to collect the current state of zookeeper.</em></p>
<p><em>You need to restore zookeeper and clickhouse snapshots from EXACTLY THE SAME moment of time - no procedure is needed. Just start &amp; run.</em></p>
<p><em>Also, that allows only to snapshot of clickhouse &amp; zookeeper as a whole. You can not do partial backups then.</em></p>
<p><em>If you lose zookeeper data while having clickhouse data (or backups of clickhouse data) - you can restore the zookeeper state from clickhouse state.</em></p>
<p><em>With a couple of tables, it can be done manually.</em></p>
<p><em>On scale, you can use</em> <a href="https://github.com/Altinity/clickhouse-zookeeper-recovery" target="_blank">https://github.com/Altinity/clickhouse-zookeeper-recovery</a></p>
<p><em>In future it will be even simpler</em> <a href="https://github.com/ClickHouse/ClickHouse/pull/13652" target="_blank">https://github.com/ClickHouse/ClickHouse/pull/13652</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f9f14245cdbc89d13e77a5b1b24de46e">45.8 - ZooKeeper cluster migration</h1>
    <div class="lead">ZooKeeper cluster migration</div>
	<p>Here is a plan for ZK 3.4.9 (no dynamic reconfiguration):</p>
<ol>
<li>Add the 3 new ZK nodes to the old cluster. No changes needed for the 3 old ZK nodes at this time.
<ol>
<li>Configure one of the new ZK nodes as a cluster of 4 nodes (3 old + 1 new), start it.</li>
<li>Configure the other two new ZK nodes as a cluster of 6 nodes (3 old + 3 new), start them.</li>
</ol>
</li>
<li>Make sure the 3 new ZK nodes connected to the old ZK cluster as followers (run <code>echo stat | nc localhost 2181</code> on the 3 new ZK nodes)</li>
<li>Confirm that the leader has 5 synced followers (run <code>echo mntr | nc localhost 2181</code> on the leader, look for <code>zk_synced_followers</code>)</li>
<li>Stop data ingestion in CH (this is to minimize errors when CH loses ZK).</li>
<li>Change the zookeeper section in the configs on the CH nodes (remove the 3 old ZK servers, add the 3 new ZK servers)</li>
<li>Make sure that there are no connections from CH to the 3 old ZK nodes (run <code>echo stat | nc localhost 2181</code> on the 3 old nodes, check their <code>Clients</code> section). Restart all CH nodes if necessary (In some cases CH can reconnect to different ZK servers without a restart).</li>
<li>Remove the 3 old ZK nodes from <code>zoo.cfg</code> on the 3 new ZK nodes.</li>
<li>Restart the 3 new ZK nodes. They should form a cluster of 3 nodes.</li>
<li>When CH reconnects to ZK, start data loading.</li>
<li>Turn off the 3 old ZK nodes.</li>
</ol>
<p>This plan works, but it is not the only way to do this, it can be changed if needed.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4b2037cae63d87dd18115b5fa7174451">45.9 - ZooKeeper Monitoring</h1>
    <div class="lead">ZooKeeper Monitoring</div>
	<h1 id="zookeeper-monitoring">ZooKeeper Monitoring</h1>
<h2 id="zookeeper">ZooKeeper</h2>
<h3 id="scrape-metrics">scrape metrics</h3>
<ul>
<li>embedded exporter since version 3.6.0
<ul>
<li><a href="https://zookeeper.apache.org/doc/r3.6.2/zookeeperMonitor.html" target="_blank">https://zookeeper.apache.org/doc/r3.6.2/zookeeperMonitor.html</a></li>
</ul>
</li>
<li>standalone exporter
<ul>
<li><a href="https://github.com/dabealu/zookeeper-exporter" target="_blank">https://github.com/dabealu/zookeeper-exporter</a></li>
</ul>
</li>
</ul>
<h3 id="install-dashboards">Install dashboards</h3>
<ul>
<li>embedded exporter <a href="https://grafana.com/grafana/dashboards/10465" target="_blank">https://grafana.com/grafana/dashboards/10465</a></li>
<li>dabealu exporter <a href="https://grafana.com/grafana/dashboards/11442" target="_blank">https://grafana.com/grafana/dashboards/11442</a></li>
</ul>
<p>See also <a href="https://grafana.com/grafana/dashboards?search=ZooKeeper&amp;dataSource=prometheus" target="_blank">https://grafana.com/grafana/dashboards?search=ZooKeeper&amp;amp;dataSource=prometheus</a></p>
<h3 id="setup-alert-rules">setup alert rules</h3>
<ul>
<li>embedded exporter <a href="https://github.com/Altinity/clickhouse-operator/blob/master/deploy/prometheus/prometheus-alert-rules-zookeeper.yaml" target="_blank">link</a></li>
</ul>
<h3 id="see-also">See also</h3>
<ul>
<li><a href="https://blog.serverdensity.com/how-to-monitor-zookeeper/" target="_blank">https://blog.serverdensity.com/how-to-monitor-zookeeper/</a></li>
<li><a href="https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/#zookeeper-metrics" target="_blank">https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/#zookeeper-metrics</a></li>
<li><a href="https://dzone.com/articles/monitoring-apache-zookeeper-servers" target="_blank">https://dzone.com/articles/monitoring-apache-zookeeper-servers</a></li>
<li><a href="https://docs.signalfx.com/en/latest/integrations/integrations-reference/integrations.zookeeper.html" target="_blank">https://docs.signalfx.com/en/latest/integrations/integrations-reference/integrations.zookeeper.html</a></li>
<li><a href="https://github.com/samber/awesome-prometheus-alerts/blob/c3ba0cf1997c7e952369a090aeb10343cdca4878/_data/rules.yml#L1146-L1170" target="_blank">https://github.com/samber/awesome-prometheus-alerts/blob/c3ba0cf1997c7e952369a090aeb10343cdca4878/_data/rules.yml#L1146-L1170</a> (or <a href="https://awesome-prometheus-alerts.grep.to/rules.html#zookeeper" target="_blank">https://awesome-prometheus-alerts.grep.to/rules.html#zookeeper</a> )</li>
<li><a href="https://alex.dzyoba.com/blog/prometheus-alerts/" target="_blank">https://alex.dzyoba.com/blog/prometheus-alerts/</a></li>
<li><a href="https://docs.datadoghq.com/integrations/zk/?tab=host" target="_blank">https://docs.datadoghq.com/integrations/zk/?tab=host</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-caaac474228860d2cc9228c7ba1fb3f9">45.10 - ZooKeeper schema</h1>
    <div class="lead">ZooKeeper schema</div>
	<h2 id="metadata">/metadata</h2>
<p>Table schema.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>date column -&gt; legacy MergeTree partition expression.
</span></span><span style="display:flex;"><span>sampling expression -&gt; SAMPLE BY
</span></span><span style="display:flex;"><span>index granularity -&gt; index_granularity
</span></span><span style="display:flex;"><span>mode -&gt; <span style="color:#204a87">type</span> of MergeTree table
</span></span><span style="display:flex;"><span>sign column -&gt; sign - CollapsingMergeTree / VersionedCollapsingMergeTree
</span></span><span style="display:flex;"><span>primary key -&gt; ORDER BY key <span style="color:#204a87;font-weight:bold">if</span> PRIMARY KEY not defined.
</span></span><span style="display:flex;"><span>sorting key -&gt; ORDER BY key <span style="color:#204a87;font-weight:bold">if</span> PRIMARY KEY defined.
</span></span><span style="display:flex;"><span>data format version -&gt; <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>partition key -&gt; PARTITION BY
</span></span><span style="display:flex;"><span>granularity bytes -&gt; index_granularity_bytes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>types of MergeTree tables:
</span></span><span style="display:flex;"><span><span style="color:#000">Ordinary</span>            <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Collapsing</span>          <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Summing</span>             <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Aggregating</span>         <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Replacing</span>           <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Graphite</span>            <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span><span style="color:#000">VersionedCollapsing</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">7</span>
</span></span></code></pre></div><h2 id="mutations">/mutations</h2>
<p>Log of latest mutations</p>
<h2 id="columns">/columns</h2>
<p>List of columns for latest (reference) table version. Replicas would try to reach this state.</p>
<h2 id="log">/log</h2>
<p>Log of latest actions with table.</p>
<p>Related settings:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">────────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┬─</span><span style="color:#000">changed</span><span style="color:#a40000">─┬─</span><span style="color:#000">description</span><span style="color:#a40000">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#a40000">───┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_replicated_logs_to_keep</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">How</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">many</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">records</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">may</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">be</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">there</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">is</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inactive</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Inactive</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">becomes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lost</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">when</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">when</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">this</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">exceed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">                                                  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt64</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">min_replicated_logs_to_keep</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Keep</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">about</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">this</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">last</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">records</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ZooKeeper</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">even</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">they</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">are</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">obsolete</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">It</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">doesn</span><span style="color:#4e9a06">&#39;t affect work of tables: used only to diagnose ZooKeeper log before cleaning. │ UInt64 │
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">└─────────────────────────────┴───────┴─────────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴────────┘
</span></span></span></code></pre></div><h2 id="replicas">/replicas</h2>
<p>List of table replicas.</p>
<h2 id="replicasreplica_name">/replicas/replica_name/</h2>
<h3 id="replicasreplica_namemutation_pointer">/replicas/replica_name/mutation_pointer</h3>
<p>Pointer to the latest mutation executed by replica</p>
<h3 id="replicasreplica_namelog_pointer">/replicas/replica_name/log_pointer</h3>
<p>Pointer to the latest task from replication_queue executed by replica</p>
<h3 id="replicasreplica_namemax_processed_insert_time">/replicas/replica_name/max_processed_insert_time</h3>
<h3 id="replicareplica_namemetadata">/replica/replica_name/metadata</h3>
<p>Table schema of specific replica</p>
<h3 id="replicareplica_namecolumns">/replica/replica_name/columns</h3>
<p>Columns list of specific replica.</p>
<h2 id="quorum">/quorum</h2>
<p>Used for quorum inserts.</p>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://twitter.com/AltinityDB">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Youtube" aria-label="Youtube">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/channel/UCE3Y2lDKl_ZfjaCrh62onYA">
      <i class="fab fa-youtube"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="LinkedIn" aria-label="LinkedIn">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/company/altinity/">
      <i class="fab fa-linkedin"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/orgs/Altinity/">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022  Altinity Inc. All Rights Reserved</small>
        <small class="ml-1"><a href="https://altinity.com/privacy-policy/" target="_blank">Privacy Policy</a></small>
	
		
	
      </div>
    </div>
  </div>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-101676615-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-101676615-2');
</script>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>






 













<script src="/js/main.min.7fa9e3e39f56ebd66798993ef3c080218d9696c971a28ef8872d750b7416a435.js" integrity="sha256-f6nj459W69ZnmJk&#43;88CAIY2Wlslxoo74hy11C3QWpDU=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
