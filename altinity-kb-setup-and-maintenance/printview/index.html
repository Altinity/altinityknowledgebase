<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=icon href=/favicons/favicon.ico><title>Setup & maintenance | Altinity® Knowledge Base for ClickHouse®</title>
<meta name=description content="Learn how to set up, deploy, monitor, and backup ClickHouse® with step-by-step guides.
"><meta property="og:url" content="http://kb.altinity.com/altinity-kb-setup-and-maintenance/"><meta property="og:site_name" content="Altinity® Knowledge Base for ClickHouse®"><meta property="og:title" content="Setup & maintenance"><meta property="og:description" content="Learn how to set up, deploy, monitor, and backup ClickHouse® with step-by-step guides."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Setup & maintenance"><meta itemprop=description content="Learn how to set up, deploy, monitor, and backup ClickHouse® with step-by-step guides."><meta itemprop=dateModified content="2024-07-30T22:09:50-04:00"><meta itemprop=keywords content="clickhouse setup,clickhouse maintenance,monitor clickhouse,data migration"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setup & maintenance"><meta name=twitter:description content="Learn how to set up, deploy, monitor, and backup ClickHouse® with step-by-step guides."><link rel=preload href=/scss/main.min.10f29ebcf80a650ac763f904f53e25ddad49c874d72279a3e2123ef3e2c93426.css as=style><link href=/scss/main.min.10f29ebcf80a650ac763f904f53e25ddad49c874d72279a3e2123ef3e2c93426.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><link rel=stylesheet href=/css/prism.css><meta name=keywords content="clickhouse setup,clickhouse maintenance,monitor clickhouse,data migration"><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/4536206.js></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","v7y63vmran")</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand-xl navbar-dark"><a class=navbar-brand href=https://altinity.com target=_blank><span class=navbar-logo><img src=/images/general/altinity-logo_horizontal_blue_white.svg width=154 alt=Altinity.com></span>
</a><button class="navbar-toggler ml-auto" type=button data-bs-toggle=collapse data-bs-target=#mobile_navbar aria-controls=mobile_navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="td-navbar-nav-scroll w-100 d-none d-xl-block" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item dropdown position-static"><a class="nav-link dropdown-toggle" href=# id=productsDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Products</a><ul class="dropdown-menu list-unstyled w-100 mega-menu" aria-labelledby=navbarDropdown><li><div class=grid-row style="grid-template-columns:35% 35% 30%"><div><h5 style=margin-bottom:15px>PRODUCTS</h5><div><div class=sub-section-header>Altinity.Cloud</div><div class=sub_links style="display:grid;grid-template-columns:50% 50%;margin-bottom:15px"><div><a href=https://altinity.com/managed-clickhouse/ id=nav_products_cloud class=med-link>Managed cloud</a><div class=desc>Deploy on Altinity’s cloud</div></div><div><a href=https://altinity.com/managed-clickhouse/bring-your-own-cloud/ id=nav_products_byoc class=med-link>Bring your own cloud</a><div class=desc>Any region, any environment</div></div></div><div class=sub_links style="display:grid;grid-template-columns:50% 50%;margin-bottom:20px"><div><a href=https://altinity.com/altinity-cloud-vs-clickhouse-cloud-faq id=nav_products_comparison><i class="fas fa-table text-primary"></i> Vendor comparison </a></div><div><a href=https://altinity.com/clickhouse-pricing/ id=nav_products_pricing><i class="fas fa-dollar-sign text-primary"></i> Pricing </a></div></div></div><div><div class=sub-section-header>Support for ClickHouse<sup>®</sup></div><a href=https://altinity.com/clickhouse-support/ id=nav_products_support class=med-link style=margin-bottom:10px>24/7 Support</a><br><a href=https://altinity.com/poc-evaluation-support/ id=nav_products_poc_evaluative_support class=med-link style=margin-bottom:10px>POC and Evaluative Support</a><br><a href=https://altinity.com/clickhouse-training/ id=nav_products_training class=med-link style=margin-bottom:10px>Training for ClickHouse<sup>®</sup></a><br></div></div><div style="border-left:1px solid rgba(255,255,255,.3);padding-left:30px"><h5 style=margin-bottom:15px>OPEN SOURCE SOFTWARE</h5><div style="margin-left:-10px;padding:5px 5px 5px 10px;margin-bottom:5px;background:rgba(24,157,208,.5);border-radius:8px"><a href=https://altinity.com/project-antalya-real-time-data-lakes/ id=nav_products_antalya_builds>NEW Project Antalya Builds </a><br><div class=desc style=margin-bottom:0>Scale ClickHouse queries infinitely with 10X cheaper data lakes</div></div><a href=https://altinity.com/altinity-stable/ id=nav_products_stable_builds>Altinity Stable Builds for ClickHouse<sup>®</sup> </a><br><div class=desc style=margin-bottom:15px>LTS-certified binaries with 3 years’ support</div><a href=https://altinity.com/kubernetes-operator/ id=nav_products_kubernetes>Altinity Kubernetes Operator for ClickHouse<sup>®</sup> </a><br><div class=desc style=margin-bottom:15px>Manage ClickHouse clusters on Kubernetes effortlessly</div><a href=https://altinity.com/altinity-backup-for-clickhouse/ id=nav_products_backup>Altinity Backup for ClickHouse<sup>®</sup> </a><br><div class=desc style=margin-bottom:15px>Simple backup and restore tool for ClickHouse</div><a href=https://altinity.com/ecosystem/>See more > </a></div><div style="border-left:1px solid rgba(255,255,255,.3);padding-left:30px"><h5 style=margin-bottom:15px>CLICKHOUSE<sup>®</sup> SOLUTIONS</h5><a href=https://altinity.com/observability-and-logging/ id=nav_observability>Observability & Logging </a><br><div class=desc style=margin-bottom:15px>Manage high-volume observability data efficiently</div><a href=https://altinity.com/security-information-and-event-management/ id=nav_siem>Security Information and Event Management (SIEM) </a><br><div class=desc style=margin-bottom:15px>Efficiently process and analyze high-volume security events</div><a href=https://altinity.com/trading-systems/ id=nav_trading_systems>Trading Analytics </a><br><div class=desc style=margin-bottom:15px>Make faster market decisions</div></div></div><div class=grid-row style="grid-template-columns:33% 60%;border-top:1px solid rgba(255,255,255,.3)"><div><a href=https://altinity.com/customer-stories/ id=nav_products_customer_stories>Customer stories </a><br><div class=desc>See why our customers love us</div></div><div><a href=https://altinity.com/plans-and-features-clickhouse/ id=nav_products_plans_features>Altinity Plans and Features </a><br><div class=desc>Managed service or support? Compare plans and features</div></div></div></li></ul></li><li class="nav-item dropdown position-static"><a class="nav-link dropdown-toggle" href=# id=resourceDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Resources</a><ul class="dropdown-menu list-unstyled w-100 mega-menu" aria-labelledby=navbarDropdown><li><div class=grid-row><div><p class=col-header>Developer Center</p><div><a href=https://docs.altinity.com/ target=_blank id=nav_resources_docs>Documentation </a><div class=desc>Product guides and tutorials</div><br></div><div><a href=https://kb.altinity.com/ target=_blank id=nav_resources_knowledgebase>Knowledge Base </a><div class=desc>Answers to common questions and issues</div><br></div><div><a href="https://altinity.com/blog/?cat=webinarspage" target=_blank id=nav_resources_webinars>Past Webinars </a><div class=desc>Watch anytime, on demand.</div><br></div><div><a href=https://altinity.com/developer-resources/ id=nav_resources_dev_resources>More Technical Content </a><div class=desc>How-to guides and videos</div><br></div></div><div><p class=col-header>Learning</p><div><a href=https://altinity.com/clickhouse-database/ id=nav_resources_what_is_ch>What is ClickHouse? </a><div class=desc>New to ClickHouse? Start here</div><br></div><div><a href=https://altinity.com/kubernetes-operator/ id=nav_resources_k8s_operator>Kubernetes Operator </a><div class=desc>Learn how it works and who uses it</div><br></div><div><a href=https://altinity.com/unevenly-distributed/ id=nav_unevenlydistributed>Unevenly Distributed </a><div class=desc>A Thought Leadership Series on Real-Time Data Lakes</div><br></div><div><a href=https://altinity.com/altinity-stable/ id=nav_resources_stable>Altinity Stable Builds </a><div class=desc>Learn why you should be using them in your prod environments</div><br></div></div><div><p class=col-header>Community</p><div><a href=https://altinity.com/ecosystem/ id=nav_resources_open_source>Open Source at Altinity </a><div class=desc>Explore our open source projects and contributions</div><br></div><div><a href=https://altinity.com/events/ id=nav_resources_events>Events </a><div class=desc>Upcoming conferences, events, and webinars</div><br></div><div><a href=https://altinity.com/slack/ target=_blank id=nav_resources_slack>Slack Community </a><div class=desc>Get help for any ClickHouse issue from experts</div><br></div><div><a href=https://altinity.com/office-hours-for-clickhouse/ id=nav_resources_office_hours>Monthly Office Hours </a><div class=desc>Meet our engineers live and ask your questions</div><br></div></div></div></li></ul></li><li class=nav-item><a class=nav-link href=https://altinity.com/blog target=_blank>Blog</a></li><li class="nav-item dropdown position-static"><a class="nav-link dropdown-toggle" href=# id=companyDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Company</a><ul class="dropdown-menu list-unstyled w-100 mega-menu" aria-labelledby=navbarDropdown><li><div class=grid-row><div><div><a href=https://altinity.com/about-us/ id=nav_company_about>About the company  </a></div><div><a href=https://altinity.com/about-us/#leadership id=nav_company_leadership>Leadership </a></div></div><div><div><a href=https://altinity.com/about-us/press-releases/ id=nav_company_press>Press Releases </a></div><div><a href=https://altinity.com/partners/ id=nav_company_partners>Partners </a></div></div><div><div><a href=https://altinity.com/customer-stories/ id=nav_company_customer_stories>Customer Stories </a></div><div><a href=https://altinity.com/careers/ id=nav_company_careers>Careers </a></div></div><div class=mega-bg-blue><div><h5>Get in touch with ClickHouse experts.</h5><a href=https://altinity.com/contact class="btn btn-primary button">Contact Us </a></div></div></div></li></ul></li><li class=nav-item><a class=nav-link href=https://altinity.com/contact target=_blank>Contact</a></li><li class="header-social-wrap ml-md-auto"><a class=navbar-button href=https://altinity.com/free-clickhouse-consultation/ target=_blank>Tech Support</a>
<a class=navbar-button href=https://acm.altinity.cloud/signup target=_blank style=margin-right:15px>ClickHouse® in Cloud</a>
<a href=https://www.youtube.com/@Altinity aria-label=Slack target=_blank rel="noopener noreferrer" class="social-button header-social-item"><span class=social-icon-custom-svg style=max-width:34px><svg fill="currentcolor" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28"><title>YouTube</title><path d="M11.109 17.625l7.562-3.906-7.562-3.953v7.859zM14 4.156c5.891.0 9.797.281 9.797.281.547.063 1.75.063 2.812 1.188.0.0.859.844 1.109 2.781.297 2.266.281 4.531.281 4.531v2.125s.016 2.266-.281 4.531c-.25 1.922-1.109 2.781-1.109 2.781-1.062 1.109-2.266 1.109-2.812 1.172.0.0-3.906.297-9.797.297v0c-7.281-.063-9.516-.281-9.516-.281-.625-.109-2.031-.078-3.094-1.188.0.0-.859-.859-1.109-2.781-.297-2.266-.281-4.531-.281-4.531v-2.125s-.016-2.266.281-4.531C.531 6.469 1.39 5.625 1.39 5.625 2.452 4.5 3.656 4.5 4.202 4.437c0 0 3.906-.281 9.797-.281v0z"/></svg>
</span></a><a href=https://altinity.com/slack/ aria-label=Slack target=_blank rel="noopener noreferrer" class="social-button header-social-item"><span class=social-icon-custom-svg style=max-width:34px><svg viewBox="0 0 36 36" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path fill="currentcolor" d="M7.563 22.747a3.782 3.782.0 11-3.78-3.78h3.78v3.78zm1.906.0a3.782 3.782.0 017.563.0v9.469a3.782 3.782.0 11-7.563.0V22.747zM13.251 7.563a3.782 3.782.0 113.782-3.78v3.78H13.251zm0 1.906a3.781 3.781.0 110 7.563H3.783a3.782 3.782.0 110-7.563h9.468zm15.183 3.782a3.783 3.783.0 113.783 3.782H28.434V13.251zm-1.9.0a3.782 3.782.0 01-7.565.0V3.783a3.782 3.782.0 117.564.0zM22.747 28.434a3.783 3.783.0 11-3.78 3.783V28.434h3.78zm0-1.9a3.782 3.782.0 010-7.565h9.469a3.782 3.782.0 110 7.564z" data-name="Icon simple-slack" id="Icon_simple-slack"/></svg>
</span></a><a href=https://github.com/altinity/ aria-label=GitHub target=_blank rel="noopener noreferrer" class="social-button header-social-item"><svg fill="currentcolor" xmlns="http://www.w3.org/2000/svg" width="24" height="28" viewBox="0 0 24 28"><title>Github</title><path d="M12 2c6.625.0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-.609.109-.828-.266-.828-.578.0-.391.016-1.687.016-3.297.0-1.125-.375-1.844-.812-2.219 2.672-.297 5.484-1.313 5.484-5.922.0-1.313-.469-2.375-1.234-3.219.125-.313.531-1.531-.125-3.187-1-.313-3.297 1.234-3.297 1.234-.953-.266-1.984-.406-3-.406s-2.047.141-3 .406c0 0-2.297-1.547-3.297-1.234-.656 1.656-.25 2.875-.125 3.187-.766.844-1.234 1.906-1.234 3.219.0 4.594 2.797 5.625 5.469 5.922-.344.313-.656.844-.766 1.609-.688.313-2.438.844-3.484-1-.656-1.141-1.844-1.234-1.844-1.234-1.172-.016-.078.734-.078.734.781.359 1.328 1.75 1.328 1.75.703 2.141 4.047 1.422 4.047 1.422.0 1 .016 1.937.016 2.234.0.313-.219.688-.828.578-4.766-1.594-8.203-6.094-8.203-11.391.0-6.625 5.375-12 12-12zM4.547 19.234c.031-.063-.016-.141-.109-.187-.094-.031-.172-.016-.203.031-.031.063.016.141.109.187.078.047.172.031.203-.031zM5.031 19.766c.063-.047.047-.156-.031-.25-.078-.078-.187-.109-.25-.047-.063.047-.047.156.031.25.078.078.187.109.25.047zM5.5 20.469c.078-.063.078-.187.0-.297-.063-.109-.187-.156-.266-.094-.078.047-.078.172.0.281s.203.156.266.109zM6.156 21.125c.063-.063.031-.203-.063-.297-.109-.109-.25-.125-.313-.047-.078.063-.047.203.063.297.109.109.25.125.313.047zM7.047 21.516c.031-.094-.063-.203-.203-.25-.125-.031-.266.016-.297.109s.063.203.203.234c.125.047.266.0.297-.094zM8.031 21.594c0-.109-.125-.187-.266-.172-.141.0-.25.078-.25.172.0.109.109.187.266.172.141.0.25-.078.25-.172zM8.937 21.438c-.016-.094-.141-.156-.281-.141-.141.031-.234.125-.219.234.016.094.141.156.281.125s.234-.125.219-.219z"/></svg></a></li></ul></div></nav><div id=mobile_navbar class="collapse js-navbar-scroll navbar-collapse d-xl-none"><ul class="menu has-collapse-sub-nav"><li class="nav-item nav-item-has-children active"><div class=drawer-nav-drop-wrap><a>Products</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a href=https://altinity.com/managed-clickhouse/>Altinity.Cloud</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/clickhouse-pricing/>Pricing for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/altinity-cloud-vs-clickhouse-cloud-faq/>Altinity.Cloud vs ClickHouse Cloud FAQ</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-support/>Support for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-training/>Training for ClickHouse</a></li></ul></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a href=https://altinity.com/ecosystem/>Open Source Software</a></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/project-antalya-real-time-data-lakes/>Project Antalya</a></li><li class=nav-item><a href=https://altinity.com/altinity-stable/>Altinity Stable Builds</a></li><li class=nav-item><a href=https://altinity.com/kubernetes-operator/>Kubernetes Operator</a></li><li class=nav-item><a href=https://altinity.com/altinity-backup-for-clickhouse/>Altinity Backup for ClickHouse</a></li></ul></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a>ClickHouse™ Solutions</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/observability-and-logging/>Observability & Logging with ClickHouse®</a></li><li class=nav-item><a href=https://altinity.com/security-information-and-event-management/>Security Information and Event Management (SIEM) with ClickHouse®</a></li><li class=nav-item><a href=https://altinity.com/trading-systems/>Trading analytics with ClickHouse®</a></li></ul></li></ul></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a>Resources</a></div><ul class=sub-menu><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a href=#>Developer Center</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a target=_blank href=https://docs.altinity.com/>Documentation</a></li><li class=nav-item><a target=_blank href=https://kb.altinity.com/>Knowledge Base</a></li><li class=nav-item><a href="https://altinity.com/blog/?cat=webinarspage">Past Webinars</a></li><li class=nav-item><a href=https://altinity.com/developer-resources/>Guides and eBooks</a></li></ul></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a href=#>Learning</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/clickhouse-database/>What is ClickHouse?</a></li><li class=nav-item><a href=https://altinity.com/what-is-kubernetes/>What is Kubernetes?</a></li><li class=nav-item><a href=https://altinity.com/unevenly-distributed/>Unevenly Distributed</a></li><li class=nav-item><a href=https://altinity.com/altinity-stable/>Altinity Stable Builds</a></li></ul></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a href=#>Community</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/events>Events</a></li><li class="nav-slack nav-item"><a target=_blank href=http://www.localhost:10008/slack>Slack Community</a></li><li class=nav-item><a href=https://altinity.com/office-hours-for-clickhouse/>Office Hours for ClickHouse®</a></li></ul></li></ul></li><li class=nav-item><a href=https://altinity.com/blog>Blog</a></li><li class="nav-item nav-item-has-children"><div class=drawer-nav-drop-wrap><a>Company</a><span class=mobile-drop-toggle></span></div><ul class=sub-menu><li class=nav-item><a href=https://altinity.com/about-us/>About Altinity</a></li><li class=nav-item><a href=https://altinity.com/about-us/#leadership>Leadership</a></li><li class=nav-item><a href=https://altinity.com/about-us/press-releases/>Press Releases</a></li><li class=nav-item><a href=https://altinity.com/partners/>Partners</a></li><li class=nav-item><a href=https://altinity.com/customer-stories/>Customer Stories</a></li><li class=nav-item><a href=https://altinity.com/careers/>Careers</a></li></ul></li><li class=nav-item><a href=https://altinity.com/contact>Contact</a></li><li class="header-nav-button nav-item"><a href=https://altinity.com/free-clickhouse-consultation>Tech Support</a></li><li class="header-nav-button nav-item"><a href="https://acm.altinity.cloud/signup?__hstc=173202428.421802398cbec3b5d6457748d00d825f.1702395478849.1769622795179.1769630357065.395&__hssc=173202428.9.1769630357065&__hsfp=e5063c5ad56e06035f046e27f2ea897a">ClickHouse® in Cloud</a></li></ul></div></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/altinity-kb-setup-and-maintenance/>Return to the regular view of this page</a>.</p></div><h1 class=title>Setup & maintenance</h1><div class=lead>Learn how to set up, deploy, monitor, and backup ClickHouse® with step-by-step guides.</div><ul><li>1: <a href=#pg-17895b08eba3969685dec534c8c71f9f>S3 & object storage</a></li><ul><li>1.1: <a href=#pg-828bae3b9b7642a9616204fb40e1e9ed>AWS S3 Recipes</a></li><li>1.2: <a href=#pg-f237075cd12a3b0d6ced37b10cce00ac>Clean up orphaned objects on s3</a></li><li>1.3: <a href=#pg-db2b60c010ae5fb71a41ed626158cd0e>How much data are written to S3 during mutations</a></li><li>1.4: <a href=#pg-801e0b0de3b47ed85a19172aec522cdc>Example of the table at s3 with cache</a></li><li>1.5: <a href=#pg-56d30b1c77fb6e372359df908c32cf1a>S3Disk</a></li></ul><li>2: <a href=#pg-3fadca3aea85e2e4d4fe0090f2c8c658>AggregateFunction(uniq, UUID) doubled after ClickHouse® upgrade</a></li><li>3: <a href=#pg-842ce56e1a0b0d67156403a261b18400>Can not connect to my ClickHouse® server</a></li><li>4: <a href=#pg-5c047eed8f820765587e3275057bd864>cgroups and kubernetes cloud providers</a></li><li>5: <a href=#pg-07649d2fd60036daef12d2739b51964f>Transforming ClickHouse logs to ndjson using Vector.dev</a></li><li>6: <a href=#pg-65c6ddd3186c33d4134ea5a9bd44bff4>Altinity Kubernetes Operator For ClickHouse®</a></li><li>7: <a href=#pg-f882d95e5c344921805c85f5e5a656df>ClickHouse® and different filesystems</a></li><li>8: <a href=#pg-ba31da9c4b193969853f742350ad98c9>ClickHouse® Access Control and Account Management (RBAC)</a></li><li>9: <a href=#pg-d7be1dae9438949199e19edc0af65a98>Client Timeouts</a></li><li>10: <a href=#pg-6f3f5a9c15f13480a872c2baa138f08e>Compatibility layer for the Altinity Kubernetes Operator for ClickHouse®</a></li><li>11: <a href=#pg-44473f5247ffb40a8d1157112098a815>How to convert uniqExact states to approximate uniq functions states</a></li><li>12: <a href=#pg-2bf046fe139243d74994289f2cb4e13e>Custom Settings</a></li><li>13: <a href=#pg-bbd4c8156a39e2b06aedbc53ab2fcc76>Description of asynchronous_metrics</a></li><li>14: <a href=#pg-bc860412ddbc53eff7624f80da132f8a>ClickHouse® data/disk encryption (at rest)</a></li><li>15: <a href=#pg-3345c1c9243b7996f5a1bc9dfc258697>DR two DC</a></li><li>16: <a href=#pg-fd903f5df1be4cc98c6592a99d2d5fd3>How ALTERs work in ClickHouse®</a></li><li>17: <a href=#pg-0d0e01b25f15d892fbdca2892ed4b4db>How to recreate a table in case of total corruption of the replication queue</a></li><li>18: <a href=#pg-7e8b8793d3f75d7f6e63b71cccb3389e>http handler example</a></li><li>19: <a href=#pg-acb1233adf7c1120a677110649007b44>Jemalloc heap profiling</a></li><li>20: <a href=#pg-7c6fe7411111212f4a99eb416db8e345>Logging</a></li><li>21: <a href=#pg-51b917d4fd065fa272b7500abbb83250>High Memory Usage During Merge in system.metric_log</a></li><li>22: <a href=#pg-d380f73c2612b91e3bc35f59f39febe2>Precreate parts using clickhouse-local</a></li><li>23: <a href=#pg-178be1fa49d7fab0cb9c1deba7df54ca>Recovery after complete data loss</a></li><li>24: <a href=#pg-201ba5457615d6a2df6a866dd2a93fcf>Replication: Can not resolve host of another ClickHouse® server</a></li><li>25: <a href=#pg-a621d627feb47445d97f056ab85fb1c0>source parts size is greater than the current maximum</a></li><li>26: <a href=#pg-598152e68b617d22b315a15725d3db6c>Successful ClickHouse® deployment plan</a></li><li>27: <a href=#pg-3ace1f73ef71bda112e1d794cc271c40>sysall database (system tables on a cluster level)</a></li><li>28: <a href=#pg-36bd996bf58568ac32e55cbc1970dce1>Timeouts during OPTIMIZE FINAL</a></li><li>29: <a href=#pg-61617b049d0115dc2404f965ada72153>Use an executable dictionary as cron task</a></li><li>30: <a href=#pg-bdd41222cb6666cd88673471ac35bde8>Useful settings to turn on/Defaults that should be reconsidered</a></li><li>31: <a href=#pg-31af424ed53bcf5281bdfaa78ab9a1ed>Who ate my CPU</a></li><li>32: <a href=#pg-3c882b894707a1546ab5cd4e5a238a68>Zookeeper session has expired</a></li><li>33: <a href=#pg-ef428242bace20ed80fc2a5a94cbc2e1>Server configuration files</a></li><li>34: <a href=#pg-4640fdb70e9b5dc2e6dae39a6d075a5c>Aggressive merges</a></li><li>35: <a href=#pg-482a9e1e23251a246ec9901728b5dda1>Altinity Backup for ClickHouse®</a></li><li>36: <a href=#pg-c5646e9a69c9b22cfb88e043089f04f0>Altinity packaging compatibility >21.x and earlier</a></li><li>37: <a href=#pg-8e50fd6090d2cd6ea786d66d7fc1dc14>AWS EC2 Storage</a></li><li>38: <a href=#pg-4789c5a0fbc6e298289a42e92e966f51>ClickHouse® in Docker</a></li><li>39: <a href=#pg-e2ee81b31da5dc08de7cc4b0235f75fd>ClickHouse® Monitoring</a></li><li>40: <a href=#pg-199cb1e25e9c6fa0e0312726a5acd246>ClickHouse® versions</a></li><li>41: <a href=#pg-51b1a2dc10fa414bfbbc21dc14811f6f>Configure ClickHouse® for low memory environments</a></li><li>42: <a href=#pg-0bbf5bd9eca8f96d4529ea56056d69c4>Converting MergeTree to Replicated</a></li><li>43: <a href=#pg-156c434f74af4cc1f5844eb80c8a1d57>Data Migration</a></li><ul><li>43.1: <a href=#pg-995190106d7ed9690cfa9cfd364aec72>MSSQL bcp pipe to clickhouse-client</a></li><li>43.2: <a href=#pg-11fb2857cf3b2c7a29cb57f3cb63eba6>Add/Remove a new replica to a ClickHouse® cluster</a></li><li>43.3: <a href=#pg-49f38a883c7ec4fc908726a6854c7bbe>clickhouse-copier</a></li><ul><li>43.3.1: <a href=#pg-e1f1d825521583c133a8d3bf2a72f6e7>clickhouse-copier 20.3 and earlier</a></li><li>43.3.2: <a href=#pg-4907e613a878d5b7819f49cc367b9f3f>clickhouse-copier 20.4 - 21.6</a></li><li>43.3.3: <a href=#pg-092d5c190f9504b9126ab5f7779a2089>Kubernetes job for clickhouse-copier</a></li></ul><li>43.4: <a href=#pg-775c97dd3622aad5380ef8cd9f7472ad>Distributed table to ClickHouse® Cluster</a></li><li>43.5: <a href=#pg-6b8cf3862e661a5ba53de12323896812>Fetch Alter Table</a></li><li>43.6: <a href=#pg-384352a945ec192141ea6fb13e0f518f>Remote table function</a></li><li>43.7: <a href=#pg-69e50f36eba192534d9f891226a8196a>Moving ClickHouse to Another Server</a></li></ul><li>44: <a href=#pg-ac091a7a3a7a23bf1a7c0acd539339ce>DDLWorker and DDL queue problems</a></li><ul><li>44.1: <a href=#pg-7f5f8971a74cdc0af853041c9dd18c8f>There are N unfinished hosts (0 of them are currently active).</a></li></ul><li>45: <a href=#pg-d3de9fe2d4264f8c0b10d27225d8c18c>differential backups using clickhouse-backup</a></li><li>46: <a href=#pg-492a58dfa6abf818e811a55026049ff2>High CPU usage in ClickHouse®</a></li><li>47: <a href=#pg-55be77301bcff9aa2583091b11b429d0>Load balancers</a></li><li>48: <a href=#pg-a5bef820919d4f1ad9265cdefeca05f5>memory configuration settings</a></li><li>49: <a href=#pg-94984fd09fca23975a3d97b23569608e>Memory Overcommiter</a></li><li>50: <a href=#pg-605ad2e3cca983282a1dbf9607bb550c>Moving a table to another device</a></li><li>51: <a href=#pg-60329cb30d1cf552b84e2cee02de47b7>Object consistency in a cluster</a></li><li>52: <a href=#pg-b4d9520dcb2feeb131e8e5640308a411>Production Cluster Configuration Guide</a></li><ul><li>52.1: <a href=#pg-202b7e3651622a4779b38f52cef739a7>Backups</a></li><li>52.2: <a href=#pg-8064c7d414e643fb87b3e0939260d98f>Cluster Configuration FAQ</a></li><li>52.3: <a href=#pg-839cbf636b5f8a35c6823f41977447f7>Cluster Configuration Process</a></li><li>52.4: <a href=#pg-3754a72a1a168184ed696d361b761145>Hardware Requirements</a></li><li>52.5: <a href=#pg-414e2937f5573cccbd17d35a64e42c62>Network Configuration</a></li></ul><li>53: <a href=#pg-e64ef5a4f506fd394e7168728f58b04b>System tables ate my disk</a></li><li>54: <a href=#pg-9f492adefec5edc496d0909f604aa8ff>ClickHouse® Replication problems</a></li><li>55: <a href=#pg-13df9db0c6033eb5e2bfdfb7089294a2>Replication queue</a></li><li>56: <a href=#pg-b49d062b4f5879d725ccb9b4aedf0f07>Schema migration tools for ClickHouse®</a></li><ul><li>56.1: <a href=#pg-f4359fae9928fc2ceb30bfc0e2c0b8d2>golang-migrate</a></li></ul><li>57: <a href=#pg-3ea70b58bc10fe6596f9888998227ac9>Settings to adjust</a></li><li>58: <a href=#pg-f46a585ead49a5db2d19ee263d652ffa>Shutting down a node</a></li><li>59: <a href=#pg-ea9b4077205d7c579bd465b784e33e77>SSL connection unexpectedly closed</a></li><li>60: <a href=#pg-ec43a5205301eb00c48712282b7243ed>Suspiciously many broken parts</a></li><li>61: <a href=#pg-14dc574ea90d3f73fbe3876ff659dd99>Threads</a></li><li>62: <a href=#pg-403fab8125b657a5a3d0f82db33c7544>Who ate my ClickHouse® memory?</a></li><li>63: <a href=#pg-001c962263e4fe6ade35b2640d581f26>X rows of Y total rows in filesystem are suspicious</a></li><li>64: <a href=#pg-475baf90f39df7559ac79d0838516eba>ZooKeeper</a></li><ul><li>64.1: <a href=#pg-fe6c92b41d659a61ae843a9c968db4e3>clickhouse-keeper-initd</a></li><li>64.2: <a href=#pg-582314d0ec1bd636faae316fd661315c>clickhouse-keeper-service</a></li><li>64.3: <a href=#pg-05425e768ddcc5be5d1203f59044e6d5>Install standalone Zookeeper for ClickHouse® on Ubuntu / Debian</a></li><li>64.4: <a href=#pg-564a3bbd39f9550e577334d912a883dc>How to check the list of watches</a></li><li>64.5: <a href=#pg-722cb96284be123698aa3e56ea92ecaf>JVM sizes and garbage collector settings</a></li><li>64.6: <a href=#pg-1ef2081889fb4a086febf3b281e44778>Proper setup</a></li><li>64.7: <a href=#pg-66b660806f12af38114754857823e52a>Recovering from complete metadata loss in ZooKeeper</a></li><li>64.8: <a href=#pg-4c33701373e85b893c3b3464fa4f6683>Using clickhouse-keeper</a></li><li>64.9: <a href=#pg-8892167f56e913cb6f2d429fc16315c8>ZooKeeper backup</a></li><li>64.10: <a href=#pg-f9f14245cdbc89d13e77a5b1b24de46e>ZooKeeper cluster migration</a></li><li>64.11: <a href=#pg-9eb0d707fbf1e834507aa5b61897fc15>ZooKeeper cluster migration when using K8s node local storage</a></li><li>64.12: <a href=#pg-4b2037cae63d87dd18115b5fa7174451>ZooKeeper Monitoring</a></li><li>64.13: <a href=#pg-caaac474228860d2cc9228c7ba1fb3f9>ZooKeeper schema</a></li></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-17895b08eba3969685dec534c8c71f9f>1 - S3 & object storage</h1><div class=lead>S3 & object storage</div></div><div class=td-content><h1 id=pg-828bae3b9b7642a9616204fb40e1e9ed>1.1 - AWS S3 Recipes</h1><div class=lead>AWS S3 Recipes</div><h2 id=using-aws-iam--identity-and-access-management-roles>Using AWS IAM — Identity and Access Management roles</h2><p>For EC2 instance, there is an option to configure an IAM role:</p><p><img src=/assets/select-ec2-iam-role.png></p><p>Role shall contain a policy with permissions like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;Version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;2012-10-17&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;Statement&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;Sid&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;allow-put-and-get&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;Effect&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Allow&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;Action&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;s3:PutObject&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;s3:GetObject&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;Resource&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;arn:aws:s3:::BUCKET_NAME/test_s3_disk/*&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Corresponding configuration of ClickHouse®:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;storage_configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;disks&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;disk_s3&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>s3<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;endpoint&gt;</span>http://s3.us-east-1.amazonaws.com/BUCKET_NAME/test_s3_disk/<span style=color:#204a87;font-weight:700>&lt;/endpoint&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;use_environment_credentials&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/use_environment_credentials&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/disk_s3&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/disks&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;policies&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;policy_s3_only&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;volumes&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;volume_s3&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#204a87;font-weight:700>&lt;disk&gt;</span>disk_s3<span style=color:#204a87;font-weight:700>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;/volume_s3&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/volumes&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/policy_s3_only&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/policies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/storage_configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><p>Small check:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>MergeTree</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tuple</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tuple</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage_policy</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;policy_s3_only&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>numbers</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_s3</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_s3</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=how-to-use-aws-irsa-and-iam-in-the-altinity-kubernetes-operator-for-clickhouse-to-allow-s3-backup-without-explicit-credentials>How to use AWS IRSA and IAM in the Altinity Kubernetes Operator for ClickHouse to allow S3 backup without Explicit credentials</h2><p>Install <code>clickhouse-operator</code> <a href=https://github.com/Altinity/clickhouse-operator/tree/master/docs/operator_installation_details.md target=_blank>https://github.com/Altinity/clickhouse-operator/tree/master/docs/operator_installation_details.md</a></p><p>Create Role <role name>and IAM Policy, look details in <a href=https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-enable-IAM.html target=_blank>https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-enable-IAM.html</a></p><p>Create service account with annotations</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;SERVICE ACOUNT NAME&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;NAMESPACE&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>eks.amazonaws.com/role-arn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arn:aws:iam::&lt;ACCOUNT_ID&gt;:role/&lt;ROLE_NAME&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Link service account to podTemplate it will create <code>AWS_ROLE_ARN</code> and <code>AWS_WEB_IDENTITY_TOKEN_FILE</code> environment variables.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;clickhouse.altinity.com/v1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;ClickHouseInstallation&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;NAME&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;NAMESPACE&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>defaults</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>templates</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>podTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;POD_TEMPLATE_NAME&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>templates</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>podTemplates</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;POD_TEMPLATE_NAME&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>serviceAccountName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;SERVICE ACCOUNT NAME&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse-backup</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>For EC2 instances the same environment variables should be created:</p><pre tabindex=0><code>AWS_ROLE_ARN=arn:aws:iam::&lt;ACCOUNT_ID&gt;:role/&lt;ROLE_NAME&gt;
AWS_WEB_IDENTITY_TOKEN_FILE=/var/run/secrets/eks.amazonaws.com/serviceaccount/token
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-f237075cd12a3b0d6ced37b10cce00ac>1.2 - Clean up orphaned objects on s3</h1><div class=lead>Clean up orphaned objects left in an S3-backed ClickHouse tiered‐storage</div><h3 id=problems>Problems</h3><ul><li>TRUNCATE and DROP TABLE remove <strong>metadata only</strong>.</li><li>Long-running queries, merges or other replicas may still reference parts, so ClickHouse delays removal.</li><li>There are bugs in Clickhouse that leave orphaned files, especially after failures.</li></ul><h3 id=solutions>Solutions</h3><ul><li>use our utility for garbage collection - <a href=https://github.com/Altinity/s3gc target=_blank>https://github.com/Altinity/s3gc</a></li><li>or create a separate path in the bucket for every table and every replica and remove the whole path in AWS console</li><li>you can also use <a href=https://clickhouse.com/docs/operations/utilities/clickhouse-disks target=_blank rel=nofollow>clickhouse-disk</a>
utility to delete s3 data:</li></ul><pre tabindex=0><code>clickhouse-disks --disk s3 --query &#34;remove /cluster/database/table/replica1&#34;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-db2b60c010ae5fb71a41ed626158cd0e>1.3 - How much data are written to S3 during mutations</h1><div class=lead>Example of how much data ClickHouse® reads and writes to s3 during mutations.</div><h2 id=configuration>Configuration</h2><p>S3 disk with disabled merges</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;storage_configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;disks&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;s3disk&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>s3<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;endpoint&gt;</span>https://s3.us-east-1.amazonaws.com/mybucket/test/test/<span style=color:#204a87;font-weight:700>&lt;/endpoint&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;use_environment_credentials&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/use_environment_credentials&gt;</span>  <span style=color:#8f5902;font-style:italic>&lt;!-- use IAM AWS role --&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>&lt;!--access_key_id&gt;xxxx&lt;/access_key_id&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;secret_access_key&gt;xxx&lt;/secret_access_key--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/s3disk&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/disks&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;policies&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;s3tiered&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;volumes&gt;</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>                      <span style=color:#204a87;font-weight:700>&lt;disk&gt;</span>default<span style=color:#204a87;font-weight:700>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&lt;s3disk&gt;</span>
</span></span><span style=display:flex><span>                      <span style=color:#204a87;font-weight:700>&lt;disk&gt;</span>s3disk<span style=color:#204a87;font-weight:700>&lt;/disk&gt;</span>  
</span></span><span style=display:flex><span>                      <span style=color:#204a87;font-weight:700>&lt;prefer_not_to_merge&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/prefer_not_to_merge&gt;</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&lt;/s3disk&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;/volumes&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/s3tiered&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/policies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/storage_configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><p>Let&rsquo;s create a table and load some synthetic data.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>D</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Date</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage_policy</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3tiered&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>today</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intDiv</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000>e8</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>98</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>091</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>700</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>57</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_on_disk</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_count</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;test_s3&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>disk_name</span><span style=color:#a40000>─┬─</span><span style=color:#000>partition</span><span style=color:#a40000>──┬─</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>──────┬─</span><span style=color:#000>part_count</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>06</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>....</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>77</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>39</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴────────────┴───────────┴───────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>70</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>023</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=performance-of-mutations-for-a-local-ebs-throughput-500-mbs>Performance of mutations for a local EBS (throughput: 500 MB/s)</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>490000000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>020</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>92</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>67</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>419</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>74</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;490000000&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>117</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>700</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>49</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>49</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>59</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>884</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>68</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;490000000&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>192</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;490000001&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>243</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>590000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mutations_sync</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>387</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;590000001&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mutations_sync</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>372</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>update</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;690000000&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mutations_sync</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>265</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>update</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;690000001&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mutations_sync</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>979</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=lets-move-data-to-s3>Let&rsquo;s move data to S3</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>modify</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TTL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>interval</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>day</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3disk&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- 10 minutes later
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>┌─</span><span style=color:#000>disk_name</span><span style=color:#a40000>─┬─</span><span style=color:#000>partition</span><span style=color:#a40000>──┬─</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>──────┬─</span><span style=color:#000>part_count</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>06</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>02</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>77</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴────────────┴───────────┴───────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>70</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>007</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=sizes-of-a-table-on-s3-and-a-size-of-each-column>Sizes of a table on S3 and a size of each column</h3><pre tabindex=0><code>select sum(rows), formatReadableSize(sum(bytes_on_disk)) size 
from system.parts where table= &#39;test_s3&#39; and active and disk_name = &#39;s3disk&#39;;
┌─sum(rows)─┬─size─────┐
│ 600000000 │ 4.58 GiB │
└───────────┴──────────┘

SELECT
    database,
    table,
    column,
    formatReadableSize(sum(column_data_compressed_bytes) AS size) AS compressed
FROM system.parts_columns
WHERE (active = 1) AND (database LIKE &#39;%&#39;) AND (table LIKE &#39;test_s3&#39;) AND (disk_name = &#39;s3disk&#39;)
GROUP BY
    database,
    table,
    column
ORDER BY column ASC

┌─database─┬─table───┬─column─┬─compressed─┐
│ default  │ test_s3 │ A      │ 2.22 GiB   │
│ default  │ test_s3 │ D      │ 5.09 MiB   │
│ default  │ test_s3 │ S      │ 2.33 GiB   │
└──────────┴─────────┴────────┴────────────┘
</code></pre><h2 id=s3-statistics-of-selects>S3 Statistics of selects</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_part</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─────────</span><span style=color:#000>A</span><span style=color:#a40000>─┬─</span><span style=color:#000>S</span><span style=color:#a40000>─────────┬──────────</span><span style=color:#000>D</span><span style=color:#a40000>─┬─</span><span style=color:#000>_part</span><span style=color:#a40000>──────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20230708</span><span style=color:#000>_106_111_1_738</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴───────────┴────────────┴────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>104</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>65</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>56</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>79</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>633</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>S3GetObject</span><span style=color:#a40000>─┬─</span><span style=color:#000>S3PutObject</span><span style=color:#a40000>─┬─</span><span style=color:#000>ReadBufferFromS3</span><span style=color:#a40000>─┬─</span><span style=color:#000>WriteBufferFromS3</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>70</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>58</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KiB</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────┴─────────────┴──────────────────┴───────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Select by primary key read only 70.58 KiB from S3</p><p>Size of this part</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>column_data_compressed_bytes</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>compressed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts_columns</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;test_s3&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>disk_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3disk&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;20230708_106_111_1_738&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ASC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#a40000>───┬─</span><span style=color:#204a87;font-weight:700>column</span><span style=color:#a40000>─┬─</span><span style=color:#000>compressed</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>51</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>51</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>47</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KiB</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>52</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────┴─────────┴────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;100000000&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─────────</span><span style=color:#000>A</span><span style=color:#a40000>─┬─</span><span style=color:#000>S</span><span style=color:#a40000>─────────┬──────────</span><span style=color:#000>D</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴───────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>86</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>745</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>700</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>49</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>144</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>S3GetObject</span><span style=color:#a40000>─┬─</span><span style=color:#000>S3PutObject</span><span style=color:#a40000>─┬─</span><span style=color:#000>ReadBufferFromS3</span><span style=color:#a40000>─┬─</span><span style=color:#000>WriteBufferFromS3</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>947</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────┴─────────────┴──────────────────┴───────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Select using fullscan of S column read only 2.36 GiB from S3, the whole S column (2.33 GiB) plus parts of A and D.</p><pre tabindex=0><code>
delete from test_s3 where A=100000000;
0 rows in set. Elapsed: 17.429 sec.

┌─q──┬─S3GetObject─┬─S3PutObject─┬─ReadBufferFromS3─┬─WriteBufferFromS3─┐
│ Q3 │        2981 │           6 │ 23.06 MiB        │ 27.25 KiB         │
└────┴─────────────┴─────────────┴──────────────────┴───────────────────┘

insert into test select &#39;Q3&#39; q, event,value  from system.events where event like &#39;%S3%&#39;;


delete from test_s3 where S=&#39;100000001&#39;;
0 rows in set. Elapsed: 31.417 sec.
┌─q──┬─S3GetObject─┬─S3PutObject─┬─ReadBufferFromS3─┬─WriteBufferFromS3─┐
│ Q4 │        4209 │           6 │ 2.39 GiB         │ 27.25 KiB         │
└────┴─────────────┴─────────────┴──────────────────┴───────────────────┘
insert into test select &#39;Q4&#39; q, event,value  from system.events where event like &#39;%S3%&#39;;



alter table test_s3 delete where A=110000000 settings mutations_sync=2;
0 rows in set. Elapsed: 19.521 sec.

┌─q──┬─S3GetObject─┬─S3PutObject─┬─ReadBufferFromS3─┬─WriteBufferFromS3─┐
│ Q5 │        2986 │          15 │ 42.27 MiB        │ 41.72 MiB         │
└────┴─────────────┴─────────────┴──────────────────┴───────────────────┘
insert into test select &#39;Q5&#39; q, event,value  from system.events where event like &#39;%S3%&#39;;


alter table test_s3 delete where S=&#39;110000001&#39; settings mutations_sync=2;
0 rows in set. Elapsed: 29.650 sec.

┌─q──┬─S3GetObject─┬─S3PutObject─┬─ReadBufferFromS3─┬─WriteBufferFromS3─┐
│ Q6 │        4212 │          15 │ 2.42 GiB         │ 41.72 MiB         │
└────┴─────────────┴─────────────┴──────────────────┴───────────────────┘
insert into test select &#39;Q6&#39; q, event,value  from system.events where event like &#39;%S3%&#39;;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-801e0b0de3b47ed85a19172aec522cdc>1.4 - Example of the table at s3 with cache</h1><div class=lead>s3 disk and s3 cache.</div><h2 id=storage-configuration>Storage configuration</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>cat /etc/clickhouse-server/config.d/s3.xml
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;storage_configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;disks&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;s3disk&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>s3<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;endpoint&gt;</span>https://s3.us-east-1.amazonaws.com/mybucket/test/s3cached/<span style=color:#204a87;font-weight:700>&lt;/endpoint&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;use_environment_credentials&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/use_environment_credentials&gt;</span>  <span style=color:#8f5902;font-style:italic>&lt;!-- use IAM AWS role --&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>&lt;!--access_key_id&gt;xxxx&lt;/access_key_id&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;secret_access_key&gt;xxx&lt;/secret_access_key--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/s3disk&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;cache&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>cache<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;disk&gt;</span>s3disk<span style=color:#204a87;font-weight:700>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;path&gt;</span>/var/lib/clickhouse/disks/s3_cache/<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;max_size&gt;</span>50Gi<span style=color:#204a87;font-weight:700>&lt;/max_size&gt;</span>  <span style=color:#8f5902;font-style:italic>&lt;!-- 50GB local cache to cache remote data --&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/cache&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/disks&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;policies&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;s3tiered&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;volumes&gt;</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>                      <span style=color:#204a87;font-weight:700>&lt;disk&gt;</span>default<span style=color:#204a87;font-weight:700>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>                      <span style=color:#204a87;font-weight:700>&lt;max_data_part_size_bytes&gt;</span>50000000000<span style=color:#204a87;font-weight:700>&lt;/max_data_part_size_bytes&gt;</span>   <span style=color:#8f5902;font-style:italic>&lt;!-- only for parts less than 50GB after they moved to s3 during merges --&gt;</span>         
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&lt;s3cached&gt;</span>
</span></span><span style=display:flex><span>                      <span style=color:#204a87;font-weight:700>&lt;disk&gt;</span>cache<span style=color:#204a87;font-weight:700>&lt;/disk&gt;</span>  <span style=color:#8f5902;font-style:italic>&lt;!-- sandwich cache plus s3disk --&gt;</span>
</span></span><span style=display:flex><span>                      <span style=color:#8f5902;font-style:italic>&lt;!-- prefer_not_to_merge&gt;true&lt;/prefer_not_to_merge&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      &lt;perform_ttl_move_on_insert&gt;false&lt;/perform_ttl_move_on_insert--&gt;</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&lt;/s3cached&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;/volumes&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/s3tiered&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/policies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/storage_configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disks</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>────┬─</span><span style=color:#000>path</span><span style=color:#a40000>──────────────────────────────┬───────────</span><span style=color:#000>free_space</span><span style=color:#a40000>─┬──────────</span><span style=color:#000>total_space</span><span style=color:#a40000>─┬</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cache</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>disks</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s3disk</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18446744073709551615</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18446744073709551615</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>149113987072</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>207907635200</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>disks</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s3disk</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18446744073709551615</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18446744073709551615</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────┴───────────────────────────────────┴──────────────────────┴──────────────────────┴</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>storage_policies</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>policy_name</span><span style=color:#a40000>─┬─</span><span style=color:#000>volume_name</span><span style=color:#a40000>─┬─</span><span style=color:#000>volume_priority</span><span style=color:#a40000>─┬─</span><span style=color:#000>disks</span><span style=color:#a40000>───────┬─</span><span style=color:#000>volume_type</span><span style=color:#a40000>─┬─</span><span style=color:#000>max_data_part_size</span><span style=color:#a40000>─┬─</span><span style=color:#000>move_factor</span><span style=color:#a40000>─┬─</span><span style=color:#000>prefer_not_to_merge</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JBOD</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3tiered</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JBOD</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>50000000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3tiered</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3cached</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;s3disk&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JBOD</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────┴─────────────┴─────────────────┴─────────────┴─────────────┴────────────────────┴─────────────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=example-with-a-new-table>example with a new table</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>D</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Date</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage_policy</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3tiered&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2023-01-01&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>e9</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>270</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>285</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>billion</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>70</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Table size is 7.65 GiB and it at the default disk (EBS):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_on_disk</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_count</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;test_s3&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>disk_name</span><span style=color:#a40000>─┬─</span><span style=color:#000>partition</span><span style=color:#a40000>──┬──</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>─────┬─</span><span style=color:#000>part_count</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>65</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴────────────┴────────────┴──────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>It seems my EBS write speed is slower than S3 write speed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2023-01-01&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>volume</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3cached&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>98</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>979</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2023-01-01&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>volume</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>127</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>741</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Queries performance against EBS:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>002</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>71</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>439</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>billion</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>87</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>699</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%4422%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>484</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>billion</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>89</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>57</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>02</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Let&rsquo;s move data to S3</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2023-01-01&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>volume</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3cached&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>81</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>068</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_on_disk</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_count</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;test_s3&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>disk_name</span><span style=color:#a40000>─┬─</span><span style=color:#000>partition</span><span style=color:#a40000>──┬──</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>─────┬─</span><span style=color:#000>part_count</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>65</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴────────────┴────────────┴──────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The first query execution against S3, the second against the cache (local EBS):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>458</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>71</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>88</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>156</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>35</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>003</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>71</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>28</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>601</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>billion</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>37</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>59</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>300</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>74</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>675</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>billion</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>115</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>27</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>922</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%4422%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>586</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>billion</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>89</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>77</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>532</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>63</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>551</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>billion</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>89</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Cache introspection</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cache_base_path</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>filesystem_cache</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>cache_base_path</span><span style=color:#a40000>─────────────────────┬─</span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>))</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>disks</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s3_cache</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────────────────────────┴───────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>system</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FILESYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cache</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cache_base_path</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>filesystem_cache</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>005</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>221</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>71</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>37</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>324</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>47</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cache_base_path</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>filesystem_cache</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>cache_base_path</span><span style=color:#a40000>─────────────────────┬─</span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>))</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>disks</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s3_cache</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>105</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>KiB</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────────────────────────┴───────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>No data is stored locally (except system log tables).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>free_space</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>free_space</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>total_space</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>total_space</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disks</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>────┬─</span><span style=color:#000>free_space</span><span style=color:#a40000>─┬─</span><span style=color:#000>total_space</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cache</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EiB</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>97</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>49</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EiB</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────┴────────────┴─────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=example-with-an-existing-table>example with an existing table</h2><p>The <code>mydata</code> table is created without the explicitly defined <code>storage_policy</code>, it means that implicitly <code>storage_policy=default</code> / <code>volume=default</code> / <code>disk=default</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_on_disk</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_count</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;mydata&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>disk_name</span><span style=color:#a40000>─┬─</span><span style=color:#000>partition</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>───────┬─</span><span style=color:#000>part_count</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202201</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>516666677</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202202</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>466666657</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202203</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>16666666</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>138</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202301</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>516666677</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202302</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>466666657</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202303</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>16666666</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>138</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴───────────┴───────────┴────────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Let&#39;s change the storage policy, this command instant and changes only metadata of the table, and possible because the new storage policy and the old has the volume `default`.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mydata</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>modify</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>setting</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage_policy</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3tiered&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>057</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=straightforward-heavy-approach>straightforward (heavy) approach</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Let&#39;s add TTL, it&#39;s a heavy command and takes a lot time and creates the performance impact, because it reads `D` column and moves parts to s3.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mydata</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>modify</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TTL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>interval</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>year</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>volume</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3cached&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>140</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>661</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>disk_name</span><span style=color:#a40000>─┬─</span><span style=color:#000>partition</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>───────┬─</span><span style=color:#000>part_count</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202201</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>516666677</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202202</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>466666657</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202203</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>16666666</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>138</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202301</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>516666677</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202302</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>466666657</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202303</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>16666666</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>138</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴───────────┴───────────┴────────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=gentle-manual-approach>gentle (manual) approach</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- alter modify TTL changes only metadata of the table and applied to only newly insterted data.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>materialize_ttl_after_modify</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mydata</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>modify</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TTL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>interval</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>year</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>volume</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3cached&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>049</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- move data slowly partition by partition
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mydata</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;202201&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>volume</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3cached&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>49</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>410</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mydata</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;202202&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>volume</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3cached&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>952</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mydata</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;202203&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>volume</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3cached&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>808</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- data can be optimized to reduce number of parts before moving it to s3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>optimize</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mydata</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;202301&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>66</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>551</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mydata</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;202301&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>volume</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3cached&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>332</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>disk_name</span><span style=color:#a40000>─┬─</span><span style=color:#000>partition</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>───────┬─</span><span style=color:#000>part_count</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202201</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>516666677</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202202</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>466666657</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202203</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>16666666</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>138</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202301</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>516666677</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- optimized partition
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202302</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>466666657</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>202303</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>16666666</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>138</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴───────────┴───────────┴────────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=s3-and-clickhouse-start-time>S3 and ClickHouse® start time</h2><p>Let&rsquo;s create a table with 1000 parts and move them to s3.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage_policy</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3tiered&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toDate</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;2000-01-01&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intDiv</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>e6</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>e9</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>optimize</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optimize_skip_merged_partitions</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_on_disk</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_count</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;test_s3&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>disk_name</span><span style=color:#a40000>─┬──</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>─────┬─</span><span style=color:#000>part_count</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴────────────┴──────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_s3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>modify</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ttl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>interval</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>year</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;s3disk&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_on_disk</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_count</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;test_s3&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>disk_name</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>─────┬─</span><span style=color:#000>part_count</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>755000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>77</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>755</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>245000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>87</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>245</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴───────────┴──────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>----  several minutes later ----
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>disk_name</span><span style=color:#a40000>─┬──</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>─────┬─</span><span style=color:#000>part_count</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3disk</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴────────────┴──────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=start-time>start time</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>:) select name, value from system.merge_tree_settings where name = &#39;max_part_loading_threads&#39;;
</span></span><span style=display:flex><span>┌─name─────────────────────┬─value─────┐
</span></span><span style=display:flex><span>│ max_part_loading_threads │ &#39;auto(4)&#39; │
</span></span><span style=display:flex><span>└──────────────────────────┴───────────┘
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># systemctl stop clickhouse-server
</span></span><span style=display:flex><span># time systemctl start clickhouse-server  / real	4m26.766s
</span></span><span style=display:flex><span># systemctl stop clickhouse-server
</span></span><span style=display:flex><span># time systemctl start clickhouse-server  / real	4m24.263s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># cat /etc/clickhouse-server/config.d/max_part_loading_threads.xml
</span></span><span style=display:flex><span>&lt;?xml version=&#34;1.0&#34;?&gt;
</span></span><span style=display:flex><span>&lt;clickhouse&gt;
</span></span><span style=display:flex><span>    &lt;merge_tree&gt;
</span></span><span style=display:flex><span>       &lt;max_part_loading_threads&gt;128&lt;/max_part_loading_threads&gt;
</span></span><span style=display:flex><span>    &lt;/merge_tree&gt;
</span></span><span style=display:flex><span>&lt;/clickhouse&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># systemctl stop clickhouse-server
</span></span><span style=display:flex><span># time systemctl start clickhouse-server / real	0m11.225s
</span></span><span style=display:flex><span># systemctl stop clickhouse-server
</span></span><span style=display:flex><span># time systemctl start clickhouse-server / real	0m10.797s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       &lt;max_part_loading_threads&gt;256&lt;/max_part_loading_threads&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># systemctl stop clickhouse-server
</span></span><span style=display:flex><span># time systemctl start clickhouse-server / real	0m8.474s
</span></span><span style=display:flex><span># systemctl stop clickhouse-server
</span></span><span style=display:flex><span># time systemctl start clickhouse-server / real	0m8.130s
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-56d30b1c77fb6e372359df908c32cf1a>1.5 - S3Disk</h1><h2 id=settings>Settings</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;storage_configuration&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;disks&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;s3&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>s3<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;endpoint&gt;</span>http://s3.us-east-1.amazonaws.com/BUCKET_NAME/test_s3_disk/<span style=color:#204a87;font-weight:700>&lt;/endpoint&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;access_key_id&gt;</span>ACCESS_KEY_ID<span style=color:#204a87;font-weight:700>&lt;/access_key_id&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;secret_access_key&gt;</span>SECRET_ACCESS_KEY<span style=color:#204a87;font-weight:700>&lt;/secret_access_key&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;skip_access_check&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/skip_access_check&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;send_metadata&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/send_metadata&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/s3&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/disks&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/storage_configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><ul><li><p>skip_access_check — if true, it&rsquo;s possible to use read only credentials with regular MergeTree table. But you would need to disable merges (<code>prefer_not_to_merge</code> setting) on s3 volume as well.</p></li><li><p>send_metadata — if true, ClickHouse® will populate s3 object with initial part & file path, which allow you to recover metadata from s3 and make debug easier.</p></li></ul><h2 id=restore-metadata-from-s3>Restore metadata from S3</h2><h3 id=default>Default</h3><p>Limitations:</p><ol><li>ClickHouse need RW access to this bucket</li></ol><p>In order to restore metadata, you would need to create restore file in <code>metadata_path/_s3_disk_name_</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>touch /var/lib/clickhouse/disks/_s3_disk_name_/restore
</span></span></code></pre></div><p>In that case ClickHouse would restore to the same bucket and path and update only metadata files in s3 bucket.</p><h3 id=custom>Custom</h3><p>Limitations:</p><ol><li>ClickHouse needs RO access to the old bucket and RW to the new.</li><li>ClickHouse will copy objects in case of restoring to a different bucket or path.</li></ol><p>If you would like to change bucket or path, you need to populate restore file with settings in key=value format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /var/lib/clickhouse/disks/_s3_disk_name_/restore
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>source_bucket</span><span style=color:#ce5c00;font-weight:700>=</span>s3disk
</span></span><span style=display:flex><span><span style=color:#000>source_path</span><span style=color:#ce5c00;font-weight:700>=</span>vol1/
</span></span></code></pre></div><h2 id=links>Links</h2><ul><li><a href=https://altinity.com/blog/integrating-clickhouse-with-minio target=_blank>https://altinity.com/blog/integrating-clickhouse-with-minio</a></li><li><a href=https://altinity.com/blog/clickhouse-object-storage-performance-minio-vs-aws-s3 target=_blank>https://altinity.com/blog/clickhouse-object-storage-performance-minio-vs-aws-s3</a></li><li><a href=https://altinity.com/blog/tips-for-high-performance-clickhouse-clusters-with-s3-object-storage target=_blank>https://altinity.com/blog/tips-for-high-performance-clickhouse-clusters-with-s3-object-storage</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-3fadca3aea85e2e4d4fe0090f2c8c658>2 - AggregateFunction(uniq, UUID) doubled after ClickHouse® upgrade</h1><h2 id=what-happened>What happened</h2><p>After ClickHouse® upgrade from version pre 21.6 to version after 21.6, count of unique UUID in AggregatingMergeTree tables nearly doubled in case of merging of data which was generated in different ClickHouse versions.</p><h2 id=why-happened>Why happened</h2><p>In <a href=https://github.com/ClickHouse/ClickHouse/pull/23631 target=_blank>pull request</a>
which changed the internal representation of big integers data types (and UUID).
SipHash64 hash-function used for uniq aggregation function for UUID data type was replaced with intHash64, which leads to different result for the same UUID value across different ClickHouse versions.
Therefore, it results in doubling of counts, when uniqState created by different ClickHouse versions being merged together.</p><p>Related <a href=https://github.com/ClickHouse/ClickHouse/issues/33607 target=_blank>issue</a>
.</p><h2 id=solution>Solution</h2><p>You need to replace any occurrence of <code>uniqState(uuid)</code> in MATERIALIZED VIEWs with <code>uniqState(sipHash64(uuid))</code> and change data type for already saved data from <code>AggregateFunction(uniq, UUID)</code> to <code>AggregateFunction(uniq, UInt64)</code>, because result data type of sipHash64 is UInt64.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- On ClickHouse version 21.3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AggregateFunction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UUID</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqState</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>reinterpretAsUUID</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>404</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>38</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>59</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>74</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>modulo</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────┴──────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- After upgrade of ClickHouse to 21.8
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>modulo</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────┴──────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>240</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>41</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>72</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>86</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>128</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqState</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>reinterpretAsUUID</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>266</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>38</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>93</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>modulo</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>99834</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Count</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>unique</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nearly</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>doubled</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100219</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100128</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100457</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100272</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100279</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>99372</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>99450</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>99974</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>99632</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>99562</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100660</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100439</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100252</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100650</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>99320</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100095</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>99632</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>99540</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>100098</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────┴──────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>356</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>56</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>54</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>126</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>79</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Option 1, create separate column
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ADD</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLUMN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>value_2</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AggregateFunction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>unhex</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>hex</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>	
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>	
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value_2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value_2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>	
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>	
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutations</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>is_done</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>008</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value_2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqState</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sipHash64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>reinterpretAsUUID</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>337</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>38</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>89</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value_2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>modulo</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value_2</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────┴──────────────────┴────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>768</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>58</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>96</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Option 2, modify column in-place with String as intermediate data type. 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>MODIFY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLUMN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>280</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>MODIFY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLUMN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AggregateFunction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>254</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqState</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sipHash64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>reinterpretAsUUID</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>554</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>38</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>89</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value_2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>modulo</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value_2</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────┴──────────────────┴────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>589</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>87</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>93</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>66</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_3</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>uniq_state_3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AggregateFunction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt64</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>value_2</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AggregateFunction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>unhex</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>hex</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Option 3, CAST uniqState(UInt64) to String.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>146</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>68</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>98</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqState</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sipHash64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>reinterpretAsUUID</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>))),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;String&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>476</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>38</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>63</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>modulo</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>49999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>50000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────┴──────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>281</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>71</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>27</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_state_4</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>uniq_state_4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AggregateFunction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UUID</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-842ce56e1a0b0d67156403a261b18400>3 - Can not connect to my ClickHouse® server</h1><div class=lead>Can not connect to my ClickHouse® server.</div><h2 id=can-not-connect-to-my-clickhouse-server>Can not connect to my ClickHouse® server</h2><p>Errors like
&ldquo;Connection reset by peer, while reading from socket&rdquo;</p><ol><li><p>Ensure that the <code>clickhouse-server</code> is running</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>systemctl status clickhouse-server
</span></span></code></pre></div><p>If server was restarted recently and don&rsquo;t accept the connections after the restart - most probably it still just starting.
During the startup sequence it need to iterate over all data folders in /var/lib/clickhouse-server
In case if you have a very high number of folders there (usually caused by a wrong partitioning, or a very high number of tables / databases)
that startup time can take a lot of time (same can happen if disk is very slow, for example NFS).</p><p>You can check that by looking for &lsquo;Ready for connections&rsquo; line in <code>/var/log/clickhouse-server/clickhouse-server.log</code> (<code>Information</code> log level needed)</p></li><li><p>Ensure you use the proper port ip / interface?</p><p>Ensure you&rsquo;re not trying to connect to secure port without tls / https or vice versa.</p><p>For <code>clickhouse-client</code> - pay attention on host / port / secure flags.</p><p>Ensure the interface you&rsquo;re connecting to is the one which ClickHouse listens (by default ClickHouse listens only localhost).</p><p>Note: If you uncomment line <code>&lt;listen_host>0.0.0.0&lt;/listen_host></code> only - ClickHouse will listen only ipv4 interfaces,
while the localhost (used by <code>clickhouse-client</code>) may be resolved to ipv6 address. And <code>clickhouse-client</code> may be failing to connect.</p><p>How to check which interfaces / ports do ClickHouse listen?</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo lsof -i -P -n <span style=color:#000;font-weight:700>|</span> grep LISTEN
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> listen_host
</span></span><span style=display:flex><span>sudo clickhouse-extract-from-config --config<span style=color:#ce5c00;font-weight:700>=</span>/etc/clickhouse-server/config.xml --key<span style=color:#ce5c00;font-weight:700>=</span>listen_host
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> tcp_port
</span></span><span style=display:flex><span>sudo clickhouse-extract-from-config --config<span style=color:#ce5c00;font-weight:700>=</span>/etc/clickhouse-server/config.xml --key<span style=color:#ce5c00;font-weight:700>=</span>tcp_port
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> tcp_port_secure
</span></span><span style=display:flex><span>sudo clickhouse-extract-from-config --config<span style=color:#ce5c00;font-weight:700>=</span>/etc/clickhouse-server/config.xml --key<span style=color:#ce5c00;font-weight:700>=</span>tcp_port_secure
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> http_port
</span></span><span style=display:flex><span>sudo clickhouse-extract-from-config --config<span style=color:#ce5c00;font-weight:700>=</span>/etc/clickhouse-server/config.xml --key<span style=color:#ce5c00;font-weight:700>=</span>http_port
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> https_port
</span></span><span style=display:flex><span>sudo clickhouse-extract-from-config --config<span style=color:#ce5c00;font-weight:700>=</span>/etc/clickhouse-server/config.xml --key<span style=color:#ce5c00;font-weight:700>=</span>https_port
</span></span></code></pre></div></li><li><p>For secure connection:</p><ul><li>ensure that server uses some certificate which can be validated by the client</li><li>OR disable certificate checks on the client (UNSECURE)</li></ul></li><li><p>Check for errors in /var/log/clickhouse-server/clickhouse-server.err.log ?</p></li><li><p>Is ClickHouse able to serve some trivial tcp / http requests from localhost?</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>curl 127.0.0.1:9200
</span></span><span style=display:flex><span>curl 127.0.0.1:8123
</span></span></code></pre></div></li><li><p>Check number of sockets opened by ClickHouse</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo lsof -i -a -p <span style=color:#204a87;font-weight:700>$(</span>pidof clickhouse-server<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># or (adjust 9000 / 8123 ports if needed)</span>
</span></span><span style=display:flex><span>netstat -tn 2&gt;/dev/null <span style=color:#000;font-weight:700>|</span> tail -n +3 <span style=color:#000;font-weight:700>|</span> awk <span style=color:#4e9a06>&#39;{ printf(&#34;%s\t%s\t%s\t%s\t%s\t%s\n&#34;, $1, $2, $3, $4, $5, $6) }&#39;</span> <span style=color:#000;font-weight:700>|</span> clickhouse-local -S <span style=color:#4e9a06>&#34;Proto String, RecvQ Int64, SendQ Int64, LocalAddress String, ForeignAddress String, State LowCardinality(String)&#34;</span> --query<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;SELECT * FROM table WHERE LocalAddress like &#39;%:9000&#39; FORMAT PrettyCompact&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>netstat -tn 2&gt;/dev/null <span style=color:#000;font-weight:700>|</span> tail -n +3 <span style=color:#000;font-weight:700>|</span> awk <span style=color:#4e9a06>&#39;{ printf(&#34;%s\t%s\t%s\t%s\t%s\t%s\n&#34;, $1, $2, $3, $4, $5, $6) }&#39;</span> <span style=color:#000;font-weight:700>|</span> clickhouse-local -S <span style=color:#4e9a06>&#34;Proto String, RecvQ Int64, SendQ Int64, LocalAddress String, ForeignAddress String, State LowCardinality(String)&#34;</span> --query<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;SELECT * FROM table WHERE LocalAddress like &#39;%:8123&#39; FORMAT PrettyCompact&#34;</span>
</span></span></code></pre></div><p>ClickHouse has a limit of number of open connections (4000 by default).</p></li><li><p>Check also:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#8f5902;font-style:italic># system overall support limited number of connections it can handle</span>
</span></span><span style=display:flex><span>netstat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># you can also be reaching of of the process ulimits (Max open files)</span>
</span></span><span style=display:flex><span>cat /proc/<span style=color:#204a87;font-weight:700>$(</span>pidof -s clickhouse-server<span style=color:#204a87;font-weight:700>)</span>/limits
</span></span></code></pre></div></li><li><p>Check firewall / selinux rules (if used)</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-5c047eed8f820765587e3275057bd864>4 - cgroups and kubernetes cloud providers</h1><div class=lead>cgroups and kubernetes cloud providers.</div><p>Why my ClickHouse® is slow after upgrade to version 22.2 and higher?</p><p>The probable reason is that ClickHouse 22.2 started to respect cgroups (Respect cgroups limits in max_threads autodetection. <a href=https://github.com/ClickHouse/ClickHouse/pull/33342 target=_blank>#33342</a>
(<a href=https://github.com/JaySon-Huang target=_blank>JaySon</a>
).</p><p>You can observe that <code>max_threads = 1</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;max_threads&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_threads</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;auto(1)&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────┴───────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This makes ClickHouse to execute all queries with a single thread (normal behavior is half of available CPU cores, cores = 64, then &lsquo;auto(32)&rsquo;).</p><p>We observe this cgroups behavior with AWS EKS (Kubernetes) environment and <a href=https://github.com/Altinity/clickhouse-operator target=_blank>Altinity
ClickHouse Operator</a>
in case if requests.cpu and limits.cpu are not set for a resource.</p><h2 id=workaround>Workaround</h2><p>We suggest to set requests.cpu = <code>half of available CPU cores</code>, and limits.cpu = <code>CPU cores</code>.</p><p>For example in case of 16 CPU cores:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>          resources:
</span></span><span style=display:flex><span>            requests:
</span></span><span style=display:flex><span>              memory: ...
</span></span><span style=display:flex><span>              cpu: 8
</span></span><span style=display:flex><span>            limits:
</span></span><span style=display:flex><span>              memory: ....
</span></span><span style=display:flex><span>              cpu: 16
</span></span></code></pre></div><p>Then you should get a new result:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;max_threads&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_threads</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;auto(8)&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────┴───────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=in-depth>in depth</h2><p>For some reason AWS EKS sets cgroup kernel parameters in case of empty requests.cpu & limits.cpu into these:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us</span>
</span></span><span style=display:flex><span>-1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># cat /sys/fs/cgroup/cpu/cpu.cfs_period_us</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>100000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># cat /sys/fs/cgroup/cpu/cpu.shares</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>2</span>
</span></span></code></pre></div><p>This makes ClickHouse to set <code>max_threads = 1</code> because of</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>cgroup_share = /sys/fs/cgroup/cpu/cpu.shares (2)
</span></span><span style=display:flex><span>PER_CPU_SHARES = 1024
</span></span><span style=display:flex><span>share_count = ceil( cgroup_share / PER_CPU_SHARES ) ---&gt; ceil(2 / 1024) ---&gt; 1
</span></span></code></pre></div><h2 id=fix>Fix</h2><p>Incorrect calculation was fixed in <a href=https://github.com/ClickHouse/ClickHouse/pull/35815 target=_blank>https://github.com/ClickHouse/ClickHouse/pull/35815</a>
and will work correctly on newer releases.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-07649d2fd60036daef12d2739b51964f>5 - Transforming ClickHouse logs to ndjson using Vector.dev</h1><div class=lead>Transforming ClickHouse logs to ndjson using Vector.dev</div><h3 id=clickhouse-228>ClickHouse 22.8</h3><p>Starting from 22.8 version, ClickHouse support writing logs in JSON format:</p><pre tabindex=0><code>&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
    &lt;logger&gt;
        &lt;!-- Structured log formatting:
        You can specify log format(for now, JSON only). In that case, the console log will be printed
        in specified format like JSON.
        For example, as below:
        {&#34;date_time&#34;:&#34;1650918987.180175&#34;,&#34;thread_name&#34;:&#34;#1&#34;,&#34;thread_id&#34;:&#34;254545&#34;,&#34;level&#34;:&#34;Trace&#34;,&#34;query_id&#34;:&#34;&#34;,&#34;logger_name&#34;:&#34;BaseDaemon&#34;,&#34;message&#34;:&#34;Received signal 2&#34;,&#34;source_file&#34;:&#34;../base/daemon/BaseDaemon.cpp; virtual void SignalListener::run()&#34;,&#34;source_line&#34;:&#34;192&#34;}
        To enable JSON logging support, just uncomment &lt;formatting&gt; tag below.
        --&gt;
        &lt;formatting&gt;json&lt;/formatting&gt;
    &lt;/logger&gt;
&lt;/clickhouse&gt;
</code></pre><h2 id=transforming-clickhouse-logs-to-ndjson-using-vectordev>Transforming ClickHouse logs to ndjson using Vector.dev"</h2><h3 id=installation-of-vectordev>Installation of vector.dev</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># arm64</span>
</span></span><span style=display:flex><span>wget https://packages.timber.io/vector/0.15.2/vector_0.15.2-1_arm64.deb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># amd64</span>
</span></span><span style=display:flex><span>wget https://packages.timber.io/vector/0.15.2/vector_0.15.2-1_amd64.deb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dpkg -i vector_0.15.2-1_*.deb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl stop vector
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir /var/log/clickhouse-server-json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chown vector.vector /var/log/clickhouse-server-json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>usermod -a -G clickhouse vector
</span></span></code></pre></div><h3 id=vector-config>vector config</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># cat /etc/vector/vector.toml</span>
</span></span><span style=display:flex><span><span style=color:#000>data_dir</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/var/lib/vector&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#000>sources</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clickhouse-log</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>type</span>                          <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;file&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>include</span>                       <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#4e9a06>&#34;/var/log/clickhouse-server/clickhouse-server.log&#34;</span> <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>fingerprinting</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>strategy</span>       <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;device_and_inode&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>message_start_indicator</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;^\d+\.\d+\.\d+ \d+:\d+:\d+&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>multi_line_timeout</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#000>transforms</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clickhouse-log-text</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>inputs</span>                        <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#4e9a06>&#34;clickhouse-log&#34;</span> <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>type</span>                          <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;remap&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>source</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>     . |= parse_regex!(.message, r&#39;</span><span style=color:#a40000>^(?</span><span style=color:#000>P</span><span style=color:#a40000>&lt;</span><span style=color:#000>timestamp</span><span style=color:#a40000>&gt;\</span><span style=color:#000>d</span><span style=color:#a40000>+\</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>\</span><span style=color:#000>d</span><span style=color:#a40000>+\</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>\</span><span style=color:#000>d</span><span style=color:#a40000>+</span> <span style=color:#a40000>\</span><span style=color:#000>d</span><span style=color:#a40000>+:\</span><span style=color:#000>d</span><span style=color:#a40000>+:\</span><span style=color:#000>d</span><span style=color:#a40000>+\</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>\</span><span style=color:#000>d</span><span style=color:#a40000>+)</span> <span style=color:#a40000>\</span><span style=color:#000;font-weight:700>[</span><span style=color:#a40000>\</span><span style=color:#000>s</span><span style=color:#a40000>?(?</span><span style=color:#000>P</span><span style=color:#a40000>&lt;</span><span style=color:#000>thread_id</span><span style=color:#a40000>&gt;\</span><span style=color:#000>d</span><span style=color:#a40000>+)\</span><span style=color:#000>s</span><span style=color:#a40000>?\</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>\</span><span style=color:#000;font-weight:700>{</span><span style=color:#a40000>(?</span><span style=color:#000>P</span><span style=color:#a40000>&lt;</span><span style=color:#000>query_id</span><span style=color:#a40000>&gt;</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>*)\</span><span style=color:#000;font-weight:700>}</span> <span style=color:#a40000>&lt;(?</span><span style=color:#000>P</span><span style=color:#a40000>&lt;</span><span style=color:#000>severity</span><span style=color:#a40000>&gt;\</span><span style=color:#000>w</span><span style=color:#a40000>+)&gt;</span> <span style=color:#a40000>(?</span><span style=color:#000>s</span><span style=color:#a40000>)(?</span><span style=color:#000>P</span><span style=color:#a40000>&lt;</span><span style=color:#000>message</span><span style=color:#a40000>&gt;</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>*$)</span><span style=color:#4e9a06>&#39;)
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#000>sinks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>emit-clickhouse-log-json</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>type</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;file&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>inputs</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#4e9a06>&#34;clickhouse-log-text&#34;</span> <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>compression</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;none&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>path</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/var/log/clickhouse-server-json/clickhouse-server.%Y-%m-%d.ndjson&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>encoding</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>only_fields</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;timestamp&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;thread_id&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;query_id&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;severity&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;message&#34;</span> <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>encoding</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>codec</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;ndjson&#34;</span>
</span></span></code></pre></div><h3 id=start>start</h3><pre tabindex=0><code>systemctl start vector

tail /var/log/clickhouse-server-json/clickhouse-server.2022-04-21.ndjson
{&#34;message&#34;:&#34;DiskLocal: Reserving 1.00 MiB on disk `default`, having unreserved 166.80 GiB.&#34;,&#34;query_id&#34;:&#34;&#34;,&#34;severity&#34;:&#34;Debug&#34;,&#34;thread_id&#34;:&#34;283239&#34;,&#34;timestamp&#34;:&#34;2022.04.21 13:43:21.164660&#34;}
{&#34;message&#34;:&#34;MergedBlockOutputStream: filled checksums 202204_67118_67118_0 (state Temporary)&#34;,&#34;query_id&#34;:&#34;&#34;,&#34;severity&#34;:&#34;Trace&#34;,&#34;thread_id&#34;:&#34;283239&#34;,&#34;timestamp&#34;:&#34;2022.04.21 13:43:21.166810&#34;}
{&#34;message&#34;:&#34;system.metric_log (e3365172-4c9b-441b-b803-756ae030e741): Renaming temporary part tmp_insert_202204_67118_67118_0 to 202204_171703_171703_0.&#34;,&#34;query_id&#34;:&#34;&#34;,&#34;severity&#34;:&#34;Trace&#34;,&#34;thread_id&#34;:&#34;283239&#34;,&#34;timestamp&#34;:&#34;2022.04.21 13:43:21.167226&#34;}
....
</code></pre><h3 id=sink-logs-into-clickhouse-table>sink logs into ClickHouse table</h3><p>Be careful with logging ClickHouse messages into the same ClickHouse instance, it will cause endless recursive self-logging.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clickhouse_logs</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>timestamp</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LowCardinality</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>thread_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LowCardinality</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>severity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LowCardinality</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>query_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>message</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toYYYYMM</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>timestamp</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>Order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toStartOfHour</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>timestamp</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>severity</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query_id</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>vector</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>identified</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;vector1234&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clickhouse_logs</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>or</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>replace</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile_vector</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>log_queries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>readonly</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#000>sinks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clickhouse-output-clickhouse</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#000>inputs</span>   <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;clickhouse-log-text&#34;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#000>type</span>     <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;clickhouse&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>host</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;http://localhost:8123&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>database</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;default&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>auth</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>strategy</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;basic&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>auth</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;vector&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>auth</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>password</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;vector1234&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>healthcheck</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>    <span style=color:#000>table</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;clickhouse_logs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>encoding</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>timestamp_format</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;unix&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>buffer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>type</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;disk&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>buffer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>max_size</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>104900000</span>
</span></span><span style=display:flex><span>    <span style=color:#000>buffer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>when_full</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;block&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>request</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>in_flight_limit</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>20</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>encoding</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>only_fields</span> <span style=color:#000;font-weight:700>=</span>  <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;host&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;timestamp&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;thread_id&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;query_id&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;severity&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;message&#34;</span><span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clickhouse_logs</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌───────────────</span><span style=color:#204a87;font-weight:700>timestamp</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#a40000>───────┬─</span><span style=color:#000>thread_id</span><span style=color:#a40000>─┬─</span><span style=color:#000>severity</span><span style=color:#a40000>─┬─</span><span style=color:#000>query_id</span><span style=color:#a40000>─┬─</span><span style=color:#000>message</span><span style=color:#a40000>─────────────────────────────────────────────────────</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>283155</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Debug</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87;font-weight:700>Session</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000>e87050</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>7824</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>46</span><span style=color:#000>b0</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000>bd5</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>29469</span><span style=color:#000>a1b102f</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Authentic</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>283155</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Debug</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87;font-weight:700>Session</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000>e87050</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>7824</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>46</span><span style=color:#000>b0</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000>bd5</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>29469</span><span style=color:#000>a1b102f</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Authentic</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>283155</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Debug</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87;font-weight:700>Session</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000>e87050</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>7824</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>46</span><span style=color:#000>b0</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000>bd5</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>29469</span><span style=color:#000>a1b102f</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Creating</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>447</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>283155</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Debug</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MemoryTracker</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>447</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>283155</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Debug</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87;font-weight:700>Session</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000>e87050</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>7824</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>46</span><span style=color:#000>b0</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000>bd5</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>29469</span><span style=color:#000>a1b102f</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Destroyin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>495</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>283155</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Debug</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87;font-weight:700>Session</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>f7eb829f</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000>b3a</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000>c43</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000>a41</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>a2e6676177fb</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Authentic</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>495</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>283155</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Debug</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87;font-weight:700>Session</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>f7eb829f</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000>b3a</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000>c43</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000>a41</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>a2e6676177fb</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Authentic</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>495</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>283155</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Debug</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87;font-weight:700>Session</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>f7eb829f</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000>b3a</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000>c43</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000>a41</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>a2e6676177fb</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Creating</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>496</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>283155</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Debug</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MemoryTracker</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>496</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>283155</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Debug</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87;font-weight:700>Session</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>f7eb829f</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000>b3a</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000>c43</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000>a41</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>a2e6676177fb</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Destroyin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────────────┴────────────┴───────────┴──────────┴──────────┴─────────────────────────────────────────────────────────────</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-65c6ddd3186c33d4134ea5a9bd44bff4>6 - Altinity Kubernetes Operator For ClickHouse®</h1><div class=lead>Altinity Kubernetes Operator For ClickHouse®</div><h2 id=altinity-kubernetes-operator-for-clickhouse-documentation>Altinity Kubernetes Operator for ClickHouse® Documentation</h2><p><a href=https://github.com/Altinity/clickhouse-operator/blob/master/docs/README.md target=_blank>https://github.com/Altinity/clickhouse-operator/blob/master/docs/README.md</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f882d95e5c344921805c85f5e5a656df>7 - ClickHouse® and different filesystems</h1><div class=lead>ClickHouse® and different filesystems.</div><p>In general ClickHouse® should work with any POSIX-compatible filesystem.</p><ul><li>hard links and soft links support is mandatory.</li><li>ClickHouse can use O_DIRECT mode to bypass the cache (and async io)</li><li>ClickHouse can use renameat2 command for some atomic operations (not all the filesystems support that).</li><li>depending on the schema and details of the usage the filesystem load can vary between the setup. The most natural load - is high throughput, with low or moderate IOPS.</li><li>data is compressed in ClickHouse (LZ4 by default), while indexes / marks / metadata files - no. Enabling disk-level compression can sometimes improve the compression, but can affect read / write speed.</li></ul><h3 id=ext4>ext4</h3><p>no issues, fully supported.</p><p>The minimum kernel version required is 3.15 (newer are recommended)</p><h3 id=xfs>XFS</h3><p>Performance issues reported by users, use on own risk. Old kernels are not recommended (4.0 or newer is recommended).</p><p>According to the users&rsquo; feedback, XFS behaves worse with ClickHouse under heavy load.
We don&rsquo;t have real proofs/benchmarks though, example reports:</p><ul><li>In GitHub there are <a href=https://github.com/ClickHouse/ClickHouse/issues/520 target=_blank>complaints about XFS</a>
from Cloudflare.</li><li>Recently my colleague discovered that two of ClickHouse servers perform worse in a cluster than
others and they found that they accidentally set up those servers with XFS instead of Ext4.</li><li>in the system journal you can sometimes see reports like &rsquo;task XYZ blocked for more than 120 seconds&rsquo; and stack trace pointing to XFS code (example: <a href=https://gist.github.com/filimonov/85b894268f978c2ccc18ea69bae5adbd target=_blank>https://gist.github.com/filimonov/85b894268f978c2ccc18ea69bae5adbd</a>
)</li><li>system goes to 99% io kernel under load sometimes.</li><li>we have XFS, sometimes ClickHouse goes to &ldquo;sleep&rdquo; because XFS daemon is doing smth unknown</li></ul><p>Maybe the above problem can be workaround by some tuning/settings, but so far we do not have a working and confirmed way to do this.</p><h3 id=zfs>ZFS</h3><p>Limitations exist, extra tuning may be needed, and having more RAM is recommended. Old kernels are not recommended.</p><p>Memory usage control - ZFS adaptive replacement cache (ARC) can take a lot of RAM. It can be the reason of out-of-memory issues when memory is also requested by the ClickHouse.</p><ul><li>It seems that the most important thing is zfs_arc_max - you just need to limit the maximum size of the ARC so that the sum of the maximum size of the arc + the CH itself does not exceed the size of the available RAM. For example, we set a limit of 80% RAM for ClickHouse and 10% for ARC. 10% will remain for the system and other applications</li></ul><p>Tuning:</p><ul><li>another potentially interesting setting is primarycache=metadata, see benchmark example: <a href=https://www.ikus-soft.com/en/blog/2018-05-23-proxmox-primarycache-all-metadata/ target=_blank>https://www.ikus-soft.com/en/blog/2018-05-23-proxmox-primarycache-all-metadata/</a></li><li>examples of tuning ZFS for MySQL <a href=https://wiki.freebsd.org/ZFSTuningGuide target=_blank>https://wiki.freebsd.org/ZFSTuningGuide</a>
- perhaps some of this can also be useful (atime, recordsize) but everything needs to be carefully checked with benchmarks (I have no way).</li><li>best practices: <a href=https://efim360.ru/zfs-best-practices-guide/ target=_blank>https://efim360.ru/zfs-best-practices-guide/</a></li></ul><p><strong>important note</strong>: In versions before 2.2 ZFS does not support the <code>renameat2</code> command, which is used by the Atomic database engine, and
therefore some of the Atomic functionality will not be available.</p><p>In old versions of ClickHouse, you can face issues with the O_DIRECT mode.</p><p>Also there is a well-known (and controversial) Linus Torvalds opinion: &ldquo;Don&rsquo;t Use ZFS on Linux&rdquo; <a href="https://www.realworldtech.com/forum/?threadid=189711&amp;curpostid=189841" target=_blank>[1]</a>
, <a href=https://arstechnica.com/gadgets/2020/01/linus-torvalds-zfs-statements-arent-right-heres-the-straight-dope/ target=_blank>[2]</a>
, <a href=https://arstechnica.com/gadgets/2020/01/linus-torvalds-zfs-statements-arent-right-heres-the-straight-dope/ target=_blank>[3]</a>
.</p><h3 id=btrfs>BTRFS</h3><p>Not enough information. Some users <a href=https://github.com/ClickHouse/ClickHouse/issues/2743#issuecomment-517845388 target=_blank>report</a>
performance improvement for their use case.</p><h3 id=reiserfs>ReiserFS</h3><p>Not enough information.</p><h3 id=lustre>Lustre</h3><p>There are reports that some people successfully use it in their setups.
A fast network is required.</p><p>There were some reports about data damage on the disks on older ClickHouse versions, which could be caused by the issues with O_DIRECT or <a href=https://lustre-discuss.lustre.narkive.com/zwcvyEEY/asynchronous-posix-i-o-with-lustre target=_blank>async io support</a>
on Lustre.</p><h3 id=nfs-and-efs>NFS (and EFS)</h3><p>According to the reports - it works, throughput depends a lot on the network speed. IOPS / number of file operations per seconds can be super low (due to the locking mechanism).</p><p><a href=https://github.com/ClickHouse/ClickHouse/issues/31113 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/31113</a></p><h3 id=moosefs>MooseFS</h3><p>There are installations using that. No extra info.</p><h3 id=glusterfs>GlusterFS</h3><p>There are installations using that. No extra info.</p><h3 id=ceph>Ceph</h3><p>There are installations using that. Some information: <a href=https://github.com/ClickHouse/ClickHouse/issues/8315 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/8315</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ba31da9c4b193969853f742350ad98c9>8 - ClickHouse® Access Control and Account Management (RBAC)</h1><div class=lead>Access Control and Account Management (RBAC).</div><p>Documentation <a href=https://clickhouse.com/docs/en/operations/access-rights/ target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/access-rights/</a></p><h2 id=enable-clickhouse-rbac-and-create-admin-user>Enable ClickHouse® RBAC and create admin user</h2><p>Create an <code>admin</code> user like (root in MySQL or postgres in PostgreSQL) to do the DBA/admin ops in the <code>user.xml</code> file and <a href=https://clickhouse.com/docs/en/operations/access-rights/#enabling-access-control target=_blank rel=nofollow>set the access management property for the admin user</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;users&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>  ....
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;admin&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>&lt;!--    
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        Password could be specified in plaintext or in SHA256 (in hex format).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        If you want to specify password in plaintext (not recommended), place it in &#39;password&#39; element.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        Example: &lt;password&gt;qwerty&lt;/password&gt;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        Password could be empty.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        If you want to specify SHA256, place it in &#39;password_sha256_hex&#39; element.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        Example: &lt;password_sha256_hex&gt;65e84be33532fb784c48129675f9eff3a682b27168c0ea744b2cf58ee02337c5&lt;/password_sha256_hex&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        Restrictions of SHA256: impossibility to connect to ClickHouse using MySQL JS client (as of July 2019).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        If you want to specify double SHA1, place it in &#39;password_double_sha1_hex&#39; element.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        Example: &lt;password_double_sha1_hex&gt;e395796d6546b1b65db9d665cd43f0e858dd4303&lt;/password_double_sha1_hex&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      --&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;password&gt;&lt;/password&gt;</span> 
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;networks&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;ip&gt;</span>::/0<span style=color:#204a87;font-weight:700>&lt;/ip&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/networks&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>&lt;!-- Settings profile for user. --&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;profile&gt;</span>default<span style=color:#204a87;font-weight:700>&lt;/profile&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>&lt;!-- Quota for user. --&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;quota&gt;</span>default<span style=color:#204a87;font-weight:700>&lt;/quota&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>&lt;!-- Set This parameter to Enable RBAC
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      Admin user can create other users and grant rights to them. --&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;access_management&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/access_management&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/admin&gt;</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><h2 id=default-user>default user</h2><p>As <code>default</code> is used for many internal and background operations, so it is not convenient to set it up with a password, because you would have to change it in many configs/parts. Best way to secure the default user is only allow localhost or trusted network connections like this in <code>users.xml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;users&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>    ......    
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;networks&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;ip&gt;</span>127.0.0.1/8<span style=color:#204a87;font-weight:700>&lt;/ip&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;ip&gt;</span>10.10.10.0/24<span style=color:#204a87;font-weight:700>&lt;/ip&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/networks&gt;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    ......
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><h2 id=replication-user>replication user</h2><p>The replication user is defined by <code>interserver_http_credential</code> tag. It does not relate to a ClickHouse client credentials configuration. <strong>If this tag is ommited then authentication is not used during replication.</strong> Ports 9009 and 9010(tls) provide low-level data access between servers. This ports should not be accessible from untrusted networks. You can specify credentials for authentication between replicas. This is required when <code>interserver_https_port</code> is accessible from untrusted networks. You can do so by defining user and password to the interserver credentials. Then replication protocol will use basic access authentication when connecting by HTTP/HTTPS to other replicas:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;interserver_http_credentials&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;user&gt;</span>replication<span style=color:#204a87;font-weight:700>&lt;/user&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;password&gt;</span>password<span style=color:#204a87;font-weight:700>&lt;/password&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/interserver_http_credentials&gt;</span>
</span></span></code></pre></div><h2 id=create-users-and-roles>Create users and roles</h2><p>Now we can setup users/roles using a generic best-practice approach for RBAC from other databases, like using roles, granting permissions to roles, creating users for different applications, etc&mldr;</p><p>see <a href=https://docs.altinity.com/operationsguide/security/clickhouse-hardening-guide/user-hardening/ target=_blank>User Hardening article</a></p><h2 id=example-3-roles-dba-dashboard_ro-ingester_rw>Example: 3 roles (dba, dashboard_ro, ingester_rw)</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dba</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>all</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dba</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>user1</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>identified</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;pass1234&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dba</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>user1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dashboard_ro</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dashboard_ro</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dictGet</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dashboard_ro</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>or</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>replace</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile_dashboard_ro</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_concurrent_queries_for_user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_threads</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_memory_usage_for_user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;30G&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_memory_usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;30G&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_execution_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_rows_to_read</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_bytes_to_read</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;5000G&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dashboard_ro</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>dash1</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>identified</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;pass1234&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dashboard_ro</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dash1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingester_rw</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingester_rw</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>or</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>replace</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile_ingester_rw</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_concurrent_queries_for_user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>-- user can run 40 queries (select, insert ...) simultaneously  
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_threads</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#8f5902;font-style:italic>-- each query can use up to 10 cpu (READONLY means user cannot override a value)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_memory_usage_for_user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;30G&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#8f5902;font-style:italic>-- all queries of the user can use up to 30G RAM
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_memory_usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;25G&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#8f5902;font-style:italic>-- each query can use up to 25G RAM
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_execution_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#8f5902;font-style:italic>-- each query can executes no longer 200 seconds
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_rows_to_read</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#8f5902;font-style:italic>-- each query can read up to 1 billion rows
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>max_bytes_to_read</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;5000G&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>READONLY</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#8f5902;font-style:italic>-- each query can read up to 5 TB from a MergeTree
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingester_rw</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>ingester_app1</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>identified</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;pass1234&#39;</span><span style=color:#f8f8f8;text-decoration:underline>　</span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingester_rw</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingester_app1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=check>check</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ clickhouse-client -u dash1 --password pass1234
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>create table <span style=color:#204a87>test</span> <span style=color:#ce5c00;font-weight:700>(</span> A Int64<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Engine</span><span style=color:#ce5c00;font-weight:700>=</span>Log<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>   DB::Exception: dash1: Not enough privileges
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>$ clickhouse-client -u user1 --password pass1234
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>create table <span style=color:#204a87>test</span> <span style=color:#ce5c00;font-weight:700>(</span> A Int64<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Engine</span><span style=color:#ce5c00;font-weight:700>=</span>Log<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>Ok.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>drop table test<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>Ok.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ clickhouse-client -u ingester_app1 --password pass1234
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span> count<span style=color:#ce5c00;font-weight:700>()</span> from system.numbers limit 1000000000000<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>   DB::Exception: Received from localhost:9000. DB::Exception: Limit <span style=color:#204a87;font-weight:700>for</span> rows or bytes to <span style=color:#204a87>read</span> exceeded, max rows: 1.00 billion
</span></span></code></pre></div><h2 id=clean-up>clean up</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profiles</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>─────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile_dashboard_ro</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile_ingester_rw</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>readonly</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>readonly</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile_dashboard_ro</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>profile_ingester_rw</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>roles</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>─────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dashboard_ro</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dba</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingester_rw</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dba</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dashboard_ro</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingester_rw</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>users</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>──────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dash1</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingester_app1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>user1</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingester_app1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>user1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dash1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-d7be1dae9438949199e19edc0af65a98>9 - Client Timeouts</h1><div class=lead>How to prevent connection errors.</div><p>Timeout settings are related to the client, server, and network. They can be tuned to solve sporadic timeout issues.</p><p>It&rsquo;s important to understand that network devices (routers, NATs, load balancers ) could have their own timeouts. Sometimes, they won&rsquo;t respect TCP keep-alive and close the session due to inactivity. Only application-level keepalives could prevent TCP sessions from closing.</p><p>Below are the settings that will work only if you set them in the default user profile. The problem is that they should be applied before the connection happens. And if you send them with a query/connection, it&rsquo;s already too late:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>receive_timeout</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3600</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>send_timeout</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3600</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>http_receive_timeout</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3600</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>http_send_timeout</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3600</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>http_connection_timeout</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Those can be set on the query level (but in the profile, too):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>tcp_keep_alive_timeout</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3600</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>--!!!send_progress_in_http_headers = 1,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>http_headers_progress_interval_ms</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>http_wait_end_of_query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>max_execution_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3600</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><a href=https://clickhouse.com/docs/en/integrations/language-clients/javascript#keep-alive-nodejs-only target=_blank rel=nofollow>https://clickhouse.com/docs/en/integrations/language-clients/javascript#keep-alive-nodejs-only</a></p><p><code>send_progress_in_http_headers</code>  will not be applied in this way because here we can configure the JDBC driver’s client options only (<a href=https://github.com/ClickHouse/clickhouse-java/blob/main/clickhouse-client/src/main/java/com/clickhouse/client/config/ClickHouseClientOption.java target=_blank>this</a>
), but there is an option called <code>custom_settings</code>  (<a href=https://github.com/ClickHouse/clickhouse-java/blob/main/clickhouse-client/src/main/java/com/clickhouse/client/config/ClickHouseClientOption.java#L34C22-L34C37 target=_blank>this</a>
) that will apply custom ch query settings for every query before the actual connection is created. The correct JDBC connection string will look like this:</p><pre tabindex=0><code>jdbc:clickhouse://&#34;${clickhouse.host}&#34;/&#34;${clickhouse.db}&#34;?ssl=true&amp;socket_timeout=3600000&amp;socket_keepalive=true&amp;custom_settings=send_progress_in_http_headers=1
</code></pre><h3 id=description>Description</h3><ul><li><code>http_send_timeout & send_timeout</code>: The timeout for sending data to the socket. If the server takes longer than this value to send data, the connection will be terminated (i.e., when the server pushes data to the client, and the client is not reading that for some reason).</li><li><code>http_receive_timeout & receive_timeout:</code> The timeout for receiving data from the socket. If the server takes longer than this value to receive the entire request from the client, the connection will be terminated. This setting ensures that the server is not kept waiting indefinitely for slow or unresponsive clients (i.e., the server tries to get some data from the client, but the client does not send anything).</li><li><code>http_connection_timeout & connect_timeout</code>: Defines how long ClickHouse should wait when it connects to another server. If the connection cannot be established within this time frame, it will be terminated. This does not impact the clients which connect to ClickHouse using HTTP (it only matters when ClickHouse works as a TCP/HTTP client).</li><li><code>keep_alive_timeout</code>: This is for &lsquo;Connection: keep-alive&rsquo; in HTTP 1.1, only for HTTP. It defines how long ClickHouse can wait for the next request in the same connection to arrive after serving the previous one. It does not lead to any SOCKET_TIMEOUT exception, just closes the socket if the client doesn&rsquo;t start a new request after that time.</li></ul><aside>💡 In 23.12 `keep_alive_timeout` was introduced default of 10 seconds. Before 23.12 default `keep_alive_timeout` configured on clickhouse side was 3. For 23.8 `keep_alive_timeout` is not present as a server setting in `system.server_settings` table but if is in the config.xml.</aside><ul><li><code>sync_request_timeout</code> – timeout for server ping. Defaults to 5 seconds.</li></ul><p>In some cases, if the data sync request time out, it may be caused by many different reasons, basically it shouldn&rsquo;t take more than 5 seconds for synchronous request-result protocol call (like Ping or TableStatus) in most of the normal circumstances, thus if time out setting too long, eg. 5 minutes or longer than that, then you will run into more overall performance issues. This is not good for any application on the server.</p><h3 id=how-to-check-the-current-timeouts>How to check the current timeouts:</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>changed</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>description</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ILIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%send_timeout%&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ILIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%receive_timeout%&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ILIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%keep_alive%&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ILIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%_http_headers&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ILIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;http_headers_progres_%&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ILIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;http_connection_%&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6f3f5a9c15f13480a872c2baa138f08e>10 - Compatibility layer for the Altinity Kubernetes Operator for ClickHouse®</h1><div class=lead>Page description for heading and indexes.</div><p>It&rsquo;s possible to expose <code>clickhouse-server</code> metrics in the style used by the Altinity Kubernetes Operator for ClickHouse®. It&rsquo;s for the <code>clickhouse-operator</code> grafana dashboard.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>operator_compatible_metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Float64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>help</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>labels</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Map</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;chi_clickhouse_event_&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Float64&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>description</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>help</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;hostname&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>labels</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;counter&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>events</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;chi_clickhouse_metric_&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Float64&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>description</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>help</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;hostname&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>labels</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;gauge&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;chi_clickhouse_metric_&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>help</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;hostname&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>labels</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;gauge&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;chi_clickhouse_metric_MemoryDictionaryBytesAllocated&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_allocated</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Float64&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;Memory size allocated for dictionaries&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>help</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;hostname&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>labels</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;gauge&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dictionaries</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;chi_clickhouse_metric_LongestRunningQuery&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>elapsed</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Float64&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;Longest running query time&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>help</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;hostname&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>labels</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;gauge&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>processes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;chi_clickhouse_table_partitions&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;chi_clickhouse_table_parts&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;chi_clickhouse_table_parts_bytes&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;chi_clickhouse_table_parts_bytes_uncompressed&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;chi_clickhouse_table_parts_rows&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;chi_clickhouse_metric_DiskDataBytes&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;chi_clickhouse_metric_MemoryPrimaryKeyBytesAllocated&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>names</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data_uncompressed_bytes</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_on_disk</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>primary_key_bytes_in_memory_allocated</span><span style=color:#000;font-weight:700>)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arrayZip</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>names</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tpl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>tpl</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tpl</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Float64&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>help</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;database&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;table&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;active&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>active</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;hostname&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>labels</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;gauge&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>active</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;chi_clickhouse_table_mutations&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;chi_clickhouse_table_mutations_parts_to_do&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>names</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Float64&#39;</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts_to_do</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Float64&#39;</span><span style=color:#000;font-weight:700>)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arrayZip</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>names</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tpl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>tpl</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>tpl</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>help</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;database&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;table&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;hostname&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>labels</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;gauge&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutations</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>is_done</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>reason</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;unknown&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;detached_by_user&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>reason</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;unknown&#39;</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>detach_reason</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;chi_clickhouse_metric_DetachedParts&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Float64&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>help</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;database&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;table&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;disk&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;hostname&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>labels</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;gauge&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>detached_parts</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>disk</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>reason</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ASC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nano /etc/clickhouse-server/config.d/operator_metrics.xml
</span></span><span style=display:flex><span>&lt;clickhouse&gt;
</span></span><span style=display:flex><span>    &lt;http_handlers&gt;
</span></span><span style=display:flex><span>        &lt;rule&gt;
</span></span><span style=display:flex><span>            &lt;url&gt;/metrics&lt;/url&gt;
</span></span><span style=display:flex><span>            &lt;methods&gt;POST,GET&lt;/methods&gt;
</span></span><span style=display:flex><span>            &lt;handler&gt;
</span></span><span style=display:flex><span>                &lt;type&gt;predefined_query_handler&lt;/type&gt;
</span></span><span style=display:flex><span>                &lt;query&gt;SELECT * FROM system.operator_compatible_metrics FORMAT Prometheus&lt;/query&gt;
</span></span><span style=display:flex><span>                &lt;content_type&gt;text/plain<span style=color:#000;font-weight:700>;</span> <span style=color:#000>charset</span><span style=color:#ce5c00;font-weight:700>=</span>utf-8&lt;/content_type&gt;
</span></span><span style=display:flex><span>            &lt;/handler&gt;
</span></span><span style=display:flex><span>        &lt;/rule&gt;
</span></span><span style=display:flex><span>        &lt;defaults/&gt;
</span></span><span style=display:flex><span>        &lt;rule&gt;
</span></span><span style=display:flex><span>            &lt;url&gt;/&lt;/url&gt;
</span></span><span style=display:flex><span>            &lt;methods&gt;POST,GET&lt;/methods&gt;
</span></span><span style=display:flex><span>            &lt;headers&gt;&lt;pragma&gt;no-cache&lt;/pragma&gt;&lt;/headers&gt;
</span></span><span style=display:flex><span>            &lt;handler&gt;
</span></span><span style=display:flex><span>                &lt;type&gt;dynamic_query_handler&lt;/type&gt;
</span></span><span style=display:flex><span>                &lt;query_param_name&gt;query&lt;/query_param_name&gt;
</span></span><span style=display:flex><span>            &lt;/handler&gt;
</span></span><span style=display:flex><span>        &lt;/rule&gt;
</span></span><span style=display:flex><span>    &lt;/http_handlers&gt;    
</span></span><span style=display:flex><span>&lt;/clickhouse&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>curl http://localhost:8123/metrics
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># HELP chi_clickhouse_metric_Query Number of executing queries</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># TYPE chi_clickhouse_metric_Query gauge</span>
</span></span><span style=display:flex><span>chi_clickhouse_metric_Query<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>hostname</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;LAPTOP&#34;</span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># HELP chi_clickhouse_metric_Merge Number of executing background merges</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># TYPE chi_clickhouse_metric_Merge gauge</span>
</span></span><span style=display:flex><span>chi_clickhouse_metric_Merge<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>hostname</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;LAPTOP&#34;</span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># HELP chi_clickhouse_metric_PartMutation Number of mutations (ALTER DELETE/UPDATE)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># TYPE chi_clickhouse_metric_PartMutation gauge</span>
</span></span><span style=display:flex><span>chi_clickhouse_metric_PartMutation<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>hostname</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;LAPTOP&#34;</span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-44473f5247ffb40a8d1157112098a815>11 - How to convert uniqExact states to approximate uniq functions states</h1><div class=lead>A way to convert to uniqExactState to other uniqStates (like uniqCombinedState) in ClickHouse®</div><h2 id=uniqexactstate>uniqExactState</h2><p><code>uniqExactState</code> is stored in two parts: a count of values in <code>LEB128</code> format + list values without a delimiter.</p><p>In our case, the value is <code>sipHash128</code> of strings passed to uniqExact function.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌─hex(uniqExactState(toString(arrayJoin([1]))))─┐
</span></span><span style=display:flex><span>│ 01E2756D8F7A583CA23016E03447724DE7            │
</span></span><span style=display:flex><span>└───────────────────────────────────────────────┘
</span></span><span style=display:flex><span>  01         E2756D8F7A583CA23016E03447724DE7
</span></span><span style=display:flex><span>  ^          ^
</span></span><span style=display:flex><span>  LEB128     sipHash128
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>┌─hex(uniqExactState(toString(arrayJoin([1, 2]))))───────────────────┐
</span></span><span style=display:flex><span>│ 024809CB4528E00621CF626BE9FA14E2BFE2756D8F7A583CA23016E03447724DE7 │
</span></span><span style=display:flex><span>└────────────────────────────────────────────────────────────────────┘
</span></span><span style=display:flex><span>  02 4809CB4528E00621CF626BE9FA14E2BF E2756D8F7A583CA23016E03447724DE7
</span></span><span style=display:flex><span>  ^        ^                                ^
</span></span><span style=display:flex><span>LEB128 sipHash128                       sipHash128
</span></span></code></pre></div><p>So, our task is to find how we can generate such values by ourself.
In case of <code>String</code> data type, it just the simple <code>sipHash128</code> function.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌─hex(sipHash128(toString(2)))─────┬─hex(sipHash128(toString(1)))─────┐
</span></span><span style=display:flex><span>│ 4809CB4528E00621CF626BE9FA14E2BF │ E2756D8F7A583CA23016E03447724DE7 │
</span></span><span style=display:flex><span>└──────────────────────────────────┴──────────────────────────────────┘
</span></span></code></pre></div><p>The second task: it needs to read a state and split it into an array of values.
Luckily for us, ClickHouse® use the exact same serialization (<code>LEB128</code> + list of values) for Arrays (in this case if <code>uniqExactState</code> and <code>Array</code> are serialized into <code>RowBinary</code> format).</p><p>We need one a helper &ndash; <code>UDF</code> function to do that conversion:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>cat /etc/clickhouse-server/pipe_function.xml
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;function&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>executable<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;execute_direct&gt;</span>0<span style=color:#204a87;font-weight:700>&lt;/execute_direct&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;name&gt;</span>pipe<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;return_type&gt;</span>Array(FixedString(16))<span style=color:#204a87;font-weight:700>&lt;/return_type&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;argument&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>String<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/argument&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;format&gt;</span>RowBinary<span style=color:#204a87;font-weight:700>&lt;/format&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;command&gt;</span>cat<span style=color:#204a87;font-weight:700>&lt;/command&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;send_chunk_header&gt;</span>0<span style=color:#204a87;font-weight:700>&lt;/send_chunk_header&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/function&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><p>This UDF &ndash; <code>pipe</code> converts <code>uniqExactState</code> to the <code>Array(FixedString(16))</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌─arrayMap(x -&gt; hex(x), pipe(uniqExactState(toString(arrayJoin([1, 2])))))──────────────┐
</span></span><span style=display:flex><span>│ [&#39;4809CB4528E00621CF626BE9FA14E2BF&#39;,&#39;E2756D8F7A583CA23016E03447724DE7&#39;]               │
</span></span><span style=display:flex><span>└───────────────────────────────────────────────────────────────────────────────────────┘
</span></span></code></pre></div><p>And here is the full example, how you can convert <code>uniqExactState(string)</code> to <code>uniqState(string)</code> or <code>uniqCombinedState(string)</code> using <code>pipe</code> UDF and <code>arrayReduce('func', [..])</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Generate demo with random data, uniqs are stored as heavy uniqExact
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregates</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>uniqExact</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AggregateFunction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AggregatingMergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqExactState</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toString</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>042</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>06</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>39</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Let&#39;s add a new columns to store optimized, approximate uniq &amp; uniqCombined
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregates</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ADD</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLUMN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>uniq</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AggregateFunction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FixedString</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayReduce</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;uniqState&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pipe</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>)),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ADD</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLUMN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>uniqCombined</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AggregateFunction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqCombined</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FixedString</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayReduce</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;uniqCombinedState&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pipe</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Materialize defaults in the new columns
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregates</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniqCombined</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniqCombined</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mutations_sync</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Let&#39;s reset defaults to remove the dependancy of the UDF from our table
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregates</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>modify</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLUMN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>uniq</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remove</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>modify</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLUMN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>uniqCombined</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remove</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Alternatively you can populate data in the new columns directly without using DEFAULT columns
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- ALTER TABLE aggregates UPDATE 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>--     uniqCombined = arrayReduce(&#39;uniqCombinedState&#39;, pipe(uniqExact)), 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>--     uniq = arrayReduce(&#39;uniqState&#39;, pipe(uniqExact)) 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- WHERE 1 settings mutations_sync=2;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Check results, results are slighty different, because uniq &amp; uniqCombined are approximate functions
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqExactMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqCombinedMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqCombined</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregates</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqExactMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqCombinedMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqCombined</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500195</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500455</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>502599</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>501549</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>498058</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>504428</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>499748</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500195</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500791</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500836</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>502430</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>497558</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500262</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>501785</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>501514</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>495758</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500121</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>498597</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>502173</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500455</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>499144</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>498386</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500525</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>503139</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>503624</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>497103</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>499986</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>497992</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>502027</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>494833</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>498831</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500983</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>501103</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500836</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>499409</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>496791</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>501641</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>502991</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500648</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500881</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴───────────────────────────┴─────────────────────────────────┴─────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>312</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>61</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Now, lets repeat the same insert, but in that case we will also populate <code>uniq</code> & <code>uniqCombined</code> with values converted via <code>sipHash128</code> function.
If we did everything right, <code>uniq</code> counts will not change, because we inserted the exact same values.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregates</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqExactState</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toString</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqState</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sipHash128</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toString</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>))),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqCombinedState</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sipHash128</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toString</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>386</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>06</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>86</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>86</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqExactMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqCombinedMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqCombined</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregates</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqExactMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqCombinedMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniqCombined</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>uniqMerge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500195</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500455</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>502599</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>501549</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>498058</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>504428</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>499748</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500195</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500791</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500836</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>502430</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>497558</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500262</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>501785</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>501514</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>495758</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500121</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>498597</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>502173</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500455</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>499144</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>498386</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500525</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>503139</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>503624</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>497103</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>499986</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>497992</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>502027</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>494833</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>498831</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500983</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>501103</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500836</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>499409</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>496791</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>501641</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>502991</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#0000cf;font-weight:700>500648</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#0000cf;font-weight:700>500881</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴───────────────────────────┴─────────────────────────────────┴─────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>318</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>02</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thousand</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Let&rsquo;s compare the data size, <code>uniq</code> won in this case, but check this article <a href=../../altinity-kb-schema-design/uniq-functions/>Functions to count uniqs</a>
, mileage may vary.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>optimize</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregates</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>column_data_compressed_bytes</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>compressed</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>column_data_uncompressed_bytes</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>usize</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uncompressed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts_columns</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;aggregates&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%uniq%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>column</span><span style=color:#a40000>───────┬─</span><span style=color:#000>compressed</span><span style=color:#a40000>─┬─</span><span style=color:#000>uncompressed</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniqExact</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>153</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>152</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>61</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniqCombined</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>76</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>62</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>76</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>38</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>38</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────┴────────────┴──────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2bf046fe139243d74994289f2cb4e13e>12 - Custom Settings</h1><div class=lead>Using custom settings</div><h2 id=using-custom-settings-in-config>Using custom settings in config</h2><p>You can not use the custom settings in config file &lsquo;as is&rsquo;, because ClickHouse® don&rsquo;t know which datatype should be used to parse it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>cat /etc/clickhouse-server/users.d/default_profile.xml 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;profiles&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>     	     <span style=color:#204a87;font-weight:700>&lt;custom_data_version&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/custom_data_version&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- will not work! see below --&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/profiles&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div><p>That will end up with the following error:</p><pre tabindex=0><code>2021.09.24 12:50:37.369259 [ 264905 ] {} &lt;Error&gt; ConfigReloader: Error updating configuration from &#39;/etc/clickhouse-server/users.xml&#39; config.: Code: 536. DB::Exception: Couldn&#39;t restore Field from dump: 1: while parsing value &#39;1&#39; for setting &#39;custom_data_version&#39;. (CANNOT_RESTORE_FROM_FIELD_DUMP), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, int, bool) @ 0x9440eba in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
1. DB::Field::restoreFromDump(std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt; const&amp;)::$_4::operator()() const @ 0x10449da0 in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
2. DB::Field::restoreFromDump(std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt; const&amp;) @ 0x10449bf1 in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
3. DB::BaseSettings&lt;DB::SettingsTraits&gt;::stringToValueUtil(std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;) @ 0x1042e2bf in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
4. DB::UsersConfigAccessStorage::parseFromConfig(Poco::Util::AbstractConfiguration const&amp;) @ 0x1041a097 in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
5. void std::__1::__function::__policy_invoker&lt;void (Poco::AutoPtr&lt;Poco::Util::AbstractConfiguration&gt;, bool)&gt;::__call_impl&lt;std::__1::__function::__default_alloc_func&lt;DB::UsersConfigAccessStorage::load(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::function&lt;std::__1::shared_ptr&lt;zkutil::ZooKeeper&gt; ()&gt; const&amp;)::$_0, void (Poco::AutoPtr&lt;Poco::Util::AbstractConfiguration&gt;, bool)&gt; &gt;(std::__1::__function::__policy_storage const*, Poco::AutoPtr&lt;Poco::Util::AbstractConfiguration&gt;&amp;&amp;, bool) @ 0x1042e7ff in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
6. DB::ConfigReloader::reloadIfNewer(bool, bool, bool, bool) @ 0x11caf54e in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
7. DB::ConfigReloader::run() @ 0x11cb0f8f in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
8. ThreadFromGlobalPool::ThreadFromGlobalPool&lt;void (DB::ConfigReloader::*)(), DB::ConfigReloader*&gt;(void (DB::ConfigReloader::*&amp;&amp;)(), DB::ConfigReloader*&amp;&amp;)::&#39;lambda&#39;()::operator()() @ 0x11cb19f1 in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
9. ThreadPoolImpl&lt;std::__1::thread&gt;::worker(std::__1::__list_iterator&lt;std::__1::thread, void*&gt;) @ 0x9481f5f in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
10. void* std::__1::__thread_proxy&lt;std::__1::tuple&lt;std::__1::unique_ptr&lt;std::__1::__thread_struct, std::__1::default_delete&lt;std::__1::__thread_struct&gt; &gt;, void ThreadPoolImpl&lt;std::__1::thread&gt;::scheduleImpl&lt;void&gt;(std::__1::function&lt;void ()&gt;, int, std::__1::optional&lt;unsigned long&gt;)::&#39;lambda0&#39;()&gt; &gt;(void*) @ 0x9485843 in /usr/lib/debug/.build-id/ba/25f6646c3be7aa95f452ec85461e96178aa365.debug
11. start_thread @ 0x9609 in /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
12. __clone @ 0x122293 in /usr/lib/x86_64-linux-gnu/libc-2.31.so
 (version 21.10.1.8002 (official build))


2021.09.29 11:36:07.722213 [ 2090 ] {} &lt;Error&gt; Application: DB::Exception: Couldn&#39;t restore Field from dump: 1: while parsing value &#39;1&#39; for setting &#39;custom_data_version&#39;
</code></pre><p>To make it work you need to change it an the following way:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>cat /etc/clickhouse-server/users.d/default_profile.xml 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;profiles&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;custom_data_version&gt;</span>UInt64_1<span style=color:#204a87;font-weight:700>&lt;/custom_data_version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/profiles&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>cat /etc/clickhouse-server/users.d/default_profile.xml 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;profiles&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;custom_data_version&gt;</span>&#39;1&#39;<span style=color:#204a87;font-weight:700>&lt;/custom_data_version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/profiles&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div><p>The list of recognized prefixes is in the sources: <a href=https://github.com/ClickHouse/ClickHouse/blob/ea13a8b562edbc422c07b5b4ecce353f79b6cb63/src/Core/Field.cpp#L253-L270 target=_blank>https://github.com/ClickHouse/ClickHouse/blob/ea13a8b562edbc422c07b5b4ecce353f79b6cb63/src/Core/Field.cpp#L253-L270</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-bbd4c8156a39e2b06aedbc53ab2fcc76>13 - Description of asynchronous_metrics</h1><div class=lead>Description of asynchronous_metrics</div><pre tabindex=0><code>CompiledExpressionCacheCount    -- number or compiled cached expression (if CompiledExpressionCache is enabled)

jemalloc -- parameters of jemalloc allocator, they are not very useful, and not interesting

MarkCacheBytes / MarkCacheFiles  -- there are cache for .mrk files (default size is 5GB), you can see is it use all 5GB or not

MemoryCode  -- how much memory allocated for ClickHouse® executable 

MemoryDataAndStack -- virtual memory allocated for data and stack

MemoryResident  -- real memory used by ClickHouse ( the same as top RES/RSS)

MemoryShared   -- shared memory used by ClickHouse

MemoryVirtual  -- virtual memory used by ClickHouse ( the same as top VIRT)

NumberOfDatabases

NumberOfTables

ReplicasMaxAbsoluteDelay -- important parameter - replica max absolute delay in seconds

ReplicasMaxRelativeDelay -- replica max relative delay (from other replicas) in seconds

ReplicasMaxInsertsInQueue  -- max number of parts to fetch for a single Replicated table

ReplicasSumInsertsInQueue  -- sum of parts to fetch for all Replicated tables

ReplicasMaxMergesInQueue  -- max number of merges in queue for a single Replicated table

ReplicasSumMergesInQueue  -- total number of merges in queue for all Replicated tables

ReplicasMaxQueueSize -- max number of tasks  for a single Replicated table 

ReplicasSumQueueSize -- total number of tasks in replication queue

UncompressedCacheBytes/UncompressedCacheCells  -- allocated memory for uncompressed cache (disabled by default)

Uptime     -- uptime seconds
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-bc860412ddbc53eff7624f80da132f8a>14 - ClickHouse® data/disk encryption (at rest)</h1><div class=lead>Example how to encrypt data in tables using storage policies.</div><h2 id=create-folder>Create folder</h2><pre tabindex=0><code>mkdir /data/clickhouse_encrypted
chown clickhouse.clickhouse /data/clickhouse_encrypted
</code></pre><h2 id=configure-encrypted-disk-and-storage>Configure encrypted disk and storage</h2><ul><li><a href=https://clickhouse.com/docs/en/operations/storing-data/#encrypted-virtual-file-system target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/storing-data/#encrypted-virtual-file-system</a></li><li><a href=https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server-settings-encryption target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server-settings-encryption</a></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>cat /etc/clickhouse-server/config.d/encrypted_storage.xml
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;storage_configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;disks&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;disk1&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>local<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;path&gt;</span>/data/clickhouse_encrypted/<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/disk1&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;encrypted_disk&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>encrypted<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;disk&gt;</span>disk1<span style=color:#204a87;font-weight:700>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;path&gt;</span>encrypted/<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;algorithm&gt;</span>AES_128_CTR<span style=color:#204a87;font-weight:700>&lt;/algorithm&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;key_hex</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>00112233445566778899aabbccddeeff<span style=color:#204a87;font-weight:700>&lt;/key_hex&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;current_key_id&gt;</span>0<span style=color:#204a87;font-weight:700>&lt;/current_key_id&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/encrypted_disk&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/disks&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;policies&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;encrypted&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;volumes&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;encrypted_volume&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#204a87;font-weight:700>&lt;disk&gt;</span>encrypted_disk<span style=color:#204a87;font-weight:700>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;/encrypted_volume&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/volumes&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/encrypted&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/policies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/storage_configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart clickhouse-server
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>is_encrypted</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disks</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>───────────┬─</span><span style=color:#000>path</span><span style=color:#a40000>──────────────────────────────────┬─</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#a40000>──┬─</span><span style=color:#000>is_encrypted</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk1</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>data</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse_encrypted</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>encrypted_disk</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>data</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse_encrypted</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>encrypted</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└────────────────┴───────────────────────────────────────┴───────┴──────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>storage_policies</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>policy_name</span><span style=color:#a40000>─┬─</span><span style=color:#000>volume_name</span><span style=color:#a40000>──────┬─</span><span style=color:#000>volume_priority</span><span style=color:#a40000>─┬─</span><span style=color:#000>disks</span><span style=color:#a40000>──────────────┬─</span><span style=color:#000>volume_type</span><span style=color:#a40000>─┬─</span><span style=color:#000>max_data_part_size</span><span style=color:#a40000>─┬─</span><span style=color:#000>move_factor</span><span style=color:#a40000>─┬─</span><span style=color:#000>prefer_not_to_merge</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JBOD</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>encrypted</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>encrypted_volume</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;encrypted_disk&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JBOD</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────┴──────────────────┴─────────────────┴────────────────────┴─────────────┴────────────────────┴─────────────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=create-table>Create table</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_encrypted</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c_int</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c_str</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c_float</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Float64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c_int</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage_policy</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;encrypted&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /data/clickhouse_encrypted/encrypted/store/906/9061167e-d5f7-45ea-8e54-eb6ba3b678dc/format_version.txt
</span></span><span style=display:flex><span>ENC�AdruM�˪h<span style=color:#4e9a06>&#34;��^�
</span></span></span></code></pre></div><h1 id=compare-performance-of-encrypted-and-not-encrypted-tables>Compare performance of encrypted and not encrypted tables</h1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_encrypted</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c_int</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c_str</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c_float</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Float64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c_int</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage_policy</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;encrypted&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_encrypted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cityHash64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>lower</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>hex</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>MD5</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toString</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)))),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>cityHash64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers_mt</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>357</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>66</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>805</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>28</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>02</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_unencrypted</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c_int</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c_str</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c_float</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Float64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c_int</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_unencrypted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cityHash64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>lower</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>hex</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>MD5</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toString</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)))),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>cityHash64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers_mt</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>175</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>66</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>805</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>28</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>83</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>avg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c_float</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_encrypted</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>195</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>800</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>511</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>66</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>avg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c_float</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_unencrypted</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>150</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>800</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>668</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>71</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>35</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c_int</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_encrypted</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>281</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>800</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>355</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>74</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>85</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c_int</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_unencrypted</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>193</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>800</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>518</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>88</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_threads</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>avg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c_float</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_encrypted</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>934</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>800</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>107</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>856</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>avg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c_float</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bench_unencrypted</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>874</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>800</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>114</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>915</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>39</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=read-key_hex-from-environment-variable>read key_hex from environment variable</h2><ul><li><a href=https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server-settings-encryption target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server-settings-encryption</a></li><li><a href=https://serverfault.com/questions/413397/how-to-set-environment-variable-in-systemd-service target=_blank>https://serverfault.com/questions/413397/how-to-set-environment-variable-in-systemd-service</a></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>cat /etc/clickhouse-server/config.d/encrypted_storage.xml
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;storage_configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;disks&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;disk1&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>local<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;path&gt;</span>/data/clickhouse_encrypted/<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/disk1&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;encrypted_disk&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>encrypted<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;disk&gt;</span>disk1<span style=color:#204a87;font-weight:700>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;path&gt;</span>encrypted/<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;algorithm&gt;</span>AES_128_CTR<span style=color:#204a87;font-weight:700>&lt;/algorithm&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;key_hex</span> <span style=color:#c4a000>from_env=</span><span style=color:#4e9a06>&#34;DiskKey&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/encrypted_disk&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/disks&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;policies&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;encrypted&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;volumes&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;encrypted_volume&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#204a87;font-weight:700>&lt;disk&gt;</span>encrypted_disk<span style=color:#204a87;font-weight:700>&lt;/disk&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;/encrypted_volume&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/volumes&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/encrypted&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/policies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/storage_configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat /etc/default/clickhouse-server
</span></span><span style=display:flex><span>DiskKey=00112233445566778899aabbccddeeff
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart clickhouse-server
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-3345c1c9243b7996f5a1bc9dfc258697>15 - DR two DC</h1><div class=lead>Disaster Recovery configuration between two data centers</div><p>Clickhouse uses Keeper (or ZooKeeper) to inform other cluster nodes about changes. Clickhouse nodes then fetch new parts directly from other nodes in the cluster. The Keeper cluster is a key for building a DR schema. You can consider Keeper a “true” cluster while clickhouse-server nodes as storage access instruments.</p><p>To implement a disaster recovery (DR) setup for ClickHouse across two physically separated data centers (A and B), with only one side active at a time, you can create a single ClickHouse cluster spanning both data centers. This setup will address data synchronization, replication, and coordination needs.</p><h2 id=cluster-configuration>Cluster Configuration</h2><ol><li>Create a single ClickHouse cluster with nodes in both data centers.</li><li>Configure the appropriate number of replicas and shards based on your performance and redundancy requirements.</li><li>Use ClickHouse Keeper or ZooKeeper for cluster coordination (see Keeper flavors discussion below).</li></ol><h2 id=data-synchronization-and-replication>Data Synchronization and Replication</h2><ol><li>ClickHouse replicas operate in a master-master configuration, eliminating the need for a separate slave approach.</li><li>Configure replicas across both data centers to ensure data synchronization.</li><li>While both DCs have active replicas, consider DC B replicas as &ldquo;passive&rdquo; from the application&rsquo;s perspective.</li></ol><h3 id=example-configuration>Example Configuration:</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;remote_servers&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;company_cluster&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>ch1.dc-a.company.com<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>ch2.dc-a.company.com<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>ch1.dc-b.company.com<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>ch2.dc-b.company.com<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/shard&gt;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- Add more shards as needed --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/company_cluster&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/remote_servers&gt;</span>
</span></span></code></pre></div><h2 id=keeper-setup>Keeper Setup</h2><ol><li>In the active data center (DC A):<ul><li>Deploy 3 active Keeper nodes</li></ul></li><li>In the passive data center (DC B):<ul><li>Deploy 1 Keeper node in observer role</li></ul></li></ol><h3 id=failover-process>Failover Process:</h3><p>In case of a failover:</p><ol><li>Shut down the ClickHouse cluster in DC A completely</li><li>Manually switch Keeper in DC B from observer to active participant (restart needed).</li><li>Create two additional Keeper nodes (they will replicate the state automatically).</li><li>Add two additional Keeper nodes to clickhouse configs</li></ol><h2 id=clickhouse-keeper-vs-zookeeper>ClickHouse Keeper vs. ZooKeeper</h2><p>While ClickHouse Keeper is generally preferable for very high-load scenarios, ZooKeeper remains a viable option for many deployments.</p><p>Considerations:</p><ul><li>ClickHouse Keeper is optimized for ClickHouse operations and can handle higher loads.</li><li>ZooKeeper is well-established and works well for many clients.</li></ul><p>The choice between ClickHouse Keeper and ZooKeeper is more about the overall system architecture and load patterns.</p><h2 id=configuration-synchronization>Configuration Synchronization</h2><p>To keep configurations in sync:</p><ol><li>Use ON CLUSTER clause for DDL statements</li><li>Store RBAC objects in Keeper</li><li>Implement a configuration management system (e.g., Ansible, Puppet) to simultaneously apply changes to clickhouse configuration files in config.d</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-fd903f5df1be4cc98c6592a99d2d5fd3>16 - How ALTERs work in ClickHouse®</h1><h3 id=how-alters-work-in-clickhouse>How ALTERs work in ClickHouse®:</h3><h4 id=add-columnindexprojection>ADD (COLUMN/INDEX/PROJECTION)</h4><p>Lightweight, will only change table metadata.
So new entity will be added in case of creation of new parts during INSERT&rsquo;s OR during merges of old parts.</p><p>In case of COLUMN, ClickHouse will calculate column value on fly in query context.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ADD</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLUMN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserted_at</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserted_at</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─────────</span><span style=color:#000>inserted_at</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>28</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>58</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─────────</span><span style=color:#000>inserted_at</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>28</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>58</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserted_at</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─────────</span><span style=color:#000>inserted_at</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─────────</span><span style=color:#000>inserted_at</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>Each</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>will</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>return</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>different</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserted_at</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>because</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>each</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>function</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>being</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>executed</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserted_at</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─────────</span><span style=color:#000>inserted_at</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic>-- &lt; This value was materialized during ingestion, that&#39;s why it&#39;s smaller than value for keys 1 &amp; 2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>└─────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─────────</span><span style=color:#000>inserted_at</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>53</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─────────</span><span style=color:#000>inserted_at</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>53</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>OPTIMIZE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserted_at</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─────────</span><span style=color:#000>inserted_at</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>52</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>52</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserted_at</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_materialization</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─────────</span><span style=color:#000>inserted_at</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>52</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>52</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2022</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>So</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserted</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>after</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>addition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>can</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>have</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>lower</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserted_at</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>then</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>without</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>materialization</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><p>If you want to backpopulate data for old parts, you have multiple options:</p><h4 id=materialize-columnindexprojection-partition-id->MATERIALIZE (COLUMN/INDEX/PROJECTION) (PART[ITION ID] &lsquo;&rsquo;)</h4><p>Will materialize this entity.</p><h4 id=optimize-table-xxxx-partition-id--final>OPTIMIZE TABLE xxxx (PART[ITION ID] &lsquo;&rsquo;) (FINAL)</h4><p>Will trigger merge, which will lead to materialization of all entities in affected parts.</p><h4 id=alter-table-xxxx-update-column_name--column_name-where-1>ALTER TABLE xxxx UPDATE column_name = column_name WHERE 1;</h4><p>Will trigger mutation, which will materialize this column.</p><h4 id=drop-columnindexprojection>DROP (COLUMN/INDEX/PROJECTION)</h4><p>Lightweight, it&rsquo;s only about changing of table metadata and removing corresponding files from filesystem.
For Compact parts it will trigger merge, which can be heavy. <a href=https://github.com/ClickHouse/ClickHouse/issues/27502 target=_blank>issue</a></p><h4 id=modify-column-date-type>MODIFY COLUMN (DATE TYPE)</h4><ol><li>Change column type in table schema.</li><li>Schedule mutation to change type for old parts.</li></ol><h3 id=mutations>Mutations</h3><p>Affected parts - parts with rows matching condition.</p><h4 id=alter-table-xxxxx-delete-where-column_1--1>ALTER TABLE xxxxx DELETE WHERE column_1 = 1;</h4><ol><li>Will overwrite all column data in affected parts.</li><li>For all part(ition)s will create new directories on disk and write new data to them or create hardlinks if they untouched.</li><li>Register new parts names in ZooKeeper.</li></ol><h4 id=alter-table-xxxxx-delete-in-partition-id--where-column_1--1>ALTER TABLE xxxxx DELETE IN PARTITION ID &rsquo;&rsquo; WHERE column_1 = 1;</h4><p>Will do the same but only for specific partition.</p><h4 id=alter-table-xxxxx-update-set-column_2--column_2-column_3--column_3-where-column_1--1>ALTER TABLE xxxxx UPDATE SET column_2 = column_2, column_3 = column_3 WHERE column_1 = 1;</h4><ol><li>Will overwrite column_2, column_3 data in affected parts.</li><li>For all part(ition)s will create new directories on disk and write new data to them or create hardlinks if they untouched.</li><li>Register new parts names in ZooKeeper.</li></ol><h4 id=delete-from-xxxxx-where-column_1--1>DELETE FROM xxxxx WHERE column_1 = 1;</h4><ol><li>Will create & populate hidden boolean column in affected parts. (_row_exists column)</li><li>For all part(ition)s will create new directories on disk and write new data to them or create hardlinks if they untouched.</li><li>Register new parts names in ZooKeeper.</li></ol><p>Despite that LWD mutations will not rewrite all columns, steps 2 & 3 in case of big tables can take significant time.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0d0e01b25f15d892fbdca2892ed4b4db>17 - How to recreate a table in case of total corruption of the replication queue</h1><div class=lead>How to recreate a table in case of total corruption of the replication queue.</div><h2 id=how-to-fix-a-replication-using-hard-reset-way>How to fix a replication using hard-reset way</h2><ol><li>Find the best replica (replica with the most fresh/consistent) data.</li><li>Backup the table <code>alter table mydatabase.mybadtable freeze;</code></li><li>Stop all applications!!! Stop ingestion. Stop queries - table will be empty for some time.</li><li>Check that detached folder is empty or clean it.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;alter table &#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39; drop detached part \&#39;&#39;, name, &#39;</span><span style=color:#a40000>\</span><span style=color:#4e9a06>&#39; settings allow_drop_detached=1;&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>detached_parts</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;mydatabase&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;mybadtable&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSVRaw</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ol start=5><li>Make sure that detached folder is empty <code>select count() from system.detached_parts where database='mydatabase' and table ='mybadtable';</code></li><li>Detach all parts (table will became empty)</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;alter table &#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39; detach partition id \&#39;&#39;, partition_id, &#39;</span><span style=color:#a40000>\</span><span style=color:#4e9a06>&#39;;&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>detach</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;mydatabase&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;mybadtable&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>detach</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>detach</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ASC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSVRaw</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ol start=7><li>Make sure that table is empty <code>select count() from mydatabase.mybadtable;</code></li><li>Attach all parts back</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;alter table &#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39; attach part \&#39;&#39;, a.name, &#39;</span><span style=color:#a40000>\</span><span style=color:#4e9a06>&#39;;&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>detached_parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;mydatabase&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;mybadtable&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSVRaw</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ol start=9><li>Make sure that data is consistent at all replicas</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_count</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition_count</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;mydatabase&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;mybadtable&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7e8b8793d3f75d7f6e63b71cccb3389e>18 - http handler example</h1><div class=lead>http handler example</div><h2 id=http-handler-example-how-to-disable-play>http handler example (how to disable /play)</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span># cat /etc/clickhouse-server/config.d/play_disable.xml
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>&lt;http_handlers&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;rule&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;url&gt;</span>/play<span style=color:#204a87;font-weight:700>&lt;/url&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;methods&gt;</span>GET<span style=color:#204a87;font-weight:700>&lt;/methods&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;handler&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>static<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;status&gt;</span>403<span style=color:#204a87;font-weight:700>&lt;/status&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;content_type&gt;</span>text/plain; charset=UTF-8<span style=color:#204a87;font-weight:700>&lt;/content_type&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;response_content&gt;&lt;/response_content&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/handler&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;defaults/&gt;</span>         <span style=color:#8f5902;font-style:italic>&lt;!-- handler to save default handlers ?query / ping --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/http_handlers&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-acb1233adf7c1120a677110649007b44>19 - Jemalloc heap profiling</h1><div class=lead>Example of .xml config to enable remote pprof style access</div><h2 id=config>Config</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- cat config.d/jemalloc_dict.xml --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;dictionaries_config&gt;</span>/etc/clickhouse-server/config.d/*_dict.xml<span style=color:#204a87;font-weight:700>&lt;/dictionaries_config&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;http_handlers&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;rule&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;url&gt;</span>/pprof/heap<span style=color:#204a87;font-weight:700>&lt;/url&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;methods&gt;</span>GET,POST<span style=color:#204a87;font-weight:700>&lt;/methods&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;handler&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;type&gt;</span>static<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;response_content&gt;</span>file://jemalloc_clickhouse.heap<span style=color:#204a87;font-weight:700>&lt;/response_content&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/handler&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;rule&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;url&gt;</span>/pprof/cmdline<span style=color:#204a87;font-weight:700>&lt;/url&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;methods&gt;</span>GET<span style=color:#204a87;font-weight:700>&lt;/methods&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;handler&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;type&gt;</span>predefined_query_handler<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;query&gt;</span>SELECT &#39;/var/lib/clickhouse&#39; FORMAT TSVRaw<span style=color:#204a87;font-weight:700>&lt;/query&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/handler&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;rule&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;url&gt;</span>/pprof/symbol<span style=color:#204a87;font-weight:700>&lt;/url&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;methods&gt;</span>GET<span style=color:#204a87;font-weight:700>&lt;/methods&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;handler&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;type&gt;</span>predefined_query_handler<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;query&gt;</span>SELECT &#39;num_symbols: &#39; || count() FROM system.symbols FORMAT TSVRaw SETTINGS allow_introspection_functions = 1<span style=color:#204a87;font-weight:700>&lt;/query&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/handler&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;rule&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;url&gt;</span>/pprof/symbol<span style=color:#204a87;font-weight:700>&lt;/url&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;methods&gt;</span>POST<span style=color:#204a87;font-weight:700>&lt;/methods&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;handler&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;type&gt;</span>predefined_query_handler<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;query&gt;</span>WITH arrayJoin(splitByChar(&#39;+&#39;, {_request_body:String})) as addr SELECT addr || &#39;    &#39; || demangle(addressToSymbol(reinterpretAsUInt64(reverse(substr(unhex(addr),2))))) SETTINGS allow_introspection_functions = 1 FORMAT TSVRaw<span style=color:#204a87;font-weight:700>&lt;/query&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/handler&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;defaults/&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;/http_handlers&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;dictionary&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;name&gt;</span>jemalloc_ls<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;structure&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;key&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;attribute&gt;</span>
</span></span><span style=display:flex><span>					<span style=color:#204a87;font-weight:700>&lt;name&gt;</span>id<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>					<span style=color:#204a87;font-weight:700>&lt;type&gt;</span>String<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;/attribute&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/key&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;attribute&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;name&gt;</span>file<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;type&gt;</span>String<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;null_value</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/attribute&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;attribute&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;name&gt;</span>size<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;type&gt;</span>UInt32<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;null_value</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/attribute&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;attribute&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;name&gt;</span>time<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;type&gt;</span>DateTime<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;null_value</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/attribute&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/structure&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;source&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;executable&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;command&gt;</span>for f in /tmp/jemalloc_clickhouse.*; do [ -f <span style=color:#ce5c00>&amp;quot;</span>$f<span style=color:#ce5c00>&amp;quot;</span> ] || continue; echo -e <span style=color:#ce5c00>&amp;quot;</span>$(basename <span style=color:#ce5c00>&amp;quot;</span>$f<span style=color:#ce5c00>&amp;quot;</span> | cut -d. -f2-3)\t$f\t$(stat -c%s <span style=color:#ce5c00>&amp;quot;</span>$f<span style=color:#ce5c00>&amp;quot;</span>)\t$(stat -c%Y <span style=color:#ce5c00>&amp;quot;</span>$f<span style=color:#ce5c00>&amp;quot;</span>)<span style=color:#ce5c00>&amp;quot;</span>; done<span style=color:#204a87;font-weight:700>&lt;/command&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;execute_direct&gt;</span>false<span style=color:#204a87;font-weight:700>&lt;/execute_direct&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;format&gt;</span>TSV<span style=color:#204a87;font-weight:700>&lt;/format&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/executable&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;layout&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;complex_key_direct/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/layout&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;lifetime&gt;</span>300<span style=color:#204a87;font-weight:700>&lt;/lifetime&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;/dictionary&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;dictionary&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;name&gt;</span>jemalloc_cp<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;structure&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;id&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;name&gt;</span>id<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;type&gt;</span>UInt32<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;attribute&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;name&gt;</span>status<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;type&gt;</span>UInt32<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;null_value</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/attribute&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/structure&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;source&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;executable&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;command&gt;</span>ver=${1:-$(head -n1 | tr -d <span style=color:#ce5c00>&amp;quot;</span>[:space:]<span style=color:#ce5c00>&amp;quot;</span>)}; file=$(ls -t -- /tmp/jemalloc_clickhouse.*.<span style=color:#ce5c00>&amp;quot;</span>$ver<span style=color:#ce5c00>&amp;quot;</span>.heap 2<span style=color:#ce5c00>&amp;gt;</span>/dev/null | head -n1); if [ -n <span style=color:#ce5c00>&amp;quot;</span>$file<span style=color:#ce5c00>&amp;quot;</span> ] <span style=color:#ce5c00>&amp;amp;&amp;amp;</span> cp -- <span style=color:#ce5c00>&amp;quot;</span>$file<span style=color:#ce5c00>&amp;quot;</span> /var/lib/clickhouse/user_files/jemalloc_clickhouse.heap; then printf <span style=color:#ce5c00>&amp;apos;</span>1\t\n<span style=color:#ce5c00>&amp;apos;</span>; else printf <span style=color:#ce5c00>&amp;apos;</span>0\t\n<span style=color:#ce5c00>&amp;apos;</span>; fi<span style=color:#204a87;font-weight:700>&lt;/command&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;execute_direct&gt;</span>false<span style=color:#204a87;font-weight:700>&lt;/execute_direct&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&lt;format&gt;</span>TSV<span style=color:#204a87;font-weight:700>&lt;/format&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;/executable&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;layout&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;direct/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/layout&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;lifetime&gt;</span>300<span style=color:#204a87;font-weight:700>&lt;/lifetime&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;/dictionary&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ curl https://user:password@cluster.env.altinity.cloud:8443/pprof/cmdline
</span></span><span style=display:flex><span>/var/lib/clickhouse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl https://user:password@cluster.env.altinity.cloud:8443/pprof/symbol
</span></span><span style=display:flex><span>num_symbols: <span style=color:#0000cf;font-weight:700>702648</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl -d <span style=color:#4e9a06>&#39;0x0F99B044+0x008512D0&#39;</span> https://user:password@cluster.env.altinity.cloud:8443/pprof/symbol
</span></span><span style=display:flex><span>0x0F99B044    DB::StorageSystemFilesystemCache::getColumnsDescription<span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>0x008512D0    icudt75_dat
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>:)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JEMALLOC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PROFILE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JEMALLOC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PROFILE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>270</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>:)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers_mt</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers_mt</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- 1.00 billion
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>└───────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>585</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>billion</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>151</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>86</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>:)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JEMALLOC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FLUSH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PROFILE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JEMALLOC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FLUSH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PROFILE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Ok</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>272</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>:)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>dictionary</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;jemalloc_ls&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>dictionary</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;jemalloc_ls&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>id</span><span style=color:#a40000>─────┬─</span><span style=color:#000>file</span><span style=color:#a40000>──────────────────────────────┬───</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#a40000>─┬────────────────</span><span style=color:#000>time</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                                   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1970</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>e</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jemalloc_clickhouse</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>heap</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>108004</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2025</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>44</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>e</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jemalloc_clickhouse</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>heap</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>111115</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2025</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>46</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>46</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>e</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jemalloc_clickhouse</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>heap</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>128098</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2025</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>47</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>e</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jemalloc_clickhouse</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>heap</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>123980</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2025</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>e</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jemalloc_clickhouse</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>heap</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>124230</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2025</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>e</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jemalloc_clickhouse</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>heap</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>117733</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2025</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>53</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└────────┴───────────────────────────────────┴────────┴─────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>021</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>:)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dictGet</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;jemalloc_cp&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;status&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dictGet</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;jemalloc_cp&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;status&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>dictGet</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;jem⋯status&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>014</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ jeprof --svg https://user:password@cluster.env.altinity.cloud:8443/pprof/heap &gt; ./mem.svg
</span></span><span style=display:flex><span>Fetching /pprof/heap profile from https://user:password@cluster.env.altinity.cloud:8443/pprof/heap to
</span></span><span style=display:flex><span>  /home/user/jeprof/clickhouse.1756728952.user.pprof.heap
</span></span><span style=display:flex><span>Wrote profile to /home/user/jeprof/clickhouse.1756728952.user.pprof.heap
</span></span><span style=display:flex><span>Dropping nodes with &lt;<span style=color:#ce5c00;font-weight:700>=</span> 90.7 MB<span style=color:#000;font-weight:700>;</span> edges with &lt;<span style=color:#ce5c00;font-weight:700>=</span> 18.1 abs<span style=color:#ce5c00;font-weight:700>(</span>MB<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>:)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dictGet</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;jemalloc_cp&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;status&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dictGet</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;jemalloc_cp&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;status&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>dictGet</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;jem⋯status&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>014</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ jeprof --svg https://user:password@cluster.env.altinity.cloud:8443/pprof/heap --base /home/user/jeprof/clickhouse.1756728952.user.pprof.heap &gt; ./mem_diff.svg
</span></span><span style=display:flex><span>Fetching /pprof/heap profile from https://user:password@cluster.env.altinity.cloud:8443/pprof/heap to
</span></span><span style=display:flex><span>  /home/user/jeprof/clickhouse.1756729237.user.pprof.heap
</span></span><span style=display:flex><span>Wrote profile to /home/user/jeprof/clickhouse.1756729237.user.pprof.heap
</span></span></code></pre></div><pre tabindex=0><code>cluster :) SYSTEM JEMALLOC DISABLE PROFILE;

SYSTEM JEMALLOC DISABLE PROFILE

Ok.

0 rows in set. Elapsed: 0.271 sec.
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-7c6fe7411111212f4a99eb416db8e345>20 - Logging</h1><div class=lead>Logging configuration and issues</div><p>Q. I get errors:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>File not found: /var/log/clickhouse-server/clickhouse-server.log.0.
</span></span><span style=display:flex><span>File not found: /var/log/clickhouse-server/clickhouse-server.log.8.gz.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> File not found: /var/log/clickhouse-server/clickhouse-server.err.log.0, Stack trace <span style=color:#ce5c00;font-weight:700>(</span>when copying this message, always include the lines below<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>0. Poco::FileImpl::handleLastErrorImpl<span style=color:#ce5c00;font-weight:700>(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const<span style=color:#000;font-weight:700>&amp;</span><span style=color:#ce5c00;font-weight:700>)</span> @ 0x11c2b345 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>1. Poco::PurgeOneFileStrategy::purge<span style=color:#ce5c00;font-weight:700>(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const<span style=color:#000;font-weight:700>&amp;</span><span style=color:#ce5c00;font-weight:700>)</span> @ 0x11c84618 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>2. Poco::FileChannel::log<span style=color:#ce5c00;font-weight:700>(</span>Poco::Message const<span style=color:#000;font-weight:700>&amp;</span><span style=color:#ce5c00;font-weight:700>)</span> @ 0x11c314cc in /usr/bin/clickhouse
</span></span><span style=display:flex><span>3. DB::OwnFormattingChannel::logExtended<span style=color:#ce5c00;font-weight:700>(</span>DB::ExtendedLogMessage const<span style=color:#000;font-weight:700>&amp;</span><span style=color:#ce5c00;font-weight:700>)</span> @ 0x8681402 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>4. DB::OwnSplitChannel::logSplit<span style=color:#ce5c00;font-weight:700>(</span>Poco::Message const<span style=color:#000;font-weight:700>&amp;</span><span style=color:#ce5c00;font-weight:700>)</span> @ 0x8682fa8 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>5. DB::OwnSplitChannel::log<span style=color:#ce5c00;font-weight:700>(</span>Poco::Message const<span style=color:#000;font-weight:700>&amp;</span><span style=color:#ce5c00;font-weight:700>)</span> @ 0x8682e41 in /usr/bin/clickhouse
</span></span></code></pre></div><p>A. Check if you have proper permission to a log files folder, and enough disk space (& inode numbers) on the block device used for logging.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls -la /var/log/clickhouse-server/
</span></span><span style=display:flex><span>df -Th
</span></span><span style=display:flex><span>df -Thi
</span></span></code></pre></div><p>Q. How to configure logging in ClickHouse®?</p><p>A. See <a href=https://github.com/ClickHouse/ClickHouse/blob/ceaf6d57b7f00e1925b85754298cf958a278289a/programs/server/config.xml#L9-L62 target=_blank>https://github.com/ClickHouse/ClickHouse/blob/ceaf6d57b7f00e1925b85754298cf958a278289a/programs/server/config.xml#L9-L62</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-51b917d4fd065fa272b7500abbb83250>21 - High Memory Usage During Merge in system.metric_log</h1><div class=lead>Resolving excessive memory consumption during merges in the ClickHouse® system.metric_log table.</div><h2 id=overview>Overview</h2><p>In recent versions of ClickHouse®, the <strong>merge process (part compaction)</strong> in the <code>system.metric_log</code> table can consume a large amount of memory.
The issue arises due to an <strong>unfortunate combination of settings</strong>, where:</p><ul><li>the merge is already large enough to produce <strong>wide parts</strong>,</li><li>but not yet large enough to enable <strong>vertical merges</strong>.</li></ul><p>This problem has become more pronounced in newer ClickHouse® versions because the <code>system.metric_log</code> table has <strong>expanded significantly</strong> — many new metrics were added, increasing the total number of columns.</p><blockquote><p><strong>Wide vs Compact</strong> — storage formats for table parts:</p><ul><li><em>Wide</em> — each column is stored in a separate file (more efficient for large datasets).</li><li><em>Compact</em> — all data is stored in a single file (more efficient for small inserts).</li></ul><p><strong>Horizontal vs Vertical merge</strong> — algorithms for combining data during merges:</p><ul><li><em>Horizontal merge</em> reads and merges all columns at once — meaning all files are opened simultaneously, and buffers are allocated for each column and each part.</li><li><em>Vertical merge</em> processes columns in batches — first merging only columns from <code>ORDER BY</code>, then the rest one by one. This approach <strong>significantly reduces memory usage</strong>.</li></ul></blockquote><p>The most memory-intensive scenario is a <strong>horizontal merge of wide parts</strong> in a table with a large number of columns.</p><hr><h2 id=demonstrating-the-problem>Demonstrating the Problem</h2><p>The issue can be reproduced easily by adjusting a few settings:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric_log</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>MODIFY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_bytes_for_wide_part</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>OPTIMIZE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric_log</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Example log output:</p><pre tabindex=0><code>[c9d66aa9f9d1] 2025.11.10 10:04:59.091067 [97] &lt;Debug&gt; MemoryTracker: Background process (mutate/merge) peak memory usage: 6.00 GiB.
</code></pre><p><strong>The merge consumed 6 GB of memory</strong> — far too much for this table.</p><hr><h2 id=vertical-merges-are-not-affected>Vertical Merges Are Not Affected</h2><p>If you explicitly force vertical merges, memory consumption normalizes, although the process becomes slightly slower:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric_log</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>MODIFY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTING</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>min_bytes_for_wide_part</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>vertical_merge_algorithm_min_rows_to_activate</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>OPTIMIZE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric_log</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Example log output:</p><pre tabindex=0><code>[c9d66aa9f9d1] 2025.11.10 10:06:14.575832 [97] &lt;Debug&gt; MemoryTracker: Background process (mutate/merge) peak memory usage: 13.98 MiB.
</code></pre><p>Now memory usage <strong>drops from 6 GB to only 14 MB</strong>.</p><hr><h2 id=root-cause>Root Cause</h2><p>The problem stems from the fact that:</p><ul><li>the threshold for enabling <em>wide</em> parts is configured in <strong>bytes</strong> (<code>min_bytes_for_wide_part</code>);</li><li>while the threshold for enabling <em>vertical merges</em> is configured in <strong>rows</strong> (<code>vertical_merge_algorithm_min_rows_to_activate</code>).</li></ul><p>When a table contains very <strong>wide rows</strong> (many lightweight columns), this mismatch causes wide parts to appear too early, while vertical merges are triggered much later.</p><hr><h2 id=default-settings>Default Settings</h2><table><thead><tr><th>Parameter</th><th>Value</th></tr></thead><tbody><tr><td><code>vertical_merge_algorithm_min_rows_to_activate</code></td><td>131072</td></tr><tr><td><code>vertical_merge_algorithm_min_bytes_to_activate</code></td><td>0</td></tr><tr><td><code>min_bytes_for_wide_part</code></td><td>10485760 (10 MB)</td></tr><tr><td><code>min_rows_for_wide_part</code></td><td>0</td></tr></tbody></table><p>The average row size in <code>metric_log</code> is approximately <strong>2.8 KB</strong>, meaning wide parts are created after roughly:</p><pre tabindex=0><code>10485760 / 2800 ≈ 3744 rows
</code></pre><p>Meanwhile, the vertical merge algorithm activates only after <strong>131 072 rows</strong> — much later.</p><hr><h2 id=possible-solutions>Possible Solutions</h2><ol><li><p><strong>Increase <code>min_bytes_for_wide_part</code></strong>
For example, set it to at least <code>2800 * 131072 ≈ 350 MB</code>.
This delays the switch to the wide format until vertical merges can also be used.</p></li><li><p><strong>Switch to a row-based threshold</strong>
Use <code>min_rows_for_wide_part</code> instead of <code>min_bytes_for_wide_part</code>.</p></li><li><p><strong>Lower the threshold for vertical merges</strong>
Reduce <code>vertical_merge_algorithm_min_rows_to_activate</code>,
or add a value for <code>vertical_merge_algorithm_min_bytes_to_activate</code>.</p></li></ol><hr><h2 id=example-local-fix-for-metric_log>Example Local Fix for <code>metric_log</code></h2><p>Apply the configuration below, then restart ClickHouse® and drop the <code>metric_log</code> table (so it will be recreated with the updated settings):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;metric_log</span> <span style=color:#c4a000>replace=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;database&gt;</span>system<span style=color:#204a87;font-weight:700>&lt;/database&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;table&gt;</span>metric_log<span style=color:#204a87;font-weight:700>&lt;/table&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;engine&gt;</span>
</span></span><span style=display:flex><span>        ENGINE = MergeTree
</span></span><span style=display:flex><span>        PARTITION BY (event_date)
</span></span><span style=display:flex><span>        ORDER BY (event_time)
</span></span><span style=display:flex><span>        TTL event_date + INTERVAL 14 DAY DELETE
</span></span><span style=display:flex><span>        SETTINGS min_bytes_for_wide_part = 536870912;
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/engine&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;flush_interval_milliseconds&gt;</span>7500<span style=color:#204a87;font-weight:700>&lt;/flush_interval_milliseconds&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/metric_log&gt;</span>
</span></span></code></pre></div><p>This configuration increases the threshold for wide parts to <strong>512 MB</strong>, preventing premature switching to the wide format and reducing memory usage during merges.</p><p>The PR <a href=https://github.com/ClickHouse/ClickHouse/pull/89811 target=_blank>#89811</a>
introduces a similar improvement.</p><hr><h2 id=global-fix-all-tables>Global Fix (All Tables)</h2><p>In addition to <code>metric_log</code>, other tables may also be affected — particularly those with <strong>average row sizes greater than ~80 bytes</strong> and <strong>hundreds of columns</strong>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;merge_tree&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;min_bytes_for_wide_part&gt;</span>0<span style=color:#204a87;font-weight:700>&lt;/min_bytes_for_wide_part&gt;</span>    <span style=color:#8f5902;font-style:italic>&lt;!-- disable size based threshold for wide part --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;min_rows_for_wide_part&gt;</span>131072<span style=color:#204a87;font-weight:700>&lt;/min_rows_for_wide_part&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- use row based instread, same value as vertical_merge_algorithm_min_rows_to_activate --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/merge_tree&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><p>These settings tell ClickHouse® to <strong>keep using compact parts longer</strong>
and to <strong>enable the vertical merge algorithm</strong> simultaneously with the switch to the wide format, preventing sudden spikes in memory usage.</p><p>Caution: the vertical merge directly from compact parts to wide part can be VERY slow.</p><hr><h3 id=-potential-risks-and-trade-offs>⚠️ Potential Risks and Trade-offs</h3><p>Raising <code>min_bytes_for_wide_part</code> globally keeps more data in <strong>compact parts</strong>, which can both help and hurt depending on workload. Compact parts store all columns in a single <code>data.bin</code> file — this makes <strong>inserts much faster</strong>, especially for tables with <strong>many columns</strong>, since fewer files are created per part. It’s also a big advantage when storing data on <strong>S3 or other object storage</strong>, where every extra file adds latency and increases API call counts.</p><p>The trade-off is that this layout makes <strong>reads less efficient</strong> for column-selective queries. Reading one or two columns from a large compact part means scanning and decompressing shared blocks instead of isolated files. It can also reduce cache locality, slightly worsen compression (different columns compressed together), and make <strong>mutations or ALTERs</strong> more expensive because each change rewrites the entire part.</p><p>Lowering thresholds for vertical merges further decreases merge memory but may make the first merges slower, as they process columns sequentially. This configuration works best for <strong>wide, append-only tables</strong> or <strong>S3-based storage</strong>, while analytical tables with frequent updates or narrow schemas may perform better with defaults. If merge memory or S3 request overhead is your main concern, applying it globally is reasonable — otherwise, start with specific wide tables like <code>system.metric_log</code>, verify performance improvements, and expand gradually.</p><p>Additionally the the vertical merge directly from compact parts to wide part can be VERY slow.</p><hr><p>✅ <strong>Summary</strong></p><p>The root issue is a mismatch between byte-based and row-based thresholds for wide parts and vertical merges.
Aligning these values — by adjusting one or both parameters — stabilizes memory usage and prevents excessive RAM consumption during merges in <code>system.metric_log</code> and similar tables.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d380f73c2612b91e3bc35f59f39febe2>22 - Precreate parts using clickhouse-local</h1><div class=lead>Precreate parts using clickhouse-local.</div><h2 id=precreate-parts-using-clickhouse-local>Precreate parts using clickhouse-local</h2><p>the code below were testes on 23.3</p><pre tabindex=0><code>## 1. Imagine we want to process this file:

cat &lt;&lt;EOF &gt; /tmp/data.csv
1,2020-01-01,&#34;String&#34;
2,2020-02-02,&#34;Another string&#34;
3,2020-03-03,&#34;One more string&#34;
4,2020-01-02,&#34;String for first partition&#34;
EOF

rm -rf /tmp/precreate_parts
mkdir -p /tmp/precreate_parts
cd /tmp/precreate_parts

## 2. that is the metadata for the table we want to fill
## schema should match the schema of the table from server
## (the easiest way is just to copy it from the server)

## I&#39;ve added sleepEachRow(0.5) here just to mimic slow insert

clickhouse-local --path=. --query=&#34;CREATE DATABASE local&#34;
clickhouse-local --path=. --query=&#34;CREATE TABLE local.test (id UInt64, d Date, s String, x MATERIALIZED sleepEachRow(0.5)) Engine=MergeTree ORDER BY id PARTITION BY toYYYYMM(d);&#34;

## 3. we can insert the input file into that table in different manners:

## a) just plain insert
cat /tmp/data.csv | clickhouse-local --path=. --query=&#34;INSERT INTO local.test FORMAT CSV&#34;

## b) use File on the top of stdin (allows to tune the types)
clickhouse-local --path=. --query=&#34;CREATE TABLE local.stdin (id UInt64, d Date, s String) Engine=File(CSV, stdin)&#34;
cat /tmp/data.csv | clickhouse-local --path=. --query=&#34;INSERT INTO local.test SELECT * FROM local.stdin&#34;

## c) Instead of stdin you can use file engine 
clickhouse-local --path=. --query &#34;CREATE TABLE local.data_csv (id UInt64, d Date, s String) Engine=File(CSV, &#39;/tmp/data.csv&#39;)&#34;
clickhouse-local --path=. --query &#34;INSERT INTO local.test SELECT * FROM local.data_csv&#34; 

# 4. now we have already parts created
clickhouse-local --path=. --query &#34;SELECT _part,* FROM local.test ORDER BY id&#34;
ls -la data/local/test/

# if needed we can even preprocess them more agressively - by doing OPTIMIZE ON that 
clickhouse-local --path=. --query &#34;OPTIMIZE TABLE local.test FINAL&#34;

# that works, but clickhouse will keep inactive parts (those &#39;unmerged&#39;) in place.
ls -la data/local/test/

# we can use a bit hacky way to force it to remove inactive parts them
clickhouse-local --path=. --query &#34;ALTER TABLE local.test MODIFY SETTING old_parts_lifetime=0, cleanup_delay_period=0, cleanup_delay_period_random_add=0&#34;

## needed to give background threads time to clean inactive parts (max_block_size allows to stop that quickly if needed)
clickhouse-local --path=. --query &#34;SELECT count() FROM numbers(100) WHERE sleepEachRow(0.1) SETTINGS max_block_size=1&#34;

ls -la data/local/test/
clickhouse-local --path=. --query &#34;SELECT _part,* FROM local.test ORDER BY id&#34;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-178be1fa49d7fab0cb9c1deba7df54ca>23 - Recovery after complete data loss</h1><div class=lead>When disaster strikes</div><h2 id=atomic--ordinary-databases>Atomic & Ordinary databases.</h2><p>srv1 &ndash; good replica</p><p>srv2 &ndash; lost replica / we will restore it from srv1</p><h2 id=test-data-3-tables-atomic--ordinary-databases>test data (3 tables (atomic & ordinary databases))</h2><p>srv1</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>testatomic</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>Atomic</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>testatomic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{database}/{table}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toYYYYMM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>D</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>testatomic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>today</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>testordinary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>Ordinary</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>testordinary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{database}/{table}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toYYYYMM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>D</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>testordinary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>today</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{database}/{table}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toYYYYMM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>D</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>today</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=destroy-srv2>destroy srv2</h2><p>srv2</p><pre tabindex=0><code>/etc/init.d/clickhouse-server stop
rm -rf /var/lib/clickhouse/*
</code></pre><h2 id=generate-script-to-re-create-databases-create_databasesql>generate script to re-create databases (create_database.sql).</h2><p>srv1</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>$</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cat</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>home</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>ubuntu</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>generate_schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>sql</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;CREATE DATABASE &#34;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#34; ENGINE = &#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39; COMMENT \&#39;&#39;, comment, &#39;</span><span style=color:#a40000>\</span><span style=color:#4e9a06>&#39;;&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>databases</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;INFORMATION_SCHEMA&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;information_schema&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;system&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>home</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>ubuntu</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>generate_schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>sql</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>create_database</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>sql</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>check the result</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat create_database.sql
</span></span><span style=display:flex><span>CREATE DATABASE <span style=color:#4e9a06>&#34;testatomic&#34;</span> <span style=color:#000>ENGINE</span> <span style=color:#ce5c00;font-weight:700>=</span> Atomic COMMENT <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>CREATE DATABASE <span style=color:#4e9a06>&#34;testordinary&#34;</span> <span style=color:#000>ENGINE</span> <span style=color:#ce5c00;font-weight:700>=</span> Ordinary COMMENT <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><p>transfer this create_database.sql to srv2 (scp / rsync)</p><h2 id=make-a-copy-of-schema-sql-files-metadata_schematar>make a copy of schema sql files (metadata_schema.tar)</h2><p>srv1</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /var/lib/clickhouse/
</span></span><span style=display:flex><span>tar -cvhf /home/ubuntu/metadata_schema.tar metadata
</span></span></code></pre></div><p><code>-h</code> - is important! (-h, &ndash;dereference Follow symlinks; archive and dump the files they point to.)</p><p>transfer this metadata_schema.tar to srv2 (scp / rsync)</p><h2 id=create-databases-at-srv2>create databases at srv2</h2><p>srv2</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/etc/init.d/clickhouse-server start
</span></span><span style=display:flex><span>clickhouse-client &lt; create_database.sql
</span></span><span style=display:flex><span>/etc/init.d/clickhouse-server stop
</span></span></code></pre></div><h2 id=create-tables-at-srv2>create tables at srv2</h2><p>srv2</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /var/lib/clickhouse/
</span></span><span style=display:flex><span>tar xkfv /home/ubuntu/metadata_schema.tar
</span></span><span style=display:flex><span>sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
</span></span><span style=display:flex><span>/etc/init.d/clickhouse-server start
</span></span></code></pre></div><p><code>tar xkfv</code> <code>-k</code> is important! To save folders/symlinks created with create database ( -k, &ndash;keep-old-files Don&rsquo;t replace existing files when extracting )</p><h2 id=check-a-recovery>check a recovery</h2><p>srv2</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>testatomic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>testordinary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-201ba5457615d6a2df6a866dd2a93fcf>24 - Replication: Can not resolve host of another ClickHouse® server</h1><h3 id=symptom>Symptom</h3><p>When configuring Replication the ClickHouse® cluster nodes are experiencing communication issues, and an error message appears in the log that states that the ClickHouse host cannot be resolved.</p><pre tabindex=0><code>&lt;Error&gt; DNSResolver: Cannot resolve host (xxxxx), error 0: DNS error.
 auto DB::StorageReplicatedMergeTree::processQueueEntry(ReplicatedMergeTreeQueue::SelectedEntryPtr)::(anonymous class)::operator()(DB::StorageReplicatedMergeTree::LogEntryPtr &amp;) const: Code: 198. DB::Exception: Not found address of host: xxxx. (DNS_ERROR),
</code></pre><h3 id=cause>Cause:</h3><p>The error message indicates that the host name of the one of the nodes of the cluster cannot be resolved by other cluster members, causing communication issues between the nodes.</p><p>Each node in the replication setup pushes its Fully Qualified Domain Name (FQDN) to Zookeeper, and if other nodes cannot access it using its FQDN, this can cause issues.</p><h3 id=action>Action:</h3><p>There are two possible solutions to this problem:</p><ol><li>Change the FQDN to allow other nodes to access it. This solution can also help to keep the environment more organized. To do this, use the following command to edit the hostname file:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo vim /etc/hostname
</span></span></code></pre></div><p>Or use the following command to change the hostname:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo hostnamectl set-hostname ...
</span></span></code></pre></div><ol start=2><li>Use the configuration parameter <code>&lt;interserver_http_host></code> to specify the IP address or hostname that the nodes can use to communicate with each other. This solution can have some issues, such as the one described in this link: <a href=https://github.com/ClickHouse/ClickHouse/issues/2154 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/2154</a>
.
To configure this parameter, refer to the documentation for more information: <a href=https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#interserver-http-host target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#interserver-http-host</a>
.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-a621d627feb47445d97f056ab85fb1c0>25 - source parts size is greater than the current maximum</h1><div class=lead>source parts size (&mldr;) is greater than the current maximum (&mldr;)</div><h2 id=symptom>Symptom</h2><p>I see messages like: <code>source parts size (...) is greater than the current maximum (...)</code> in the logs and/or inside <code>system.replication_queue</code></p><h2 id=cause>Cause</h2><p>Usually that means that there are already few big merges running.
You can see the running merges using the query:</p><pre tabindex=0><code>SELECT * FROM system.merges
</code></pre><p>That logic is needed to prevent picking a log of huge merges simultaneously
(otherwise they will take all available slots and ClickHouse® will not be
able to do smaller merges, which usually are important for keeping the
number of parts stable).</p><h2 id=action>Action</h2><p>It is normal to see those messages on some stale replicas. And it should be resolved
automatically after some time. So just wait & monitor system.merges &
system.replication_queue tables, it should be resolved by it&rsquo;s own.</p><p>If it happens often or don&rsquo;t resolves by it&rsquo;s own during some longer period of time,
it could be caused by:</p><ol><li>increased insert pressure</li><li>disk issues / high load (it works slow, not enough space etc.)</li><li>high CPU load (not enough CPU power to catch up with merges)</li><li>issue with table schemas leading to high merges pressure (high / increased number of tables / partitions / etc.)</li></ol><p>Start from checking dmesg / system journals / ClickHouse monitoring to find the anomalies.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-598152e68b617d22b315a15725d3db6c>26 - Successful ClickHouse® deployment plan</h1><div class=lead>Successful ClickHouse® deployment plan</div><h2 id=successful-clickhouse-deployment-plan>Successful ClickHouse® deployment plan</h2><h3 id=stage-0-build-poc>Stage 0. Build POC</h3><ol><li>Install single node ClickHouse<ul><li><a href=https://clickhouse.com/docs/en/getting-started/tutorial/ target=_blank rel=nofollow>https://clickhouse.com/docs/en/getting-started/tutorial/</a></li><li><a href=https://clickhouse.com/docs/en/getting-started/install/ target=_blank rel=nofollow>https://clickhouse.com/docs/en/getting-started/install/</a></li><li><a href=https://docs.altinity.com/altinitystablebuilds/stablequickstartguide/ target=_blank>https://docs.altinity.com/altinitystablebuilds/stablequickstartguide/</a></li></ul></li><li>Start with creating a single table (the biggest one), use MergeTree engine. Create &lsquo;some&rsquo; schema (most probably it will be far from optimal). Prefer denormalized approach for all immutable dimensions, for mutable dimensions - consider dictionaries.</li><li>Load some amount of data (at least 5 Gb, and 10 mln rows) - preferable the real one, or as close to real as possible. Usually the simplest options are either through CSV / TSV files (or <code>insert into clickhouse_table select * FROM mysql(...) where ...</code>)</li><li>Create several representative queries.</li><li>Check the columns cardinality, and appropriate types, use minimal needed type</li><li>Review the partition by and order by. <a href=https://kb.altinity.com/engines/mergetree-table-engine-family/pick-keys/ target=_blank>https://kb.altinity.com/engines/mergetree-table-engine-family/pick-keys/</a></li><li>Create the schema(s) with better/promising order by / partitioning, load data in. Pick the best schema.</li><li>consider different improvements of particular columns (codecs / better data types etc.) <a href=https://kb.altinity.com/altinity-kb-schema-design/codecs/altinity-kb-how-to-test-different-compression-codecs/ target=_blank>https://kb.altinity.com/altinity-kb-schema-design/codecs/altinity-kb-how-to-test-different-compression-codecs/</a></li><li>If the performance of certain queries is not enough - consider using PREWHERE / skipping indexes</li><li>Repeat 2-9 for next big table(s). Avoid scenarios when you need to join big tables.</li><li>Pick the clients library for you programming language (the most mature are python / golang / java / c++), build some pipeline - for inserts (low QPS, lot of rows in singe insert, check acknowledgements & retry the same block on failures), ETLs if needed, some reporting layer (<a href=https://kb.altinity.com/altinity-kb-integrations/bi-tools/ target=_blank>https://kb.altinity.com/altinity-kb-integrations/bi-tools/</a>
) </li></ol><h3 id=stage-1-planning-the-production-setup>Stage 1. Planning the production setup</h3><ol><li>Collect more data / estimate insert speed, estimate the column sizes per day / month.</li><li>Measure the speed of queries</li><li>Consider improvement using materialized views / projections / dictionaries.</li><li>Collect requirements (ha / number of simultaneous queries / insert pressure / &rsquo;exactly once&rsquo; etc)</li><li>Do a cluster sizing estimation, plan the hardware <ul><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/hardware-requirements/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/hardware-requirements/</a></li><li><a href=https://blog.cloudflare.com/clickhouse-capacity-estimation-framework/ target=_blank>https://blog.cloudflare.com/clickhouse-capacity-estimation-framework/</a></li></ul></li><li>plan the network, if needed - consider using LoadBalancers etc.<ul><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/network-configuration/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/network-configuration/</a></li></ul></li><li>If you need sharding - consider different sharding approaches.</li></ol><h3 id=stage-2-preprod-setup--development>Stage 2. Preprod setup & development</h3><ol><li>Install ClickHouse in cluster - several nodes / VMs + zookeeper<ul><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/cluster-configuration-process/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/cluster-production-configuration-guide/cluster-configuration-process/</a></li><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/altinity-kb-proper-setup/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/altinity-kb-proper-setup/</a></li><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/</a></li></ul></li><li>Create good config & automate config / os / restarts (ansible / puppet etc)<ul><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-settings-to-adjust/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-settings-to-adjust/</a></li><li>for docker: <a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-clickhouse-in-docker/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-clickhouse-in-docker/</a></li><li>for k8s, use the Altinity Kubernetes Operator for ClickHouse OR <a href=https://kb.altinity.com/altinity-kb-kubernetes/altinity-kb-possible-issues-with-running-clickhouse-in-k8s/ target=_blank>https://kb.altinity.com/altinity-kb-kubernetes/altinity-kb-possible-issues-with-running-clickhouse-in-k8s/</a></li></ul></li><li>Set up monitoring / log processing / alerts etc.<ul><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-monitoring/#build-your-own-monitoring target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-monitoring/#build-your-own-monitoring</a></li></ul></li><li>Set up users.<ul><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/rbac/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/rbac/</a></li></ul></li><li>Think of schema management. Deploy the schema.<ul><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/schema-migration-tools/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/schema-migration-tools/</a></li></ul></li><li>Design backup / failover strategies:<ul><li><a href=https://clickhouse.com/docs/en/operations/backup/ target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/backup/</a></li><li><a href=https://github.com/Altinity/clickhouse-backup target=_blank>https://github.com/Altinity/clickhouse-backup</a></li></ul></li><li>Develop pipelines / queries, create test suite, CI/CD</li><li>Do benchmark / stress tests</li><li>Test configuration changes / server restarts / failovers / version upgrades</li><li>Review the security topics (tls, limits / restrictions, network, passwords)</li><li>Document the solution for operations</li></ol><h3 id=stage-3-production-setup>Stage 3. Production setup</h3><ol><li>Deploy the production setup (consider also canary / blue-greed deployments etc)</li><li>Schedule ClickHouse upgrades every 6 to 12 months (if possible)</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-3ace1f73ef71bda112e1d794cc271c40>27 - sysall database (system tables on a cluster level)</h1><div class=lead>sysall database (system tables on a cluster level)</div><h2 id=requirements>Requirements</h2><p>The idea is that you have a macros <code>cluster</code> with cluster name.</p><p>For example you have a cluster named <code>production</code> and this cluster includes all ClickHouse® nodes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/clusters.xml
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;remote_servers&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;production&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>And you need to have a macro <code>cluster</code> set to <code>production</code>:</p><pre tabindex=0><code>cat /etc/clickhouse-server/config.d/macros.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;yandex&gt;
    &lt;macros&gt;
        &lt;cluster&gt;production&lt;/cluster&gt;
        &lt;replica&gt;....&lt;/replica&gt;
        ....
    &lt;/macros&gt;
&lt;/yandex&gt;
</code></pre><p>Now you should be able to query all nodes using <code>clusterAllReplicas</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>materialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uptime</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uptime</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>one</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>─┬─</span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>──────────────┬──</span><span style=color:#000>uptime</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chhost1</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chhost1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>localdomain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1071574</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chhost2</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chhost2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>localdomain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1071517</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└────────────┴─────────────────────┴─────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><code>skip_unavailable_shards</code> is necessary to query a system with some nodes are down.</p><h2 id=script-to-create-db-objects>Script to create DB objects</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>clickhouse-client -q <span style=color:#4e9a06>&#39;show tables from system&#39;</span>&gt; list
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#4e9a06>`</span>cat list<span style=color:#4e9a06>`</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;CREATE OR REPLACE VIEW sysall.&#34;</span><span style=color:#000>$i</span><span style=color:#4e9a06>&#34; as select hostName() nodeHost, FQDN() nodeFQDN, * from clusterAllReplicas(&#39;{cluster}&#39;, system.&#34;</span><span style=color:#000>$i</span><span style=color:#4e9a06>&#34;) SETTINGS skip_unavailable_shards = 1;&#34;</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cluster_state</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>shard_num</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>replica_num</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>host_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>host_address</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>port</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>errors_count</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>uptime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uptime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;UP&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;DOWN&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>node_state</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clusters</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LEFT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>replaceRegexpOne</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;-(\d+)-0$&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;-\1&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>host_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- remove trailing 0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>fqdn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>materialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uptime</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uptime</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>one</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hosts_info</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>host_name</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>getMacro</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;cluster&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_inserts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_inserts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_metrics</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>backups</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>backups</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clusters</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clusters</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>columns</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>columns</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>current_roles</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>current_roles</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>data_skipping_indices</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>data_skipping_indices</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>databases</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>databases</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>detached_parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>detached_parts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dictionaries</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dictionaries</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disks</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disks</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>distributed_ddl_queue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>distributed_ddl_queue</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>distribution_queue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>distribution_queue</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dropped_tables</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dropped_tables</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>enabled_roles</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>enabled_roles</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>errors</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>errors</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>events</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>events</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>filesystem_cache</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>filesystem_cache</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>grants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>grants</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>jemalloc_bins</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>jemalloc_bins</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>macros</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>macros</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>merge_tree_settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>merge_tree_settings</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>merges</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>merges</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>moves</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>moves</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutations</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutations</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>named_collections</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>named_collections</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts_columns</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts_columns</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>privileges</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>privileges</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>processes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>processes</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>projection_parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>projection_parts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>projection_parts_columns</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>projection_parts_columns</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_cache</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_cache</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_log</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_log</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>quota_limits</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>quota_limits</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>quota_usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>quota_usage</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>quotas</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>quotas</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>quotas_usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>quotas_usage</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicas</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicas</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicated_fetches</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicated_fetches</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicated_merge_tree_settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicated_merge_tree_settings</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replication_queue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replication_queue</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>role_grants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>role_grants</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>roles</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>roles</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>row_policies</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>row_policies</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>server_settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>server_settings</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settings</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settings_profile_elements</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settings_profile_elements</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settings_profiles</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settings_profiles</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>storage_policies</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>storage_policies</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tables</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tables</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_directories</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_directories</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_processes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_processes</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>users</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>users</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>warnings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>warnings</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper_connection</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeHost</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper_connection</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=some-examples>Some examples</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cluster_state</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>shard_num</span><span style=color:#a40000>─┬─</span><span style=color:#000>replica_num</span><span style=color:#a40000>─┬─</span><span style=color:#000>host_name</span><span style=color:#a40000>───────────┬─</span><span style=color:#000>host_address</span><span style=color:#a40000>─┬─</span><span style=color:#000>port</span><span style=color:#a40000>─┬─</span><span style=color:#000>errors_count</span><span style=color:#a40000>─┬──</span><span style=color:#000>uptime</span><span style=color:#a40000>─┬─</span><span style=color:#000>node_state</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chhost1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>localdomain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>253</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>86</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1071788</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UP</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chhost2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>localdomain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>253</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>215</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1071731</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UP</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chhost3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>localdomain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>252</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>83</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9999</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DOWN</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┴─────────────┴─────────────────────┴──────────────┴──────┴──────────────┴─────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>nodeFQDN</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>path</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>free_space</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>free</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>total_space</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>total</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sysall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disks</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>nodeFQDN</span><span style=color:#a40000>────────────┬─</span><span style=color:#000>path</span><span style=color:#a40000>─────────────────┬─</span><span style=color:#204a87;font-weight:700>free</span><span style=color:#a40000>───────┬─</span><span style=color:#000>total</span><span style=color:#a40000>──────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chhost1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>localdomain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>511</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>937</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>54</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chhost2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>localdomain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>495</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>77</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>937</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>54</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────────┴──────────────────────┴────────────┴────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-36bd996bf58568ac32e55cbc1970dce1>28 - Timeouts during OPTIMIZE FINAL</h1><div class=lead><code>Timeout exceeded ...</code> or <code>executing longer than distributed_ddl_task_timeout</code> during <code>OPTIMIZE FINAL</code>.</div><h2 id=timeout-exceeded--or-executing-longer-than-distributed_ddl_task_timeout--during-optimize-final><code>Timeout exceeded ...</code> or <code>executing longer than distributed_ddl_task_timeout</code> during <code>OPTIMIZE FINAL</code></h2><p>Timeout may occur</p><ol><li><p>due to the fact that the client reach timeout interval.</p><ul><li>in case of TCP / native clients - you can change send_timeout / receive_timeout + tcp_keep_alive_timeout + driver timeout settings</li><li>in case of HTTP clients - you can change http_send_timeout / http_receive_timeout + tcp_keep_alive_timeout + driver timeout settings</li></ul></li><li><p>(in the case of ON CLUSTER queries) due to the fact that the timeout for query execution by shards ends</p><ul><li>see setting <code>distributed_ddl_task_timeout</code></li></ul></li></ol><p>In the first case you additionally may get the misleading messages: <code>Cancelling query. ... Query was cancelled.</code></p><p>In both cases, this does NOT stop the execution of the OPTIMIZE command. It continues to work even after
the client is disconnected. You can see the progress of that in <code>system.processes</code> / <code>show processlist</code> / <code>system.merges</code> / <code>system.query_log</code>.</p><p>The same applies to queries like:</p><ul><li><code>INSERT ... SELECT</code></li><li><code>CREATE TABLE ... AS SELECT</code></li><li><code>CREATE MATERIALIZED VIEW ... POPULATE ...</code></li></ul><p>It is possible to run a query with some special <code>query_id</code> and then poll the status from the processlist (in the case of a cluster, it can be a bit more complicated).</p><p>See also</p><ul><li><a href=https://github.com/ClickHouse/ClickHouse/issues/6093 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/6093</a></li><li><a href=https://github.com/ClickHouse/ClickHouse/issues/7794 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/7794</a></li><li><a href=https://github.com/ClickHouse/ClickHouse/issues/28896 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/28896</a></li><li><a href=https://github.com/ClickHouse/ClickHouse/issues/19319 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/19319</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-61617b049d0115dc2404f965ada72153>29 - Use an executable dictionary as cron task</h1><div class=lead>If you need to execute scheduled tasks, you can use an executable dictionary like it was a cron task.</div><h3 id=rationale>Rationale</h3><p>Imagine that we need to restart clickhouse-server every saturday at 10:00 AM. We can use an executable dictionary to do this. Here is the approach and code necessary to do this. It can be used for other operations like INSERT into tables or execute some other imaginative tasks that need an scheduled execution.</p><p>Let&rsquo;s create a simple table to register all the restarts scheduled by this dictionary:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>restart_table</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>restart_datetime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TinyLog</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=configuration>Configuration</h3><p>This is the ClickHouse configuration file we will be using for executable dictionaries. The dictionary is a dummy one (ignore the format and other stuff, we need format in the dict definition because if not it will fail loading), we don’t need it to do anything, just execute a script that has all the logic. The scheduled time is defined in the LIFETIME property of the dictionary (every 5 minutes dictionary will be refreshed and subsequently the script executed). Also for this case we need to load it on startup time setting lazy loading of dicts to false.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- cat restart_dict.xml --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;dictionaries_config&gt;</span>/etc/clickhouse-server/config.d/*_dict.xml<span style=color:#204a87;font-weight:700>&lt;/dictionaries_config&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;dictionaries_lazy_load&gt;</span>false<span style=color:#204a87;font-weight:700>&lt;/dictionaries_lazy_load&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;dictionary&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;name&gt;</span>restart_dict<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;structure&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;name&gt;</span>restart_id<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;type&gt;</span>UInt64<span style=color:#204a87;font-weight:700>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/structure&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;source&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;executable&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;command&gt;</span>restart_dict.sh<span style=color:#204a87;font-weight:700>&lt;/command&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;execute_direct&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/execute_direct&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;format&gt;</span>CSV<span style=color:#204a87;font-weight:700>&lt;/format&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/executable&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;layout&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;flat/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/layout&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;lifetime&gt;</span>300<span style=color:#204a87;font-weight:700>&lt;/lifetime&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/dictionary&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><h3 id=action>Action</h3><p>Now the restart logic (which can be different for other needs). In this case it will do nothing until the restart windows comes. During the restart window, we check if there has been a restart in the same window timeframe (if window is an hour the condition should be 1h). The script will issue a <code>SYSTEM SHUTDOWN</code> command to restart the server. The script will also insert a record in the restart_table to register the restart time.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#000>CLICKHOUSE_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;admin&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>CLICKHOUSE_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;xxxxxxxxx&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check if today is Saturday and the time is 10:00 AM CET or later</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Get current day of week (1-7, where 7 is Sunday)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># reload time for dict is 300 secs / 10 mins</span>
</span></span><span style=display:flex><span><span style=color:#000>current_day</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>date +%u<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Get current time in hours and minutes</span>
</span></span><span style=display:flex><span><span style=color:#000>current_time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>date +%H%M<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check if today is Saturday (6) and the time is between 10:00 AM and 11:00 AM</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#000>$current_day</span> -eq <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>$current_time</span> -ge <span style=color:#0000cf;font-weight:700>1000</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>$current_time</span> -lt <span style=color:#0000cf;font-weight:700>1100</span> <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Get current date and time as timestamp</span>
</span></span><span style=display:flex><span>    <span style=color:#000>current_timestamp</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>date +%s<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>last_restart_timestamp</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>clickhouse-client --user <span style=color:#000>$CLICKHOUSE_USER</span> --password <span style=color:#000>$CLICKHOUSE_PASSWORD</span> --query <span style=color:#4e9a06>&#34;SELECT max(toUnixTimestamp(restart_datetime)) FROM restart_table&#34;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Check if the last restart timestamp is within last hour, if not then restart</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#204a87;font-weight:700>$((</span> current_timestamp <span style=color:#ce5c00;font-weight:700>-</span> last_restart_timestamp <span style=color:#204a87;font-weight:700>))</span> -ge <span style=color:#0000cf;font-weight:700>3600</span> <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># Push data to log table and restart</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#000>$current_timestamp</span> <span style=color:#000;font-weight:700>|</span> clickhouse-client --user <span style=color:#000>$CLICKHOUSE_USER</span> --password <span style=color:#000>$CLICKHOUSE_PASSWORD</span> --query <span style=color:#4e9a06>&#34;INSERT INTO restart_table FORMAT TSVRaw&#34;</span>
</span></span><span style=display:flex><span>        clickhouse-client --user <span style=color:#000>$CLICKHOUSE_USER</span> --password <span style=color:#000>$CLICKHOUSE_PASSWORD</span> --query <span style=color:#4e9a06>&#34;SYSTEM SHUTDOWN&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span></code></pre></div><h3 id=improvements>Improvements</h3><p>If the dictionary has a high frecuency refresh time, then clickhouse could end up executing that script multiple times using a lot of resources and creating processes that can look like &lsquo;stuck&rsquo; ones.
To overcome this we can use the executable pool setting: <a href=https://clickhouse.com/docs/sql-reference/dictionaries#executable-pool target=_blank rel=nofollow>https://clickhouse.com/docs/sql-reference/dictionaries#executable-pool</a></p><p>Executable pool will spawn a pool of processes (similar as a pool of connections) with the specified command and keep them running until they exit, which is useful for heavy scripts/python and reduces the initialization impact of those on clickhouse.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bdd41222cb6666cd88673471ac35bde8>30 - Useful settings to turn on/Defaults that should be reconsidered</h1><div class=lead>Useful settings to turn on.</div><h2 id=useful-settings-to-turn-ondefaults-that-should-be-reconsidered>Useful settings to turn on/Defaults that should be reconsidered</h2><p>Some setting that are not enabled by default.</p><ul><li><a href=https://clickhouse.com/docs/operations/settings/merge-tree-settings#ttl_only_drop_parts target=_blank rel=nofollow>ttl_only_drop_parts</a></li></ul><p>Enables or disables complete dropping of data parts where all rows are expired in MergeTree tables.</p><p>When ttl_only_drop_parts is disabled (by default), the ClickHouse® server only deletes expired rows according to their TTL.</p><p>When ttl_only_drop_parts is enabled, the ClickHouse server drops a whole part when all rows in it are expired.</p><p>Dropping whole parts instead of partial cleaning TTL-d rows allows having shorter merge_with_ttl_timeout times and lower impact on system performance.</p><ul><li><a href=https://clickhouse.com/docs/en/operations/settings/settings/#join_use_nulls target=_blank rel=nofollow>join_use_nulls</a></li></ul><p>Might be you not expect that join will be filled with default values for missing columns (instead of classic NULLs) during JOIN.</p><p>Sets the type of JOIN behaviour. When merging tables, empty cells may appear. ClickHouse fills them differently based on this setting.</p><p>Possible values:</p><p>0 — The empty cells are filled with the default value of the corresponding field type.
1 — JOIN behaves the same way as in standard SQL. The type of the corresponding field is converted to Nullable, and empty cells are filled with NULL.</p><ul><li><a href=https://clickhouse.com/docs/en/operations/settings/settings/#aggregate_functions_null_for_empty target=_blank rel=nofollow>aggregate_functions_null_for_empty</a></li></ul><p>Default behaviour is not compatible with ANSI SQL (ClickHouse avoids Nullable types by performance reasons)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>avg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>avg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>nan</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└────────┴────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregate_functions_null_for_empty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>avg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>sumOrNull</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┬─</span><span style=color:#000>avgOrNull</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#a40000>ᴺᵁᴸᴸ</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#a40000>ᴺᵁᴸᴸ</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────┴──────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-31af424ed53bcf5281bdfaa78ab9a1ed>31 - Who ate my CPU</h1><div class=lead>Queries to find which subsytem of ClickHouse® is using the most of CPU.</div><h2 id=merges>Merges</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>((</span><span style=color:#000>elapsed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>progress</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>elapsed</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>estimate</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>elapsed</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>progress</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>is_mutation</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>total_size_bytes_compressed</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>memory_usage</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mem</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>merges</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>elapsed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=mutations>Mutations</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>substr</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>command</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts_to_do</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>parts_to_do</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>anyIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>latest_fail_reason</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>latest_fail_reason</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutations</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>is_done</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>command</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=current-processes>Current Processes</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>elapsed</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>processes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>is_initial_query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>elapsed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=processes-retrospectively>Processes retrospectively</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>normalizedQueryHash</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hash</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>current_database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ProfileEvents</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;UserTimeMicroseconds&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>userCPUq</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>userCPUms</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>query_duration_ms</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query_duration_ms</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>userCPUms</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>query_duration_ms</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cpu_per_sec</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>userCPUq</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>heaviest_query</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_log</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_date</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>today</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>current_database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>hash</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>userCPUms</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Vertical</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-3c882b894707a1546ab5cd4e5a238a68>32 - Zookeeper session has expired</h1><div class=lead>Zookeeper session has expired</div><blockquote><p><strong>Q. I get &ldquo;Zookeeper session has expired&rdquo; once. What should i do? Should I worry?</strong></p></blockquote><p>Getting exceptions or lack of acknowledgement in distributed system from time to time is a normal situation.
Your client should do the retry. If that happened once and your client do retries correctly - nothing to worry about.</p><p>It it happens often, or with every retry - it may be a sign of some misconfiguration / issue in cluster (see below).</p><blockquote><p><strong>Q. we see a lot of these: Zookeeper session has expired. Switching to a new session</strong></p></blockquote><p>A. There is a single Zookeeper session per server. But there are many threads that can use Zookeeper simultaneously.
So the same event (we lose the single Zookeeper session we had), will be reported by all the threads/queries which were using that Zookeeper session.</p><p>Usually after loosing the Zookeeper session that exception is printed by all the thread which watch Zookeeper replication queues, and all the threads which had some in-flight Zookeeper operations (for example inserts, <code>ON CLUSTER</code> commands etc).</p><p>If you see a lot of those simultaneously - that just means you have a lot of threads talking to Zookeeper simultaneously (or may be you have many replicated tables?).</p><p>BTW: every Replicated table comes with its own cost, so you <a href=/altinity-kb-schema-design/how-much-is-too-much/#number-of-tables-system-wide-across-all-databases>can&amp;rsquo;t scale the number of replicated tables indefinitely</a>
.</p><p>Typically after several hundreds (sometimes thousands) of replicated tables, the ClickHouse® server becomes unusable: it can&rsquo;t do any other work, but only keeping replication housekeeping tasks. &lsquo;ClickHouse-way&rsquo; is to have a few (maybe dozens) of very huge tables instead of having thousands of tiny tables. (Side note: the number of not-replicated tables can be scaled much better).</p><p>So again if during short period of time you see lot of those exceptions and that don&rsquo;t happen anymore for a while - nothing to worry about. Just ensure your client is doing retries properly.</p><blockquote><p><strong>Q. We are wondering what is causing that session to &ldquo;timeout&rdquo; as the default looks like 30 seconds, and there&rsquo;s certainly stuff happening much more frequently than every 30 seconds.</strong></p></blockquote><p>Typically that has nothing with an expiration/timeout - even if you do nothing there are heartbeat events in the Zookeeper protocol.</p><p>So internally inside ClickHouse:</p><ol><li>we have a &lsquo;zookeeper client&rsquo; which in practice is a single Zookeeper connection (TCP socket), with 2 threads - one serving reads, the seconds serving writes, and some API around.</li><li>while everything is ok Zookeeper client keeps a single logical &lsquo;zookeeper session&rsquo; (also by sending heartbeats etc).</li><li>we may have hundreds of &lsquo;users&rsquo; of that Zookeeper client - those are threads that do some housekeeping, serve queries etc.</li><li>Zookeeper client normally have dozen &lsquo;in-flight&rsquo; requests (asked by different threads). And if something bad happens with that
(disconnect, some issue with Zookeeper server, some other failure), Zookeeper client needs to re-establish the connection and switch to the new session
so all those &lsquo;in-flight&rsquo; requests will be terminated with a &lsquo;session expired&rsquo; exception.</li></ol><blockquote><p><strong>Q. That problem happens very often (all the time, every X minutes / hours / days).</strong></p></blockquote><p>Sometimes the real issue can be visible somewhere close to the first &lsquo;session expired&rsquo; exception in the log. (i.e. Zookeeper client thread can
know & print to logs the real reason, while all &lsquo;user&rsquo; threads just get &lsquo;session expired&rsquo;).</p><p>Also Zookeeper logs may ofter have a clue to that was the real problem.</p><p>Known issues which can lead to session termination by Zookeeper:</p><ol><li>connectivity / network issues.</li><li><code>jute.maxbuffer</code> overrun. If you need to pass too much data in a single Zookeeper transaction. (often happens if you need to do ALTER table UPDATE or other mutation on the table with big number of parts). The fix is adjusting JVM setting: -Djute.maxbuffer=8388608. See <a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/jvm-sizes-and-garbage-collector-settings/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/jvm-sizes-and-garbage-collector-settings/</a></li><li>XID overflow. XID is a transaction counter in Zookeeper, if you do too many transactions the counter reaches maxint32, and to restart the counter Zookeeper closes all the connections. Usually, that happens rarely, and is not avoidable in Zookeeper (well in clickhouse-keeper that problem solved). There are some corner cases / some schemas which may end up with that XID overflow happening quite often. (a worst case we saw was once per 3 weeks).</li></ol><blockquote><p><strong>Q. &ldquo;Zookeeper session has expired&rdquo; happens every time I try to start the mutation / do other ALTER on Replicated table.</strong></p></blockquote><p>During ALTERing replicated table ClickHouse need to create a record in Zookeeper listing all the parts which should be mutated (that usually means = list names of all parts of the table). If the size of list of parts exceeds maximum buffer size - Zookeeper drops the connection.</p><p>Parts name length can be different for different tables. In average with default <code>jute.maxbuffer</code> (1Mb) mutations start to fail for tables which have more than 5000 parts.</p><p>Solutions:</p><ol><li>rethink partitioning, high number of parts in table is usually <a href=https://kb.altinity.com/altinity-kb-schema-design/how-much-is-too-much/#number-of-parts--partitions-system-wide-across-all-databases target=_blank>not recommended</a></li><li>increase <code>jute.maxbuffer</code> on Zookeeper side <a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/jvm-sizes-and-garbage-collector-settings/ target=_blank>to values about 8M</a></li><li>use IN PARTITION clause for mutations (where applicable) - since <a href=https://github.com/ClickHouse/ClickHouse/pull/13403 target=_blank>20.12</a></li><li>switch to clickhouse-keeper</li></ol><blockquote><p><strong>Q. &ldquo;Zookeeper session has expired and also Operation timeout&rdquo; happens when reading blocks from Zookeeper</strong>:</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2024.02.22 07:20:39.222171 <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#0000cf;font-weight:700>1047</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{}</span> &lt;Error&gt; ZooKeeperClient: Code: 999. Coordination::Exception: Operation timeout <span style=color:#ce5c00;font-weight:700>(</span>no response<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>for</span> request List <span style=color:#204a87;font-weight:700>for</span> path: 
</span></span><span style=display:flex><span>/clickhouse/tables/github_events/block_numbers/20240205105000 <span style=color:#ce5c00;font-weight:700>(</span>Operation timeout<span style=color:#ce5c00;font-weight:700>)</span>. <span style=color:#ce5c00;font-weight:700>(</span>KEEPER_EXCEPTION<span style=color:#ce5c00;font-weight:700>)</span>, 
</span></span><span style=display:flex><span>2024.02.22 07:20:39.223293 <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#0000cf;font-weight:700>246</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{}</span> &lt;Error&gt; default.github_events : void DB::StorageReplicatedMergeTree::mergeSelectingTask<span style=color:#ce5c00;font-weight:700>()</span>: 
</span></span><span style=display:flex><span>Code: 999. Coordination::Exception: /clickhouse/tables/github_events/block_numbers/20240205105000 <span style=color:#ce5c00;font-weight:700>(</span>Connection loss<span style=color:#ce5c00;font-weight:700>)</span>. 
</span></span></code></pre></div><p>Sometimes these <code>Session expired</code> and <code>operation timeout</code> are common, because of merges that read all the blocks in Zookeeper for a table and if there are many blocks (and partitions) read time can be longer than the 10 secs default <a href=https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings#server-settings_zookeeper target=_blank rel=nofollow>operation timeout</a>
.
When dropping a partition, ClickHouse never drops old block numbers from Zookeeper, so the list grows indefinitely. It is done as a precaution against race between DROP PARTITION and INSERT. It is safe to clean those old blocks manually</p><p>This is being addressed in <strong><a href=https://github.com/ClickHouse/ClickHouse/pull/59507 target=_blank>#59507 Add &lt;code>FORGET PARTITION&lt;/code> query to remove old partition nodes from</a></strong></p><p>Solutions:
Manually remove old/forgotten blocks <a href=https://kb.altinity.com/altinity-kb-useful-queries/remove_unneeded_block_numbers/ target=_blank>https://kb.altinity.com/altinity-kb-useful-queries/remove_unneeded_block_numbers/</a></p><p>Related issues:</p><ul><li><a href=https://github.com/ClickHouse/ClickHouse/issues/16307 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/16307</a></li><li><a href=https://github.com/ClickHouse/ClickHouse/issues/11933 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/11933</a></li><li><a href=https://github.com/ClickHouse/ClickHouse/issues/32646 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/32646</a></li><li><a href=https://github.com/ClickHouse/ClickHouse/issues/15882 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/15882</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ef428242bace20ed80fc2a5a94cbc2e1>33 - Server configuration files</h1><div class=lead>How to organize configuration files in ClickHouse® and how to manage changes</div><h2 id=сonfig-management-recommended-structure>Сonfig management (recommended structure)</h2><p>ClickHouse® server config consists of two parts server settings (config.xml) and users settings (users.xml).</p><p>By default they are stored in the folder <strong>/etc/clickhouse-server/</strong> in two files config.xml & users.xml.</p><p>We suggest never change vendor config files and place your changes into separate .xml files in sub-folders. This way is easier to maintain and ease ClickHouse upgrades.</p><p><strong>/etc/clickhouse-server/users.d</strong> – sub-folder for <a href=/altinity-kb-setup-and-maintenance/rbac/>user settings</a>
(derived from <code>users.xml</code> filename).</p><p><strong>/etc/clickhouse-server/config.d</strong> – sub-folder for server settings (derived from <code>config.xml</code> filename).</p><p><strong>/etc/clickhouse-server/conf.d</strong> – sub-folder for any (both) settings.</p><p>If the root config (xml or yaml) has a different name, such as <code>keeper_config.xml</code> or <code>config_instance_66.xml</code>, then the <code>keeper_config.d</code> and <code>config_instance_66.d</code> folders will be used. But <code>conf.d</code> is always used and processed last.</p><p>File names of your xml files can be arbitrary but they are applied in alphabetical order.</p><p>Examples:</p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/config.d/listen_host.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;clickhouse&gt;
  &lt;listen_host&gt;::&lt;/listen_host&gt;
&lt;/clickhouse&gt;


$ cat /etc/clickhouse-server/config.d/macros.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;clickhouse&gt;
  &lt;macros&gt;
    &lt;cluster&gt;test&lt;/cluster&gt;
    &lt;replica&gt;host22&lt;/replica&gt;
    &lt;shard&gt;0&lt;/shard&gt;
    &lt;server_id&gt;41295&lt;/server_id&gt;
    &lt;server_name&gt;host22.server.com&lt;/server_name&gt;
  &lt;/macros&gt;
&lt;/clickhouse&gt;

cat /etc/clickhouse-server/config.d/zoo.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;clickhouse&gt;
  &lt;zookeeper&gt;
    &lt;node&gt;
      &lt;host&gt;localhost&lt;/host&gt;
      &lt;port&gt;2181&lt;/port&gt;
    &lt;/node&gt;
  &lt;/zookeeper&gt;
  &lt;distributed_ddl&gt;
    &lt;path&gt;/clickhouse/test/task_queue/ddl&lt;/path&gt;
  &lt;/distributed_ddl&gt;
&lt;/clickhouse&gt;

cat /etc/clickhouse-server/users.d/enable_access_management_for_user_default.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;clickhouse&gt;
  &lt;users&gt;
    &lt;default&gt;
      &lt;access_management&gt;1&lt;/access_management&gt;
    &lt;/default&gt;
  &lt;/users&gt;
&lt;/clickhouse&gt;

cat /etc/clickhouse-server/users.d/memory_usage.xml
&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;clickhouse&gt;
    &lt;profiles&gt;
        &lt;default&gt;
            &lt;max_bytes_before_external_group_by&gt;25290221568&lt;/max_bytes_before_external_group_by&gt;
            &lt;max_memory_usage&gt;50580443136&lt;/max_memory_usage&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/clickhouse&gt;
</code></pre><p>BTW, you can define any macro in your configuration and use them in <a href=https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/ target=_blank>Zookeeper</a>
paths</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span> ReplicatedMergeTree(&#39;/clickhouse/{cluster}/tables/my_table&#39;,&#39;{replica}&#39;)
</span></span></code></pre></div><p>or in your code using function getMacro:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>srv_server_info</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>getMacro</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;shard&#39;</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>shard_num</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>getMacro</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;server_name&#39;</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>server_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>getMacro</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;server_id&#39;</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Settings can be appended to an XML tree (default behaviour) or replaced or removed.</p><p>Example how to delete <strong>tcp_port</strong> & <strong>http_port</strong> defined on higher level in the main config.xml (it disables open tcp & http ports if you configured secure ssl):</p><pre tabindex=0><code class=language-markup data-lang=markup>cat /etc/clickhouse-server/config.d/disable_open_network.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
  &lt;http_port remove=&#34;1&#34;/&gt;
  &lt;tcp_port remove=&#34;1&#34;/&gt;
&lt;/clickhouse&gt;
</code></pre><p>Example how to replace <strong>remote_servers</strong> section defined on higher level in the main config.xml (it allows to remove default test clusters.</p><pre tabindex=0><code class=language-markup data-lang=markup>&lt;?xml version=&#34;1.0&#34; ?&gt;
&lt;clickhouse&gt;
  &lt;remote_servers replace=&#34;1&#34;&gt;
    &lt;mycluster&gt;
      ....
    &lt;/mycluster&gt;
  &lt;/remote_servers&gt;
&lt;/clickhouse&gt;
</code></pre><h2 id=settings--restart>Settings & restart</h2><p>General &lsquo;rule of thumb&rsquo;:</p><ul><li><strong>server</strong> settings (<code>config.xml</code> and <code>config.d</code>) changes <strong>require restart</strong>;</li><li><strong>user</strong> settings (<code>users.xml</code> and <code>users.d</code>) changes <strong>don&rsquo;t require restart</strong>.</li></ul><p>But there are <strong>exceptions</strong> from those rules (see below).</p><h3 id=server-config-configxml-sections-which-dont-require-restart>Server config (config.xml) sections which don&rsquo;t require restart</h3><ul><li><code>&lt;max_server_memory_usage></code></li><li><code>&lt;max_server_memory_usage_to_ram_ratio></code></li><li><code>&lt;max_table_size_to_drop></code> (since 19.12)</li><li><code>&lt;max_partition_size_to_drop></code> (since 19.12)</li><li><code>&lt;max_concurrent_queries></code> (since 21.11, also for versions older than v24 system tables are not updated with the new config values)</li><li><code>&lt;macros></code></li><li><code>&lt;remote_servers></code></li><li><code>&lt;dictionaries_config></code></li><li><code>&lt;user_defined_executable_functions_config></code></li><li><code>&lt;models_config></code></li><li><code>&lt;keeper_server></code></li><li><code>&lt;zookeeper></code> (but reconnect don&rsquo;t happen automatically)</li><li><code>&lt;storage_configuration></code> &ndash; only if you add a new entity (disk/volume/policy), to modify these enitities restart is mandatory.</li><li><code>&lt;user_directories></code></li><li><code>&lt;access_control_path></code></li><li><code>&lt;encryption_codecs></code></li><li><code>&lt;logger></code> (since 21.11)</li></ul><p>Those sections (live in separate files):</p><ul><li><code>&lt;dictionaries></code></li><li><code>&lt;functions></code></li><li><code>&lt;models></code></li></ul><p>See also <a href=https://github.com/ClickHouse/ClickHouse/blob/445b0ba7cc6b82e69fef28296981fbddc64cd634/programs/server/Server.cpp#L809-L883 target=_blank>https://github.com/ClickHouse/ClickHouse/blob/445b0ba7cc6b82e69fef28296981fbddc64cd634/programs/server/Server.cpp#L809-L883</a></p><h3 id=user-settings-which-require-restart>User settings which require restart.</h3><p>Most of user setting changes don&rsquo;t require restart, but they get applied at the connect time, so existing connection may still use old user-level settings.
That means that that new setting will be applied to new sessions / after reconnect.</p><p>The list of user setting which require server restart:</p><ul><li><code>&lt;background_buffer_flush_schedule_pool_size></code></li><li><code>&lt;background_pool_size></code></li><li><code>&lt;background_merges_mutations_concurrency_ratio></code></li><li><code>&lt;background_move_pool_size></code></li><li><code>&lt;background_fetches_pool_size></code></li><li><code>&lt;background_common_pool_size></code></li><li><code>&lt;background_schedule_pool_size></code></li><li><code>&lt;background_message_broker_schedule_pool_size></code></li><li><code>&lt;background_distributed_schedule_pool_size></code></li><li><code>&lt;max_replicated_fetches_network_bandwidth_for_server></code></li><li><code>&lt;max_replicated_sends_network_bandwidth_for_server></code></li></ul><p>See also <code>select * from system.settings where description ilike '%start%'</code></p><p>Also there are several &rsquo;long-running&rsquo; user sessions which are almost never restarted and can keep the setting from the server start (it&rsquo;s DDLWorker, <a href=https://altinity.com/blog/kafka-engine-the-story-continues target=_blank>Kafka</a>
, and some other service things).</p><h2 id=dictionaries>Dictionaries</h2><p>We suggest to store each dictionary description in a separate (own) file in a <strong>/etc/clickhouse-server/dict</strong> sub-folder.</p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/dict/country.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;dictionaries&gt;
  &lt;dictionary&gt;
    &lt;name&gt;country&lt;/name&gt;
    &lt;source&gt;
      &lt;http&gt;
      ...
  &lt;/dictionary&gt;
&lt;/dictionaries&gt;
</code></pre><p>and add to the configuration</p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/config.d/dictionaries.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
  &lt;dictionaries_config&gt;dict/*.xml&lt;/dictionaries_config&gt;
  &lt;dictionaries_lazy_load&gt;true&lt;/dictionaries_lazy_load&gt;
&lt;/clickhouse&gt;
</code></pre><p><strong>dict/*.xml</strong> – relative path, servers seeks files in the folder <strong>/etc/clickhouse-server/dict</strong>. More info in <a href=#Multiple-ClickHouse-instances-at-one-host>Multiple ClickHouse instances</a>
.</p><h2 id=incl-attribute--metricaxml>incl attribute & metrica.xml</h2><p><strong>incl</strong> attribute allows to include some XML section from a special <strong>include</strong> file multiple times.</p><p>By default <strong>include</strong> file is <strong>/etc/metrika.xml</strong>. You can use many include files for each XML section.</p><p>For example to avoid repetition of user/password for each dictionary you can create an XML file:</p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/dict_sources.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
  &lt;mysql_config&gt;
      &lt;port&gt;3306&lt;/port&gt;
      &lt;user&gt;user&lt;/user&gt;
      &lt;password&gt;123&lt;/password&gt;
      &lt;replica&gt;
        &lt;host&gt;mysql_host&lt;/host&gt;
        &lt;priority&gt;1&lt;/priority&gt;
      &lt;/replica&gt;
      &lt;db&gt;my_database&lt;/db&gt;
  &lt;/mysql_config&gt;
&lt;/clickhouse&gt;
</code></pre><p>Include this file:</p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/config.d/dictionaries.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
  ...
  &lt;include_from&gt;/etc/clickhouse-server/dict_sources.xml&lt;/include_from&gt;
&lt;/clickhouse&gt;
</code></pre><p>And use in dictionary descriptions (<strong>incl=&ldquo;mysql_config&rdquo;</strong>):</p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/dict/country.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;dictionaries&gt;
  &lt;dictionary&gt;
    &lt;name&gt;country&lt;/name&gt;
    &lt;source&gt;
        &lt;mysql incl=&#34;mysql_config&#34;&gt;
            &lt;table&gt;my_table&lt;/table&gt;
            &lt;invalidate_query&gt;select max(id) from my_table&lt;/invalidate_query&gt;
        &lt;/mysql&gt;
    &lt;/source&gt;
      ...
  &lt;/dictionary&gt;
&lt;/dictionaries&gt;
</code></pre><h2 id=multiple-clickhouse-instances-at-one-host>Multiple ClickHouse instances at one host</h2><p>By default ClickHouse server configs are in <strong>/etc/clickhouse-server/</strong> because clickhouse-server runs with a parameter <strong>&ndash;config-file /etc/clickhouse-server/config.xml</strong></p><p><strong>config-file</strong> is defined in startup scripts:</p><ul><li><strong>/etc/init.d/clickhouse-server</strong> – init-V</li><li><strong>/etc/systemd/system/clickhouse-server.service</strong> – systemd</li></ul><p>ClickHouse uses the path from <strong>config-file</strong> parameter as base folder and seeks for other configs by relative path. All sub-folders <strong>users.d / config.d</strong> are relative.</p><p>You can start multiple <strong>clickhouse-server</strong> each with own <strong>&ndash;config-file.</strong></p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/bin/clickhouse-server --config-file /etc/clickhouse-server-node1/config.xml
</span></span><span style=display:flex><span>  /etc/clickhouse-server-node1/  config.xml ... users.xml
</span></span><span style=display:flex><span>  /etc/clickhouse-server-node1/config.d/disable_open_network.xml
</span></span><span style=display:flex><span>  /etc/clickhouse-server-node1/users.d/....
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/usr/bin/clickhouse-server --config-file /etc/clickhouse-server-node2/config.xml
</span></span><span style=display:flex><span>  /etc/clickhouse-server-node2/   config.xml ... users.xml
</span></span><span style=display:flex><span>  /etc/clickhouse-server-node2/config.d/disable_open_network.xml
</span></span><span style=display:flex><span>  /etc/clickhouse-server-node2/users.d/....
</span></span></code></pre></div><p>If you need to run multiple servers for CI purposes you can combine all settings in a single fat XML file and start ClickHouse without config folders/sub-folders.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/bin/clickhouse-server --config-file /tmp/ch1.xml
</span></span><span style=display:flex><span>/usr/bin/clickhouse-server --config-file /tmp/ch2.xml
</span></span><span style=display:flex><span>/usr/bin/clickhouse-server --config-file /tmp/ch3.xml
</span></span></code></pre></div><p>Each ClickHouse instance must work with own <strong>data-folder</strong> and <strong>tmp-folder</strong>.</p><p>By default ClickHouse uses <strong>/var/lib/clickhouse/</strong>. It can be overridden in path settings</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;path&gt;</span>/data/clickhouse-ch1/<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;tmp_path&gt;</span>/data/clickhouse-ch1/tmp/<span style=color:#204a87;font-weight:700>&lt;/tmp_path&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;user_files_path&gt;</span>/data/clickhouse-ch1/user_files/<span style=color:#204a87;font-weight:700>&lt;/user_files_path&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;local_directory&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;path&gt;</span>/data/clickhouse-ch1/access/<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/local_directory&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;format_schema_path&gt;</span>/data/clickhouse-ch1/format_schemas/<span style=color:#204a87;font-weight:700>&lt;/format_schema_path&gt;</span>
</span></span></code></pre></div><h2 id=preprocessed_configs>preprocessed_configs</h2><p>ClickHouse server watches config files and folders. When you change, add or remove XML files ClickHouse immediately assembles XML files into a combined file. These combined files are stored in <strong>/var/lib/clickhouse/preprocessed_configs/</strong> folders.</p><p>You can verify that your changes are valid by checking <strong>/var/lib/clickhouse/preprocessed_configs/config.xml</strong>, <strong>/var/lib/clickhouse/preprocessed_configs/users.xml</strong>.</p><p>If something wrong with with your settings e.g. unclosed XML element or typo you can see alerts about this mistakes in <strong>/var/log/clickhouse-server/clickhouse-server.log</strong></p><p>If you see your changes in <strong>preprocessed_configs</strong> it does not mean that changes are applied on running server, check Settings and restart.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4640fdb70e9b5dc2e6dae39a6d075a5c>34 - Aggressive merges</h1><div class=lead>Aggressive merges</div><p>Q: Is there any way I can dedicate more resources to the merging process when running ClickHouse® on pretty beefy machines (like 36 cores, 1TB of RAM, and large NVMe disks)?</p><p>Mostly such things doing by changing the level of parallelism:</p><p>1.  <code>background_pool_size</code> - how many threads will be actually doing the merge (if you can push all the server resources to do the merges, i.e. no selects will be running - you can give all the cores to that, so try increasing to 36). If you use replicated table - use the same value for <code>max_replicated_merges_in_queue</code>.</p><p>2.  <code>background_merges_mutations_concurrency_ratio</code> - how many merges will be assigned (multiplier of background_pool_size), sometimes the default (2) may work against you since it will assign smaller merges, which is nice if you need to deal with real-time inserts, but is not important it you do bulk inserts and later start a lot of merges. So I would try 1.</p><ol start=3><li><code>number_of_free_entries_in_pool_to_lower_max_size_of_merge</code> (merge_tree setting) should be changed together with background_pool_size (50-90% of that). &ldquo;When there is less than a specified number of free entries in the pool (or replicated queue), start to lower the maximum size of the merge to process (or to put in the queue). This is to allow small merges to process - not filling the pool with long-running merges.&rdquo; To make it really aggressive try 90-95% of background_pool_size, for ex. 34 (so you will have 34 huge merges and 2 small ones).</li></ol><p>Additionally, you can:</p><ul><li>control how big target parts will be created by the merges (max_bytes_to_merge_at_max_space_in_pool)</li><li>disable direct io for big merges (min_merge_bytes_to_use_direct_io) - direct io is often slower (it bypasses the page cache, and it is used there to prevent pushing out the often used data from the cache by the running merge).</li><li>on a replicated system with slow merges and a fast network you can use execute_merges_on_single_replica_time_threshold</li><li>analyze if the Vertical or Horizontal merge is better / faster for your case/schema. (Vertical first merges the columns from the table ORDER BY and then other columns one by another - that normally requires less ram, and keep fewer files opened, but requires more complex computations compared to horizontal when all columns are merged simultaneously).</li><li>if you have a lot of tables - you can also give more resources to the scheduler (the component which assigns the merges, and do some housekeeping) - background_schedule_pool_size & background_common_pool_size</li><li>review the schema, especially codes/compression used (they allow to reduce the size, but often can impact the merge speed significantly).</li><li>try to form bigger parts when doing inserts (min_insert_block_size_bytes / min_insert_block_size_rows / max_insert_block_size)</li><li>check if wide (every column in a separate file) or compact (columns are mixed in one file) parts are used (system.parts). By default min_bytes_for_wide_part=10 mln rows (so if the part is bigger that that the wide format will be used, compact otherwise). Sometimes it can be beneficial to use a compact format even for bigger parts (a lot of relatively small columns) or oppositely - use a wide format even for small parts (few fat columns in the table).</li><li>consider using recent ClickHouse releases - they use compressed marks by default, which can be beneficial for reducing the i/o</li></ul><p>All the adjustments/performance optimizations should be controlled by some reproducible &lsquo;benchmark&rsquo; so you can control/prove that the change gives the expected result (sometimes it&rsquo;s quite hard to predict the impact of some change on the real system). Please also monitors how system resources (especially CPU, IO + for replicated tables: network & zookeeper) are used/saturated during the test. Also monitor/plot the usage of the pools:</p><pre tabindex=0><code>select * from system.metrics where metric like &#39;%PoolTask&#39;
</code></pre><p>Those recommendations are NOT generic. For systems with real-time insert & select pressure happening together with merges - those adjustments can be &rsquo;too aggressive&rsquo;. So if you have different setups with different usage patterns - avoid using the same &lsquo;aggressive&rsquo; settings template for all of them.</p><p>TL/DR version:</p><pre tabindex=0><code>cat /etc/clickhouse-server/config.d/aggresive_merges.xml
&lt;clickhouse&gt;
 &lt;background_pool_size&gt;36&lt;/background_pool_size&gt;
 &lt;background_schedule_pool_size&gt;128&lt;/background_schedule_pool_size&gt;
 &lt;background_common_pool_size&gt;8&lt;/background_common_pool_size&gt;
 &lt;background_merges_mutations_concurrency_ratio&gt;1&lt;/background_merges_mutations_concurrency_ratio&gt;
 &lt;merge_tree&gt;
  &lt;number_of_free_entries_in_pool_to_lower_max_size_of_merge&gt;32&lt;/number_of_free_entries_in_pool_to_lower_max_size_of_merge&gt;
  &lt;max_replicated_merges_in_queue&gt;36&lt;/max_replicated_merges_in_queue&gt;
  &lt;max_bytes_to_merge_at_max_space_in_pool&gt;161061273600&lt;/max_bytes_to_merge_at_max_space_in_pool&gt;
  &lt;min_merge_bytes_to_use_direct_io&gt;10737418240&lt;/min_merge_bytes_to_use_direct_io&gt; &lt;!-- 0 to disable --&gt;
 &lt;/merge_tree&gt;
&lt;/clickhouse&gt;

cat /etc/clickhouse-server/users.d/aggresive_merges.xml
&lt;clickhouse&gt; &lt;!-- on 22.8 that should be adjusted in both places - default profile and main config --&gt;
&lt;profiles&gt;
&lt;default&gt;
&lt;background_pool_size&gt;36&lt;/background_pool_size&gt;
&lt;background_schedule_pool_size&gt;128&lt;/background_schedule_pool_size&gt;
&lt;background_common_pool_size&gt;8&lt;/background_common_pool_size&gt;
&lt;background_merges_mutations_concurrency_ratio&gt;1&lt;/background_merges_mutations_concurrency_ratio&gt;
&lt;/default&gt;
&lt;/profiles&gt;
&lt;/clickhouse&gt;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-482a9e1e23251a246ec9901728b5dda1>35 - Altinity Backup for ClickHouse®</h1><div class=lead>Altinity Backup for ClickHouse® + backblaze</div><h3 id=installation-and-configuration>Installation and configuration</h3><p>Download the latest <code>clickhouse-backup.tar.gz</code> from assets from <a href=https://github.com/Altinity/clickhouse-backup/releases target=_blank>https://github.com/Altinity/clickhouse-backup/releases</a></p><p>This tar.gz contains a single binary of <code>clickhouse-backup</code> and an example of config file.</p><p>Backblaze has s3 compatible API but requires empty acl parameter <code>acl: ""</code>.</p><p><a href=https://www.backblaze.com/ target=_blank>https://www.backblaze.com/</a>
has 15 days and free 10Gb S3 trial.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir clickhouse-backup
</span></span><span style=display:flex><span>$ <span style=color:#204a87>cd</span> clickhouse-backup
</span></span><span style=display:flex><span>$ wget https://github.com/Altinity/clickhouse-backup/releases/download/v2.5.20/clickhouse-backup.tar.gz
</span></span><span style=display:flex><span>$ tar zxf clickhouse-backup.tar.gz
</span></span><span style=display:flex><span>$ rm clickhouse-backup.tar.gz
</span></span><span style=display:flex><span>$ cat config.yml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>general</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>remote_storage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>disable_progress_bar</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>backups_to_keep_local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>backups_to_keep_remote</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>log_level</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>info</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>allow_empty_backups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>clickhouse</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>localhost</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>disk_mapping</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>skip_tables</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>system.*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>5m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>freeze_by_part</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>secure</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>skip_verify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>sync_replicated_tables</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>log_sql_queries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>s3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>access_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#8f5902;font-style:italic>****1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>secret_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>K****1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;mybucket&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://s3.us-west-000.backblazeb2.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>us-west-000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>acl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>force_path_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse-backup</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>disable_ssl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>part_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>536870912</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>compression_level</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>compression_format</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>sse</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>disable_cert_verification</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>storage_class</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STANDARD</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>I have a database <code>test</code> with table <code>test</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>400000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><code>clickhouse-backup list</code> should work without errors (it scans local and remote (s3) folders):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo ./clickhouse-backup list -c config.yml
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><h3 id=backup>Backup</h3><ul><li>create a local backup of database test</li><li>upload this backup to remote</li><li>remove the local backup</li><li>drop the source database</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo ./clickhouse-backup create --tables<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;test.*&#39;</span> bkp01 -c config.yml
</span></span><span style=display:flex><span>2021/05/31 23:11:13  info <span style=color:#204a87;font-weight:700>done</span>   <span style=color:#000>backup</span><span style=color:#ce5c00;font-weight:700>=</span>bkp01 <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>=</span>create <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>=</span>test.test
</span></span><span style=display:flex><span>2021/05/31 23:11:13  info <span style=color:#204a87;font-weight:700>done</span>   <span style=color:#000>backup</span><span style=color:#ce5c00;font-weight:700>=</span>bkp01 <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>=</span>create
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo ./clickhouse-backup upload bkp01 -c config.yml
</span></span><span style=display:flex><span> 1.44 MiB / 1.44 MiB <span style=color:#ce5c00;font-weight:700>[=====================]</span> 100.00% 2s
</span></span><span style=display:flex><span>2021/05/31 23:12:13  info <span style=color:#204a87;font-weight:700>done</span>   <span style=color:#000>backup</span><span style=color:#ce5c00;font-weight:700>=</span>bkp01 <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>=</span>upload <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>=</span>test.test
</span></span><span style=display:flex><span>2021/05/31 23:12:17  info <span style=color:#204a87;font-weight:700>done</span>   <span style=color:#000>backup</span><span style=color:#ce5c00;font-weight:700>=</span>bkp01 <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>=</span>upload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo ./clickhouse-backup list -c config.yml
</span></span><span style=display:flex><span>bkp01   1.44MiB   31/05/2021 23:11:13   <span style=color:#204a87>local</span>
</span></span><span style=display:flex><span>bkp01   1.44MiB   31/05/2021 23:11:13   remote      tar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo ./clickhouse-backup delete <span style=color:#204a87>local</span> bkp01 -c config.yml
</span></span><span style=display:flex><span>2021/05/31 23:13:29  info delete <span style=color:#4e9a06>&#39;bkp01&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=restore>Restore</h3><ul><li>download the remote backup</li><li>restore database</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo ./clickhouse-backup list -c config.yml
</span></span><span style=display:flex><span>bkp01   1.44MiB   31/05/2021 23:11:13   remote      tar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo ./clickhouse-backup download bkp01 -c config.yml
</span></span><span style=display:flex><span>2021/05/31 23:14:41  info <span style=color:#204a87;font-weight:700>done</span>    <span style=color:#000>backup</span><span style=color:#ce5c00;font-weight:700>=</span>bkp01 <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>=</span>download <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>=</span>test.test
</span></span><span style=display:flex><span> 1.47 MiB / 1.47 MiB <span style=color:#ce5c00;font-weight:700>[=====================]</span> 100.00% 0s
</span></span><span style=display:flex><span>2021/05/31 23:14:43  info <span style=color:#204a87;font-weight:700>done</span>    <span style=color:#000>backup</span><span style=color:#ce5c00;font-weight:700>=</span>bkp01 <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>=</span>download <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>=</span>test.test
</span></span><span style=display:flex><span>2021/05/31 23:14:43  info <span style=color:#204a87;font-weight:700>done</span>    <span style=color:#000>backup</span><span style=color:#ce5c00;font-weight:700>=</span>bkp01 <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>=</span>download
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo ./clickhouse-backup restore bkp01 -c config.yml
</span></span><span style=display:flex><span>2021/05/31 23:16:04  info <span style=color:#204a87;font-weight:700>done</span>    <span style=color:#000>backup</span><span style=color:#ce5c00;font-weight:700>=</span>bkp01 <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>=</span>restore <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>=</span>test.test
</span></span><span style=display:flex><span>2021/05/31 23:16:04  info <span style=color:#204a87;font-weight:700>done</span>    <span style=color:#000>backup</span><span style=color:#ce5c00;font-weight:700>=</span>bkp01 <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>=</span>restore
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>400000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=delete-backups>Delete backups</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo ./clickhouse-backup delete <span style=color:#204a87>local</span> bkp01 -c config.yml
</span></span><span style=display:flex><span>2021/05/31 23:17:05  info delete <span style=color:#4e9a06>&#39;bkp01&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo ./clickhouse-backup delete remote bkp01 -c config.yml
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c5646e9a69c9b22cfb88e043089f04f0>36 - Altinity packaging compatibility >21.x and earlier</h1><div class=lead>Altinity packaging compatibility >21.x and earlier</div><h2 id=working-with-altinity--yandex-packaging-together>Working with Altinity & Yandex packaging together</h2><p>Since ClickHouse® version 21.1 Altinity switches to the same packaging as used by Yandex. That is needed for syncing things and introduces several improvements (like adding systemd service file).</p><p>Unfortunately, that change leads to compatibility issues - automatic dependencies resolution gets confused by the conflicting package names: both when you update ClickHouse to the new version (the one which uses older packaging) and when you want to install older altinity packages (20.8 and older).</p><h3 id=installing-old-clickhouse-version-with-old-packaging-schema>Installing old ClickHouse version (with old packaging schema)</h3><p>When you try to install versions 20.8 or older from Altinity repo -</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>=</span>20.8.12.2-1.el7
</span></span><span style=display:flex><span>yum install clickhouse-client-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span> clickhouse-server-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span>
</span></span></code></pre></div><p>yum outputs something like</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install clickhouse-client-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span> clickhouse-server-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>Loaded plugins: fastestmirror, ovl
</span></span><span style=display:flex><span>Loading mirror speeds from cached hostfile
</span></span><span style=display:flex><span> * base: centos.hitme.net.pl
</span></span><span style=display:flex><span> * extras: centos1.hti.pl
</span></span><span style=display:flex><span> * updates: centos1.hti.pl
</span></span><span style=display:flex><span>Altinity_clickhouse-altinity-stable/x86_64/signature                                                                                                                                <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>833</span> B  00:00:00
</span></span><span style=display:flex><span>Altinity_clickhouse-altinity-stable/x86_64/signature                                                                                                                                <span style=color:#000;font-weight:700>|</span> 1.0 kB  00:00:01 !!!
</span></span><span style=display:flex><span>Altinity_clickhouse-altinity-stable-source/signature                                                                                                                                <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>833</span> B  00:00:00
</span></span><span style=display:flex><span>Altinity_clickhouse-altinity-stable-source/signature                                                                                                                                <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>951</span> B  00:00:00 !!!
</span></span><span style=display:flex><span>Resolving Dependencies
</span></span><span style=display:flex><span>--&gt; Running transaction check
</span></span><span style=display:flex><span>---&gt; Package clickhouse-client.x86_64 0:20.8.12.2-1.el7 will be installed
</span></span><span style=display:flex><span>---&gt; Package clickhouse-server.x86_64 0:20.8.12.2-1.el7 will be installed
</span></span><span style=display:flex><span>--&gt; Processing Dependency: clickhouse-server-common <span style=color:#ce5c00;font-weight:700>=</span> 20.8.12.2-1.el7 <span style=color:#204a87;font-weight:700>for</span> package: clickhouse-server-20.8.12.2-1.el7.x86_64
</span></span><span style=display:flex><span>Package clickhouse-server-common is obsoleted by clickhouse-server, but obsoleting package does not provide <span style=color:#204a87;font-weight:700>for</span> requirements
</span></span><span style=display:flex><span>--&gt; Processing Dependency: clickhouse-common-static <span style=color:#ce5c00;font-weight:700>=</span> 20.8.12.2-1.el7 <span style=color:#204a87;font-weight:700>for</span> package: clickhouse-server-20.8.12.2-1.el7.x86_64
</span></span><span style=display:flex><span>--&gt; Running transaction check
</span></span><span style=display:flex><span>---&gt; Package clickhouse-common-static.x86_64 0:20.8.12.2-1.el7 will be installed
</span></span><span style=display:flex><span>---&gt; Package clickhouse-server.x86_64 0:20.8.12.2-1.el7 will be installed
</span></span><span style=display:flex><span>--&gt; Processing Dependency: clickhouse-server-common <span style=color:#ce5c00;font-weight:700>=</span> 20.8.12.2-1.el7 <span style=color:#204a87;font-weight:700>for</span> package: clickhouse-server-20.8.12.2-1.el7.x86_64
</span></span><span style=display:flex><span>Package clickhouse-server-common is obsoleted by clickhouse-server, but obsoleting package does not provide <span style=color:#204a87;font-weight:700>for</span> requirements
</span></span><span style=display:flex><span>--&gt; Finished Dependency Resolution
</span></span><span style=display:flex><span>Error: Package: clickhouse-server-20.8.12.2-1.el7.x86_64 <span style=color:#ce5c00;font-weight:700>(</span>Altinity_clickhouse-altinity-stable<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           Requires: clickhouse-server-common <span style=color:#ce5c00;font-weight:700>=</span> 20.8.12.2-1.el7
</span></span><span style=display:flex><span>           Available: clickhouse-server-common-1.1.54370-2.x86_64 <span style=color:#ce5c00;font-weight:700>(</span>clickhouse-stable<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>               clickhouse-server-common <span style=color:#ce5c00;font-weight:700>=</span> 1.1.54370-2
</span></span><span style=display:flex><span>           Available: clickhouse-server-common-1.1.54378-2.x86_64 <span style=color:#ce5c00;font-weight:700>(</span>clickhouse-stable<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>               clickhouse-server-common <span style=color:#ce5c00;font-weight:700>=</span> 1.1.54378-2
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>           Available: clickhouse-server-common-20.8.11.17-1.el7.x86_64 <span style=color:#ce5c00;font-weight:700>(</span>Altinity_clickhouse-altinity-stable<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>               clickhouse-server-common <span style=color:#ce5c00;font-weight:700>=</span> 20.8.11.17-1.el7
</span></span><span style=display:flex><span>           Available: clickhouse-server-common-20.8.12.2-1.el7.x86_64 <span style=color:#ce5c00;font-weight:700>(</span>Altinity_clickhouse-altinity-stable<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>               clickhouse-server-common <span style=color:#ce5c00;font-weight:700>=</span> 20.8.12.2-1.el7
</span></span><span style=display:flex><span> You could try using --skip-broken to work around the problem
</span></span><span style=display:flex><span> You could try running: rpm -Va --nofiles --nodigest
</span></span></code></pre></div><p>As you can see yum has an issue with resolving <code>clickhouse-server-common</code> dependency, which marked as obsoleted by newer packages.</p><h4 id=solution-with-old-packaging-scheme>Solution with Old Packaging Scheme</h4><p>add <code>--setopt=obsoletes=0</code> flag to the yum call.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>=</span>20.8.12.2-1.el7
</span></span><span style=display:flex><span>yum install --setopt<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>obsoletes</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> clickhouse-client-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span> clickhouse-server-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>title: <span style=color:#4e9a06>&#34;installation succeeded&#34;</span>
</span></span><span style=display:flex><span>linkTitle: <span style=color:#4e9a06>&#34;installation succeeded&#34;</span>
</span></span><span style=display:flex><span>description: &gt;
</span></span><span style=display:flex><span>    installation succeeded
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>Alternatively, you can add <code>obsoletes=0</code> into <code>/etc/yum.conf</code>.</p><h3 id=to-update-to-new-clickhouse-version-from-old-packaging-schema-to-new-packaging-schema>To update to new ClickHouse version (from old packaging schema to new packaging schema)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>=</span>21.1.7.1-2
</span></span><span style=display:flex><span>yum install clickhouse-client-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span> clickhouse-server-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Loaded plugins: fastestmirror, ovl
</span></span><span style=display:flex><span>Loading mirror speeds from cached hostfile
</span></span><span style=display:flex><span> * base: centos.hitme.net.pl
</span></span><span style=display:flex><span> * extras: centos1.hti.pl
</span></span><span style=display:flex><span> * updates: centos1.hti.pl
</span></span><span style=display:flex><span>Altinity_clickhouse-altinity-stable/x86_64/signature                                                                                                                                <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>833</span> B  00:00:00
</span></span><span style=display:flex><span>Altinity_clickhouse-altinity-stable/x86_64/signature                                                                                                                                <span style=color:#000;font-weight:700>|</span> 1.0 kB  00:00:01 !!!
</span></span><span style=display:flex><span>Altinity_clickhouse-altinity-stable-source/signature                                                                                                                                <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>833</span> B  00:00:00
</span></span><span style=display:flex><span>Altinity_clickhouse-altinity-stable-source/signature                                                                                                                                <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>951</span> B  00:00:00 !!!
</span></span><span style=display:flex><span>Nothing to <span style=color:#204a87;font-weight:700>do</span>
</span></span></code></pre></div><p>It is caused by wrong dependencies resolution.</p><h4 id=solution-with-new-package-scheme>Solution with New Package Scheme</h4><p>To update to the latest available version - just add <code>clickhouse-server-common</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install clickhouse-client clickhouse-server clickhouse-server-common
</span></span></code></pre></div><p>This way the latest available version will be installed (even if you will request some other version explicitly).</p><p>To install some specific version remove old packages first, then install new ones.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum erase clickhouse-client clickhouse-server clickhouse-server-common clickhouse-common-static
</span></span><span style=display:flex><span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>=</span>21.1.7.1
</span></span><span style=display:flex><span>yum install clickhouse-client-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span> clickhouse-server-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span>
</span></span></code></pre></div><h3 id=downgrade-from-new-version-to-old-one>Downgrade from new version to old one</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>=</span>20.8.12.2-1.el7
</span></span><span style=display:flex><span>yum downgrade  clickhouse-client-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span> clickhouse-server-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span>
</span></span></code></pre></div><p>will not work:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Loaded plugins: fastestmirror, ovl
</span></span><span style=display:flex><span>Loading mirror speeds from cached hostfile
</span></span><span style=display:flex><span> * base: ftp.agh.edu.pl
</span></span><span style=display:flex><span> * extras: ftp.agh.edu.pl
</span></span><span style=display:flex><span> * updates: centos.wielun.net
</span></span><span style=display:flex><span>Resolving Dependencies
</span></span><span style=display:flex><span>--&gt; Running transaction check
</span></span><span style=display:flex><span>---&gt; Package clickhouse-client.x86_64 0:20.8.12.2-1.el7 will be a downgrade
</span></span><span style=display:flex><span>---&gt; Package clickhouse-client.noarch 0:21.1.7.1-2 will be erased
</span></span><span style=display:flex><span>---&gt; Package clickhouse-server.x86_64 0:20.8.12.2-1.el7 will be a downgrade
</span></span><span style=display:flex><span>--&gt; Processing Dependency: clickhouse-server-common <span style=color:#ce5c00;font-weight:700>=</span> 20.8.12.2-1.el7 <span style=color:#204a87;font-weight:700>for</span> package: clickhouse-server-20.8.12.2-1.el7.x86_64
</span></span><span style=display:flex><span>Package clickhouse-server-common-20.8.12.2-1.el7.x86_64 is obsoleted by clickhouse-server-21.1.7.1-2.noarch which is already installed
</span></span><span style=display:flex><span>--&gt; Processing Dependency: clickhouse-common-static <span style=color:#ce5c00;font-weight:700>=</span> 20.8.12.2-1.el7 <span style=color:#204a87;font-weight:700>for</span> package: clickhouse-server-20.8.12.2-1.el7.x86_64
</span></span><span style=display:flex><span>---&gt; Package clickhouse-server.noarch 0:21.1.7.1-2 will be erased
</span></span><span style=display:flex><span>--&gt; Finished Dependency Resolution
</span></span><span style=display:flex><span>Error: Package: clickhouse-server-20.8.12.2-1.el7.x86_64 <span style=color:#ce5c00;font-weight:700>(</span>Altinity_clickhouse-altinity-stable<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           Requires: clickhouse-common-static <span style=color:#ce5c00;font-weight:700>=</span> 20.8.12.2-1.el7
</span></span><span style=display:flex><span>           Installed: clickhouse-common-static-21.1.7.1-2.x86_64 <span style=color:#ce5c00;font-weight:700>(</span>@clickhouse-stable<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>               clickhouse-common-static <span style=color:#ce5c00;font-weight:700>=</span> 21.1.7.1-2
</span></span><span style=display:flex><span>           Available: clickhouse-common-static-1.1.54378-2.x86_64 <span style=color:#ce5c00;font-weight:700>(</span>clickhouse-stable<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>               clickhouse-common-static <span style=color:#ce5c00;font-weight:700>=</span> 1.1.54378-2
</span></span><span style=display:flex><span>Error: Package: clickhouse-server-20.8.12.2-1.el7.x86_64 <span style=color:#ce5c00;font-weight:700>(</span>Altinity_clickhouse-altinity-stable<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>           Available: clickhouse-server-common-20.8.12.2-1.el7.x86_64 <span style=color:#ce5c00;font-weight:700>(</span>Altinity_clickhouse-altinity-stable<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>               clickhouse-server-common <span style=color:#ce5c00;font-weight:700>=</span> 20.8.12.2-1.el7
</span></span><span style=display:flex><span> You could try using --skip-broken to work around the problem
</span></span><span style=display:flex><span> You could try running: rpm -Va --nofiles --nodigest
</span></span></code></pre></div><h4 id=solution-with-downgrading>Solution With Downgrading</h4><p>Remove packages first, then install older versions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum erase clickhouse-client clickhouse-server clickhouse-server-common clickhouse-common-static
</span></span><span style=display:flex><span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>=</span>20.8.12.2-1.el7
</span></span><span style=display:flex><span>yum install --setopt<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>obsoletes</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> clickhouse-client-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span> clickhouse-server-<span style=color:#4e9a06>${</span><span style=color:#000>version</span><span style=color:#4e9a06>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8e50fd6090d2cd6ea786d66d7fc1dc14>37 - AWS EC2 Storage</h1><div class=lead>AWS EBS, EFS, FSx, Lustre</div><h1 id=ebs>EBS</h1><p>Most native choose for ClickHouse® as fast storage, because it usually guarantees best throughput, IOPS, latency for reasonable price.</p><p><a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-optimized.html target=_blank>https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-optimized.html</a></p><p><a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-volume-types.html target=_blank>https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-volume-types.html</a></p><h2 id=general-purpose-ssd-volumes>General Purpose SSD volumes</h2><p>In usual conditions ClickHouse being limited by throughput of volumes and amount of provided IOPS doesn&rsquo;t make any big difference for performance starting from a certain number. So the most native choice for ClickHouse is gp3 and gp2 volumes.</p><p>‌EC2 instances also have an EBS throughput limit, it depends on the size of the EC2 instance. That means if you would attach multiple volumes which would have high potential throughput, you would be limited by your EC2 instance, so usually there is no reason to have more than 1-3 GP3 volume or 4-5 GP2 volume per node.</p><p>It&rsquo;s pretty straightforward to set up a ClickHouse for using multiple EBS volumes with jbod storage_policies.</p><p><a href=https://aws.amazon.com/ebs/general-purpose/ target=_blank>general purpose</a></p><table><thead><tr><th style=text-align:left><b>Volume type</b></th><th style=text-align:center>gp3</th><th style=text-align:center>gp2</th></tr></thead><tbody><tr><td style=text-align:left><b>Max throughput per volume</b></td><td style=text-align:center>1000 MiB/s</td><td style=text-align:center>250 MiB/s</td></tr><tr><td style=text-align:left><b>Price</b></td><td style=text-align:center><p>$0.08/GB-month</p><p>3,000 IOPS free and</p><p>$0.005/provisioned IOPS-month over 3,000;</p><p>125 MB/s free and</p><p>$0.04/provisioned MB/s-month over 125</p></td><td style=text-align:center>$0.10/GB-month</td></tr></tbody></table><h3 id=gp3>GP3</h3><p>It&rsquo;s <strong>recommended option</strong>, as it allow you to have only one volume, for instances which have less than 10 Gbps EBS Bandwidth (nodes =&lt;32 VCPU usually) and still have maximum performance.
For bigger instances, it make sense to look into option of having several GP3 volumes.</p><p>It&rsquo;s a new type of volume, which is 20% cheaper than gp2 per GB-month and has lower free throughput: only 125 MiB/s vs 250 MiB/s. But you can buy additional throughput and IOPS for volume. It also works better if most of your queries read only one or several parts, because in that case you are not being limited by performance of a single EBS disk, as parts can be located only on one disk at once.</p><p>Because, you need to have less GP3 volumes compared to GP2 option, it&rsquo;s suggested approach for now.</p><p>For best performance, it&rsquo;s suggested to buy:</p><ul><li>7000 IOPS</li><li>Throughput up to the limit of your EC2 instance (1000 MiB/s is safe option)</li></ul><h3 id=gp2>GP2</h3><p>‌GP2 volumes have a hard limit of 250 MiB/s per volume (for volumes bigger than 334 GB), it usually makes sense to split one big volume in multiple smaller volumes larger than 334GB in order to have maximum possible throughput.</p><h2 id=throughput-optimized-hdd-volumes>Throughput Optimized HDD volumes</h2><h3 id=st1>ST1</h3><p>Looks like a good candidate for cheap cold storage for old data with decent maximum throughput 500 MiB/s. But it achieved only for big volumes >5 TiB.</p><p><a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/hdd-vols.html#EBSVolumeTypes_st1 target=_blank>Throughput credits and burst performance</a></p><h2 id=provisioned-iops-ssd-volumes>Provisioned IOPS SSD volumes</h2><h3 id=io2block-express-io2-io1>IO2 Block Express, IO2, IO1</h3><p>In 99.99% cases doesn&rsquo;t give any benefit for ClickHouse compared to GP3 option and perform worse because maximum throughput is limited to 500 MiB/s per volume if you buy less than 32 000 IOPS, which is really expensive (compared to other options) and unneeded for ClickHouse. And if you have spare money, it&rsquo;s better to spend them on better EC2 instance.</p><h1 id=s3>S3</h1><p>Best option for cold data, it can give considerably good throughput and really good price, but latencies and IOPS much worse than EBS option.
Another interesting point is, for EC2 instance throughput limit for EBS and S3 calculated separately, so if you access your data both from EBS and S3, you can get double throughput.</p><p>It&rsquo;s stated in AWS documentation, that S3 can fully utilize network capacity of EC2 instance. (up to 100 Gb/s)
Latencies or (first-byte-out) estimated to be 100-200 milliseconds withing single region.</p><p>It also recommended to enable <a href=https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html#create-gateway-endpoint-s3 target=_blank>gateway endpoint for s3</a>
, it can push throughput even further (up to 800 Gb/s)</p><p><a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/optimizing-performance.html target=_blank>S3 best practices</a></p><h1 id=efs>EFS</h1><p>Works over NFSv4.1 version.
We have clients, which run their ClickHouse installations over NFS. It works considerably well as cold storage, so it&rsquo;s recommended to have EBS disks for hot data. A fast network is required.</p><p>ClickHouse doesn&rsquo;t have any native option to reuse the same data on durable network disk via several replicas. You either need to store the same data twice or build custom tooling around ClickHouse and use it without Replicated*MergeTree tables.</p><h1 id=fsx>FSx</h1><h2 id=lustre>Lustre</h2><p>We have several clients, who use Lustre (some of them use AWS FSx Lustre, another is self managed Lustre) without any big issue. Fast network is required.
There were known problems with data damage on older versions caused by issues with O_DIRECT or <a href=https://lustre-discuss.lustre.narkive.com/zwcvyEEY/asynchronous-posix-i-o-with-lustre target=_blank>async IO</a>
support on Lustre.</p><p>ClickHouse doesn&rsquo;t have any native option to reuse the same data on durable network disk via several replicas. You either need to store the same data twice or build custom tooling around ClickHouse and use it without Replicated*MergeTree tables.</p><p><a href=https://altinity.com/blog/2019/11/27/amplifying-clickhouse-capacity-with-multi-volume-storage-part-1 target=_blank>https://altinity.com/blog/2019/11/27/amplifying-clickhouse-capacity-with-multi-volume-storage-part-1</a></p><p><a href=https://altinity.com/blog/2019/11/29/amplifying-clickhouse-capacity-with-multi-volume-storage-part-2 target=_blank>https://altinity.com/blog/2019/11/29/amplifying-clickhouse-capacity-with-multi-volume-storage-part-2</a></p><p><a href="https://calculator.aws/%5c#/createCalculator/EBS?nc2=h_ql_pr_calc" target=_blank>https://calculator.aws/#/createCalculator/EBS?nc2=h_ql_pr_calc</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-4789c5a0fbc6e298289a42e92e966f51>38 - ClickHouse® in Docker</h1><div class=lead>ClickHouse® in Docker</div><h2 id=do-you-have-documentation-on-docker-deployments>Do you have documentation on Docker deployments?</h2><p>Check</p><ul><li><a href=https://hub.docker.com/r/clickhouse/clickhouse-server target=_blank>https://hub.docker.com/r/clickhouse/clickhouse-server</a></li><li><a href=https://docs.altinity.com/clickhouseonkubernetes/ target=_blank>https://docs.altinity.com/clickhouseonkubernetes/</a></li><li>sources of entry point - <a href=https://github.com/ClickHouse/ClickHouse/blob/master/docker/server/entrypoint.sh target=_blank>https://github.com/ClickHouse/ClickHouse/blob/master/docker/server/entrypoint.sh</a></li></ul><p>Important things:</p><ul><li>use concrete version tag (avoid using latest)</li><li>if possible use <code>--network=host</code> (due to performance reasons)</li><li>you need to mount the folder <code>/var/lib/clickhouse</code> to have persistency.</li><li>you MAY also mount the folder <code>/var/log/clickhouse-server</code> to have logs accessible outside of the container.</li><li>Also, you may mount in some files or folders in the configuration folder:<ul><li><code>/etc/clickhouse-server/config.d/listen_ports.xml</code></li></ul></li><li><code>--ulimit nofile=262144:262144</code></li><li>You can also set on some linux capabilities to enable some of extra features of ClickHouse® (not obligatory): <code>SYS_PTRACE NET_ADMIN IPC_LOCK SYS_NICE</code></li><li>you may also mount in the folder <code>/docker-entrypoint-initdb.d/</code> - all SQL or bash scripts there will be executed during container startup.</li><li>if you use cgroup limits - it may misbehave <a href=https://github.com/ClickHouse/ClickHouse/issues/2261 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/2261</a>
(set up <code>&lt;max_server_memory_usage></code> manually)</li><li>there are several ENV switches, see: <a href=https://github.com/ClickHouse/ClickHouse/blob/master/docker/server/entrypoint.sh target=_blank>https://github.com/ClickHouse/ClickHouse/blob/master/docker/server/entrypoint.sh</a></li></ul><p>TLDR version: use it as a starting point:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --name some-clickhouse-server <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --ulimit <span style=color:#000>nofile</span><span style=color:#ce5c00;font-weight:700>=</span>262144:262144 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --volume<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span>/data:/var/lib/clickhouse <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --volume<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span>/logs:/var/log/clickhouse-server <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --volume<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span>/configs/memory_adjustment.xml:/etc/clickhouse-server/config.d/memory_adjustment.xml <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --cap-add<span style=color:#ce5c00;font-weight:700>=</span>SYS_NICE <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --cap-add<span style=color:#ce5c00;font-weight:700>=</span>NET_ADMIN <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --cap-add<span style=color:#ce5c00;font-weight:700>=</span>IPC_LOCK <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --cap-add<span style=color:#ce5c00;font-weight:700>=</span>SYS_PTRACE <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --network<span style=color:#ce5c00;font-weight:700>=</span>host <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   clickhouse/clickhouse-server:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker <span style=color:#204a87>exec</span> -it some-clickhouse-server clickhouse-client
</span></span><span style=display:flex><span>docker <span style=color:#204a87>exec</span> -it some-clickhouse-server bash
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e2ee81b31da5dc08de7cc4b0235f75fd>39 - ClickHouse® Monitoring</h1><div class=lead>Tracking potential issues in your cluster before they cause a critical error</div><p>What to read / watch on the subject:</p><ul><li>Altinity webinar &ldquo;ClickHouse Monitoring 101: What to monitor and how&rdquo;. <a href="https://www.youtube.com/watch?v=W9KlehhgwLw" target=_blank>Watch the video</a>
or <a href=https://www.slideshare.net/Altinity/clickhouse-monitoring-101-what-to-monitor-and-how target=_blank>download the slides</a>
.</li><li><a href=https://clickhouse.com/docs/en/operations/monitoring/ target=_blank rel=nofollow>The ClickHouse docs</a></li></ul><h2 id=what-should-be-monitored>What should be monitored</h2><p>The following metrics should be collected / monitored</p><ul><li><p>For Host Machine:</p><ul><li>CPU</li><li>Memory</li><li>Network (bytes/packets)</li><li>Storage (iops)</li><li>Disk Space (free / used)</li></ul></li><li><p>For ClickHouse:</p><ul><li>Connections (Number of queries running)</li><li>DDL queue length</li><li>RWLocks</li><li>Read / Write / Return (bytes/rows)</li><li>Merges (queue length, memory used)</li><li>Mutations</li><li>Query duration (optional)</li><li>Replication queue length and lag</li><li>Read only tables</li><li>ZooKeeper latencies</li><li>Zookeeper operations (count)</li><li>S3 errors (if used)</li></ul></li><li><p>For Zookeeper:</p><ul><li><a href=../altinity-kb-zookeeper/zookeeper-monitoring/>See separate article</a></li></ul></li></ul><h2 id=clickhouse-monitoring-tools>ClickHouse monitoring tools</h2><h3 id=prometheus-embedded-exporter--grafana>Prometheus (embedded exporter) + Grafana</h3><ul><li>Enable <a href=https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-prometheus target=_blank rel=nofollow>embedded exporter</a></li><li>Grafana dashboards <a href=https://grafana.com/grafana/dashboards/14192 target=_blank>https://grafana.com/grafana/dashboards/14192</a>
or <a href=https://grafana.com/grafana/dashboards/13500 target=_blank>https://grafana.com/grafana/dashboards/13500</a></li></ul><h3 id=prometheus-embedded-http-handler-with-altinity-kubernetes-operator-for-clickhouse-style-metrics--grafana>Prometheus (embedded http handler with Altinity Kubernetes Operator for ClickHouse style metrics) + Grafana</h3><ul><li>Enable <a href=../monitoring-operator-exporter-compatibility/>http handler</a></li><li>Useful, if you want to use the dashboard from the Altinity Kubernetes Operator for ClickHouse, but do not run ClickHouse in k8s.</li></ul><h3 id=prometheus-embedded-exporter-in-the-altinity-kubernetes-operator-for-clickhouse--grafana>Prometheus (embedded exporter in the Altinity Kubernetes Operator for ClickHouse) + Grafana</h3><ul><li>exporter is included in the Altinity Kubernetes Operator for ClickHouse, and enabled automatically</li><li>see instructions of <a href=https://github.com/Altinity/clickhouse-operator/blob/eb3fc4e28514d0d6ea25a40698205b02949bcf9d/docs/prometheus_setup.md target=_blank>Prometheus</a>
and <a href=https://github.com/Altinity/clickhouse-operator/blob/eb3fc4e28514d0d6ea25a40698205b02949bcf9d/docs/grafana_setup.md target=_blank>Grafana</a>
installation (if you don&rsquo;t have one)</li><li>Grafana dashboard <a href=https://github.com/Altinity/clickhouse-operator/tree/master/grafana-dashboard target=_blank>https://github.com/Altinity/clickhouse-operator/tree/master/grafana-dashboard</a></li><li>Prometheus alerts <a href=https://github.com/Altinity/clickhouse-operator/blob/master/deploy/prometheus/prometheus-alert-rules-clickhouse.yaml target=_blank>https://github.com/Altinity/clickhouse-operator/blob/master/deploy/prometheus/prometheus-alert-rules-clickhouse.yaml</a></li></ul><h3 id=prometheus-clickhouse-external-exporter--grafana>Prometheus (ClickHouse external exporter) + Grafana</h3><ul><li><a href=https://github.com/ClickHouse/clickhouse_exporter target=_blank>clickhouse-exporter</a></li><li>Dashboard: <a href=https://grafana.com/grafana/dashboards/882 target=_blank>https://grafana.com/grafana/dashboards/882</a></li></ul><p>(unmaintained)</p><h3 id=dashboards-querying-clickhouse-directly-via-vertamedia--altinity-plugin>Dashboards querying ClickHouse directly via vertamedia / Altinity plugin</h3><ul><li>Overview: <a href=https://grafana.com/grafana/dashboards/13606 target=_blank>https://grafana.com/grafana/dashboards/13606</a></li><li>Queries dashboard (analyzing system.query_log) <a href=https://grafana.com/grafana/dashboards/2515 target=_blank>https://grafana.com/grafana/dashboards/2515</a></li></ul><h2 id=dashboard-querying-clickhouse-directly-via-grafana-plugin>Dashboard querying ClickHouse directly via Grafana plugin</h2><ul><li><a href=https://grafana.com/blog/2022/05/05/introducing-the-official-clickhouse-plugin-for-grafana/ target=_blank>https://grafana.com/blog/2022/05/05/introducing-the-official-clickhouse-plugin-for-grafana/</a></li><li><a href=https://gist.github.com/filimonov/271e5b27c085356c67db3c1bf2204506 target=_blank>https://gist.github.com/filimonov/271e5b27c085356c67db3c1bf2204506</a></li></ul><h3 id=zabbix>Zabbix</h3><ul><li><a href=https://www.zabbix.com/integrations/clickhouse target=_blank>https://www.zabbix.com/integrations/clickhouse</a></li><li><a href=https://github.com/Altinity/clickhouse-zabbix-template target=_blank>https://github.com/Altinity/clickhouse-zabbix-template</a></li></ul><h3 id=graphite>Graphite</h3><ul><li>Use the embedded exporter. See <a href=https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-graphite target=_blank rel=nofollow>docs</a>
and config.xml</li></ul><h3 id=influxdb>InfluxDB</h3><ul><li>You can use embedded exporter, plus Telegraf. For more information, see <a href=https://docs.influxdata.com/influxdb/v1.7/supported_protocols/graphite/ target=_blank>Graphite protocol support in InfluxDB</a>
.</li></ul><h3 id=nagiosicinga>Nagios/Icinga</h3><ul><li><a href=https://github.com/exogroup/check_clickhouse/ target=_blank>https://github.com/exogroup/check_clickhouse/</a></li></ul><h3 id=commercial-solution>Commercial solution</h3><ul><li>Datadog <a href="https://docs.datadoghq.com/integrations/clickhouse/?tab=host" target=_blank>https://docs.datadoghq.com/integrations/clickhouse/?tab=host</a></li><li>Sematext <a href=https://sematext.com/docs/integration/clickhouse/ target=_blank>https://sematext.com/docs/integration/clickhouse/</a></li><li>Instana <a href=https://www.instana.com/supported-technologies/clickhouse-monitoring/ target=_blank>https://www.instana.com/supported-technologies/clickhouse-monitoring/</a></li><li>site24x7 <a href=https://www.site24x7.com/plugins/clickhouse-monitoring.html target=_blank>https://www.site24x7.com/plugins/clickhouse-monitoring.html</a></li><li>Acceldata Pulse <a href=https://www.acceldata.io/blog/acceldata-pulse-for-clickhouse-monitoring target=_blank>https://www.acceldata.io/blog/acceldata-pulse-for-clickhouse-monitoring</a></li></ul><h3 id=build-your-own-clickhouse-monitoring>&ldquo;Build your own&rdquo; ClickHouse monitoring</h3><p>ClickHouse allows to access lots of internals using system tables. The main tables to access monitoring data are:</p><ul><li>system.metrics</li><li>system.asynchronous_metrics</li><li>system.events</li></ul><p>Minimum necessary set of checks</p><table><tr><td><strong>Check Name</strong></td><td><strong><code>Shell or SQL command</code></strong></td><td><strong><code>Severity</code></strong></td></tr><tr><td>ClickHouse status</td><td><code>$ curl 'http://localhost:8123/'</code><p><code>Ok.</code></td><td><code>Critical</code></td></tr><tr><td>Too many simultaneous queries. Maximum: 100 (by default)</td><td><code>select value from system.metrics</code><p><code>where metric='Query'</code></td><td><code>Critical</code></td></tr><tr><td>Replication status</td><td><code>$ curl 'http://localhost:8123/replicas_status'</code><p><code>Ok.</code></td><td><code>High</code></td></tr><tr><td>Read only replicas (reflected by <code>replicas_status</code> as well)</td><td><code>select value from system.metrics</code><p><code>where metric='ReadonlyReplica'</code></td><td><code>High</code></td></tr><tr><td>Some replication tasks are stuck</td><td><code>select count()</code><p><code>from system.replication_queue</code><p><code>where num_tries > 100 or num_postponed > 1000</code></td><td><code>High</code></td></tr><tr><td>ZooKeeper is available</td><td><code>select count() from system.zookeeper</code><p><code>where path='/'</code></td><td><code>Critical for writes</code></td></tr><tr><td>ZooKeeper exceptions</td><td><code>select value from system.events</code><p><code>where event='ZooKeeperHardwareExceptions'</code></td><td><code>Medium</code></td></tr><tr><td>Other CH nodes are available</td><td><code>$ for node in `echo "select distinct host_address from system.clusters where host_name !='localhost'" | curl 'http://localhost:8123/' --silent --data-binary @-`; do curl "http://$node:8123/" --silent ; done | sort -u</code><p><code>Ok.</code></td><td><code>High</code></td></tr><tr><td>All CH clusters are available (i.e. every configured cluster has enough replicas to serve queries)</td><td><code>for cluster in `echo "select distinct cluster from system.clusters where host_name !='localhost'" | curl 'http://localhost:8123/' --silent --data-binary @-` ; do clickhouse-client --query="select '$cluster', 'OK' from cluster('$cluster', system, one)" ; done</code></td><td><code>Critical</code></td></tr><tr><td>There are files in 'detached' folders</td><td><code>$ find /var/lib/clickhouse/data/*/*/detached/* -type d | wc -l; \
19.8+</code><p><code>select count() from system.detached_parts</code></td><td><code>Medium</code></td></tr><tr><td>Too many parts: \
Number of parts is growing; \
Inserts are being delayed; \
Inserts are being rejected</td><td><code>select value from system.asynchronous_metrics</code><p><code>where metric='MaxPartCountForPartition';</code><p><code>select value from system.events/system.metrics</code><p><code>where event/metric='DelayedInserts'; \
select value from system.events</code><p><code>where event='RejectedInserts'</code></td><td><code>Critical</code></td></tr><tr><td>Dictionaries: exception</td><td><code>select concat(name,': ',last_exception)</code><p><code>from system.dictionaries</code><p><code>where last_exception != ''</code></td><td><code>Medium</code></td></tr><tr><td>ClickHouse has been restarted</td><td><code>select uptime();</code><p><code>select value from system.asynchronous_metrics</code><p><code>where metric='Uptime'</code></td><td></td></tr><tr><td>DistributedFilesToInsert should not be always increasing</td><td><code>select value from system.metrics</code><p><code>where metric='DistributedFilesToInsert'</code></td><td><code>Medium</code></td></tr><tr><td>A data part was lost</td><td><code>select value from system.events</code><p><code>where event='ReplicatedDataLoss'</code></td><td><code>High</code></td></tr><tr><td>Data parts are not the same on different replicas</td><td><code>select value from system.events where event='DataAfterMergeDiffersFromReplica'; \
select value from system.events where event='DataAfterMutationDiffersFromReplica'</code></td><td><code>Medium</code></td></tr><tr><td></td><td></td><td></td></tr></table><p>The following queries are recommended to be included in monitoring:</p><ul><li><code>SELECT * FROM system.replicas</code><ul><li>For more information, see the ClickHouse guide on <a href=https://clickhouse.tech/docs/en/operations/system_tables/#system_tables-replicas target=_blank rel=nofollow>System Tables</a></li></ul></li><li><code>SELECT * FROM system.merges</code><ul><li>Checks on the speed and progress of currently executed merges.</li></ul></li><li><code>SELECT * FROM system.mutations</code><ul><li>This is the source of information on the speed and progress of currently executed merges.</li></ul></li></ul><h2 id=monitoring-clickhouse-logs>Monitoring ClickHouse logs</h2><p><a href=/altinity-kb-setup-and-maintenance/logging/>ClickHouse logs</a>
can be another important source of information. There are 2 logs enabled by default</p><ul><li>/var/log/clickhouse-server/clickhouse-server.err.log (error & warning, you may want to keep an eye on that or send it to some monitoring system)</li><li>/var/log/clickhouse-server/clickhouse-server.log (trace logs, very detailed, useful for debugging, usually too verbose to monitor).</li></ul><p>You can additionally enable system.text_log table to have an access to the logs from clickhouse sql queries (ensure that you will not expose some information to the users who should not see it).</p><pre tabindex=0><code>$ cat /etc/clickhouse-server/config.d/text_log.xml
&lt;yandex&gt;
    &lt;text_log&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;text_log&lt;/table&gt;
        &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;
        &lt;level&gt;warning&lt;/level&gt;
    &lt;/text_log&gt;
&lt;/yandex&gt;
</code></pre><h2 id=opentelemetry-support>OpenTelemetry support</h2><p>See <a href=https://clickhouse.com/docs/en/operations/opentelemetry/ target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/opentelemetry/</a></p><h2 id=other-sources>Other sources</h2><ul><li><a href=https://tech.marksblogg.com/clickhouse-prometheus-grafana.html target=_blank>https://tech.marksblogg.com/clickhouse-prometheus-grafana.html</a></li><li><a href=https://sematext.com/blog/clickhouse-monitoring-key-metrics/ target=_blank>Key Metrics for Monitoring ClickHouse</a></li><li><a href=https://www.datadoghq.com/blog/monitor-clickhouse/ target=_blank>Monitor ClickHouse with Datadog</a></li><li><a href="https://docs.google.com/spreadsheets/d/1K92yZr5slVQEvDglfZ88k_7bfsAKqahY9RPp_2tSdVU/edit#gid=521173956" target=_blank>Unsorted notes on monitor and Alerts</a></li><li><a href=https://intl.cloud.tencent.com/document/product/1026/36887 target=_blank>https://intl.cloud.tencent.com/document/product/1026/36887</a></li><li><a href=https://www.tinybird.co/blog/what-i-learned-operating-clickhouse-part-ii target=_blank>Tinybird experience (scroll to monitoring section)</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-199cb1e25e9c6fa0e0312726a5acd246>40 - ClickHouse® versions</h1><div class=lead>ClickHouse® versions</div><h2 id=clickhouse-versioning-schema>ClickHouse® versioning schema</h2><p><img alt="ClickHouse Version Breakdown" src=/assets/illyustraciya_bez_nazvaniya.png></p><p>Example:</p><p>21.3.10.1-lts</p><ol><li>21 is the year of release.</li><li>3 indicates a Feature Release. This is an increment where features are delivered.</li><li>10 is the bugfix / maintenance version. When that version is incremented it means that some bugs was fixed comparing to 21.3.9.</li><li>1 - build number, means nothing for end users.</li><li>lts - type of release. (long time support).</li></ol><h3 id=what-is-altinity-stable-version>What is Altinity Stable version?</h3><p>It is one of general / public version of ClickHouse which has passed some extra testings, the upgrade path and changelog was analyzed, known issues are documented, and at least few big companies use it on production. All those things take some time, so usually that means that Altinity Stable is always a &lsquo;behind&rsquo; the main releases.</p><p>Altinity version - is an option for conservative users, who prefer bit older but better known things.</p><p>Usually there is no reason to use version older than Altinity Stable. If you see that new Altinity Version arrived and you still use some older version - you should for sure consider an upgrade.</p><p>Additionally for Altinity client we provide extra support for those version for a longer time (and we also support newer versions).</p><h3 id=which-version-should-i-use>Which version should I use?</h3><p>We recommend the following approach:</p><ol><li>When you start using ClickHouse and before you go on production - pick the latest stable version.</li><li>If you already have ClickHouse running on production:<ol><li>Check all the new queries / schemas on the staging first, especially if some new ClickHouse features are used.</li><li>Do minor (bugfix) upgrades regularly: monitor new maintenance releases of the feature release you use.</li><li>When considering upgrade - check <a href=https://docs.altinity.com/altinitystablerelease/ target=_blank>Altinity Stable release docs</a>
, if you want to use newer release - analyze changelog and known issues.</li><li>Check latest stable or test versions of ClickHouse on your staging environment regularly and pass the feedback to us or on the <a href=https://github.com/ClickHouse/ClickHouse target=_blank>official ClickHouse github</a>
.</li><li>Consider blue/green or canary upgrades.</li></ol></li></ol><p>See also: <a href=https://clickhouse.tech/docs/en/faq/operations/production/ target=_blank rel=nofollow>https://clickhouse.tech/docs/en/faq/operations/production/</a></p><h2 id=how-do-i-upgrade>How do I upgrade?</h2><p>Follow this KB article for <a href=https://kb.altinity.com/upgrade/ target=_blank>ClickHouse version upgrade</a></p><h2 id=bugs>Bugs?</h2><p>ClickHouse development process goes in a very high pace and has already thousands of features. CI system doing tens of thousands of tests (including tests with different sanitizers) against every commit.</p><p>All core features are well-tested, and very stable, and code is high-quality. But as with any other software bad things may happen. Usually the most of bugs happens in the new, freshly added functionality, and in some complex combination of several features (of course all possible combinations of features just physically can’t be tested). Usually new features are adopted by the community and stabilize quickly.</p><h3 id=what-should-i-do-if-i-found-a-bug-in-clickhouse>What should I do if I found a bug in ClickHouse?</h3><ol><li>First of all: try to upgrade to the latest bugfix release Example: if you use v21.3.5.42-lts but you know that v21.3.10.1-lts already exists - start with upgrade to that. Upgrades to latest maintenance releases are smooth and safe.</li><li>Look for similar issues in github. Maybe the fix is on the way.</li><li>If you can reproduce the bug: try to isolate it - remove some pieces of query one-by-one / simplify the scenario until the issue still reproduces. This way you can figure out which part is responsible for that bug, and you can try to create <a href=https://stackoverflow.com/help/minimal-reproducible-example target=_blank>minimal reproducible example</a></li><li>Once you have minimal reproducible example:<ol><li>report it to github (or to Altinity Support)</li><li>check if it reproduces on newer ClickHouse versions</li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-51b1a2dc10fa414bfbbc21dc14811f6f>41 - Configure ClickHouse® for low memory environments</h1><div class=lead>Configure ClickHouse® for low memory environments</div><p>While Clickhouse® it&rsquo;s typically deployed on powerful servers with ample memory and CPU, it can be deployed in resource-constrained environments like a Raspberry Pi. Whether you&rsquo;re working on edge computing, IoT data collection, or simply experimenting with ClickHouse in a small-scale setup, running it efficiently on low-memory hardware can be a rewarding challenge.</p><p>TLDR;</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- config.xml --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- These settinsg should allow to run clickhouse in nodes with 4GB/8GB RAM --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>&lt;!-- disable some optional components/tables --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;mysql_port</span> <span style=color:#c4a000>remove=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;postgresql_port</span> <span style=color:#c4a000>remove=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>  
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;query_thread_log</span> <span style=color:#c4a000>remove=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;opentelemetry_span_log</span> <span style=color:#c4a000>remove=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;processors_profile_log</span> <span style=color:#c4a000>remove=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>&lt;!-- disable mlock, allowing binary pages to be unloaded from RAM, relying on Linux defaults --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;mlock_executable&gt;</span>false<span style=color:#204a87;font-weight:700>&lt;/mlock_executable&gt;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>&lt;!-- decrease the cache sizes --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;mark_cache_size&gt;</span>268435456<span style=color:#204a87;font-weight:700>&lt;/mark_cache_size&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- 256 MB --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;index_mark_cache_size&gt;</span>67108864<span style=color:#204a87;font-weight:700>&lt;/index_mark_cache_size&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- 64 MB --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;uncompressed_cache_size&gt;</span>16777216<span style=color:#204a87;font-weight:700>&lt;/uncompressed_cache_size&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- 16 MB --&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>&lt;!-- control the concurrency --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;max_thread_pool_size&gt;</span>2000<span style=color:#204a87;font-weight:700>&lt;/max_thread_pool_size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;max_connections&gt;</span>64<span style=color:#204a87;font-weight:700>&lt;/max_connections&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;max_concurrent_queries&gt;</span>8<span style=color:#204a87;font-weight:700>&lt;/max_concurrent_queries&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;max_server_memory_usage_to_ram_ratio&gt;</span>0.75<span style=color:#204a87;font-weight:700>&lt;/max_server_memory_usage_to_ram_ratio&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- 75% of the RAM, leave more for the system --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;max_server_memory_usage&gt;</span>0<span style=color:#204a87;font-weight:700>&lt;/max_server_memory_usage&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- We leave the overcommiter to manage available ram for queries--&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>&lt;!-- reconfigure the main pool to limit the merges (those can create problems if the insert pressure is high) --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;background_pool_size&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/background_pool_size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;background_merges_mutations_concurrency_ratio&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/background_merges_mutations_concurrency_ratio&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;merge_tree&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;merge_max_block_size&gt;</span>1024<span style=color:#204a87;font-weight:700>&lt;/merge_max_block_size&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;max_bytes_to_merge_at_max_space_in_pool&gt;</span>1073741824<span style=color:#204a87;font-weight:700>&lt;/max_bytes_to_merge_at_max_space_in_pool&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- 1 GB max part--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;number_of_free_entries_in_pool_to_lower_max_size_of_merge&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/number_of_free_entries_in_pool_to_lower_max_size_of_merge&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;number_of_free_entries_in_pool_to_execute_mutation&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/number_of_free_entries_in_pool_to_execute_mutation&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;number_of_free_entries_in_pool_to_execute_optimize_entire_partition&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/number_of_free_entries_in_pool_to_execute_optimize_entire_partition&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>&lt;!-- Reduces memory usage during merges in system.metric_log table (enabled by default) by setting min_bytes_for_wide_part and vertical_merge_algorithm_min_bytes_to_activate to 128MB --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;min_bytes_for_wide_part&gt;</span>134217728<span style=color:#204a87;font-weight:700>&lt;/min_bytes_for_wide_part&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;vertical_merge_algorithm_min_bytes_to_activate&gt;</span>134217728<span style=color:#204a87;font-weight:700>&lt;/vertical_merge_algorithm_min_bytes_to_activate&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/merge_tree&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>&lt;!-- shrink all pools to minimum--&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;background_buffer_flush_schedule_pool_size&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/background_buffer_flush_schedule_pool_size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;background_merges_mutations_scheduling_policy&gt;</span>round_robin<span style=color:#204a87;font-weight:700>&lt;/background_merges_mutations_scheduling_policy&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;background_move_pool_size&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/background_move_pool_size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;background_fetches_pool_size&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/background_fetches_pool_size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;background_common_pool_size&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/background_common_pool_size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;background_schedule_pool_size&gt;</span>8<span style=color:#204a87;font-weight:700>&lt;/background_schedule_pool_size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;background_message_broker_schedule_pool_size&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/background_message_broker_schedule_pool_size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;background_distributed_schedule_pool_size&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/background_distributed_schedule_pool_size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;tables_loader_foreground_pool_size&gt;</span>0<span style=color:#204a87;font-weight:700>&lt;/tables_loader_foreground_pool_size&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;tables_loader_background_pool_size&gt;</span>0<span style=color:#204a87;font-weight:700>&lt;/tables_loader_background_pool_size&gt;</span>   
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- users.xml --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;profiles&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;max_threads&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/max_threads&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;max_block_size&gt;</span>8192<span style=color:#204a87;font-weight:700>&lt;/max_block_size&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;queue_max_wait_ms&gt;</span>1000<span style=color:#204a87;font-weight:700>&lt;/queue_max_wait_ms&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;max_execution_time&gt;</span>600<span style=color:#204a87;font-weight:700>&lt;/max_execution_time&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;input_format_parallel_parsing&gt;</span>0<span style=color:#204a87;font-weight:700>&lt;/input_format_parallel_parsing&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;output_format_parallel_formatting&gt;</span>0<span style=color:#204a87;font-weight:700>&lt;/output_format_parallel_formatting&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;max_bytes_before_external_group_by&gt;</span>3221225472<span style=color:#204a87;font-weight:700>&lt;/max_bytes_before_external_group_by&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- 3 GB --&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;max_bytes_before_external_sort&gt;</span>3221225472<span style=color:#204a87;font-weight:700>&lt;/max_bytes_before_external_sort&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- 3 GB --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/profiles&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><p>Some interesting settings to explain:</p><ul><li>Disabling both postgres/mysql interfaces will release some CPU/memory resources.</li><li>Disabling some system tables like <code>processor_profile_log</code>, <code>opentelemetry_span_log</code>, or <code>query_thread_log</code> will help reducing write amplification. Those tables write a lot of data very frequently. In a Raspi4 with 4 GB of RAM and a simple USB3.1 storage they can spend some needed resources.</li><li>Decrease mark caches. Defaults are 5GB and they are loaded into RAM (in newer versions this behavior of loading them completely in RAM can be tuned with a prewarm setting <a href=https://github.com/ClickHouse/ClickHouse/pull/71053 target=_blank>https://github.com/ClickHouse/ClickHouse/pull/71053</a>
) so better to reserve a reasonable amount of space in line with the total amount of RAM. For example for 4/8GB 256MB is a good value.</li><li>Tune server memory and leave 25% for OS ops (<code>max_server_memory_usage_to_ram_ratio</code>)</li><li>Tune the thread pools and queues for merges and mutations:<ul><li><code>merge_max_block_size</code> will reduce the number of rows per block when merging. Default is 8192 and this will reduce the memory usage of merges.</li><li>The <code>number_of_free_entries_in_pool</code> settings are very nice to tune how much concurrent merges are allowed in the queue. When there is less than specified number of free entries in pool , start to lower maximum size of merge to process (or to put in queue) or do not execute part mutations to leave free threads for regular merges . This is to allow small merges to process - not filling the pool with long running merges or multiple mutations. You can check clickhouse documentation to get more insights.</li></ul></li><li>Reduce the background pools and be conservative. In a Raspi4 with 4 cores and 4 GB or ram, background pool should be not bigger than the number of cores and even less if possible.</li><li>Tune some profile settings to enable disk spilling (<code>max_bytes_before_external_group_by</code> and <code>max_bytes_before_external_sort</code>) and reduce the number of threads per query plus enable queuing of queries (<code>queue_max_wait_ms</code>) if the <code>max_concurrent_queries</code> limit is exceeded. Also <code>max_block_size</code> is not usually touched but in this case we can lower it ro reduce RAM usage.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-0bbf5bd9eca8f96d4529ea56056d69c4>42 - Converting MergeTree to Replicated</h1><div class=lead>Adding replication to a table</div><p>To enable replication in a table that uses the <code>MergeTree</code> engine, you need to convert the engine to <code>ReplicatedMergeTree</code>. Options here are:</p><ol><li>Use<code>INSERT INTO foo_replicated SELECT * FROM foo</code>. (suitable for small tables)</li><li>Create table aside and attach all partition from the existing table then drop original table (uses hard links don&rsquo;t require extra disk space). <code>ALTER TABLE foo_replicated ATTACH PARTITION ID 'bar' FROM 'foo'</code> You can easily auto generate those commands using a query like: <code>SELECT DISTINCT 'ALTER TABLE foo_replicated ATTACH PARTITION ID \'' || partition_id || '\' FROM foo;' from system.parts WHERE table = 'foo';</code> See <a href=#example-for-option-2-above>the example below</a>
for details.</li><li>Do it &lsquo;in place&rsquo; using some file manipulation. see the procedure described here: <a href=https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/replication/#converting-from-mergetree-to-replicatedmergetree target=_blank rel=nofollow>https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/replication/#converting-from-mergetree-to-replicatedmergetree</a></li><li>Do a backup of MergeTree and recover as ReplicatedMergeTree. <a href=https://github.com/Altinity/clickhouse-backup/blob/master/Examples.md#how-to-convert-mergetree-to-replicatedmegretree target=_blank>https://github.com/Altinity/clickhouse-backup/blob/master/Examples.md#how-to-convert-mergetree-to-replicatedmegretree</a></li><li>Embedded command for recent Clickhouse versions - <a href=https://clickhouse.com/docs/en/sql-reference/statements/attach#attach-mergetree-table-as-replicatedmergetree target=_blank rel=nofollow>https://clickhouse.com/docs/en/sql-reference/statements/attach#attach-mergetree-table-as-replicatedmergetree</a></li></ol><h2 id=example-for-option-2-above>Example for option 2 above</h2><p>Note: <code>ATTACH PARTITION ID 'bar' FROM 'foo'</code> is practically free from a compute and disk space perspective. This feature utilizes filesystem hard-links and the fact that files are immutable in ClickHouse® (it&rsquo;s the core of the ClickHouse design, filesystem hard-links and such file manipulations are widely used).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>D</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toYYYYMM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>D</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>today</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>e8</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>today</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>e8</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌───</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>200000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo_replicated</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{database}/{table}/{shard}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toYYYYMM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>D</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STOP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MERGES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;ALTER TABLE foo_replicated ATTACH PARTITION ID \&#39;&#39; || partition_id || &#39;</span><span style=color:#a40000>\</span><span style=color:#4e9a06>&#39; FROM foo;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;foo&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;ALTER TABLE foo_replicated ATTACH PARTITION ID \&#39;&#39;, partition_id, &#39;</span><span style=color:#a40000>\</span><span style=color:#4e9a06>&#39; FROM foo;&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo_replicated</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;202111&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>                         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo_replicated</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;202201&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>                         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────────────────────────────────────────────────────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>q</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;SELECT DISTINCT &#39;ALTER TABLE foo_replicated ATTACH PARTITION ID \&#39;&#39; || partition_id || &#39;\&#39; FROM foo;&#39; from system.parts WHERE table = &#39;foo&#39; format TabSeparatedRaw&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>mn</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>START</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MERGES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo_replicated</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌───</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>200000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>rename</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo_old</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo_replicated</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- you can drop foo_old any time later, it&#39;s kinda a cheap backup, 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- it cost nothing until you insert a lot of additional data into foo_replicated
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-156c434f74af4cc1f5844eb80c8a1d57>43 - Data Migration</h1><div class=lead>Data Migration</div><h2 id=export--import-into-common-data-formats>Export & Import into common data formats</h2><p>Pros:</p><ul><li>Data can be inserted into any DBMS.</li></ul><p>Cons:</p><ul><li>Decoding & encoding of common data formats may be slower / require more CPU</li><li>The data size is usually bigger than ClickHouse® formats.</li><li>Some of the common data formats have limitations.</li></ul><div class="alert alert-info" role=alert><h4 class=alert-heading>Info</h4><p>The best approach to do that is using clickhouse-client, in that case, encoding/decoding of format happens client-side, while client and server speak clickhouse Native format (columnar & compressed).</p><p>In contrast: when you use HTTP protocol, the server do encoding/decoding and more data is passed between client and server.</p></div><h2 id=remoteremotesecure-or-clusterdistributed-table>remote/remoteSecure or cluster/Distributed table</h2><p>Pros:</p><ul><li>Simple to run.</li><li>It’s possible to change the schema and distribution of data between shards.</li><li>It’s possible to copy only some subset of data.</li><li>Needs only access to ClickHouse TCP port.</li></ul><p>Cons:</p><ul><li>Uses CPU / RAM (mostly on the receiver side)</li></ul><p>See details of both approaches in:</p><p><a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/remote-table-function/>remote-table-function.md</a></p><p><a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/distributed-table-cluster/>distributed-table-cluster.md</a></p><h2 id=manual-parts-moving-freeze--rsync--attach>Manual parts moving: freeze / rsync / attach</h2><p>Pros:</p><ul><li>Low CPU / RAM usage.</li></ul><p>Cons:</p><ul><li>Table schema should be the same.</li><li>A lot of manual operations/scripting.</li></ul><div class="alert alert-info" role=alert><h4 class=alert-heading>Info</h4>With some additional care and scripting, it’s possible to do cheap re-sharding on parts level.</div><p>See details in:</p><p><a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/rsync/>rsync.md</a></p><h2 id=clickhouse-backup>clickhouse-backup</h2><p>Pros:</p><ul><li>Low CPU / RAM usage.</li><li>Suitable to recover both schema & data for all tables at once.</li></ul><p>Cons:</p><ul><li>Table schema should be the same.</li></ul><p>Just create the backup on server 1, upload it to server 2, and restore the backup.</p><p>See <a href=https://github.com/Altinity/clickhouse-backup target=_blank>https://github.com/Altinity/clickhouse-backup</a></p><p><a href=https://altinity.com/blog/introduction-to-clickhouse-backups-and-clickhouse-backup target=_blank>https://altinity.com/blog/introduction-to-clickhouse-backups-and-clickhouse-backup</a></p><h2 id=fetch-from-zookeeper-path>Fetch from zookeeper path</h2><p>Pros:</p><ul><li>Low CPU / RAM usage.</li></ul><p>Cons:</p><ul><li>Table schema should be the same.</li><li>Works only when the source and the destination ClickHouse servers share the same zookeeper (without chroot)</li><li>Needs to access zookeeper and ClickHouse replication ports: (<code>interserver_http_port</code> or <code>interserver_https_port</code>)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FETCH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition_expr</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;path-in-zookeeper&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/fetch_alter_table/>alter table fetch detail</a></p><h2 id=using-the-replication-protocol-by-adding-a-new-replica>Using the replication protocol by adding a new replica</h2><p>Just make one more replica in another place.</p><p>Pros:</p><ul><li>Simple to setup</li><li>Data is consistent all the time automatically.</li><li>Low CPU and network usage should be tuned.</li></ul><p>Cons:</p><ul><li>Needs to reach both zookeeper client (2181) and ClickHouse replication ports: (<code>interserver_http_port</code> or <code>interserver_https_port</code>)</li><li>In case of cluster migration, zookeeper need’s to be migrated too.</li><li>Replication works both ways so new replica should be outside the main cluster.</li></ul><p>Check the details in:</p><p><a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/add_remove_replica/>Add a replica to a Cluster</a></p><h2 id=see-also>See also</h2><h3 id=github-issues>Github issues</h3><p><a href=https://github.com/ClickHouse/ClickHouse/issues/10943 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/10943</a>
<a href=https://github.com/ClickHouse/ClickHouse/issues/20219 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/20219</a>
<a href=https://github.com/ClickHouse/ClickHouse/pull/17871 target=_blank>https://github.com/ClickHouse/ClickHouse/pull/17871</a></p><h3 id=other-links>Other links</h3><p><a href=https://habr.com/ru/company/avito/blog/500678/ target=_blank>https://habr.com/ru/company/avito/blog/500678/</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-995190106d7ed9690cfa9cfd364aec72>43.1 - MSSQL bcp pipe to clickhouse-client</h1><div class=lead>Export from MSSQL to ClickHouse®</div><h2 id=how-to-pipe-data-to-clickhouse-from-bcp-export-tool-for-mssql-database>How to pipe data to ClickHouse® from bcp export tool for MSSQL database</h2><h3 id=prepare-tables>Prepare tables</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>LAPTOP.localdomain :<span style=color:#ce5c00;font-weight:700>)</span> CREATE TABLE tbl<span style=color:#ce5c00;font-weight:700>(</span>key UInt32<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span>MergeTree ORDER BY key<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@LAPTOP:/home/user# sqlcmd -U sa -P Password78
</span></span><span style=display:flex><span>1&gt; WITH t0<span style=color:#ce5c00;font-weight:700>(</span>i<span style=color:#ce5c00;font-weight:700>)</span> AS <span style=color:#ce5c00;font-weight:700>(</span>SELECT <span style=color:#0000cf;font-weight:700>0</span> UNION ALL SELECT 0<span style=color:#ce5c00;font-weight:700>)</span>, t1<span style=color:#ce5c00;font-weight:700>(</span>i<span style=color:#ce5c00;font-weight:700>)</span> AS <span style=color:#ce5c00;font-weight:700>(</span>SELECT <span style=color:#0000cf;font-weight:700>0</span> FROM t0 a, t0 b<span style=color:#ce5c00;font-weight:700>)</span>, t2<span style=color:#ce5c00;font-weight:700>(</span>i<span style=color:#ce5c00;font-weight:700>)</span> AS <span style=color:#ce5c00;font-weight:700>(</span>SELECT <span style=color:#0000cf;font-weight:700>0</span> FROM t1 a, t1 b<span style=color:#ce5c00;font-weight:700>)</span>, t3<span style=color:#ce5c00;font-weight:700>(</span>i<span style=color:#ce5c00;font-weight:700>)</span> AS <span style=color:#ce5c00;font-weight:700>(</span>SELECT <span style=color:#0000cf;font-weight:700>0</span> FROM t2 a, t2 b<span style=color:#ce5c00;font-weight:700>)</span>, t4<span style=color:#ce5c00;font-weight:700>(</span>i<span style=color:#ce5c00;font-weight:700>)</span> AS <span style=color:#ce5c00;font-weight:700>(</span>SELECT <span style=color:#0000cf;font-weight:700>0</span> FROM t3 a, t3 b<span style=color:#ce5c00;font-weight:700>)</span>, t5<span style=color:#ce5c00;font-weight:700>(</span>i<span style=color:#ce5c00;font-weight:700>)</span> AS <span style=color:#ce5c00;font-weight:700>(</span>SELECT <span style=color:#0000cf;font-weight:700>0</span> FROM t4 a, t3 b<span style=color:#ce5c00;font-weight:700>)</span>,n<span style=color:#ce5c00;font-weight:700>(</span>i<span style=color:#ce5c00;font-weight:700>)</span> AS <span style=color:#ce5c00;font-weight:700>(</span>SELECT ROW_NUMBER<span style=color:#ce5c00;font-weight:700>()</span> OVER<span style=color:#ce5c00;font-weight:700>(</span>ORDER BY <span style=color:#ce5c00;font-weight:700>(</span>SELECT 0<span style=color:#ce5c00;font-weight:700>))</span> FROM t5<span style=color:#ce5c00;font-weight:700>)</span> SELECT i INTO tbl FROM n WHERE i BETWEEN <span style=color:#0000cf;font-weight:700>1</span> AND <span style=color:#0000cf;font-weight:700>16777216</span>
</span></span><span style=display:flex><span>2&gt; GO
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>16777216</span> rows affected<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@LAPTOP:/home/user# sqlcmd -U sa -P Password78 -Q <span style=color:#4e9a06>&#34;SELECT count(*) FROM tbl&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-----------
</span></span><span style=display:flex><span>   <span style=color:#0000cf;font-weight:700>16777216</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> rows affected<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><h3 id=piping>Piping</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@LAPTOP:/home/user# mkfifo import_pipe
</span></span><span style=display:flex><span>root@LAPTOP:/home/user# bcp <span style=color:#4e9a06>&#34;SELECT * FROM tbl&#34;</span> queryout import_pipe -t, -c -b <span style=color:#0000cf;font-weight:700>200000</span> -U sa -P Password78 -S localhost <span style=color:#000;font-weight:700>&amp;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>1<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#0000cf;font-weight:700>6038</span>
</span></span><span style=display:flex><span>root@LAPTOP:/home/user#
</span></span><span style=display:flex><span>Starting copy...
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>2000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>3000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>4000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>5000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>6000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>7000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>8000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>9000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>10000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>11000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>12000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>13000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>14000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>15000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>16000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>17000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>18000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>19000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>20000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>21000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>22000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>23000</span>
</span></span><span style=display:flex><span>-- Enter
</span></span><span style=display:flex><span>root@LAPTOP:/home/user# cat import_pipe <span style=color:#000;font-weight:700>|</span> clickhouse-client --query <span style=color:#4e9a06>&#34;INSERT INTO tbl FORMAT CSV&#34;</span> <span style=color:#000;font-weight:700>&amp;</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>16769000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>16770000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>16771000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>16772000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>16773000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>16774000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>16775000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>16776000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1000</span> rows successfully bulk-copied to host-file. Total received: <span style=color:#0000cf;font-weight:700>16777000</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>16777216</span> rows copied.
</span></span><span style=display:flex><span>Network packet size <span style=color:#ce5c00;font-weight:700>(</span>bytes<span style=color:#ce5c00;font-weight:700>)</span>: <span style=color:#0000cf;font-weight:700>4096</span>
</span></span><span style=display:flex><span>Clock Time <span style=color:#ce5c00;font-weight:700>(</span>ms.<span style=color:#ce5c00;font-weight:700>)</span> Total     : <span style=color:#0000cf;font-weight:700>11540</span>  Average : <span style=color:#ce5c00;font-weight:700>(</span>1453831.5 rows per sec.<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>1<span style=color:#ce5c00;font-weight:700>]</span>-  Done                    bcp <span style=color:#4e9a06>&#34;SELECT * FROM tbl&#34;</span> queryout import_pipe -t, -c -b <span style=color:#0000cf;font-weight:700>200000</span> -U sa -P Password78 -S localhost
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2<span style=color:#ce5c00;font-weight:700>]</span>+  Done                    cat import_pipe <span style=color:#000;font-weight:700>|</span> clickhouse-client --query <span style=color:#4e9a06>&#34;INSERT INTO tbl FORMAT CSV&#34;</span>
</span></span></code></pre></div><h3 id=another-shell>Another shell</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@LAPTOP:/home/user# <span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#4e9a06>`</span>seq <span style=color:#0000cf;font-weight:700>1</span> 600<span style=color:#4e9a06>`</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> clickhouse-client -q <span style=color:#4e9a06>&#34;select count() from tbl&#34;</span><span style=color:#000;font-weight:700>;</span>sleep 1<span style=color:#000;font-weight:700>;</span>  <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1048545</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>4194180</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>6291270</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>9436905</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>11533995</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>13631085</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>16777216</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>16777216</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>16777216</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>16777216</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-11fb2857cf3b2c7a29cb57f3cb63eba6>43.2 - Add/Remove a new replica to a ClickHouse® cluster</h1><div class=lead>How to add/remove a new ClickHouse replica manually and using <code>clickhouse-backup</code></div><h2 id=add-nodesreplicas-to-a-clickhouse-cluster>ADD nodes/replicas to a ClickHouse® cluster</h2><p>To add some ClickHouse® replicas to an existing cluster if -30TB then better to use replication:</p><ul><li>don’t add the <code>remote_servers.xml</code> until replication is done.</li><li>Add these files and restart to limit bandwidth and avoid saturation (70% total bandwidth):</li></ul><p><a href=https://clickhouse.com/docs/en/operations/settings/settings/#max_replicated_fetches_network_bandwidth_for_server target=_blank rel=nofollow>Core Settings | ClickHouse Docs</a></p><p>💡 Do the <strong>Gbps to Bps</strong> math correctly. For 10G —> 1250MB/s —> 1250000000 B/s and change <code>max_replicated_*</code> settings accordingly:</p><ul><li>Nodes replicating from:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;profiles&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;max_replicated_sends_network_bandwidth_for_server&gt;</span>50000<span style=color:#204a87;font-weight:700>&lt;/max_replicated_sends_network_bandwidth_for_server&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;/profiles&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><ul><li>Nodes replicating to:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;profiles&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>&lt;max_replicated_fetches_network_bandwidth_for_server&gt;</span>50000<span style=color:#204a87;font-weight:700>&lt;/max_replicated_fetches_network_bandwidth_for_server&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&lt;/profiles&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><h3 id=manual-method-ddl>Manual method (DDL)</h3><ul><li>Create tables <code>manually</code> and be sure macros in all replicas are aligned with the ZK path. If zk path uses <code>{cluster}</code> then this method won’t work. ZK path should use <code>{shard}</code> and <code>{replica}</code> or <code>{uuid}</code> (if databases are Atomic) only.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- DDL for Databases
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;CREATE DATABASE &#34;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#34; ENGINE = &#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine_full</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;;&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>databases</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;system&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;information_schema&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;INFORMATION_SCHEMA&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OUTFILE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/tmp/databases.sql&#39;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSVRaw</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- DDL for tables and views
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>replaceRegexpOne</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>replaceOne</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>create_table_query</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;;&#39;</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;(&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;ON CLUSTER \&#39;</span><span style=color:#a40000>{</span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#a40000>}\</span><span style=color:#4e9a06>&#39; (&#39;</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;CREATE (TABLE|DICTIONARY|VIEW|LIVE VIEW|WINDOW VIEW)&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;CREATE \\1 IF NOT EXISTS&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tables</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;MaterializedView&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;system&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;information_schema&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;INFORMATION_SCHEMA&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>create_table_query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;.inner.%%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;.inner_id.%%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OUTFILE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/tmp/schema.sql&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>STDOUT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSVRaw</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>show_table_uuid_in_table_create_query_if_not_nil</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--- DDL only for materialized views
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>replaceRegexpOne</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>replaceOne</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>create_table_query</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;;&#39;</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;TO&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;ON CLUSTER \&#39;</span><span style=color:#a40000>{</span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#a40000>}\</span><span style=color:#4e9a06>&#39; TO&#39;</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;(CREATE MATERIALIZED VIEW)&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;\\1 IF NOT EXISTS&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tables</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;MaterializedView&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;system&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;information_schema&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;INFORMATION_SCHEMA&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>create_table_query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;.inner.%%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;.inner_id.%%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>		</span><span style=color:#000>as_select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OUTFILE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/tmp/schema.sql&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>APPEND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>STDOUT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSVRaw</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>show_table_uuid_in_table_create_query_if_not_nil</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This will generate the UUIDs in the CREATE TABLE definition, something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>insert_test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UUID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;51b41170-5192-4947-b13b-d4094c511f06&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLUSTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>id_order</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt16</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>id_plat</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>id_warehouse</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>id_product</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt16</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>order_type</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt16</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>order_status</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>datetime_order</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>units</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int16</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>total</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Float32</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/tables/{uuid}/{shard}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tuple</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id_order</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id_plat</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id_warehouse</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li>Copy both SQL to destination replica and execute</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>--host localhost --port 9000 -mn &lt; databases.sql
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>--host localhost --port 9000 -mn &lt; schema.sql
</span></span></span></code></pre></div><h3 id=using-clickhouse-backup>Using <code>clickhouse-backup</code></h3><ul><li>Before proceeding: check if you have <code>restore_schema_on_cluster</code> set; if it is, this procedure will drop tables with <code>ON CLUSTER</code>, which is not its intention! To verify:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ clickhouse-backup print-config<span style=color:#000;font-weight:700>|</span>grep restore_schema_on_cluster
</span></span><span style=display:flex><span>    restore_schema_on_cluster: <span style=color:#4e9a06>&#34;&#34;</span>
</span></span></code></pre></div><ul><li>Using <code>clickhouse-backup</code> to copy the schema of a replica to another is also convenient, and if <a href=/engines/altinity-kb-atomic-database-engine/>using Atomic database</a>
with <code>{uuid}</code> macros in <a href="https://www.youtube.com/watch?v=oHwhXc0re6k" target=_blank>ReplicatedMergeTree engines</a>
.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo -u clickhouse clickhouse-backup create --schema --rbac --named-collections rbac_and_schema
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># From the destination replica do this in 2 steps (for safety, keep --env=RESTORE_SCHEMA_ON_CLUSTER=):</span>
</span></span><span style=display:flex><span>$ sudo -u clickhouse clickhouse-backup restore --env<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>RESTORE_SCHEMA_ON_CLUSTER</span><span style=color:#ce5c00;font-weight:700>=</span> --rbac-only rbac_and_schema
</span></span><span style=display:flex><span>$ sudo -u clickhouse clickhouse-backup restore --env<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>RESTORE_SCHEMA_ON_CLUSTER</span><span style=color:#ce5c00;font-weight:700>=</span> --schema --named-collections rbac_and_schema
</span></span></code></pre></div><h3 id=using-altinity-operator>Using <code>altinity operator</code></h3><p>If there is at least one alive replica in the shard, you can remove PVCs and STS for affected nodes and trigger reconciliation. The operator will try to copy the schema from other replicas.</p><h3 id=check-that-schema-migration-was-successful-and-node-is-replicating>Check that schema migration was successful and node is replicating</h3><ul><li>To check that the schema migration has been <strong>successful</strong> query system.replicas:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>replica_is_active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicas</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Vertical</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li><p>Check how the replication process is performing using <a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-replication-queue/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-replication-queue/</a></p><ul><li>If there are many postponed tasks with the message:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>Not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>executing</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fetch</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000>_22719661_22719661_0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>because</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>fetches</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>already</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>executing</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>                                                                                                      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2023</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>06</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>then it is ok, the maximum replication slots are being used. Exceptions are not OK and should be investigated</p></li><li><p>If migration was successful and replication is working, then wait until the replication is finished. It may take some days, depending on how much data is being replicated. After this edit, the cluster configuration xml file for all replicas (<code>remote_servers.xml</code>), and add the new replica to the cluster.</p></li></ul><h3 id=possible-problems>Possible problems</h3><h4 id=exception-replica_already_exists><strong>Exception</strong> <code>REPLICA_ALREADY_EXISTS</code></h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>Code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>253</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Received</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>localhost</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>There</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>was</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>an</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dl</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ny2</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>vm</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>internal</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>io</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#000;font-weight:700>]:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>253</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Replica</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tables</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000>c3503c3</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ed3c</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000>cb3</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ef41b3aed0a8</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>replicas</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>dl</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ny2</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>vm</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>internal</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>io</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>already</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>REPLICA_ALREADY_EXISTS</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>official</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>build</span><span style=color:#000;font-weight:700>)).</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>REPLICA_ALREADY_EXISTS</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xxxx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>yyyy</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UUID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;3c3503c3-ed3c-443b-9cb3-ef41b3aed0a8&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><a href=/altinity-kb-setup-and-maintenance/altinity-kb-check-replication-ddl-queue/>The DDLs</a>
have been executed and some tables have been created and after that dropped but some left overs are left in ZK:</p><ul><li>If databases can be dropped then use <code>DROP DATABASE xxxxx SYNC</code></li><li>If databases cannot be dropped use <code>SYSTEM DROP REPLICA ‘replica_name’ FROM db.table</code></li></ul><h4 id=exception-table_already_exists><strong>Exception</strong> <code>TABLE_ALREADY_EXISTS</code></h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>Code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>57</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Received</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>localhost</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>There</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>was</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>an</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dl</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ny2</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>vm</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>internal</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>io</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#000;font-weight:700>]:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>57</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Directory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>store</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000>c3</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000>c3503c3</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ed3c</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000>cb3</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ef41b3aed0a8</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>already</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#000>TABLE_ALREADY_EXISTS</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>official</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>build</span><span style=color:#000;font-weight:700>)).</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>TABLE_ALREADY_EXISTS</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xxxx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>yyyy</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UUID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;3c3503c3-ed3c-443b-9cb3-ef41b3aed0a8&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLUSTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Tables have not been dropped correctly:</p><ul><li>If databases can be dropped then use <code>DROP DATABASE xxxxx SYNC</code></li><li>If databases cannot be dropped use:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;DROP TABLE &#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39; SYNC;&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tables</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;system&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;information_schema&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;INFORMATION_SCHEMA&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OUTFILE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/tmp/drop_tables.sql&#39;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSVRaw</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=tuning>Tuning</h3><ul><li>Sometimes replication goes very fast and if you have a tiered storage hot/cold you could run out of space, so for that it is interesting to:<ul><li>reduce fetches from 8 to 4</li><li>increase moves from 8 to 16</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;profiles&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>        
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;max_replicated_fetches_network_bandwidth_for_server&gt;</span>625000000<span style=color:#204a87;font-weight:700>&lt;/max_replicated_fetches_network_bandwidth_for_server&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;background_fetches_pool_size&gt;</span>4<span style=color:#204a87;font-weight:700>&lt;/background_fetches_pool_size&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;background_move_pool_size&gt;</span>16<span style=color:#204a87;font-weight:700>&lt;/background_move_pool_size&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/profiles&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div><ul><li>Also to monitor this with:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Move%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5050155</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>af4a</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>474</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>a07a</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>f2f7e95fb395</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>metric</span><span style=color:#a40000>─────────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>──────────────────────────────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackgroundMovePoolTask</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tasks</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackgroundProcessingPool</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>moves</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└────────────────────────┴───────┴──────────────────────────────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>164</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>dnieto</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>:)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Fetch%&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Fetch%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>992</span><span style=color:#000>cae2a</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>fb58</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>4150</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>a088</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>83273805</span><span style=color:#000>d0c4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>metric</span><span style=color:#a40000>────────────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>───────────────────────────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedFetch</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>being</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>fetched</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackgroundFetchesPoolTask</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>fetches</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>an</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>associated</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>background</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pool</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└───────────────────────────┴───────┴───────────────────────────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>163</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li>There are new tables in v23 <code>system.replicated_fetches</code> and <code>system.moves</code> check it out for more info.</li><li>if needed just stop replication using <code>SYSTEM STOP FETCHES</code> from the replicating nodes</li></ul><h2 id=remove-nodesreplicas-from-a-cluster>REMOVE nodes/Replicas from a Cluster</h2><ul><li>It is important to know which replica/node you want to remove to avoid problems. To check it you need to connect to a different replica/node that the one you want to remove. For instance we want to remove <code>arg_t04</code>, so we connected to replica <code>arg_t01</code>:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mapKeys</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>replica_is_active</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica_name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicas</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>replica_name</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arg_t01</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arg_t02</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arg_t03</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arg_t04</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li>After that (make sure you&rsquo;re connected to a replica different from the one that you want to remove, <code>arg_tg01</code>) and execute:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;arg_t04&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li>If by any chance you&rsquo;re connected to the same replica you want to remove then <strong><code>SYSTEM DROP REPLICA</code></strong> will not work.</li><li>BTW <code>SYSTEM DROP REPLICA</code> does not drop any tables and does not remove any data or metadata from disk, it will only remove metadata from Zookeeper/Keeper</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- What happens if executing system drop replica in the local replica to remove.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;arg_t04&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>017</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Received</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exception</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>305</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Received</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dnieto</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>zenbook</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lan</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9440</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>We</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>can</span><span style=color:#4e9a06>&#39;t drop local replica, please use `DROP TABLE` if you want to clean the data and drop this replica. (TABLE_WAS_NOT_DROPPED)
</span></span></span></code></pre></div><ul><li>After DROP REPLICA, we need to check that the replica is gone from the list or replicas:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mapKeys</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>replica_is_active</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica_name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicas</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>replica_name</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arg_t01</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arg_t02</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arg_t03</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- We should see there is no replica arg_t04
</span></span></span></code></pre></div><ul><li>Delete the replica in the cluster configuration: <code>remote_servers.xml</code> and shutdown the node/replica removed.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-49f38a883c7ec4fc908726a6854c7bbe>43.3 - clickhouse-copier</h1><div class=lead>clickhouse-copier</div><p>The description of the utility and its parameters, as well as examples of the config files that you need to create for the copier are in the official repo for the <a href=https://github.com/clickhouse/copier/ target=_blank>ClickHouse® copier utility</a></p><p>The steps to run a task:</p><ol><li><p>Create a config file for <code>clickhouse-copier</code> (zookeeper.xml)</p></li><li><p>Create a config file for the task (task1.xml)</p></li><li><p>Create the task in ZooKeeper and start an instance of <code>clickhouse-copier</code></p><p><code>clickhouse-copier --daemon --base-dir=/opt/clickhouse-copier --config=/opt/clickhouse-copier/zookeeper.xml --task-path=/clickhouse/copier/task1 --task-file=/opt/clickhouse-copier/task1.xml</code></p><p>If the node in ZooKeeper already exists and you want to change it, you need to add the <code>task-upload-force</code> parameter:</p><p><code>clickhouse-copier --daemon --base-dir=/opt/clickhouse-copier --config=/opt/clickhouse-copier/zookeeper.xml --task-path=/clickhouse/copier/task1 --task-file=/opt/clickhouse-copier/task1.xml --task-upload-force=1</code></p><p>If you want to run another instance of <code>clickhouse-copier</code> for the same task, you need to copy the config file (zookeeper.xml) to another server, and run this command:</p><p><code>clickhouse-copier --daemon --base-dir=/opt/clickhouse-copier --config=/opt/clickhouse-copier/zookeeper.xml --task-path=/clickhouse/copier/task1</code></p></li></ol><p>The number of simultaneously running instances is controlled be the <code>max_workers</code> parameter in your task configuration file. If you run more workers superfluous workers will sleep and log messages like this:</p><p><code>&lt;Debug> ClusterCopier: Too many workers (1, maximum 1). Postpone processing</code></p><h3 id=see-also>See also</h3><ul><li><a href=https://github.com/clickhouse/copier/ target=_blank>https://github.com/clickhouse/copier/</a></li><li>Никита Михайлов. Кластер ClickHouse ctrl-с ctrl-v. HighLoad++ Весна 2021 <a href=https://raw.githubusercontent.com/ClickHouse/clickhouse-presentations/master/highload2021/copier.pdf target=_blank>slides</a></li><li>21.7 have a huge bulk of fixes / improvements. <a href=https://github.com/ClickHouse/ClickHouse/pull/23518 target=_blank>https://github.com/ClickHouse/ClickHouse/pull/23518</a></li><li><a href=https://altinity.com/blog/2018/8/22/clickhouse-copier-in-practice target=_blank>https://altinity.com/blog/2018/8/22/clickhouse-copier-in-practice</a></li><li><a href=https://github.com/getsentry/snuba/blob/master/docs/clickhouse-copier.md target=_blank>https://github.com/getsentry/snuba/blob/master/docs/clickhouse-copier.md</a></li><li><a href=https://hughsite.com/post/clickhouse-copier-usage.html target=_blank>https://hughsite.com/post/clickhouse-copier-usage.html</a></li><li><a href=https://www.jianshu.com/p/c058edd664a6 target=_blank>https://www.jianshu.com/p/c058edd664a6</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e1f1d825521583c133a8d3bf2a72f6e7>43.3.1 - clickhouse-copier 20.3 and earlier</h1><div class=lead>clickhouse-copier 20.3 and earlier</div><p><code>clickhouse-copier</code> was created to move data between clusters.
It runs simple INSERT…SELECT queries and can copy data between tables with different engine parameters and between clusters with different number of shards.
In the task configuration file you need to describe the layout of the source and the target cluster, and list the tables that you need to copy. You can copy whole tables or specific partitions.
<code>clickhouse-copier</code> uses temporary distributed tables to select from the source cluster and insert into the target cluster.</p><h2 id=the-process-is-as-follows>The process is as follows</h2><ol><li>Process the configuration files.</li><li>Discover the list of partitions if not provided in the config.</li><li>Copy partitions one by one.<ol><li>Drop the partition from the target table if it’s not empty</li><li>Copy data from source shards one by one.<ol><li>Check if there is data for the partition on a source shard.</li><li>Check the status of the task in ZooKeeper.</li><li>Create target tables on all shards of the target cluster.</li><li>Insert the partition of data into the target table.</li></ol></li><li>Mark the partition as completed in ZooKeeper.</li></ol></li></ol><p>If there are several workers running simultaneously, they will assign themselves to different source shards.
If a worker was interrupted, another worker can be started to continue the task. The next worker will drop incomplete partitions and resume the copying.</p><h2 id=configuring-the-engine-of-the-target-table>Configuring the engine of the target table</h2><p><code>clickhouse-copier</code> uses the engine from the task configuration file for these purposes:</p><ul><li>to create target tables if they don’t exist.</li><li>PARTITION BY: to SELECT a partition of data from the source table, to DROP existing partitions from target tables.</li></ul><p><code>clickhouse-copier</code> does not support the old MergeTree format.
However, you can create the target tables manually and specify the engine in the task configuration file in the new format so that <code>clickhouse-copier</code> can parse it for its SELECT queries.</p><h2 id=how-to-monitor-the-status-of-running-tasks>How to monitor the status of running tasks</h2><p><code>clickhouse-copier</code> uses ZooKeeper to keep track of the progress and to communicate between workers.
Here is a list of queries that you can use to see what’s happening.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>--task-path /clickhouse/copier/task1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The task config
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8;text-decoration:underline>           
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>----------------------------+---------------------+--------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>description</span><span style=color:#f8f8f8;text-decoration:underline>                 </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2020</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>task_active_workers_version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2020</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>tables</span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>task_active_workers</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Running workers
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/task_active_workers&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The list of processed tables
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/tables&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The list of processed partitions
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/tables/&lt;table&gt;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#f8f8f8;text-decoration:underline>           
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-------+--------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>201909</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The status of a partition
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>                     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#f8f8f8;text-decoration:underline>           
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-------------------------+--------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>shards</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>partition_active_workers</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The status of source shards
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/shards&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8;text-decoration:underline>           
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-----+---------------------+--------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>37</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2019</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>49</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>29</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4907e613a878d5b7819f49cc367b9f3f>43.3.2 - clickhouse-copier 20.4 - 21.6</h1><div class=lead>clickhouse-copier 20.4 - 21.6</div><p><code>clickhouse-copier</code> was created to move data between clusters.
It runs simple <code>INSERT…SELECT</code> queries and can copy data between tables with different engine parameters and between clusters with different number of shards.
In the task configuration file you need to describe the layout of the source and the target cluster, and list the tables that you need to copy. You can copy whole tables or specific partitions.
<code>clickhouse-copier</code> uses temporary distributed tables to select from the source cluster and insert into the target cluster.</p><p>The behavior of <code>clickhouse-copier</code> was changed in 20.4:</p><ul><li>Now <code>clickhouse-copier</code> inserts data into intermediate tables, and after the insert finishes successfully <code>clickhouse-copier</code> attaches the completed partition into the target table. This allows for incremental data copying, because the data in the target table is intact during the process. <strong>Important note:</strong> ATTACH PARTITION respects the <code>max_partition_size_to_drop</code> limit. Make sure the <code>max_partition_size_to_drop</code> limit is big enough (or set to zero) in the destination cluster. If <code>clickhouse-copier</code> is unable to attach a partition because of the limit, it will proceed to the next partition, and it will drop the intermediate table when the task is finished (if the intermediate table is less than the <code>max_table_size_to_drop</code> limit). <strong>Another important note:</strong> ATTACH PARTITION is replicated. The attached partition will need to be downloaded by the other replicas. This can create significant network traffic between ClickHouse nodes. If an attach takes a long time, <code>clickhouse-copier</code> will log a timeout and will proceed to the next step.</li><li>Now <code>clickhouse-copier</code> splits the source data into chunks and copies them one by one. This is useful for big source tables, when inserting one partition of data can take hours. If there is an error during the insert <code>clickhouse-copier</code> has to drop the whole partition and start again. The <code>number_of_splits</code> parameter lets you split your data into chunks so that in case of an exception <code>clickhouse-copier</code> has to re-insert only one chunk of the data.</li><li>Now <code>clickhouse-copier</code> runs <code>OPTIMIZE target_table PARTITION ... DEDUPLICATE</code> for non-Replicated MergeTree tables. <strong>Important note:</strong> This is a very strange feature that can do more harm than good. We recommend to disable it by configuring the engine of the target table as Replicated in the task configuration file, and create the target tables manually if they are not supposed to be replicated. Intermediate tables are always created as plain MergeTree.</li></ul><h2 id=the-process-is-as-follows>The process is as follows</h2><ol><li>Process the configuration files.</li><li>Discover the list of partitions if not provided in the config.</li><li>Copy partitions one by one ** The metadata in ZooKeeper suggests the order described here.**<ol><li>Copy chunks of data one by one.<ol><li>Copy data from source shards one by one.<ol><li>Create intermediate tables on all shards of the target cluster.</li><li>Check the status of the chunk in ZooKeeper.</li><li>Drop the partition from the intermediate table if the previous attempt was interrupted.</li><li>Insert the chunk of data into the intermediate tables.</li><li>Mark the shard as completed in ZooKeeper</li></ol></li></ol></li><li>Attach the chunks of the completed partition into the target table one by one<ol><li>Attach a chunk into the target table.</li><li><strong>non-Replicated:</strong> Run OPTIMIZE target_table DEDUPLICATE for the partition on the target table.</li></ol></li></ol></li><li>Drop intermediate tables (may not succeed if the tables are bigger than <code>max_table_size_to_drop</code>).</li></ol><p>If there are several workers running simultaneously, they will assign themselves to different source shards.
If a worker was interrupted, another worker can be started to continue the task. The next worker will drop incomplete partitions and resume the copying.</p><h2 id=configuring-the-engine-of-the-target-table>Configuring the engine of the target table</h2><p><code>clickhouse-copier</code> uses the engine from the task configuration file for these purposes:</p><ul><li>to create target and intermediate tables if they don’t exist.</li><li>PARTITION BY: to SELECT a partition of data from the source table, to ATTACH partitions into target tables, to DROP incomplete partitions from intermediate tables, to OPTIMIZE partitions after they are attached to the target.</li><li>ORDER BY: to SELECT a chunk of data from the source table.</li></ul><p>Here is an example of SELECT that <code>clickhouse-copier</code> runs to get the sixth of ten chunks of data:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>the</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clause</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>a</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>the</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition_key</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cityHash64</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>the</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clause</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><code>clickhouse-copier</code> does not support the old MergeTree format.
However, you can create the intermediate tables manually with the same engine as the target tables (otherwise ATTACH will not work), and specify the engine in the task configuration file in the new format so that <code>clickhouse-copier</code> can parse it for SELECT, ATTACH PARTITION and DROP PARTITION queries.</p><p><strong>Important note</strong>: always configure engine as Replicated to disable OPTIMIZE … DEDUPLICATE (unless you know why you need <code>clickhouse-copier</code> to run OPTIMIZE … DEDUPLICATE).</p><h2 id=how-to-configure-the-number-of-chunks>How to configure the number of chunks</h2><p>The default value for <code>number_of_splits</code> is 10.
You can change this parameter in the <code>table</code> section of the task configuration file. We recommend setting it to 1 for smaller tables.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;cluster_push&gt;</span>target_cluster<span style=color:#204a87;font-weight:700>&lt;/cluster_push&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;database_push&gt;</span>target_database<span style=color:#204a87;font-weight:700>&lt;/database_push&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;table_push&gt;</span>target_table<span style=color:#204a87;font-weight:700>&lt;/table_push&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;number_of_splits&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/number_of_splits&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;engine&gt;</span>Engine=Replicated...<span style=color:#204a87;font-weight:700>&lt;engine&gt;</span>
</span></span></code></pre></div><h2 id=how-to-monitor-the-status-of-running-tasks>How to monitor the status of running tasks</h2><p><code>clickhouse-copier</code> uses ZooKeeper to keep track of the progress and to communicate between workers.
Here is a list of queries that you can use to see what’s happening.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>--task-path=/clickhouse/copier/task1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The task config
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8;text-decoration:underline>           
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>----------------------------+---------------------+--------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>description</span><span style=color:#f8f8f8;text-decoration:underline>                 </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>28</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>status</span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>28</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>task_active_workers_version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>tables</span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>47</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>47</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>task_active_workers</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Status
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/status&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Running workers
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/task_active_workers&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The list of processed tables
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/tables&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The list of processed partitions
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/tables/&lt;table&gt;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#f8f8f8;text-decoration:underline>           
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-------+--------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>202103</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>47</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>202102</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>202101</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>27</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>36</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>202012</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The status of a partition
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#f8f8f8;text-decoration:underline>           
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>---------------+--------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>piece_0</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>attach_is_done</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The status of a piece
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/piece_N&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>                           </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#f8f8f8;text-decoration:underline>           
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-------------------------------+--------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>shards</span><span style=color:#f8f8f8;text-decoration:underline>                         </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>is_dirty</span><span style=color:#f8f8f8;text-decoration:underline>                       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>51</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>partition_piece_active_workers</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>54</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>clean_start</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>54</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The status of source shards
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/piece_N/shards&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8;text-decoration:underline>           
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-----+---------------------+--------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>54</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2021</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-092d5c190f9504b9126ab5f7779a2089>43.3.3 - Kubernetes job for clickhouse-copier</h1><div class=lead>Kubernetes job for <code>clickhouse-copier</code></div><h1 id=clickhouse-copier-deployment-in-kubernetes><code>clickhouse-copier</code> deployment in kubernetes</h1><p><code>clickhouse-copier</code> can be deployed in a kubernetes environment to automate some simple backups or copy fresh data between clusters.</p><p>Some documentation to read:</p><ul><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/altinity-kb-clickhouse-copier/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/altinity-kb-clickhouse-copier/</a></li><li><a href=https://github.com/clickhouse/copier/ target=_blank>https://github.com/clickhouse/copier/</a></li></ul><h2 id=deployment>Deployment</h2><p>Use a kubernetes job is recommended but a simple pod can be used if you only want to execute the copy one time.</p><p>Just edit/change all the <code>yaml</code> files to your needs.</p><h3 id=1-create-the-pvc>1) Create the PVC:</h3><p>First create a namespace in which all the pods and resources are going to be deployed</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace clickhouse-copier
</span></span></code></pre></div><p>Then create the PVC using a <code>storageClass</code> gp2-encrypted class or use any other storageClass from other providers:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PersistentVolumeClaim</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copier-logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse-copier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>storageClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gp2-encrypted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>accessModes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>ReadWriteOnce</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>storage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>100Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>and deploy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n clickhouse-copier create -f ./kubernetes/copier-pvc.yaml
</span></span></code></pre></div><h3 id=2-create-the-configmap>2) Create the configmap:</h3><p>The configmap has both files <code>zookeeper.xml</code> and <code>task01.xml</code> with the zookeeper node listing and the parameters for the task respectively.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copier-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse-copier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>task01.xml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;clickhouse&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;logger&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;console&gt;true&lt;/console&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;log remove=&#34;remove&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;errorlog remove=&#34;remove&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;level&gt;trace&lt;/level&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;/logger&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;remote_servers&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;all-replicated&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;shard&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        &lt;replica&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;host&gt;clickhouse01.svc.cluster.local&lt;/host&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;port&gt;9000&lt;/port&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;user&gt;chcopier&lt;/user&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;password&gt;pass&lt;/password&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        &lt;/replica&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        &lt;replica&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;host&gt;clickhouse02.svc.cluster.local&lt;/host&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;port&gt;9000&lt;/port&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;user&gt;chcopier&lt;/user&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;password&gt;pass&lt;/password&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        &lt;/replica&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;/shard&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;/all-replicated&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;all-sharded&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;!-- &lt;secret&gt;&lt;/secret&gt; --&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;shard&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        &lt;replica&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;host&gt;clickhouse03.svc.cluster.local&lt;/host&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;port&gt;9000&lt;/port&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;user&gt;chcopier&lt;/user&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;password&gt;pass&lt;/password&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        &lt;/replica&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;/shard&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;shard&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        &lt;replica&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;host&gt;clickhouse03.svc.cluster.local&lt;/host&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;port&gt;9000&lt;/port&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;user&gt;chcopier&lt;/user&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                            &lt;password&gt;pass&lt;/password&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        &lt;/replica&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;/shard&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;/all-sharded&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;/remote_servers&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;max_workers&gt;1&lt;/max_workers&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;settings_pull&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;readonly&gt;1&lt;/readonly&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;/settings_pull&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;settings_push&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;readonly&gt;0&lt;/readonly&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;/settings_push&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;settings&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;connect_timeout&gt;3&lt;/connect_timeout&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;insert_distributed_sync&gt;1&lt;/insert_distributed_sync&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;/settings&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;tables&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;table_sales&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;cluster_pull&gt;all-replicated&lt;/cluster_pull&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;database_pull&gt;default&lt;/database_pull&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;table_pull&gt;fact_sales_event&lt;/table_pull&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;cluster_push&gt;all-sharded&lt;/cluster_push&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;database_push&gt;default&lt;/database_push&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;table_push&gt;fact_sales_event&lt;/table_push&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;engine&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        Engine=ReplicatedMergeTree(&#39;/clickhouse/{cluster}/tables/{shard}/fact_sales_event&#39;, &#39;{replica}&#39;)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        PARTITION BY toYYYYMM(timestamp)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        ORDER BY (channel_id, product_id)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                        SETTINGS index_granularity = 8192
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;/engine&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;sharding_key&gt;rand()&lt;/sharding_key&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;/table_ventas&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;/tables&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;/clickhouse&gt;</span><span style=color:#f8f8f8;text-decoration:underline>        
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>zookeeper.xml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;clickhouse&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;logger&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;level&gt;trace&lt;/level&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;size&gt;100M&lt;/size&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;count&gt;3&lt;/count&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;/logger&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;zookeeper&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;node&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;host&gt;zookeeper1.svc.cluster.local&lt;/host&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;port&gt;2181&lt;/port&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;/node&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;node&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;host&gt;zookeeper2.svc.cluster.local&lt;/host&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;port&gt;2181&lt;/port&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;/node&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;node&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;host&gt;zookeeper3.svc.cluster.local&lt;/host&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    &lt;port&gt;2181&lt;/port&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                &lt;/node&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;/zookeeper&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;/clickhouse&gt;</span><span style=color:#f8f8f8;text-decoration:underline>        
</span></span></span></code></pre></div><p>and deploy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n clickhouse-copier create -f ./kubernetes/copier-configmap.yaml
</span></span></code></pre></div><p>The <code>task01.xml</code> file has many parameters to take into account explained in the repo for <a href=https://github.com/clickhouse/copier/ target=_blank>clickhouse-copier</a>
. Important to note that it is needed a FQDN for the Zookeeper nodes and ClickHouse® server that are valid for the cluster. As the deployment creates a new namespace, it is recommended to use a FQDN linked to a service. For example <code>zookeeper01.svc.cluster.local</code>. This file should be adapted to both clusters topologies and to the needs of the user.</p><p>The <code>zookeeper.xml</code> file is pretty straightforward with a simple 3 node ensemble configuration.</p><h3 id=3-create-the-job>3) Create the job:</h3><p>Basically the job will download the official ClickHouse image and will create a pod with 2 containers:</p><ul><li><p>clickhouse-copier: This container will run the clickhouse-copier utility.</p></li><li><p>sidecar-logging: This container will be used to read the logs of the clickhouse-copier container for different runs (this part can be improved):</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>batch/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Job</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse-copier-test</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse-copier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># only for kubernetes 1.23</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># ttlSecondsAfterFinished: 86400</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse-copier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clickhouse/clickhouse-server:21.8</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#000>clickhouse-copier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- --<span style=color:#000>task-upload-force=1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- --<span style=color:#000>config-file=$(CH_COPIER_CONFIG)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- --<span style=color:#000>task-path=$(CH_COPIER_TASKPATH)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- --<span style=color:#000>task-file=$(CH_COPIER_TASKFILE)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- --<span style=color:#000>base-dir=$(CH_COPIER_BASEDIR)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CH_COPIER_CONFIG</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/var/lib/clickhouse/tmp/zookeeper.xml&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CH_COPIER_TASKPATH</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/clickhouse/copier/tasks/task01&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CH_COPIER_TASKFILE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/var/lib/clickhouse/tmp/task01.xml&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CH_COPIER_BASEDIR</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/var/lib/clickhouse/tmp&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>2048Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copier-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/lib/clickhouse/tmp/zookeeper.xml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>subPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>zookeeper.xml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copier-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/lib/clickhouse/tmp/task01.xml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>subPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>task01.xml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copier-logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/lib/clickhouse/tmp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sidecar-logger</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>busybox:1.35</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;/bin/sh&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;-c&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;tail&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;-n&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;1000&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;-f&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/tmp/copier-logs/clickhouse-copier*/*.log&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>512Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copier-logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/tmp/copier-logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copier-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>configMap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copier-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>items</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>zookeeper.xml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>zookeeper.xml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>task01.xml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>task01.xml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copier-logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>persistentVolumeClaim</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>claimName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copier-logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>restartPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Never</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>backoffLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Deploy and watch progress checking the logs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n clickhouse-copier logs &lt;podname&gt; sidecar-logging
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-775c97dd3622aad5380ef8cd9f7472ad>43.4 - Distributed table to ClickHouse® Cluster</h1><div class=lead>Shifting INSERTs to a standby cluster</div><p>In order to shift INSERTS to a standby cluster (for example increase zone availability or <a href=https://docs.altinity.com/operationsguide/availability-and-recovery/recovery-architecture/ target=_blank>disaster recovery</a>
) some ClickHouse® features can be used.</p><p>Basically we need to create a distributed table, a MV, rewrite the <code>remote_servers.xml</code> config file and tune some parameters.</p><p>Distributed engine information and parameters:
<a href=https://clickhouse.com/docs/en/engines/table-engines/special/distributed/ target=_blank rel=nofollow>https://clickhouse.com/docs/en/engines/table-engines/special/distributed/</a></p><h2 id=steps>Steps</h2><h3 id=create-a-distributed-table-in-the-source-cluster>Create a Distributed table in the source cluster</h3><p>For example, we should have a <code>ReplicatedMergeTree</code> table in which all inserts are falling. This table is the first step in our pipeline:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inserts_source</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLUSTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;source&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>column1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>column2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>.....</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/tables/{shard}/inserts_source&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toYYYYMM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>column2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>column1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>column2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This table lives in the source cluster and all INSERTS go there. In order to shift all INSERTS in the source cluster to destination cluster we can create a <code>Distributed</code> table that points to another <code>ReplicatedMergeTree</code> in the destination cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inserts_source_dist</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLUSTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;source&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>column1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>column2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>.....</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Distributed</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;destination&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserts_destination</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=create-a-materialized-view-to-shift-inserts-to-destination-cluster>Create a Materialized View to shift INSERTS to destination cluster:</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MATERIALIZED</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>shift_inserts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLUSTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;source&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inserts_source_dist</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inserts_source</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=create-a-replicatedmergetree-table-in-the-destination-cluster>Create a ReplicatedMergeTree table in the destination cluster:</h3><p>This is the table in the destination cluster that is pointed by the distributed table in the source cluster</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inserts_destination</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLUSTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;destination&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>column1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>column2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>.....</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/tables/{shard}/inserts_destination&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toYYYYMM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>column2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>column1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>column2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=rewrite-remote_serversxml>Rewrite remote_servers.xml:</h3><p>All the hostnames/FQDN from each replica/node must be accessible from both clusters. Also the remote_servers.xml from the source cluster should read like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;remote_servers&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;source&gt;</span>   
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>host03<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9000<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>host04<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9000<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/shard&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;destination&gt;</span>   
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>host01<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9000<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>host02<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9000<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/shard&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/destination&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;!-- If using a LB to shift inserts you need to use user and password and create MT destination table in an all-replicated cluster config --&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;destination_with_lb&gt;</span>   
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>load_balancer.xxxx.com<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9440<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;secure&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/secure&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;username&gt;</span>user<span style=color:#204a87;font-weight:700>&lt;/username&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;password&gt;</span>pass<span style=color:#204a87;font-weight:700>&lt;/password&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/shard&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/destination_with_lb&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;/remote_servers&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><h3 id=configuration-settings>Configuration settings</h3><p>Depending on your use case you can set the the distributed INSERTs to sync or <a href=/altinity-kb-queries-and-syntax/async-inserts/>async mode</a>
. This example is for async mode:
Put this config settings on the default profile. Check for more info about the possible modes:</p><p><a href=https://clickhouse.com/docs/en/operations/settings/settings#insert_distributed_sync target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/settings/settings#insert_distributed_sync</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>    ....
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;profiles&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>&lt;!-- StorageDistributed DirectoryMonitors try to batch individual inserts into bigger ones to increase performance --&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;distributed_directory_monitor_batch_inserts&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/distributed_directory_monitor_batch_inserts&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>&lt;!-- StorageDistributed DirectoryMonitors try to split batch into smaller in case of failures --&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;distributed_directory_monitor_split_batch_on_failure&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/distributed_directory_monitor_split_batch_on_failure&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>    .....
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/profiles&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6b8cf3862e661a5ba53de12323896812>43.5 - Fetch Alter Table</h1><div class=lead>Fetch Alter Table</div><h1 id=fetch-parts-from-zookeeper>FETCH Parts from Zookeeper</h1><p>This is a detailed explanation on how to move data by fetching partitions or parts between replicas</p><h3 id=get-partitions-by-database-and-table>Get partitions by database and table:</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>partition_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;db1&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;db2&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;dbn&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This query will return all the partitions and parts stored in this node for the databases and their tables.</p><h3 id=fetch-the-partitions>Fetch the partitions:</h3><p>Prior starting with the fetching process it is recommended to check the <code>system.detached_parts</code> table of the destination node. There is a chance that detached folders already contain some old parts, and you will have to remove them all before starting moving data. Otherwise you will attach those old parts together with the fetched parts. Also you could run into issues if there are detached folders with the same names as the ones you are fetching (not very probable, put possible). Simply delete the detached parts and continue with the process.</p><p>To fetch a partition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>tablename</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FETCH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>partition_id</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{shard}/{table}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The <code>FROM</code> path is from the zookeeper node and you have to specify the shard from you&rsquo;re <a href=https://clickhouse.com/docs/en/sql-reference/statements/alter/partition#alter_fetch-partition target=_blank rel=nofollow>fetching the partition</a>
. Next executing the DDL query:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>tablename</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>partition_id</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>will attach the partitions to a table. Again and because the process is manual, it is recommended to check that the fetched partitions are attached correctly and that there are no detached parts left. Check both <code>system.parts</code> and <code>system.detached_parts</code> tables.</p><h3 id=detach-tables-and-delete-replicas>Detach tables and delete replicas:</h3><p>If needed, after moving the data and checking that everything is sound, you can detach the tables and delete the replicas.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Required for DROP REPLICA
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>DETACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>  
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- This will remove everything from /table_path_in_z/replicas/replica_name
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- but not the data. You could reattach the table again and
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- restore the replica if needed. Get the zookeeper_path and replica_name from system.replicas
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;replica_name&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ZKPATH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/table_path_in_zk/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=query-to-generate-all-the-ddl>Query to generate all the DDL:</h3><p>With this query you can generate the DDL script that will do the fetch and attach operations for each table and partition.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;alter table &#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#4e9a06>&#39; FETCH PARTITION &#39;&#39;&#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#000>partition_id</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#4e9a06>&#39;&#39;&#39; FROM &#39;&#39;&#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#000>zookeeper_path</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#4e9a06>&#39;&#39;&#39;; &#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#4e9a06>&#39;alter table &#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#4e9a06>&#39; ATTACH PARTITION &#39;&#39;&#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#000>partition_id</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#4e9a06>&#39;&#39;&#39;;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INNER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicas</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;db1&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;db2&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;dbn&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>You could add an ORDER BY to manually make the list in the order you need, or use ORDER BY rand() to randomize it. You will then need to split the commands between the shards.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-384352a945ec192141ea6fb13e0f518f>43.6 - Remote table function</h1><div class=lead>Remote table function</div><h2 id=remote-table-function>remote(&mldr;) table function</h2><p>Suitable for moving up to hundreds of gigabytes of data.</p><p>With bigger tables recommended approach is to slice the original data by some <code>WHERE</code> condition, ideally - apply the condition on partitioning key, to avoid writing data to many partitions at once.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>staging_table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>(...)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>date</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2021-04-13&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>staging_table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>(...)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>date</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2021-04-12&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>staging_table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>(...)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>date</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2021-04-11&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>....</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>(...)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>staging_table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>date</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2021-04-11&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>....</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=q-can-it-create-a-bigger-load-on-the-source-system>Q. Can it create a bigger load on the source system?</h3><p>Yes, it may use disk read & network write bandwidth. But typically write speed is worse than the read speed, so most probably the receiver side will be a bottleneck, and the sender side will not be overloaded.</p><p>While of course it should be checked, every case is different.</p><h3 id=q-can-i-tune-insert-speed-to-make-it-faster>Q. Can I tune INSERT speed to make it faster?</h3><p>Yes, by the cost of extra memory usage (on the receiver side).</p><p>ClickHouse® tries to form blocks of data in memory and while one of limit: <code>min_insert_block_size_rows</code> or <code>min_insert_block_size_bytes</code> being hit, ClickHouse dump this block on disk. If ClickHouse tries to execute insert in parallel (<code>max_insert_threads > 1</code>), it would form multiple blocks at one time.<br>So maximum memory usage can be calculated like this: <code>max_insert_threads * first(min_insert_block_size_rows OR min_insert_block_size_bytes)</code></p><p>Default values:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>────────────────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_insert_block_size_rows</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1048545</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_insert_block_size_bytes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>268427520</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_insert_threads</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>or</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>means</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>that</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>is</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>run</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>parallel</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────────────────┴───────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Tune those settings depending on your table average row size and amount of memory which are safe to occupy by <code>INSERT SELECT</code> query.</p><h3 id=q-ive-got-the-error-all-connection-tries-failed>Q. I&rsquo;ve got the error &ldquo;All connection tries failed&rdquo;</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;server.from.remote.dc:9440&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;default.table&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;admin&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;password&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Received</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exception</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>519</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Received</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>localhost</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>All</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>attempts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>get</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>structure</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>failed</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Log</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>279</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>displayText</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>NetException</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>All</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>connection</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tries</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>failed</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Log</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>209</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>displayText</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>NetException</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>connect</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>out</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>192</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9440</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dc</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9440</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>official</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>build</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>209</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>displayText</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>NetException</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>connect</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>out</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>192</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9440</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dc</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9440</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>official</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>build</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>209</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>displayText</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>NetException</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>connect</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>out</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>192</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9440</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dc</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9440</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>official</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>build</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ol><li>Using remote(&mldr;) table function with secure TCP port (default values is 9440). There is remoteSecure() function for that.</li><li>High (>50ms) ping between servers, values for <code>connect_timeout_with_failover_ms,</code> <code>connect_timeout_with_failover_secure_ms</code> need&rsquo;s to be adjusted accordingly.</li></ol><p>Default values:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>────────────────────────────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>connect_timeout_with_failover_ms</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>connect_timeout_with_failover_secure_ms</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────────────────────────────┴───────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=example>Example</h3><pre tabindex=0><code>#!/bin/bash

table=&#39;...&#39;
database=&#39;bvt&#39;
local=&#39;...&#39;
remote=&#39;...&#39;
CH=&#34;clickhouse-client&#34;   # you may add auth here 
settings=&#34;  max_insert_threads=20, 
            max_threads=20, 
            min_insert_block_size_bytes = 536870912, 
            min_insert_block_size_rows = 16777216, 
            max_insert_block_size = 16777216,
            optimize_on_insert=0&#34;;

# need it to create temp table with same structure (suitable for attach)
params=$($CH -h $remote -q &#34;select partition_key,sorting_key,primary_key from system.tables where table=&#39;$table&#39; and database = &#39;$database&#39; &#34; -f TSV)
IFS=$&#39;\t&#39; read -r partition_key sorting_key primary_key &lt;&lt;&lt; $params

$CH -h $local \  # get list of source partitions
-q &#34;select distinct partition from system.parts where table=&#39;$table&#39; and database = &#39;$database&#39; &#34;

while read -r partition; do
# check that the partition is already copied
  if [ `$CH -h $remote -q &#34; select count() from system.parts table=&#39;$table&#39; and database = &#39;$database&#39; and partition=&#39;$partition&#39;&#34;` -eq 0 ] ; then
      $CH -n -h $remote -q &#34;
        create temporary table temp as $database.$table engine=MergeTree -- 23.3 required for temporary table
           partition by ($partition_key) primary key ($primary_key)  order by ($sorting_key);
        -- SYSTEM STOP MERGES temp; -- maybe....
        set $settings;
        insert into temp select * from remote($local,$database.$table) where _partition=&#39;$partition&#39;
        -- order by ($sorting_key) -- maybe....
        ;
        alter table $database.$table attach partition $partition from temp
  &#34;
  fi
done
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-69e50f36eba192534d9f891226a8196a>43.7 - Moving ClickHouse to Another Server</h1><div class=lead>Copying Multi-Terabyte Live ClickHouse to Another Server</div><p>When migrating a large, live ClickHouse cluster (multi-terabyte scale) to a new server or cluster, the goal is to minimize downtime while ensuring data consistency. A practical method is to use <strong>incremental <code>rsync</code></strong> in multiple passes, combined with ClickHouse’s replication features.</p><ol><li><strong>Prepare the new cluster</strong><ul><li>Ensure the new cluster is set up with its own ZooKeeper (or Keeper).</li><li>Configure ClickHouse but keep it stopped initially.</li><li>For clickhouse-operator instances, you can stop all pods by CHI definition:</li></ul></li></ol><pre tabindex=0><code>spec:
  stop: &#34;true&#34;
</code></pre><p>and attach volumes (PVC) to a service pod.</p><ol start=2><li><p><strong>Initial data sync</strong></p><p>Run a full recursive sync of the data directory from the old server to the new one:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rsync -ravlW --delete /var/lib/clickhouse/ user@new_host:/var/lib/clickhouse/
</span></span></code></pre></div><p>Explanation of flags:</p><ul><li><code>r</code>: recursive, includes all subdirectories.</li><li><code>a</code>: archive mode (preserves symlinks, permissions, timestamps, ownership, devices).</li><li><code>v</code>: verbose, shows progress.</li><li><code>l</code>: copy symlinks as symlinks.</li><li><code>W</code>: copy whole files instead of using rsync’s delta algorithm (faster for large DB files).</li><li>&ndash;delete: remove files from the destination that don’t exist on the source.</li></ul><p>If you plan to run several replicas on a new cluster, rsync data to all of them. To save the performance of production servers, you can copy data to 1 new replica and then use it as a source for others. You can start with a single replica and add more after switching, but it will take more time afterward, as additional replicas need to pull all the data.</p><p>Add &ndash;bwlimit=100000 to preserve the performance of the production cluster while copying a lot of data.</p><p>Consider shards as independent clusters.</p></li><li><p><strong>Incremental re-syncs</strong></p><ul><li>Repeat the <code>rsync</code> step multiple times while the old cluster is live.</li><li>Each subsequent run will copy only changes and reduce the final sync time.</li></ul></li><li><p><strong>Restore replication metadata</strong></p><ul><li>Start the new ClickHouse node(s).</li><li>Run <code>SYSTEM RESTORE REPLICA table_name</code> to rebuild replication metadata in ZooKeeper.</li></ul></li><li><p><strong>Test the application</strong></p><ul><li>Point your test environment to the new cluster.</li><li>Validate queries, schema consistency, and application behavior.</li></ul></li><li><p><strong>Final sync and switchover</strong></p><ul><li>Stop ClickHouse on the old cluster.</li><li>Immediately run a final incremental <code>rsync</code> to catch last-minute changes.</li><li>Reinitialize ZooKeeper/Keeper database (stop/clear snapshots/start).</li><li>Run <code>SYSTEM RESTORE REPLICA table_name</code> to rebuild replication metadata in ZooKeeper again.</li><li>Start ClickHouse on the new cluster and switch production traffic.</li><li>add more replicas as needed</li></ul></li></ol><p>NOTES:</p><ol><li>To restore metadata on all cluster nodes by a single command, use <code>ON CLUSTER</code> modifier for the RESTORE REPLICA command.</li><li>You can build a script to run restore replica commands over all replicated tables by query:</li></ol><pre tabindex=0><code>select &#39;SYSTEM RESTORE REPLICA &#39; || database || &#39;.&#39; || table || &#39; ON CLUSTER {cluster} ;&#39;
from system.tables
where engine ilike &#39;Replicated%&#39;
</code></pre><ol start=2><li>If you are using a mount point that differs from /var/lib/clickhouse/data, adjust the rsync command accordingly to point to the correct location. For example, suppose you reconfigure the storage path as follows in /etc/clickhouse-server/config.d/config.xml.</li></ol><pre tabindex=0><code>&lt;clickhouse&gt;
    &lt;!-- Path to data directory, with trailing slash. --&gt;
    &lt;path&gt;/data1/clickhouse/&lt;/path&gt;
    ...
&lt;/clickhouse&gt;
</code></pre><p>You&rsquo;ll need to use <code>/data1/clickhouse</code> instead of <code>/var/lib/clickhouse</code> in the rsync paths.</p><ol start=3><li>ClickHouse Docker container image does not have rsync installed. Add it using apt-get or run sidecar in k8s or run a service pod with volumes attached.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-ac091a7a3a7a23bf1a7c0acd539339ce>44 - DDLWorker and DDL queue problems</h1><div class=lead>Finding and troubleshooting problems in the <code>distributed_ddl_queue</code></div><p>DDLWorker is a subprocess (thread) of <code>clickhouse-server</code> that executes <code>ON CLUSTER</code> tasks at the node.</p><p>When you execute a DDL query with <code>ON CLUSTER mycluster</code> section, the query executor at the current node reads the cluster <code>mycluster</code> definition (remote_servers / system.clusters) and places tasks into Zookeeper znode <code>task_queue/ddl/...</code> for members of the cluster <code>mycluster</code>.</p><p>DDLWorker at all ClickHouse® nodes constantly check this <code>task_queue</code> for their tasks, executes them locally, and reports about the results back into <code>task_queue</code>.</p><p>The common issue is the different hostnames/IPAddresses in the cluster definition and locally.</p><p>So if the initiator node puts tasks for a host named Host1. But the Host1 thinks about own name as localhost or <strong>xdgt634678d</strong> (internal docker hostname) and never sees tasks for the Host1 because is looking tasks for <strong>xdgt634678d.</strong> The same with internal VS external IP addresses.</p><h2 id=ddlworker-thread-crashed>DDLWorker thread crashed</h2><p>That causes ClickHouse to stop executing <code>ON CLUSTER</code> tasks.</p><p>Check that DDLWorker is alive:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ps -eL<span style=color:#000;font-weight:700>|</span>grep DDL
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>18829</span> <span style=color:#0000cf;font-weight:700>18876</span> ?        00:00:00 DDLWorkerClnr
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>18829</span> <span style=color:#0000cf;font-weight:700>18879</span> ?        00:00:00 DDLWorker
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ps -ef<span style=color:#000;font-weight:700>|</span>grep 18829<span style=color:#000;font-weight:700>|</span>grep -v grep
</span></span><span style=display:flex><span>clickho+ <span style=color:#0000cf;font-weight:700>18829</span> <span style=color:#0000cf;font-weight:700>18828</span>  <span style=color:#0000cf;font-weight:700>1</span> Feb09 ?        00:55:00 /usr/bin/clickhouse-server --con...
</span></span></code></pre></div><p>As you can see there are two threads: <code>DDLWorker</code> and <code>DDLWorkerClnr</code>.</p><p>The second thread – <code>DDLWorkerCleaner</code> cleans old tasks from <code>task_queue</code>. You can configure how many recent tasks to store:</p><pre tabindex=0><code class=language-markup data-lang=markup>config.xml
&lt;yandex&gt;
    &lt;distributed_ddl&gt;
        &lt;path&gt;/clickhouse/task_queue/ddl&lt;/path&gt;
        &lt;pool_size&gt;1&lt;/pool_size&gt;
        &lt;max_tasks_in_queue&gt;1000&lt;/max_tasks_in_queue&gt;
        &lt;task_max_lifetime&gt;604800&lt;/task_max_lifetime&gt;
        &lt;cleanup_delay_period&gt;60&lt;/cleanup_delay_period&gt;
    &lt;/distributed_ddl&gt;
&lt;/yandex&gt;
</code></pre><p>Default values:</p><p><strong>cleanup_delay_period</strong> = 60 seconds – Sets how often to start cleanup to remove outdated data.</p><p><strong>task_max_lifetime</strong> = 7 * 24 * 60 * 60 (in seconds = week) – Delete task if its age is greater than that.</p><p><strong>max_tasks_in_queue</strong> = 1000 – How many tasks could be in the queue.</p><p><strong>pool_size</strong> = 1 - How many ON CLUSTER queries can be run simultaneously.</p><h2 id=too-intensive-stream-of-on-cluster-command>Too intensive stream of ON CLUSTER command</h2><p>Generally, it&rsquo;s a bad design, but you can increase pool_size setting</p><h2 id=stuck-ddl-tasks-in-the-distributed_ddl_queue>Stuck DDL tasks in the distributed_ddl_queue</h2><p>Sometimes <a href=/altinity-kb-setup-and-maintenance/altinity-kb-ddlworker/>DDL tasks</a>
(the ones that use ON CLUSTER) can get stuck in the <code>distributed_ddl_queue</code> because the replicas can overload if multiple DDLs (thousands of CREATE/DROP/ALTER) are executed at the same time. This is very normal in heavy ETL jobs.This can be detected by checking the <code>distributed_ddl_queue</code> table and see if there are tasks that are not moving or are stuck for a long time.</p><p>If these DDLs are completed in some replicas but failed in others, the simplest way to solve this is to execute the failed command in the missed replicas without ON CLUSTER. If most of the DDLs failed, then check the number of unfinished records in <code>distributed_ddl_queue</code> on the other nodes, because most probably it will be as high as thousands.</p><p>First, backup the <code>distributed_ddl_queue</code> into a table so you will have a snapshot of the table with the states of the tasks. You can do this with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>system_distributed_ddl_queue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>distributed_ddl_queue</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>After this, we need to check from the backup table which tasks are not finished and execute them manually in the missed replicas, and review the pipeline which do <code>ON CLUSTER</code> command and does not abuse them. There is a new <code>CREATE TEMPORARY TABLE</code> command that can be used to avoid the <code>ON CLUSTER</code> command in some cases, where you need an intermediate table to do some operations and after that you can <code>INSERT INTO</code> the final table or do <code>ALTER TABLE final ATTACH PARTITION FROM TABLE temp</code> and this temp table will be dropped automatically after the session is closed.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-7f5f8971a74cdc0af853041c9dd18c8f>44.1 - There are N unfinished hosts (0 of them are currently active).</h1><div class=lead>There are N unfinished hosts (0 of them are currently active).</div><p>Sometimes your Distributed DDL queries are being stuck, and not executing on all or subset of nodes, there are a lot of possible reasons for that kind of behavior, so it would take some time and effort to investigate.</p><h2 id=possible-reasons>Possible reasons</h2><h3 id=clickhouse-node-cant-recognize-itself>ClickHouse® node can&rsquo;t recognize itself</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clusters</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- check is_local column, it should have 1 for itself
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>getent hosts clickhouse.local.net <span style=color:#8f5902;font-style:italic># or other name which should be local</span>
</span></span><span style=display:flex><span>hostname --fqdn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat /etc/hosts
</span></span><span style=display:flex><span>cat /etc/hostname
</span></span></code></pre></div><h3 id=debian--ubuntu>Debian / Ubuntu</h3><p>There is an issue in Debian based images, when hostname being mapped to 127.0.1.1 address which doesn&rsquo;t literally match network interface and ClickHouse fails to detect this address as local.</p><p><a href=https://github.com/ClickHouse/ClickHouse/issues/23504 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/23504</a></p><h4 id=previous-task-is-being-executed-and-taking-some-time>Previous task is being executed and taking some time</h4><p>It&rsquo;s usually some heavy operations like merges, mutations, alter columns, so it make sense to check those tables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PROCESSLIST</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>merges</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mutations</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>In that case, you can just wait completion of previous task.</p><h3 id=previous-task-is-stuck-because-of-some-error>Previous task is stuck because of some error</h3><p>In that case, the first step is to understand which exact task is stuck and why. There are some queries which can help with that.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- list of all distributed ddl queries, path can be different in your installation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- information about specific task.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;query-0000001000&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- 22.3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow_unrestricted_reads_from_keeper</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;true&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- 22.6
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow_unrestricted_reads_from_keeper</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;true&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- How many nodes executed this task
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numChildren</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>finished_nodes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;finished&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>─────┬─</span><span style=color:#000>finished_nodes</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>finished</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────┴────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- The nodes that are running the task
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/active/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- What was the result for the finished nodes 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ctime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/task_queue/ddl/query-0000001000/finished/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Latest successfull executed tasks from query_log.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_log</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%ddl_entry%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;cluster&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%MaxDDLEntryID%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>───────────────────┬─</span><span style=color:#000>metric</span><span style=color:#a40000>────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>───────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chi</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ab</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>svc</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MaxDDLEntryID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>1468</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Max</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>entry</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDLWorker</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>───────────────────┬─</span><span style=color:#000>metric</span><span style=color:#a40000>────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>───────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chi</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ab</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>svc</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MaxDDLEntryID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>1468</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Max</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>entry</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDLWorker</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>───────────────────┬─</span><span style=color:#000>metric</span><span style=color:#a40000>────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>───────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chi</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>ab</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>svc</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MaxDDLEntryID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>1468</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Max</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>entry</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DDLWorker</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Information about task execution from logs.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>grep</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87;font-weight:700>C</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;ddl_entry&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=issues-that-can-prevent-task-execution>Issues that can prevent task execution</h3><h4 id=obsolete-replicas>Obsolete Replicas</h4><p>Obsolete replicas left in zookeeper.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>zookeeper_path</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica_path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicas</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>total_replicas</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active_replicas</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/cluster/tables/01/database/table/replicas&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;replica_name&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STOP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICATION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>QUEUES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>START</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICATION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>QUEUES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><a href=https://clickhouse.tech/docs/en/sql-reference/statements/system/%5c#query_language-system-drop-replica target=_blank rel=nofollow>https://clickhouse.tech/docs/en/sql-reference/statements/system/#query_language-system-drop-replica</a></p><h4 id=tasks-manually-removed-from-ddl-queue>Tasks manually removed from DDL queue</h4><p>Task were removed from DDL queue, but left in Replicated*MergeTree table queue.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grep -C <span style=color:#0000cf;font-weight:700>40</span> <span style=color:#4e9a06>&#34;ddl_entry&#34;</span> /var/log/clickhouse-server/clickhouse-server*.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:28.956888 <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#0000cf;font-weight:700>599</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{}</span> &lt;Debug&gt; DDLWorker: Processing task query-0000211211 <span style=color:#ce5c00;font-weight:700>(</span>ALTER TABLE db.table_local ON CLUSTER <span style=color:#4e9a06>`</span>all-replicated<span style=color:#4e9a06>`</span> DELETE WHERE <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> 1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:29.053555 <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#0000cf;font-weight:700>599</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{}</span> &lt;Error&gt; DDLWorker: ZooKeeper error: Code: 999, e.displayText<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>=</span> Coordination::Exception: No node, Stack trace <span style=color:#ce5c00;font-weight:700>(</span>when copying this message, always include the lines below<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-0. Coordination::Exception::Exception<span style=color:#ce5c00;font-weight:700>(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const<span style=color:#000;font-weight:700>&amp;</span>, Coordination::Error, int<span style=color:#ce5c00;font-weight:700>)</span> @ 0xfb2f6b3 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-1. Coordination::Exception::Exception<span style=color:#ce5c00;font-weight:700>(</span>Coordination::Error<span style=color:#ce5c00;font-weight:700>)</span> @ 0xfb2fb56 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:2. DB::DDLWorker::createStatusDirs<span style=color:#ce5c00;font-weight:700>(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const<span style=color:#000;font-weight:700>&amp;</span>, std::__1::shared_ptr&lt;zkutil::ZooKeeper&gt; const<span style=color:#000;font-weight:700>&amp;</span><span style=color:#ce5c00;font-weight:700>)</span> @ 0xeb3127a in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:3. DB::DDLWorker::processTask<span style=color:#ce5c00;font-weight:700>(</span>DB::DDLTask<span style=color:#000;font-weight:700>&amp;</span><span style=color:#ce5c00;font-weight:700>)</span> @ 0xeb36c96 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:4. DB::DDLWorker::enqueueTask<span style=color:#ce5c00;font-weight:700>(</span>std::__1::unique_ptr&lt;DB::DDLTask, std::__1::default_delete&lt;DB::DDLTask&gt; &gt;<span style=color:#ce5c00;font-weight:700>)</span> @ 0xeb35f22 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-5. ? @ 0xeb47aed in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-6. ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::worker<span style=color:#ce5c00;font-weight:700>(</span>std::__1::__list_iterator&lt;ThreadFromGlobalPool, void*&gt;<span style=color:#ce5c00;font-weight:700>)</span> @ 0x8633bcd in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-7. ThreadFromGlobalPool::ThreadFromGlobalPool&lt;void ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::scheduleImpl&lt;void&gt;<span style=color:#ce5c00;font-weight:700>(</span>std::__1::function&lt;void <span style=color:#ce5c00;font-weight:700>()</span>&gt;, int, std::__1::optional&lt;unsigned long&gt;<span style=color:#ce5c00;font-weight:700>)</span>::<span style=color:#4e9a06>&#39;lambda1&#39;</span><span style=color:#ce5c00;font-weight:700>()</span>&gt;<span style=color:#ce5c00;font-weight:700>(</span>void<span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>, void ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::scheduleImpl&lt;void&gt;<span style=color:#ce5c00;font-weight:700>(</span>std::__1::function&lt;void <span style=color:#ce5c00;font-weight:700>()</span>&gt;, int, std::__1::optional&lt;unsigned long&gt;<span style=color:#ce5c00;font-weight:700>)</span>::<span style=color:#4e9a06>&#39;lambda1&#39;</span><span style=color:#ce5c00;font-weight:700>()&amp;&amp;</span>...<span style=color:#ce5c00;font-weight:700>)</span>::<span style=color:#4e9a06>&#39;lambda&#39;</span><span style=color:#ce5c00;font-weight:700>()</span>::operator<span style=color:#ce5c00;font-weight:700>()()</span> @ 0x863612f in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-8. ThreadPoolImpl&lt;std::__1::thread&gt;::worker<span style=color:#ce5c00;font-weight:700>(</span>std::__1::__list_iterator&lt;std::__1::thread, void*&gt;<span style=color:#ce5c00;font-weight:700>)</span> @ 0x8630ffd in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-9. ? @ 0x8634bb3 in /usr/bin/clickhouse
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-10. start_thread @ 0x9609 in /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log-11. __clone @ 0x122293 in /usr/lib/x86_64-linux-gnu/libc-2.31.so
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log- <span style=color:#ce5c00;font-weight:700>(</span>version 21.1.8.30 <span style=color:#ce5c00;font-weight:700>(</span>official build<span style=color:#ce5c00;font-weight:700>))</span>
</span></span><span style=display:flex><span>/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:29.053951 <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#0000cf;font-weight:700>599</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{}</span> &lt;Debug&gt; DDLWorker: Processing task query-0000211211 <span style=color:#ce5c00;font-weight:700>(</span>ALTER TABLE db.table_local ON CLUSTER <span style=color:#4e9a06>`</span>all-replicated<span style=color:#4e9a06>`</span> DELETE WHERE <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> 1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>Context of this problem is:</p><ul><li>Constant pressure of cheap ON CLUSTER DELETE queries.</li><li>One replica was down for a long amount of time (multiple days).</li><li>Because of pressure on the DDL queue, it purged old records due to the <code>task_max_lifetime</code> setting.</li><li>When a lagging replica comes up, it&rsquo;s fail&rsquo;s execute old queries from DDL queue, because at this point they were purged from it.</li></ul><p>Solution:</p><ul><li>Reload/Restore this replica from scratch.</li></ul><h4 id=ddl-path-was-changed-in-zookeeper-without-restarting-clickhouse>DDL path was changed in Zookeeper without restarting ClickHouse</h4><p>Changing the DDL queue path in Zookeeper without restarting ClickHouse will make ClickHouse confused. If you need to do this ensure that you restart ClickHouse before submitting additional distributed DDL commands. Here&rsquo;s an example.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Path before change:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/clickhouse101/task_queue&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>path</span><span style=color:#a40000>─────────────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse101</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>task_queue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────┴───────┴──────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Path after change
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/clickhouse/clickhouse101/task_queue&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>path</span><span style=color:#a40000>─────────────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ddl2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>clickhouse101</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>task_queue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────┴───────┴──────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The reason is that ClickHouse will not &ldquo;see&rdquo; this change and will continue to look for tasks in the old path. Altering paths in Zookeeper should be avoided if at all possible. If necessary it must be done <em>very carefully</em>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d3de9fe2d4264f8c0b10d27225d8c18c>45 - differential backups using clickhouse-backup</h1><div class=lead>differential backups using clickhouse-backup</div><h3 id=differential-backups-using-clickhouse-backup>differential backups using clickhouse-backup</h3><ol><li>Download the latest version of Altinity Backup for ClickHouse®: <a href=https://github.com/Altinity/clickhouse-backup/releases target=_blank>https://github.com/Altinity/clickhouse-backup/releases</a></li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ubuntu / debian</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wget https://github.com/Altinity/clickhouse-backup/releases/download/v2.5.20/clickhouse-backup_2.5.20_amd64.deb 
</span></span><span style=display:flex><span>sudo dpkg -i clickhouse-backup_2.5.20_amd64.deb 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># centos / redhat / fedora </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo yum install https://github.com/Altinity/clickhouse-backup/releases/download/v2.5.20/clickhouse-backup-2.5.20-1.x86_64.rpm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># other platforms</span>
</span></span><span style=display:flex><span>wget https://github.com/Altinity/clickhouse-backup/releases/download/v2.5.20/clickhouse-backup.tar.gz
</span></span><span style=display:flex><span>sudo mkdir /etc/clickhouse-backup/
</span></span><span style=display:flex><span>sudo mv clickhouse-backup/config.yml /etc/clickhouse-backup/config.yml.example
</span></span><span style=display:flex><span>sudo mv clickhouse-backup/clickhouse-backup /usr/bin/
</span></span><span style=display:flex><span>rm -rf clickhouse-backup clickhouse-backup.tar.gz
</span></span></code></pre></div><ol start=2><li>Create a runner script for the crontab</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /opt/clickhouse-backup-diff/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt; &#39;END&#39; &gt; /opt/clickhouse-backup-diff/clickhouse-backup-cron.sh
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>set +x
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>command_line_argument=$1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>backup_name=$(date +%Y-%M-%d-%H-%M-%S)
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>echo &#34;Creating local backup &#39;${backup_name}&#39; (full, using hardlinks)...&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>clickhouse-backup create &#34;${backup_name}&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>if [[ &#34;run_diff&#34; == &#34;${command_line_argument}&#34; &amp;&amp; &#34;2&#34; -le &#34;$(clickhouse-backup list local | wc -l)&#34; ]]; then
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  prev_backup_name=&#34;$(clickhouse-backup list local | tail -n 2 | head -n 1 | cut -d &#34; &#34; -f 1)&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  echo &#34;Uploading the backup &#39;${backup_name}&#39; as diff from the previous backup (&#39;${prev_backup_name}&#39;)&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  clickhouse-backup upload --diff-from &#34;${prev_backup_name}&#34; &#34;${backup_name}&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>elif [[ &#34;&#34; == &#34;${command_line_argument}&#34; ]]; then
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  echo &#34;Uploading the backup &#39;${backup_name}, and removing old unneeded backups&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  KEEP_BACKUPS_LOCAL=1 KEEP_BACKUPS_REMOTE=1 clickhouse-backup upload &#34;${backup_name}&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>fi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>END</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chmod +x /opt/clickhouse-backup-diff/clickhouse-backup-cron.sh
</span></span></code></pre></div><ol start=3><li>Create configuration for clickhouse-backup</li></ol><pre tabindex=0><code># Check the example: /etc/clickhouse-backup/config.yml.example 
vim /etc/clickhouse-backup/config.yml
</code></pre><ol start=4><li>Edit the crontab</li></ol><pre tabindex=0><code>crontab -e

# full backup at 0:00 Monday
0 0 * * 1 clickhouse /opt/clickhouse-backup-diff/clickhouse-backup-cron.sh
# differential backup every hour (except of 00:00) Monday 
0 1-23 * * 1 clickhouse /opt/clickhouse-backup-diff/clickhouse-backup-cron.sh run_diff
# differential backup every hour Sunday, Tuesday-Saturday
0 */1 * * 0,2-6 clickhouse /opt/clickhouse-backup-diff/clickhouse-backup-cron.sh run_diff
</code></pre><ol start=5><li>Recover the last backup:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>last_remote_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span>clickhouse-backup list remote <span style=color:#000;font-weight:700>|</span> tail -n <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#34; &#34;</span> -f 1<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>clickhouse-backup download <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>last_remote_backup</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>clickhouse-backup restore --rm <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>last_remote_backup</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-492a58dfa6abf818e811a55026049ff2>46 - High CPU usage in ClickHouse®</h1><div class=lead>Getting CPU usage under control</div><p>In general, it is a NORMAL situation for ClickHouse® that while processing a huge dataset it can use a lot of (or all of) the server resources. It is &lsquo;by design&rsquo; - just to make the answers faster.</p><p>The main directions to reduce the CPU usage <strong>is to review the schema / queries</strong> to limit the amount of the data which need to be processed, and to plan the resources in a way when single running query will not impact the others.</p><p>Any attempts to reduce the CPU usage will end up with slower queries!</p><h3 id=how-to-slow-down-queries-to-reduce-the-cpu-usage>How to slow down queries to reduce the CPU usage</h3><p>If it is acceptable for you - please check the following options for limiting the CPU usage:</p><ol><li><p>setting <code>max_threads</code>: reducing the number of threads that are allowed to use one request. Fewer threads = more free cores for other requests. By default, it&rsquo;s allowed to take half of the available CPU cores, adjust only when needed. So if if you have 10 cores then <code>max_threads = 10</code> will work about twice faster than <code>max_threads=5</code>, but will take 100% or CPU. (max_threads=5 will use half of CPUs so 50%).</p></li><li><p>setting <code>os_thread_priority</code>: increasing niceness for selected requests. In this case, the operating system, when choosing which of the running processes to allocate processor time, will prefer processes with lower niceness. 0 is the default niceness. The higher the niceness, the lower the priority of the process. The maximum niceness value is 19.</p></li></ol><p>These are custom settings that can be tweaked in several ways:</p><ol><li><p>by specifying them when connecting a client, for example</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>clickhouse-client --os_thread_priority<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>19</span> -q <span style=color:#4e9a06>&#39;SELECT max (number) from numbers (100000000)&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#39;SELECT max(number) from numbers(100000000)&#39;</span> <span style=color:#000;font-weight:700>|</span> curl <span style=color:#4e9a06>&#39;http://localhost:8123/?os_thread_priority=19&#39;</span> --data-binary @-
</span></span></code></pre></div></li><li><p>via dedicated API / connection parameters in client libraries</p></li><li><p>using the SQL command SET (works only within the session)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>os_thread_priority</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>using different profiles of settings for different users. Something like</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;profiles&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;default&gt;</span>
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/default&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;lowcpu&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;os_thread_priority&gt;</span>19<span style=color:#204a87;font-weight:700>&lt;/os_thread_priority&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;max_threads&gt;</span>4<span style=color:#204a87;font-weight:700>&lt;/max_threads&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/lowcpu&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/profiles&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>&lt;!-- Users and ACL. --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;users&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;!-- If user name was not specified, &#39;default&#39; user is used. --&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;limited_user&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;password&gt;</span>123<span style=color:#204a87;font-weight:700>&lt;/password&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;networks&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;ip&gt;</span>::/0<span style=color:#204a87;font-weight:700>&lt;/ip&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/networks&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;profile&gt;</span>lowcpu<span style=color:#204a87;font-weight:700>&lt;/profile&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>&lt;!-- Quota for user. --&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;quota&gt;</span>default<span style=color:#204a87;font-weight:700>&lt;/quota&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/limited_user&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/users&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div></li></ol><p>There are also plans to introduce a system of more flexible control over the assignment of resources to different requests.</p><p>Also, if these are manually created queries, then you can try to discipline users by adding quotas to them (they can be formulated as &ldquo;you can read no more than 100GB of data per hour&rdquo; or &ldquo;no more than 10 queries&rdquo;, etc.)</p><p>If these are automatically generated queries, it may make sense to check if there is no way to write them in a more efficient way.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-55be77301bcff9aa2583091b11b429d0>47 - Load balancers</h1><div class=lead>Load balancers</div><p>In general - one of the simplest option to do load balancing is to implement it on the client side.</p><p>I.e. list several endpoints for ClickHouse® connections and add some logic to pick one of the nodes.</p><p>Many client libraries support that.</p><h2 id=clickhouse-native-protocol-port-9000>ClickHouse native protocol (port 9000)</h2><p>Currently there are no protocol-aware proxies for ClickHouse protocol, so the proxy / load balancer can work only on TCP level.</p><p>One of the best option for TCP load balancer is haproxy, also nginx can work in that mode.</p><p>Haproxy will pick one upstream when connection is established, and after that it will keep it connected to the same server until the client or server will disconnect (or some timeout will happen).</p><p>It can’t send different queries coming via a single connection to different servers, as he knows nothing about ClickHouse protocol and doesn&rsquo;t know when one query ends and another start, it just sees the binary stream.</p><p>So for native protocol, there are only 3 possibilities:</p><ol><li>close connection after each query client-side</li><li>close connection after each query server-side (currently there is only one setting for that - idle_connection_timeout=0, which is not exact what you need, but similar).</li><li>use a ClickHouse server with Distributed table as a proxy.</li></ol><h2 id=http-protocol-port-8123>HTTP protocol (port 8123)</h2><p>There are many more options and you can use haproxy / nginx / chproxy, etc.
chproxy give some extra ClickHouse-specific features, you can find a list of them at <a href=https://chproxy.org target=_blank>https://chproxy.org</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-a5bef820919d4f1ad9265cdefeca05f5>48 - memory configuration settings</h1><div class=lead>memory configuration settings</div><h2 id=max_memory_usage-single-query-memory-usage>max_memory_usage. Single query memory usage</h2><p>max_memory_usage - the maximum amount of memory allowed for <strong>a single query</strong> to take. By default, it&rsquo;s 10Gb. The default value is good, don&rsquo;t adjust it in advance.</p><p>There are scenarios when you need to relax the limit for particular queries (if you hit &lsquo;Memory limit (for query) exceeded&rsquo;), or use a lower limit if you need to discipline the users or increase the number of simultaneous queries.</p><h2 id=server-memory-usage>Server memory usage</h2><p>Server memory usage = constant memory footprint (used by different caches, dictionaries, etc) + sum of memory temporary used by running queries (a theoretical limit is a number of simultaneous queries multiplied by max_memory_usage).</p><p>Since 20.4 you can set up a global limit using the <code>max_server_memory_usage</code> setting. If <strong>something</strong> will hit that limit you will see &lsquo;Memory limit (total) exceeded&rsquo; in <strong>random places</strong>.</p><p>By default it 90% of the physical RAM of the server.
<a href=https://clickhouse.tech/docs/en/operations/server-configuration-parameters/settings/#max_server_memory_usage target=_blank rel=nofollow>https://clickhouse.tech/docs/en/operations/server-configuration-parameters/settings/#max_server_memory_usage</a>
<a href=https://github.com/ClickHouse/ClickHouse/blob/e5b96bd93b53d2c1130a249769be1049141ef386/programs/server/config.xml#L239-L250 target=_blank>https://github.com/ClickHouse/ClickHouse/blob/e5b96bd93b53d2c1130a249769be1049141ef386/programs/server/config.xml#L239-L250</a></p><p>You can decrease that in some scenarios (like you need to leave more free RAM for page cache or to some other software).</p><h3 id=limits>Limits?</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ilike</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%MemoryTotal%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>union</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>all</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toUInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>server_settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;max_server_memory_usage&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PrettyCompactMonoBlock</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=how-to-check-what-is-using-my-ram>How to check what is using my RAM?</h3><p><a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-who-ate-my-memory/>altinity-kb-who-ate-my-memory.md</a></p><h3 id=mark-cache>Mark cache</h3><p><a href=https://github.com/ClickHouse/clickhouse-presentations/blob/master/meetup39/mark-cache.pdf target=_blank>https://github.com/ClickHouse/clickhouse-presentations/blob/master/meetup39/mark-cache.pdf</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-94984fd09fca23975a3d97b23569608e>49 - Memory Overcommiter</h1><div class=lead>Enable Memory overcommiter instead of ussing <code>max_memory_usage</code> per query</div><h2 id=memory-overcommiter>Memory Overcommiter</h2><p>From version 22.2+ <a href=https://github.com/ClickHouse/ClickHouse/pull/31182 target=_blank>ClickHouse® was updated with enhanced Memory overcommit capabilities</a>
. In the past, queries were constrained by the <code>max_memory_usage</code> setting, imposing a rigid limitation. Users had the option to increase this limit, but it came at the potential expense of impacting other users during a single query. With the introduction of Memory overcommit, more memory-intensive queries can now execute, granted there are ample resources available. When the <a href=https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings#max_server_memory_usage target=_blank rel=nofollow>server reaches its maximum memory limit</a>
, ClickHouse identifies the most overcommitted queries and attempts to terminate them. It&rsquo;s important to note that the terminated query might not be the one causing the condition. If it&rsquo;s not, the query will undergo a waiting period to allow the termination of the high-memory query before resuming its execution. This setup ensures that low-memory queries always have the opportunity to run, while more resource-intensive queries can execute during server idle times when resources are abundant. Users have the flexibility to fine-tune this behavior at both the server and user levels.</p><p>If the memory overcommitter is not being used you&rsquo;ll get something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Received exception from server <span style=color:#ce5c00;font-weight:700>(</span>version 22.8.20<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>Code: 241. DB::Exception: Received from altinity.cloud:9440. DB::Exception: Received from chi-replica1-2-0:9000. DB::Exception: Memory limit <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span> query<span style=color:#ce5c00;font-weight:700>)</span> exceeded: would use 5.00 GiB <span style=color:#ce5c00;font-weight:700>(</span>attempt to allocate chunk of <span style=color:#0000cf;font-weight:700>4196736</span> bytes<span style=color:#ce5c00;font-weight:700>)</span>, maximum: 5.00 GiB. OvercommitTracker decision: Memory overcommit isn<span style=color:#4e9a06>&#39;t used. OvercommitTracker isn&#39;</span>t set.: <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avg_value_size_hint</span> <span style=color:#ce5c00;font-weight:700>=</span> 0, <span style=color:#000>avg_chars_size</span> <span style=color:#ce5c00;font-weight:700>=</span> 1, <span style=color:#000>limit</span> <span style=color:#ce5c00;font-weight:700>=</span> 8192<span style=color:#ce5c00;font-weight:700>)</span>: <span style=color:#204a87;font-weight:700>while</span> receiving packet from chi-replica1-1-0:9000: While executing Remote. <span style=color:#ce5c00;font-weight:700>(</span>MEMORY_LIMIT_EXCEEDED<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>So to enable Memory Overcommit you need to get rid of the <code>max_memory_usage</code> and <code>max_memory_usage_for_user</code> (set them to 0) and configure overcommit specific settings (<strong>usually defaults are ok, so read carefully the documentation</strong>)</p><ul><li><code>memory_overcommit_ratio_denominator</code>: It represents soft memory limit on the user level. This value is used to compute query overcommit ratio.</li><li><code>memory_overcommit_ratio_denominator_for_user</code>: It represents soft memory limit on the global level. This value is used to compute query overcommit ratio.</li><li><code>memory_usage_overcommit_max_wait_microseconds</code>: Maximum time thread will wait for memory to be freed in the case of memory overcommit. If timeout is reached and memory is not freed, exception is thrown</li></ul><p>Please check <a href=https://clickhouse.com/docs/en/operations/settings/memory-overcommit target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/settings/memory-overcommit</a></p><p>Also you will check/need to configure global memory server setting. These are by default:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;clickhouse&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>&lt;!-- when max_server_memory_usage is set to non-zero, max_server_memory_usage_to_ram_ratio is ignored--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;max_server_memory_usage&gt;</span>0<span style=color:#204a87;font-weight:700>&lt;/max_server_memory_usage&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;max_server_memory_usage_to_ram_ratio&gt;</span>0.8<span style=color:#204a87;font-weight:700>&lt;/max_server_memory_usage_to_ram_ratio&gt;</span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/clickhouse&gt;</span>
</span></span></code></pre></div><p>With these set, now if you execute some queries with bigger memory needs than your <code>max_server_memory_usage</code> you&rsquo;ll get something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Received exception from server <span style=color:#ce5c00;font-weight:700>(</span>version 22.8.20<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>Code: 241. DB::Exception: Received from altinity.cloud:9440. DB::Exception: Received from chi-test1-2-0:9000. DB::Exception: Memory limit <span style=color:#ce5c00;font-weight:700>(</span>total<span style=color:#ce5c00;font-weight:700>)</span> exceeded: would use 12.60 GiB <span style=color:#ce5c00;font-weight:700>(</span>attempt to allocate chunk of <span style=color:#0000cf;font-weight:700>4280448</span> bytes<span style=color:#ce5c00;font-weight:700>)</span>, maximum: 12.60 GiB. OvercommitTracker decision: Query was selected to stop by OvercommitTracker.: <span style=color:#204a87;font-weight:700>while</span> receiving packet from chi-replica1-2-0:9000: While executing Remote. <span style=color:#ce5c00;font-weight:700>(</span>MEMORY_LIMIT_EXCEEDED<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>This will allow you to know that the Overcommit memory tracker is set and working.</p><p>Also to note that maybe you don&rsquo;t need the Memory Overcommit system because with <code>max_memory_usage</code> per query you&rsquo;re ok.</p><p>The good thing about memory overcommit is that you let ClickHouse handle the memory limitations instead of doing it manually, but there may be some scenarios where you don&rsquo;t want to use it and using <code>max_memory_usage</code> or <code>max_memory_usage_for_user</code> is a better fit. For example, if your workload has a lot of small/medium queries that are not memory intensive and you need to run few memory intensive queries for some users with a fixed memory limit. This is a common scenario for <code>dbt</code> or other ETL tools that usually run big memory intensive queries.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-605ad2e3cca983282a1dbf9607bb550c>50 - Moving a table to another device</h1><div class=lead>Moving a table to another device.</div><p>Suppose we mount a new device at path <code>/mnt/disk_1</code> and want to move <code>table_4</code> to it.</p><ol><li>Create directory on new device for ClickHouse® data. /in shell <code>mkdir /mnt/disk_1/clickhouse</code></li><li>Change ownership of created directory to ClickHouse user. /in shell <code>chown -R clickhouse:clickhouse /mnt/disk_1/clickhouse</code></li><li>Create a special storage policy which should include both disks: old and new. /in shell</li></ol><pre tabindex=0><code class=language-markup data-lang=markup>nano /etc/clickhouse-server/config.d/storage.xml
###################/etc/clickhouse-server/config.d/storage.xml###########################
&lt;yandex&gt;
  &lt;storage_configuration&gt;
    &lt;disks&gt;
      &lt;!--
          default disk is special, it always
          exists even if not explicitly
          configured here, but you can&#39;t change
          it&#39;s path here (you should use &lt;path&gt;
          on top level config instead)
      --&gt;
      &lt;default&gt;
         &lt;!--
             You can reserve some amount of free space
             on any disk (including default) by adding
             keep_free_space_bytes tag
         --&gt;
      &lt;/default&gt;
      &lt;disk_1&gt; &lt;!-- disk name --&gt;
          &lt;path&gt;/mnt/disk_1/clickhouse/&lt;/path&gt;
      &lt;/disk_1&gt;
    &lt;/disks&gt;
    &lt;policies&gt;
      &lt;move_from_default_to_disk_1&gt; &lt;!-- name for new storage policy --&gt;
        &lt;volumes&gt;
          &lt;default&gt;
            &lt;disk&gt;default&lt;/disk&gt;
            &lt;max_data_part_size_bytes&gt;10000000&lt;/max_data_part_size_bytes&gt;
          &lt;/default&gt;
          &lt;disk_1_vol&gt; &lt;!-- name of volume --&gt;
            &lt;!--
                we have only one disk in that volume
                and we reference here the name of disk
                as configured above in &lt;disks&gt; section
            --&gt;
            &lt;disk&gt;disk_1&lt;/disk&gt;
          &lt;/disk_1_vol&gt;
        &lt;/volumes&gt;
        &lt;move_factor&gt;0.99&lt;/move_factor&gt;
      &lt;/move_from_default_to_disk_1&gt;
    &lt;/policies&gt;
  &lt;/storage_configuration&gt;
&lt;/yandex&gt;
#########################################################################################
</code></pre><ol><li>Update storage_policy setting of tables to new policy.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>MODIFY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage_policy</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;move_from_default_to_disk_1&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ol><li>Wait till all parts of tables change their disk_name to new disk.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;table_4&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_on_disk</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;table_4&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disk_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ol><li>Remove &lsquo;default&rsquo; disk from new storage policy. In server shell:</li></ol><pre tabindex=0><code class=language-markup data-lang=markup>nano /etc/clickhouse-server/config.d/storage.xml
###################/etc/clickhouse-server/config.d/storage.xml###########################
&lt;yandex&gt;
  &lt;storage_configuration&gt;
    &lt;disks&gt;
      &lt;!--
          default disk is special, it always
          exists even if not explicitly
          configured here, but you can&#39;t change
          it&#39;s path here (you should use &lt;path&gt;
          on top level config instead)
      --&gt;
      &lt;default&gt;
         &lt;!--
             You can reserve some amount of free space
             on any disk (including default) by adding
             keep_free_space_bytes tag
         --&gt;
      &lt;/default&gt;
      &lt;disk_1&gt; &lt;!-- disk name --&gt;
          &lt;path&gt;/mnt/disk_1/clickhouse/&lt;/path&gt;
      &lt;/disk_1&gt;
    &lt;/disks&gt;
    &lt;policies&gt;
      &lt;move_from_default_to_disk_1&gt; &lt;!-- name for new storage policy --&gt;
        &lt;volumes&gt;
          &lt;disk_1_vol&gt; &lt;!-- name of volume --&gt;
            &lt;!--
                we have only one disk in that volume
                and we reference here the name of disk
                as configured above in &lt;disks&gt; section
            --&gt;
            &lt;disk&gt;disk_1&lt;/disk&gt;
          &lt;/disk_1_vol&gt;
        &lt;/volumes&gt;
        &lt;move_factor&gt;0.99&lt;/move_factor&gt;
      &lt;/move_from_default_to_disk_1&gt;
    &lt;/policies&gt;
  &lt;/storage_configuration&gt;
&lt;/yandex&gt;
#########################################################################################
</code></pre><p>ClickHouse wouldn&rsquo;t auto reload config, because we removed some disks from storage policy, so we need to restart it by hand.</p><ol><li>Restart ClickHouse server.</li><li>Make sure that storage policy uses the right disks.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>storage_policies</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;move_from_default_to_disk_1&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-60329cb30d1cf552b84e2cee02de47b7>51 - Object consistency in a cluster</h1><div class=lead>Object consistency in a cluster</div><p>List of missing tables</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>groupArray</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>one</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hosts</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#000>arrayFilter</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>has</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>groupArray</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>),</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hosts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>miss_table</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>tables</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Log&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Memory&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;TinyLog&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>HAVING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>miss_table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#a40000>─┬─</span><span style=color:#000>miss_table</span><span style=color:#a40000>────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;host366.mynetwork.net&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────┴───────┴───────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>List of inconsistent tables</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniqExact</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>create_table_query</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tables</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>HAVING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>List of inconsistent columns</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>groupArray</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>one</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hosts</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#000>arrayStringConcat</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arrayMap</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#4e9a06>&#39;: &#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                                 </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>groupArray</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>)),</span><span style=color:#4e9a06>&#39;, &#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>diff</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>columns</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>HAVING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>length</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arrayDistinct</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>length</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>length</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>hosts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#a40000>─┬─</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#a40000>───┬─</span><span style=color:#204a87;font-weight:700>column</span><span style=color:#a40000>────┬─</span><span style=color:#000>diff</span><span style=color:#a40000>────────────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>z</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>host22</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>host21</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────┴─────────┴───────────┴─────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>List of inconsistent dictionaries</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>groupArray</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>one</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hosts</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>dictionary</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#000>arrayFilter</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>has</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>groupArray</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>),</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hosts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>miss_dict</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#000>arrayReduce</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;min&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>groupArray</span><span style=color:#000;font-weight:700>((</span><span style=color:#000>element_count</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ec</span><span style=color:#000;font-weight:700>).</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>min</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#000>arrayReduce</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;max&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>groupArray</span><span style=color:#000;font-weight:700>((</span><span style=color:#000>element_count</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ec</span><span style=color:#000;font-weight:700>).</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>dictionary</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>element_count</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterAllReplicas</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>dictionaries</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>dictionary</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>HAVING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>miss_dict</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>or</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>min</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>skip_unavailable_shards</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b4d9520dcb2feeb131e8e5640308a411>52 - Production Cluster Configuration Guide</h1><div class=lead>Production Cluster Configuration Guide</div><p>Moving from a single ClickHouse® server to a clustered format provides several benefits:</p><ul><li>Replication guarantees data integrity.</li><li>Provides redundancy.</li><li>Failover by being able to restart half of the nodes without encountering downtime.</li></ul><p>Moving from an unsharded ClickHouse environment to a sharded cluster requires redesign of schema and queries. Starting with a sharded cluster from the beginning makes it easier in the future to scale the cluster up.</p><p>Setting up a ClickHouse cluster for a production environment requires the following stages:</p><ul><li>Hardware Requirements</li><li>Network Configuration</li><li>Create Host Names</li><li>Monitoring Considerations</li><li>Configuration Steps</li><li>Setting Up Backups</li><li>Staging Plans</li><li>Upgrading The Cluster</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-202b7e3651622a4779b38f52cef739a7>52.1 - Backups</h1><div class=lead>Backups</div><p>ClickHouse® is currently at the design stage of creating some universal backup solution. Some custom backup strategies are:</p><ol><li>Each shard is backed up separately.</li><li>FREEZE the table/partition. For more information, see <a href=https://clickhouse.tech/docs/en/sql-reference/statements/alter/partition/#alter_freeze-partition target=_blank rel=nofollow>Alter Freeze Partition</a>
.<ol><li>This creates hard links in shadow subdirectory.</li></ol></li><li>rsync that directory to a backup location, then remove that subfolder from shadow.<ol><li>Cloud users are recommended to use <a href=https://rclone.org/ target=_blank>Rclone</a>
.</li></ol></li><li>Always add the full contents of the metadata subfolder that contains the current DB schema and ClickHouse configs to your backup.</li><li>For a second replica, it’s enough to copy metadata and configuration.</li><li>Data in ClickHouse is already compressed with lz4, backup can be compressed bit better, but avoid using cpu-heavy compression algorithms like gzip, use something like zstd instead.</li></ol><p>The tool automating that process: <a href=https://github.com/Altinity/clickhouse-backup target=_blank>Altinity Backup for ClickHouse</a>
.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8064c7d414e643fb87b3e0939260d98f>52.2 - Cluster Configuration FAQ</h1><div class=lead>Cluster Configuration FAQ</div><h2 id=clickhouse-does-not-start-some-other-unexpected-behavior-happening>ClickHouse® does not start, some other unexpected behavior happening</h2><p>Check ClickHouse logs, they are your friends:</p><p>tail -n 1000 /var/log/clickhouse-server/clickhouse-server.err.log | less
tail -n 10000 /var/log/clickhouse-server/clickhouse-server.log | less</p><h2 id=how-do-i-restrict-memory-usage>How Do I Restrict Memory Usage?</h2><p>See <a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-memory-configuration-settings/>our knowledge base article</a>
and <a href=https://clickhouse.tech/docs/en/operations/settings/query-complexity/#settings_max_memory_usage target=_blank rel=nofollow>official documentation</a>
for more information.</p><h2 id=clickhouse-died-during-big-query-execution>ClickHouse died during big query execution</h2><p>Misconfigured ClickHouse can try to allocate more RAM than is available on the system.</p><p>In that case an OS component called oomkiller can kill the ClickHouse process.</p><p>That event leaves traces inside system logs (can be checked by running dmesg command).</p><h2 id=how-do-i-make-huge-group-by-queries-use-less-ram>How Do I make huge ‘Group By’ queries use less RAM?</h2><p>Enable on disk GROUP BY (it is slower, so is disabled by default)</p><p>Set <a href=https://clickhouse.tech/docs/en/operations/settings/query-complexity/#settings-max_bytes_before_external_group_by target=_blank rel=nofollow>max_bytes_before_external_group_by</a>
to a value about 70-80% of your max_memory_usage value.</p><h2 id=data-returned-in-chunks-by-clickhouse-client>Data returned in chunks by clickhouse-client</h2><p>See <a href=http://kb.altinity.com/altinity-kb-interfaces/altinity-kb-clickhouse-client/>altinity-kb-clickhouse-client</a></p><h2 id=i-cant-connect-from-other-hosts--what-do-i-do>I Can’t Connect From Other Hosts. What do I do?</h2><p>Check the <listen>settings in config.xml. Verify that the connection can connect on both IPV4 and IPV6.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-839cbf636b5f8a35c6823f41977447f7>52.3 - Cluster Configuration Process</h1><div class=lead>Cluster Configuration Process</div><p>So you set up 3 nodes with zookeeper (zookeeper1, zookeeper2, zookeeper3 - <a href=https://docs.altinity.com/operationsguide/clickhouse-zookeeper/ target=_blank>How to install zookeeper?</a>
), and and 4 nodes with ClickHouse® (clickhouse-sh1r1,clickhouse-sh1r2,clickhouse-sh2r1,clickhouse-sh2r2 - <a href=https://docs.altinity.com/altinitystablerelease/stablequickstartguide/ target=_blank>how to install ClickHouse?</a>
). Now we need to make them work together.</p><p>Use ansible/puppet/salt or other systems to control the servers’ configurations.</p><ol><li>Configure ClickHouse access to Zookeeper by adding the file zookeeper.xml in /etc/clickhouse-server/config.d/ folder. This file must be placed on all ClickHouse servers.</li></ol><pre tabindex=0><code class=language-markup data-lang=markup>&lt;yandex&gt;
    &lt;zookeeper&gt;
        &lt;node&gt;
            &lt;host&gt;zookeeper1&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
        &lt;node&gt;
            &lt;host&gt;zookeeper2&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
        &lt;node&gt;
            &lt;host&gt;zookeeper3&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
    &lt;/zookeeper&gt;
&lt;/yandex&gt;
</code></pre><ol><li>On each server put the file macros.xml in <code>/etc/clickhouse-server/config.d/</code> folder.</li></ol><pre tabindex=0><code class=language-markup data-lang=markup>&lt;yandex&gt;
    &lt;!--
        That macros are defined per server,
        and they can be used in DDL, to make the DB schema cluster/server neutral
    --&gt;
    &lt;macros&gt;
        &lt;cluster&gt;prod_cluster&lt;/cluster&gt;
        &lt;shard&gt;01&lt;/shard&gt;
        &lt;replica&gt;clickhouse-sh1r1&lt;/replica&gt; &lt;!-- better - use the same as hostname  --&gt;
    &lt;/macros&gt;
&lt;/yandex&gt;
</code></pre><ol><li>On each server place the file cluster.xml in /etc/clickhouse-server/config.d/ folder. Before 20.10 ClickHouse will use default user to connect to other nodes (configurable, other users can be used), since 20.10 we recommend to use passwordless intercluster authentication based on common secret (HMAC auth)</li></ol><pre tabindex=0><code class=language-markup data-lang=markup>&lt;yandex&gt;
    &lt;remote_servers&gt;
        &lt;prod_cluster&gt; &lt;!-- you need to give a some name for a cluster --&gt;

            &lt;!--
                &lt;secret&gt;some_random_string, same on all cluster nodes, keep it safe&lt;/secret&gt;
            --&gt;
            &lt;shard&gt;
                &lt;internal_replication&gt;true&lt;/internal_replication&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh1r1&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh1r2&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
            &lt;/shard&gt;
            &lt;shard&gt;
                &lt;internal_replication&gt;true&lt;/internal_replication&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh2r1&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
                &lt;replica&gt;
                    &lt;host&gt;clickhouse-sh2r2&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
            &lt;/shard&gt;
        &lt;/prod_cluster&gt;
    &lt;/remote_servers&gt;
&lt;/yandex&gt;
</code></pre><ol><li>A good practice is to create 2 additional cluster configurations similar to prod_cluster above with the following distinction: but listing all nodes of single shard (all are replicas) and as nodes of 6 different shards (no replicas)<ol><li>all-replicated: All nodes are listed as replicas in a single shard.</li><li>all-sharded: All nodes are listed as separate shards with no replicas.</li></ol></li></ol><p>Once this is complete, other queries that span nodes can be performed. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_table_local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLUSTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt8</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/tables/{database}/{table}/{shard}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>That will create a table on all servers in the cluster. You can insert data into this table and it will be replicated automatically to the other shards.To store the data or read the data from all shards at the same time, create a Distributed table that links to the replicatedMergeTree table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test_table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLUSTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>Distributed</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;
</span></span></span></code></pre></div><h4 id=hardening-clickhouse-security><strong>Hardening ClickHouse Security</strong></h4><p><strong>See</strong> <a href=https://docs.altinity.com/operationsguide/security/ target=_blank>https://docs.altinity.com/operationsguide/security/</a></p><h3 id=additional-settings>Additional Settings</h3><p>See <a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-settings-to-adjust/>altinity-kb-settings-to-adjust</a></p><h4 id=users>Users</h4><p>Disable or add password for the default users default and readonly if your server is accessible from non-trusted networks.</p><p>If you add password to the default user, you will need to adjust cluster configuration, since the other servers need to know the default user’s should know the default user’s to connect to each other.</p><p>If you’re inside a trusted network, you can leave default user set to nothing to allow the ClickHouse nodes to communicate with each other.</p><h4 id=engines--clickhouse-building-blocks>Engines & ClickHouse building blocks</h4><p>For general explanations of roles of different engines - check the post <a href=https://github.com/yandex/ClickHouse/issues/2161 target=_blank>Distributed vs Shard vs Replicated ahhh, help me!!!</a>
.</p><h4 id=zookeeper-paths>Zookeeper Paths</h4><p>Use conventions for zookeeper paths. For example, use:</p><p>ReplicatedMergeTree(&rsquo;/clickhouse/{cluster}/tables/{shard}/table_name&rsquo;, &lsquo;{replica}&rsquo;)</p><p>for:</p><p>SELECT * FROM system.zookeeper WHERE path=&rsquo;/ &mldr;';</p><h4 id=configuration-best-practices>Configuration Best Practices</h4><table><thead><tr><th style=text-align:left><p>Attribution</p><p>Modified by a post [on GitHub by Mikhail Filimonov](https://github.com/ClickHouse/ClickHouse/issues/3607#issuecomment-440235298).</p></th></tr></thead><tbody></tbody></table><p>The following are recommended Best Practices when it comes to setting up a ClickHouse Cluster with Zookeeper:</p><ol><li>Don’t edit/overwrite default configuration files. Sometimes a newer version of ClickHouse introduces some new settings or changes the defaults in config.xml and users.xml.<ol><li>Set configurations via the extra files in conf.d directory. For example, to overwrite the interface save the file config.d/listen.xml, with the following:</li></ol></li></ol><pre tabindex=0><code class=language-markup data-lang=markup>&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;listen_host replace=&#34;replace&#34;&gt;::&lt;/listen_host&gt;
&lt;/yandex&gt;
</code></pre><ol><li>The same is true for users. For example, change the default profile by putting the file in users.d/profile_default.xml:</li></ol><pre tabindex=0><code class=language-markup data-lang=markup>&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;profiles&gt;
        &lt;default replace=&#34;replace&#34;&gt;
            &lt;max_memory_usage&gt;15000000000&lt;/max_memory_usage&gt;
            &lt;max_bytes_before_external_group_by&gt;12000000000&lt;/max_bytes_before_external_group_by&gt;
            &lt;max_bytes_before_external_sort&gt;12000000000&lt;/max_bytes_before_external_sort&gt;
            &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt;
            &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt;
            &lt;load_balancing&gt;random&lt;/load_balancing&gt;
            &lt;log_queries&gt;1&lt;/log_queries&gt;
            &lt;max_execution_time&gt;600&lt;/max_execution_time&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/yandex&gt;
</code></pre><ol><li>Or you can create a user by putting a file users.d/user_xxx.xml (since 20.5 you can also use CREATE USER)</li></ol><pre tabindex=0><code class=language-markup data-lang=markup>&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;users&gt;
        &lt;xxx&gt;
            &lt;!-- PASSWORD=$(base64 &lt; /dev/urandom | head -c8); echo &#34;$PASSWORD&#34;; echo -n &#34;$PASSWORD&#34; | sha256sum | tr -d &#39;-&#39; --&gt;
            &lt;password_sha256_hex&gt;...&lt;/password_sha256_hex&gt;
            &lt;networks incl=&#34;networks&#34; /&gt;
            &lt;profile&gt;readonly&lt;/profile&gt;
            &lt;quota&gt;default&lt;/quota&gt;
            &lt;allow_databases incl=&#34;allowed_databases&#34; /&gt;
        &lt;/xxx&gt;
    &lt;/users&gt;
&lt;/yandex&gt;
</code></pre><ol><li>Some parts of configuration will contain repeated elements (like allowed ips for all the users). To avoid repeating that - use substitutions file. By default its /etc/metrika.xml, but you can change it for example to /etc/clickhouse-server/substitutions.xml with the &lt;include_from> section of the main config. Put the repeated parts into substitutions file, like this:</li></ol><pre tabindex=0><code class=language-markup data-lang=markup>&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;yandex&gt;
    &lt;networks&gt;
        &lt;ip&gt;::1&lt;/ip&gt;
        &lt;ip&gt;127.0.0.1&lt;/ip&gt;
        &lt;ip&gt;10.42.0.0/16&lt;/ip&gt;
        &lt;ip&gt;192.168.0.0/24&lt;/ip&gt;
    &lt;/networks&gt;
&lt;/yandex&gt;
</code></pre><p>These files can be common for all the servers inside the cluster or can be individualized per server. If you choose to use one substitutions file per cluster, not per node, you will also need to generate the file with macros, if macros are used.</p><p>This way you have full flexibility; you’re not limited to the settings described in the template. You can change any settings per server or data center just by assigning files with some settings to that server or server group. It becomes easy to navigate, edit, and assign files.</p><h3 id=other-configuration-recommendations>Other Configuration Recommendations</h3><p>Other configurations that should be evaluated:</p><ul><li><listen>in config.xml: Determines which IP addresses and ports the ClickHouse servers listen for incoming communications.</li><li>&lt;max_memory_..> and &lt;max_bytes_before_external_&mldr;> in users.xml. These are part of the profile <default>.</li><li>&lt;max_execution_time></li><li>&lt;log_queries></li></ul><p>The following extra debug logs should be considered:</p><ul><li>part_log</li><li>text_log</li></ul><h3 id=understanding-the-configuration>Understanding The Configuration</h3><p>ClickHouse configuration stores most of its information in two files:</p><ul><li>config.xml: Stores <a href=https://clickhouse.yandex/docs/en/operations/server_settings/ target=_blank>Server configuration parameters</a>
. They are server wide, some are hierarchical , and most of them can’t be changed in runtime. The list of settings to apply without a restart changes from version to version. Some settings can be verified using system tables, for example:<ul><li>macros (system.macros)</li><li>remote_servers (system.clusters)</li></ul></li><li>users.xml: Configure users, and user level / session level <a href=https://clickhouse.yandex/docs/en/operations/settings/settings/ target=_blank>settings</a>
.<ul><li>Each user can change these during their session by:<ul><li>Using parameter in http query</li><li>By using parameter for clickhouse-client</li><li>Sending query like set allow_experimental_data_skipping_indices=1.</li></ul></li><li>Those settings and their current values are visible in system.settings. You can make some settings global by editing default profile in users.xml, which does not need restart.</li><li>You can forbid users to change their settings by using readonly=2 for that user, or using <a href=https://clickhouse.yandex/docs/en/operations/settings/constraints_on_settings/ target=_blank>setting constraints</a>
.</li><li>Changes in users.xml are applied w/o restart.</li></ul></li></ul><p>For both config.xml and users.xml, it’s preferable to put adjustments in the config.d and users.d subfolders instead of editing config.xml and users.xml directly.</p><p>You can check if the config file was reread by checking /var/lib/clickhouse/preprocessed_configs/ folder.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3754a72a1a168184ed696d361b761145>52.4 - Hardware Requirements</h1><div class=lead>Hardware Requirements</div><h3 id=clickhouse>ClickHouse®</h3><p>ClickHouse will use all available hardware to maximize performance. So the more hardware - the better. As of this publication, the hardware requirements are:</p><ul><li>Minimum Hardware: 4-core CPU with support of SSE4.2, 16 Gb RAM, 1Tb HDD.<ul><li>Recommended for development and staging environments.</li><li>SSE4.2 is required, and going below 4 Gb of RAM is not recommended.</li></ul></li><li>Recommended Hardware: >=16-cores, >=64Gb RAM, HDD-raid or SSD.<ul><li>For processing up to hundreds of millions / billions of rows.</li></ul></li></ul><p>For clouds: disk throughput is the more important factor compared to IOPS. Be aware of burst / baseline disk speed difference.</p><p>See also: <a href=https://benchmark.clickhouse.com/hardware/ target=_blank rel=nofollow>https://benchmark.clickhouse.com/hardware/</a></p><h3 id=zookeeper><strong>Zookeeper</strong></h3><p>Zookeeper requires separate servers from those used for ClickHouse. Zookeeper has poor performance when installed on the same node as ClickHouse.</p><p>Hardware Requirements for Zookeeper:</p><ul><li>Fast disk speed (ideally NVMe, 128Gb should be enough).</li><li>Any modern CPU (one core, better 2)</li><li>4Gb of RAM</li></ul><p>For clouds - be careful with burstable network disks (like gp2 on aws): you may need up to 1000 IOPs on the disk for on a long run, so gp3 with 3000 IOPs baseline is a better choice.</p><p>The number of Zookeeper instances depends on the environment:</p><ul><li>Production: 3 is an optimal number of zookeeper instances.</li><li>Development and Staging: 1 zookeeper instance is sufficient.</li></ul><p>See also:</p><ul><li><a href=https://docs.altinity.com/operationsguide/clickhouse-zookeeper/ target=_blank>https://docs.altinity.com/operationsguide/clickhouse-zookeeper/</a></li><li><a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/altinity-kb-proper-setup/>altinity-kb-proper-setup</a></li><li><a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/zookeeper-monitoring/>zookeeper-monitoring</a></li></ul><h4 id=clickhouse-hardware-configuration>ClickHouse Hardware Configuration</h4><p>Configure the servers according to those recommendations on the <a href=https://clickhouse.com/docs/en/operations/tips/ target=_blank rel=nofollow>ClickHouse Usage Recommendations</a>
.</p><h4 id=test-your-hardware><strong>Test Your Hardware</strong></h4><p>Be sure to test the following:</p><ul><li>RAM speed.</li><li>Network speed.</li><li>Storage speed.</li></ul><p>It’s better to find any performance issues before installing ClickHouse.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-414e2937f5573cccbd17d35a64e42c62>52.5 - Network Configuration</h1><div class=lead>Network Configuration</div><h3 id=networking-and-server-room-planning><strong>Networking And Server Room Planning</strong></h3><p>The network used for your ClickHouse® cluster should be a fast network, ideally 10 Gbit or more.
ClickHouse nodes generate a lot of traffic to exchange the data between nodes (port 9009 for replication, and 9000 for distributed queries).
Zookeeper traffic in normal circumstances is moderate, but in some special cases can also be very significant.</p><p>For the zookeeper low latency is more important than bandwidth.</p><p>Keep the replicas isolated on the hardware level. This allows for cluster failover from possible outages.</p><ul><li>For Physical Environments: Avoid placing 2 ClickHouse replicas on the same server rack. Ideally, they should be on isolated network switches and an isolated power supply.</li><li>For Clouds Environments: Use different availability zones between the ClickHouse replicas when possible (but be aware of the interzone traffic costs)</li></ul><p>These considerations are the same as the Zookeeper nodes.</p><p>For example:</p><table><thead><tr><th style=text-align:left><strong>Rack</strong></th><th style=text-align:left><strong>Server</strong></th><th style=text-align:left><strong>Server</strong></th><th style=text-align:left><strong>Server</strong></th><th style=text-align:left><strong>Server</strong></th></tr></thead><tbody><tr><td style=text-align:left><strong>Rack 1</strong></td><td style=text-align:left><strong>CH_SHARD1_R1</strong></td><td style=text-align:left><strong>CH_SHARD2_R1</strong></td><td style=text-align:left><strong>CH_SHARD3_R1</strong></td><td style=text-align:left><strong>ZOO_1</strong></td></tr><tr><td style=text-align:left><strong>Rack 2</strong></td><td style=text-align:left><strong>CH_SHARD1_R2</strong></td><td style=text-align:left><strong>CH_SHARD2_R2</strong></td><td style=text-align:left><strong>CH_SHARD3_R2</strong></td><td style=text-align:left><strong>ZOO_2</strong></td></tr><tr><td style=text-align:left><strong>Rack 3</strong></td><td style=text-align:left><strong>ZOO3</strong></td><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left></td></tr></tbody></table><h4 id=network-ports-and-firewall><strong>Network Ports And Firewall</strong></h4><p>ClickHouse listens the following ports:</p><ul><li>9000: clickhouse-client, native clients, other clickhouse-servers connect to here.</li><li>8123: HTTP clients</li><li>9009: Other replicas will connect here to download data.</li></ul><p>For more information, see <a href=https://www.altinity.com/blog/2019/3/15/clickhouse-networking-part-1 target=_blank>CLICKHOUSE NETWORKING, PART 1</a>
.</p><p>Zookeeper listens the following ports:</p><ul><li>2181: Client connections.</li><li>2888: Inter-ensemble connections.</li><li>3888: Leader election.</li></ul><p>Outbound traffic from ClickHouse connects to the following ports:</p><ul><li>ZooKeeper: On port 2181.</li><li>Other CH nodes in the cluster: On port 9000 and 9009.</li><li>Dictionary sources: Depending on what was configured such as HTTP, MySQL, Mongo, etc.</li><li>Kafka or Hadoop: If those integrations were enabled.</li></ul><h3 id=ssl><strong>SSL</strong></h3><p>For non-trusted networks enable SSL/HTTPS. If acceptable, it is better to keep interserver communications unencrypted for performance reasons.</p><h3 id=naming-schema><strong>Naming Schema</strong></h3><p>The best time to start creating a naming schema for the servers is before they’re created and configured.</p><p>There are a few features based on good server naming in ClickHouse:</p><ul><li>clickhouse-client prompts: Allows a different prompt for clickhouse-client per server hostname.</li><li>Nearest hostname load balancing: For more information, see <a href=https://clickhouse.yandex/docs/en/operations/settings/settings/#load_balancing-nearest_hostname target=_blank>Nearest Hostname</a>
.</li></ul><p>A good option is to use the following:</p><p>{datacenter}-{serverroom}-{rack identifier}-{clickhouse cluster identifier}-{shard number or server number}.</p><p>Other examples:</p><ul><li>rxv-olap-ch-master-sh01-r01:<ul><li>rxv - location (rack#15)</li><li>olap - product name</li><li>ch = clickhouse</li><li>master = stage</li><li>sh01 = shard 1</li><li>r01 = replica 1</li></ul></li><li>hetnzerde1-ch-prod-01.local:<ul><li>hetnzerde1 - location (also replica id)</li><li>ch = clickhouse</li><li>prod = stage</li><li>01 - server number / shard number in that DC</li></ul></li><li>sh01.ch-front.dev.aws-east1a.example.com:<ul><li>sh01 - shard 01</li><li>ch-front - cluster name</li><li>dev = stage</li><li>aws = cloud provider</li><li>east1a = region and availability zone</li></ul></li></ul><h4 id=host-name-references><strong>Host Name References</strong></h4><ul><li><a href=https://stackoverflow.com/a/39336460/1555175 target=_blank>What are the best practices for domain names (dev, staging, production)?</a></li><li><a href=https://www.replex.io/blog/9-best-practices-and-examples-for-working-with-kubernetes-labels target=_blank>9 Best Practices and Examples for Working with Kubernetes Labels</a></li><li><a href=https://devcentral.f5.com/s/articles/thoughts-on-hostname-nomenclature target=_blank>Thoughts On Hostname Nomenclature</a></li></ul><h3 id=additional-hostname-tips><strong>Additional Hostname Tips</strong></h3><ul><li>Hostnames configured on the server should not change. If you do need to change the host name, one reference to use is <a href=https://linuxize.com/post/how-to-change-hostname-on-ubuntu-18-04/ target=_blank>How to Change Hostname on Ubuntu 18.04</a>
.</li><li>The server should be accessible to other servers in the cluster via it’s hostname. Otherwise you will need to configure interserver_hostname in your config.</li><li>Ensure that <code>hostname --fqdn</code> and <code>getent hosts $(hostname --fqdn)</code> return the correct name and ip.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e64ef5a4f506fd394e7168728f58b04b>53 - System tables ate my disk</h1><div class=lead>When the ClickHouse® SYSTEM database gets out of hand</div><blockquote><p><strong>Note 1:</strong> System database stores virtual tables (<strong>parts</strong>, <strong>tables,</strong> <strong>columns, etc.</strong>) and *<strong>_log</strong> tables.</p><p>Virtual tables do not persist on disk. They reflect ClickHouse® memory (c++ structures). They cannot be changed or removed.</p><p>Log tables are named with postfix *<strong>_log</strong> and have the <a href=/engines/mergetree-table-engine-family/>MergeTree engine</a>
. ClickHouse does not use information stored in these tables, this data is for you only.</p><p>You can drop / rename / truncate *<strong>_log</strong> tables at any time. ClickHouse will recreate them in about 7 seconds (flush period).</p></blockquote><blockquote><p><strong>Note 2:</strong> Log tables with numeric postfixes (_1 / 2 / 3 &mldr;) <code>query_log_1 query_thread_log_3</code> are results of <a href=https://altinity.com/clickhouse-upgrade-overview/ target=_blank>ClickHouse upgrades</a>
(or other changes of schemas of these tables). When a new version of ClickHouse starts and discovers that a system log table&rsquo;s schema is incompatible with a new schema, then ClickHouse renames the old *_log table to the name with the prefix and creates a table with the new schema. You can drop such tables if you don&rsquo;t need such historic data.</p></blockquote><h2 id=you-can-disable-all--any-of-them>You can disable all / any of them</h2><p>Do not create log tables at all (a restart is needed for these changes to take effect).</p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/config.d/z_log_disable.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
    &lt;asynchronous_metric_log remove=&#34;1&#34;/&gt;
    &lt;backup_log remove=&#34;1&#34;/&gt;
    &lt;error_log remove=&#34;1&#34;/&gt;
    &lt;metric_log remove=&#34;1&#34;/&gt;
    &lt;query_metric_log remove=&#34;1&#34;/&gt;
    &lt;query_thread_log remove=&#34;1&#34; /&gt;  
    &lt;query_log remove=&#34;1&#34; /&gt;
    &lt;query_views_log remove=&#34;1&#34; /&gt;
    &lt;part_log remove=&#34;1&#34;/&gt;
    &lt;session_log remove=&#34;1&#34;/&gt;
    &lt;text_log remove=&#34;1&#34; /&gt;
    &lt;trace_log remove=&#34;1&#34;/&gt;
    &lt;crash_log remove=&#34;1&#34;/&gt;
    &lt;opentelemetry_span_log remove=&#34;1&#34;/&gt;
    &lt;zookeeper_log remove=&#34;1&#34;/&gt;
    &lt;processors_profile_log remove=&#34;1&#34;/&gt;
    &lt;latency_log remove=&#34;1&#34;/&gt;
    &lt;background_schedule_pool_log remove=&#34;1&#34;/&gt;
    &lt;aggregated_zookeeper_log remove=&#34;1&#34;/&gt;
    &lt;zookeeper_connection_log remove=&#34;1&#34;/&gt;
&lt;/clickhouse&gt;
</code></pre><p><strong>We do not recommend removing <code>query_log</code> and <code>query_thread_log</code> as queries&rsquo; (they have very useful information for debugging), and logging can be easily turned off without a restart through user profiles:</strong></p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/users.d/z_log_queries.xml
&lt;clickhouse&gt;
    &lt;profiles&gt;
        &lt;default&gt;
            &lt;log_queries&gt;0&lt;/log_queries&gt; &lt;!-- normally it&#39;s better to keep it turned on! --&gt;
            &lt;log_query_threads&gt;0&lt;/log_query_threads&gt;
            &lt;log_processors_profiles&gt;0&lt;/log_processors_profiles&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/clickhouse&gt;
</code></pre><p>Hint: <code>z_log_disable.xml</code> is named with <strong>z_</strong> in the beginning, it means this config will be applied the last and will override all other config files with these sections (config are applied in alphabetical order).</p><p>You can also configure these settings to reduce the amount of data in the <code>system.query_log</code> table:</p><pre tabindex=0><code class=language-markup data-lang=markup>name                              | value       | description                                                                                                                                                       
----------------------------------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------
log_queries_min_type              | QUERY_START | Minimal type in query_log to log, possible values (from low to high): QUERY_START, QUERY_FINISH, EXCEPTION_BEFORE_START, EXCEPTION_WHILE_PROCESSING.
log_queries_min_query_duration_ms | 0           | Minimal time for the query to run, to get to the query_log/query_thread_log.
log_queries_cut_to_length         | 100000      | If query length is greater than specified threshold (in bytes), then cut query when writing to query log. Also limit length of printed query in ordinary text log.
log_profile_events                | 1           | Log query performance statistics into the query_log and query_thread_log.
log_query_settings                | 1           | Log query settings into the query_log.
log_queries_probability           | 1           | Log queries with the specified probabality.
</code></pre><h2 id=you-can-configure-ttl>You can configure TTL</h2><p>Example for <code>query_log</code>. It drops partitions with data older than 14 days:</p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/config.d/query_log_ttl.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
    &lt;query_log replace=&#34;1&#34;&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;query_log&lt;/table&gt;
        &lt;engine&gt;ENGINE = MergeTree PARTITION BY (event_date)
                ORDER BY (event_time)
                TTL event_date + INTERVAL 14 DAY DELETE
        &lt;/engine&gt;
        &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;
    &lt;/query_log&gt;
&lt;/clickhouse&gt;
</code></pre><p>After that you need to restart ClickHouse and <em>if using old clickhouse versions like 20 or less</em>, drop or rename the existing system.query_log table and then CH creates a new table with these settings. This is automatically done in newer versions 21+.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_log</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_log_1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Important part here is a daily partitioning <code>PARTITION BY (event_date)</code> in this case TTL expression <code>event_date + INTERVAL 14 DAY DELETE</code> expires all rows at the same time. In this case ClickHouse drops whole partitions. Dropping of partitions is very easy operation for CPU / Disk I/O.</p><p>Usual TTL processing (when table partitioned by toYYYYMM and TTL by day) is heavy CPU / Disk I/O consuming operation which re-writes data parts without expired rows.</p><p>You can <a href=/altinity-kb-queries-and-syntax/ttl/modify-ttl/>add TTL without ClickHouse restart</a>
(and table dropping or renaming):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_log</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>MODIFY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TTL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_date</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>INTERVAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DAY</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>But in this case ClickHouse will drop only whole monthly partitions (will store data older than 14 days).</p><h2 id=one-more-way-to-configure-ttl-for-system-tables>One more way to configure TTL for system tables</h2><p>This way just adds TTL to a table and leaves monthly (default) partitioning (will store data older than 14 days).</p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/config.d/query_log_ttl.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
    &lt;query_log&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;query_log&lt;/table&gt;
        &lt;ttl&gt;event_date + INTERVAL 30 DAY DELETE&lt;/ttl&gt;
    &lt;/query_log&gt;
&lt;/clickhouse&gt;
</code></pre><p>💡 For the <a href=https://github.com/Altinity/clickhouse-operator/blob/master/README.md target=_blank>clickhouse-operator</a>
, the above method of using only the <code>&lt;engine></code> tag without <code>&lt;ttl></code> or <code>&lt;partition></code> is recommended, because of possible configuration clashes.</p><p>After that you need to restart ClickHouse and <em>if using old clickhouse versions like 20 or less</em>, drop or rename the existing system.query_log table and then CH creates a new table with these settings. This is automatically done in newer versions 21+.</p><h2 id=you-can-disable-logging-on-a-session-level-or-in-users-profile-for-all-or-specific-users>You can disable logging on a session level or in user’s profile (for all or specific users)</h2><p>But only for logs generated on session level (<code>query_log</code> / <code>query_thread_log</code>)</p><p>In this case a restart is not needed.</p><p>Let’s disable query logging for all users (profile = default, all other profiles inherit it).</p><pre tabindex=0><code class=language-markup data-lang=markup>cat /etc/clickhouse-server/users.d/log_queries.xml
&lt;clickhouse&gt;
    &lt;profiles&gt;
        &lt;default&gt;
            &lt;log_queries&gt;0&lt;/log_queries&gt;
            &lt;log_query_threads&gt;0&lt;/log_query_threads&gt;
            &lt;log_processors_profiles&gt;0&lt;/log_processors_profiles&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/clickhouse&gt;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-9f492adefec5edc496d0909f604aa8ff>54 - ClickHouse® Replication problems</h1><div class=lead>Finding and troubleshooting problems in the <code>replication_queue</code></div><h1 id=common-problems--solutions>Common problems & solutions</h1><ul><li><p>If the replication queue does not have any Exceptions only postponed reasons without exceptions just leave ClickHouse® do Merges/Mutations and it will eventually catch up and reduce the number of tasks in <code>replication_queue</code>. Number of concurrent merges and fetches can be tuned but if it is done without an analysis of your workload then you may end up in a worse situation. If Delay in queue is going up actions may be needed:</p></li><li><p>First simplest approach:
try to <code>SYSTEM RESTART REPLICA db.table</code> (This will DETACH/ATTACH table internally)</p></li></ul><h1 id=how-to-check-for-replication-problems>How to check for replication problems</h1><ol><li><p>Check <code>system.replicas</code> first, cluster-wide. It allows to check if the problem is local to some replica or global, and allows to see the exception.
allows to answer the following questions:</p><ul><li>Are there any ReadOnly replicas?</li><li>Is there the connection to zookeeper active?</li><li>Is there the exception during table init? (<code>Code: 999. Coordination::Exception: Transaction failed (No node): Op #1</code>)</li></ul></li><li><p>Check <code>system.replication_queue</code>.</p><ul><li>How many tasks there / are they moving / are there some very old tasks there? (check <code>created_time</code> column, if tasks are 24h old, it is a sign of a problem):</li><li>You can use this qkb article query: <a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-replication-queue/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-replication-queue/</a></li><li>Check if there are tasks with a high number of <code>num_tries</code> or <code>num_postponed</code> and <code>postponed_reason</code> this is a sign of stuck tasks.</li><li>Check the problematic parts affecting the stuck tasks. You can use columns <code>new_part_name</code> or <code>parts_to_merge</code></li><li>Check which type is the task. If it is <code>MUTATE_PART</code> then it is a mutation task. If it is <code>MERGE_PARTS</code> then it is a merge task. These tasks can be deleted from the replication queue but <code>GET_PARTS</code> should not be deleted.</li></ul></li><li><p>Check <code>system.errors</code></p></li><li><p>Check <code>system.mutations</code>:</p><ul><li>You can check that in the replication queue are stuck tasks of type <code>MUTATE_PART</code>, and that those mutations are still executing <code>system.mutations</code> using column <code>is_done</code></li></ul></li><li><p>Find the moment when the problem started and collect/analyze / preserve logs from that moment. It is usually during the first steps of a restart/crash</p></li><li><p>Use <code>part_log</code> and <code>system.parts</code> to gather information of the parts related with the stuck tasks in the replication queue:</p><ul><li>Check if those parts exist and are active from <code>system.parts</code> (use partition_id, name as part and active columns to filter)</li><li>Extract the part history from <code>system.part_log</code></li><li>Example query from <code>part_log</code>:</li></ul></li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;all-sharded&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>part_log</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>hostName</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;chi-prod-live-2-0-0&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;chi-prod-live-2-2-0&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;chi-prod-live-2-1-0&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;sessions_local&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;analytics&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;20230411_33631_33654_3&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ol start=7><li>If there are no errors, just everything get slower - check the load (usual system metrics)</li></ol><h2 id=some-stuck-replication-task-for-a-partition-that-was-already-removed-or-has-no-data>Some stuck replication task for a partition that was already removed or has no data</h2><ul><li><p>This can be easily detected because some exceptions will be in the replication queue that reference a part from a partition that do not exist. Here the most probable scenario is that the partition was dropped and some tasks were left in the queue.</p></li><li><p>drop the partition manually once again (it should remove the task)</p></li><li><p>If the partition exists but the part is missing (maybe because it is superseded by a newer merged part) then you can try to DETACH/ATTACH the partition.</p></li><li><p>Below DML generates the ALTER commands to do this:</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>extract</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>new_part_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;^[^_]+&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition_id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;/* count: &#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39; */\n&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;ALTER TABLE &#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39; DETACH PARTITION ID \&#39;&#39;|| partition_id || &#39;</span><span style=color:#a40000>\</span><span style=color:#4e9a06>&#39;;\n&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;ALTER TABLE &#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39; ATTACH PARTITION ID \&#39;&#39;|| partition_id || &#39;</span><span style=color:#a40000>\</span><span style=color:#4e9a06>&#39;;\n&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replication_queue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rq</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition_id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>HAVING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_tries</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_tries</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSVRaw</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=problem-with-mutation-stuck-in-the-queue>Problem with mutation stuck in the queue</h2><ul><li><p>This can happen if the mutation is finished and, for some reason, the task is not removed from the queue. This can be detected by checking <code>system.mutations</code> table and seeing if the mutation is done, but the task is still in the queue.</p></li><li><p>kill the mutation (again)</p></li></ul><h2 id=replica-is-not-starting-because-local-set-of-files-differs-too-much>Replica is not starting because local set of files differs too much</h2><ul><li>First try increase the thresholds or set flag <code>force_restore_data</code> flag and restarting clickhouse/pod <a href=https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replication#recovery-after-complete-data-loss target=_blank rel=nofollow>https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replication#recovery-after-complete-data-loss</a></li></ul><h2 id=replica-is-in-read-only-mode>Replica is in Read-Only MODE</h2><p>Sometimes, due to crashes, zookeeper unavailability, slowness, or other reasons, some of the tables can be in Read-Only mode. This allows SELECTS but not INSERTS. So we need to do DROP / RESTORE replica procedure.</p><p>Just to be clear, this procedure <strong>will not delete any data</strong>, it will just re-create the metadata in zookeeper with the current state of the <a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/add_remove_replica/>ClickHouse replica</a>
.</p><p>How it works:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DETACHED</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- clean detached folder before operation. PARTITION ALL works only for the fresh clickhouse versions
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>DETACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- Required for DROP REPLICA
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Use the zookeeper_path and replica_name from system.replicas. 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;replica_name&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ZKPATH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;/table_path_in_zk&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- It will remove everything from the /table_path_in_zk/replicas/replica_name
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- Table will be in readonly mode, because there is no metadata in ZK and after that execute
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RESTORE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- It will detach all partitions, re-create metadata in ZK (like it&#39;s new empty table), and then attach all partitions back
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SYNC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- Not mandatory. It will Wait for replicas to synchronize parts. Also it&#39;s recommended to check `system.detached_parts` on all replicas after recovery is finished.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>detached_parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;table_name&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- check for leftovers. See the potential problems here https://altinity.com/blog/understanding-detached-parts-in-clickhouse
</span></span></span></code></pre></div><p>Starting from version 23, it&rsquo;s possible to use syntax <a href=https://clickhouse.com/docs/en/sql-reference/statements/system#drop-replica target=_blank rel=nofollow>SYSTEM DROP REPLICA 'replica_name' FROM TABLE db.table</a>
instead of the <code>ZKPATH</code> variant, but you need to execute the above command from a different replica than the one you want to drop, which is not convenient sometimes. We recommend using the above method because it works with any version and is more reliable.</p><h2 id=procedure-to-restore-multiple-tables-in-read-only-mode-per-replica>Procedure to restore multiple tables in Read-Only mode per replica</h2><p>It is better to make an approach per replica, because restoring a replica using ON CLUSTER could lead to race conditions that would cause errors and a big stress in zookeeper/keeper</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;-- Table &#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>row_num</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;\n&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;DETACH TABLE `&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;`.`&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;`;\n&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;SYSTEM DROP REPLICA &#39;&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;&#39; FROM ZKPATH &#39;&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>zookeeper_path</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;&#39;;\n&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;ATTACH TABLE `&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;`.`&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;`;\n&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#39;SYSTEM RESTORE REPLICA `&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;`.`&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;`;\n&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>rowNumberInAllBlocks</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>row_num</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>any</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>replica_name</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>any</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>zookeeper_path</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>zookeeper_path</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replicas</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>is_readonly</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSVRaw</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This will generate the DDL statements to be executed per replica and generate an ouput that can be saved as an SQL file . It is important to execute the commands per replica in the sequence generated by the above DDL:</p><ul><li>DETACH the table</li><li>DROP REPLICA</li><li>ATTACH the table</li><li>RESTORE REPLICA</li></ul><p>If we do this in parallel a table could still be attaching while another query is dropping/restoring the replica in zookeeper, causing errors.</p><p>The following bash script will read the generated SQL file and execute the commands sequentially, asking for user input in case of errors. Simply save the generated SQL to a file (e.g. <code>recovery_commands.sql</code>) and run the script below (that you can name as <code>clickhouse_replica_recovery.sh</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ clickhouse_replica_recovery.sh recovery_commands.sql
</span></span></code></pre></div><p>Here the script:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ClickHouse Replica Recovery Script</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This script executes DETACH, DROP REPLICA, ATTACH, and RESTORE REPLICA commands sequentially</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configuration</span>
</span></span><span style=display:flex><span><span style=color:#000>CLICKHOUSE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CLICKHOUSE_HOST</span><span style=color:#204a87;font-weight:700>:-</span><span style=color:#000>localhost</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>CLICKHOUSE_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CLICKHOUSE_PORT</span><span style=color:#204a87;font-weight:700>:-</span><span style=color:#000>9000</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>CLICKHOUSE_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CLICKHOUSE_USER</span><span style=color:#204a87;font-weight:700>:-</span><span style=color:#000>clickhouse_operator</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>CLICKHOUSE_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CLICKHOUSE_PASSWORD</span><span style=color:#204a87;font-weight:700>:-</span><span style=color:#000>xxxxxxxxx</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>COMMANDS_FILE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>1</span><span style=color:#204a87;font-weight:700>:-</span><span style=color:#000>recovery_commands</span><span style=color:#000;font-weight:700>.sql</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>LOG_FILE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;recovery_</span><span style=color:#204a87;font-weight:700>$(</span>date +%Y%m%d_%H%M%S<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Colors for output</span>
</span></span><span style=display:flex><span><span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;\033[0;31m&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>GREEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;\033[0;32m&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>YELLOW</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;\033[1;33m&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>BLUE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;\033[0;34m&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>MAGENTA</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;\033[0;35m&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>NC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;\033[0m&#39;</span> <span style=color:#8f5902;font-style:italic># No Color</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Function to log messages</span>
</span></span><span style=display:flex><span>log<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#34;[</span><span style=color:#204a87;font-weight:700>$(</span>date <span style=color:#4e9a06>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>] </span><span style=color:#000>$1</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> tee -a <span style=color:#4e9a06>&#34;</span><span style=color:#000>$LOG_FILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Function to execute a SQL statement with retry logic</span>
</span></span><span style=display:flex><span>execute_sql<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$1</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>table_num</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$2</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>step_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$3</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>        log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Executing command for Table </span><span style=color:#000>$table_num</span><span style=color:#4e9a06> - </span><span style=color:#000>$step_name</span><span style=color:#4e9a06>:</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        log <span style=color:#4e9a06>&#34;</span><span style=color:#000>$sql</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># Build clickhouse-client command</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>local</span> <span style=color:#000>ch_cmd</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;clickhouse-client --host=</span><span style=color:#000>$CLICKHOUSE_HOST</span><span style=color:#4e9a06> --port=</span><span style=color:#000>$CLICKHOUSE_PORT</span><span style=color:#4e9a06> --user=</span><span style=color:#000>$CLICKHOUSE_USER</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -n <span style=color:#4e9a06>&#34;</span><span style=color:#000>$CLICKHOUSE_PASSWORD</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#000>ch_cmd</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$ch_cmd</span><span style=color:#4e9a06> --password=</span><span style=color:#000>$CLICKHOUSE_PASSWORD</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># Execute the command and capture output and exit code</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>local</span> output
</span></span><span style=display:flex><span>        <span style=color:#204a87>local</span> exit_code
</span></span><span style=display:flex><span>        <span style=color:#000>output</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$sql</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#000>$ch_cmd</span> 2&gt;<span style=color:#000;font-weight:700>&amp;</span>1<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>exit_code</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$?</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># Log the output</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$output</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> tee -a <span style=color:#4e9a06>&#34;</span><span style=color:#000>$LOG_FILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$exit_code</span> -eq <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>GREEN</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>✓ Successfully executed</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>            log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>RED</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>✗ Failed to execute (Exit code: </span><span style=color:#000>$exit_code</span><span style=color:#4e9a06>)</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>            log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>RED</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Error output: </span><span style=color:#000>$output</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># Ask user what to do</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>                log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>MAGENTA</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>========================================</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>                log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>MAGENTA</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Error occurred! Choose an option:</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>                log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>MAGENTA</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>========================================</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>[R]</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> - Retry this command&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>[I]</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> - Ignore this error and continue to next command in this table&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>[S]</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> - Skip this entire table and move to next table&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>[A]</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> - Abort script execution&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87>echo</span> -n <span style=color:#4e9a06>&#34;Enter your choice (R/I/S/A): &#34;</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic># Read from /dev/tty to get user input from terminal</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87>read</span> -r response &lt; /dev/tty
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>response</span><span style=color:#000;font-weight:700>^^</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> in
</span></span><span style=display:flex><span>                    R<span style=color:#000;font-weight:700>|</span>RETRY<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                        log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BLUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Retrying command...</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#204a87>break</span>  <span style=color:#8f5902;font-style:italic># Break inner loop to retry</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>                    I<span style=color:#000;font-weight:700>|</span>IGNORE<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                        log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Ignoring error and continuing to next command...</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#8f5902;font-style:italic># Return error but continue</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>                    S<span style=color:#000;font-weight:700>|</span>SKIP<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                        log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Skipping entire table </span><span style=color:#000>$table_num</span><span style=color:#4e9a06>...</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>2</span>  <span style=color:#8f5902;font-style:italic># Return special code to skip table</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>                    A<span style=color:#000;font-weight:700>|</span>ABORT<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                        log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>RED</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Aborting script execution...</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>                    *<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>RED</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Invalid option &#39;</span><span style=color:#000>$response</span><span style=color:#4e9a06>&#39;. Please enter R, I, S, or A.</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>esac</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Main execution function</span>
</span></span><span style=display:flex><span>main<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BLUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>========================================</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BLUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>ClickHouse Replica Recovery Script</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BLUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>========================================</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;Host: </span><span style=color:#000>$CLICKHOUSE_HOST</span><span style=color:#4e9a06>:</span><span style=color:#000>$CLICKHOUSE_PORT</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;User: </span><span style=color:#000>$CLICKHOUSE_USER</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;Commands file: </span><span style=color:#000>$COMMANDS_FILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;Log file: </span><span style=color:#000>$LOG_FILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Check if commands file exists</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -f <span style=color:#4e9a06>&#34;</span><span style=color:#000>$COMMANDS_FILE</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>RED</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Error: Commands file &#39;</span><span style=color:#000>$COMMANDS_FILE</span><span style=color:#4e9a06>&#39; not found!</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Usage: </span><span style=color:#000>$0</span><span style=color:#4e9a06> [commands_file]&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;  commands_file: Path to SQL commands file (default: recovery_commands.sql)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Example: </span><span style=color:#000>$0</span><span style=color:#4e9a06> my_commands.sql&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Process SQL commands from file</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>current_sql</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>table_counter</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>step_in_table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>failed_count</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>success_count</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>ignored_count</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>skipped_tables</span><span style=color:#ce5c00;font-weight:700>=()</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>skip_current_table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000>IFS</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>read</span> -r line <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>[</span> -n <span style=color:#4e9a06>&#34;</span><span style=color:#000>$line</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># Skip empty lines</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[[</span> -z <span style=color:#4e9a06>&#34;</span><span style=color:#000>$line</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$line</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span>~ ^<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>*$ <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># Check if this is a comment line indicating a new table</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$line</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span>~ ^<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>*--<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>*Table<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>+<span style=color:#ce5c00;font-weight:700>([</span>0-9<span style=color:#ce5c00;font-weight:700>]</span>+<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#000>table_counter</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BASH_REMATCH</span><span style=color:#000;font-weight:700>[1]</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>step_in_table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>            <span style=color:#000>skip_current_table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>            log <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>            log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BLUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>========================================</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>            log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BLUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Processing Table </span><span style=color:#000>$table_counter</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>            log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BLUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>========================================</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$line</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span>~ ^<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>*-- <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># Skip other comment lines</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># Skip if we&#39;re skipping this table</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$skip_current_table</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># Check if line ends with semicolon to count statements</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$line</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span>~ <span style=color:#4e9a06>\;</span><span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>*$ <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>                <span style=color:#000>step_in_table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$((</span>step_in_table <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#204a87;font-weight:700>))</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># Accumulate the SQL statement</span>
</span></span><span style=display:flex><span>        <span style=color:#000>current_sql</span><span style=color:#ce5c00;font-weight:700>+=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$line</span><span style=color:#4e9a06> &#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># Check if we have a complete statement (ends with semicolon)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$line</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span>~ <span style=color:#4e9a06>\;</span><span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>*$ <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#000>step_in_table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$((</span>step_in_table <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#204a87;font-weight:700>))</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># Determine the step name</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>local</span> <span style=color:#000>step_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$current_sql</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span>~ ^<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>*DETACH <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>                <span style=color:#000>step_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;DETACH&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$current_sql</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span>~ ^<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>*SYSTEM<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>+DROP<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>+REPLICA <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>                <span style=color:#000>step_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;DROP REPLICA&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$current_sql</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span>~ ^<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>*ATTACH <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>                <span style=color:#000>step_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;ATTACH&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$current_sql</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span>~ ^<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>*SYSTEM<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>+RESTORE<span style=color:#ce5c00;font-weight:700>[[</span>:space:<span style=color:#ce5c00;font-weight:700>]]</span>+REPLICA <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>                <span style=color:#000>step_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;RESTORE REPLICA&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            log <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>            log <span style=color:#4e9a06>&#34;Step </span><span style=color:#000>$step_in_table</span><span style=color:#4e9a06>/4: </span><span style=color:#000>$step_name</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># Execute the statement</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>local</span> result
</span></span><span style=display:flex><span>            execute_sql <span style=color:#4e9a06>&#34;</span><span style=color:#000>$current_sql</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$table_counter</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$step_name</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$?</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$result</span> -eq <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>                <span style=color:#000>success_count</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$((</span>success_count <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#204a87;font-weight:700>))</span>
</span></span><span style=display:flex><span>                sleep <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#8f5902;font-style:italic># Small delay between commands</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$result</span> -eq <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic># User chose to ignore this error</span>
</span></span><span style=display:flex><span>                <span style=color:#000>failed_count</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$((</span>failed_count <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#204a87;font-weight:700>))</span>
</span></span><span style=display:flex><span>                <span style=color:#000>ignored_count</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$((</span>ignored_count <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#204a87;font-weight:700>))</span>
</span></span><span style=display:flex><span>                sleep <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$result</span> -eq <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic># User chose to skip this table</span>
</span></span><span style=display:flex><span>                <span style=color:#000>skip_current_table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>                <span style=color:#000>skipped_tables</span><span style=color:#ce5c00;font-weight:700>+=(</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$table_counter</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Skipping remaining commands for Table </span><span style=color:#000>$table_counter</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># Reset current_sql for next statement</span>
</span></span><span style=display:flex><span>            <span style=color:#000>current_sql</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>done</span> &lt; <span style=color:#4e9a06>&#34;</span><span style=color:#000>$COMMANDS_FILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Summary</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BLUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>========================================</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BLUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Execution Summary</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BLUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>========================================</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;Total successful commands: </span><span style=color:#4e9a06>${</span><span style=color:#000>GREEN</span><span style=color:#4e9a06>}</span><span style=color:#000>$success_count</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;Total failed commands: </span><span style=color:#4e9a06>${</span><span style=color:#000>RED</span><span style=color:#4e9a06>}</span><span style=color:#000>$failed_count</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;Total ignored errors: </span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}</span><span style=color:#000>$ignored_count</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;Total tables processed: </span><span style=color:#000>$table_counter</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>${#</span><span style=color:#000>skipped_tables</span><span style=color:#000;font-weight:700>[@]</span><span style=color:#4e9a06>}</span> -gt <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#4e9a06>&#34;Skipped tables: </span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}${</span><span style=color:#000>skipped_tables</span><span style=color:#000;font-weight:700>[*]</span><span style=color:#4e9a06>}${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#4e9a06>&#34;Log file: </span><span style=color:#000>$LOG_FILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$failed_count</span> -eq <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>GREEN</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>All commands executed successfully!</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>YELLOW</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>Some commands failed or were ignored. Please check the log file.</span><span style=color:#4e9a06>${</span><span style=color:#000>NC</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Run the main function</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-13df9db0c6033eb5e2bfdfb7089294a2>55 - Replication queue</h1><div class=lead>Replication queue</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>last_exception</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>postpone_reason</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>min</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>create_time</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>last_attempt_time</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>last_postpone_time</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_postponed</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_postponed</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_tries</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_tries</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>min</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_tries</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_tries</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>countIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>last_exception</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>count_err</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>countIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_postponed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>count_postponed</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>countIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>is_currently_executing</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>count_executing</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>count_all</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>replication_queue</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>count_all</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b49d062b4f5879d725ccb9b4aedf0f07>56 - Schema migration tools for ClickHouse®</h1><div class=lead>Schema migration tools for ClickHouse®</div><ul><li><a href=https://atlasgo.io target=_blank>atlas</a><ul><li><a href=https://atlasgo.io/guides/clickhouse target=_blank>https://atlasgo.io/guides/clickhouse</a></li></ul></li><li>golang-migrate tool - see <a href=./golang-migrate>golang-migrate</a></li><li>liquibase<ul><li><a href=https://github.com/mediarithmics/liquibase-clickhouse target=_blank>https://github.com/mediarithmics/liquibase-clickhouse</a></li><li><a href=https://johntipper.org/how-to-execute-liquibase-changesets-against-clickhouse/ target=_blank>https://johntipper.org/how-to-execute-liquibase-changesets-against-clickhouse/</a></li></ul></li><li>HousePlant<ul><li>New CLI migration tool (Dec2024) for ClickHouse developed by <a href=https://june.so target=_blank>June</a></li><li>Documentation <a href=https://houseplant.readthedocs.io/en/latest/index.html target=_blank>https://houseplant.readthedocs.io/en/latest/index.html</a></li><li>Github <a href=https://github.com/juneHQ/houseplant target=_blank>https://github.com/juneHQ/houseplant</a></li></ul></li><li>ClickSuite<ul><li>developed by <a href=https://www.gamebeast.gg/ target=_blank>GameBeast</a></li><li>A robust CLI tool for managing ClickHouse database migrations with environment-specific configurations and TypeScript support.</li><li>Github <a href=https://github.com/GamebeastGG/clicksuite target=_blank>https://github.com/GamebeastGG/clicksuite</a></li></ul></li><li>Flyway<ul><li><a href=https://documentation.red-gate.com/fd/clickhouse-database-277579307.html target=_blank>Official community supported plugin</a>
<a href=https://github.com/flyway/flyway-community-db-support/tree/main/flyway-database-clickhouse target=_blank>git</a>
<a href=https://github.com/flyway/flyway-community-db-support target=_blank>https://github.com/flyway/flyway-community-db-support</a></li><li>Old pull requests (latest at the top):<ul><li><a href=https://github.com/flyway/flyway/pull/3333 target=_blank>https://github.com/flyway/flyway/pull/3333</a>
СlickHouse support</li><li><a href=https://github.com/flyway/flyway/pull/3134 target=_blank>https://github.com/flyway/flyway/pull/3134</a>
СlickHouse support</li><li><a href=https://github.com/flyway/flyway/pull/3133 target=_blank>https://github.com/flyway/flyway/pull/3133</a>
Add support ClickHouse</li><li><a href=https://github.com/flyway/flyway/pull/2981 target=_blank>https://github.com/flyway/flyway/pull/2981</a>
ClickHouse replicated</li><li><a href=https://github.com/flyway/flyway/pull/2640 target=_blank>https://github.com/flyway/flyway/pull/2640</a>
Yet another ClickHouse support</li><li><a href=https://github.com/flyway/flyway/pull/2166 target=_blank>https://github.com/flyway/flyway/pull/2166</a>
ClickHouse support (#1772)</li><li><a href=https://github.com/flyway/flyway/pull/1773 target=_blank>https://github.com/flyway/flyway/pull/1773</a>
Fixed #1772: Add support for ClickHouse (<a href=https://clickhouse.yandex/ target=_blank>https://clickhouse.yandex/</a>
)</li></ul></li></ul></li><li><a href=https://alembic.sqlalchemy.org/en/latest/ target=_blank>alembic</a><ul><li>see <a href=https://clickhouse-sqlalchemy.readthedocs.io/en/latest/migrations.html target=_blank>https://clickhouse-sqlalchemy.readthedocs.io/en/latest/migrations.html</a></li></ul></li><li>bytebase<ul><li><a href=https://bytebase.com target=_blank>https://bytebase.com</a></li></ul></li><li>custom tool for ClickHouse for python<ul><li><a href=https://github.com/delium/clickhouse-migrator target=_blank>https://github.com/delium/clickhouse-migrator</a></li><li><a href=https://github.com/zifter/clickhouse-migrations target=_blank>https://github.com/zifter/clickhouse-migrations</a></li><li><a href=https://github.com/trushad0w/clickhouse-migrate target=_blank>https://github.com/trushad0w/clickhouse-migrate</a></li></ul></li><li>phpMigrations<ul><li><a href=https://github.com/smi2/phpMigrationsClickhouse target=_blank>https://github.com/smi2/phpMigrationsClickHouse</a></li><li><a href=https://habrahabr.ru/company/smi2/blog/317682/ target=_blank>https://habrahabr.ru/company/smi2/blog/317682/</a></li></ul></li><li>dbmate<ul><li><a href=https://github.com/amacneil/dbmate#clickhouse target=_blank>https://github.com/amacneil/dbmate#clickhouse</a></li></ul></li></ul><p>Know more?</p><p><a href=https://clickhouse.com/docs/knowledgebase/schema_migration_tools target=_blank rel=nofollow>https://clickhouse.com/docs/knowledgebase/schema_migration_tools</a></p><p>Article on migrations in ClickHouse
<a href=https://posthog.com/blog/async-migrations target=_blank>https://posthog.com/blog/async-migrations</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f4359fae9928fc2ceb30bfc0e2c0b8d2>56.1 - golang-migrate</h1><div class=lead>golang-migrate</div><h3 id=migrate><code>migrate</code></h3><p><code>migrate</code> is a simple schema migration tool written in golang. No external dependencies are required (like interpreter, jre), only one platform-specific executable. <a href=https://github.com/golang-migrate/migrate target=_blank>golang-migrate/migrate</a></p><p><code>migrate</code> supports several databases, including ClickHouse® (support was introduced by <a href=https://github.com/kshvakov target=_blank>@kshvakov</a>
).</p><p>To store information about migrations state <code>migrate</code> creates one additional table in target database, by default that table is called <code>schema_migrations</code>.</p><h4 id=install>Install</h4><p><a href=https://github.com/golang-migrate/migrate/releases target=_blank>download</a>
the <code>migrate</code> executable for your platform and put it to the folder listed in your %PATH.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#wget https://github.com/golang-migrate/migrate/releases/download/v3.2.0/migrate.linux-amd64.tar.gz</span>
</span></span><span style=display:flex><span>wget https://github.com/golang-migrate/migrate/releases/download/v4.14.1/migrate.linux-amd64.tar.gz
</span></span><span style=display:flex><span>tar -xzf migrate.linux-amd64.tar.gz
</span></span><span style=display:flex><span>mkdir -p ~/bin
</span></span><span style=display:flex><span>mv migrate.linux-amd64 ~/bin/migrate
</span></span><span style=display:flex><span>rm migrate.linux-amd64.tar.gz
</span></span></code></pre></div><h4 id=sample-usage>Sample usage</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir migrations
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#39;create table test(id UInt8) Engine = Memory;&#39;</span> &gt; migrations/000001_my_database_init.up.sql
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#39;DROP TABLE test;&#39;</span> &gt; migrations/000001_my_database_init.down.sql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># you can also auto-create file with new migrations with automatic numbering like that:</span>
</span></span><span style=display:flex><span>migrate create -dir migrations -seq -digits <span style=color:#0000cf;font-weight:700>6</span> -ext sql my_database_init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>edit migrations/000001_my_database_init.up.sql <span style=color:#000;font-weight:700>&amp;</span> migrations/000001_my_database_init.down.sql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>migrate -database <span style=color:#4e9a06>&#39;clickhouse://localhost:9000&#39;</span> -path ./migrations up
</span></span><span style=display:flex><span>1/u my_database_init <span style=color:#ce5c00;font-weight:700>(</span>6.502974ms<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>migrate -database <span style=color:#4e9a06>&#39;clickhouse://localhost:9000&#39;</span> -path ./migrations down
</span></span><span style=display:flex><span>1/d my_database_init <span style=color:#ce5c00;font-weight:700>(</span>2.164394ms<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># clears the database (use carefully - will not ask any confirmations)</span>
</span></span><span style=display:flex><span>➜ migrate -database <span style=color:#4e9a06>&#39;clickhouse://localhost:9000&#39;</span> -path ./migrations drop
</span></span></code></pre></div><h4 id=connection-string-format>Connection string format</h4><p><code>clickhouse://host:port?username=user&amp;password=qwerty&amp;database=clicks</code></p><table><thead><tr><th style=text-align:left>URL Query</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>x-migrations-table</code></td><td style=text-align:left>Name of the migrations table</td></tr><tr><td style=text-align:left><code>x-migrations-table-engine</code></td><td style=text-align:left>Engine to use for the migrations table, defaults to TinyLog</td></tr><tr><td style=text-align:left><code>x-cluster-name</code></td><td style=text-align:left>Name of cluster for creating table cluster wide</td></tr><tr><td style=text-align:left><code>database</code></td><td style=text-align:left>The name of the database to connect to</td></tr><tr><td style=text-align:left><code>username</code></td><td style=text-align:left>The user to sign in as</td></tr><tr><td style=text-align:left><code>password</code></td><td style=text-align:left>The user&rsquo;s password</td></tr><tr><td style=text-align:left><code>host</code></td><td style=text-align:left>The host to connect to.</td></tr><tr><td style=text-align:left><code>port</code></td><td style=text-align:left>The port to bind to.</td></tr><tr><td style=text-align:left><code>secure</code></td><td style=text-align:left>to use a secure connection (for self-signed also add <code>skip_verify=1</code>)</td></tr></tbody></table><h4 id=replicated--distributed--cluster-environments>Replicated / Distributed / Cluster environments</h4><p><code>golang-migrate</code> supports a clustered ClickHouse environment since v4.15.0.</p><p>If you provide <code>x-cluster-name</code> query param, it will create the table to store migration data on the passed cluster.</p><h4 id=known-issues>Known issues</h4><p><code>could not load time location: unknown time zone Europe/Moscow in line 0:</code></p><p>It&rsquo;s happens due of missing tzdata package in migrate/migrate docker image of golang-migrate.
There is 2 possible solutions:</p><ol><li>You can build your own golang-migrate image from official with tzdata package.</li><li>If you using it as part of your CI you can add installing tzdata package as one of step in CI before using golang-migrate.</li></ol><p>Related GitHub issues:
<a href=https://github.com/golang-migrate/migrate/issues/494 target=_blank>https://github.com/golang-migrate/migrate/issues/494</a>
<a href=https://github.com/golang-migrate/migrate/issues/201 target=_blank>https://github.com/golang-migrate/migrate/issues/201</a></p><p>Using database name in <code>x-migrations-table</code></p><ol><li>Creates table with <code>database.table</code></li><li>When running migrations migrate actually uses database from query settings and encapsulate <code>database.table</code> as table name: ``other_database.`database.table```</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-3ea70b58bc10fe6596f9888998227ac9>57 - Settings to adjust</h1><div class=lead>Settings to adjust</div><ol><li><p><code>query_log</code> and other <code>_log</code> tables - set up TTL, or some other cleanup procedures.</p><pre tabindex=0><code class=language-markup data-lang=markup>cat /etc/clickhouse-server/config.d/query_log.xml
&lt;clickhouse&gt;
    &lt;query_log replace=&#34;1&#34;&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;query_log&lt;/table&gt;
        &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;
        &lt;engine&gt;
ENGINE = MergeTree
PARTITION BY event_date
ORDER BY (event_time)
TTL event_date + interval 90 day
SETTINGS ttl_only_drop_parts=1
        &lt;/engine&gt;
    &lt;/query_log&gt;
&lt;/clickhouse&gt;
</code></pre></li><li><p><code>query_thread_log</code> - typically is not too useful for end users, you can disable it (or set up TTL).
We do not recommend removing this table completely as you might need it for debug one day and the threads&rsquo; logging can be easily disabled/enabled without a restart through user profiles:</p><pre tabindex=0><code class=language-markup data-lang=markup> $ cat /etc/clickhouse-server/users.d/z_log_queries.xml
 &lt;clickhouse&gt;
     &lt;profiles&gt;
         &lt;default&gt;
             &lt;log_query_threads&gt;0&lt;/log_query_threads&gt;
         &lt;/default&gt;
     &lt;/profiles&gt;
 &lt;/clickhouse&gt;
</code></pre></li><li><p>If you have a good monitoring outside ClickHouse® you don&rsquo;t need to store the history of metrics in ClickHouse</p><pre tabindex=0><code class=language-markup data-lang=markup>cat /etc/clickhouse-server/config.d/disable_metric_logs.xml
&lt;clickhouse&gt;
    &lt;metric_log remove=&#34;1&#34; /&gt;
    &lt;asynchronous_metric_log remove=&#34;1&#34; /&gt;
&lt;/clickhouse&gt;
</code></pre></li><li><p><code>part_log</code> - may be nice, especially at the beginning / during system tuning/analyze.</p><pre tabindex=0><code class=language-markup data-lang=markup>cat /etc/clickhouse-server/config.d/part_log.xml
&lt;clickhouse&gt;
    &lt;part_log replace=&#34;1&#34;&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;part_log&lt;/table&gt;
        &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;
        &lt;engine&gt;
ENGINE = MergeTree
PARTITION BY toYYYYMM(event_date)
ORDER BY (event_time)
TTL toStartOfMonth(event_date) + INTERVAL 3 MONTH
SETTINGS ttl_only_drop_parts=1
        &lt;/engine&gt;
    &lt;/part_log&gt;
&lt;/clickhouse&gt;
</code></pre></li><li><p>on older versions <code>log_queries</code> is disabled by default, it&rsquo;s worth having it enabled always.</p><pre tabindex=0><code class=language-markup data-lang=markup>$ cat /etc/clickhouse-server/users.d/log_queries.xml
&lt;clickhouse&gt;
    &lt;profiles&gt;
        &lt;default&gt;
            &lt;log_queries&gt;1&lt;/log_queries&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/clickhouse&gt;
</code></pre></li><li><p>quite often you want to have on-disk group by / order by enabled (both disabled by default).</p><pre tabindex=0><code class=language-markup data-lang=markup>cat /etc/clickhouse-server/users.d/enable_on_disk_operations.xml
&lt;clickhouse&gt;
    &lt;profiles&gt;
        &lt;default&gt;
           &lt;max_bytes_before_external_group_by&gt;2000000000&lt;/max_bytes_before_external_group_by&gt;
           &lt;max_bytes_before_external_sort&gt;2000000000&lt;/max_bytes_before_external_sort&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/clickhouse&gt;
</code></pre></li><li><p>quite often you want to create more users with different limitations.
The most typical is <code>&lt;max_execution_time></code>
It&rsquo;s actually also not a way to plan/share existing resources better, but it at least disciplines users.</p><p>Also introducing some <a href=https://clickhouse.tech/docs/en/operations/settings/query-complexity/ target=_blank rel=nofollow>restrictions on query complexity</a>
can be a good option to discipline users.</p><p>You can find the preset example <a href=https://clickhouse.tech/docs/en/operations/settings/settings-profiles/ target=_blank rel=nofollow>here</a>
.
Also, force_index_by_date + force_primary_key can be a nice idea to avoid queries that &lsquo;accidentally&rsquo; do full scans, max_concurrent_queries_for_user</p></li><li><p>merge_tree settings: <code>max_bytes_to_merge_at_max_space_in_pool</code> (may be reduced in some scenarios), <code>inactive_parts_to_throw_insert</code> - can be enabled, <code>replicated_deduplication_window</code> - can be extended if single insert create lot of parts , <code>merge_with_ttl_timeout</code> - when you use ttl</p></li><li><p><code>insert_distributed_sync</code> - for small clusters you may sometimes want to enable it</p></li><li><p>when the durability is the main requirement (or server / storage is not stable) - you may want to enable <code>fsync_*</code> setting (impacts the write performance significantly!!), and <code>insert_quorum</code></p></li><li><p>If you use FINAL queries - usually you want to enable <code>do_not_merge_across_partitions_select_final</code></p></li><li><p>memory usage per server / query / user: <a href=/altinity-kb-setup-and-maintenance/altinity-kb-memory-configuration-settings/>memory configuration settings</a></p></li><li><p>if you use async_inserts - you often may want to increase max_concurrent_queries</p></li></ol><pre tabindex=0><code>&lt;clickhouse&gt;
    &lt;max_concurrent_queries&gt;500&lt;/max_concurrent_queries&gt;
    &lt;max_concurrent_insert_queries&gt;400&lt;/max_concurrent_insert_queries&gt;
    &lt;max_concurrent_select_queries&gt;100&lt;/max_concurrent_select_queries&gt;
&lt;/clickhouse&gt;
</code></pre><ol start=11><li>materialize_ttl_after_modify=0</li><li>access_management=1</li><li>secret in &lt;remote_servers></li></ol><p>See also:</p><p><a href=https://docs.altinity.com/operationsguide/security/clickhouse-hardening-guide/ target=_blank>https://docs.altinity.com/operationsguide/security/clickhouse-hardening-guide/</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f46a585ead49a5db2d19ee263d652ffa>58 - Shutting down a node</h1><div class=lead>Shutting down a node</div><p>It’s possible to shutdown server on fly, but that would lead to failure of some queries.</p><p>More safer way:</p><ul><li><p>Remove server (which is going to be disabled) from remote_server section of config.xml on all servers.</p><ul><li>avoid removing the last replica of the shard (that can lead to incorrect data placement if you use non-random distribution)</li></ul></li><li><p>Remove server from load balancer, so new queries wouldn’t hit it.</p></li><li><p>Detach Kafka / Rabbit / Buffer tables (if used), and Materialized* databases.</p></li><li><p>Wait until all already running queries would finish execution on it.
It’s possible to check it via query:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PROCESSLIST</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Ensure there is no pending data in distributed tables</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>distribution_queue</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FLUSH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DISTRIBUTED</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Run sync replica query in related shard replicas (others than the one you remove) via query:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SYNC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Shutdown server.</p></li></ul><p><code>SYSTEM SHUTDOWN</code> query by default doesn’t wait until query completion and tries to kill all queries immediately after receiving signal, if you want to change this behavior, you need to enable setting <code>shutdown_wait_unfinished_queries</code>.</p><p><a href=https://github.com/ClickHouse/ClickHouse/blob/d705f8ead4bdc837b8305131844f558ec002becc/programs/server/Server.cpp#L1682 target=_blank>https://github.com/ClickHouse/ClickHouse/blob/d705f8ead4bdc837b8305131844f558ec002becc/programs/server/Server.cpp#L1682</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ea9b4077205d7c579bd465b784e33e77>59 - SSL connection unexpectedly closed</h1><div class=lead>SSL connection unexpectedly closed</div><p>ClickHouse doesn&rsquo;t probe CA path which is default on CentOS and Amazon Linux.</p><h2 id=clickhouse-client>ClickHouse client</h2><pre tabindex=0><code class=language-markup data-lang=markup>cat /etc/clickhouse-client/conf.d/openssl-ca.xml
&lt;config&gt;
    &lt;openSSL&gt;
        &lt;client&gt; &lt;!-- Used for connection to server&#39;s secure tcp port --&gt;
            &lt;caConfig&gt;/etc/ssl/certs&lt;/caConfig&gt;
        &lt;/client&gt;
    &lt;/openSSL&gt;
&lt;/config&gt;
</code></pre><h2 id=clickhouse-server>ClickHouse server</h2><pre tabindex=0><code class=language-markup data-lang=markup>cat /etc/clickhouse-server/conf.d/openssl-ca.xml
&lt;config&gt;
    &lt;openSSL&gt;
        &lt;server&gt;  &lt;!-- Used for https server AND secure tcp port --&gt;
            &lt;caConfig&gt;/etc/ssl/certs&lt;/caConfig&gt;
        &lt;/server&gt;
        &lt;client&gt;  &lt;!-- Used for connecting to https dictionary source and secured Zookeeper communication --&gt;
            &lt;caConfig&gt;/etc/ssl/certs&lt;/caConfig&gt;
        &lt;/client&gt;
    &lt;/openSSL&gt;
&lt;/config&gt;
</code></pre><p><a href=https://github.com/ClickHouse/ClickHouse/issues/17803 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/17803</a></p><p><a href=https://github.com/ClickHouse/ClickHouse/issues/18869 target=_blank>https://github.com/ClickHouse/ClickHouse/issues/18869</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ec43a5205301eb00c48712282b7243ed>60 - Suspiciously many broken parts</h1><div class=lead>Debugging a common error message</div><h2 id=symptom>Symptom:</h2><p>clickhouse fails to start with a message <code>DB::Exception: Suspiciously many broken parts to remove.</code></p><h2 id=cause>Cause:</h2><p>That exception is just a safeguard check/circuit breaker, triggered when clickhouse detects a lot of broken parts during server startup.</p><p>Parts are considered broken if they have bad checksums or some files are missing or malformed. Usually, that means the data was corrupted on the disk.</p><p>Why data could be corrupted?</p><ol><li><p>the most often reason is a hard restart of the system, leading to a loss of the data which was not fully flushed to disk from the system page cache. Please be aware that by default ClickHouse doesn&rsquo;t do fsync, so data is considered inserted after it was passed to the Linux page cache. See fsync-related settings in ClickHouse.</p></li><li><p>it can also be caused by disk failures, maybe there are bad blocks on hard disk, or logical problems, or some raid issue. Check system journals, use <code>fsck</code> / <code>mdadm</code> and other standard tools to diagnose the disk problem.</p></li><li><p>other reasons: manual intervention/bugs etc, for example, the data files or folders are removed by mistake or moved to another folder.</p></li></ol><h2 id=action>Action:</h2><ol><li><p>If you are ok to accept the <a href=/altinity-kb-setup-and-maintenance/recovery-after-complete-data-loss/>data loss</a>
: set up <code>force_restore_data</code> flag and clickhouse will move the parts to detached. Data loss is possible if the issue is a result of misconfiguration (i.e. someone accidentally has fixed xml configs with incorrect <a href=https://altinity.com/webinarspage/deep-dive-on-clickhouse-sharding-and-replication target=_blank>shard/replica macros</a>
, data will be moved to detached folder and can be recovered).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
</span></span></code></pre></div><p>then restart clickhouse. the table will be attached, and the broken parts will be detached, which means the data from those parts will not be available for the selects. You can see the list of those parts in the <code>system.detached_parts</code> table and drop them if needed using <code>ALTER TABLE ... DROP DETACHED PART ...</code> commands.</p><p>If you are ok to tolerate bigger losses automatically you can change that safeguard configuration to be less sensitive by increasing <code>max_suspicious_broken_parts</code> setting:</p><pre tabindex=0><code>cat /etc/clickhouse-server/config.d/max_suspicious_broken_parts.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
     &lt;merge_tree&gt;
         &lt;max_suspicious_broken_parts&gt;50&lt;/max_suspicious_broken_parts&gt;
     &lt;/merge_tree&gt;
&lt;/clickhouse&gt;
</code></pre><p>this limit is set to 100 by default in recent releases. We can set a bigger value (250 or more), but the data will be lost because of the corruption.</p><p>Check out also a similar setting <code>max_suspicious_broken_parts_bytes</code>.<br>See <a href=https://clickhouse.com/docs/en/operations/settings/merge-tree-settings/ target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/settings/merge-tree-settings/</a></p></li><li><p>If you can&rsquo;t accept the data loss - you should recover data from backups / re-insert it once again etc.</p><p>If you don&rsquo;t want to tolerate automatic detaching of broken parts, you can set <code>max_suspicious_broken_parts_bytes</code> and <code>max_suspicious_broken_parts</code> to 0.</p></li></ol><h2 id=scenario-illustrating--testing>Scenario illustrating / testing</h2><ol><li>Create table</li></ol><pre tabindex=0><code>create table t111(A UInt32) Engine=MergeTree order by A settings max_suspicious_broken_parts=1;
insert into t111 select number from numbers(100000);
</code></pre><ol start=2><li>Detach the table and make Data corruption</li></ol><pre tabindex=0><code>detach table t111;
</code></pre><p>cd /var/lib/clickhouse/data/default/t111/all_***
make data file corruption:</p><pre tabindex=0><code>&gt; data.bin
</code></pre><p>repeat for 2 or more data files.</p><ol start=3><li>Attach the table:</li></ol><pre tabindex=0><code>attach table t111;
 
Received exception from server (version 21.12.3):
Code: 231. DB::Exception: Received from localhost:9000. DB::Exception: Suspiciously many (2) broken parts to remove.. (TOO_MANY_UNEXPEC
</code></pre><ol start=4><li>setup force_restore_data flag</li></ol><pre tabindex=0><code>sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
sudo service clickhouse-server restart
</code></pre><p>then the table <code>t111</code> will be attached, losing the corrupted data.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-14dc574ea90d3f73fbe3876ff659dd99>61 - Threads</h1><div class=lead>Threads</div><h3 id=count-threads-used-by-clickhouse-server>Count threads used by clickhouse-server</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /proc/<span style=color:#204a87;font-weight:700>$(</span>pidof -s clickhouse-server<span style=color:#204a87;font-weight:700>)</span>/status <span style=color:#000;font-weight:700>|</span> grep Threads
</span></span><span style=display:flex><span>Threads: <span style=color:#0000cf;font-weight:700>103</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ps hH <span style=color:#204a87;font-weight:700>$(</span>pidof -s clickhouse-server<span style=color:#204a87;font-weight:700>)</span> <span style=color:#000;font-weight:700>|</span> wc -l
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>103</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ps hH -AF <span style=color:#000;font-weight:700>|</span> grep clickhouse <span style=color:#000;font-weight:700>|</span> wc -l
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>116</span>
</span></span></code></pre></div><h3 id=thread-counts-by-type-using-ps--clickhouse-local>Thread counts by type (using ps & clickhouse-local)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ps H -o <span style=color:#4e9a06>&#39;tid comm&#39;</span> <span style=color:#204a87;font-weight:700>$(</span>pidof -s clickhouse-server<span style=color:#204a87;font-weight:700>)</span> <span style=color:#000;font-weight:700>|</span>  tail -n +2 <span style=color:#000;font-weight:700>|</span> awk <span style=color:#4e9a06>&#39;{ printf(&#34;%s\t%s\n&#34;, $1, $2) }&#39;</span> <span style=color:#000;font-weight:700>|</span> clickhouse-local -S <span style=color:#4e9a06>&#34;threadid UInt16, name String&#34;</span> -q <span style=color:#4e9a06>&#34;SELECT name, count() FROM table GROUP BY name WITH TOTALS ORDER BY count() DESC FORMAT PrettyCompact&#34;</span>
</span></span></code></pre></div><h3 id=threads-used-by-running-queries>Threads used by running queries:</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>length</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>thread_ids</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>threads_count</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>processes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>threads_count</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=thread-pools-limits--usage>Thread pools limits & usage</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%pool%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>─────────────────────────────────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>connection_pool_max_wait_ms</span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>distributed_connections_pool_size</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>background_buffer_flush_schedule_pool_size</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>background_pool_size</span><span style=color:#f8f8f8;text-decoration:underline>                         </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>background_move_pool_size</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>background_fetches_pool_size</span><span style=color:#f8f8f8;text-decoration:underline>                 </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>background_schedule_pool_size</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>background_message_broker_schedule_pool_size</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>background_distributed_schedule_pool_size</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>postgresql_connection_pool_size</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>postgresql_connection_pool_wait_timeout</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>odbc_bridge_connection_pool_size</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────────────────────────────┴───────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metric</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Background%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>metric</span><span style=color:#a40000>──────────────────────────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackgroundPoolTask</span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackgroundFetchesPoolTask</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackgroundMovePoolTask</span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackgroundSchedulePoolTask</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackgroundBufferFlushSchedulePoolTask</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackgroundDistributedSchedulePoolTask</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackgroundMessageBrokerSchedulePoolTask</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────────────────────────────┴───────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>lower</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>metric</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%thread%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ASC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>metric</span><span style=color:#a40000>───────────────────────────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPThreads</span><span style=color:#f8f8f8;text-decoration:underline>                              </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>InterserverThreads</span><span style=color:#f8f8f8;text-decoration:underline>                       </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MySQLThreads</span><span style=color:#f8f8f8;text-decoration:underline>                             </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OSThreadsRunnable</span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OSThreadsTotal</span><span style=color:#f8f8f8;text-decoration:underline>                           </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>2910</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PostgreSQLThreads</span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCPThreads</span><span style=color:#f8f8f8;text-decoration:underline>                               </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>jemalloc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>background_thread</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>num_runs</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>jemalloc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>background_thread</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>num_threads</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>jemalloc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>background_thread</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>run_intervals</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────────────────────────────────────┴───────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>lower</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>metric</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%thread%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ASC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000>acbb596</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>e28f</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000>f89</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>94</span><span style=color:#000>b2</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>27</span><span style=color:#000>dccfe88ee9</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>metric</span><span style=color:#a40000>─────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>───────────────────────────────────────────────────────────────────────────────────────────────────────┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GlobalThread</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>151</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>threads</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thread</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pool</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>                                                                          </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GlobalThreadActive</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>144</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>threads</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thread</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pool</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>running</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>task</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>                                                           </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LocalThread</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>threads</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thread</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pools</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>The</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>threads</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thread</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pools</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>are</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>taken</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>the</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thread</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pool</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LocalThreadActive</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>threads</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thread</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pools</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>running</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>task</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>                                                           </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>QueryThread</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>processing</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>threads</span><span style=color:#f8f8f8;text-decoration:underline>                                                                                </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└────────────────────┴───────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=stack-traces-of-the-working-threads-from-the-pools>Stack traces of the working threads from the pools</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow_introspection_functions</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayMap</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>demangle</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>addressToSymbol</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>trace</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>all</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>thread_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>query_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>arrayStringConcat</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;\n&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>res</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>stack_trace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>res</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ILIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Pool%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Vertical</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-403fab8125b657a5a3d0f82db33c7544>62 - Who ate my ClickHouse® memory?</h1><div class=lead><em>&ldquo;It was here a few minutes ago&mldr;&rdquo;</em></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JEMALLOC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PURGE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;OS&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;OSMemory%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Caches&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%CacheBytes&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Caches&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%CacheBytes&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;MMaps&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;MMappedFileBytes&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Process&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Memory%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;MemoryTable&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>total_bytes</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tables</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Join&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Memory&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Buffer&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Set&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;StorageBuffer&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;StorageBufferBytes&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Queries&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>left</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>memory_usage</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>processes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Dictionaries&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_allocated</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dictionaries</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;PrimaryKeys&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;db:&#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>primary_key_bytes_in_memory_allocated</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Merges&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;db:&#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>memory_usage</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>merges</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;InMemoryParts&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;db:&#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data_uncompressed_bytes</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;InMemory&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;AsyncInserts&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;db:&#39;</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>total_bytes</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_inserts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;FileBuffersVirtual&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;OpenFileFor%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;ThreadStacksVirual&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;GlobalThread&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;UserMemoryTracking&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>memory_usage</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_processes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;QueryCacheBytes&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>result_size</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_cache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;MemoryTracking&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;total&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;MemoryTracking&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metrics</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ilike</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Cach%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>or</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ilike</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Mem%&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PrettyCompactMonoBlock</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_metrics</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Cach%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>or</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Mem%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PrettyCompactMonoBlock</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>asynchronous_metric_log</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>600</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Cach%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>or</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Mem%&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PrettyCompactMonoBlock</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes_allocated</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dictionaries</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>total_bytes</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tables</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Memory&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Set&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Join&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>sumIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data_uncompressed_bytes</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;InMemory&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory_parts</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>primary_key_bytes_in_memory</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>primary_key_bytes_in_memory</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>primary_key_bytes_in_memory_allocated</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>primary_key_bytes_in_memory_allocated</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>memory_usage</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>merges</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>memory_usage</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>processes</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>result_size</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_cache</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>initial_query_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>elapsed</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>memory_usage</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>peak_memory_usage</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>query</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>processes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>peak_memory_usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>event_time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>initial_query_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>memory_usage</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>query</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_log</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_date</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>today</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7200</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory_usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#4e9a06>`</span>seq <span style=color:#0000cf;font-weight:700>1</span> 600<span style=color:#4e9a06>`</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> clickhouse-client --empty_result_for_aggregation_by_empty_set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> -q <span style=color:#4e9a06>&#34;select (select &#39;Merges: \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>&#39;||formatReadableSize(sum(memory_usage)) from system.merges), (select \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>&#39;Processes: &#39;||formatReadableSize(sum(memory_usage)) from system.processes)&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>sleep 3<span style=color:#000;font-weight:700>;</span>  <span style=color:#204a87;font-weight:700>done</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Merges: 96.57 MiB	Processes: 41.98 MiB
</span></span><span style=display:flex><span>Merges: 82.24 MiB	Processes: 41.91 MiB
</span></span><span style=display:flex><span>Merges: 66.33 MiB	Processes: 41.91 MiB
</span></span><span style=display:flex><span>Merges: 66.49 MiB	Processes: 37.13 MiB
</span></span><span style=display:flex><span>Merges: 67.78 MiB	Processes: 37.13 MiB
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;         Merges      Processes       PrimaryK       TempTabs          Dicts&#34;</span><span style=color:#000;font-weight:700>;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#4e9a06>`</span>seq <span style=color:#0000cf;font-weight:700>1</span> 600<span style=color:#4e9a06>`</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> clickhouse-client --empty_result_for_aggregation_by_empty_set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>  -q <span style=color:#4e9a06>&#34;select \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>(select leftPad(formatReadableSize(sum(memory_usage)),15, &#39; &#39;) from system.merges)||
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>(select leftPad(formatReadableSize(sum(memory_usage)),15, &#39; &#39;) from system.processes)||
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>(select leftPad(formatReadableSize(sum(primary_key_bytes_in_memory_allocated)),15, &#39; &#39;) from system.parts)|| \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>(select leftPad(formatReadableSize(sum(total_bytes)),15, &#39; &#39;) from system.tables \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06> WHERE engine IN (&#39;Memory&#39;,&#39;Set&#39;,&#39;Join&#39;))||
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>(select leftPad(formatReadableSize(sum(bytes_allocated)),15, &#39; &#39;) FROM system.dictionaries)
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>;</span> sleep 3<span style=color:#000;font-weight:700>;</span>  <span style=color:#204a87;font-weight:700>done</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         Merges      Processes       PrimaryK       TempTabs          Dicts
</span></span><span style=display:flex><span>         0.00 B         0.00 B      21.36 MiB       1.58 GiB     911.07 MiB
</span></span><span style=display:flex><span>         0.00 B         0.00 B      21.36 MiB       1.58 GiB     911.07 MiB
</span></span><span style=display:flex><span>         0.00 B         0.00 B      21.35 MiB       1.58 GiB     911.07 MiB
</span></span><span style=display:flex><span>         0.00 B         0.00 B      21.36 MiB       1.58 GiB     911.07 MiB
</span></span></code></pre></div><h2 id=retrospection-analysis-of-the-ram-usage-based-on-query_log-and-part_log-shows-peaks>retrospection analysis of the RAM usage based on query_log and part_log (shows peaks)</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>INTERVAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HOUR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- you can adjust that
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic>-- you can adjust that
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>INTERVAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HOUR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>time_frame_size</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>toStartOfInterval</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_timestamp</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>time_frame_size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeframe</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mem_overall</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>peak_ram</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>maxIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mem_by_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Insert&#39;</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inserts_ram</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>maxIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mem_by_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Select&#39;</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>selects_ram</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>maxIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mem_by_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;MergeParts&#39;</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>merge_ram</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>maxIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mem_by_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;MutatePart&#39;</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mutate_ram</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>maxIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mem_by_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Alter&#39;</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>alter_ram</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>maxIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mem_by_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Create&#39;</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>create_ram</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>maxIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mem_by_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Insert&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Select&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;MergeParts&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;MutatePart&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Alter&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Create&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other_types_ram</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>groupUniqArrayIf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Insert&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Select&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;MergeParts&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;MutatePart&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Alter&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Create&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other_types</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>toDateTime</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toUInt32</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_timestamp</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>t</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>SUM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mem</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OVER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mem_by_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>SUM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mem</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OVER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mem_overall</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>([(</span><span style=color:#000>toFloat64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_time_microseconds</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>duration_ms</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>peak_memory_usage</span><span style=color:#000;font-weight:700>)),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toFloat64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_time_microseconds</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>peak_memory_usage</span><span style=color:#000;font-weight:700>)])</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;LowCardinality(String)&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mem</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>part_log</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BETWEEN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>peak_memory_usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>([(</span><span style=color:#000>toFloat64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>query_start_time_microseconds</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>memory_usage</span><span style=color:#000;font-weight:700>)),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toFloat64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_time_microseconds</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>memory_usage</span><span style=color:#000;font-weight:700>)])</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>query_kind</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mem</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_log</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BETWEEN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory_usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>([(</span><span style=color:#000>toFloat64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_time_microseconds</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>view_duration_ms</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toInt64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>peak_memory_usage</span><span style=color:#000;font-weight:700>)),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toFloat64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_time_microseconds</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>peak_memory_usage</span><span style=color:#000;font-weight:700>)])</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>CAST</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>view_type</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#4e9a06>&#39;View&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;LowCardinality(String)&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mem</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>query_views_log</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BETWEEN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>peak_memory_usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeframe</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeframe</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PrettyCompactMonoBlock</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=retrospection-analysis-of-trace_log>retrospection analysis of trace_log</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>INTERVAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HOUR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- you can adjust that
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_time</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic>-- you can adjust that
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>trace_type</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>topK</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>query_id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>trace_log</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>event_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BETWEEN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_time</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>trace_type</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>queries</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>peak_size</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sum_of_peaks</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>formatReadableSize</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>peak_size</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>biggest_query_peak</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>query_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>peak_size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>toStartOfInterval</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toIntervalMinute</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>query_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>peak_size</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>trace_log</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>trace_type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;MemoryPeak&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>event_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toIntervalHour</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>query_id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ASC</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- later on you can check particular query_ids in query_log
</span></span></span></code></pre></div><h2 id=analysis-of-the-server-text-logs>analysis of the server text logs</h2><pre tabindex=0><code>grep MemoryTracker /var/log/clickhouse-server.log
zgrep MemoryTracker /var/log/clickhouse-server.log.*.gz
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-001c962263e4fe6ade35b2640d581f26>63 - X rows of Y total rows in filesystem are suspicious</h1><div class=lead>X rows of Y total rows in filesystem are suspicious</div><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4>The local set of parts of table doesn&rsquo;t look like the set of parts in ZooKeeper. 100.00 rows of 150.00 total rows in filesystem are suspicious. There are 1 unexpected parts with 100 rows (1 of them is not just-written with 100 rows), 0 missing parts (with 0 blocks).: Cannot attach table.</div><p>ClickHouse has a registry of parts in ZooKeeper.</p><p>And during the start ClickHouse compares that list of parts on a local disk is consistent with a list in ZooKeeper. If the lists are too different ClickHouse denies to start because it could be an issue with settings, wrong Shard or wrong Replica macros. But this safe-limiter throws an exception if the difference is more 50% (in rows).</p><p>In your case the table is very small and the difference >50% ( 100.00 vs 150.00 ) is only a single part mismatch, which can be the result of hard restart.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>merge_tree_settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;replicated_max_ratio_of_wrong_parts&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>────────────────────────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>changed</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>──────────────────────────────────────────────────────────────────────────┬─</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#a40000>──┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replicated_max_ratio_of_wrong_parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>If</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratio</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>wrong</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>total</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>is</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>less</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>than</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>this</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>start</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Float</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────────────────────────────────────┴───────┴─────────┴──────────────────────────────────────────────────────────────────────────────────────┴───────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>You can set another value of <code>replicated_max_ratio_of_wrong_parts</code> for all MergeTree tables or per table.</p><p><a href=https://clickhouse.tech/docs/en/operations/settings/merge-tree-settings target=_blank rel=nofollow>https://clickhouse.tech/docs/en/operations/settings/merge-tree-settings</a></p><h2 id=after-manipulation-with-storage_policies-and-disks>After manipulation with storage_policies and disks</h2><p>When storage policy changes (one disk was removed from it), ClickHouse compared parts on disk and this replica state in ZooKeeper and found out that a lot of parts (from removed disk) disappeared. So ClickHouse removed them from the replica state in ZooKeeper and scheduled to fetch them from other replicas.</p><p>After we add the removed disk to storage_policy back, ClickHouse finds missing parts, but at this moment they are not registered for that replica.
ClickHouse produce error message like this:</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4><error>Application: DB::Exception: The local set of parts of table default.tbl doesn&rsquo;t look like the set of parts in ZooKeeper: 14.96 billion rows of 16.24 billion total rows in filesystem are suspicious. There are 45 unexpected parts with 14960302620 rows (43 of them is not just-written with 14959824636 rows), 0 missing parts (with 0 blocks).: Cannot attach table <code>default</code>.<code>tbl</code> from metadata file /var/lib/clickhouse/metadata/default/tbl.sql from query ATTACH TABLE default.tbl &mldr; ENGINE=ReplicatedMergeTree(&rsquo;/clickhouse/tables/0/default/tbl&rsquo;, &lsquo;replica-0&rsquo;)&mldr; SETTINGS index_granularity = 1024, storage_policy = &rsquo;ebs_hot_and_cold&rsquo;: while loading database <code>default</code> from path /var/lib/clickhouse/metadata/data</div><p>At this point, it&rsquo;s possible to either tune setting <code>replicated_max_ratio_of_wrong_parts</code> or do force restore, but it will end up downloading all &ldquo;missing&rdquo; parts from other replicas, which can take a lot of time for big tables.</p><h3 id=clickhouse-217>ClickHouse 21.7+</h3><ol><li>Rename table SQL attach script in order to prevent ClickHouse from attaching it at startup.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mv /var/lib/clickhouse/metadata/default/tbl.sql /var/lib/clickhouse/metadata/default/tbl.sql.bak
</span></span></code></pre></div><ol start=2><li><p>Start ClickHouse server.</p></li><li><p>Remove metadata for this replica from ZooKeeper.</p></li></ol><pre tabindex=0><code>SYSTEM DROP REPLICA &#39;replica-0&#39; FROM ZKPATH &#39;/clickhouse/tables/0/default/tbl&#39;;

SELECT * FROM system.zookeeper WHERE path = &#39;/clickhouse/tables/0/default/tbl/replicas&#39;;
</code></pre><ol start=4><li>Rename table SQL attach script back to normal name.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mv /var/lib/clickhouse/metadata/default/tbl.sql.bak /var/lib/clickhouse/metadata/default/tbl.sql
</span></span></code></pre></div><ol start=5><li>Attach table to ClickHouse server, because there is no metadata in ZooKeeper, ClickHouse will attach it in read only state.</li></ol><pre tabindex=0><code>ATTACH TABLE default.tbl;
</code></pre><ol start=6><li>Run <code>SYSTEM RESTORE REPLICA</code> in order to sync state on disk and in ZooKeeper.</li></ol><pre tabindex=0><code>SYSTEM RESTORE REPLICA default.tbl;
</code></pre><ol start=7><li>Run <code>SYSTEM SYNC REPLICA</code> to download missing parts from other replicas.</li></ol><pre tabindex=0><code>SYSTEM SYNC REPLICA default.tbl;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-475baf90f39df7559ac79d0838516eba>64 - ZooKeeper</h1><div class=lead>ZooKeeper</div><h3 id=requirements>Requirements</h3><p>TLDR version:</p><ol><li>USE DEDICATED FAST DISKS for the transaction log! (crucial for performance due to write-ahead-log, NVMe is preferred for heavy load setup).</li><li>use 3 nodes (more nodes = slower quorum, less = no HA).</li><li>low network latency between zookeeper nodes is very important (latency, not bandwidth).</li><li>have at least 4Gb of RAM, disable swap, <a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/jvm-sizes-and-garbage-collector-settings/ target=_blank>tune JVM sizes, and garbage collector settings</a></li><li>ensure that zookeeper will not be CPU-starved by some other processes</li><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/zookeeper-monitoring/ target=_blank>monitor zookeeper</a>
.</li></ol><p>Side note:
in many cases, the slowness of the zookeeper is actually a symptom of some issue with ClickHouse® schema/usage pattern (the most typical issues: an enormous number of partitions/tables/databases with real-time inserts, tiny & frequent inserts).</p><h3 id=how-to-install>How to install</h3><ul><li><a href=https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/ target=_blank>https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/</a></li><li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/>altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/</a></li></ul><h3 id=random-links-on-best-practices>Random links on best practices</h3><ul><li><a href=https://docs.confluent.io/platform/current/zookeeper/deployment.html target=_blank>https://docs.confluent.io/platform/current/zookeeper/deployment.html</a></li><li><a href=https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems target=_blank>https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems</a></li><li><a href=https://clickhouse.tech/docs/en/operations/tips/#zookeeper target=_blank rel=nofollow>https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a></li><li><a href=https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html target=_blank>https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html</a></li><li><a href=https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting target=_blank>https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting</a></li></ul><p>Cite from <a href=https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems target=_blank>https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems</a>
:</p><blockquote><h2 id=things-to-avoid>Things to Avoid</h2><p>Here are some common problems you can avoid by configuring ZooKeeper correctly:</p><ul><li><em>inconsistent lists of servers</em> : The list of ZooKeeper servers used by the clients must match the list of ZooKeeper servers that each ZooKeeper server has. Things work okay if the client list is a subset of the real list, but things will really act strange if clients have a list of ZooKeeper servers that are in different ZooKeeper clusters. Also, the server lists in each Zookeeper server configuration file should be consistent with one another.</li><li><em>incorrect placement of transaction log</em> : The most performance critical part of ZooKeeper is the transaction log. ZooKeeper syncs transactions to media before it returns a response. A dedicated transaction log device is key to consistent good performance. Putting the log on a busy device will adversely affect performance. If you only have one storage device, increase the snapCount so that snapshot files are generated less often; it does not eliminate the problem, but it makes more resources available for the transaction log.</li><li><em>incorrect Java heap size</em> : You should take special care to set your Java max heap size correctly. In particular, you should not create a situation in which ZooKeeper swaps to disk. The disk is death to ZooKeeper. Everything is ordered, so if processing one request swaps the disk, all other queued requests will probably do the same. the disk. DON&rsquo;T SWAP. Be conservative in your estimates: if you have 4G of RAM, do not set the Java max heap size to 6G or even 4G. For example, it is more likely you would use a 3G heap for a 4G machine, as the operating system and the cache also need memory. The best and only recommend practice for estimating the heap size your system needs is to run load tests, and then make sure you are well below the usage limit that would cause the system to swap.</li><li><em>Publicly accessible deployment</em> : A ZooKeeper ensemble is expected to operate in a trusted computing environment. It is thus recommended to deploy ZooKeeper behind a firewall.</li></ul></blockquote><h3 id=how-to-check-number-of-followers>How to check number of followers:</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>echo</span> mntr <span style=color:#000;font-weight:700>|</span> nc zookeeper <span style=color:#0000cf;font-weight:700>2187</span> <span style=color:#000;font-weight:700>|</span> grep foll
</span></span><span style=display:flex><span>zk_synced_followers    <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>zk_synced_non_voting_followers    <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>zk_avg_follower_sync_time    0.0
</span></span><span style=display:flex><span>zk_min_follower_sync_time    <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>zk_max_follower_sync_time    <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>zk_cnt_follower_sync_time    <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>zk_sum_follower_sync_time    <span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div><h2 id=tools>Tools</h2><p><a href=https://github.com/apache/zookeeper/blob/master/zookeeper-docs/src/main/resources/markdown/zookeeperTools.md target=_blank>https://github.com/apache/zookeeper/blob/master/zookeeper-docs/src/main/resources/markdown/zookeeperTools.md</a></p><h2 id=alternative-for-zkcli>Alternative for zkCli</h2><ul><li><a href=https://github.com/go-zkcli/zkcli target=_blank>https://github.com/go-zkcli/zkcli</a></li></ul><h2 id=web-ui>Web UI</h2><ul><li><a href=https://github.com/elkozmon/zoonavigator-api target=_blank>https://github.com/elkozmon/zoonavigator-api</a></li><li><a href=https://github.com/tobilg/docker-zookeeper-webui target=_blank>https://github.com/tobilg/docker-zookeeper-webui</a></li><li><a href=https://github.com/vran-dev/PrettyZoo target=_blank>https://github.com/vran-dev/PrettyZoo</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fe6c92b41d659a61ae843a9c968db4e3>64.1 - clickhouse-keeper-initd</h1><div class=lead>clickhouse-keeper-initd</div><h2 id=clickhouse-keeper-initd>clickhouse-keeper-initd</h2><p>An init.d script for clickhouse-keeper.
This example is based on zkServer.sh</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>### BEGIN INIT INFO</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Provides:          clickhouse-keeper</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Default-Start:     2 3 4 5</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Default-Stop:      0 1 6</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Required-Start:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Required-Stop:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Short-Description: Start keeper daemon</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Description: Start keeper daemon</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>### END INIT INFO</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>NAME</span><span style=color:#ce5c00;font-weight:700>=</span>clickhouse-keeper
</span></span><span style=display:flex><span><span style=color:#000>ZOOCFGDIR</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/<span style=color:#000>$NAME</span>
</span></span><span style=display:flex><span><span style=color:#000>ZOOCFG</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOCFGDIR</span><span style=color:#4e9a06>/keeper.xml&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>ZOO_LOG_DIR</span><span style=color:#ce5c00;font-weight:700>=</span>/var/log/<span style=color:#000>$NAME</span>
</span></span><span style=display:flex><span><span style=color:#000>USER</span><span style=color:#ce5c00;font-weight:700>=</span>clickhouse
</span></span><span style=display:flex><span><span style=color:#000>GROUP</span><span style=color:#ce5c00;font-weight:700>=</span>clickhouse
</span></span><span style=display:flex><span><span style=color:#000>ZOOPIDDIR</span><span style=color:#ce5c00;font-weight:700>=</span>/var/run/<span style=color:#000>$NAME</span>
</span></span><span style=display:flex><span><span style=color:#000>ZOOPIDFILE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ZOOPIDDIR</span>/<span style=color:#000>$NAME</span>.pid
</span></span><span style=display:flex><span><span style=color:#000>SCRIPTNAME</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/init.d/<span style=color:#000>$NAME</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#echo &#34;Using config: $ZOOCFG&#34; &gt;&amp;2</span>
</span></span><span style=display:flex><span><span style=color:#000>ZOOCMD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;clickhouse-keeper -C </span><span style=color:#4e9a06>${</span><span style=color:#000>ZOOCFG</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> start --daemon&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ensure PIDDIR exists, otw stop will fail</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span>dirname <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -w <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOO_LOG_DIR</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOO_LOG_DIR</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>$1</span> in
</span></span><span style=display:flex><span>start<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> -n <span style=color:#4e9a06>&#34;Starting keeper ... &#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -f <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>kill</span> -0 <span style=color:#4e9a06>`</span>cat <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>`</span> &gt; /dev/null 2&gt;<span style=color:#000;font-weight:700>&amp;</span>1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87>echo</span> already running as process <span style=color:#4e9a06>`</span>cat <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>`</span>.
</span></span><span style=display:flex><span>         <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    sudo -u clickhouse <span style=color:#4e9a06>`</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOCMD</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$?</span> -eq <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>      pgrep -f <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOCMD</span><span style=color:#4e9a06>&#34;</span> &gt; <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;PID:&#34;</span> <span style=color:#4e9a06>`</span>cat <span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$?</span> -eq <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        sleep <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> STARTED
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> FAILED TO WRITE PID
</span></span><span style=display:flex><span>        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>echo</span> SERVER DID NOT START
</span></span><span style=display:flex><span>      <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>start-foreground<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    sudo -u clickhouse clickhouse-keeper -C <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOCFG</span><span style=color:#4e9a06>&#34;</span> start
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>print-cmd<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;sudo -u clickhouse </span><span style=color:#4e9a06>${</span><span style=color:#000>ZOOCMD</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>stop<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> -n <span style=color:#4e9a06>&#34;Stopping keeper ... &#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -f <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;no keeper to stop (could not find file </span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>)&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ZOOPID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>cat <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>echo</span> <span style=color:#000>$ZOOPID</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>kill</span> <span style=color:#000>$ZOOPID</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>         sleep <span style=color:#0000cf;font-weight:700>3</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>kill</span> -0 <span style=color:#000>$ZOOPID</span> &gt; /dev/null 2&gt;<span style=color:#000;font-weight:700>&amp;</span>1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#000>$ZOOPID</span> is still running
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>      rm <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>echo</span> STOPPED
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>restart<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>shift</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;</span><span style=color:#000>$0</span><span style=color:#4e9a06>&#34;</span> stop <span style=color:#4e9a06>${</span><span style=color:#000;font-weight:700>@</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#0000cf;font-weight:700>3</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;</span><span style=color:#000>$0</span><span style=color:#4e9a06>&#34;</span> start <span style=color:#4e9a06>${</span><span style=color:#000;font-weight:700>@</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>status<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>clientPortAddress</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>clientPort</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2181</span>
</span></span><span style=display:flex><span>    <span style=color:#000>STAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>`</span><span style=color:#204a87>echo</span> srvr <span style=color:#000;font-weight:700>|</span> nc <span style=color:#000>$clientPortAddress</span> <span style=color:#000>$clientPort</span> 2&gt; /dev/null <span style=color:#000;font-weight:700>|</span> grep Mode<span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;x</span><span style=color:#000>$STAT</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;x&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Error contacting service. It is probably not running.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#000>$STAT</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>*<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Usage: </span><span style=color:#000>$0</span><span style=color:#4e9a06> {start|start-foreground|stop|restart|status|print-cmd}&#34;</span> &gt;<span style=color:#000;font-weight:700>&amp;</span><span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>esac</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-582314d0ec1bd636faae316fd661315c>64.2 - clickhouse-keeper-service</h1><div class=lead>clickhouse-keeper-service</div><h2 id=clickhouse-keeper-service>clickhouse-keeper-service</h2><h3 id=installation>installation</h3><p>Need to install <code>clickhouse-common-static</code> + <code>clickhouse-keeper</code> OR <code>clickhouse-common-static</code> + <code>clickhouse-server</code>.
Both OK, use the first if you don&rsquo;t need ClickHouse® server locally.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dpkg -i clickhouse-common-static_<span style=color:#ce5c00;font-weight:700>{</span>%version<span style=color:#ce5c00;font-weight:700>}</span>.deb clickhouse-keeper_<span style=color:#ce5c00;font-weight:700>{</span>%version<span style=color:#ce5c00;font-weight:700>}</span>.deb
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dpkg -i clickhouse-common-static_<span style=color:#ce5c00;font-weight:700>{</span>%version<span style=color:#ce5c00;font-weight:700>}</span>.deb clickhouse-server_<span style=color:#ce5c00;font-weight:700>{</span>%version<span style=color:#ce5c00;font-weight:700>}</span>.deb clickhouse-client_<span style=color:#ce5c00;font-weight:700>{</span>%version<span style=color:#ce5c00;font-weight:700>}</span>.deb
</span></span></code></pre></div><p>Create directories</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /etc/clickhouse-keeper/config.d
</span></span><span style=display:flex><span>mkdir -p /var/log/clickhouse-keeper
</span></span><span style=display:flex><span>mkdir -p /var/lib/clickhouse-keeper/coordination/log
</span></span><span style=display:flex><span>mkdir -p /var/lib/clickhouse-keeper/coordination/snapshots
</span></span><span style=display:flex><span>mkdir -p /var/lib/clickhouse-keeper/cores
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chown -R clickhouse.clickhouse /etc/clickhouse-keeper /var/log/clickhouse-keeper /var/lib/clickhouse-keeper
</span></span></code></pre></div><h3 id=config>config</h3><pre tabindex=0><code>cat /etc/clickhouse-keeper/config.xml

&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
    &lt;logger&gt;
        &lt;!-- Possible levels [1]:

          - none (turns off logging)
          - fatal
          - critical
          - error
          - warning
          - notice
          - information
          - debug
          - trace
          - test (not for production usage)

            [1]: https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/Logger.h#L105-L114
        --&gt;
        &lt;level&gt;trace&lt;/level&gt;
        &lt;log&gt;/var/log/clickhouse-keeper/clickhouse-keeper.log&lt;/log&gt;
        &lt;errorlog&gt;/var/log/clickhouse-keeper/clickhouse-keeper.err.log&lt;/errorlog&gt;
        &lt;!-- Rotation policy
             See https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/FileChannel.h#L54-L85
          --&gt;
        &lt;size&gt;1000M&lt;/size&gt;
        &lt;count&gt;10&lt;/count&gt;
        &lt;!-- &lt;console&gt;1&lt;/console&gt; --&gt; &lt;!-- Default behavior is autodetection (log to console if not daemon mode and is tty) --&gt;

        &lt;!-- Per level overrides (legacy):

        For example to suppress logging of the ConfigReloader you can use:
        NOTE: levels.logger is reserved, see below.
        --&gt;
        &lt;!--
        &lt;levels&gt;
          &lt;ConfigReloader&gt;none&lt;/ConfigReloader&gt;
        &lt;/levels&gt;
        --&gt;

        &lt;!-- Per level overrides:

        For example to suppress logging of the RBAC for default user you can use:
        (But please note that the logger name maybe changed from version to version, even after minor upgrade)
        --&gt;
        &lt;!--
        &lt;levels&gt;
          &lt;logger&gt;
            &lt;name&gt;ContextAccess (default)&lt;/name&gt;
            &lt;level&gt;none&lt;/level&gt;
          &lt;/logger&gt;
          &lt;logger&gt;
            &lt;name&gt;DatabaseOrdinary (test)&lt;/name&gt;
            &lt;level&gt;none&lt;/level&gt;
          &lt;/logger&gt;
        &lt;/levels&gt;
        --&gt;
        &lt;!-- Structured log formatting:
        You can specify log format(for now, JSON only). In that case, the console log will be printed
        in specified format like JSON.
        For example, as below:
        {&#34;date_time&#34;:&#34;1650918987.180175&#34;,&#34;thread_name&#34;:&#34;#1&#34;,&#34;thread_id&#34;:&#34;254545&#34;,&#34;level&#34;:&#34;Trace&#34;,&#34;query_id&#34;:&#34;&#34;,&#34;logger_name&#34;:&#34;BaseDaemon&#34;,&#34;message&#34;:&#34;Received signal 2&#34;,&#34;source_file&#34;:&#34;../base/daemon/BaseDaemon.cpp; virtual void SignalListener::run()&#34;,&#34;source_line&#34;:&#34;192&#34;}
        To enable JSON logging support, just uncomment &lt;formatting&gt; tag below.
        --&gt;
        &lt;!-- &lt;formatting&gt;json&lt;/formatting&gt; --&gt;
    &lt;/logger&gt;

    &lt;!-- Listen specified address.
     Use :: (wildcard IPv6 address), if you want to accept connections both with IPv4 and IPv6 from everywhere.
     Notes:
     If you open connections from wildcard address, make sure that at least one of the following measures applied:
     - server is protected by firewall and not accessible from untrusted networks;
     - all users are restricted to subset of network addresses (see users.xml);
     - all users have strong passwords, only secure (TLS) interfaces are accessible, or connections are only made via TLS interfaces.
     - users without password have readonly access.
     See also: https://www.shodan.io/search?query=clickhouse
    --&gt;
    &lt;!-- &lt;listen_host&gt;::&lt;/listen_host&gt; --&gt;


    &lt;!-- Same for hosts without support for IPv6: --&gt;
    &lt;!-- &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt; --&gt;

    &lt;!-- Default values - try listen localhost on IPv4 and IPv6. --&gt;
    &lt;!--
    &lt;listen_host&gt;::1&lt;/listen_host&gt;
    &lt;listen_host&gt;127.0.0.1&lt;/listen_host&gt;
    --&gt;

    &lt;!-- &lt;interserver_listen_host&gt;::&lt;/interserver_listen_host&gt; --&gt;
    &lt;!-- Listen host for communication between replicas. Used for data exchange --&gt;
    &lt;!-- Default values - equal to listen_host --&gt;

    &lt;!-- Don&#39;t exit if IPv6 or IPv4 networks are unavailable while trying to listen. --&gt;
    &lt;!-- &lt;listen_try&gt;0&lt;/listen_try&gt; --&gt;

    &lt;!-- Allow multiple servers to listen on the same address:port. This is not recommended.
    --&gt;
    &lt;!-- &lt;listen_reuse_port&gt;0&lt;/listen_reuse_port&gt; --&gt;
    &lt;!-- &lt;listen_backlog&gt;4096&lt;/listen_backlog&gt; --&gt;

    &lt;path&gt;/var/lib/clickhouse-keeper/&lt;/path&gt;
    &lt;core_path&gt;/var/lib/clickhouse-keeper/cores&lt;/core_path&gt;

    &lt;keeper_server&gt;
	    &lt;tcp_port&gt;2181&lt;/tcp_port&gt;
	    &lt;server_id&gt;1&lt;/server_id&gt;
	    &lt;log_storage_path&gt;/var/lib/clickhouse-keeper/coordination/log&lt;/log_storage_path&gt;
	    &lt;snapshot_storage_path&gt;/var/lib/clickhouse-keeper/coordination/snapshots&lt;/snapshot_storage_path&gt;

	    &lt;coordination_settings&gt;
        	&lt;operation_timeout_ms&gt;10000&lt;/operation_timeout_ms&gt;
	        &lt;session_timeout_ms&gt;30000&lt;/session_timeout_ms&gt;
	        &lt;raft_logs_level&gt;trace&lt;/raft_logs_level&gt;
	        &lt;rotate_log_storage_interval&gt;10000&lt;/rotate_log_storage_interval&gt;
	    &lt;/coordination_settings&gt;

            &lt;raft_configuration&gt;
	              &lt;server&gt;
                   &lt;id&gt;1&lt;/id&gt;
                   &lt;hostname&gt;localhost&lt;/hostname&gt;
                   &lt;port&gt;9444&lt;/port&gt;
                &lt;/server&gt;
           &lt;/raft_configuration&gt;
    &lt;/keeper_server&gt;
&lt;/clickhouse&gt;
</code></pre><pre tabindex=0><code>cat /etc/clickhouse-keeper/config.d/keeper.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
    &lt;listen_host&gt;::&lt;/listen_host&gt;
    &lt;keeper_server&gt;
            &lt;tcp_port&gt;2181&lt;/tcp_port&gt;
            &lt;server_id&gt;1&lt;/server_id&gt;
            &lt;raft_configuration&gt;
                &lt;server&gt;
                   &lt;id&gt;1&lt;/id&gt;
       	           &lt;hostname&gt;keeper-host-1&lt;/hostname&gt;
                   &lt;port&gt;9444&lt;/port&gt;
                &lt;/server&gt;
                &lt;server&gt;
                   &lt;id&gt;2&lt;/id&gt;
                   &lt;hostname&gt;keeper-host-2&lt;/hostname&gt;
                   &lt;port&gt;9444&lt;/port&gt;
                &lt;/server&gt;
                &lt;server&gt;
                   &lt;id&gt;3&lt;/id&gt;
                   &lt;hostname&gt;keeper-host-3&lt;/hostname&gt;
                   &lt;port&gt;9444&lt;/port&gt;
                &lt;/server&gt;                
           &lt;/raft_configuration&gt;
    &lt;/keeper_server&gt;
&lt;/clickhouse&gt;
</code></pre><h3 id=systemd-service>systemd service</h3><pre tabindex=0><code>cat /lib/systemd/system/clickhouse-keeper.service
[Unit]
Description=ClickHouse Keeper (analytic DBMS for big data)
Requires=network-online.target
# NOTE: that After/Wants=time-sync.target is not enough, you need to ensure
# that the time was adjusted already, if you use systemd-timesyncd you are
# safe, but if you use ntp or some other daemon, you should configure it
# additionaly.
After=time-sync.target network-online.target
Wants=time-sync.target

[Service]
Type=simple
User=clickhouse
Group=clickhouse
Restart=always
RestartSec=30
RuntimeDirectory=clickhouse-keeper
ExecStart=/usr/bin/clickhouse-keeper --config=/etc/clickhouse-keeper/config.xml --pid-file=/run/clickhouse-keeper/clickhouse-keeper.pid
# Minus means that this file is optional.
EnvironmentFile=-/etc/default/clickhouse
LimitCORE=infinity
LimitNOFILE=500000
CapabilityBoundingSet=CAP_NET_ADMIN CAP_IPC_LOCK CAP_SYS_NICE CAP_NET_BIND_SERVICE

[Install]
# ClickHouse should not start from the rescue shell (rescue.target).
WantedBy=multi-user.target
</code></pre><pre tabindex=0><code>systemctl daemon-reload

systemctl status clickhouse-keeper

systemctl start clickhouse-keeper
</code></pre><h3 id=debug-start-without-service-as-foreground-application>debug start without service (as foreground application)</h3><pre tabindex=0><code>sudo -u clickhouse /usr/bin/clickhouse-keeper --config=/etc/clickhouse-keeper/config.xml
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-05425e768ddcc5be5d1203f59044e6d5>64.3 - Install standalone Zookeeper for ClickHouse® on Ubuntu / Debian</h1><div class=lead>Install standalone Zookeeper for ClickHouse® on Ubuntu / Debian.</div><h2 id=reference-script-to-install-standalone-zookeeper-for-ubuntu--debian>Reference script to install standalone Zookeeper for Ubuntu / Debian</h2><p>Tested on Ubuntu 20.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># install java runtime environment</span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt install default-jre
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># prepare folders, logs folder should be on the low-latency disk.</span>
</span></span><span style=display:flex><span>sudo mkdir -p /var/lib/zookeeper/data /var/lib/zookeeper/logs /etc/zookeeper /var/log/zookeeper /opt 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># download and install files </span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>3.6.3
</span></span><span style=display:flex><span>wget https://dlcdn.apache.org/zookeeper/zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin.tar.gz -O /tmp/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin.tar.gz
</span></span><span style=display:flex><span>sudo tar -xvf /tmp/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin.tar.gz -C /opt
</span></span><span style=display:flex><span>rm -rf /tmp/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># create the user </span>
</span></span><span style=display:flex><span>sudo groupadd -r zookeeper
</span></span><span style=display:flex><span>sudo useradd -r -g zookeeper --home-dir<span style=color:#ce5c00;font-weight:700>=</span>/var/lib/zookeeper --shell<span style=color:#ce5c00;font-weight:700>=</span>/bin/false zookeeper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># symlink pointing to the used version of zookeeper distibution</span>
</span></span><span style=display:flex><span>sudo ln -s /opt/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin /opt/zookeeper 
</span></span><span style=display:flex><span>sudo chown -R zookeeper:zookeeper /var/lib/zookeeper /var/log/zookeeper /etc/zookeeper /opt/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin
</span></span><span style=display:flex><span>sudo chown -h zookeeper:zookeeper /opt/zookeeper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># shortcuts in /usr/local/bin/</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkCli.sh &#34;$@&#34;&#39;</span>             <span style=color:#000;font-weight:700>|</span> sudo tee /usr/local/bin/zkCli
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkServer.sh &#34;$@&#34;&#39;</span>          <span style=color:#000;font-weight:700>|</span> sudo tee /usr/local/bin/zkServer
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkCleanup.sh &#34;$@&#34;&#39;</span>         <span style=color:#000;font-weight:700>|</span> sudo tee /usr/local/bin/zkCleanup
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkSnapShotToolkit.sh &#34;$@&#34;&#39;</span> <span style=color:#000;font-weight:700>|</span> sudo tee /usr/local/bin/zkSnapShotToolkit
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkTxnLogToolkit.sh &#34;$@&#34;&#39;</span>   <span style=color:#000;font-weight:700>|</span> sudo tee /usr/local/bin/zkTxnLogToolkit
</span></span><span style=display:flex><span>sudo chmod +x /usr/local/bin/zkCli /usr/local/bin/zkServer /usr/local/bin/zkCleanup /usr/local/bin/zkSnapShotToolkit /usr/local/bin/zkTxnLogToolkit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># put in the config</span>
</span></span><span style=display:flex><span>sudo cp opt/zookeeper/conf/* /etc/zookeeper
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | sudo tee /etc/zookeeper/zoo.cfg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>initLimit=20
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>syncLimit=10
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>maxSessionTimeout=60000000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>maxClientCnxns=2000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>preAllocSize=131072
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>snapCount=3000000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>dataDir=/var/lib/zookeeper/data
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>dataLogDir=/var/lib/zookeeper/logs # use low-latency disk!
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>clientPort=2181
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>#clientPortAddress=nthk-zoo1.localdomain
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>autopurge.snapRetainCount=10
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>autopurge.purgeInterval=1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>4lw.commands.whitelist=*
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>sudo chown -R zookeeper:zookeeper /etc/zookeeper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># create systemd service file</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | sudo tee /etc/systemd/system/zookeeper.service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Description=Zookeeper Daemon
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Documentation=http://zookeeper.apache.org
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Requires=network.target
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>After=network.target
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[Service]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Type=forking
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>WorkingDirectory=/var/lib/zookeeper
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>User=zookeeper
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Group=zookeeper
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Environment=ZK_SERVER_HEAP=1536 # in megabytes, adjust to ~ 80-90% of avaliable RAM (more than 8Gb is rather overkill)
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Environment=SERVER_JVMFLAGS=&#34;-Xms256m -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Environment=ZOO_LOG_DIR=/var/log/zookeeper
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ExecStart=/opt/zookeeper/bin/zkServer.sh start /etc/zookeeper/zoo.cfg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ExecStop=/opt/zookeeper/bin/zkServer.sh stop /etc/zookeeper/zoo.cfg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ExecReload=/opt/zookeeper/bin/zkServer.sh restart /etc/zookeeper/zoo.cfg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>TimeoutSec=30
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Restart=on-failure
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[Install]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>WantedBy=default.target
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># start zookeeper</span>
</span></span><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo systemctl start zookeeper.service 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check status etc.</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> stat <span style=color:#000;font-weight:700>|</span> nc localhost <span style=color:#0000cf;font-weight:700>2181</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> ruok <span style=color:#000;font-weight:700>|</span> nc localhost <span style=color:#0000cf;font-weight:700>2181</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> mntr <span style=color:#000;font-weight:700>|</span> nc localhost <span style=color:#0000cf;font-weight:700>2181</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-564a3bbd39f9550e577334d912a883dc>64.4 - How to check the list of watches</h1><div class=lead>How to check the list of watches</div><p>Zookeeper use watches to notify a client on znode changes. This article explains how to check watches set by ZooKeeper servers and how it is used.</p><p><strong>Solution:</strong></p><p>Zookeeper uses the <code>'wchc'</code> command to list all watches set on the Zookeeper server.</p><p><code># echo wchc | nc zookeeper 2181</code></p><p>Reference</p><p><a href=https://zookeeper.apache.org/doc/r3.4.12/zookeeperAdmin.html target=_blank>https://zookeeper.apache.org/doc/r3.4.12/zookeeperAdmin.html</a></p><p>The <code>wchp</code> and <code>wchc</code> commands are not enabled by default because of their known DOS vulnerability. For more information, see <a href=https://issues.apache.org/jira/browse/ZOOKEEPER-2693 target=_blank>ZOOKEEPER-2693</a>
and <a href=https://vulners.com/exploitdb/EDB-ID:41277 target=_blank>Zookeeper 3.5.2 - Denial of Service</a>
.</p><p>By default those commands are disabled, they can be enabled via Java system property:</p><p><code>-Dzookeeper.4lw.commands.whitelist=*</code></p><p>on in zookeeper config: <code>4lw.commands.whitelist=*</code>\</p></div><div class=td-content style=page-break-before:always><h1 id=pg-722cb96284be123698aa3e56ea92ecaf>64.5 - JVM sizes and garbage collector settings</h1><div class=lead>JVM sizes and garbage collector settings</div><h2 id=tldr-version>TLDR version</h2><p>use fresh Java version (11 or newer), disable swap and set up (for 4 Gb node):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>JAVA_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;-Xms512m -Xmx3G -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;</span>
</span></span></code></pre></div><p>If you have a node with more RAM - change it accordingly, for example for 8Gb node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>JAVA_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;-Xms512m -Xmx7G -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;</span>
</span></span></code></pre></div><h2 id=details>Details</h2><ol><li><p>ZooKeeper runs as in JVM. Depending on version different garbage collectors are available.</p></li><li><p>Recent JVM versions (starting from 10) use <code>G1</code> garbage collector by default (should work fine).
On JVM 13-14 using <code>ZGC</code> or <code>Shenandoah</code> garbage collector may reduce pauses.
On older JVM version (before 10) you may want to make some tuning to decrease pauses, ParNew + CMS garbage collectors (like in Yandex config) is one of the best options.</p></li><li><p>One of the most important setting for JVM application is heap size. A heap size of >1 GB is recommended for most use cases and monitoring heap usage to ensure no delays are caused by garbage collection. We recommend to use at least 4Gb of RAM for zookeeper nodes (8Gb is better, that will make difference only when zookeeper is heavily loaded).</p></li></ol><p>Set the Java heap size smaller than available RAM size on the node. This is very important to avoid swapping, which will seriously degrade ZooKeeper performance. Be conservative - use a maximum heap size of 3GB for a 4GB machine.</p><ol><li><p>Add <code>XX:+AlwaysPreTouch</code> flag as well to load the memory pages into memory at the start of the zookeeper.</p></li><li><p>Set min (<code>Xms</code>) heap size to the values like 512Mb, or even to the same value as max (<code>Xmx</code>) to avoid resizing and returning the RAM to OS. Add <code>XX:+AlwaysPreTouch</code> flag as well to load the memory pages into memory at the start of the zookeeper.</p></li><li><p><code>MaxGCPauseMillis=50</code> (by default 200) - the &rsquo;target&rsquo; acceptable pause for garbage collection (milliseconds)</p></li><li><p><code>jute.maxbuffer</code> limits the maximum size of znode content. By default it&rsquo;s 1Mb. In some usecases (lot of partitions in table) ClickHouse® may need to create bigger znodes.</p></li><li><p>(optional) enable GC logs: <code>-Xloggc:/path_to/gc.log</code></p></li></ol><h2 id=zookeeper-configuration-used-by-yandex-metrika-from-2017>Zookeeper configuration used by Yandex Metrika (from 2017)</h2><p>The configuration used by Yandex ( <a href=https://clickhouse.com/docs/en/operations/tips#zookeeper target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/tips#zookeeper</a>
) - they use older JVM version (with <code>UseParNewGC</code> garbage collector), and tune GC logs heavily:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>JAVA_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;-Xms{{ cluster.get(&#39;xms&#39;,&#39;128M&#39;) }} \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -Xmx{{ cluster.get(&#39;xmx&#39;,&#39;1G&#39;) }} \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -Xloggc:/var/log/</span><span style=color:#000>$NAME</span><span style=color:#4e9a06>/zookeeper-gc.log \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+UseGCLogFileRotation \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:NumberOfGCLogFiles=16 \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:GCLogFileSize=16M \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -verbose:gc \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintGCTimeStamps \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintGCDateStamps \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintGCDetails
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintTenuringDistribution \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintGCApplicationStoppedTime \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintGCApplicationConcurrentTime \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintSafepointStatistics \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+UseParNewGC \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+UseConcMarkSweepGC \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+CMSParallelRemarkEnabled&#34;</span>
</span></span></code></pre></div><h2 id=see-also>See also</h2><ul><li><a href=https://wikitech.wikimedia.org/wiki/JVM_Tuning#G1_for_full_gcs target=_blank>https://wikitech.wikimedia.org/wiki/JVM_Tuning#G1_for_full_gcs</a></li><li><a href=https://sematext.com/blog/java-garbage-collection-tuning/ target=_blank>https://sematext.com/blog/java-garbage-collection-tuning/</a></li><li><a href=https://www.oracle.com/technical-resources/articles/java/g1gc.html target=_blank>https://www.oracle.com/technical-resources/articles/java/g1gc.html</a></li><li><a href=https://docs.oracle.com/cd/E40972_01/doc.70/e40973/cnf_jvmgc.htm#autoId2 target=_blank>https://docs.oracle.com/cd/E40972_01/doc.70/e40973/cnf_jvmgc.htm#autoId2</a></li><li><a href=https://docs.cloudera.com/runtime/7.2.7/kafka-performance-tuning/topics/kafka-tune-broker-tuning-jvm.html target=_blank>https://docs.cloudera.com/runtime/7.2.7/kafka-performance-tuning/topics/kafka-tune-broker-tuning-jvm.html</a></li><li><a href=https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cm-tune-g1gc.html target=_blank>https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cm-tune-g1gc.html</a></li><li><a href=https://www.maknesium.de/21-most-important-java-8-vm-options-for-servers target=_blank>https://www.maknesium.de/21-most-important-java-8-vm-options-for-servers</a></li><li><a href=https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304 target=_blank>https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304</a></li><li><a href=https://github.com/chewiebug/GCViewer target=_blank>https://github.com/chewiebug/GCViewer</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1ef2081889fb4a086febf3b281e44778>64.6 - Proper setup</h1><div class=lead>Proper setup</div><h3 id=main-docs-article>Main docs article</h3><p><a href=https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/ target=_blank>https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/</a></p><h3 id=hardware-requirements>Hardware requirements</h3><p>TLDR version:</p><ol><li>USE DEDICATED FAST DISKS for the transaction log! (crucial for performance due to write-ahead-log, NVMe is preferred for heavy load setup).</li><li>use 3 nodes (more nodes = slower quorum, less = no HA).</li><li>low network latency between zookeeper nodes is very important (latency, not bandwidth).</li><li>have at least 4Gb of RAM, disable swap, tune JVM sizes, and garbage collector settings.</li><li>ensure that zookeeper will not be CPU-starved by some other processes</li><li>monitor zookeeper.</li></ol><p>Side note:
in many cases, the slowness of the zookeeper is actually a symptom of some issue with ClickHouse® schema/usage pattern (the most typical issues: an enormous number of partitions/tables/databases with real-time inserts, tiny & frequent inserts).</p><p>Some doc about that subject:</p><ul><li><a href=https://docs.confluent.io/platform/current/zookeeper/deployment.html target=_blank>https://docs.confluent.io/platform/current/zookeeper/deployment.html</a></li><li><a href=https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems target=_blank>https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems</a></li><li><a href=https://clickhouse.tech/docs/en/operations/tips/#zookeeper target=_blank rel=nofollow>https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a></li><li><a href=https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html target=_blank>https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html</a></li><li><a href=https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting target=_blank>https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting</a></li></ul><p>Cite from <a href=https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems target=_blank>https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems</a>
:</p><blockquote><h2 id=things-to-avoid>Things to Avoid</h2><p>Here are some common problems you can avoid by configuring ZooKeeper correctly:</p><ul><li><em>inconsistent lists of servers</em> : The list of ZooKeeper servers used by the clients must match the list of ZooKeeper servers that each ZooKeeper server has. Things work okay if the client list is a subset of the real list, but things will really act strange if clients have a list of ZooKeeper servers that are in different ZooKeeper clusters. Also, the server lists in each Zookeeper server configuration file should be consistent with one another.</li><li><em>incorrect placement of transaction log</em> : The most performance critical part of ZooKeeper is the transaction log. ZooKeeper syncs transactions to media before it returns a response. A dedicated transaction log device is key to consistent good performance. Putting the log on a busy device will adversely affect performance. If you only have one storage device, increase the snapCount so that snapshot files are generated less often; it does not eliminate the problem, but it makes more resources available for the transaction log.</li><li><em>incorrect Java heap size</em> : You should take special care to set your Java max heap size correctly. In particular, you should not create a situation in which ZooKeeper swaps to disk. The disk is death to ZooKeeper. Everything is ordered, so if processing one request swaps the disk, all other queued requests will probably do the same. the disk. DON&rsquo;T SWAP. Be conservative in your estimates: if you have 4G of RAM, do not set the Java max heap size to 6G or even 4G. For example, it is more likely you would use a 3G heap for a 4G machine, as the operating system and the cache also need memory. The best and only recommend practice for estimating the heap size your system needs is to run load tests, and then make sure you are well below the usage limit that would cause the system to swap.</li><li><em>Publicly accessible deployment</em> : A ZooKeeper ensemble is expected to operate in a trusted computing environment. It is thus recommended to deploy ZooKeeper behind a firewall.</li></ul></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-66b660806f12af38114754857823e52a>64.7 - Recovering from complete metadata loss in ZooKeeper</h1><div class=lead>Recovering from complete metadata loss in ZooKeeper</div><h2 id=problem>Problem</h2><p>Every ClickHouse® user experienced a loss of ZooKeeper one day. While the data is available and replicas respond to queries, inserts are no longer possible. ClickHouse uses ZooKeeper in order to store the reference version of the table structure and part of data, and when it is not available can not guarantee data consistency anymore. Replicated tables turn to the read-only mode. In this article we describe step-by-step instructions of how to restore ZooKeeper metadata and bring ClickHouse cluster back to normal operation.</p><p>In order to restore ZooKeeper we have to solve two tasks. First, we need to restore table metadata in ZooKeeper. Currently, the only way to do it is to recreate the table with the <code>CREATE TABLE DDL</code> statement.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;zookeeper_path&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;replica_name&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The second and more difficult task is to populate zookeeper with information of ClickHouse data parts. As mentioned above, ClickHouse stores the reference data about all parts of replicated tables in ZooKeeper, so we have to traverse all partitions and re-attach them to the recovered replicated table in order to fix that.</p><div class="alert alert-info" role=alert><h4 class=alert-heading>Info</h4>Starting from ClickHouse version 21.7 there is SYSTEM RESTORE REPLICA command</div><p><a href=https://altinity.com/blog/a-new-way-to-restore-clickhouse-after-zookeeper-metadata-is-lost target=_blank>https://altinity.com/blog/a-new-way-to-restore-clickhouse-after-zookeeper-metadata-is-lost</a></p><h2 id=test-case>Test case</h2><p>Let&rsquo;s say we have replicated table <code>table_repl</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87>number</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intDiv</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>And populate it with some data</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;/clickhouse/cluster_1/tables/01/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;table_repl&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Now let’s remove metadata in zookeeper using <code>ZkCli.sh</code> at ZooKeeper host:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>deleteall  /clickhouse/cluster_1/tables/01/table_repl
</span></span></code></pre></div><p>And try to resync ClickHouse replica state with zookeeper:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>RESTART</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>If we try to insert some data in the table, error happens:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>And now we have an exception that we lost all metadata in zookeeper. It is time to recover!</p><h2 id=current-solution>Current Solution</h2><ol><li><p>Detach replicated table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>DETACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Save the table’s attach script and change engine of replicated table to non-replicated *mergetree analogue. Table definition is located in the ‘metadata’ folder, ‘<code>/var/lib/clickhouse/metadata/default/table_repl.sql</code>’ in our example. Please make a backup copy and modify the file as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87>number</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intDiv</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Needs to be replaced with this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87>number</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intDiv</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Attach non-replicated table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Rename non-replicated table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl_old</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Create a new replicated table. Take the saved attach script and replace ATTACH with CREATE, and run it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87>number</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intDiv</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Attach parts from old table to new.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl_old</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl_old</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li></ol><p>If the table has many partitions, it may require some shell script to make it easier.</p><h3 id=automated-approach>Automated approach</h3><p>For a large number of tables, you can use script <a href=https://github.com/Altinity/clickhouse-zookeeper-recovery target=_blank>https://github.com/Altinity/clickhouse-zookeeper-recovery</a>
which partially automates the above approach.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4c33701373e85b893c3b3464fa4f6683>64.8 - Using clickhouse-keeper</h1><div class=lead>Moving to the ClickHouse® alternative to Zookeeper</div><p>Since 2021 the development of built-in ClickHouse® alternative for Zookeeper is happening, whose goal is to address several design pitfalls, and get rid of extra dependency.</p><p>See slides: <a href=https://presentations.clickhouse.com/meetup54/keeper.pdf target=_blank rel=nofollow>https://presentations.clickhouse.com/meetup54/keeper.pdf</a>
and video <a href="https://youtu.be/IfgtdU1Mrm0?t=2682" target=_blank>https://youtu.be/IfgtdU1Mrm0?t=2682</a></p><h2 id=current-status-last-updated-july-2023>Current status (last updated: July 2023)</h2><p>Since version 23.3 we recommend using clickhouse-keeper for new installations.</p><p>Even better if you will use the latest version of clickhouse-keeper (currently it&rsquo;s 23.7), and it&rsquo;s not necessary to use the same version of clickhouse-keeper as ClickHouse itself.</p><p>For existing systems that currently use Apache Zookeeper, you can consider upgrading to clickhouse-keeper especially if you will <a href=https://altinity.com/clickhouse-upgrade-overview/ target=_blank>upgrade ClickHouse</a>
also.</p><p>But please remember that on very loaded systems the change can give no performance benefits or can sometimes lead to a worse performance.</p><p>The development pace of keeper code is <a href="https://github.com/ClickHouse/ClickHouse/pulls?q=is%3Apr+keeper" target=_blank>still high</a>
so every new version should bring improvements / cover the issues, and stability/maturity grows from version to version, so
if you want to play with clickhouse-keeper in some environment - please use <a href=https://altinity.com/altinity-stable/ target=_blank>the most recent ClickHouse releases</a>
! And of course: share your feedback :)</p><h2 id=how-does-clickhouse-keeper-work>How does clickhouse-keeper work?</h2><p>Official docs: <a href=https://clickhouse.com/docs/en/guides/sre/keeper/clickhouse-keeper/ target=_blank rel=nofollow>https://clickhouse.com/docs/en/guides/sre/keeper/clickhouse-keeper/</a></p><p>ClickHouse-keeper still need to be started additionally on few nodes (similar to &rsquo;normal&rsquo; zookeeper) and speaks normal zookeeper protocol - needed to simplify A/B tests with real zookeeper.</p><p>To test that you need to run 3 instances of clickhouse-server (which will mimic zookeeper) with an extra config like that:</p><p><a href=https://github.com/ClickHouse/ClickHouse/blob/master/tests/integration/test_keeper_multinode_simple/configs/enable_keeper1.xml target=_blank>https://github.com/ClickHouse/ClickHouse/blob/master/tests/integration/test_keeper_multinode_simple/configs/enable_keeper1.xml</a></p><p><a href=https://github.com/ClickHouse/ClickHouse/blob/master/tests/integration/test_keeper_snapshots/configs/enable_keeper.xml target=_blank>https://github.com/ClickHouse/ClickHouse/blob/master/tests/integration/test_keeper_snapshots/configs/enable_keeper.xml</a></p><p>or event single instance with config like that: <a href=https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/keeper_port.xml target=_blank>https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/keeper_port.xml</a>
<a href=https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/zookeeper.xml target=_blank>https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/zookeeper.xml</a></p><p>And point all the ClickHouses (zookeeper config section) to those nodes / ports.</p><p>Latest version is recommended (even testing / master builds). We will be thankful for any feedback.</p><h2 id=systemd-service-file>systemd service file</h2><p>See
<a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/clickhouse-keeper-service/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/clickhouse-keeper-service/</a></p><h2 id=initd-script>init.d script</h2><p>See
<a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/clickhouse-keeper-initd/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/clickhouse-keeper-initd/</a></p><h2 id=example-of-a-simple-cluster-with-2-nodes-of-clickhouse-using-built-in-keeper>Example of a simple cluster with 2 nodes of ClickHouse using built-in keeper</h2><p>For example you can start two ClickHouse nodes (hostname1, hostname2)</p><h3 id=hostname1>hostname1</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/keeper.xml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;keeper_server&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;tcp_port&gt;</span>2181<span style=color:#204a87;font-weight:700>&lt;/tcp_port&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;server_id&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/server_id&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;log_storage_path&gt;</span>/var/lib/clickhouse/coordination/log<span style=color:#204a87;font-weight:700>&lt;/log_storage_path&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;snapshot_storage_path&gt;</span>/var/lib/clickhouse/coordination/snapshots<span style=color:#204a87;font-weight:700>&lt;/snapshot_storage_path&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;coordination_settings&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;operation_timeout_ms&gt;</span>10000<span style=color:#204a87;font-weight:700>&lt;/operation_timeout_ms&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;session_timeout_ms&gt;</span>30000<span style=color:#204a87;font-weight:700>&lt;/session_timeout_ms&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;raft_logs_level&gt;</span>trace<span style=color:#204a87;font-weight:700>&lt;/raft_logs_level&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;rotate_log_storage_interval&gt;</span>10000<span style=color:#204a87;font-weight:700>&lt;/rotate_log_storage_interval&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/coordination_settings&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;raft_configuration&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;server&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>                 <span style=color:#204a87;font-weight:700>&lt;hostname&gt;</span>hostname1<span style=color:#204a87;font-weight:700>&lt;/hostname&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9444<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/server&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;server&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>                 <span style=color:#204a87;font-weight:700>&lt;hostname&gt;</span>hostname2<span style=color:#204a87;font-weight:700>&lt;/hostname&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9444<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/server&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/raft_configuration&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/keeper_server&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;zookeeper&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;node&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>localhost<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>2181<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/node&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/zookeeper&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;distributed_ddl&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;path&gt;</span>/clickhouse/testcluster/task_queue/ddl<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/distributed_ddl&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/macros.xml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;macros&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;cluster&gt;</span>testcluster<span style=color:#204a87;font-weight:700>&lt;/cluster&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>replica1<span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/shard&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/macros&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div><h3 id=hostname2>hostname2</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/keeper.xml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;keeper_server&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;tcp_port&gt;</span>2181<span style=color:#204a87;font-weight:700>&lt;/tcp_port&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;server_id&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/server_id&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;log_storage_path&gt;</span>/var/lib/clickhouse/coordination/log<span style=color:#204a87;font-weight:700>&lt;/log_storage_path&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;snapshot_storage_path&gt;</span>/var/lib/clickhouse/coordination/snapshots<span style=color:#204a87;font-weight:700>&lt;/snapshot_storage_path&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;coordination_settings&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;operation_timeout_ms&gt;</span>10000<span style=color:#204a87;font-weight:700>&lt;/operation_timeout_ms&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;session_timeout_ms&gt;</span>30000<span style=color:#204a87;font-weight:700>&lt;/session_timeout_ms&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;raft_logs_level&gt;</span>trace<span style=color:#204a87;font-weight:700>&lt;/raft_logs_level&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;rotate_log_storage_interval&gt;</span>10000<span style=color:#204a87;font-weight:700>&lt;/rotate_log_storage_interval&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/coordination_settings&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;raft_configuration&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;server&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>                 <span style=color:#204a87;font-weight:700>&lt;hostname&gt;</span>hostname1<span style=color:#204a87;font-weight:700>&lt;/hostname&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9444<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/server&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;server&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>                 <span style=color:#204a87;font-weight:700>&lt;hostname&gt;</span>hostname2<span style=color:#204a87;font-weight:700>&lt;/hostname&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9444<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/server&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/raft_configuration&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/keeper_server&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;zookeeper&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;node&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>localhost<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>2181<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/node&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/zookeeper&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;distributed_ddl&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;path&gt;</span>/clickhouse/testcluster/task_queue/ddl<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/distributed_ddl&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/macros.xml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;macros&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;cluster&gt;</span>testcluster<span style=color:#204a87;font-weight:700>&lt;/cluster&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>replica2<span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/shard&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/macros&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div><h3 id=on-both>on both</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/clusters.xml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;remote_servers&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;testcluster&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>hostname1<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9000<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>hostname2<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9000<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/shard&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/testcluster&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/remote_servers&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div><p>Then create a table</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{database}/{table}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>Order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- on both nodes:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8892167f56e913cb6f2d429fc16315c8>64.9 - ZooKeeper backup</h1><div class=lead>ZooKeeper backup</div><p>Question: Do I need to backup Zookeeper Database, because it’s pretty important for ClickHouse®?</p><p>TLDR answer: <strong>NO, just backup ClickHouse data itself, and do SYSTEM RESTORE REPLICA during recovery to recreate zookeeper data</strong></p><p>Details:</p><p>Zookeeper does not store any data, it stores the STATE of the distributed system (&ldquo;that replica have those parts&rdquo;, &ldquo;still need 2 merges to do&rdquo;, &ldquo;alter is being applied&rdquo; etc). That state always changes, and you can not capture / backup / and recover that state in a safe manner. So even backup from few seconds ago is representing some &lsquo;old state from the past&rsquo; which is INCONSISTENT with actual state of the data.</p><p>In other words - if ClickHouse is working - then the state of distributed system always changes, and it&rsquo;s almost impossible to collect the current state of zookeeper (while you collecting it it will change many times). The only exception is &lsquo;stop-the-world&rsquo; scenario - i.e. shutdown all ClickHouse nodes, with all other zookeeper clients, then shutdown all the zookeeper, and only then take the backups, in that scenario and backups of zookeeper & ClickHouse will be consistent. In that case restoring the backup is as simple (and is equal to) as starting all the nodes which was stopped before. But usually that scenario is very non-practical because it requires huge downtime.</p><p>So what to do instead? It&rsquo;s enough if you will backup ClickHouse data itself, and to recover the state of zookeeper you can just run the command <code>SYSTEM RESTORE REPLICA</code> command <strong>AFTER</strong> restoring the ClickHouse data itself. That will recreate the state of the replica in the zookeeper as it exists on the filesystem after backup recovery.</p><p>Normally Zookeeper ensemble consists of 3 nodes, which is enough to survive hardware failures.</p><p>On older version (which don&rsquo;t have <code>SYSTEM RESTORE REPLICA</code> command - it can be done manually, using instruction <a href=https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replication/#converting-from-mergetree-to-replicatedmergetree%29 target=_blank rel=nofollow>https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replication/#converting-from-mergetree-to-replicatedmergetree)</a>
, on scale you can try <a href=https://github.com/Altinity/clickhouse-zookeeper-recovery target=_blank>https://github.com/Altinity/clickhouse-zookeeper-recovery</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f9f14245cdbc89d13e77a5b1b24de46e>64.10 - ZooKeeper cluster migration</h1><div class=lead>ZooKeeper cluster migration</div><p>Here is a plan for ZK 3.4.9 (no dynamic reconfiguration):</p><ol><li>Add the 3 new ZK nodes to the old cluster. No changes needed for the 3 old ZK nodes at this time.<ol><li>Configure one of the new ZK nodes as a cluster of 4 nodes (3 old + 1 new), start it.</li><li>Configure the other two new ZK nodes as a cluster of 6 nodes (3 old + 3 new), start them.</li></ol></li><li>Make sure the 3 new ZK nodes connected to the old ZK cluster as followers (run <code>echo stat | nc localhost 2181</code> on the 3 new ZK nodes)</li><li>Confirm that the leader has 5 synced followers (run <code>echo mntr | nc localhost 2181</code> on the leader, look for <code>zk_synced_followers</code>)</li><li>Stop data ingestion in CH (this is to minimize errors when CH loses ZK).</li><li>Change the zookeeper section in the configs on the CH nodes (remove the 3 old ZK servers, add the 3 new ZK servers)</li><li>Make sure that there are no connections from CH to the 3 old ZK nodes (run <code>echo stat | nc localhost 2181</code> on the 3 old nodes, check their <code>Clients</code> section). Restart all CH nodes if necessary (In some cases CH can reconnect to different ZK servers without a restart).</li><li>Remove the 3 old ZK nodes from <code>zoo.cfg</code> on the 3 new ZK nodes.</li><li>Restart the 3 new ZK nodes. They should form a cluster of 3 nodes.</li><li>When CH reconnects to ZK, start data loading.</li><li>Turn off the 3 old ZK nodes.</li></ol><p>This plan works, but it is not the only way to do this, it can be changed if needed.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9eb0d707fbf1e834507aa5b61897fc15>64.11 - ZooKeeper cluster migration when using K8s node local storage</h1><div class=lead>ZooKeeper cluster migration when using K8s node local storage</div><p>Describes how to migrate a ZooKeeper cluster when using K8s node-local storage such as static PV, <code>local-path</code>, <code>TopoLVM</code>.</p><p>Requires HA setup (3+ pods).</p><p>This solution is more risky than <a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/altinity-kb-zookeeper-cluster-migration/>migration by adding followers</a>
because it reduces
the number of active consensus members but is operationally simpler. When running with <code>clickhouse-keeper</code>, it can be
performed gracefully so that quorum is maintained during the whole operation.</p><ol><li>Find the leader pod and note its name<ol><li>To detect leader run <code>echo stat | nc 127.0.0.1 2181 | grep leader</code> inside pods</li></ol></li><li>Make sure the ZK cluster is healthy and all nodes are in sync<ol><li>(run on leader) <code>echo mntr | nc 127.0.0.1 2181 | grep zk_synced_followers</code> should be N-1 for N member cluster</li></ol></li><li>Pick the first <strong>non-leader</strong> pod and delete its <code>PVC</code>,<ol><li><code>kubectl delete --wait=false pvc clickhouse-keeper-data-0</code> -> status should be <code>Terminating</code></li><li>Also delete <code>PV</code> if your <code>StorageClass</code> reclaim policy is set to <code>Retain</code></li></ol></li><li>If you are using dynamic volume provisioning make adjustments based on your k8s infrastructure (such as moving labels and taints or cordoning node) so that after pod delete the new one will be scheduled on the planned node<ol><li><code>kubectl label node planned-node dedicated=zookeeper</code></li><li><code>kubectl label node this-pod-node dedicated-</code></li><li><code>kubectl taint node planned-node dedicated=zookeeper:NoSchedule</code></li><li><code>kubectl taint node this-pod-node dedicated=zookeeper:NoSchedule-</code></li></ol></li><li>For manual volume provisioning wait till a new <code>PVC</code> is created and then provision volume on the planned node</li><li>Delete the first non-leader pod and wait for its PV to be deleted<ol><li><code>kubectl delete pod clickhouse-keeper-0</code></li><li><code>kubectl wait --for=delete pv/pvc-0a823311-616f-4b7e-9b96-0c059c62ab3b --timeout=120s</code></li></ol></li><li>Wait for the new pod to be scheduled and volume provisioned (or provision manual volume per instructions above)</li><li>Ensure new member joined and synced<ol><li>(run on leader) <code>echo mntr | nc 127.0.0.1 2181 | grep zk_synced_followers</code> should be N-1 for N member cluster</li></ol></li><li>Repeat for all other non-leader pods</li><li>(ClickHouse® Keeper only), for Zookeeper you will need to force an election by stopping the leader<ol><li>Ask the current leader to yield leadership</li><li><code>echo ydld | nc 127.0.0.1 2181</code> -> should print something like <code>Sent yield leadership request to ...</code></li><li><ul><li>Make sure a different leader was elected by finding your new leader</li></ul></li></ol></li><li>Finally repeat for the leader pod</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-4b2037cae63d87dd18115b5fa7174451>64.12 - ZooKeeper Monitoring</h1><div class=lead>ZooKeeper Monitoring</div><h2 id=zookeeper>ZooKeeper</h2><h3 id=scrape-metrics>scrape metrics</h3><ul><li>embedded exporter since version 3.6.0<ul><li><a href=https://zookeeper.apache.org/doc/r3.6.2/zookeeperMonitor.html target=_blank>https://zookeeper.apache.org/doc/r3.6.2/zookeeperMonitor.html</a></li></ul></li><li>standalone exporter<ul><li><a href=https://github.com/dabealu/zookeeper-exporter target=_blank>https://github.com/dabealu/zookeeper-exporter</a></li></ul></li></ul><h3 id=install-dashboards>Install dashboards</h3><ul><li>embedded exporter <a href=https://grafana.com/grafana/dashboards/10465 target=_blank>https://grafana.com/grafana/dashboards/10465</a></li><li>dabealu exporter <a href=https://grafana.com/grafana/dashboards/11442 target=_blank>https://grafana.com/grafana/dashboards/11442</a></li></ul><p>See also <a href="https://grafana.com/grafana/dashboards?search=ZooKeeper&amp;dataSource=prometheus" target=_blank>https://grafana.com/grafana/dashboards?search=ZooKeeper&amp;amp;dataSource=prometheus</a></p><h3 id=setup-alert-rules>setup alert rules</h3><ul><li>embedded exporter <a href=https://github.com/Altinity/clickhouse-operator/blob/master/deploy/prometheus/prometheus-alert-rules-zookeeper.yaml target=_blank>link</a></li></ul><h3 id=see-also>See also</h3><ul><li><a href=https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/#zookeeper-metrics target=_blank>https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/#zookeeper-metrics</a></li><li><a href=https://dzone.com/articles/monitoring-apache-zookeeper-servers target=_blank>https://dzone.com/articles/monitoring-apache-zookeeper-servers</a>
- note exhibitor is no longer maintained</li><li><a href=https://github.com/samber/awesome-prometheus-alerts/blob/c3ba0cf1997c7e952369a090aeb10343cdca4878/_data/rules.yml#L1146-L1170 target=_blank>https://github.com/samber/awesome-prometheus-alerts/blob/c3ba0cf1997c7e952369a090aeb10343cdca4878/_data/rules.yml#L1146-L1170</a>
(or <a href=https://awesome-prometheus-alerts.grep.to/rules.html#zookeeper target=_blank>https://awesome-prometheus-alerts.grep.to/rules.html#zookeeper</a>
)</li><li><a href=https://alex.dzyoba.com/blog/prometheus-alerts/ target=_blank>https://alex.dzyoba.com/blog/prometheus-alerts/</a></li><li><a href="https://docs.datadoghq.com/integrations/zk/?tab=host" target=_blank>https://docs.datadoghq.com/integrations/zk/?tab=host</a></li><li><a href=https://statuslist.app/uptime-monitoring/zookeeper/ target=_blank>https://statuslist.app/uptime-monitoring/zookeeper/</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-caaac474228860d2cc9228c7ba1fb3f9>64.13 - ZooKeeper schema</h1><div class=lead>ZooKeeper schema</div><h2 id=metadata>/metadata</h2><p>Table schema.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>date column -&gt; legacy MergeTree partition expression.
</span></span><span style=display:flex><span>sampling expression -&gt; SAMPLE BY
</span></span><span style=display:flex><span>index granularity -&gt; index_granularity
</span></span><span style=display:flex><span>mode -&gt; <span style=color:#204a87>type</span> of MergeTree table
</span></span><span style=display:flex><span>sign column -&gt; sign - CollapsingMergeTree / VersionedCollapsingMergeTree
</span></span><span style=display:flex><span>primary key -&gt; ORDER BY key <span style=color:#204a87;font-weight:700>if</span> PRIMARY KEY not defined.
</span></span><span style=display:flex><span>sorting key -&gt; ORDER BY key <span style=color:#204a87;font-weight:700>if</span> PRIMARY KEY defined.
</span></span><span style=display:flex><span>data format version -&gt; <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>partition key -&gt; PARTITION BY
</span></span><span style=display:flex><span>granularity bytes -&gt; index_granularity_bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>types of MergeTree tables:
</span></span><span style=display:flex><span><span style=color:#000>Ordinary</span>            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#000>Collapsing</span>          <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#000>Summing</span>             <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span><span style=color:#000>Aggregating</span>         <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span>
</span></span><span style=display:flex><span><span style=color:#000>Replacing</span>           <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span>
</span></span><span style=display:flex><span><span style=color:#000>Graphite</span>            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span>
</span></span><span style=display:flex><span><span style=color:#000>VersionedCollapsing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7</span>
</span></span></code></pre></div><h2 id=mutations>/mutations</h2><p>Log of latest mutations</p><h2 id=columns>/columns</h2><p>List of columns for latest (reference) table version. Replicas would try to reach this state.</p><h2 id=log>/log</h2><p>Log of latest actions with table.</p><p>Related settings:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>────────────────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>changed</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#a40000>───┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_replicated_logs_to_keep</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>How</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>many</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>records</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>may</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>be</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>log</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>there</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>is</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inactive</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Inactive</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>becomes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lost</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>when</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>when</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>this</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>exceed</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>                                                  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_replicated_logs_to_keep</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Keep</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>about</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>this</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>last</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>records</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ZooKeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>log</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>even</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>they</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>are</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>obsolete</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>It</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>doesn</span><span style=color:#4e9a06>&#39;t affect work of tables: used only to diagnose ZooKeeper log before cleaning. │ UInt64 │
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>└─────────────────────────────┴───────┴─────────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴────────┘
</span></span></span></code></pre></div><h2 id=replicas>/replicas</h2><p>List of table replicas.</p><h2 id=replicasreplica_name>/replicas/replica_name/</h2><h3 id=replicasreplica_namemutation_pointer>/replicas/replica_name/mutation_pointer</h3><p>Pointer to the latest mutation executed by replica</p><h3 id=replicasreplica_namelog_pointer>/replicas/replica_name/log_pointer</h3><p>Pointer to the latest task from replication_queue executed by replica</p><h3 id=replicasreplica_namemax_processed_insert_time>/replicas/replica_name/max_processed_insert_time</h3><h3 id=replicareplica_namemetadata>/replica/replica_name/metadata</h3><p>Table schema of specific replica</p><h3 id=replicareplica_namecolumns>/replica/replica_name/columns</h3><p>Columns list of specific replica.</p><h2 id=quorum>/quorum</h2><p>Used for quorum inserts.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class="row footer-inner pb-3"><div class=col-12><a href=https://altinity.com target=_blank><img src=/images/general/altinity-logo_horizontal_blue_white.svg width=154 alt=Altinity.com></a></div></div><div class="row footer-inner py-3"><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>PRODUCT</b></li><li class=nav-item><a href=https://altinity.com/managed-clickhouse/ target=_blank>Altinity.Cloud</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-support/ target=_blank>Support for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-training target=_blank>Training for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-pricing/ target=_blank>Altinity.Cloud Pricing</a></li><li class=nav-item><a href=https://altinity.com/plans-and-features-clickhouse/ target=_blank>Altinity Plans and Features</a></li></ul><div class="d-none d-md-block mb-3"><img decoding=async style="width:60px;display:inline-block;margin:0 10px 0 0" src=/images/general/soc.webp alt="SOC Certified"><img decoding=async style=width:60px;display:inline-block;margin:0 src=/images/general/soc2.webp alt="SOC2 TYPE II Certified"></div></div><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>RESOURCES</b></li><li class=nav-item><a href=https://altinity.com/blog target=_blank>Blog</a></li><li class=nav-item><a href=https://docs.altinity.com/ target=_blank>Documentation</a></li><li class=nav-item><a href=https://kb.altinity.com/ target=_blank>Knowledge Base</a></li><li class=nav-item><a href=https://altinity.com/releases target=_blank>Altinity Stable Builds</a></li><li class=nav-item><a href=https://hubs.la/Q02pLTV20 target=_blank>Kubernetes Operator</a></li><li class=nav-item><a href=https://altinity.com/ecosystem/ target=_blank>Altinity Open Source Projects</a></li><li class=nav-item><a href=https://altinity.com/events/ target=_blank>Events</a></li></ul></div><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>COMPANY</b></li><li class=nav-item><a href=https://altinity.com/about-us/ target=_blank>About Altinity</a></li><li class=nav-item><a href=https://altinity.com/about-us/press-releases target=_blank>Press Releases</a></li><li class=nav-item><a href=https://altinity.com/partners/ target=_blank>Partners</a></li><li class=nav-item><a href=https://altinity.com/customer-stories/ target=_blank>Customer Stories</a></li><li class=nav-item><a href=https://altinity.com/careers/ target=_blank>Careers</a></li><li class=nav-item><a href=https://altinity.com/contact/ target=_blank>Contact Us</a></li></ul></div><div class="col-12 col-sm-6 col-md-3">Get the latest ClickHouse news straight to your inbox every month.<br><a href=https://altinity.com/newsletter/ target=_blank class="btn btn-primary my-3" style=border-radius:1.5rem>Sign Up</a></div></div></div><div class="row footer-inner pb-3"><div class="col-12 col-sm-6 text-left text-xs-center py-2"><small class=text-white>&copy; 2026 Altinity Inc. Altinity®, Altinity.Cloud®, and Altinity Stable® are registered trademarks of Altinity, Inc. ClickHouse® is a registered trademark of ClickHouse, Inc.; Altinity is not affiliated with or associated with ClickHouse, Inc. Kafka, Kubernetes, MySQL, and PostgreSQL are trademarks and property of their respective owners. All Rights Reserved</small>
<small class=ml-1><a href=https://altinity.com/privacy-policy/ target=_blank>Privacy Policy</a></small></div><div class="col-12 col-sm-6 text-end text-xs-center"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://altinity.com/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=X aria-label=X><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/AltinityDB><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/company/altinity/><i class="fab fa-linkedin"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.youtube.com/channel/UCE3Y2lDKl_ZfjaCrh62onYA><i class="fab fa-youtube"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/Altinity/altinityknowledgebase><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Reddit aria-label=Reddit><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.reddit.com/r/Clickhouse/><i class="fab fa-reddit"></i></a></li></ul></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-101676615-2"></script><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/4536206.js></script><script type=text/javascript>!function(){var e,t="06536e793668baa",n=function(){Reo.init({clientID:"06536e793668baa"})};(e=document.createElement("script")).src="https://static.reo.dev/"+t+"/reo.js",e.defer=!0,e.onload=n,document.head.appendChild(e)}()</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-101676615-2")</script><script>$(document).ready(function(){$(".mobile-drop-toggle").on("click",function(){$(this).parent().parent().toggleClass("active")})})</script></footer><script type=text/javascript>_linkedin_partner_id="1601132",window._linkedin_data_partner_ids=window._linkedin_data_partner_ids||[],window._linkedin_data_partner_ids.push(_linkedin_partner_id)</script><script type=text/javascript>(function(e){e||(window.lintrk=function(e,t){window.lintrk.q.push([e,t])},window.lintrk.q=[]);var n=document.getElementsByTagName("script")[0],t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://snap.licdn.com/li.lms-analytics/insight.min.js",n.parentNode.insertBefore(t,n)})(window.lintrk)</script><noscript><img height=1 width=1 style=display:none alt src="https://px.ads.linkedin.com/collect/?pid=1601132&fmt=gif"></noscript></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/tabpane-persist.js></script></body></html>