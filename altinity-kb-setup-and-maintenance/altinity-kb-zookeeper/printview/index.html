<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=icon href=/favicons/favicon.ico><title>ZooKeeper | Altinity® Knowledge Base for ClickHouse®</title>
<meta name=description content="ZooKeeper
"><meta property="og:url" content="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/"><meta property="og:site_name" content="Altinity® Knowledge Base for ClickHouse®"><meta property="og:title" content="ZooKeeper"><meta property="og:description" content="ZooKeeper"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="ZooKeeper"><meta itemprop=description content="ZooKeeper"><meta itemprop=dateModified content="2024-07-30T22:09:50-04:00"><meta itemprop=wordCount content="522"><meta name=twitter:card content="summary"><meta name=twitter:title content="ZooKeeper"><meta name=twitter:description content="ZooKeeper"><link rel=preload href=/scss/main.min.2b572659bc7fea3f75213379efc217ce16fd006fe842d92e20eda9357d016609.css as=style><link href=/scss/main.min.2b572659bc7fea3f75213379efc217ce16fd006fe842d92e20eda9357d016609.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><link rel=stylesheet href=/css/prism.css><meta name=keywords content><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/4536206.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="a" viewBox="0 0 91.660006 105.99" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs1"><style id="style1">.b{fill:#fff}.c{fill:#199dcf}</style></defs><g id="g7"><polygon class="c" points="45.88,0 45.88,0.04 22.94,13.3 22.93,13.3 22.93,13.3 0.09,26.49 0.09,26.49 0.09,26.49 0,26.54 0.09,26.59 0.09,50.96 66.86,12.12" id="polygon1"/><polygon class="c" points="22.94,42.29 4.21,53.19 22.94,64.08" id="polygon2"/><polygon class="c" points="0.09,55.59 0.09,79.43 0,79.48 0.09,79.54 0.09,105.99 22.8,92.88 22.8,92.88 43.75,80.79 0.23,55.51" id="polygon3"/><polygon class="c" points="89.61,25.17 70.92,14.38 48.03,27.7 64.18,37.02 64.22,36.96 66.79,38.45" id="polygon4"/><g id="g6"><polygon class="c" points="91.66,52.82 91.63,52.83 76.33,44 91.66,52.92" id="polygon5"/><polygon class="c" points="91.66,105.76 91.66,57.55 68.71,44.2 68.71,92.51" id="polygon6"/></g><polygon class="c" points="91.66,52.85 91.66,28.61 70.77,40.76 76.28,43.97" id="polygon7"/></g></svg></span><span class=font-weight-bold>Altinity Knowledge Base for ClickHouse<sup>®</sup></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=productsDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Products</a><div class=dropdown-menu aria-labelledby=productsDropdown><a class=dropdown-item href=https://altinity.com/managed-clickhouse/ target=_blank><span style=font-size:large>Altinity.Cloud</span><br><span style=font-size:small>Managed service for ClickHouse in any AWS, GCP, or Azure region or your own VPC</span></a>
<a class=dropdown-item href=https://altinity.com/clickhouse-support/ target=_blank><span style=font-size:large>Support for ClickHouse</span><br><span style=font-size:small>Get 24/7 Support or POC and evaluative support</span></a>
<a class=dropdown-item href=https://altinity.com/clickhouse-training/ target=_blank><span style=font-size:large>Training for ClickHouse</span><br><span style=font-size:small>Altinity Administrator training for ClickHouse</span></a>
<a class=dropdown-item href=https://altinity.com/customer-stories/ target=_blank><span style=font-size:large>Customer Stories</span><br><span style=font-size:small>See why our customers love us</span></a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=resourceDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Resources</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=https://docs.altinity.com/ target=_blank><span style=font-size:large>Documentation</span><br><span style=font-size:small>Product guides and tutorials</span></a>
<a class=dropdown-item href=https://hubs.la/Q02pLTV20 target=_blank><span style=font-size:large>Guides and eBooks</span><br><span style=font-size:small>Technical content for developers</span></a>
<a class=dropdown-item href=https://altinity.com/clickhouse-database/ target=_blank><span style=font-size:large>What is ClickHouse?</span><br><span style=font-size:small>Learn why ClickHouse is the fastest database in the world</span></a>
<a class=dropdown-item href=https://altinity.com/what-is-kubernetes/ target=_blank><span style=font-size:large>What is Kubernetes?</span><br><span style=font-size:small>Learn why Kubernetes is the platform of choice for analytic databases</span></a></div></li><li class=nav-item><a class=nav-link href=https://altinity.com/blog target=_blank>Blog <span class=navbar-logo><svg width="25.897644" height="31.648945" viewBox="0 0 25.897644 31.648945" id="svg1" xmlns="http://www.w3.org/2000/svg"><path d="m18 14.5v6H6v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#fff" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round" id="path1" style="stroke:#fff;stroke-opacity:1"/></svg></span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=companyDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Company</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=https://altinity.com/about-us/ target=_blank><span style=font-size:large>About the Company</span><br><span style=font-size:small>Who we are and what we do</span></a>
<a class=dropdown-item href=https://altinity.com/careers/ target=_blank><span style=font-size:large>Careers</span><br><span style=font-size:small>Join our team!</span></a>
<a class=dropdown-item href=https://altinity.com/contact target=_blank><span style=font-size:large>Contact</span><br><span style=font-size:small>Have questions? We've got answers.</span></a></div></li><li class="header-social-wrap ml-md-auto"><div style=padding-right:20px class="header-social-inner-wrap element-social-inner-wrap social-show-label-false social-style-filled"><a class=mega-menu-link href=https://altinity.com/free-clickhouse-consultation/><span style=border-radius:24px;padding-top:.3em;padding-bottom:.3em;padding-left:1em;padding-right:1em;background-color:#1e9dcf;color:#fff;font-style:normal;font-size:13px;line-height:17px;font-weight:700>Need help?</span>
</a>&nbsp;
<a href=https://altinity.com/slack aria-label=Slack target=_blank rel="noopener noreferrer" class="social-button header-social-item social-link-custom1" data-positional-element-id=75><span class=social-icon-custom-svg style=max-width:34px><svg viewBox="0 0 36 36" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path fill="#fff" d="M7.563 22.747a3.782 3.782.0 11-3.78-3.78h3.78v3.78zm1.906.0a3.782 3.782.0 017.563.0v9.469a3.782 3.782.0 11-7.563.0V22.747zM13.251 7.563a3.782 3.782.0 113.782-3.78v3.78H13.251zm0 1.906a3.781 3.781.0 110 7.563H3.783a3.782 3.782.0 110-7.563h9.468zm15.183 3.782a3.783 3.783.0 113.783 3.782H28.434V13.251zm-1.9.0a3.782 3.782.0 01-7.565.0V3.783a3.782 3.782.0 117.564.0zM22.747 28.434a3.783 3.783.0 11-3.78 3.783V28.434h3.78zm0-1.9a3.782 3.782.0 010-7.565h9.469a3.782 3.782.0 110 7.564z" data-name="Icon simple-slack" id="Icon_simple-slack"/></svg>
</span></a>&nbsp;&nbsp;&nbsp;
<a href=https://github.com/Altinity/altinityknowledgebase aria-label=GitHub target=_blank rel="noopener noreferrer" class="social-button header-social-item social-link-github has-custom-image" data-positional-element-id=76><img width=500 height=245 src=https://altinity.com/wp-content/uploads/2023/11/github-mark-white.png class="social-icon-image lazyloaded" alt decoding=async loading=lazy style=max-width:24px data-ll-status=loaded><noscript><img width=250 height=245 src=https://altinity.com/wp-content/uploads/2023/11/github-mark-white.png class=social-icon-image alt decoding=async loading=lazy style=max-width:24px></noscript></a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/>Return to the regular view of this page</a>.</p></div><h1 class=title>ZooKeeper</h1><div class=lead>ZooKeeper</div><ul><li>1: <a href=#pg-fe6c92b41d659a61ae843a9c968db4e3>clickhouse-keeper-initd</a></li><li>2: <a href=#pg-582314d0ec1bd636faae316fd661315c>clickhouse-keeper-service</a></li><li>3: <a href=#pg-05425e768ddcc5be5d1203f59044e6d5>Install standalone Zookeeper for ClickHouse® on Ubuntu / Debian</a></li><li>4: <a href=#pg-564a3bbd39f9550e577334d912a883dc>How to check the list of watches</a></li><li>5: <a href=#pg-722cb96284be123698aa3e56ea92ecaf>JVM sizes and garbage collector settings</a></li><li>6: <a href=#pg-1ef2081889fb4a086febf3b281e44778>Proper setup</a></li><li>7: <a href=#pg-66b660806f12af38114754857823e52a>Recovering from complete metadata loss in ZooKeeper</a></li><li>8: <a href=#pg-4c33701373e85b893c3b3464fa4f6683>Using clickhouse-keeper</a></li><li>9: <a href=#pg-8892167f56e913cb6f2d429fc16315c8>ZooKeeper backup</a></li><li>10: <a href=#pg-f9f14245cdbc89d13e77a5b1b24de46e>ZooKeeper cluster migration</a></li><li>11: <a href=#pg-9eb0d707fbf1e834507aa5b61897fc15>ZooKeeper cluster migration when using K8s node local storage</a></li><li>12: <a href=#pg-4b2037cae63d87dd18115b5fa7174451>ZooKeeper Monitoring</a></li><li>13: <a href=#pg-caaac474228860d2cc9228c7ba1fb3f9>ZooKeeper schema</a></li></ul><div class=content><h3 id=requirements>Requirements</h3><p>TLDR version:</p><ol><li>USE DEDICATED FAST DISKS for the transaction log! (crucial for performance due to write-ahead-log, NVMe is preferred for heavy load setup).</li><li>use 3 nodes (more nodes = slower quorum, less = no HA).</li><li>low network latency between zookeeper nodes is very important (latency, not bandwidth).</li><li>have at least 4Gb of RAM, disable swap, <a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/jvm-sizes-and-garbage-collector-settings/ target=_blank>tune JVM sizes, and garbage collector settings</a></li><li>ensure that zookeeper will not be CPU-starved by some other processes</li><li><a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/zookeeper-monitoring/ target=_blank>monitor zookeeper</a>
.</li></ol><p>Side note:
in many cases, the slowness of the zookeeper is actually a symptom of some issue with ClickHouse® schema/usage pattern (the most typical issues: an enormous number of partitions/tables/databases with real-time inserts, tiny & frequent inserts).</p><h3 id=how-to-install>How to install</h3><ul><li><a href=https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/ target=_blank>https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/</a></li><li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/>altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/</a></li></ul><h3 id=random-links-on-best-practices>Random links on best practices</h3><ul><li><a href=https://docs.confluent.io/platform/current/zookeeper/deployment.html target=_blank>https://docs.confluent.io/platform/current/zookeeper/deployment.html</a></li><li><a href=https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems target=_blank>https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems</a></li><li><a href=https://clickhouse.tech/docs/en/operations/tips/#zookeeper target=_blank rel=nofollow>https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a></li><li><a href=https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html target=_blank>https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html</a></li><li><a href=https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting target=_blank>https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting</a></li></ul><p>Cite from <a href=https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems target=_blank>https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems</a>
:</p><blockquote><h2 id=things-to-avoid>Things to Avoid</h2><p>Here are some common problems you can avoid by configuring ZooKeeper correctly:</p><ul><li><em>inconsistent lists of servers</em> : The list of ZooKeeper servers used by the clients must match the list of ZooKeeper servers that each ZooKeeper server has. Things work okay if the client list is a subset of the real list, but things will really act strange if clients have a list of ZooKeeper servers that are in different ZooKeeper clusters. Also, the server lists in each Zookeeper server configuration file should be consistent with one another.</li><li><em>incorrect placement of transaction log</em> : The most performance critical part of ZooKeeper is the transaction log. ZooKeeper syncs transactions to media before it returns a response. A dedicated transaction log device is key to consistent good performance. Putting the log on a busy device will adversely affect performance. If you only have one storage device, increase the snapCount so that snapshot files are generated less often; it does not eliminate the problem, but it makes more resources available for the transaction log.</li><li><em>incorrect Java heap size</em> : You should take special care to set your Java max heap size correctly. In particular, you should not create a situation in which ZooKeeper swaps to disk. The disk is death to ZooKeeper. Everything is ordered, so if processing one request swaps the disk, all other queued requests will probably do the same. the disk. DON&rsquo;T SWAP. Be conservative in your estimates: if you have 4G of RAM, do not set the Java max heap size to 6G or even 4G. For example, it is more likely you would use a 3G heap for a 4G machine, as the operating system and the cache also need memory. The best and only recommend practice for estimating the heap size your system needs is to run load tests, and then make sure you are well below the usage limit that would cause the system to swap.</li><li><em>Publicly accessible deployment</em> : A ZooKeeper ensemble is expected to operate in a trusted computing environment. It is thus recommended to deploy ZooKeeper behind a firewall.</li></ul></blockquote><h3 id=how-to-check-number-of-followers>How to check number of followers:</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>echo</span> mntr <span style=color:#000;font-weight:700>|</span> nc zookeeper <span style=color:#0000cf;font-weight:700>2187</span> <span style=color:#000;font-weight:700>|</span> grep foll
</span></span><span style=display:flex><span>zk_synced_followers    <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>zk_synced_non_voting_followers    <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>zk_avg_follower_sync_time    0.0
</span></span><span style=display:flex><span>zk_min_follower_sync_time    <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>zk_max_follower_sync_time    <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>zk_cnt_follower_sync_time    <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>zk_sum_follower_sync_time    <span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div><h2 id=tools>Tools</h2><p><a href=https://github.com/apache/zookeeper/blob/master/zookeeper-docs/src/main/resources/markdown/zookeeperTools.md target=_blank>https://github.com/apache/zookeeper/blob/master/zookeeper-docs/src/main/resources/markdown/zookeeperTools.md</a></p><h2 id=alternative-for-zkcli>Alternative for zkCli</h2><ul><li><a href=https://github.com/go-zkcli/zkcli target=_blank>https://github.com/go-zkcli/zkcli</a></li></ul><h2 id=web-ui>Web UI</h2><ul><li><a href=https://github.com/elkozmon/zoonavigator-api target=_blank>https://github.com/elkozmon/zoonavigator-api</a></li><li><a href=https://github.com/tobilg/docker-zookeeper-webui target=_blank>https://github.com/tobilg/docker-zookeeper-webui</a></li><li><a href=https://github.com/vran-dev/PrettyZoo target=_blank>https://github.com/vran-dev/PrettyZoo</a></li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-fe6c92b41d659a61ae843a9c968db4e3>1 - clickhouse-keeper-initd</h1><div class=lead>clickhouse-keeper-initd</div><h2 id=clickhouse-keeper-initd>clickhouse-keeper-initd</h2><p>An init.d script for clickhouse-keeper.
This example is based on zkServer.sh</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>### BEGIN INIT INFO</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Provides:          clickhouse-keeper</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Default-Start:     2 3 4 5</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Default-Stop:      0 1 6</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Required-Start:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Required-Stop:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Short-Description: Start keeper daemon</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Description: Start keeper daemon</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>### END INIT INFO</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>NAME</span><span style=color:#ce5c00;font-weight:700>=</span>clickhouse-keeper
</span></span><span style=display:flex><span><span style=color:#000>ZOOCFGDIR</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/<span style=color:#000>$NAME</span>
</span></span><span style=display:flex><span><span style=color:#000>ZOOCFG</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOCFGDIR</span><span style=color:#4e9a06>/keeper.xml&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>ZOO_LOG_DIR</span><span style=color:#ce5c00;font-weight:700>=</span>/var/log/<span style=color:#000>$NAME</span>
</span></span><span style=display:flex><span><span style=color:#000>USER</span><span style=color:#ce5c00;font-weight:700>=</span>clickhouse
</span></span><span style=display:flex><span><span style=color:#000>GROUP</span><span style=color:#ce5c00;font-weight:700>=</span>clickhouse
</span></span><span style=display:flex><span><span style=color:#000>ZOOPIDDIR</span><span style=color:#ce5c00;font-weight:700>=</span>/var/run/<span style=color:#000>$NAME</span>
</span></span><span style=display:flex><span><span style=color:#000>ZOOPIDFILE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ZOOPIDDIR</span>/<span style=color:#000>$NAME</span>.pid
</span></span><span style=display:flex><span><span style=color:#000>SCRIPTNAME</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/init.d/<span style=color:#000>$NAME</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#echo &#34;Using config: $ZOOCFG&#34; &gt;&amp;2</span>
</span></span><span style=display:flex><span><span style=color:#000>ZOOCMD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;clickhouse-keeper -C </span><span style=color:#4e9a06>${</span><span style=color:#000>ZOOCFG</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> start --daemon&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ensure PIDDIR exists, otw stop will fail</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span>dirname <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -w <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOO_LOG_DIR</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOO_LOG_DIR</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>$1</span> in
</span></span><span style=display:flex><span>start<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> -n <span style=color:#4e9a06>&#34;Starting keeper ... &#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -f <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>kill</span> -0 <span style=color:#4e9a06>`</span>cat <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>`</span> &gt; /dev/null 2&gt;<span style=color:#000;font-weight:700>&amp;</span>1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87>echo</span> already running as process <span style=color:#4e9a06>`</span>cat <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>`</span>.
</span></span><span style=display:flex><span>         <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    sudo -u clickhouse <span style=color:#4e9a06>`</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOCMD</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$?</span> -eq <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>      pgrep -f <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOCMD</span><span style=color:#4e9a06>&#34;</span> &gt; <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;PID:&#34;</span> <span style=color:#4e9a06>`</span>cat <span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$?</span> -eq <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        sleep <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> STARTED
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> FAILED TO WRITE PID
</span></span><span style=display:flex><span>        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>echo</span> SERVER DID NOT START
</span></span><span style=display:flex><span>      <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>start-foreground<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    sudo -u clickhouse clickhouse-keeper -C <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOCFG</span><span style=color:#4e9a06>&#34;</span> start
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>print-cmd<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;sudo -u clickhouse </span><span style=color:#4e9a06>${</span><span style=color:#000>ZOOCMD</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>stop<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> -n <span style=color:#4e9a06>&#34;Stopping keeper ... &#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -f <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;no keeper to stop (could not find file </span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>)&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ZOOPID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>cat <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>echo</span> <span style=color:#000>$ZOOPID</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>kill</span> <span style=color:#000>$ZOOPID</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>         sleep <span style=color:#0000cf;font-weight:700>3</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>kill</span> -0 <span style=color:#000>$ZOOPID</span> &gt; /dev/null 2&gt;<span style=color:#000;font-weight:700>&amp;</span>1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#000>$ZOOPID</span> is still running
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>      rm <span style=color:#4e9a06>&#34;</span><span style=color:#000>$ZOOPIDFILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>echo</span> STOPPED
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>restart<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>shift</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;</span><span style=color:#000>$0</span><span style=color:#4e9a06>&#34;</span> stop <span style=color:#4e9a06>${</span><span style=color:#000;font-weight:700>@</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#0000cf;font-weight:700>3</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;</span><span style=color:#000>$0</span><span style=color:#4e9a06>&#34;</span> start <span style=color:#4e9a06>${</span><span style=color:#000;font-weight:700>@</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>status<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>clientPortAddress</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>clientPort</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2181</span>
</span></span><span style=display:flex><span>    <span style=color:#000>STAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>`</span><span style=color:#204a87>echo</span> srvr <span style=color:#000;font-weight:700>|</span> nc <span style=color:#000>$clientPortAddress</span> <span style=color:#000>$clientPort</span> 2&gt; /dev/null <span style=color:#000;font-weight:700>|</span> grep Mode<span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;x</span><span style=color:#000>$STAT</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;x&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Error contacting service. It is probably not running.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#000>$STAT</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>*<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Usage: </span><span style=color:#000>$0</span><span style=color:#4e9a06> {start|start-foreground|stop|restart|status|print-cmd}&#34;</span> &gt;<span style=color:#000;font-weight:700>&amp;</span><span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>esac</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-582314d0ec1bd636faae316fd661315c>2 - clickhouse-keeper-service</h1><div class=lead>clickhouse-keeper-service</div><h2 id=clickhouse-keeper-service>clickhouse-keeper-service</h2><h3 id=installation>installation</h3><p>Need to install <code>clickhouse-common-static</code> + <code>clickhouse-keeper</code> OR <code>clickhouse-common-static</code> + <code>clickhouse-server</code>.
Both OK, use the first if you don&rsquo;t need ClickHouse® server locally.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dpkg -i clickhouse-common-static_<span style=color:#ce5c00;font-weight:700>{</span>%version<span style=color:#ce5c00;font-weight:700>}</span>.deb clickhouse-keeper_<span style=color:#ce5c00;font-weight:700>{</span>%version<span style=color:#ce5c00;font-weight:700>}</span>.deb
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dpkg -i clickhouse-common-static_<span style=color:#ce5c00;font-weight:700>{</span>%version<span style=color:#ce5c00;font-weight:700>}</span>.deb clickhouse-server_<span style=color:#ce5c00;font-weight:700>{</span>%version<span style=color:#ce5c00;font-weight:700>}</span>.deb clickhouse-client_<span style=color:#ce5c00;font-weight:700>{</span>%version<span style=color:#ce5c00;font-weight:700>}</span>.deb
</span></span></code></pre></div><p>Create directories</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /etc/clickhouse-keeper/config.d
</span></span><span style=display:flex><span>mkdir -p /var/log/clickhouse-keeper
</span></span><span style=display:flex><span>mkdir -p /var/lib/clickhouse-keeper/coordination/log
</span></span><span style=display:flex><span>mkdir -p /var/lib/clickhouse-keeper/coordination/snapshots
</span></span><span style=display:flex><span>mkdir -p /var/lib/clickhouse-keeper/cores
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chown -R clickhouse.clickhouse /etc/clickhouse-keeper /var/log/clickhouse-keeper /var/lib/clickhouse-keeper
</span></span></code></pre></div><h3 id=config>config</h3><pre tabindex=0><code>cat /etc/clickhouse-keeper/config.xml

&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
    &lt;logger&gt;
        &lt;!-- Possible levels [1]:

          - none (turns off logging)
          - fatal
          - critical
          - error
          - warning
          - notice
          - information
          - debug
          - trace
          - test (not for production usage)

            [1]: https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/Logger.h#L105-L114
        --&gt;
        &lt;level&gt;trace&lt;/level&gt;
        &lt;log&gt;/var/log/clickhouse-keeper/clickhouse-keeper.log&lt;/log&gt;
        &lt;errorlog&gt;/var/log/clickhouse-keeper/clickhouse-keeper.err.log&lt;/errorlog&gt;
        &lt;!-- Rotation policy
             See https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/FileChannel.h#L54-L85
          --&gt;
        &lt;size&gt;1000M&lt;/size&gt;
        &lt;count&gt;10&lt;/count&gt;
        &lt;!-- &lt;console&gt;1&lt;/console&gt; --&gt; &lt;!-- Default behavior is autodetection (log to console if not daemon mode and is tty) --&gt;

        &lt;!-- Per level overrides (legacy):

        For example to suppress logging of the ConfigReloader you can use:
        NOTE: levels.logger is reserved, see below.
        --&gt;
        &lt;!--
        &lt;levels&gt;
          &lt;ConfigReloader&gt;none&lt;/ConfigReloader&gt;
        &lt;/levels&gt;
        --&gt;

        &lt;!-- Per level overrides:

        For example to suppress logging of the RBAC for default user you can use:
        (But please note that the logger name maybe changed from version to version, even after minor upgrade)
        --&gt;
        &lt;!--
        &lt;levels&gt;
          &lt;logger&gt;
            &lt;name&gt;ContextAccess (default)&lt;/name&gt;
            &lt;level&gt;none&lt;/level&gt;
          &lt;/logger&gt;
          &lt;logger&gt;
            &lt;name&gt;DatabaseOrdinary (test)&lt;/name&gt;
            &lt;level&gt;none&lt;/level&gt;
          &lt;/logger&gt;
        &lt;/levels&gt;
        --&gt;
        &lt;!-- Structured log formatting:
        You can specify log format(for now, JSON only). In that case, the console log will be printed
        in specified format like JSON.
        For example, as below:
        {&#34;date_time&#34;:&#34;1650918987.180175&#34;,&#34;thread_name&#34;:&#34;#1&#34;,&#34;thread_id&#34;:&#34;254545&#34;,&#34;level&#34;:&#34;Trace&#34;,&#34;query_id&#34;:&#34;&#34;,&#34;logger_name&#34;:&#34;BaseDaemon&#34;,&#34;message&#34;:&#34;Received signal 2&#34;,&#34;source_file&#34;:&#34;../base/daemon/BaseDaemon.cpp; virtual void SignalListener::run()&#34;,&#34;source_line&#34;:&#34;192&#34;}
        To enable JSON logging support, just uncomment &lt;formatting&gt; tag below.
        --&gt;
        &lt;!-- &lt;formatting&gt;json&lt;/formatting&gt; --&gt;
    &lt;/logger&gt;

    &lt;!-- Listen specified address.
     Use :: (wildcard IPv6 address), if you want to accept connections both with IPv4 and IPv6 from everywhere.
     Notes:
     If you open connections from wildcard address, make sure that at least one of the following measures applied:
     - server is protected by firewall and not accessible from untrusted networks;
     - all users are restricted to subset of network addresses (see users.xml);
     - all users have strong passwords, only secure (TLS) interfaces are accessible, or connections are only made via TLS interfaces.
     - users without password have readonly access.
     See also: https://www.shodan.io/search?query=clickhouse
    --&gt;
    &lt;!-- &lt;listen_host&gt;::&lt;/listen_host&gt; --&gt;


    &lt;!-- Same for hosts without support for IPv6: --&gt;
    &lt;!-- &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt; --&gt;

    &lt;!-- Default values - try listen localhost on IPv4 and IPv6. --&gt;
    &lt;!--
    &lt;listen_host&gt;::1&lt;/listen_host&gt;
    &lt;listen_host&gt;127.0.0.1&lt;/listen_host&gt;
    --&gt;

    &lt;!-- &lt;interserver_listen_host&gt;::&lt;/interserver_listen_host&gt; --&gt;
    &lt;!-- Listen host for communication between replicas. Used for data exchange --&gt;
    &lt;!-- Default values - equal to listen_host --&gt;

    &lt;!-- Don&#39;t exit if IPv6 or IPv4 networks are unavailable while trying to listen. --&gt;
    &lt;!-- &lt;listen_try&gt;0&lt;/listen_try&gt; --&gt;

    &lt;!-- Allow multiple servers to listen on the same address:port. This is not recommended.
    --&gt;
    &lt;!-- &lt;listen_reuse_port&gt;0&lt;/listen_reuse_port&gt; --&gt;
    &lt;!-- &lt;listen_backlog&gt;4096&lt;/listen_backlog&gt; --&gt;

    &lt;path&gt;/var/lib/clickhouse-keeper/&lt;/path&gt;
    &lt;core_path&gt;/var/lib/clickhouse-keeper/cores&lt;/core_path&gt;

    &lt;keeper_server&gt;
	    &lt;tcp_port&gt;2181&lt;/tcp_port&gt;
	    &lt;server_id&gt;1&lt;/server_id&gt;
	    &lt;log_storage_path&gt;/var/lib/clickhouse-keeper/coordination/log&lt;/log_storage_path&gt;
	    &lt;snapshot_storage_path&gt;/var/lib/clickhouse-keeper/coordination/snapshots&lt;/snapshot_storage_path&gt;

	    &lt;coordination_settings&gt;
        	&lt;operation_timeout_ms&gt;10000&lt;/operation_timeout_ms&gt;
	        &lt;session_timeout_ms&gt;30000&lt;/session_timeout_ms&gt;
	        &lt;raft_logs_level&gt;trace&lt;/raft_logs_level&gt;
	        &lt;rotate_log_storage_interval&gt;10000&lt;/rotate_log_storage_interval&gt;
	    &lt;/coordination_settings&gt;

            &lt;raft_configuration&gt;
	              &lt;server&gt;
                   &lt;id&gt;1&lt;/id&gt;
                   &lt;hostname&gt;localhost&lt;/hostname&gt;
                   &lt;port&gt;9444&lt;/port&gt;
                &lt;/server&gt;
           &lt;/raft_configuration&gt;
    &lt;/keeper_server&gt;
&lt;/clickhouse&gt;
</code></pre><pre tabindex=0><code>cat /etc/clickhouse-keeper/config.d/keeper.xml
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;clickhouse&gt;
    &lt;listen_host&gt;::&lt;/listen_host&gt;
    &lt;keeper_server&gt;
            &lt;tcp_port&gt;2181&lt;/tcp_port&gt;
            &lt;server_id&gt;1&lt;/server_id&gt;
            &lt;raft_configuration&gt;
                &lt;server&gt;
                   &lt;id&gt;1&lt;/id&gt;
       	           &lt;hostname&gt;keeper-host-1&lt;/hostname&gt;
                   &lt;port&gt;9444&lt;/port&gt;
                &lt;/server&gt;
                &lt;server&gt;
                   &lt;id&gt;2&lt;/id&gt;
                   &lt;hostname&gt;keeper-host-2&lt;/hostname&gt;
                   &lt;port&gt;9444&lt;/port&gt;
                &lt;/server&gt;
                &lt;server&gt;
                   &lt;id&gt;3&lt;/id&gt;
                   &lt;hostname&gt;keeper-host-3&lt;/hostname&gt;
                   &lt;port&gt;9444&lt;/port&gt;
                &lt;/server&gt;                
           &lt;/raft_configuration&gt;
    &lt;/keeper_server&gt;
&lt;/clickhouse&gt;
</code></pre><h3 id=systemd-service>systemd service</h3><pre tabindex=0><code>cat /lib/systemd/system/clickhouse-keeper.service
[Unit]
Description=ClickHouse Keeper (analytic DBMS for big data)
Requires=network-online.target
# NOTE: that After/Wants=time-sync.target is not enough, you need to ensure
# that the time was adjusted already, if you use systemd-timesyncd you are
# safe, but if you use ntp or some other daemon, you should configure it
# additionaly.
After=time-sync.target network-online.target
Wants=time-sync.target

[Service]
Type=simple
User=clickhouse
Group=clickhouse
Restart=always
RestartSec=30
RuntimeDirectory=clickhouse-keeper
ExecStart=/usr/bin/clickhouse-keeper --config=/etc/clickhouse-keeper/config.xml --pid-file=/run/clickhouse-keeper/clickhouse-keeper.pid
# Minus means that this file is optional.
EnvironmentFile=-/etc/default/clickhouse
LimitCORE=infinity
LimitNOFILE=500000
CapabilityBoundingSet=CAP_NET_ADMIN CAP_IPC_LOCK CAP_SYS_NICE CAP_NET_BIND_SERVICE

[Install]
# ClickHouse should not start from the rescue shell (rescue.target).
WantedBy=multi-user.target
</code></pre><pre tabindex=0><code>systemctl daemon-reload

systemctl status clickhouse-keeper

systemctl start clickhouse-keeper
</code></pre><h3 id=debug-start-without-service-as-foreground-application>debug start without service (as foreground application)</h3><pre tabindex=0><code>sudo -u clickhouse /usr/bin/clickhouse-keeper --config=/etc/clickhouse-keeper/config.xml
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-05425e768ddcc5be5d1203f59044e6d5>3 - Install standalone Zookeeper for ClickHouse® on Ubuntu / Debian</h1><div class=lead>Install standalone Zookeeper for ClickHouse® on Ubuntu / Debian.</div><h2 id=reference-script-to-install-standalone-zookeeper-for-ubuntu--debian>Reference script to install standalone Zookeeper for Ubuntu / Debian</h2><p>Tested on Ubuntu 20.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># install java runtime environment</span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt install default-jre
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># prepare folders, logs folder should be on the low-latency disk.</span>
</span></span><span style=display:flex><span>sudo mkdir -p /var/lib/zookeeper/data /var/lib/zookeeper/logs /etc/zookeeper /var/log/zookeeper /opt 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># download and install files </span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>3.6.3
</span></span><span style=display:flex><span>wget https://dlcdn.apache.org/zookeeper/zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin.tar.gz -O /tmp/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin.tar.gz
</span></span><span style=display:flex><span>sudo tar -xvf /tmp/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin.tar.gz -C /opt
</span></span><span style=display:flex><span>rm -rf /tmp/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># create the user </span>
</span></span><span style=display:flex><span>sudo groupadd -r zookeeper
</span></span><span style=display:flex><span>sudo useradd -r -g zookeeper --home-dir<span style=color:#ce5c00;font-weight:700>=</span>/var/lib/zookeeper --shell<span style=color:#ce5c00;font-weight:700>=</span>/bin/false zookeeper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># symlink pointing to the used version of zookeeper distibution</span>
</span></span><span style=display:flex><span>sudo ln -s /opt/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin /opt/zookeeper 
</span></span><span style=display:flex><span>sudo chown -R zookeeper:zookeeper /var/lib/zookeeper /var/log/zookeeper /etc/zookeeper /opt/apache-zookeeper-<span style=color:#4e9a06>${</span><span style=color:#000>ZOOKEEPER_VERSION</span><span style=color:#4e9a06>}</span>-bin
</span></span><span style=display:flex><span>sudo chown -h zookeeper:zookeeper /opt/zookeeper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># shortcuts in /usr/local/bin/</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkCli.sh &#34;$@&#34;&#39;</span>             <span style=color:#000;font-weight:700>|</span> sudo tee /usr/local/bin/zkCli
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkServer.sh &#34;$@&#34;&#39;</span>          <span style=color:#000;font-weight:700>|</span> sudo tee /usr/local/bin/zkServer
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkCleanup.sh &#34;$@&#34;&#39;</span>         <span style=color:#000;font-weight:700>|</span> sudo tee /usr/local/bin/zkCleanup
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkSnapShotToolkit.sh &#34;$@&#34;&#39;</span> <span style=color:#000;font-weight:700>|</span> sudo tee /usr/local/bin/zkSnapShotToolkit
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> -e <span style=color:#4e9a06>&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkTxnLogToolkit.sh &#34;$@&#34;&#39;</span>   <span style=color:#000;font-weight:700>|</span> sudo tee /usr/local/bin/zkTxnLogToolkit
</span></span><span style=display:flex><span>sudo chmod +x /usr/local/bin/zkCli /usr/local/bin/zkServer /usr/local/bin/zkCleanup /usr/local/bin/zkSnapShotToolkit /usr/local/bin/zkTxnLogToolkit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># put in the config</span>
</span></span><span style=display:flex><span>sudo cp opt/zookeeper/conf/* /etc/zookeeper
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | sudo tee /etc/zookeeper/zoo.cfg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>initLimit=20
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>syncLimit=10
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>maxSessionTimeout=60000000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>maxClientCnxns=2000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>preAllocSize=131072
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>snapCount=3000000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>dataDir=/var/lib/zookeeper/data
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>dataLogDir=/var/lib/zookeeper/logs # use low-latency disk!
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>clientPort=2181
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>#clientPortAddress=nthk-zoo1.localdomain
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>autopurge.snapRetainCount=10
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>autopurge.purgeInterval=1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>4lw.commands.whitelist=*
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>sudo chown -R zookeeper:zookeeper /etc/zookeeper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># create systemd service file</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | sudo tee /etc/systemd/system/zookeeper.service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Description=Zookeeper Daemon
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Documentation=http://zookeeper.apache.org
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Requires=network.target
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>After=network.target
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[Service]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Type=forking
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>WorkingDirectory=/var/lib/zookeeper
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>User=zookeeper
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Group=zookeeper
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Environment=ZK_SERVER_HEAP=1536 # in megabytes, adjust to ~ 80-90% of avaliable RAM (more than 8Gb is rather overkill)
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Environment=SERVER_JVMFLAGS=&#34;-Xms256m -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Environment=ZOO_LOG_DIR=/var/log/zookeeper
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ExecStart=/opt/zookeeper/bin/zkServer.sh start /etc/zookeeper/zoo.cfg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ExecStop=/opt/zookeeper/bin/zkServer.sh stop /etc/zookeeper/zoo.cfg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ExecReload=/opt/zookeeper/bin/zkServer.sh restart /etc/zookeeper/zoo.cfg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>TimeoutSec=30
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Restart=on-failure
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[Install]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>WantedBy=default.target
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># start zookeeper</span>
</span></span><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo systemctl start zookeeper.service 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check status etc.</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> stat <span style=color:#000;font-weight:700>|</span> nc localhost <span style=color:#0000cf;font-weight:700>2181</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> ruok <span style=color:#000;font-weight:700>|</span> nc localhost <span style=color:#0000cf;font-weight:700>2181</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> mntr <span style=color:#000;font-weight:700>|</span> nc localhost <span style=color:#0000cf;font-weight:700>2181</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-564a3bbd39f9550e577334d912a883dc>4 - How to check the list of watches</h1><div class=lead>How to check the list of watches</div><p>Zookeeper use watches to notify a client on znode changes. This article explains how to check watches set by ZooKeeper servers and how it is used.</p><p><strong>Solution:</strong></p><p>Zookeeper uses the <code>'wchc'</code> command to list all watches set on the Zookeeper server.</p><p><code># echo wchc | nc zookeeper 2181</code></p><p>Reference</p><p><a href=https://zookeeper.apache.org/doc/r3.4.12/zookeeperAdmin.html target=_blank>https://zookeeper.apache.org/doc/r3.4.12/zookeeperAdmin.html</a></p><p>The <code>wchp</code> and <code>wchc</code> commands are not enabled by default because of their known DOS vulnerability. For more information, see <a href=https://issues.apache.org/jira/browse/ZOOKEEPER-2693 target=_blank>ZOOKEEPER-2693</a>
and <a href=https://vulners.com/exploitdb/EDB-ID:41277 target=_blank>Zookeeper 3.5.2 - Denial of Service</a>
.</p><p>By default those commands are disabled, they can be enabled via Java system property:</p><p><code>-Dzookeeper.4lw.commands.whitelist=*</code></p><p>on in zookeeper config: <code>4lw.commands.whitelist=*</code>\</p></div><div class=td-content style=page-break-before:always><h1 id=pg-722cb96284be123698aa3e56ea92ecaf>5 - JVM sizes and garbage collector settings</h1><div class=lead>JVM sizes and garbage collector settings</div><h2 id=tldr-version>TLDR version</h2><p>use fresh Java version (11 or newer), disable swap and set up (for 4 Gb node):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>JAVA_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;-Xms512m -Xmx3G -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;</span>
</span></span></code></pre></div><p>If you have a node with more RAM - change it accordingly, for example for 8Gb node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>JAVA_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;-Xms512m -Xmx7G -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;</span>
</span></span></code></pre></div><h2 id=details>Details</h2><ol><li><p>ZooKeeper runs as in JVM. Depending on version different garbage collectors are available.</p></li><li><p>Recent JVM versions (starting from 10) use <code>G1</code> garbage collector by default (should work fine).
On JVM 13-14 using <code>ZGC</code> or <code>Shenandoah</code> garbage collector may reduce pauses.
On older JVM version (before 10) you may want to make some tuning to decrease pauses, ParNew + CMS garbage collectors (like in Yandex config) is one of the best options.</p></li><li><p>One of the most important setting for JVM application is heap size. A heap size of >1 GB is recommended for most use cases and monitoring heap usage to ensure no delays are caused by garbage collection. We recommend to use at least 4Gb of RAM for zookeeper nodes (8Gb is better, that will make difference only when zookeeper is heavily loaded).</p></li></ol><p>Set the Java heap size smaller than available RAM size on the node. This is very important to avoid swapping, which will seriously degrade ZooKeeper performance. Be conservative - use a maximum heap size of 3GB for a 4GB machine.</p><ol><li><p>Add <code>XX:+AlwaysPreTouch</code> flag as well to load the memory pages into memory at the start of the zookeeper.</p></li><li><p>Set min (<code>Xms</code>) heap size to the values like 512Mb, or even to the same value as max (<code>Xmx</code>) to avoid resizing and returning the RAM to OS. Add <code>XX:+AlwaysPreTouch</code> flag as well to load the memory pages into memory at the start of the zookeeper.</p></li><li><p><code>MaxGCPauseMillis=50</code> (by default 200) - the &rsquo;target&rsquo; acceptable pause for garbage collection (milliseconds)</p></li><li><p><code>jute.maxbuffer</code> limits the maximum size of znode content. By default it&rsquo;s 1Mb. In some usecases (lot of partitions in table) ClickHouse® may need to create bigger znodes.</p></li><li><p>(optional) enable GC logs: <code>-Xloggc:/path_to/gc.log</code></p></li></ol><h2 id=zookeeper-configuration-used-by-yandex-metrika-from-2017>Zookeeper configuration used by Yandex Metrika (from 2017)</h2><p>The configuration used by Yandex ( <a href=https://clickhouse.com/docs/en/operations/tips#zookeeper target=_blank rel=nofollow>https://clickhouse.com/docs/en/operations/tips#zookeeper</a>
) - they use older JVM version (with <code>UseParNewGC</code> garbage collector), and tune GC logs heavily:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>JAVA_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;-Xms{{ cluster.get(&#39;xms&#39;,&#39;128M&#39;) }} \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -Xmx{{ cluster.get(&#39;xmx&#39;,&#39;1G&#39;) }} \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -Xloggc:/var/log/</span><span style=color:#000>$NAME</span><span style=color:#4e9a06>/zookeeper-gc.log \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+UseGCLogFileRotation \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:NumberOfGCLogFiles=16 \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:GCLogFileSize=16M \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -verbose:gc \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintGCTimeStamps \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintGCDateStamps \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintGCDetails
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintTenuringDistribution \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintGCApplicationStoppedTime \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintGCApplicationConcurrentTime \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+PrintSafepointStatistics \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+UseParNewGC \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+UseConcMarkSweepGC \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -XX:+CMSParallelRemarkEnabled&#34;</span>
</span></span></code></pre></div><h2 id=see-also>See also</h2><ul><li><a href=https://wikitech.wikimedia.org/wiki/JVM_Tuning#G1_for_full_gcs target=_blank>https://wikitech.wikimedia.org/wiki/JVM_Tuning#G1_for_full_gcs</a></li><li><a href=https://sematext.com/blog/java-garbage-collection-tuning/ target=_blank>https://sematext.com/blog/java-garbage-collection-tuning/</a></li><li><a href=https://www.oracle.com/technical-resources/articles/java/g1gc.html target=_blank>https://www.oracle.com/technical-resources/articles/java/g1gc.html</a></li><li><a href=https://docs.oracle.com/cd/E40972_01/doc.70/e40973/cnf_jvmgc.htm#autoId2 target=_blank>https://docs.oracle.com/cd/E40972_01/doc.70/e40973/cnf_jvmgc.htm#autoId2</a></li><li><a href=https://docs.cloudera.com/runtime/7.2.7/kafka-performance-tuning/topics/kafka-tune-broker-tuning-jvm.html target=_blank>https://docs.cloudera.com/runtime/7.2.7/kafka-performance-tuning/topics/kafka-tune-broker-tuning-jvm.html</a></li><li><a href=https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cm-tune-g1gc.html target=_blank>https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cm-tune-g1gc.html</a></li><li><a href=https://www.maknesium.de/21-most-important-java-8-vm-options-for-servers target=_blank>https://www.maknesium.de/21-most-important-java-8-vm-options-for-servers</a></li><li><a href=https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304 target=_blank>https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304</a></li><li><a href=https://github.com/chewiebug/GCViewer target=_blank>https://github.com/chewiebug/GCViewer</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1ef2081889fb4a086febf3b281e44778>6 - Proper setup</h1><div class=lead>Proper setup</div><h3 id=main-docs-article>Main docs article</h3><p><a href=https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/ target=_blank>https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/</a></p><h3 id=hardware-requirements>Hardware requirements</h3><p>TLDR version:</p><ol><li>USE DEDICATED FAST DISKS for the transaction log! (crucial for performance due to write-ahead-log, NVMe is preferred for heavy load setup).</li><li>use 3 nodes (more nodes = slower quorum, less = no HA).</li><li>low network latency between zookeeper nodes is very important (latency, not bandwidth).</li><li>have at least 4Gb of RAM, disable swap, tune JVM sizes, and garbage collector settings.</li><li>ensure that zookeeper will not be CPU-starved by some other processes</li><li>monitor zookeeper.</li></ol><p>Side note:
in many cases, the slowness of the zookeeper is actually a symptom of some issue with ClickHouse® schema/usage pattern (the most typical issues: an enormous number of partitions/tables/databases with real-time inserts, tiny & frequent inserts).</p><p>Some doc about that subject:</p><ul><li><a href=https://docs.confluent.io/platform/current/zookeeper/deployment.html target=_blank>https://docs.confluent.io/platform/current/zookeeper/deployment.html</a></li><li><a href=https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems target=_blank>https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems</a></li><li><a href=https://clickhouse.tech/docs/en/operations/tips/#zookeeper target=_blank rel=nofollow>https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a></li><li><a href=https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html target=_blank>https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html</a></li><li><a href=https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting target=_blank>https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting</a></li></ul><p>Cite from <a href=https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems target=_blank>https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems</a>
:</p><blockquote><h2 id=things-to-avoid>Things to Avoid</h2><p>Here are some common problems you can avoid by configuring ZooKeeper correctly:</p><ul><li><em>inconsistent lists of servers</em> : The list of ZooKeeper servers used by the clients must match the list of ZooKeeper servers that each ZooKeeper server has. Things work okay if the client list is a subset of the real list, but things will really act strange if clients have a list of ZooKeeper servers that are in different ZooKeeper clusters. Also, the server lists in each Zookeeper server configuration file should be consistent with one another.</li><li><em>incorrect placement of transaction log</em> : The most performance critical part of ZooKeeper is the transaction log. ZooKeeper syncs transactions to media before it returns a response. A dedicated transaction log device is key to consistent good performance. Putting the log on a busy device will adversely affect performance. If you only have one storage device, increase the snapCount so that snapshot files are generated less often; it does not eliminate the problem, but it makes more resources available for the transaction log.</li><li><em>incorrect Java heap size</em> : You should take special care to set your Java max heap size correctly. In particular, you should not create a situation in which ZooKeeper swaps to disk. The disk is death to ZooKeeper. Everything is ordered, so if processing one request swaps the disk, all other queued requests will probably do the same. the disk. DON&rsquo;T SWAP. Be conservative in your estimates: if you have 4G of RAM, do not set the Java max heap size to 6G or even 4G. For example, it is more likely you would use a 3G heap for a 4G machine, as the operating system and the cache also need memory. The best and only recommend practice for estimating the heap size your system needs is to run load tests, and then make sure you are well below the usage limit that would cause the system to swap.</li><li><em>Publicly accessible deployment</em> : A ZooKeeper ensemble is expected to operate in a trusted computing environment. It is thus recommended to deploy ZooKeeper behind a firewall.</li></ul></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-66b660806f12af38114754857823e52a>7 - Recovering from complete metadata loss in ZooKeeper</h1><div class=lead>Recovering from complete metadata loss in ZooKeeper</div><h2 id=problem>Problem</h2><p>Every ClickHouse® user experienced a loss of ZooKeeper one day. While the data is available and replicas respond to queries, inserts are no longer possible. ClickHouse uses ZooKeeper in order to store the reference version of the table structure and part of data, and when it is not available can not guarantee data consistency anymore. Replicated tables turn to the read-only mode. In this article we describe step-by-step instructions of how to restore ZooKeeper metadata and bring ClickHouse cluster back to normal operation.</p><p>In order to restore ZooKeeper we have to solve two tasks. First, we need to restore table metadata in ZooKeeper. Currently, the only way to do it is to recreate the table with the <code>CREATE TABLE DDL</code> statement.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;zookeeper_path&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;replica_name&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The second and more difficult task is to populate zookeeper with information of ClickHouse data parts. As mentioned above, ClickHouse stores the reference data about all parts of replicated tables in ZooKeeper, so we have to traverse all partitions and re-attach them to the recovered replicated table in order to fix that.</p><div class="alert alert-info" role=alert><h4 class=alert-heading>Info</h4>Starting from ClickHouse version 21.7 there is SYSTEM RESTORE REPLICA command</div><p><a href=https://altinity.com/blog/a-new-way-to-restore-clickhouse-after-zookeeper-metadata-is-lost target=_blank>https://altinity.com/blog/a-new-way-to-restore-clickhouse-after-zookeeper-metadata-is-lost</a></p><h2 id=test-case>Test case</h2><p>Let&rsquo;s say we have replicated table <code>table_repl</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87>number</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intDiv</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>And populate it with some data</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zookeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;/clickhouse/cluster_1/tables/01/&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>system</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;table_repl&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partition</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Now let’s remove metadata in zookeeper using <code>ZkCli.sh</code> at ZooKeeper host:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>deleteall  /clickhouse/cluster_1/tables/01/table_repl
</span></span></code></pre></div><p>And try to resync ClickHouse replica state with zookeeper:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>RESTART</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>REPLICA</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>If we try to insert some data in the table, error happens:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>And now we have an exception that we lost all metadata in zookeeper. It is time to recover!</p><h2 id=current-solution>Current Solution</h2><ol><li><p>Detach replicated table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>DETACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Save the table’s attach script and change engine of replicated table to non-replicated *mergetree analogue. Table definition is located in the ‘metadata’ folder, ‘<code>/var/lib/clickhouse/metadata/default/table_repl.sql</code>’ in our example. Please make a backup copy and modify the file as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87>number</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intDiv</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Needs to be replaced with this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87>number</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intDiv</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Attach non-replicated table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Rename non-replicated table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl_old</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Create a new replicated table. Take the saved attach script and replace ATTACH with CREATE, and run it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87>number</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intDiv</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Attach parts from old table to new.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl_old</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ATTACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>table_repl_old</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li></ol><p>If the table has many partitions, it may require some shell script to make it easier.</p><h3 id=automated-approach>Automated approach</h3><p>For a large number of tables, you can use script <a href=https://github.com/Altinity/clickhouse-zookeeper-recovery target=_blank>https://github.com/Altinity/clickhouse-zookeeper-recovery</a>
which partially automates the above approach.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4c33701373e85b893c3b3464fa4f6683>8 - Using clickhouse-keeper</h1><div class=lead>Moving to the ClickHouse® alternative to Zookeeper</div><p>Since 2021 the development of built-in ClickHouse® alternative for Zookeeper is happening, whose goal is to address several design pitfalls, and get rid of extra dependency.</p><p>See slides: <a href=https://presentations.clickhouse.com/meetup54/keeper.pdf target=_blank rel=nofollow>https://presentations.clickhouse.com/meetup54/keeper.pdf</a>
and video <a href="https://youtu.be/IfgtdU1Mrm0?t=2682" target=_blank>https://youtu.be/IfgtdU1Mrm0?t=2682</a></p><h2 id=current-status-last-updated-july-2023>Current status (last updated: July 2023)</h2><p>Since version 23.3 we recommend using clickhouse-keeper for new installations.</p><p>Even better if you will use the latest version of clickhouse-keeper (currently it&rsquo;s 23.7), and it&rsquo;s not necessary to use the same version of clickhouse-keeper as ClickHouse itself.</p><p>For existing systems that currently use Apache Zookeeper, you can consider upgrading to clickhouse-keeper especially if you will <a href=https://altinity.com/clickhouse-upgrade-overview/ target=_blank>upgrade ClickHouse</a>
also.</p><p>But please remember that on very loaded systems the change can give no performance benefits or can sometimes lead to a worse performance.</p><p>The development pace of keeper code is <a href="https://github.com/ClickHouse/ClickHouse/pulls?q=is%3Apr+keeper" target=_blank>still high</a>
so every new version should bring improvements / cover the issues, and stability/maturity grows from version to version, so
if you want to play with clickhouse-keeper in some environment - please use <a href=https://altinity.com/altinity-stable/ target=_blank>the most recent ClickHouse releases</a>
! And of course: share your feedback :)</p><h2 id=how-does-clickhouse-keeper-work>How does clickhouse-keeper work?</h2><p>Official docs: <a href=https://clickhouse.com/docs/en/guides/sre/keeper/clickhouse-keeper/ target=_blank rel=nofollow>https://clickhouse.com/docs/en/guides/sre/keeper/clickhouse-keeper/</a></p><p>ClickHouse-keeper still need to be started additionally on few nodes (similar to &rsquo;normal&rsquo; zookeeper) and speaks normal zookeeper protocol - needed to simplify A/B tests with real zookeeper.</p><p>To test that you need to run 3 instances of clickhouse-server (which will mimic zookeeper) with an extra config like that:</p><p><a href=https://github.com/ClickHouse/ClickHouse/blob/master/tests/integration/test_keeper_multinode_simple/configs/enable_keeper1.xml target=_blank>https://github.com/ClickHouse/ClickHouse/blob/master/tests/integration/test_keeper_multinode_simple/configs/enable_keeper1.xml</a></p><p><a href=https://github.com/ClickHouse/ClickHouse/blob/master/tests/integration/test_keeper_snapshots/configs/enable_keeper.xml target=_blank>https://github.com/ClickHouse/ClickHouse/blob/master/tests/integration/test_keeper_snapshots/configs/enable_keeper.xml</a></p><p>or event single instance with config like that: <a href=https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/keeper_port.xml target=_blank>https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/keeper_port.xml</a>
<a href=https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/zookeeper.xml target=_blank>https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/zookeeper.xml</a></p><p>And point all the ClickHouses (zookeeper config section) to those nodes / ports.</p><p>Latest version is recommended (even testing / master builds). We will be thankful for any feedback.</p><h2 id=systemd-service-file>systemd service file</h2><p>See
<a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/clickhouse-keeper-service/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/clickhouse-keeper-service/</a></p><h2 id=initd-script>init.d script</h2><p>See
<a href=https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/clickhouse-keeper-initd/ target=_blank>https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/clickhouse-keeper-initd/</a></p><h2 id=example-of-a-simple-cluster-with-2-nodes-of-clickhouse-using-built-in-keeper>Example of a simple cluster with 2 nodes of ClickHouse using built-in keeper</h2><p>For example you can start two ClickHouse nodes (hostname1, hostname2)</p><h3 id=hostname1>hostname1</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/keeper.xml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;keeper_server&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;tcp_port&gt;</span>2181<span style=color:#204a87;font-weight:700>&lt;/tcp_port&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;server_id&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/server_id&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;log_storage_path&gt;</span>/var/lib/clickhouse/coordination/log<span style=color:#204a87;font-weight:700>&lt;/log_storage_path&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;snapshot_storage_path&gt;</span>/var/lib/clickhouse/coordination/snapshots<span style=color:#204a87;font-weight:700>&lt;/snapshot_storage_path&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;coordination_settings&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;operation_timeout_ms&gt;</span>10000<span style=color:#204a87;font-weight:700>&lt;/operation_timeout_ms&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;session_timeout_ms&gt;</span>30000<span style=color:#204a87;font-weight:700>&lt;/session_timeout_ms&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;raft_logs_level&gt;</span>trace<span style=color:#204a87;font-weight:700>&lt;/raft_logs_level&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;rotate_log_storage_interval&gt;</span>10000<span style=color:#204a87;font-weight:700>&lt;/rotate_log_storage_interval&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/coordination_settings&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;raft_configuration&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;server&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>                 <span style=color:#204a87;font-weight:700>&lt;hostname&gt;</span>hostname1<span style=color:#204a87;font-weight:700>&lt;/hostname&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9444<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/server&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;server&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>                 <span style=color:#204a87;font-weight:700>&lt;hostname&gt;</span>hostname2<span style=color:#204a87;font-weight:700>&lt;/hostname&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9444<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/server&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/raft_configuration&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/keeper_server&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;zookeeper&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;node&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>localhost<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>2181<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/node&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/zookeeper&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;distributed_ddl&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;path&gt;</span>/clickhouse/testcluster/task_queue/ddl<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/distributed_ddl&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/macros.xml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;macros&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;cluster&gt;</span>testcluster<span style=color:#204a87;font-weight:700>&lt;/cluster&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>replica1<span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/shard&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/macros&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div><h3 id=hostname2>hostname2</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/keeper.xml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;keeper_server&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;tcp_port&gt;</span>2181<span style=color:#204a87;font-weight:700>&lt;/tcp_port&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;server_id&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/server_id&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;log_storage_path&gt;</span>/var/lib/clickhouse/coordination/log<span style=color:#204a87;font-weight:700>&lt;/log_storage_path&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;snapshot_storage_path&gt;</span>/var/lib/clickhouse/coordination/snapshots<span style=color:#204a87;font-weight:700>&lt;/snapshot_storage_path&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;coordination_settings&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;operation_timeout_ms&gt;</span>10000<span style=color:#204a87;font-weight:700>&lt;/operation_timeout_ms&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;session_timeout_ms&gt;</span>30000<span style=color:#204a87;font-weight:700>&lt;/session_timeout_ms&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;raft_logs_level&gt;</span>trace<span style=color:#204a87;font-weight:700>&lt;/raft_logs_level&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;rotate_log_storage_interval&gt;</span>10000<span style=color:#204a87;font-weight:700>&lt;/rotate_log_storage_interval&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/coordination_settings&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;raft_configuration&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;server&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>                 <span style=color:#204a87;font-weight:700>&lt;hostname&gt;</span>hostname1<span style=color:#204a87;font-weight:700>&lt;/hostname&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9444<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/server&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;server&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>2<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>                 <span style=color:#204a87;font-weight:700>&lt;hostname&gt;</span>hostname2<span style=color:#204a87;font-weight:700>&lt;/hostname&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9444<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/server&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/raft_configuration&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/keeper_server&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;zookeeper&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;node&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>localhost<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>2181<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/node&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/zookeeper&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;distributed_ddl&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;path&gt;</span>/clickhouse/testcluster/task_queue/ddl<span style=color:#204a87;font-weight:700>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/distributed_ddl&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/macros.xml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;macros&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;cluster&gt;</span>testcluster<span style=color:#204a87;font-weight:700>&lt;/cluster&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>replica2<span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/shard&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/macros&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div><h3 id=on-both>on both</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>$ cat /etc/clickhouse-server/config.d/clusters.xml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;yandex&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;remote_servers&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;testcluster&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;shard&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>hostname1<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9000<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;replica&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;host&gt;</span>hostname2<span style=color:#204a87;font-weight:700>&lt;/host&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;port&gt;</span>9000<span style=color:#204a87;font-weight:700>&lt;/port&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/replica&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/shard&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/testcluster&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/remote_servers&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/yandex&gt;</span>
</span></span></code></pre></div><p>Then create a table</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{cluster}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplicatedMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/clickhouse/{cluster}/tables/{database}/{table}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;{replica}&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>Order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- on both nodes:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8892167f56e913cb6f2d429fc16315c8>9 - ZooKeeper backup</h1><div class=lead>ZooKeeper backup</div><p>Question: Do I need to backup Zookeeper Database, because it’s pretty important for ClickHouse®?</p><p>TLDR answer: <strong>NO, just backup ClickHouse data itself, and do SYSTEM RESTORE REPLICA during recovery to recreate zookeeper data</strong></p><p>Details:</p><p>Zookeeper does not store any data, it stores the STATE of the distributed system (&ldquo;that replica have those parts&rdquo;, &ldquo;still need 2 merges to do&rdquo;, &ldquo;alter is being applied&rdquo; etc). That state always changes, and you can not capture / backup / and recover that state in a safe manner. So even backup from few seconds ago is representing some &lsquo;old state from the past&rsquo; which is INCONSISTENT with actual state of the data.</p><p>In other words - if ClickHouse is working - then the state of distributed system always changes, and it&rsquo;s almost impossible to collect the current state of zookeeper (while you collecting it it will change many times). The only exception is &lsquo;stop-the-world&rsquo; scenario - i.e. shutdown all ClickHouse nodes, with all other zookeeper clients, then shutdown all the zookeeper, and only then take the backups, in that scenario and backups of zookeeper & ClickHouse will be consistent. In that case restoring the backup is as simple (and is equal to) as starting all the nodes which was stopped before. But usually that scenario is very non-practical because it requires huge downtime.</p><p>So what to do instead? It&rsquo;s enough if you will backup ClickHouse data itself, and to recover the state of zookeeper you can just run the command <code>SYSTEM RESTORE REPLICA</code> command <strong>AFTER</strong> restoring the ClickHouse data itself. That will recreate the state of the replica in the zookeeper as it exists on the filesystem after backup recovery.</p><p>Normally Zookeeper ensemble consists of 3 nodes, which is enough to survive hardware failures.</p><p>On older version (which don&rsquo;t have <code>SYSTEM RESTORE REPLICA</code> command - it can be done manually, using instruction <a href=https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replication/#converting-from-mergetree-to-replicatedmergetree%29 target=_blank rel=nofollow>https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replication/#converting-from-mergetree-to-replicatedmergetree)</a>
, on scale you can try <a href=https://github.com/Altinity/clickhouse-zookeeper-recovery target=_blank>https://github.com/Altinity/clickhouse-zookeeper-recovery</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f9f14245cdbc89d13e77a5b1b24de46e>10 - ZooKeeper cluster migration</h1><div class=lead>ZooKeeper cluster migration</div><p>Here is a plan for ZK 3.4.9 (no dynamic reconfiguration):</p><ol><li>Add the 3 new ZK nodes to the old cluster. No changes needed for the 3 old ZK nodes at this time.<ol><li>Configure one of the new ZK nodes as a cluster of 4 nodes (3 old + 1 new), start it.</li><li>Configure the other two new ZK nodes as a cluster of 6 nodes (3 old + 3 new), start them.</li></ol></li><li>Make sure the 3 new ZK nodes connected to the old ZK cluster as followers (run <code>echo stat | nc localhost 2181</code> on the 3 new ZK nodes)</li><li>Confirm that the leader has 5 synced followers (run <code>echo mntr | nc localhost 2181</code> on the leader, look for <code>zk_synced_followers</code>)</li><li>Stop data ingestion in CH (this is to minimize errors when CH loses ZK).</li><li>Change the zookeeper section in the configs on the CH nodes (remove the 3 old ZK servers, add the 3 new ZK servers)</li><li>Make sure that there are no connections from CH to the 3 old ZK nodes (run <code>echo stat | nc localhost 2181</code> on the 3 old nodes, check their <code>Clients</code> section). Restart all CH nodes if necessary (In some cases CH can reconnect to different ZK servers without a restart).</li><li>Remove the 3 old ZK nodes from <code>zoo.cfg</code> on the 3 new ZK nodes.</li><li>Restart the 3 new ZK nodes. They should form a cluster of 3 nodes.</li><li>When CH reconnects to ZK, start data loading.</li><li>Turn off the 3 old ZK nodes.</li></ol><p>This plan works, but it is not the only way to do this, it can be changed if needed.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9eb0d707fbf1e834507aa5b61897fc15>11 - ZooKeeper cluster migration when using K8s node local storage</h1><div class=lead>ZooKeeper cluster migration when using K8s node local storage</div><p>Describes how to migrate a ZooKeeper cluster when using K8s node-local storage such as static PV, <code>local-path</code>, <code>TopoLVM</code>.</p><p>Requires HA setup (3+ pods).</p><p>This solution is more risky than <a href=http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/altinity-kb-zookeeper-cluster-migration/>migration by adding followers</a>
because it reduces
the number of active consensus members but is operationally simpler. When running with <code>clickhouse-keeper</code>, it can be
performed gracefully so that quorum is maintained during the whole operation.</p><ol><li>Find the leader pod and note its name<ol><li>To detect leader run <code>echo stat | nc 127.0.0.1 2181 | grep leader</code> inside pods</li></ol></li><li>Make sure the ZK cluster is healthy and all nodes are in sync<ol><li>(run on leader) <code>echo mntr | nc 127.0.0.1 2181 | grep zk_synced_followers</code> should be N-1 for N member cluster</li></ol></li><li>Pick the first <strong>non-leader</strong> pod and delete its <code>PVC</code>,<ol><li><code>kubectl delete --wait=false pvc clickhouse-keeper-data-0</code> -> status should be <code>Terminating</code></li><li>Also delete <code>PV</code> if your <code>StorageClass</code> reclaim policy is set to <code>Retain</code></li></ol></li><li>If you are using dynamic volume provisioning make adjustments based on your k8s infrastructure (such as moving labels and taints or cordoning node) so that after pod delete the new one will be scheduled on the planned node<ol><li><code>kubectl label node planned-node dedicated=zookeeper</code></li><li><code>kubectl label node this-pod-node dedicated-</code></li><li><code>kubectl taint node planned-node dedicated=zookeeper:NoSchedule</code></li><li><code>kubectl taint node this-pod-node dedicated=zookeeper:NoSchedule-</code></li></ol></li><li>For manual volume provisioning wait till a new <code>PVC</code> is created and then provision volume on the planned node</li><li>Delete the first non-leader pod and wait for its PV to be deleted<ol><li><code>kubectl delete pod clickhouse-keeper-0</code></li><li><code>kubectl wait --for=delete pv/pvc-0a823311-616f-4b7e-9b96-0c059c62ab3b --timeout=120s</code></li></ol></li><li>Wait for the new pod to be scheduled and volume provisioned (or provision manual volume per instructions above)</li><li>Ensure new member joined and synced<ol><li>(run on leader) <code>echo mntr | nc 127.0.0.1 2181 | grep zk_synced_followers</code> should be N-1 for N member cluster</li></ol></li><li>Repeat for all other non-leader pods</li><li>(ClickHouse® Keeper only), for Zookeeper you will need to force an election by stopping the leader<ol><li>Ask the current leader to yield leadership</li><li><code>echo ydld | nc 127.0.0.1 2181</code> -> should print something like <code>Sent yield leadership request to ...</code></li><li><ul><li>Make sure a different leader was elected by finding your new leader</li></ul></li></ol></li><li>Finally repeat for the leader pod</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-4b2037cae63d87dd18115b5fa7174451>12 - ZooKeeper Monitoring</h1><div class=lead>ZooKeeper Monitoring</div><h2 id=zookeeper>ZooKeeper</h2><h3 id=scrape-metrics>scrape metrics</h3><ul><li>embedded exporter since version 3.6.0<ul><li><a href=https://zookeeper.apache.org/doc/r3.6.2/zookeeperMonitor.html target=_blank>https://zookeeper.apache.org/doc/r3.6.2/zookeeperMonitor.html</a></li></ul></li><li>standalone exporter<ul><li><a href=https://github.com/dabealu/zookeeper-exporter target=_blank>https://github.com/dabealu/zookeeper-exporter</a></li></ul></li></ul><h3 id=install-dashboards>Install dashboards</h3><ul><li>embedded exporter <a href=https://grafana.com/grafana/dashboards/10465 target=_blank>https://grafana.com/grafana/dashboards/10465</a></li><li>dabealu exporter <a href=https://grafana.com/grafana/dashboards/11442 target=_blank>https://grafana.com/grafana/dashboards/11442</a></li></ul><p>See also <a href="https://grafana.com/grafana/dashboards?search=ZooKeeper&amp;dataSource=prometheus" target=_blank>https://grafana.com/grafana/dashboards?search=ZooKeeper&amp;amp;dataSource=prometheus</a></p><h3 id=setup-alert-rules>setup alert rules</h3><ul><li>embedded exporter <a href=https://github.com/Altinity/clickhouse-operator/blob/master/deploy/prometheus/prometheus-alert-rules-zookeeper.yaml target=_blank>link</a></li></ul><h3 id=see-also>See also</h3><ul><li><a href=https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/#zookeeper-metrics target=_blank>https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/#zookeeper-metrics</a></li><li><a href=https://dzone.com/articles/monitoring-apache-zookeeper-servers target=_blank>https://dzone.com/articles/monitoring-apache-zookeeper-servers</a>
- note exhibitor is no longer maintained</li><li><a href=https://github.com/samber/awesome-prometheus-alerts/blob/c3ba0cf1997c7e952369a090aeb10343cdca4878/_data/rules.yml#L1146-L1170 target=_blank>https://github.com/samber/awesome-prometheus-alerts/blob/c3ba0cf1997c7e952369a090aeb10343cdca4878/_data/rules.yml#L1146-L1170</a>
(or <a href=https://awesome-prometheus-alerts.grep.to/rules.html#zookeeper target=_blank>https://awesome-prometheus-alerts.grep.to/rules.html#zookeeper</a>
)</li><li><a href=https://alex.dzyoba.com/blog/prometheus-alerts/ target=_blank>https://alex.dzyoba.com/blog/prometheus-alerts/</a></li><li><a href="https://docs.datadoghq.com/integrations/zk/?tab=host" target=_blank>https://docs.datadoghq.com/integrations/zk/?tab=host</a></li><li><a href=https://statuslist.app/uptime-monitoring/zookeeper/ target=_blank>https://statuslist.app/uptime-monitoring/zookeeper/</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-caaac474228860d2cc9228c7ba1fb3f9>13 - ZooKeeper schema</h1><div class=lead>ZooKeeper schema</div><h2 id=metadata>/metadata</h2><p>Table schema.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>date column -&gt; legacy MergeTree partition expression.
</span></span><span style=display:flex><span>sampling expression -&gt; SAMPLE BY
</span></span><span style=display:flex><span>index granularity -&gt; index_granularity
</span></span><span style=display:flex><span>mode -&gt; <span style=color:#204a87>type</span> of MergeTree table
</span></span><span style=display:flex><span>sign column -&gt; sign - CollapsingMergeTree / VersionedCollapsingMergeTree
</span></span><span style=display:flex><span>primary key -&gt; ORDER BY key <span style=color:#204a87;font-weight:700>if</span> PRIMARY KEY not defined.
</span></span><span style=display:flex><span>sorting key -&gt; ORDER BY key <span style=color:#204a87;font-weight:700>if</span> PRIMARY KEY defined.
</span></span><span style=display:flex><span>data format version -&gt; <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>partition key -&gt; PARTITION BY
</span></span><span style=display:flex><span>granularity bytes -&gt; index_granularity_bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>types of MergeTree tables:
</span></span><span style=display:flex><span><span style=color:#000>Ordinary</span>            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#000>Collapsing</span>          <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#000>Summing</span>             <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span><span style=color:#000>Aggregating</span>         <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span>
</span></span><span style=display:flex><span><span style=color:#000>Replacing</span>           <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span>
</span></span><span style=display:flex><span><span style=color:#000>Graphite</span>            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span>
</span></span><span style=display:flex><span><span style=color:#000>VersionedCollapsing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7</span>
</span></span></code></pre></div><h2 id=mutations>/mutations</h2><p>Log of latest mutations</p><h2 id=columns>/columns</h2><p>List of columns for latest (reference) table version. Replicas would try to reach this state.</p><h2 id=log>/log</h2><p>Log of latest actions with table.</p><p>Related settings:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>┌─</span><span style=color:#000>name</span><span style=color:#a40000>────────────────────────┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>changed</span><span style=color:#a40000>─┬─</span><span style=color:#000>description</span><span style=color:#a40000>────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#a40000>───┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_replicated_logs_to_keep</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>How</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>many</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>records</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>may</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>be</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>log</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>there</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>is</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inactive</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Inactive</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>replica</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>becomes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lost</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>when</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>when</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>this</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>exceed</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>                                                  </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>min_replicated_logs_to_keep</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Keep</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>about</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>this</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>last</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>records</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ZooKeeper</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>log</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>even</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>they</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>are</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>obsolete</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>It</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>doesn</span><span style=color:#4e9a06>&#39;t affect work of tables: used only to diagnose ZooKeeper log before cleaning. │ UInt64 │
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>└─────────────────────────────┴───────┴─────────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴────────┘
</span></span></span></code></pre></div><h2 id=replicas>/replicas</h2><p>List of table replicas.</p><h2 id=replicasreplica_name>/replicas/replica_name/</h2><h3 id=replicasreplica_namemutation_pointer>/replicas/replica_name/mutation_pointer</h3><p>Pointer to the latest mutation executed by replica</p><h3 id=replicasreplica_namelog_pointer>/replicas/replica_name/log_pointer</h3><p>Pointer to the latest task from replication_queue executed by replica</p><h3 id=replicasreplica_namemax_processed_insert_time>/replicas/replica_name/max_processed_insert_time</h3><h3 id=replicareplica_namemetadata>/replica/replica_name/metadata</h3><p>Table schema of specific replica</p><h3 id=replicareplica_namecolumns>/replica/replica_name/columns</h3><p>Columns list of specific replica.</p><h2 id=quorum>/quorum</h2><p>Used for quorum inserts.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class="row footer-inner pb-3"><div class=col-12><a href=https://altinity.com target=_blank><img src=/images/general/altinity-logo_horizontal_blue_white.svg width=154 alt=Altinity.com></a></div></div><div class="row footer-inner py-3"><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>PRODUCT</b></li><li class=nav-item><a href=https://altinity.com/managed-clickhouse/ target=_blank>Altinity.Cloud</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-support/ target=_blank>Support for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-training target=_blank>Training for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-pricing/ target=_blank>Altinity.Cloud Pricing</a></li><li class=nav-item><a href=https://altinity.com/plans-and-features-clickhouse/ target=_blank>Altinity Plans and Features</a></li></ul><div class="d-none d-md-block mb-3"><img decoding=async style="width:60px;display:inline-block;margin:0 10px 0 0" src=/images/general/soc.webp alt="SOC Certified"><img decoding=async style=width:60px;display:inline-block;margin:0 src=/images/general/soc2.webp alt="SOC2 TYPE II Certified"></div></div><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>RESOURCES</b></li><li class=nav-item><a href=https://altinity.com/blog target=_blank>Blog</a></li><li class=nav-item><a href=https://docs.altinity.com/ target=_blank>Documentation</a></li><li class=nav-item><a href=https://kb.altinity.com/ target=_blank>Knowledge Base</a></li><li class=nav-item><a href=https://altinity.com/releases target=_blank>Altinity Stable Builds</a></li><li class=nav-item><a href=https://hubs.la/Q02pLTV20 target=_blank>Kubernetes Operator</a></li><li class=nav-item><a href=https://altinity.com/ecosystem/ target=_blank>Altinity Open Source Projects</a></li><li class=nav-item><a href=https://altinity.com/events/ target=_blank>Events</a></li></ul></div><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>COMPANY</b></li><li class=nav-item><a href=https://altinity.com/about-us/ target=_blank>About Altinity</a></li><li class=nav-item><a href=https://altinity.com/about-us/press-releases target=_blank>Press Releases</a></li><li class=nav-item><a href=https://altinity.com/partners/ target=_blank>Partners</a></li><li class=nav-item><a href=https://altinity.com/customer-stories/ target=_blank>Customer Stories</a></li><li class=nav-item><a href=https://altinity.com/careers/ target=_blank>Careers</a></li><li class=nav-item><a href=https://altinity.com/contact/ target=_blank>Contact Us</a></li></ul></div><div class="col-12 col-sm-6 col-md-3">Get the latest ClickHouse news straight to your inbox every month.<br><a href=https://altinity.com/newsletter/ target=_blank class="btn btn-primary my-3" style=border-radius:1.5rem>Sign Up</a></div></div></div><div class="row footer-inner pb-3"><div class="col-12 col-sm-6 text-left text-xs-center py-2"><small class=text-white>&copy; 2025 Altinity Inc. Altinity®, Altinity.Cloud®, and Altinity Stable® are registered trademarks of Altinity, Inc. ClickHouse® is a registered trademark of ClickHouse, Inc.; Altinity is not affiliated with or associated with ClickHouse, Inc. Kafka, Kubernetes, MySQL, and PostgreSQL are trademarks and property of their respective owners. All Rights Reserved</small>
<small class=ml-1><a href=https://altinity.com/privacy-policy/ target=_blank>Privacy Policy</a></small></div><div class="col-12 col-sm-6 text-end text-xs-center"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://altinity.com/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=X aria-label=X><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/AltinityDB><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/company/altinity/><i class="fab fa-linkedin"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.youtube.com/channel/UCE3Y2lDKl_ZfjaCrh62onYA><i class="fab fa-youtube"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/Altinity/altinityknowledgebase><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Reddit aria-label=Reddit><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.reddit.com/r/Clickhouse/><i class="fab fa-reddit"></i></a></li></ul></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-101676615-2"></script><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/4536206.js></script><script type=text/javascript>!function(){var e,t="06536e793668baa",n=function(){Reo.init({clientID:"06536e793668baa"})};(e=document.createElement("script")).src="https://static.reo.dev/"+t+"/reo.js",e.defer=!0,e.onload=n,document.head.appendChild(e)}()</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-101676615-2")</script></footer><script type=text/javascript>_linkedin_partner_id="1601132",window._linkedin_data_partner_ids=window._linkedin_data_partner_ids||[],window._linkedin_data_partner_ids.push(_linkedin_partner_id)</script><script type=text/javascript>(function(e){e||(window.lintrk=function(e,t){window.lintrk.q.push([e,t])},window.lintrk.q=[]);var n=document.getElementsByTagName("script")[0],t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://snap.licdn.com/li.lms-analytics/insight.min.js",n.parentNode.insertBefore(t,n)})(window.lintrk)</script><noscript><img height=1 width=1 style=display:none alt src="https://px.ads.linkedin.com/collect/?pid=1601132&fmt=gif"></noscript></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/tabpane-persist.js></script></body></html>