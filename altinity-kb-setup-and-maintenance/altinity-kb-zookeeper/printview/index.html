<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.96.0" /><link rel="canonical" type="text/html" href="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="icon" href="/favicons/favicon.ico" >
<title>ZooKeeper | Altinity Knowledge Base</title>
<meta name="description" content="Altinity Knowledge Base"><meta property="og:title" content="ZooKeeper" />
<meta property="og:description" content="ZooKeeper
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/" /><meta property="og:site_name" content="Altinity Knowledge Base" />

<meta itemprop="name" content="ZooKeeper">
<meta itemprop="description" content="ZooKeeper
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ZooKeeper"/>
<meta name="twitter:description" content="ZooKeeper
"/>




<link rel="preload" href="/scss/main.min.ec0d259783afc2c6841272db4924ae5f6ab47953b32356793cb392fb1f3c3e5d.css" as="style">
<link href="/scss/main.min.ec0d259783afc2c6841272db4924ae5f6ab47953b32356793cb392fb1f3c3e5d.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css"/>

<meta name="keywords" content="">




  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 97.68 112.95"><defs><linearGradient id="linear-gradient" x1="49.43" y1="564.05" x2="21.19" y2="486.25" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#009cd0"/><stop offset=".16" stop-color="#02a0d4"/><stop offset=".33" stop-color="#08acdf"/><stop offset=".49" stop-color="#12c0f1"/><stop offset=".66" stop-color="#10bced"/><stop offset=".83" stop-color="#0ab0e2"/><stop offset="1" stop-color="#009cd0"/></linearGradient><linearGradient id="linear-gradient-2" x1="0" y1="472.36" x2="48.75" y2="472.36" xlink:href="#linear-gradient"/><linearGradient id="linear-gradient-3" x1=".05" y1="493.62" x2="24.5" y2="493.62" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#fff"/><stop offset=".03" stop-color="#f2f7fb"/><stop offset=".19" stop-color="#b3d2e7"/><stop offset=".34" stop-color="#7cb2d5"/><stop offset=".5" stop-color="#5097c7"/><stop offset=".64" stop-color="#2d83bc"/><stop offset=".78" stop-color="#1474b4"/><stop offset=".9" stop-color="#056bb0"/><stop offset="1" stop-color="#0068ae"/></linearGradient><linearGradient id="linear-gradient-4" x1="73.23" y1="507.9" x2="97.68" y2="507.9" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0068ae"/><stop offset=".12" stop-color="#046aaf"/><stop offset=".25" stop-color="#1072b3"/><stop offset=".38" stop-color="#257eba"/><stop offset=".5" stop-color="#418fc3"/><stop offset=".63" stop-color="#66a4ce"/><stop offset=".76" stop-color="#93bfdd"/><stop offset=".88" stop-color="#c7deed"/><stop offset="1" stop-color="#fff"/></linearGradient><linearGradient id="linear-gradient-5" x1="50.7" y1="522" x2="74.92" y2="522" gradientTransform="matrix(1, 0, 0, -1, 0, 550.11)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0068ae"/><stop offset=".09" stop-color="#096eb1"/><stop offset=".23" stop-color="#237db9"/><stop offset=".41" stop-color="#4d95c6"/><stop offset=".62" stop-color="#86b8d9"/><stop offset=".86" stop-color="#cfe3f0"/><stop offset="1" stop-color="#fff"/></linearGradient></defs><title>logo_1</title><g style="isolation:isolate"><g id="Layer_2" data-name="Layer 2"><g id="Layer_1-2" data-name="Layer 1"><path d="M97.68 56.29h0L73.23 42.21V98.58L97.68 112.7V56.29z" style="fill:#009cd0"/><path d="M73.23 42.21 97.68 56.32V28.09z" style="fill:#009cd0"/><path d="M73.25 42.2 97.68 28.09 73.25 14h0L48.79 28.08 73.23 42.19v0h0z" style="fill:#009cd0"/><path d="M73.34 14.12 48.89.0V0L24.45 14.18h0L.1 28.23h0L0 28.29l.09.05V56.46L24.45 42.4h0 .1.0L49.4 27.94 73.34 14.12z" style="fill:url(#linear-gradient)"/><path d="M48.75 84.87 24.45 70.52v-28L.21 56.53l-.12-.07v.14L0 56.66l.09.05V84.65L0 84.7l.09.06V113L24.3 99v0L48.75 84.87z" style="fill:url(#linear-gradient-2)"/><path d="M.05 56.44 24.5 70.55V42.32z" style="fill:#009cd0"/><path d="M.05 56.49 24.5 70.6V42.37z" style="mix-blend-mode:multiply;fill:url(#linear-gradient-3)"/><path d="M73.23 42.21 97.68 56.32V28.09z" style="mix-blend-mode:multiply;fill:url(#linear-gradient-4)"/><path d="M97.68 28.09 73.23 14v0L48.79 28.13 73.25 42.25v0z" style="mix-blend-mode:multiply;fill:url(#linear-gradient-5)"/></g></g></g></svg></span><span class="text-uppercase font-weight-bold">Altinity Knowledge Base</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.9f88c2900b11dcd5146da70a8cc84431.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">ZooKeeper</h1>
<div class="lead">ZooKeeper</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-05425e768ddcc5be5d1203f59044e6d5">Install standalone Zookeeper for ClickHouse on Ubuntu / Debian</a></li>


    
  
    
    
	
<li>2: <a href="#pg-4c33701373e85b893c3b3464fa4f6683">clickhouse-keeper</a></li>


    
  
    
    
	
<li>3: <a href="#pg-564a3bbd39f9550e577334d912a883dc">How to check the list of watches</a></li>


    
  
    
    
	
<li>4: <a href="#pg-722cb96284be123698aa3e56ea92ecaf">JVM sizes and garbage collector settings</a></li>


    
  
    
    
	
<li>5: <a href="#pg-1ef2081889fb4a086febf3b281e44778">Proper setup</a></li>


    
  
    
    
	
<li>6: <a href="#pg-66b660806f12af38114754857823e52a">Recovering from complete metadata loss in ZooKeeper</a></li>


    
  
    
    
	
<li>7: <a href="#pg-8892167f56e913cb6f2d429fc16315c8">ZooKeeper backup</a></li>


    
  
    
    
	
<li>8: <a href="#pg-f9f14245cdbc89d13e77a5b1b24de46e">ZooKeeper cluster migration</a></li>


    
  
    
    
	
<li>9: <a href="#pg-4b2037cae63d87dd18115b5fa7174451">ZooKeeper Monitoring</a></li>


    
  
    
    
	
<li>10: <a href="#pg-caaac474228860d2cc9228c7ba1fb3f9">ZooKeeper schema</a></li>


    
  

    </ul>


<div class="content">
      <h3 id="requirements">Requirements</h3>
<p>TLDR version:</p>
<ol>
<li>USE DEDICATED FAST DISKS for the transaction log! (crucial for performance due to write-ahead-log, NVMe is preferred for heavy load setup).</li>
<li>use 3 nodes (more nodes = slower quorum, less = no HA).</li>
<li>low network latency between zookeeper nodes is very important (latency, not bandwidth).</li>
<li>have at least 4Gb of RAM, disable swap, <a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/jvm-sizes-and-garbage-collector-settings/" target="_blank">tune JVM sizes, and garbage collector settings</a></li>
<li>ensure that zookeeper will not be CPU-starved by some other processes</li>
<li><a href="https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/zookeeper-monitoring/" target="_blank">monitor zookeeper</a>.</li>
</ol>
<p>Side note:
in many cases, the slowness of the zookeeper is actually a symptom of some issue with clickhouse schema/usage pattern (the most typical issues: an enormous number of partitions/tables/databases with real-time inserts, tiny &amp; frequent inserts).</p>
<h3 id="how-to-install">How to install</h3>
<ul>
<li><a href="https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/" target="_blank">https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/</a></li>
<li><a href="/altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/">altinity-kb-setup-and-maintenance/altinity-kb-zookeeper/install_ubuntu/</a></li>
</ul>
<h3 id="random-links-on-best-practices">Random links on best practices</h3>
<ul>
<li><a href="https://docs.confluent.io/platform/current/zookeeper/deployment.html" target="_blank">https://docs.confluent.io/platform/current/zookeeper/deployment.html</a></li>
<li><a href="https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems" target="_blank">https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems</a></li>
<li><a href="https://clickhouse.tech/docs/en/operations/tips/#zookeeper" target="_blank">https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a></li>
<li><a href="https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html" target="_blank">https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting" target="_blank">https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting</a></li>
</ul>
<p>Cite from <a href="https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems" target="_blank">https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems</a> :</p>
<blockquote>
<h2 id="things-to-avoid">Things to Avoid</h2>
<p>Here are some common problems you can avoid by configuring ZooKeeper correctly:</p>
<ul>
<li><em>inconsistent lists of servers</em> : The list of ZooKeeper servers used by the clients must match the list of ZooKeeper servers that each ZooKeeper server has. Things work okay if the client list is a subset of the real list, but things will really act strange if clients have a list of ZooKeeper servers that are in different ZooKeeper clusters. Also, the server lists in each Zookeeper server configuration file should be consistent with one another.</li>
<li><em>incorrect placement of transaction log</em> : The most performance critical part of ZooKeeper is the transaction log. ZooKeeper syncs transactions to media before it returns a response. A dedicated transaction log device is key to consistent good performance. Putting the log on a busy device will adversely affect performance. If you only have one storage device, increase the snapCount so that snapshot files are generated less often; it does not eliminate the problem, but it makes more resources available for the transaction log.</li>
<li><em>incorrect Java heap size</em> : You should take special care to set your Java max heap size correctly. In particular, you should not create a situation in which ZooKeeper swaps to disk. The disk is death to ZooKeeper. Everything is ordered, so if processing one request swaps the disk, all other queued requests will probably do the same. the disk. DON&rsquo;T SWAP. Be conservative in your estimates: if you have 4G of RAM, do not set the Java max heap size to 6G or even 4G. For example, it is more likely you would use a 3G heap for a 4G machine, as the operating system and the cache also need memory. The best and only recommend practice for estimating the heap size your system needs is to run load tests, and then make sure you are well below the usage limit that would cause the system to swap.</li>
<li><em>Publicly accessible deployment</em> : A ZooKeeper ensemble is expected to operate in a trusted computing environment. It is thus recommended to deploy ZooKeeper behind a firewall.</li>
</ul>
</blockquote>
<h3 id="how-to-check-number-of-followers">How to check number of followers:</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> mntr <span style="color:#000;font-weight:bold">|</span> nc zookeeper <span style="color:#0000cf;font-weight:bold">2187</span> <span style="color:#000;font-weight:bold">|</span> grep foll
</span></span><span style="display:flex;"><span>zk_synced_followers    <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>zk_synced_non_voting_followers    <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>zk_avg_follower_sync_time    0.0
</span></span><span style="display:flex;"><span>zk_min_follower_sync_time    <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>zk_max_follower_sync_time    <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>zk_cnt_follower_sync_time    <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>zk_sum_follower_sync_time    <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><h2 id="tools">Tools</h2>
<p><a href="https://github.com/apache/zookeeper/blob/master/zookeeper-docs/src/main/resources/markdown/zookeeperTools.md" target="_blank">https://github.com/apache/zookeeper/blob/master/zookeeper-docs/src/main/resources/markdown/zookeeperTools.md</a></p>
<h2 id="alternatives-for-zkcli">Alternatives for zkCli</h2>
<ul>
<li><a href="https://github.com/go-zkcli/zkcli" target="_blank">https://github.com/go-zkcli/zkcli</a></li>
<li><a href="https://github.com/outbrain/zookeepercli" target="_blank">https://github.com/outbrain/zookeepercli</a></li>
<li><a href="https://idata.co.il/2018/07/a-day-at-the-zoo-graphic-uis-for-apache-zookeeper/" target="_blank">https://idata.co.il/2018/07/a-day-at-the-zoo-graphic-uis-for-apache-zookeeper/</a></li>
</ul>
<h2 id="web-ui">Web UI</h2>
<ul>
<li><a href="https://github.com/elkozmon/zoonavigator-api" target="_blank">https://github.com/elkozmon/zoonavigator-api</a></li>
<li><a href="https://github.com/tobilg/docker-zookeeper-webui" target="_blank">https://github.com/tobilg/docker-zookeeper-webui</a></li>
<li><a href="https://github.com/vran-dev/PrettyZoo" target="_blank">https://github.com/vran-dev/PrettyZoo</a></li>
</ul>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-05425e768ddcc5be5d1203f59044e6d5">1 - Install standalone Zookeeper for ClickHouse on Ubuntu / Debian</h1>
    <div class="lead">Install standalone Zookeeper for ClickHouse on Ubuntu / Debian.</div>
	<h2 id="reference-script-to-install-standalone-zookeeper-for-ubuntu--debian">Reference script to install standalone Zookeeper for Ubuntu / Debian</h2>
<p>Tested on Ubuntu 20.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install java runtime environment</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt install default-jre
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># prepare folders, logs folder should be on the low-latency disk.</span>
</span></span><span style="display:flex;"><span>sudo mkdir -p /var/lib/zookeeper/data /var/lib/zookeeper/logs /etc/zookeeper /var/log/zookeeper /opt 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># download and install files </span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span>3.6.3
</span></span><span style="display:flex;"><span>wget https://dlcdn.apache.org/zookeeper/zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin.tar.gz -O /tmp/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin.tar.gz
</span></span><span style="display:flex;"><span>sudo tar -xvf /tmp/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin.tar.gz -C /opt
</span></span><span style="display:flex;"><span>rm -rf /tmp/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># create the user </span>
</span></span><span style="display:flex;"><span>sudo groupadd -r zookeeper
</span></span><span style="display:flex;"><span>sudo useradd -r -g zookeeper --home-dir<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/zookeeper --shell<span style="color:#ce5c00;font-weight:bold">=</span>/bin/false zookeeper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># symlink pointing to the used version of zookeeper distibution</span>
</span></span><span style="display:flex;"><span>sudo ln -s /opt/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin /opt/zookeeper 
</span></span><span style="display:flex;"><span>sudo chown -R zookeeper:zookeeper /var/lib/zookeeper /var/log/zookeeper /etc/zookeeper /opt/apache-zookeeper-<span style="color:#4e9a06">${</span><span style="color:#000">ZOOKEEPER_VERSION</span><span style="color:#4e9a06">}</span>-bin
</span></span><span style="display:flex;"><span>sudo chown -h zookeeper:zookeeper /opt/zookeeper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># shortcuts in /usr/local/bin/</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkCli.sh &#34;$@&#34;&#39;</span>             <span style="color:#000;font-weight:bold">|</span> sudo tee /usr/local/bin/zkCli
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkServer.sh &#34;$@&#34;&#39;</span>          <span style="color:#000;font-weight:bold">|</span> sudo tee /usr/local/bin/zkServer
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkCleanup.sh &#34;$@&#34;&#39;</span>         <span style="color:#000;font-weight:bold">|</span> sudo tee /usr/local/bin/zkCleanup
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkSnapShotToolkit.sh &#34;$@&#34;&#39;</span> <span style="color:#000;font-weight:bold">|</span> sudo tee /usr/local/bin/zkSnapShotToolkit
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#39;#!/usr/bin/env bash\n/opt/zookeeper/bin/zkTxnLogToolkit.sh &#34;$@&#34;&#39;</span>   <span style="color:#000;font-weight:bold">|</span> sudo tee /usr/local/bin/zkTxnLogToolkit
</span></span><span style="display:flex;"><span>sudo chmod +x /usr/local/bin/zkCli /usr/local/bin/zkServer /usr/local/bin/zkCleanup /usr/local/bin/zkSnapShotToolkit /usr/local/bin/zkTxnLogToolkit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># put in the config</span>
</span></span><span style="display:flex;"><span>sudo cp opt/zookeeper/conf/* /etc/zookeeper
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt;EOF | sudo tee /etc/zookeeper/zoo.cfg
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">initLimit=20
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">syncLimit=10
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">maxSessionTimeout=60000000
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">maxClientCnxns=2000
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">preAllocSize=131072
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">snapCount=3000000
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">dataDir=/var/lib/zookeeper/data
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">dataLogDir=/var/lib/zookeeper/logs # use low-latency disk!
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">clientPort=2181
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">#clientPortAddress=nthk-zoo1.localdomain
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">autopurge.snapRetainCount=10
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">autopurge.purgeInterval=1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">4lw.commands.whitelist=*
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>sudo chown -R zookeeper:zookeeper /etc/zookeeper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># create systemd service file</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt;EOF | sudo tee /etc/systemd/system/zookeeper.service
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Description=Zookeeper Daemon
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Documentation=http://zookeeper.apache.org
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Requires=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Type=forking
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">WorkingDirectory=/var/lib/zookeeper
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">User=zookeeper
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Group=zookeeper
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=ZK_SERVER_HEAP=1536 # in megabytes, adjust to ~ 80-90% of avaliable RAM (more than 8Gb is rather overkill)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=SERVER_JVMFLAGS=&#34;-Xms256m -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=ZOO_LOG_DIR=/var/log/zookeeper
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=/opt/zookeeper/bin/zkServer.sh start /etc/zookeeper/zoo.cfg
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStop=/opt/zookeeper/bin/zkServer.sh stop /etc/zookeeper/zoo.cfg
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecReload=/opt/zookeeper/bin/zkServer.sh restart /etc/zookeeper/zoo.cfg
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">TimeoutSec=30
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">WantedBy=default.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># start zookeeper</span>
</span></span><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl start zookeeper.service 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># check status etc.</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> stat <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">2181</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> ruok <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">2181</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> mntr <span style="color:#000;font-weight:bold">|</span> nc localhost <span style="color:#0000cf;font-weight:bold">2181</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4c33701373e85b893c3b3464fa4f6683">2 - clickhouse-keeper</h1>
    <div class="lead">clickhouse-keeper</div>
	<p>In 21.3 there is already an option to run own clickhouse zookeeper implementation. It&rsquo;s still experimental, and still need to be started additionally on few nodes (similar to &rsquo;normal&rsquo; zookeeper) and speaks normal zookeeper protocol - needed to simplify A/B tests with real zookeeper.</p>
<p>No docs, for now, only PR with code &amp; tests. Of course, if you want to play with it - you can, and early feedback is very valuable. But be prepared for a lot of tiny issues here and there, so don&rsquo;t be disappointed if it will not satisfy your expectations for some reason. It&rsquo;s very-very fresh :slightly_smiling_face: It&rsquo;s ready for some trial runs, but not ready yet for production use cases.</p>
<p>To test that you need to run 3 instances of clickhouse-server (which will mimic zookeeper) with an extra config like that:</p>
<p><a href="https://github.com/ClickHouse/ClickHouse/blob/c8b1004ecb4bfc4aa581dbcbbbe3a4c72ce57123/tests/integration/test_keeper_multinode_simple/configs/enable_keeper1.xml" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/c8b1004ecb4bfc4aa581dbcbbbe3a4c72ce57123/tests/integration/test_keeper_multinode_simple/configs/enable_keeper1.xml</a></p>
<p><a href="https://github.com/ClickHouse/ClickHouse/blob/c8b1004ecb4bfc4aa581dbcbbbe3a4c72ce57123/tests/integration/test_keeper_snapshots/configs/enable_keeper.xml" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/c8b1004ecb4bfc4aa581dbcbbbe3a4c72ce57123/tests/integration/test_keeper_snapshots/configs/enable_keeper.xml</a></p>
<p>or event single instance with config like that: <a href="https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/keeper_port.xml" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/keeper_port.xml</a>
<a href="https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/zookeeper.xml" target="_blank">https://github.com/ClickHouse/ClickHouse/blob/master/tests/config/config.d/zookeeper.xml</a></p>
<p>And point all the clickhouses (zookeeper config secton) to those nodes / ports.</p>
<p>Latest testing version is recommended. We will be thankful for any feedback.</p>
<h2 id="example-of-a-simple-cluster-with-2-nodes-of-clickhouse-using-built-in-keeper">Example of a simple cluster with 2 nodes of Clickhouse using built-in keeper</h2>
<p>For example you can start two Clikhouse nodes (hostname1, hostname2)</p>
<h3 id="hostname1">hostname1</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>$ cat /etc/clickhouse-server/config.d/keeper.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;keeper_server&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;tcp_port&gt;</span>2181<span style="color:#204a87;font-weight:bold">&lt;/tcp_port&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;server_id&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/server_id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;log_storage_path&gt;</span>/var/lib/clickhouse/coordination/log<span style="color:#204a87;font-weight:bold">&lt;/log_storage_path&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;snapshot_storage_path&gt;</span>/var/lib/clickhouse/coordination/snapshots<span style="color:#204a87;font-weight:bold">&lt;/snapshot_storage_path&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;coordination_settings&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;operation_timeout_ms&gt;</span>10000<span style="color:#204a87;font-weight:bold">&lt;/operation_timeout_ms&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;session_timeout_ms&gt;</span>30000<span style="color:#204a87;font-weight:bold">&lt;/session_timeout_ms&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;raft_logs_level&gt;</span>trace<span style="color:#204a87;font-weight:bold">&lt;/raft_logs_level&gt;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&lt;rotate_log_storage_interval&gt;</span>10000<span style="color:#204a87;font-weight:bold">&lt;/rotate_log_storage_interval&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/coordination_settings&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;raft_configuration&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;server&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;id&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#204a87;font-weight:bold">&lt;hostname&gt;</span>hostname1<span style="color:#204a87;font-weight:bold">&lt;/hostname&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9444<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;/server&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;server&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;id&gt;</span>2<span style="color:#204a87;font-weight:bold">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#204a87;font-weight:bold">&lt;hostname&gt;</span>hostname2<span style="color:#204a87;font-weight:bold">&lt;/hostname&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9444<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;/server&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;/raft_configuration&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/keeper_server&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;zookeeper&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;node&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>localhost<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>2181<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/node&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/zookeeper&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;distributed_ddl&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;path&gt;</span>/clickhouse/testcluster/task_queue/ddl<span style="color:#204a87;font-weight:bold">&lt;/path&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/distributed_ddl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat /etc/clickhouse-server/config.d/macros.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;macros&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;cluster&gt;</span>testcluster<span style="color:#204a87;font-weight:bold">&lt;/cluster&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>replica1<span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;shard&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/shard&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/macros&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><h3 id="hostname2">hostname2</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>$ cat /etc/clickhouse-server/config.d/keeper.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;keeper_server&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;tcp_port&gt;</span>2181<span style="color:#204a87;font-weight:bold">&lt;/tcp_port&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;server_id&gt;</span>2<span style="color:#204a87;font-weight:bold">&lt;/server_id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;log_storage_path&gt;</span>/var/lib/clickhouse/coordination/log<span style="color:#204a87;font-weight:bold">&lt;/log_storage_path&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;snapshot_storage_path&gt;</span>/var/lib/clickhouse/coordination/snapshots<span style="color:#204a87;font-weight:bold">&lt;/snapshot_storage_path&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;coordination_settings&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;operation_timeout_ms&gt;</span>10000<span style="color:#204a87;font-weight:bold">&lt;/operation_timeout_ms&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;session_timeout_ms&gt;</span>30000<span style="color:#204a87;font-weight:bold">&lt;/session_timeout_ms&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;raft_logs_level&gt;</span>trace<span style="color:#204a87;font-weight:bold">&lt;/raft_logs_level&gt;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&lt;rotate_log_storage_interval&gt;</span>10000<span style="color:#204a87;font-weight:bold">&lt;/rotate_log_storage_interval&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/coordination_settings&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;raft_configuration&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;server&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;id&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#204a87;font-weight:bold">&lt;hostname&gt;</span>hostname1<span style="color:#204a87;font-weight:bold">&lt;/hostname&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9444<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;/server&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;server&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;id&gt;</span>2<span style="color:#204a87;font-weight:bold">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#204a87;font-weight:bold">&lt;hostname&gt;</span>hostname2<span style="color:#204a87;font-weight:bold">&lt;/hostname&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9444<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;/server&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;/raft_configuration&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/keeper_server&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;zookeeper&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;node&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>localhost<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>2181<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/node&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/zookeeper&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;distributed_ddl&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;path&gt;</span>/clickhouse/testcluster/task_queue/ddl<span style="color:#204a87;font-weight:bold">&lt;/path&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/distributed_ddl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat /etc/clickhouse-server/config.d/macros.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;macros&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;cluster&gt;</span>testcluster<span style="color:#204a87;font-weight:bold">&lt;/cluster&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>replica2<span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;shard&gt;</span>1<span style="color:#204a87;font-weight:bold">&lt;/shard&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/macros&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><h3 id="on-both">on both</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>$ cat /etc/clickhouse-server/config.d/clusters.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;yandex&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;remote_servers&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;testcluster&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;shard&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>hostname1<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9000<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;replica&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;host&gt;</span>hostname2<span style="color:#204a87;font-weight:bold">&lt;/host&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&lt;port&gt;</span>9000<span style="color:#204a87;font-weight:bold">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&lt;/replica&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;/shard&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/testcluster&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/remote_servers&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/yandex&gt;</span>
</span></span></code></pre></div><p>Then create a table</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{cluster}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">S</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Engine</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{database}/{table}&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">Order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">A</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100000000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- on both nodes:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-564a3bbd39f9550e577334d912a883dc">3 - How to check the list of watches</h1>
    <div class="lead">How to check the list of watches</div>
	<p>Zookeeper use watches to notify a client on znode changes. This article explains how to check watches set by ZooKeeper servers and how it is used.</p>
<p><strong>Solution:</strong></p>
<p>Zookeeper uses the <code>'wchc'</code> command to list all watches set on the Zookeeper server.</p>
<p><code># echo wchc | nc zookeeper 2181</code></p>
<p>Reference</p>
<p><a href="https://zookeeper.apache.org/doc/r3.4.12/zookeeperAdmin.html" target="_blank">https://zookeeper.apache.org/doc/r3.4.12/zookeeperAdmin.html</a></p>
<p>The <code>wchp</code> and <code>wchc</code> commands are not enabled by default because of their known DOS vulnerability. For more information, see <a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2693" target="_blank">ZOOKEEPER-2693</a>and <a href="https://vulners.com/exploitdb/EDB-ID:41277" target="_blank">Zookeeper 3.5.2 - Denial of Service</a>.</p>
<p>By default those commands are disabled, they can be enabled via Java system property:</p>
<p><code>-Dzookeeper.4lw.commands.whitelist=*</code></p>
<p>on in zookeeper config: <code>4lw.commands.whitelist=*</code>\</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-722cb96284be123698aa3e56ea92ecaf">4 - JVM sizes and garbage collector settings</h1>
    <div class="lead">JVM sizes and garbage collector settings</div>
	<h2 id="tldr-version">TLDR version</h2>
<p>use fresh Java version (11 or newer), disable swap and set up (for 4 Gb node):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">JAVA_OPTS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-Xms512m -Xmx3G -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;</span>
</span></span></code></pre></div><p>If you have a node with more RAM - change it accordingly, for example for 8Gb node:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">JAVA_OPTS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-Xms512m -Xmx7G -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&#34;</span>
</span></span></code></pre></div><h2 id="details">Details</h2>
<ol>
<li>
<p>ZooKeeper runs as in JVM. Depending on version different garbage collectors are available.</p>
</li>
<li>
<p>Recent JVM versions (starting from 10) use <code>G1</code> garbage collector by default (should work fine).
On JVM 13-14 using <code>ZGC</code> or <code>Shenandoah</code> garbage collector may reduce pauses.
On older JVM version (before 10) you may want to make some tuning to decrease pauses, ParNew + CMS garbage collectors (like in Yandex config) is one of the best options.</p>
</li>
<li>
<p>One of the most important setting for JVM application is heap size. A heap size of &gt;1 GB is recommended for most use cases and monitoring heap usage to ensure no delays are caused by garbage collection. We recommend to use at least 4Gb of RAM for zookeeper nodes (8Gb is better, that will make difference only when zookeeper is heavily loaded).</p>
</li>
</ol>
<p>Set the Java heap size smaller than available RAM size on the node. This is very important to avoid swapping, which will seriously degrade ZooKeeper performance. Be conservative - use a maximum heap size of 3GB for a 4GB machine.</p>
<ol>
<li>
<p>Add <code>XX:+AlwaysPreTouch</code> flag as well to load the memory pages into memory at the start of the zookeeper.</p>
</li>
<li>
<p>Set min (<code>Xms</code>) heap size to the values like 512Mb, or even to the same value as max (<code>Xmx</code>) to avoid resizing and returning the RAM to OS. Add <code>XX:+AlwaysPreTouch</code> flag as well to load the memory pages into memory at the start of the zookeeper.</p>
</li>
<li>
<p><code>MaxGCPauseMillis=50</code> (by default 200) - the &rsquo;target&rsquo; acceptable pause for garbage collection (milliseconds)</p>
</li>
<li>
<p><code>jute.maxbuffer</code> limits the maximum size of znode content. By default it&rsquo;s 1Mb. In some usecases (lot of partitions in table) ClickHouse may need to create bigger znodes.</p>
</li>
<li>
<p>(optional) enable GC logs: <code>-Xloggc:/path_to/gc.log</code></p>
</li>
</ol>
<h2 id="zookeeper-configurarion-used-by-yandex-metrika-from-2017">Zookeeper configurarion used by Yandex Metrika (from 2017)</h2>
<p>The configuration used by Yandex ( <a href="https://clickhouse.tech/docs/en/operations/tips/#zookeeper" target="_blank">https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a> ) - they use older JVM version (with <code>UseParNewGC</code> garbage collector), and tune GC logs heavily:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">JAVA_OPTS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-Xms{{ cluster.get(&#39;xms&#39;,&#39;128M&#39;) }} \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -Xmx{{ cluster.get(&#39;xmx&#39;,&#39;1G&#39;) }} \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -Xloggc:/var/log/</span><span style="color:#000">$NAME</span><span style="color:#4e9a06">/zookeeper-gc.log \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+UseGCLogFileRotation \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:NumberOfGCLogFiles=16 \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:GCLogFileSize=16M \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -verbose:gc \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintGCTimeStamps \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintGCDateStamps \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintGCDetails
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintTenuringDistribution \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintGCApplicationStoppedTime \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintGCApplicationConcurrentTime \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+PrintSafepointStatistics \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+UseParNewGC \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+UseConcMarkSweepGC \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -XX:+CMSParallelRemarkEnabled&#34;</span>
</span></span></code></pre></div><h2 id="see-also">See also</h2>
<ul>
<li><a href="https://wikitech.wikimedia.org/wiki/JVM_Tuning#G1_for_full_gcs" target="_blank">https://wikitech.wikimedia.org/wiki/JVM_Tuning#G1_for_full_gcs</a></li>
<li><a href="https://sematext.com/blog/java-garbage-collection-tuning/" target="_blank">https://sematext.com/blog/java-garbage-collection-tuning/</a></li>
<li><a href="https://www.oracle.com/technical-resources/articles/java/g1gc.html" target="_blank">https://www.oracle.com/technical-resources/articles/java/g1gc.html</a></li>
<li><a href="https://docs.oracle.com/cd/E40972_01/doc.70/e40973/cnf_jvmgc.htm#autoId2" target="_blank">https://docs.oracle.com/cd/E40972_01/doc.70/e40973/cnf_jvmgc.htm#autoId2</a></li>
<li><a href="https://docs.cloudera.com/runtime/7.2.7/kafka-performance-tuning/topics/kafka-tune-broker-tuning-jvm.html" target="_blank">https://docs.cloudera.com/runtime/7.2.7/kafka-performance-tuning/topics/kafka-tune-broker-tuning-jvm.html</a></li>
<li><a href="https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cm-tune-g1gc.html" target="_blank">https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cm-tune-g1gc.html</a></li>
<li><a href="https://blog.sokolenko.me/2014/11/javavm-options-production.html" target="_blank">https://blog.sokolenko.me/2014/11/javavm-options-production.html</a></li>
<li><a href="https://www.maknesium.de/21-most-important-java-8-vm-options-for-servers" target="_blank">https://www.maknesium.de/21-most-important-java-8-vm-options-for-servers</a></li>
<li><a href="https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304" target="_blank">https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304</a></li>
<li><a href="https://github.com/chewiebug/GCViewer" target="_blank">https://github.com/chewiebug/GCViewer</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1ef2081889fb4a086febf3b281e44778">5 - Proper setup</h1>
    <div class="lead">Proper setup</div>
	<h3 id="main-docs-article">Main docs article</h3>
<p><a href="https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/" target="_blank">https://docs.altinity.com/operationsguide/clickhouse-zookeeper/zookeeper-installation/</a></p>
<h3 id="hardware-requirements">Hardware requirements</h3>
<p>TLDR version:</p>
<ol>
<li>USE DEDICATED FAST DISKS for the transaction log! (crucial for performance due to write-ahead-log, NVMe is preferred for heavy load setup).</li>
<li>use 3 nodes (more nodes = slower quorum, less = no HA).</li>
<li>low network latency between zookeeper nodes is very important (latency, not bandwidth).</li>
<li>have at least 4Gb of RAM, disable swap, tune JVM sizes, and garbage collector settings.</li>
<li>ensure that zookeeper will not be CPU-starved by some other processes</li>
<li>monitor zookeeper.</li>
</ol>
<p>Side note:
in many cases, the slowness of the zookeeper is actually a symptom of some issue with clickhouse schema/usage pattern (the most typical issues: an enormous number of partitions/tables/databases with real-time inserts, tiny &amp; frequent inserts).</p>
<p>Some doc about that subject:</p>
<ul>
<li><a href="https://docs.confluent.io/platform/current/zookeeper/deployment.html" target="_blank">https://docs.confluent.io/platform/current/zookeeper/deployment.html</a></li>
<li><a href="https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems" target="_blank">https://zookeeper.apache.org/doc/r3.4.9/zookeeperAdmin.html#sc_commonProblems</a></li>
<li><a href="https://clickhouse.tech/docs/en/operations/tips/#zookeeper" target="_blank">https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a></li>
<li><a href="https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html" target="_blank">https://lucene.apache.org/solr/guide/7_4/setting-up-an-external-zookeeper-ensemble.html</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting" target="_blank">https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting</a></li>
</ul>
<p>Cite from <a href="https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems" target="_blank">https://zookeeper.apache.org/doc/r3.5.7/zookeeperAdmin.html#sc_commonProblems</a> :</p>
<blockquote>
<h2 id="things-to-avoid">Things to Avoid</h2>
<p>Here are some common problems you can avoid by configuring ZooKeeper correctly:</p>
<ul>
<li><em>inconsistent lists of servers</em> : The list of ZooKeeper servers used by the clients must match the list of ZooKeeper servers that each ZooKeeper server has. Things work okay if the client list is a subset of the real list, but things will really act strange if clients have a list of ZooKeeper servers that are in different ZooKeeper clusters. Also, the server lists in each Zookeeper server configuration file should be consistent with one another.</li>
<li><em>incorrect placement of transaction log</em> : The most performance critical part of ZooKeeper is the transaction log. ZooKeeper syncs transactions to media before it returns a response. A dedicated transaction log device is key to consistent good performance. Putting the log on a busy device will adversely affect performance. If you only have one storage device, increase the snapCount so that snapshot files are generated less often; it does not eliminate the problem, but it makes more resources available for the transaction log.</li>
<li><em>incorrect Java heap size</em> : You should take special care to set your Java max heap size correctly. In particular, you should not create a situation in which ZooKeeper swaps to disk. The disk is death to ZooKeeper. Everything is ordered, so if processing one request swaps the disk, all other queued requests will probably do the same. the disk. DON&rsquo;T SWAP. Be conservative in your estimates: if you have 4G of RAM, do not set the Java max heap size to 6G or even 4G. For example, it is more likely you would use a 3G heap for a 4G machine, as the operating system and the cache also need memory. The best and only recommend practice for estimating the heap size your system needs is to run load tests, and then make sure you are well below the usage limit that would cause the system to swap.</li>
<li><em>Publicly accessible deployment</em> : A ZooKeeper ensemble is expected to operate in a trusted computing environment. It is thus recommended to deploy ZooKeeper behind a firewall.</li>
</ul>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-66b660806f12af38114754857823e52a">6 - Recovering from complete metadata loss in ZooKeeper</h1>
    <div class="lead">Recovering from complete metadata loss in ZooKeeper</div>
	<h2 id="problem">Problem</h2>
<p>Every ClickHouse user experienced a loss of ZooKeeper one day. While the data is available and replicas respond to queries, inserts are no longer possible. ClickHouse uses ZooKeeper in order to store the reference version of the table structure and part of data, and when it is not available can not guarantee data consistency anymore. Replicated tables turn to the read-only mode. In this article we describe step-by-step instructions of how to restore ZooKeeper metadata and bring ClickHouse cluster back to normal operation.</p>
<p>In order to restore ZooKeeper we have to solve two tasks. First, we need to restore table metadata in ZooKeeper. Currently, the only way to do it is to recreate the table with the <code>CREATE TABLE DDL</code> statement.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENGINE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;zookeeper_path&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;replica_name&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The second and more difficult task is to populate zookeeper with information of clickhouse data parts. As mentioned above, ClickHouse stores the reference data about all parts of replicated tables in ZooKeeper, so we have to traverse all partitions and re-attach them to the recovered replicated table in order to fix that.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    Starting from ClickHouse version 21.7 there is SYSTEM RESTORE REPLICA command

</div>

<p><a href="https://altinity.com/blog/a-new-way-to-restore-clickhouse-after-zookeeper-metadata-is-lost" target="_blank">https://altinity.com/blog/a-new-way-to-restore-clickhouse-after-zookeeper-metadata-is-lost</a></p>
<h2 id="test-case">Test case</h2>
<p>Let&rsquo;s say we have replicated table <code>table_repl</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87">number</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intDiv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And populate it with some data</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zookeeper</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;/clickhouse/cluster_1/tables/01/&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">partition</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">system</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;table_repl&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">partition</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Now let’s remove metadata in zookeeper using <code>ZkCli.sh</code> at ZooKeeper host:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>deleteall  /clickhouse/cluster_1/tables/01/table_repl
</span></span></code></pre></div><p>And try to resync clickhouse replica state with zookeeper:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SYSTEM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RESTART</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>If we try to insert some data in the table, error happens:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And now we have an exception that we lost all metadata in zookeeper. It is time to recover!</p>
<h2 id="current-solution">Current Solution</h2>
<ol>
<li>
<p>Detach replicated table.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">DETACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Save the table’s attach script and change engine of replicated table to non-replicated *mergetree analogue. Table definition is located in the ‘metadata’ folder, ‘<code>/var/lib/clickhouse/metadata/default/table_repl.sql</code>’ in our example. Please make a backup copy and modify the file as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87">number</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intDiv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_granularity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Needs to be replaced with this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87">number</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MergeTree</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intDiv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_granularity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Attach non-replicated table.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Rename non-replicated table.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl_old</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Create a new replicated table. Take the saved attach script and replace ATTACH with CREATE, and run it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87">number</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ENGINE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicatedMergeTree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/clickhouse/{cluster}/tables/{shard}/table_repl&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{replica}&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intDiv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SETTINGS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_granularity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Attach parts from old table to new.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl_old</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ATTACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARTITION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_repl_old</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ol>
<p>If the table has many partitions, it may require some shell script to make it easier.</p>
<h3 id="automated-approach">Automated approach</h3>
<p>For a large number of tables, you can use script  <a href="https://github.com/Altinity/clickhouse-zookeeper-recovery" target="_blank">https://github.com/Altinity/clickhouse-zookeeper-recovery</a> which partially automates the above approach.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8892167f56e913cb6f2d429fc16315c8">7 - ZooKeeper backup</h1>
    <div class="lead">ZooKeeper backup</div>
	<p>You may have a question: “Do I need to backup Zookeeper Database, because it’s pretty important for ClickHouse?”</p>
<p>Answer: <em>ZK is in memory database. All nodes of ZK has exactly the same data.</em></p>
<p><em>If you have 3 ZK servers, then you have 3 copies of (3 backups) already.</em></p>
<p><em>To backup ZK has no sense because you need to have a snapshot of ZK + last ZK logs to exactly the last ZK transaction.</em></p>
<p><em>You cannot use ZK database backed up 3 hours ago or 3 minutes ago.</em></p>
<p><em>ZK restored from the backup will be inconsistent with CH database.</em></p>
<p><em>Answer2: Usually, it doesn&rsquo;t have too much sense. It&rsquo;s very hard to take zookeeper snapshot at exactly the same state as clickhouse. (well maybe if you will turn of clickhouses, then you can take snapshots of clickhouse AND zookeepers). So for example on clouds if you can stop all nodes and take disk snapshots - it will just work.</em></p>
<p><em>But while clickhouse is working it&rsquo;s almost impossible to collect the current state of zookeeper.</em></p>
<p><em>You need to restore zookeeper and clickhouse snapshots from EXACTLY THE SAME moment of time - no procedure is needed. Just start &amp; run.</em></p>
<p><em>Also, that allows only to snapshot of clickhouse &amp; zookeeper as a whole. You can not do partial backups then.</em></p>
<p><em>If you lose zookeeper data while having clickhouse data (or backups of clickhouse data) - you can restore the zookeeper state from clickhouse state.</em></p>
<p><em>With a couple of tables, it can be done manually.</em></p>
<p><em>On scale, you can use</em> <a href="https://github.com/Altinity/clickhouse-zookeeper-recovery" target="_blank">https://github.com/Altinity/clickhouse-zookeeper-recovery</a></p>
<p><em>In future it will be even simpler</em> <a href="https://github.com/ClickHouse/ClickHouse/pull/13652" target="_blank">https://github.com/ClickHouse/ClickHouse/pull/13652</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f9f14245cdbc89d13e77a5b1b24de46e">8 - ZooKeeper cluster migration</h1>
    <div class="lead">ZooKeeper cluster migration</div>
	<p>Here is a plan for ZK 3.4.9 (no dynamic reconfiguration):</p>
<ol>
<li>Add the 3 new ZK nodes to the old cluster. No changes needed for the 3 old ZK nodes at this time.
<ol>
<li>Configure one of the new ZK nodes as a cluster of 4 nodes (3 old + 1 new), start it.</li>
<li>Configure the other two new ZK nodes as a cluster of 6 nodes (3 old + 3 new), start them.</li>
</ol>
</li>
<li>Make sure the 3 new ZK nodes connected to the old ZK cluster as followers (run <code>echo stat | nc localhost 2181</code> on the 3 new ZK nodes)</li>
<li>Confirm that the leader has 5 synced followers (run <code>echo mntr | nc localhost 2181</code> on the leader, look for <code>zk_synced_followers</code>)</li>
<li>Stop data ingestion in CH (this is to minimize errors when CH loses ZK).</li>
<li>Change the zookeeper section in the configs on the CH nodes (remove the 3 old ZK servers, add the 3 new ZK servers)</li>
<li>Make sure that there are no connections from CH to the 3 old ZK nodes (run <code>echo stat | nc localhost 2181</code> on the 3 old nodes, check their <code>Clients</code> section). Restart all CH nodes if necessary (In some cases CH can reconnect to different ZK servers without a restart).</li>
<li>Remove the 3 old ZK nodes from <code>zoo.cfg</code> on the 3 new ZK nodes.</li>
<li>Restart the 3 new ZK nodes. They should form a cluster of 3 nodes.</li>
<li>When CH reconnects to ZK, start data loading.</li>
<li>Turn off the 3 old ZK nodes.</li>
</ol>
<p>This plan works, but it is not the only way to do this, it can be changed if needed.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4b2037cae63d87dd18115b5fa7174451">9 - ZooKeeper Monitoring</h1>
    <div class="lead">ZooKeeper Monitoring</div>
	<h1 id="zookeeper-monitoring">ZooKeeper Monitoring</h1>
<h2 id="zookeeper">ZooKeeper</h2>
<h3 id="scrape-metrics">scrape metrics</h3>
<ul>
<li>embedded exporter since version 3.6.0
<ul>
<li><a href="https://zookeeper.apache.org/doc/r3.6.2/zookeeperMonitor.html" target="_blank">https://zookeeper.apache.org/doc/r3.6.2/zookeeperMonitor.html</a></li>
</ul>
</li>
<li>standalone exporter
<ul>
<li><a href="https://github.com/dabealu/zookeeper-exporter" target="_blank">https://github.com/dabealu/zookeeper-exporter</a></li>
</ul>
</li>
</ul>
<h3 id="install-dashboards">Install dashboards</h3>
<ul>
<li>embedded exporter <a href="https://grafana.com/grafana/dashboards/10465" target="_blank">https://grafana.com/grafana/dashboards/10465</a></li>
<li>dabealu exporter <a href="https://grafana.com/grafana/dashboards/11442" target="_blank">https://grafana.com/grafana/dashboards/11442</a></li>
</ul>
<p>See also <a href="https://grafana.com/grafana/dashboards?search=ZooKeeper&amp;dataSource=prometheus" target="_blank">https://grafana.com/grafana/dashboards?search=ZooKeeper&amp;amp;dataSource=prometheus</a></p>
<h3 id="setup-alert-rules">setup alert rules</h3>
<ul>
<li>embedded exporter <a href="https://github.com/Altinity/clickhouse-operator/blob/master/deploy/prometheus/prometheus-alert-rules-zookeeper.yaml" target="_blank">link</a></li>
</ul>
<h3 id="see-also">See also</h3>
<ul>
<li><a href="https://blog.serverdensity.com/how-to-monitor-zookeeper/" target="_blank">https://blog.serverdensity.com/how-to-monitor-zookeeper/</a></li>
<li><a href="https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/#zookeeper-metrics" target="_blank">https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/#zookeeper-metrics</a></li>
<li><a href="https://dzone.com/articles/monitoring-apache-zookeeper-servers" target="_blank">https://dzone.com/articles/monitoring-apache-zookeeper-servers</a></li>
<li><a href="https://docs.signalfx.com/en/latest/integrations/integrations-reference/integrations.zookeeper.html" target="_blank">https://docs.signalfx.com/en/latest/integrations/integrations-reference/integrations.zookeeper.html</a></li>
<li><a href="https://github.com/samber/awesome-prometheus-alerts/blob/c3ba0cf1997c7e952369a090aeb10343cdca4878/_data/rules.yml#L1146-L1170" target="_blank">https://github.com/samber/awesome-prometheus-alerts/blob/c3ba0cf1997c7e952369a090aeb10343cdca4878/_data/rules.yml#L1146-L1170</a> (or <a href="https://awesome-prometheus-alerts.grep.to/rules.html#zookeeper" target="_blank">https://awesome-prometheus-alerts.grep.to/rules.html#zookeeper</a> )</li>
<li><a href="https://alex.dzyoba.com/blog/prometheus-alerts/" target="_blank">https://alex.dzyoba.com/blog/prometheus-alerts/</a></li>
<li><a href="https://docs.datadoghq.com/integrations/zk/?tab=host" target="_blank">https://docs.datadoghq.com/integrations/zk/?tab=host</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-caaac474228860d2cc9228c7ba1fb3f9">10 - ZooKeeper schema</h1>
    <div class="lead">ZooKeeper schema</div>
	<h2 id="metadata">/metadata</h2>
<p>Table schema.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>date column -&gt; legacy MergeTree partition expression.
</span></span><span style="display:flex;"><span>sampling expression -&gt; SAMPLE BY
</span></span><span style="display:flex;"><span>index granularity -&gt; index_granularity
</span></span><span style="display:flex;"><span>mode -&gt; <span style="color:#204a87">type</span> of MergeTree table
</span></span><span style="display:flex;"><span>sign column -&gt; sign - CollapsingMergeTree / VersionedCollapsingMergeTree
</span></span><span style="display:flex;"><span>primary key -&gt; ORDER BY key <span style="color:#204a87;font-weight:bold">if</span> PRIMARY KEY not defined.
</span></span><span style="display:flex;"><span>sorting key -&gt; ORDER BY key <span style="color:#204a87;font-weight:bold">if</span> PRIMARY KEY defined.
</span></span><span style="display:flex;"><span>data format version -&gt; <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>partition key -&gt; PARTITION BY
</span></span><span style="display:flex;"><span>granularity bytes -&gt; index_granularity_bytes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>types of MergeTree tables:
</span></span><span style="display:flex;"><span><span style="color:#000">Ordinary</span>            <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Collapsing</span>          <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Summing</span>             <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Aggregating</span>         <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Replacing</span>           <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Graphite</span>            <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span><span style="color:#000">VersionedCollapsing</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">7</span>
</span></span></code></pre></div><h2 id="mutations">/mutations</h2>
<p>Log of latest mutations</p>
<h2 id="columns">/columns</h2>
<p>List of columns for latest (reference) table version. Replicas would try to reach this state.</p>
<h2 id="log">/log</h2>
<p>Log of latest actions with table.</p>
<p>Related settings:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">┌─</span><span style="color:#000">name</span><span style="color:#a40000">────────────────────────┬─</span><span style="color:#000">value</span><span style="color:#a40000">─┬─</span><span style="color:#000">changed</span><span style="color:#a40000">─┬─</span><span style="color:#000">description</span><span style="color:#a40000">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#a40000">───┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_replicated_logs_to_keep</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">How</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">many</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">records</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">may</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">be</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">there</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">is</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inactive</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Inactive</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">becomes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lost</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">when</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">when</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">this</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">exceed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">                                                  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UInt64</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">min_replicated_logs_to_keep</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Keep</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">about</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">this</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">last</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">records</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ZooKeeper</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">even</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">they</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">are</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">obsolete</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">It</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">doesn</span><span style="color:#4e9a06">&#39;t affect work of tables: used only to diagnose ZooKeeper log before cleaning. │ UInt64 │
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">└─────────────────────────────┴───────┴─────────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴────────┘
</span></span></span></code></pre></div><h2 id="replicas">/replicas</h2>
<p>List of table replicas.</p>
<h2 id="replicasreplica_name">/replicas/replica_name/</h2>
<h3 id="replicasreplica_namemutation_pointer">/replicas/replica_name/mutation_pointer</h3>
<p>Pointer to the latest mutation executed by replica</p>
<h3 id="replicasreplica_namelog_pointer">/replicas/replica_name/log_pointer</h3>
<p>Pointer to the latest task from replication_queue executed by replica</p>
<h3 id="replicasreplica_namemax_processed_insert_time">/replicas/replica_name/max_processed_insert_time</h3>
<h3 id="replicareplica_namemetadata">/replica/replica_name/metadata</h3>
<p>Table schema of specific replica</p>
<h3 id="replicareplica_namecolumns">/replica/replica_name/columns</h3>
<p>Columns list of specific replica.</p>
<h2 id="quorum">/quorum</h2>
<p>Used for quorum inserts.</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://twitter.com/AltinityDB">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Youtube" aria-label="Youtube">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/channel/UCE3Y2lDKl_ZfjaCrh62onYA">
      <i class="fab fa-youtube"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="LinkedIn" aria-label="LinkedIn">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/company/altinity/">
      <i class="fab fa-linkedin"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/orgs/Altinity/">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022  Altinity Inc. All Rights Reserved</small>
        <small class="ml-1"><a href="https://altinity.com/privacy-policy/" target="_blank">Privacy Policy</a></small>
	
		
	
      </div>
    </div>
  </div>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-101676615-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-101676615-2');
</script>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>






 













<script src="/js/main.min.7fa9e3e39f56ebd66798993ef3c080218d9696c971a28ef8872d750b7416a435.js" integrity="sha256-f6nj459W69ZnmJk&#43;88CAIY2Wlslxoo74hy11C3QWpDU=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
