<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=icon href=/favicons/favicon.ico><title>UPSERT by VersionedCollapsingMergeTree | Altinity® Knowledge Base for ClickHouse®</title>
<meta name=description content="How to aggregate mutating event stream with duplicates"><meta property="og:url" content="http://kb.altinity.com/engines/mergetree-table-engine-family/versioned-collapsing-mergetree/"><meta property="og:site_name" content="Altinity® Knowledge Base for ClickHouse®"><meta property="og:title" content="UPSERT by VersionedCollapsingMergeTree"><meta property="og:description" content="How to aggregate mutating event stream with duplicates"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="engines"><meta property="article:modified_time" content="2024-11-19T07:44:52+01:00"><meta itemprop=name content="UPSERT by VersionedCollapsingMergeTree"><meta itemprop=description content="How to aggregate mutating event stream with duplicates"><meta itemprop=dateModified content="2024-11-19T07:44:52+01:00"><meta itemprop=wordCount content="3956"><meta name=twitter:card content="summary"><meta name=twitter:title content="UPSERT by VersionedCollapsingMergeTree"><meta name=twitter:description content="How to aggregate mutating event stream with duplicates"><link rel=preload href=/scss/main.min.2b572659bc7fea3f75213379efc217ce16fd006fe842d92e20eda9357d016609.css as=style><link href=/scss/main.min.2b572659bc7fea3f75213379efc217ce16fd006fe842d92e20eda9357d016609.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><link rel=stylesheet href=/css/prism.css><meta name=keywords content><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/4536206.js></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="a" viewBox="0 0 91.660006 105.99" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs1"><style id="style1">.b{fill:#fff}.c{fill:#199dcf}</style></defs><g id="g7"><polygon class="c" points="45.88,0 45.88,0.04 22.94,13.3 22.93,13.3 22.93,13.3 0.09,26.49 0.09,26.49 0.09,26.49 0,26.54 0.09,26.59 0.09,50.96 66.86,12.12" id="polygon1"/><polygon class="c" points="22.94,42.29 4.21,53.19 22.94,64.08" id="polygon2"/><polygon class="c" points="0.09,55.59 0.09,79.43 0,79.48 0.09,79.54 0.09,105.99 22.8,92.88 22.8,92.88 43.75,80.79 0.23,55.51" id="polygon3"/><polygon class="c" points="89.61,25.17 70.92,14.38 48.03,27.7 64.18,37.02 64.22,36.96 66.79,38.45" id="polygon4"/><g id="g6"><polygon class="c" points="91.66,52.82 91.63,52.83 76.33,44 91.66,52.92" id="polygon5"/><polygon class="c" points="91.66,105.76 91.66,57.55 68.71,44.2 68.71,92.51" id="polygon6"/></g><polygon class="c" points="91.66,52.85 91.66,28.61 70.77,40.76 76.28,43.97" id="polygon7"/></g></svg></span><span class=font-weight-bold>Altinity Knowledge Base for ClickHouse<sup>®</sup></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=productsDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Products</a><div class=dropdown-menu aria-labelledby=productsDropdown><a class=dropdown-item href=https://altinity.com/managed-clickhouse/ target=_blank><span style=font-size:large>Altinity.Cloud</span><br><span style=font-size:small>Managed service for ClickHouse in any AWS, GCP, or Azure region or your own VPC</span></a>
<a class=dropdown-item href=https://altinity.com/clickhouse-support/ target=_blank><span style=font-size:large>Support for ClickHouse</span><br><span style=font-size:small>Get 24/7 Support or POC and evaluative support</span></a>
<a class=dropdown-item href=https://altinity.com/clickhouse-training/ target=_blank><span style=font-size:large>Training for ClickHouse</span><br><span style=font-size:small>Altinity Administrator training for ClickHouse</span></a>
<a class=dropdown-item href=https://altinity.com/customer-stories/ target=_blank><span style=font-size:large>Customer Stories</span><br><span style=font-size:small>See why our customers love us</span></a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=resourceDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Resources</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=https://docs.altinity.com/ target=_blank><span style=font-size:large>Documentation</span><br><span style=font-size:small>Product guides and tutorials</span></a>
<a class=dropdown-item href=https://hubs.la/Q02pLTV20 target=_blank><span style=font-size:large>Guides and eBooks</span><br><span style=font-size:small>Technical content for developers</span></a>
<a class=dropdown-item href=https://altinity.com/clickhouse-database/ target=_blank><span style=font-size:large>What is ClickHouse?</span><br><span style=font-size:small>Learn why ClickHouse is the fastest database in the world</span></a>
<a class=dropdown-item href=https://altinity.com/what-is-kubernetes/ target=_blank><span style=font-size:large>What is Kubernetes?</span><br><span style=font-size:small>Learn why Kubernetes is the platform of choice for analytic databases</span></a></div></li><li class=nav-item><a class=nav-link href=https://altinity.com/blog target=_blank>Blog <span class=navbar-logo><svg width="25.897644" height="31.648945" viewBox="0 0 25.897644 31.648945" id="svg1" xmlns="http://www.w3.org/2000/svg"><path d="m18 14.5v6H6v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#fff" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round" id="path1" style="stroke:#fff;stroke-opacity:1"/></svg></span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=companyDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Company</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=https://altinity.com/about-us/ target=_blank><span style=font-size:large>About the Company</span><br><span style=font-size:small>Who we are and what we do</span></a>
<a class=dropdown-item href=https://altinity.com/careers/ target=_blank><span style=font-size:large>Careers</span><br><span style=font-size:small>Join our team!</span></a>
<a class=dropdown-item href=https://altinity.com/contact target=_blank><span style=font-size:large>Contact</span><br><span style=font-size:small>Have questions? We've got answers.</span></a></div></li><li class="header-social-wrap ml-md-auto"><div style=padding-right:20px class="header-social-inner-wrap element-social-inner-wrap social-show-label-false social-style-filled"><a class=mega-menu-link href=https://altinity.com/free-clickhouse-consultation/><span style=border-radius:24px;padding-top:.3em;padding-bottom:.3em;padding-left:1em;padding-right:1em;background-color:#1e9dcf;color:#fff;font-style:normal;font-size:13px;line-height:17px;font-weight:700>Need help?</span>
</a>&nbsp;
<a href=https://altinity.com/slack aria-label=Slack target=_blank rel="noopener noreferrer" class="social-button header-social-item social-link-custom1" data-positional-element-id=75><span class=social-icon-custom-svg style=max-width:34px><svg viewBox="0 0 36 36" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path fill="#fff" d="M7.563 22.747a3.782 3.782.0 11-3.78-3.78h3.78v3.78zm1.906.0a3.782 3.782.0 017.563.0v9.469a3.782 3.782.0 11-7.563.0V22.747zM13.251 7.563a3.782 3.782.0 113.782-3.78v3.78H13.251zm0 1.906a3.781 3.781.0 110 7.563H3.783a3.782 3.782.0 110-7.563h9.468zm15.183 3.782a3.783 3.783.0 113.783 3.782H28.434V13.251zm-1.9.0a3.782 3.782.0 01-7.565.0V3.783a3.782 3.782.0 117.564.0zM22.747 28.434a3.783 3.783.0 11-3.78 3.783V28.434h3.78zm0-1.9a3.782 3.782.0 010-7.565h9.469a3.782 3.782.0 110 7.564z" data-name="Icon simple-slack" id="Icon_simple-slack"/></svg>
</span></a>&nbsp;&nbsp;&nbsp;
<a href=https://github.com/Altinity/altinityknowledgebase aria-label=GitHub target=_blank rel="noopener noreferrer" class="social-button header-social-item social-link-github has-custom-image" data-positional-element-id=76><img width=500 height=245 src=https://altinity.com/wp-content/uploads/2023/11/github-mark-white.png class="social-icon-image lazyloaded" alt decoding=async loading=lazy style=max-width:24px data-ll-status=loaded><noscript><img width=250 height=245 src=https://altinity.com/wp-content/uploads/2023/11/github-mark-white.png class=social-icon-image alt decoding=async loading=lazy style=max-width:24px></noscript></a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.21b07d7fe134d30ffa62ff06d762b6b9.json data-offline-search-base-href=/ data-offline-search-max-results=10></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="td-sidebar-nav collapse td-sidebar-nav--search-disabled" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m--li><a href=/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-><span>Altinity® Knowledge Base for ClickHouse®</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-engines-li><a href=/engines/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-engines><span>Engines</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-enginesaltinity-kb-atomic-database-engine-li><a href=/engines/altinity-kb-atomic-database-engine/ title="ClickHouse® Atomic Database Engine" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-enginesaltinity-kb-atomic-database-engine><span>Atomic Database Engine</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-enginesaltinity-kb-atomic-database-enginehow-to-convert-ordinary-to-atomic-li><a href=/engines/altinity-kb-atomic-database-engine/how-to-convert-ordinary-to-atomic/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesaltinity-kb-atomic-database-enginehow-to-convert-ordinary-to-atomic><span>How to Convert Ordinary to Atomic</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-enginesaltinity-kb-atomic-database-enginealtinity-kb-how-to-convert-atomic-to-ordinary-li><a href=/engines/altinity-kb-atomic-database-engine/altinity-kb-how-to-convert-atomic-to-ordinary/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesaltinity-kb-atomic-database-enginealtinity-kb-how-to-convert-atomic-to-ordinary><span>How to Convert Atomic to Ordinary</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enginesaltinity-kb-embeddedrocksdb-and-dictionary-li><a href=/engines/altinity-kb-embeddedrocksdb-and-dictionary/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesaltinity-kb-embeddedrocksdb-and-dictionary><span>EmbeddedRocksDB & dictionary</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-enginesmergetree-table-engine-family-li><a href=/engines/mergetree-table-engine-family/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-enginesmergetree-table-engine-family><span>MergeTree table engine family</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enginesmergetree-table-engine-familycollapsing-vs-replacing-li><a href=/engines/mergetree-table-engine-family/collapsing-vs-replacing/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familycollapsing-vs-replacing><span>CollapsingMergeTree vs ReplacingMergeTree</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enginesmergetree-table-engine-familypart-naming-and-mvcc-li><a href=/engines/mergetree-table-engine-family/part-naming-and-mvcc/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familypart-naming-and-mvcc><span>Part names & MVCC</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enginesmergetree-table-engine-familypick-keys-li><a href=/engines/mergetree-table-engine-family/pick-keys/ title="How to pick an ORDER BY / PRIMARY KEY / PARTITION BY for the MergeTree family table" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familypick-keys><span>Properly ordering and partitioning MergeTree tables</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enginesmergetree-table-engine-familyaggregatingmergetree-li><a href=/engines/mergetree-table-engine-family/aggregatingmergetree/ title="ClickHouse® AggregatingMergeTree" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familyaggregatingmergetree><span>AggregatingMergeTree</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enginesmergetree-table-engine-familyindex-and-column-files-li><a href=/engines/mergetree-table-engine-family/index-and-column-files/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familyindex-and-column-files><span>index & column files</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enginesmergetree-table-engine-familymerge-performance-final-optimize-by-li><a href=/engines/mergetree-table-engine-family/merge-performance-final-optimize-by/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familymerge-performance-final-optimize-by><span>Merge performance and OPTIMIZE FINAL</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enginesmergetree-table-engine-familyaltinity-kb-nulls-in-order-by-li><a href=/engines/mergetree-table-engine-family/altinity-kb-nulls-in-order-by/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familyaltinity-kb-nulls-in-order-by><span>Nulls in order by</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-enginesmergetree-table-engine-familyreplacingmergetree-li><a href=/engines/mergetree-table-engine-family/replacingmergetree/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-enginesmergetree-table-engine-familyreplacingmergetree><span>ReplacingMergeTree</span></a><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-enginesmergetree-table-engine-familyreplacingmergetreealtinity-kb-replacingmergetree-does-not-collapse-duplicates-li><a href=/engines/mergetree-table-engine-family/replacingmergetree/altinity-kb-replacingmergetree-does-not-collapse-duplicates/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familyreplacingmergetreealtinity-kb-replacingmergetree-does-not-collapse-duplicates><span>ReplacingMergeTree does not collapse duplicates</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enginesmergetree-table-engine-familyskip-index-li><a href=/engines/mergetree-table-engine-family/skip-index/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familyskip-index><span>Skip index</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enginesmergetree-table-engine-familysummingmergetree-li><a href=/engines/mergetree-table-engine-family/summingmergetree/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familysummingmergetree><span>SummingMergeTree</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-enginesmergetree-table-engine-familyversioned-collapsing-mergetree-li><a href=/engines/mergetree-table-engine-family/versioned-collapsing-mergetree/ title="UPSERT by VersionedCollapsingMergeTree" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-enginesmergetree-table-engine-familyversioned-collapsing-mergetree><span class=td-sidebar-nav-active-item>VersionedCollapsingMT</span></a></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-altinity-kb-queries-and-syntax-li><a href=/altinity-kb-queries-and-syntax/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-queries-and-syntax><span>Queries & Syntax</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-queries-and-syntaxgroup-by-li><a href=/altinity-kb-queries-and-syntax/group-by/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-queries-and-syntaxgroup-by><span>GROUP BY</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxgroup-bytricks-li><a href=/altinity-kb-queries-and-syntax/group-by/tricks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxgroup-bytricks><span>GROUP BY tricks</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxvariable-partitioning-li><a href=/altinity-kb-queries-and-syntax/variable-partitioning/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxvariable-partitioning><span>Adjustable table partitioning</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxdatetime64-li><a href=/altinity-kb-queries-and-syntax/datetime64/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxdatetime64><span>DateTime64</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxdistinct-vs-group-by-vs-limit-by-li><a href=/altinity-kb-queries-and-syntax/distinct-vs-group-by-vs-limit-by/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxdistinct-vs-group-by-vs-limit-by><span>DISTINCT & GROUP BY & LIMIT 1 BY what the difference</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxliteral-decimal-or-float-li><a href=/altinity-kb-queries-and-syntax/literal-decimal-or-float/ title="Imprecise parsing of literal Decimal or Float64" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxliteral-decimal-or-float><span>Imprecise literal Decimal or Float64 values</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxmultiple-date-column-in-partition-key-li><a href=/altinity-kb-queries-and-syntax/multiple-date-column-in-partition-key/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxmultiple-date-column-in-partition-key><span>Multiple aligned date columns in PARTITION BY expression</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxrow_policy_using_dictionary-li><a href=/altinity-kb-queries-and-syntax/row_policy_using_dictionary/ title="Row policies overhead (hiding 'removed' tenants)" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxrow_policy_using_dictionary><span>Row policies overhead</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxslow_select_count-li><a href=/altinity-kb-queries-and-syntax/slow_select_count/ title="Why is simple `SELECT count()` Slow in ClickHouse®?" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxslow_select_count><span>Slow `SELECT count()`</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxtrace_log-li><a href=/altinity-kb-queries-and-syntax/trace_log/ title="Collecting query execution flamegraphs using system.trace_log" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxtrace_log><span>trace_log</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxarray-functions-as-window-li><a href=/altinity-kb-queries-and-syntax/array-functions-as-window/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxarray-functions-as-window><span>Using array functions to mimic window-functions alike behavior</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxstate-and-merge-combinators-li><a href=/altinity-kb-queries-and-syntax/state-and-merge-combinators/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxstate-and-merge-combinators><span>-State & -Merge combinators</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxaltinity-kb-alter-modify-column-is-stuck-the-column-is-inaccessible-li><a href=/altinity-kb-queries-and-syntax/altinity-kb-alter-modify-column-is-stuck-the-column-is-inaccessible/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxaltinity-kb-alter-modify-column-is-stuck-the-column-is-inaccessible><span>ALTER MODIFY COLUMN is stuck, the column is inaccessible.</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxansi-sql-mode-li><a href=/altinity-kb-queries-and-syntax/ansi-sql-mode/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxansi-sql-mode><span>ANSI SQL mode</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxasync-inserts-li><a href=/altinity-kb-queries-and-syntax/async-inserts/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxasync-inserts><span>Async INSERTs</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxatomic-insert-li><a href=/altinity-kb-queries-and-syntax/atomic-insert/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxatomic-insert><span>Atomic insert</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxprojections-examples-li><a href=/altinity-kb-queries-and-syntax/projections-examples/ title="ClickHouse® Projections" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxprojections-examples><span>ClickHouse Projections</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxcumulative-unique-li><a href=/altinity-kb-queries-and-syntax/cumulative-unique/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxcumulative-unique><span>Cumulative Anything</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxdata-types-on-disk-and-in-ram-li><a href=/altinity-kb-queries-and-syntax/data-types-on-disk-and-in-ram/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxdata-types-on-disk-and-in-ram><span>Data types on disk and in RAM</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxdelete-via-tombstone-column-li><a href=/altinity-kb-queries-and-syntax/delete-via-tombstone-column/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxdelete-via-tombstone-column><span>DELETE via tombstone column</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxexplain-query-li><a href=/altinity-kb-queries-and-syntax/explain-query/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxexplain-query><span>EXPLAIN query</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxfill-missing-values-at-query-time-li><a href=/altinity-kb-queries-and-syntax/fill-missing-values-at-query-time/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxfill-missing-values-at-query-time><span>Fill missing values at query time</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxaltinity-kb-final-clause-speed-li><a href=/altinity-kb-queries-and-syntax/altinity-kb-final-clause-speed/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxaltinity-kb-final-clause-speed><span>FINAL clause speed</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxjoin-with-calendar-using-arrays-li><a href=/altinity-kb-queries-and-syntax/join-with-calendar-using-arrays/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxjoin-with-calendar-using-arrays><span>Join with Calendar using Arrays</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-queries-and-syntaxjoins-li><a href=/altinity-kb-queries-and-syntax/joins/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-queries-and-syntaxjoins><span>JOINs</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxjoinsjoins-tricks-li><a href=/altinity-kb-queries-and-syntax/joins/joins-tricks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxjoinsjoins-tricks><span>JOIN optimization tricks</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxjsonextract-to-parse-many-attributes-at-a-time-li><a href=/altinity-kb-queries-and-syntax/jsonextract-to-parse-many-attributes-at-a-time/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxjsonextract-to-parse-many-attributes-at-a-time><span>JSONExtract to parse many attributes at a time</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxaltinity-kb-kill-query-li><a href=/altinity-kb-queries-and-syntax/altinity-kb-kill-query/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxaltinity-kb-kill-query><span>KILL QUERY</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxlag-lead-li><a href=/altinity-kb-queries-and-syntax/lag-lead/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxlag-lead><span>Lag / Lead</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxmachine-learning-in-clickhouse-li><a href=/altinity-kb-queries-and-syntax/machine-learning-in-clickhouse/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxmachine-learning-in-clickhouse><span>Machine learning in ClickHouse</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxmutations-li><a href=/altinity-kb-queries-and-syntax/mutations/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxmutations><span>Mutations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxaltinity-kb-optimize-vs-optimize-final-li><a href=/altinity-kb-queries-and-syntax/altinity-kb-optimize-vs-optimize-final/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxaltinity-kb-optimize-vs-optimize-final><span>OPTIMIZE vs OPTIMIZE FINAL</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxaltinity-kb-parameterized-views-li><a href=/altinity-kb-queries-and-syntax/altinity-kb-parameterized-views/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxaltinity-kb-parameterized-views><span>Parameterized views</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxpartial-projection-optimization-li><a href=/altinity-kb-queries-and-syntax/partial-projection-optimization/ title="Use both projection and raw data in single query" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxpartial-projection-optimization><span>partial-projection-optimization</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxpivot-unpivot-li><a href=/altinity-kb-queries-and-syntax/pivot-unpivot/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxpivot-unpivot><span>PIVOT / UNPIVOT</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxaltinity-kb-possible-deadlock-avoided-client-should-retry-li><a href=/altinity-kb-queries-and-syntax/altinity-kb-possible-deadlock-avoided.-client-should-retry/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxaltinity-kb-possible-deadlock-avoided-client-should-retry><span>Possible deadlock avoided. Client should retry</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxroaring-bitmaps-for-calculating-retention-li><a href=/altinity-kb-queries-and-syntax/roaring-bitmaps-for-calculating-retention/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxroaring-bitmaps-for-calculating-retention><span>Roaring bitmaps for calculating retention</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxaltinity-kb-sample-by-li><a href=/altinity-kb-queries-and-syntax/altinity-kb-sample-by/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxaltinity-kb-sample-by><span>SAMPLE by</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxsampling-example-li><a href=/altinity-kb-queries-and-syntax/sampling-example/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxsampling-example><span>Sampling Example</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxsimplestateif-or-ifstate-for-simple-aggregate-functions-li><a href=/altinity-kb-queries-and-syntax/simplestateif-or-ifstate-for-simple-aggregate-functions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxsimplestateif-or-ifstate-for-simple-aggregate-functions><span>Simple aggregate functions & combinators</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-queries-and-syntaxskip-indexes-li><a href=/altinity-kb-queries-and-syntax/skip-indexes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-queries-and-syntaxskip-indexes><span>Skip indexes</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxskip-indexesminmax-li><a href=/altinity-kb-queries-and-syntax/skip-indexes/minmax/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxskip-indexesminmax><span>Example: minmax</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxskip-indexesskip-index-bloom_filter-for-array-column-li><a href=/altinity-kb-queries-and-syntax/skip-indexes/skip-index-bloom_filter-for-array-column/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxskip-indexesskip-index-bloom_filter-for-array-column><span>Skip index bloom_filter Example</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxskip-indexesskip-indexes-examples-li><a href=/altinity-kb-queries-and-syntax/skip-indexes/skip-indexes-examples/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxskip-indexesskip-indexes-examples><span>Skip indexes examples</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxtime-zones-li><a href=/altinity-kb-queries-and-syntax/time-zones/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxtime-zones><span>Time zones</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxts-interpolation-li><a href=/altinity-kb-queries-and-syntax/ts-interpolation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxts-interpolation><span>Time-series alignment with interpolation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxtop-n-and-remain-li><a href=/altinity-kb-queries-and-syntax/top-n-and-remain/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxtop-n-and-remain><span>Top N & Remain</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxtroubleshooting-li><a href=/altinity-kb-queries-and-syntax/troubleshooting/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxtroubleshooting><span>Troubleshooting</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-queries-and-syntaxttl-li><a href=/altinity-kb-queries-and-syntax/ttl/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-queries-and-syntaxttl><span>TTL</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxttlmodify-ttl-li><a href=/altinity-kb-queries-and-syntax/ttl/modify-ttl/ title="MODIFY (ADD) TTL in ClickHouse®" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxttlmodify-ttl><span>MODIFY (ADD) TTL</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxttlwhat-are-my-ttls-li><a href=/altinity-kb-queries-and-syntax/ttl/what-are-my-ttls/ title="What are my TTL settings?" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxttlwhat-are-my-ttls><span>What are my TTL settings</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxttlttl-group-by-examples-li><a href=/altinity-kb-queries-and-syntax/ttl/ttl-group-by-examples/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxttlttl-group-by-examples><span>TTL GROUP BY Examples</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxttlttl-recompress-example-li><a href=/altinity-kb-queries-and-syntax/ttl/ttl-recompress-example/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxttlttl-recompress-example><span>TTL Recompress example</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxupdate-via-dictionary-li><a href=/altinity-kb-queries-and-syntax/update-via-dictionary/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxupdate-via-dictionary><span>UPDATE via Dictionary</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxvalues-mapping-li><a href=/altinity-kb-queries-and-syntax/values-mapping/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxvalues-mapping><span>Values mapping</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-queries-and-syntaxwindow-functions-li><a href=/altinity-kb-queries-and-syntax/window-functions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-queries-and-syntaxwindow-functions><span>Window functions</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-altinity-kb-functions-li><a href=/altinity-kb-functions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-functions><span>Functions</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-functionshow-to-encode-decode-quantiletdigest-state-li><a href=/altinity-kb-functions/how-to-encode-decode-quantiletdigest-state/ title="How to encode/decode quantileTDigest states from/to list of centroids" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-functionshow-to-encode-decode-quantiletdigest-state><span>Encoding and Decoding of quantileTDigest states</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-functionskurt_skew_statistics-li><a href=/altinity-kb-functions/kurt_skew_statistics/ title="kurt & skew statistical functions in ClickHouse® " class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-functionskurt_skew_statistics><span>kurt & skew</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-functionsresample-vs-if-vs-map-vs-subquery-li><a href=/altinity-kb-functions/resample-vs-if-vs-map-vs-subquery/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-functionsresample-vs-if-vs-map-vs-subquery><span>-Resample vs -If vs -Map vs Subquery</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-functionsarrayfold-li><a href=/altinity-kb-functions/arrayfold/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-functionsarrayfold><span>arrayFold</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-functionsarray-like-memory-usage-li><a href=/altinity-kb-functions/array-like-memory-usage/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-functionsarray-like-memory-usage><span>arrayMap, arrayJoin or ARRAY JOIN memory usage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-functionsassumenotnull-and-friends-li><a href=/altinity-kb-functions/assumenotnull-and-friends/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-functionsassumenotnull-and-friends><span>assumeNotNull and friends</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-functionsencrypt-li><a href=/altinity-kb-functions/encrypt/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-functionsencrypt><span>Encrypt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-functionsaltinity-kb-sequencematch-li><a href=/altinity-kb-functions/altinity-kb-sequencematch/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-functionsaltinity-kb-sequencematch><span>sequenceMatch</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-altinity-kb-integrations-li><a href=/altinity-kb-integrations/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-integrations><span>Integrations</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-cloud-li><a href=/altinity-kb-integrations/altinity-cloud/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-integrationsaltinity-cloud><span>Altinity Cloud Access Management</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsclickhouse_python_drivers-li><a href=/altinity-kb-integrations/clickhouse_python_drivers/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsclickhouse_python_drivers><span>ClickHouse® python drivers</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsmysql-clickhouse-li><a href=/altinity-kb-integrations/mysql-clickhouse/ title=MySQL class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsmysql-clickhouse><span>Integrating ClickHouse® with MySQL</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsclickhouse-odbc-li><a href=/altinity-kb-integrations/clickhouse-odbc/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsclickhouse-odbc><span>ODBC Driver for ClickHouse®</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsspark-li><a href=/altinity-kb-integrations/spark/ title="ClickHouse® + Spark" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsspark><span>Spark</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsbi-tools-li><a href=/altinity-kb-integrations/bi-tools/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsbi-tools><span>BI Tools</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationscatboost-mindsdb-fastai-li><a href=/altinity-kb-integrations/catboost-mindsdb-fast.ai/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationscatboost-mindsdb-fastai><span>CatBoost / MindsDB / Fast.ai</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-google-s3-gcs-li><a href=/altinity-kb-integrations/altinity-kb-google-s3-gcs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-google-s3-gcs><span>Google S3 (GCS)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafka-li><a href=/altinity-kb-integrations/altinity-kb-kafka/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-integrationsaltinity-kb-kafka><span>Kafka</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafkakafka-schema-inference-li><a href=/altinity-kb-integrations/altinity-kb-kafka/kafka-schema-inference/ title="Inferring Schema from AvroConfluent Messages in Kafka for ClickHouse®" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-kafkakafka-schema-inference><span>Schema Inference for Kafka</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafkabackground_message_broker_schedule_pool_size-li><a href=/altinity-kb-integrations/altinity-kb-kafka/background_message_broker_schedule_pool_size/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-kafkabackground_message_broker_schedule_pool_size><span>Setting the background message broker schedule pool size</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-adjusting-librdkafka-settings-li><a href=/altinity-kb-integrations/altinity-kb-kafka/altinity-kb-adjusting-librdkafka-settings/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-adjusting-librdkafka-settings><span>Adjusting librdkafka settings</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafkaerror-handling-li><a href=/altinity-kb-integrations/altinity-kb-kafka/error-handling/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-kafkaerror-handling><span>Error handling</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-exactly-once-semantics-li><a href=/altinity-kb-integrations/altinity-kb-kafka/altinity-kb-exactly-once-semantics/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-exactly-once-semantics><span>Exactly once semantics</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-kafka-main-parsing-loop-li><a href=/altinity-kb-integrations/altinity-kb-kafka/altinity-kb-kafka-main-parsing-loop/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-kafka-main-parsing-loop><span>Kafka main parsing loop</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-kafka-parallel-consuming-li><a href=/altinity-kb-integrations/altinity-kb-kafka/altinity-kb-kafka-parallel-consuming/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-kafka-parallel-consuming><span>Kafka parallel consuming</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-kafka-mv-consuming-li><a href=/altinity-kb-integrations/altinity-kb-kafka/altinity-kb-kafka-mv-consuming/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-kafka-mv-consuming><span>Multiple MVs attached to Kafka table</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-rewind-fast-forward-replay-li><a href=/altinity-kb-integrations/altinity-kb-kafka/altinity-kb-rewind-fast-forward-replay/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-rewind-fast-forward-replay><span>Rewind / fast-forward / replay</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-selects-from-engine-kafka-li><a href=/altinity-kb-integrations/altinity-kb-kafka/altinity-kb-selects-from-engine-kafka/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-kafkaaltinity-kb-selects-from-engine-kafka><span>SELECTs from engine=Kafka</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-integrationsaltinity-kb-rabbitmq-li><a href=/altinity-kb-integrations/altinity-kb-rabbitmq/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-integrationsaltinity-kb-rabbitmq><span>RabbitMQ</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-integrationsaltinity-kb-rabbitmqerror-handling-li><a href=/altinity-kb-integrations/altinity-kb-rabbitmq/error-handling/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-integrationsaltinity-kb-rabbitmqerror-handling><span>RabbitMQ Error handling</span></a></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-altinity-kb-setup-and-maintenance-li><a href=/altinity-kb-setup-and-maintenance/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-setup-and-maintenance><span>Setup & maintenance</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storage-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-s3-object-storage/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storage><span>S3 & object storage</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storageaws-s3-recipes-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-s3-object-storage/aws-s3-recipes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storageaws-s3-recipes><span>AWS S3 Recipes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storageclean-up-orphaned-objects-on-s3md-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-s3-object-storage/clean-up-orphaned-objects-on-s3.md/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storageclean-up-orphaned-objects-on-s3md><span>Clean up orphaned objects on s3</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storages3_and_mutations-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-s3-object-storage/s3_and_mutations/ title="How much data are written to S3 during mutations" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storages3_and_mutations><span>s3 and mutations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storages3_cache_example-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-s3-object-storage/s3_cache_example/ title="Example of the table at s3 with cache" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storages3_cache_example><span>s3 cached table</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storages3disk-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-s3-object-storage/s3disk/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-s3-object-storages3disk><span>S3Disk</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceuniq-uuid-doubled-clickhouse-upgrade-li><a href=/altinity-kb-setup-and-maintenance/uniq-uuid-doubled-clickhouse-upgrade/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceuniq-uuid-doubled-clickhouse-upgrade><span>AggregateFunction(uniq, UUID) doubled after ClickHouse® upgrade</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceconnection-problems-li><a href=/altinity-kb-setup-and-maintenance/connection-problems/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceconnection-problems><span>Can not connect to my ClickHouse® server</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancecgroups_k8s-li><a href=/altinity-kb-setup-and-maintenance/cgroups_k8s/ title="cgroups and kubernetes cloud providers" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancecgroups_k8s><span>cgroups and k8s</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancech-logs-2-json-vectordev-li><a href=/altinity-kb-setup-and-maintenance/ch-logs-2-json-vectordev/ title="Transforming ClickHouse logs to ndjson using Vector.dev" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancech-logs-2-json-vectordev><span>ClickHouse logs and Vector.dev</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceclickhouse-operator-li><a href=/altinity-kb-setup-and-maintenance/clickhouse-operator/ title="Altinity Kubernetes Operator For ClickHouse®" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceclickhouse-operator><span>ClickHouse operator</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancefilesystems-li><a href=/altinity-kb-setup-and-maintenance/filesystems/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancefilesystems><span>ClickHouse® and different filesystems</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancerbac-li><a href=/altinity-kb-setup-and-maintenance/rbac/ title="ClickHouse® Access Control and Account Management (RBAC)" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancerbac><span>ClickHouse® RBAC example</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceclient-timeouts-li><a href=/altinity-kb-setup-and-maintenance/client-timeouts/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceclient-timeouts><span>Client Timeouts</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancemonitoring-operator-exporter-compatibility-li><a href=/altinity-kb-setup-and-maintenance/monitoring-operator-exporter-compatibility/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancemonitoring-operator-exporter-compatibility><span>Compatibility layer for the Altinity Kubernetes Operator for ClickHouse®</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceuniqexact-to-uniq-combined-li><a href=/altinity-kb-setup-and-maintenance/uniqexact-to-uniq-combined/ title="How to convert uniqExact states to approximate uniq functions states" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceuniqexact-to-uniq-combined><span>Convert uniqExact to uniq(Combined)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancecustom_settings-li><a href=/altinity-kb-setup-and-maintenance/custom_settings/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancecustom_settings><span>Custom Settings</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceasynchronous_metrics_descr-li><a href=/altinity-kb-setup-and-maintenance/asynchronous_metrics_descr/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceasynchronous_metrics_descr><span>Description of asynchronous_metrics</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancedisk_encryption-li><a href=/altinity-kb-setup-and-maintenance/disk_encryption/ title="ClickHouse® data/disk encryption (at rest)" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancedisk_encryption><span>disk encryption</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancedr-two-dc-li><a href=/altinity-kb-setup-and-maintenance/dr-two-dc/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancedr-two-dc><span>DR two DC</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealters-li><a href=/altinity-kb-setup-and-maintenance/alters/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealters><span>How ALTERs work in ClickHouse®</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancehow_to_recreate_table-li><a href=/altinity-kb-setup-and-maintenance/how_to_recreate_table/ title="How to recreate a table in case of total corruption of the replication queue" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancehow_to_recreate_table><span>How to recreate a table</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancehttp_handlers-li><a href=/altinity-kb-setup-and-maintenance/http_handlers/ title="http handler example" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancehttp_handlers><span>http_handlers</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancejemalloc_heap_profiling-li><a href=/altinity-kb-setup-and-maintenance/jemalloc_heap_profiling/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancejemalloc_heap_profiling><span>Jemalloc heap profiling</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancelogging-li><a href=/altinity-kb-setup-and-maintenance/logging/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancelogging><span>Logging</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceprecreate_parts_using_clickhouse_localsh-li><a href=/altinity-kb-setup-and-maintenance/precreate_parts_using_clickhouse_local.sh/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceprecreate_parts_using_clickhouse_localsh><span>Precreate parts using clickhouse-local</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancerecovery-after-complete-data-loss-li><a href=/altinity-kb-setup-and-maintenance/recovery-after-complete-data-loss/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancerecovery-after-complete-data-loss><span>Recovery after complete data loss</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancechange-me-li><a href=/altinity-kb-setup-and-maintenance/change-me/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancechange-me><span>Replication: Can not resolve host of another ClickHouse® server</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancesource-pars-size-is-greater-than-maximum-li><a href=/altinity-kb-setup-and-maintenance/source-pars-size-is-greater-than-maximum/ title="source parts size is greater than the current maximum" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancesource-pars-size-is-greater-than-maximum><span>source parts sizeis greater than the current maximum</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceclickhouse-deployment-plan-li><a href=/altinity-kb-setup-and-maintenance/clickhouse-deployment-plan/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceclickhouse-deployment-plan><span>Successful ClickHouse® deployment plan</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancesysall-li><a href=/altinity-kb-setup-and-maintenance/sysall/ title="sysall database (system tables on a cluster level)" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancesysall><span>sysall database</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancetimeouts-during-optimize-final-li><a href=/altinity-kb-setup-and-maintenance/timeouts-during-optimize-final/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancetimeouts-during-optimize-final><span>Timeouts during OPTIMIZE FINAL</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceexecutable-dictionary-li><a href=/altinity-kb-setup-and-maintenance/executable-dictionary/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceexecutable-dictionary><span>Use an executable dictionary as cron task</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceuseful-setting-to-turn-on-li><a href=/altinity-kb-setup-and-maintenance/useful-setting-to-turn-on/ title="Useful settings to turn on/Defaults that should be reconsidered" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceuseful-setting-to-turn-on><span>Useful settings to turn on</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancewho-ate-my-cpu-li><a href=/altinity-kb-setup-and-maintenance/who-ate-my-cpu/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancewho-ate-my-cpu><span>Who ate my CPU</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancezookeeper-session-expired-li><a href=/altinity-kb-setup-and-maintenance/zookeeper-session-expired/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancezookeeper-session-expired><span>Zookeeper session has expired</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-server-config-files-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-server-config-files/ title="Server configuration files" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-server-config-files><span>Server config files</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-aggressive_merges-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-aggressive_merges/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-aggressive_merges><span>Aggressive merges</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceclickhouse-backup-li><a href=/altinity-kb-setup-and-maintenance/clickhouse-backup/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceclickhouse-backup><span>Altinity Backup for ClickHouse®</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-packaging-compatibility-greater-than-21x-and-earlier-li><a href=/altinity-kb-setup-and-maintenance/altinity-packaging-compatibility-greater-than-21.x-and-earlier/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-packaging-compatibility-greater-than-21x-and-earlier><span>Altinity packaging compatibility >21.x and earlier</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceaws-ec2-storage-li><a href=/altinity-kb-setup-and-maintenance/aws-ec2-storage/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceaws-ec2-storage><span>AWS EC2 Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-clickhouse-in-docker-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-clickhouse-in-docker/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-clickhouse-in-docker><span>ClickHouse® in Docker</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-monitoring-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-monitoring/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-monitoring><span>ClickHouse® Monitoring</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceclickhouse-versions-li><a href=/altinity-kb-setup-and-maintenance/clickhouse-versions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceclickhouse-versions><span>ClickHouse® versions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceconfigure_clickhouse_for_low_mem_envs-li><a href=/altinity-kb-setup-and-maintenance/configure_clickhouse_for_low_mem_envs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceconfigure_clickhouse_for_low_mem_envs><span>Configure ClickHouse® for low memory environments</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-converting-mergetree-to-replicated-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-converting-mergetree-to-replicated/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-converting-mergetree-to-replicated><span>Converting MergeTree to Replicated</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migration-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migration><span>Data Migration</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationmssql-clickhouse-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/mssql-clickhouse/ title="MSSQL bcp pipe to clickhouse-client" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationmssql-clickhouse><span>Export from MSSQL to ClickHouse®</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationadd_remove_replica-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/add_remove_replica/ title="Add/Remove a new replica to a ClickHouse® cluster" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationadd_remove_replica><span>add_remove_replica</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationaltinity-kb-clickhouse-copier-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/altinity-kb-clickhouse-copier/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationaltinity-kb-clickhouse-copier><span>clickhouse-copier</span></a><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationaltinity-kb-clickhouse-copieraltinity-kb-clickhouse-copier-203-and-earlier-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/altinity-kb-clickhouse-copier/altinity-kb-clickhouse-copier-20.3-and-earlier/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationaltinity-kb-clickhouse-copieraltinity-kb-clickhouse-copier-203-and-earlier><span>clickhouse-copier 20.3 and earlier</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationaltinity-kb-clickhouse-copieraltinity-kb-clickhouse-copier-204_216-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/altinity-kb-clickhouse-copier/altinity-kb-clickhouse-copier-20.4_21.6/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationaltinity-kb-clickhouse-copieraltinity-kb-clickhouse-copier-204_216><span>clickhouse-copier 20.4 - 21.6</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationaltinity-kb-clickhouse-copieraltinity-kb-clickhouse-copier-kubernetes-job-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/altinity-kb-clickhouse-copier/altinity-kb-clickhouse-copier-kubernetes-job/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationaltinity-kb-clickhouse-copieraltinity-kb-clickhouse-copier-kubernetes-job><span>Kubernetes job for clickhouse-copier</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationdistributed-table-cluster-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/distributed-table-cluster/ title="Distributed table to ClickHouse® Cluster" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationdistributed-table-cluster><span>Distributed table to cluster</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationfetch_alter_table-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/fetch_alter_table/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationfetch_alter_table><span>Fetch Alter Table</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationremote-table-function-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/remote-table-function/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationremote-table-function><span>Remote table function</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationrsync-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-data-migration/rsync/ title="Moving ClickHouse to Another Server" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-data-migrationrsync><span>rsync</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-ddlworker-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-ddlworker/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-setup-and-maintenancealtinity-kb-ddlworker><span>DDLWorker and DDL queue problems</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-ddlworkerthere-are-n-unfinished-hosts-0-of-them-are-currently-active-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-ddlworker/there-are-n-unfinished-hosts-0-of-them-are-currently-active/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-ddlworkerthere-are-n-unfinished-hosts-0-of-them-are-currently-active><span>There are N unfinished hosts (0 of them are currently active).</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceclickhouse-backup-diff-li><a href=/altinity-kb-setup-and-maintenance/clickhouse-backup-diff/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceclickhouse-backup-diff><span>differential backups using clickhouse-backup</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancehigh-cpu-usage-li><a href=/altinity-kb-setup-and-maintenance/high-cpu-usage/ title="High CPU usage in ClickHouse®" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancehigh-cpu-usage><span>High CPU usage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenanceload-balancers-li><a href=/altinity-kb-setup-and-maintenance/load-balancers/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenanceload-balancers><span>Load balancers</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-memory-configuration-settings-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-memory-configuration-settings/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-memory-configuration-settings><span>memory configuration settings</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-memory-overcommit-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-memory-overcommit/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-memory-overcommit><span>Memory Overcommiter</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-moving-table-to-another-device-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-moving-table-to-another-device./ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-moving-table-to-another-device><span>Moving a table to another device</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-setup-and-maintenancealtinity-kb-object-consistency-in-a-cluster-li><a href=/altinity-kb-setup-and-maintenance/altinity-kb-object-consistency-in-a-cluster/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-setup-and-maintenancealtinity-kb-object-consistency-in-a-cluster><span>Object consistency in a cluster</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-altinity-kb-useful-queries-li><a href=/altinity-kb-useful-queries/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-useful-queries><span>Useful queries</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriestable-meta-in-zookeeper-li><a href=/altinity-kb-useful-queries/table-meta-in-zookeeper/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriestable-meta-in-zookeeper><span>Check table metadata in zookeeper</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriescompare_query_log_for_2_intervals-li><a href=/altinity-kb-useful-queries/compare_query_log_for_2_intervals/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriescompare_query_log_for_2_intervals><span>Compare query_log for 2 intervals</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriesdebug-hang-li><a href=/altinity-kb-useful-queries/debug-hang/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriesdebug-hang><span>Debug hanging thing</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriesquery_log-li><a href=/altinity-kb-useful-queries/query_log/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriesquery_log><span>Handy queries for system.query_log</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriesingestion-rate-part_log-li><a href=/altinity-kb-useful-queries/ingestion-rate-part_log/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriesingestion-rate-part_log><span>Ingestion metrics from system.part_log</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriesremove_unneeded_block_numbers-li><a href=/altinity-kb-useful-queries/remove_unneeded_block_numbers/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriesremove_unneeded_block_numbers><span>Remove block numbers from zookeeper for removed partitions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriesremove_empty_partitions_from_rq-li><a href=/altinity-kb-useful-queries/remove_empty_partitions_from_rq/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriesremove_empty_partitions_from_rq><span>Removing tasks in the replication queue related to empty partitions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriesdetached-parts-li><a href=/altinity-kb-useful-queries/detached-parts/ title="Can detached parts in ClickHouse® be dropped?" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriesdetached-parts><span>Can detached parts be dropped?</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriesaltinity-kb-database-size-table-column-size-li><a href=/altinity-kb-useful-queries/altinity-kb-database-size-table-column-size/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriesaltinity-kb-database-size-table-column-size><span>Database Size - Table - Column size</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriesconnection-issues-distributed-parts-li><a href=/altinity-kb-useful-queries/connection-issues-distributed-parts/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriesconnection-issues-distributed-parts><span>Notes on Various Errors with respect to replication and distributed connections</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriesaltinity-kb-number-of-active-parts-in-a-partition-li><a href=/altinity-kb-useful-queries/altinity-kb-number-of-active-parts-in-a-partition/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriesaltinity-kb-number-of-active-parts-in-a-partition><span>Number of active parts in a partition</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-useful-queriesparts-consistency-li><a href=/altinity-kb-useful-queries/parts-consistency/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-useful-queriesparts-consistency><span>Parts consistency</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-altinity-kb-schema-design-li><a href=/altinity-kb-schema-design/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-schema-design><span>Schema design</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designhow-much-is-too-much-li><a href=/altinity-kb-schema-design/how-much-is-too-much/ title="ClickHouse® limitations" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designhow-much-is-too-much><span>ClickHouse limitations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designrow-level-deduplication-li><a href=/altinity-kb-schema-design/row-level-deduplication/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designrow-level-deduplication><span>ClickHouse® row-level deduplication</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designbackfill_column-li><a href=/altinity-kb-schema-design/backfill_column/ title="Column backfilling with alter/update using a dictionary" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designbackfill_column><span>Column backfilling from dictionary</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designuniq-functions-li><a href=/altinity-kb-schema-design/uniq-functions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designuniq-functions><span>Functions to count uniqs</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designchange-order-by-li><a href=/altinity-kb-schema-design/change-order-by/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designchange-order-by><span>How to change ORDER BY</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designingestion-aggregate-function-li><a href=/altinity-kb-schema-design/ingestion-aggregate-function/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designingestion-aggregate-function><span>Ingestion of AggregateFunction</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designinsert_deduplication-li><a href=/altinity-kb-schema-design/insert_deduplication/ title="Insert Deduplication / Insert Idempotency" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designinsert_deduplication><span>insert deduplication</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designaltinity-kb-jsoneachrow-tuples-and-mvs-li><a href=/altinity-kb-schema-design/altinity-kb-jsoneachrow-tuples-and-mvs/ title="JSONEachRow, Tuples, Maps and Materialized Views" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designaltinity-kb-jsoneachrow-tuples-and-mvs><span>JSONEachRow, tuple, map and MVs</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designpreaggregations-li><a href=/altinity-kb-schema-design/preaggregations/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designpreaggregations><span>Pre-Aggregation approaches</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designsnowflakeid-li><a href=/altinity-kb-schema-design/snowflakeid/ title="SnowflakeID for Efficient Primary Keys " class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designsnowflakeid><span>SnowflakeID</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designtwo-columns-indexing-li><a href=/altinity-kb-schema-design/two-columns-indexing/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designtwo-columns-indexing><span>Two columns indexing</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designbest-schema-for-storing-many-metrics-registered-from-the-single-source-li><a href=/altinity-kb-schema-design/best-schema-for-storing-many-metrics-registered-from-the-single-source/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designbest-schema-for-storing-many-metrics-registered-from-the-single-source><span>Best schema for storing many metrics registered from the single source</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-schema-designcodecs-li><a href=/altinity-kb-schema-design/codecs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-schema-designcodecs><span>Codecs</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designcodecscodecs-on-array-columns-li><a href=/altinity-kb-schema-design/codecs/codecs-on-array-columns/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designcodecscodecs-on-array-columns><span>Codecs on array columns</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designcodecscodecs-speed-li><a href=/altinity-kb-schema-design/codecs/codecs-speed/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designcodecscodecs-speed><span>Codecs speed</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designcodecsaltinity-kb-how-to-test-different-compression-codecs-li><a href=/altinity-kb-schema-design/codecs/altinity-kb-how-to-test-different-compression-codecs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designcodecsaltinity-kb-how-to-test-different-compression-codecs><span>How to test different compression codecs</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designaltinity-kb-dictionaries-vs-lowcardinality-li><a href=/altinity-kb-schema-design/altinity-kb-dictionaries-vs-lowcardinality/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designaltinity-kb-dictionaries-vs-lowcardinality><span>Dictionaries vs LowCardinality</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designflattened-table-li><a href=/altinity-kb-schema-design/flattened-table/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designflattened-table><span>Flattened table</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designfloats-vs-decimals-li><a href=/altinity-kb-schema-design/floats-vs-decimals/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designfloats-vs-decimals><span>Floats vs Decimals</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designingestion-performance-and-formats-li><a href=/altinity-kb-schema-design/ingestion-performance-and-formats/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designingestion-performance-and-formats><span>Ingestion performance and formats</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designhow-to-store-ips-li><a href=/altinity-kb-schema-design/how-to-store-ips/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designhow-to-store-ips><span>IPs/masks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designaltinity-kb-jsonasstring-and-mat-view-as-json-parser-li><a href=/altinity-kb-schema-design/altinity-kb-jsonasstring-and-mat.-view-as-json-parser/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designaltinity-kb-jsonasstring-and-mat-view-as-json-parser><span>JSONAsString and Mat. View as JSON parser</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designlowcardinality-li><a href=/altinity-kb-schema-design/lowcardinality/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designlowcardinality><span>LowCardinality</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-altinity-kb-schema-designmaterialized-views-li><a href=/altinity-kb-schema-design/materialized-views/ title="ClickHouse® Materialized Views" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-schema-designmaterialized-views><span>Materialized Views</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designmaterialized-viewsidempotent_inserts_mv-li><a href=/altinity-kb-schema-design/materialized-views/idempotent_inserts_mv/ title="Idempotent inserts into a materialized view" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designmaterialized-viewsidempotent_inserts_mv><span>Idempotent insert MV</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-schema-designmaterialized-viewsbackfill-populate-mv-in-a-controlled-manner-li><a href=/altinity-kb-schema-design/materialized-views/backfill-populate-mv-in-a-controlled-manner/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-schema-designmaterialized-viewsbackfill-populate-mv-in-a-controlled-manner><span>Backfill/populate MV in a controlled manner</span></a></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-altinity-kb-kubernetes-li><a href=/altinity-kb-kubernetes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-kubernetes><span>Using the Altinity Kubernetes Operator for ClickHouse®</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-kubernetesaltinity-kb-istio-user-issue-k8s-li><a href=/altinity-kb-kubernetes/altinity-kb-istio-user-issue-k8s/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-kubernetesaltinity-kb-istio-user-issue-k8s><span>Istio Issues</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-altinity-kb-interfaces-li><a href=/altinity-kb-interfaces/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-interfaces><span>Interfaces</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-interfacesaltinity-kb-clickhouse-client-li><a href=/altinity-kb-interfaces/altinity-kb-clickhouse-client/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-interfacesaltinity-kb-clickhouse-client><span>clickhouse-client</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-upgrade-li><a href=/upgrade/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-upgrade><span>Upgrade</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-upgradevulnerabilities-li><a href=/upgrade/vulnerabilities/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-upgradevulnerabilities><span>Vulnerabilities</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-upgradeclickhouse-feature-report-li><a href=/upgrade/clickhouse-feature-report/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-upgradeclickhouse-feature-report><span>ClickHouse® Function/Engines/Settings Report</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-upgraderemoving-empty-parts-li><a href=/upgrade/removing-empty-parts/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-upgraderemoving-empty-parts><span>Removing empty parts</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-upgraderemoving-lost-parts-li><a href=/upgrade/removing-lost-parts/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-upgraderemoving-lost-parts><span>Removing lost parts</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-altinity-kb-dictionaries-li><a href=/altinity-kb-dictionaries/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-altinity-kb-dictionaries><span>Dictionaries</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-dictionariesdictionaries-and-arrays-li><a href=/altinity-kb-dictionaries/dictionaries-and-arrays/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-dictionariesdictionaries-and-arrays><span>Dictionaries & arrays</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-dictionariesdictionary-on-top-tables-li><a href=/altinity-kb-dictionaries/dictionary-on-top-tables/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-dictionariesdictionary-on-top-tables><span>Dictionary on the top of several tables using VIEW</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-dictionariesdimension_table_desing-li><a href=/altinity-kb-dictionaries/dimension_table_desing/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-dictionariesdimension_table_desing><span>Dimension table design</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-dictionariesexample-of-postgresql-dictionary-li><a href=/altinity-kb-dictionaries/example-of-postgresql-dictionary/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-dictionariesexample-of-postgresql-dictionary><span>Example of PostgreSQL dictionary</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-dictionariesmysql8-source-for-dictionaries-li><a href=/altinity-kb-dictionaries/mysql8-source-for-dictionaries/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-dictionariesmysql8-source-for-dictionaries><span>MySQL8 source for dictionaries</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-dictionariespartial-updates-li><a href=/altinity-kb-dictionaries/partial-updates/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-dictionariespartial-updates><span>Partial updates</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-dictionariesaltinity-kb-range_hashed-example-open-intervals-li><a href=/altinity-kb-dictionaries/altinity-kb-range_hashed-example-open-intervals/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-dictionariesaltinity-kb-range_hashed-example-open-intervals><span>range_hashed example - open intervals</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-dictionariessecurity-named-collections-li><a href=/altinity-kb-dictionaries/security-named-collections/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-dictionariessecurity-named-collections><span>Security named collections</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-altinity-kb-dictionariesaltinity-kb-sparse_hashed-vs-hashed-li><a href=/altinity-kb-dictionaries/altinity-kb-sparse_hashed-vs-hashed/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-altinity-kb-dictionariesaltinity-kb-sparse_hashed-vs-hashed><span>SPARSE_HASHED VS HASHED vs HASHED_ARRAY</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-using-this-knowledgebase-li><a href=/using-this-knowledgebase/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-using-this-knowledgebase><span>Using This Knowledge Base</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-using-this-knowledgebasemermaid_example-li><a href=/using-this-knowledgebase/mermaid_example/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-using-this-knowledgebasemermaid_example><span>Mermaid Example</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-upgrade_ebook-li><a href=https://hubs.la/Q03ccpmq0 title="Upgrade eBook" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-upgrade_ebook><span>ClickHouse® Upgrade eBook</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-maintenance_ebook-li><a href=https://hubs.la/Q03ccp610 class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-maintenance_ebook><span>ClickHouse Cluster Maintenance eBook</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-search-li><a href=/search/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-search><span></span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.21b07d7fe134d30ffa62ff06d762b6b9.json data-offline-search-base-href=/ data-offline-search-max-results=10></div><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/Altinity/altinityknowledgebase/edit/main/content/en/engines/mergetree-table-engine-family/versioned-collapsing-mergetree.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/Altinity/altinityknowledgebase/new/main/content/en/engines/mergetree-table-engine-family/versioned-collapsing-mergetree.md?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/Altinity/altinityknowledgebase/issues/new?title=/engines/mergetree-table-engine-family/versioned-collapsing-mergetree/" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a id=print href=http://kb.altinity.com/engines/mergetree-table-engine-family/printview/><i class="fa fa-print fa-fw"></i> Print entire section</a></div><nav id=TableOfContents><ul><li><ul><li><a href=#challenges-with-mutated-data>Challenges with mutated data</a></li><li><a href=#collapsing>Collapsing</a></li><li><a href=#replace-data-in-another-partition>Replace data in another partition</a></li><li><a href=#row-deduplication>Row deduplication</a></li><li><a href=#getting-old-row>Getting old row</a></li><li><a href=#upsert-by-collapsing>UPSERT by Collapsing</a></li><li><a href=#speed-test>Speed Test</a></li><li><a href=#adding-projections>Adding projections</a></li><li><a href=#deletes-inaccuracy>DELETEs inaccuracy</a></li><li><a href=#combine-old-and-new>Combine old and new</a></li><li><a href=#complex-primary-key>Complex Primary Key</a></li><li><a href=#sharding>Sharding</a></li></ul></li></ul></nav><div style=color:#888;line-height:.5></div><div style=font-size:small;color:#000;font-style:normal;background-color:#eee;padding:15px>Altinity®, Altinity.Cloud®, and Altinity Stable® are registered trademarks of Altinity, Inc. ClickHouse® is a registered trademark of ClickHouse, Inc.; Altinity is not affiliated with or associated with ClickHouse, Inc.</div><div style=font-size:medium;font-style:normal;padding:15px><span style=font-size:24px;font-weight:700;color:#199dd0>Project Antalya</span><br>Build Real‑Time Data Lakes with ClickHouse® and Apache Iceberg<br><a href=https://altinity.com/project-antalya-real-time-data-lakes/><span style=font-style:italic;font-weight:700;color:#199dd0>Learn more</span></a></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/engines/>Engines</a></li><li class=breadcrumb-item><a href=/engines/mergetree-table-engine-family/>MergeTree table engine family</a></li><li class="breadcrumb-item active" aria-current=page>VersionedCollapsingMT</li></ol></nav><div class=td-content><h1>UPSERT by VersionedCollapsingMergeTree</h1><div class=lead>How to aggregate mutating event stream with duplicates</div><h3 id=challenges-with-mutated-data>Challenges with mutated data</h3><p>When you have an incoming event stream with duplicates, updates, and deletes, building a consistent row state inside the ClickHouse® table is a big challenge.</p><p>The UPDATE/DELETE approach in the OLTP world won’t help with OLAP databases tuned to handle big batches. UPDATE/DELETE operations in ClickHouse are executed as “mutations,” rewriting a lot of data and being relatively slow. You can’t run such operations very often, as for OLTP databases. But the UPSERT operation (insert and replace) runs fast with the ReplacingMergeTree Engine. It’s even set as the default mode for INSERT without any special keyword. We can emulate UPDATE (or even DELETE) with the UPSERT operation.</p><p>There are a lot of <a href=https://altinity.com/blog/clickhouse-replacingmergetree-explained-the-good-the-bad-and-the-ugly target=_blank>blog posts</a>
on how to use ReplacingMergeTree Engine to handle mutated data streams. A properly designed table schema with ReplacingMergeTree Engine is a good instrument for building the DWH Dimensions table. But when maintaining metrics in Fact tables, there are several problems:</p><ul><li>it’s not possible to use a valuable ClickHouse feature - online aggregation of incoming data by Materialized Views or Projections on top of the ReplacingMT table, because duplicates and updates will not be deduplicated by the engine during inserts, and calculated aggregates (like sum or count) will be incorrect. For significant amounts of data, it’s become critical because aggregating raw data during report queries will take too much time.</li><li>unfinished support for DELETEs. While in the newest versions of ClickHouse, it’s possible to add the is_deleted to ReplacingMergeTree parameters, the necessity of manually filtering out deleted rows after FINAL processing makes that feature less useful.</li><li>Mutated data should be localized to the same partition. If the “replacing” row is saved to a partition different from the previous one, the report query will be much slower or produce unexpected results.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- multiple partitions problem
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RMT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>someCol</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>eventTime</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplacingMergeTree</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toYYYYMM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>eventTime</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RMT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;first&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2024-04-25T10:16:21&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RMT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;second&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2024-05-02T08:36:59&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>with</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>merged</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RMT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>merged</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eventTime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2024-05-01&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>You will get a row with ‘first’, not an empty set, as one might expect with the FINAL processing of a whole table.</p><h3 id=collapsing>Collapsing</h3><p>ClickHouse has other table engines, such as CollapsingMergeTree and VersionedCollapsingMergeTree, that can be used even better for UPSERT operation.</p><p>Both work by inserting a “rollback row” to compensate for the previous insert. The difference between CollapsingMergeTree and VersionedCollapsingMergeTree is in the algorithm of collapsing. For Cluster configurations, it’s essential to understand which row came first and who should replace whom. That is why using ReplicatedVersionedCollapsingMergeTree is mandatory for Replicated Clusters.</p><p>When dealing with such complicated data streams, it needs to be solved 3 tasks simultaneously:</p><ul><li>remove duplicates</li><li>process updates and deletes</li><li>calculate correct aggregates</li></ul><p>It’s essential to understand how the collapsing algorithm of VersionedCollapsingMergeTree works. Quote from the <a href=https://clickhouse.com/docs/en/operations/settings/settings#max-insert-threads target=_blank rel=nofollow>documentation</a>
:</p><blockquote><p>When ClickHouse merges data parts, it deletes each pair of rows that have the same primary key and version and different Sign. The order of rows does not matter.</p></blockquote><p>The version column should increase over time. You may use a natural timestamp for that. Random-generated IDs are not suitable for the version column.</p><h3 id=replace-data-in-another-partition>Replace data in another partition</h3><p>Let’s first fix the problem with mutated data in a different partition.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>VCMT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>someCol</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>eventTime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Int8</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>VersionedCollapsingMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>eventTime</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toYYYYMM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>eventTime</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>VCMT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;first&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2024-04-25 10:16:21&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>VCMT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;first&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2024-04-25 10:16:21&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;second&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2024-05-02 08:36:59&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>do_not_merge_across_partitions_select_final</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- for fast FINAL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;no rows after:&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>with</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>merged</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>VCMT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>merged</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eventTime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2024-05-01&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>With VersionedCollapsingMergeTree, we can use more partition strategies, even with columns not tied to the row’s primary key. This could facilitate the creation of faster queries, more convenient TTLs (Time-To-Live), and backups.</p><h3 id=row-deduplication>Row deduplication</h3><p>There are several ways to remove duplicates from the event stream. The most effective feature is block deduplication, which occurs when ClickHouse drops incoming blocks with the same checksum (or tag). However, this requires building a smart ingestor capable of saving positions in a transactional manner.</p><p>However, another method is possible: verifying whether a particular row already exists in the destination table to avoid redundant insertions. Together with block deduplication, that method also avoids using ReplacingMergeTree and FINAL during query time.</p><p>Ensuring accuracy and consistency in results requires executing this process on a single thread within one cluster node. This method is particularly suitable for less active event streams, such as those with up to 100,000 events per second. To boost performance, incoming streams should be segmented into several partitions (or &lsquo;shards&rsquo;) based on the table/event&rsquo;s Primary Key, with each partition processed on a single thread.</p><p>An example of row deduplication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MergeTree</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example1Null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>materialized</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>view</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__Example1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example1Null</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example1Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Here is the trick:</p><ul><li>use Null table and MatView to be able to access both the insert block and the dest table</li><li>check the existence of IDs in the destination table with a fast index scan by a primary key using the IN operator</li><li>filter existing rows from insert block by NOT IN operator</li></ul><p>In most cases, the insert block does not have too many rows (like 1000-100k), so checking the destination table for their existence by scanning the Primary Key (residing in memory) won’t take much time. However, due to the high table index granularity, it can still be noticeable on high load. To enhance performance, consider reducing index granularity to 4096 (from the default 8192) or even fewer values.</p><h3 id=getting-old-row>Getting old row</h3><p>To process updates in CollapsingMergeTree, the &rsquo;last row state&rsquo; must be known before inserting the &lsquo;compensation row.&rsquo; Sometimes, this is possible - CDC events coming from MySQL’s binlog or Postgres’s WAL contain not only &rsquo;new&rsquo; data but also &lsquo;old&rsquo; values. If one of the columns includes a sequence-generated version or timestamp of the row’s update time, it can be used as the row’s &lsquo;version&rsquo; for VersionedCollapsingMergeTree. When the incoming event stream lacks old metric values and suitable version information, we can retrieve that data by examining the ClickHouse table using the same method used for row deduplication in the previous example.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Int8</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CollapsingMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example2Null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example2</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>materialized</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>view</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__Example2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>with</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>([</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>])</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example2Null</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#ce5c00;font-weight:700>=-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example2Null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_new</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>join</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>I read more data from the Example2 table than from Example1. Instead of simply checking the row existence by the IN operator, a JOIN with existing rows is used to build a “compensate row.”</p><p>For UPSERT, the collapsing algorithm requires inserting two rows. So, I need to create two rows from any row that is found in the local table. It´s an essential part of the suggested approach, which allows me to produce proper rows for inserting with a human-readable code with clear if() statements. That is why I execute arrayJoin while reading old data.</p><p>Don’t try to run the code above. It’s just a short explanation of the idea, lacking many needed elements.</p><h3 id=upsert-by-collapsing>UPSERT by Collapsing</h3><p>Here is a more realistic <a href=https://fiddle.clickhouse.com/babb6069-f629-4f6b-be2c-be51c9f0aa9b target=_blank rel=nofollow>example</a>
with more checks that can be played with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#000>Int32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>   
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metric1</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metric2</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>UInt64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87>Int8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>VersionedCollapsingMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>materialized</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>view</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3Transform</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>with</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>([</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>])</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                 </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#000>PREWHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                 </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>left</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>join</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>=-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#8f5902;font-style:italic>-- insert only delete row if it&#39;s found in old data
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- skip duplicates for updates
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- original
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;step1&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- no duplicates (with the same version) inserted
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>),(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;step2&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- delete a row with id=2. version for delete row does not have any meaning
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;step3&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- replace a row with id=1. row with sign=-1 not needed, but can be in the insert blocks (will be skipped)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>),(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;step4&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Important additions:</p><ul><li>When multiple events with the same ID and different versions are received in the one insert batch, the most recent event is applied.</li><li>“delete rows” with sign=-1 and the wrong version are not used for processing. For the Collapsing algorithm, the delete row version should match the version from the row stored in the local table, not the same version from the replacing row. That’s why I decided to skip such a “delete row” received from the incoming stream and build it from the table’s data.</li><li>using FINAL and PREWHERE (to speed up FINAL) while reading the destination table. PREWHERE filters are applied before FINAL processing, reducing the number of grouped rows.</li><li>filter to skip out-of-order events by checking the version</li><li>DELETE event processing (inside last WHERE)</li></ul><h3 id=speed-test>Speed Test</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow_experimental_analyzer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#000>Int32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metric1</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metric2</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>Float32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>UInt64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87>Int8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>VersionedCollapsingMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4096</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>do_not_merge_across_partitions_select_final</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- make 100M table
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;HR&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Finance&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Engineering&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Sales&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Marketing&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>E8</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>function</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeSpent</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>date_diff</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;millisecond&#39;</span><span style=color:#000;font-weight:700>,(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#000;font-weight:700>),</span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- measure plain INSERT time for 1M batch
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>temporary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;HR&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Finance&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Engineering&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Sales&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Marketing&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>E6</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;INSERT&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--create table Stage engine=MergeTree order by id as Example3 ;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>materialized</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>view</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3Transform</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>with</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000>__old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>([</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>])</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#000>PREWHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                                                                                  </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>left</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>join</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>=-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#8f5902;font-style:italic>-- insert only delete row if it&#39;s found in old data
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- skip duplicates for updates
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- calculate UPSERT time for 1M batch
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>temporary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>E6</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>--number AS id,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;HR&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Finance&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Engineering&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Sales&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Marketing&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>E6</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;UPSERT&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- FINAL query
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>temporary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;FINAL&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- GROUP BY query
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>temporary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;GROUP BY&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>optimize</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- FINAL query
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>temporary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;FINAL OPTIMIZED&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- GROUP BY query
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>temporary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;GROUP BY OPTIMIZED&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>You can use fiddle or <code>clickhouse-local</code> to run such a test:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat test.sql <span style=color:#000;font-weight:700>|</span> clickhouse-local -nm
</span></span></code></pre></div><p>Results (Mac A2 Pro), milliseconds:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	252	INSERT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	1710	UPSERT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	763	FINAL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	311	GROUP BY
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	314	FINAL OPTIMIZED
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	295	GROUP BY OPTIMIZED
</span></span></span></code></pre></div><p>UPSERT is six times slower than direct INSERT because it requires looking up the destination table. That is the price. It is better to use idempotent inserts with an exactly-once delivery guarantee. However, it’s not always possible.</p><p>The FINAL speed is quite good, especially if we split the table by 20 partitions, use <code>do_not_merge_across_partitions_select_final</code> setting, and keep most of the table’s partitions optimized (1 part per partition). But we can do it better.</p><h3 id=adding-projections>Adding projections</h3><p>Let&rsquo;s add an aggregating projection, and also add a more useful <code>updated_at</code> timestamp instead of an abstract <code>_version</code> and replace <code>String</code> for Department dimension by LowCardinality(String). Let’s look at the difference in time execution.</p><p><a href=https://fiddle.clickhouse.com/3140d341-ccc5-4f57-8fbf-55dbf4883a21 target=_blank rel=nofollow>https://fiddle.clickhouse.com/3140d341-ccc5-4f57-8fbf-55dbf4883a21</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow_experimental_analyzer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#000>Int32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>LowCardinality</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metric1</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>Int32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metric2</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>Float32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>DateTime64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87>Int8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>VersionedCollapsingMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>partition</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_granularity</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4096</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>do_not_merge_across_partitions_select_final</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- make 100M table
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;HR&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Finance&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Engineering&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Sales&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Marketing&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>E8</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>temporary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>function</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeSpent</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>date_diff</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;millisecond&#39;</span><span style=color:#000;font-weight:700>,(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#000;font-weight:700>),</span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- measure plain INSERT time for 1M batch
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;HR&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Finance&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Engineering&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Sales&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Marketing&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>E6</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;INSERT&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--create table Stage engine=MergeTree order by id as Example4 ;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>materialized</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>view</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4Transform</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>with</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000>__old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>([</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>])</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#000>PREWHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                                                                                    </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>left</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>join</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>=-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#8f5902;font-style:italic>-- insert only delete row if it&#39;s found in old data
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- skip duplicates for updates
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- calculate UPSERT time for 1M batch
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>E6</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>--number AS id,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;HR&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Finance&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Engineering&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Sales&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Marketing&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>E6</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;UPSERT&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- FINAL query
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;FINAL&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- GROUP BY query
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;GROUP BY&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--select &#39;--parts1&#39;,partition, count() from system.parts where active and table=&#39;Example4&#39;  group by partition;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>optimize</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;OPTIMIZE&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- FINAL OPTIMIZED
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;FINAL OPTIMIZED&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- GROUP BY OPTIMIZED
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;GROUP BY OPTIMIZED&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--  UPSERT a little data to create more parts
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;HR&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Finance&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Engineering&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Sales&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Marketing&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--select &#39;--parts2&#39;,partition, count() from system.parts where active and table=&#39;Example4&#39; group by partition;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- GROUP BY SEMI-OPTIMIZED
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;GROUP BY SEMI-OPTIMIZED&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--alter table Example4 add column Smetric1 Int32 alias metric1*sign;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>add</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>projection</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>byDep</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Materialize Projection
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>materialize</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>projection</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>byDep</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mutations_sync</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;Materialize Projection&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- GROUP BY query Projected
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timeMark</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>force_optimize_projection</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>format</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;---&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>timeSpent</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#39;GROUP BY Projected&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Results (Mac A2 Pro), milliseconds:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	175	INSERT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	1613	UPSERT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	329	FINAL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	102	GROUP BY
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	10498	OPTIMIZE
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	103	FINAL OPTIMIZED
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	90	GROUP BY OPTIMIZED
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	94	GROUP BY SEMI-OPTIMIZED
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	919	Materialize Projection
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>---	5	GROUP BY Projected
</span></span></span></code></pre></div><p>Some thoughts:</p><ul><li>INSERT, UPSERT, and SELECT benefit from switching the Department column to LowCardinality. Fewer reads - faster queries.</li><li>OPTIMIZE is VERY expensive</li><li>FINAL is quite fast (especially for the OPTIMIZED table). You don’t need to OPTIMIZE the table till the 1 part for partition to remove FINAL from the query. Not having too many parts already gives you a performance boost.</li><li>GROUP BY for that task is still faster</li><li>projections building requires resources. Inserts to the table with Projections will be longer. Tune the insert timeouts.</li><li>Query over projection is very fast (as it should be). However, it’s not always possible to aggregate data in such a simple way.</li></ul><h3 id=deletes-inaccuracy>DELETEs inaccuracy</h3><p>The typical CDC event for DWH systems besides INSERT is UPSERT—a new row replaces the old one (with suitable aggregate corrections). But DELETE events are also supported (ones with column sign=-1). The Materialized View described above will correctly process the DELETE event by inserting only 1 row with sign=-1 if a row with a particular ID already exists in the table. In such cases, VersionedCollapsingMergeTree will wipe both rows (with sign=1 & -1) during merge or final operations.</p><p>However, it can lead to incorrect duplicate processing in some rare situations. Here is the scenario:</p><ul><li>two events happen in the source database (insert and delete) for the very same ID</li><li>only insert event create a duplicate (delete event does not duplicate)</li><li>all 3 events (delete and two inserts) were processed in separate batches</li><li>ClickHouse executes the merge operation very quickly after the first INSERT and DELETE events are received, effectively removing the row with that ID from the table</li><li>the second (duplicated) insert is saved to the table because we lost the information about the first insertion</li></ul><p>The probability of such a sequence is relatively low, especially in normal operations when the amount of DELETEs is not too significant. Processing events in big batches will reduce the probability even more.</p><h3 id=combine-old-and-new>Combine old and new</h3><p>The presented technique can be used to reimplement the AggregatingMergeTree algorithm to combine old and new row data using VersionedCollapsingMergeTree.</p><p><a href=https://fiddle.clickhouse.com/e1d7e04c-f1d6-4a25-9aac-1fe2b543c693 target=_blank rel=nofollow>https://fiddle.clickhouse.com/e1d7e04c-f1d6-4a25-9aac-1fe2b543c693</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example5</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#000>Int32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>   
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metric1</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metric2</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>Nullable</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>updated_at</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>DateTime64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87>Int8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>VersionedCollapsingMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>updated_at</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>materialized</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>view</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example5Transform</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>with</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>updated_at</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000>__old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>([</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>])</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                 </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#000>PREWHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                 </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>greatest</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ifNull</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>updated_at</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>updated_at</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>updated_at</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>left</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>join</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>=-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#8f5902;font-style:italic>-- insert only delete row if it&#39;s found in old data
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>updated_at</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>updated_at</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- skip duplicates for updates
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- original
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;step0&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;step1&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;step2&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=complex-primary-key>Complex Primary Key</h3><p>I used a simple, compact column with Int64 type for the primary key in previous examples. It&rsquo;s better to go this route with monotonically growing IDs like autoincrement ID or SnowFlakeId (based on timestamp). However, in some cases, a more complex primary key is needed. For instance, when storing data for multiple tenants (Customers, partners, etc.) in the same table. This is not a problem for the suggested technique - use all the necessary columns in all filters and JOIN operations as Tuple.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example6</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#000>Int64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>  
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>tenant_id</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#000>Int32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metric1</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>UInt64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87>Int8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>VersionedCollapsingMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sign</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tenant_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>materialized</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>view</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example6Transform</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>with</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Stage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tenant_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000>__old</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>arrayJoin</span><span style=color:#000;font-weight:700>([</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>])</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                 </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Example6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>final</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#000>PREWHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tenant_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tenant_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                 </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>tenant_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>left</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>join</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tenant_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sign</span><span style=color:#ce5c00;font-weight:700>=-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_sign</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#8f5902;font-style:italic>-- insert only delete row if it&#39;s found in old data
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>__new</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>__old</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>_version</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- skip duplicates for updates
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=sharding>Sharding</h3><p>The suggested approach works well when inserting data in a single thread on a single replica. This is suitable for up to 1M events per second. However, for higher traffic, it&rsquo;s necessary to use multiple ingesting threads across several replicas. In such cases, collisions caused by parts manipulation and replication delay can disrupt the entire Collapsing algorithm.</p><p>But inserting different shards with a sharding key derived from ID works fine. Every shard will operate with its own non-intersecting set of IDs, and don’t interfere with each other.</p><p>The same approach can be implemented when inserting several threads into the same replica node. For big installations with high traffic and many shards and replicas, the ingesting app can split the data stream into a considerably large number of “virtual shards” (or partitions in Kafka terminology) and then map the “virtual shards” to the threads doing inserts to “physical shards.”</p><p>The incoming stream could be split into several ones by using an expression like <code>cityHash64(id) % 50 = 0</code> as a sharding key. The ingesting app should calculate the shard number before sending data to internal buffers that will be flushed to INSERTs.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- emulate insert into distributed table
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>function</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;localhos{t,t,t}&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>Stage</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>E6</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>--number AS id,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;HR&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Finance&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Engineering&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Sales&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Marketing&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Department</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metric2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>settings</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>prefer_localhost_replica</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=td-page-meta__lastmod>Last modified 2024.11.19: <a href=https://github.com/Altinity/altinityknowledgebase/commit/f471d5c9ffae439fd25cd4284f5cdca70904369d>snowlakeid link (f471d5c)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class="row footer-inner pb-3"><div class=col-12><a href=https://altinity.com target=_blank><img src=/images/general/altinity-logo_horizontal_blue_white.svg width=154 alt=Altinity.com></a></div></div><div class="row footer-inner py-3"><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>PRODUCT</b></li><li class=nav-item><a href=https://altinity.com/managed-clickhouse/ target=_blank>Altinity.Cloud</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-support/ target=_blank>Support for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-training target=_blank>Training for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-pricing/ target=_blank>Altinity.Cloud Pricing</a></li><li class=nav-item><a href=https://altinity.com/plans-and-features-clickhouse/ target=_blank>Altinity Plans and Features</a></li></ul><div class="d-none d-md-block mb-3"><img decoding=async style="width:60px;display:inline-block;margin:0 10px 0 0" src=/images/general/soc.webp alt="SOC Certified"><img decoding=async style=width:60px;display:inline-block;margin:0 src=/images/general/soc2.webp alt="SOC2 TYPE II Certified"></div></div><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>RESOURCES</b></li><li class=nav-item><a href=https://altinity.com/blog target=_blank>Blog</a></li><li class=nav-item><a href=https://docs.altinity.com/ target=_blank>Documentation</a></li><li class=nav-item><a href=https://kb.altinity.com/ target=_blank>Knowledge Base</a></li><li class=nav-item><a href=https://altinity.com/releases target=_blank>Altinity Stable Builds</a></li><li class=nav-item><a href=https://hubs.la/Q02pLTV20 target=_blank>Kubernetes Operator</a></li><li class=nav-item><a href=https://altinity.com/ecosystem/ target=_blank>Altinity Open Source Projects</a></li><li class=nav-item><a href=https://altinity.com/events/ target=_blank>Events</a></li></ul></div><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>COMPANY</b></li><li class=nav-item><a href=https://altinity.com/about-us/ target=_blank>About Altinity</a></li><li class=nav-item><a href=https://altinity.com/about-us/press-releases target=_blank>Press Releases</a></li><li class=nav-item><a href=https://altinity.com/partners/ target=_blank>Partners</a></li><li class=nav-item><a href=https://altinity.com/customer-stories/ target=_blank>Customer Stories</a></li><li class=nav-item><a href=https://altinity.com/careers/ target=_blank>Careers</a></li><li class=nav-item><a href=https://altinity.com/contact/ target=_blank>Contact Us</a></li></ul></div><div class="col-12 col-sm-6 col-md-3">Get the latest ClickHouse news straight to your inbox every month.<br><a href=https://altinity.com/newsletter/ target=_blank class="btn btn-primary my-3" style=border-radius:1.5rem>Sign Up</a></div></div></div><div class="row footer-inner pb-3"><div class="col-12 col-sm-6 text-left text-xs-center py-2"><small class=text-white>&copy; 2025 Altinity Inc. Altinity®, Altinity.Cloud®, and Altinity Stable® are registered trademarks of Altinity, Inc. ClickHouse® is a registered trademark of ClickHouse, Inc.; Altinity is not affiliated with or associated with ClickHouse, Inc. Kafka, Kubernetes, MySQL, and PostgreSQL are trademarks and property of their respective owners. All Rights Reserved</small>
<small class=ml-1><a href=https://altinity.com/privacy-policy/ target=_blank>Privacy Policy</a></small></div><div class="col-12 col-sm-6 text-end text-xs-center"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://altinity.com/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=X aria-label=X><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/AltinityDB><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/company/altinity/><i class="fab fa-linkedin"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.youtube.com/channel/UCE3Y2lDKl_ZfjaCrh62onYA><i class="fab fa-youtube"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/Altinity/altinityknowledgebase><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Reddit aria-label=Reddit><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.reddit.com/r/Clickhouse/><i class="fab fa-reddit"></i></a></li></ul></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-101676615-2"></script><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/4536206.js></script><script type=text/javascript>!function(){var e,t="06536e793668baa",n=function(){Reo.init({clientID:"06536e793668baa"})};(e=document.createElement("script")).src="https://static.reo.dev/"+t+"/reo.js",e.defer=!0,e.onload=n,document.head.appendChild(e)}()</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-101676615-2")</script></footer><script type=text/javascript>_linkedin_partner_id="1601132",window._linkedin_data_partner_ids=window._linkedin_data_partner_ids||[],window._linkedin_data_partner_ids.push(_linkedin_partner_id)</script><script type=text/javascript>(function(e){e||(window.lintrk=function(e,t){window.lintrk.q.push([e,t])},window.lintrk.q=[]);var n=document.getElementsByTagName("script")[0],t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://snap.licdn.com/li.lms-analytics/insight.min.js",n.parentNode.insertBefore(t,n)})(window.lintrk)</script><noscript><img height=1 width=1 style=display:none alt src="https://px.ads.linkedin.com/collect/?pid=1601132&fmt=gif"></noscript></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/tabpane-persist.js></script></body></html>